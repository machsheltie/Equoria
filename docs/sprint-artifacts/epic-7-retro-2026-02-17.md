# Epic 7 Retrospective: Groom System

**Date:** 2026-02-17
**Epic:** Epic 7 - Groom System
**Status:** Completed
**Duration:** ~2 weeks (2026-02-06 to 2026-02-17)
**Participants:** Heirr (Project Lead), Bob (Scrum Master), Alice (Product Owner), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev)

---

## Executive Summary

Epic 7 delivered **7 stories, 464 tests, 9 components, and 7 type files** — all with **zero deferred tests**. This epic was the direct proof-of-concept for Epic 6's retrospective lessons: story-by-story verification, inline testing for all critical logic, and type-driven architecture. The result was a clean, confident delivery with no quality debt.

**Key Achievement:** Epic 7 inverted Epic 6's quality profile. Where Epic 6 shipped 6 stories with 0 inline tests and 90+ deferred, Epic 7 shipped 7 stories with **464 inline tests and 0 deferred**.

---

## Epic 7 Completion Summary

### Stories Completed (7/7 — 100%)

**7-1: Groom Hiring Interface** (P0)

- Component: `GroomHiringInterface` via `GroomPersonalityDisplay` + `GroomPersonalityBadge`
- Types: `groomPersonality.ts` — 152 lines, personality trait definitions, compatibility rules
- Tests: **25 passing**
- Key Features: Personality type display, skill level badges, hire confirmation flow

**7-2: Groom Personality Display** (P0)

- Components: `GroomPersonalityDisplay.tsx` (162L), `GroomPersonalityBadge.tsx` (43L)
- Types: `groomPersonality.ts` extended — personality descriptions, interaction modifiers
- Tests: **51 passing**
- Key Features: Full personality panel with trait descriptions, compatibility indicators

**7-3: Task Assignment UI** (P0)

- Component: `GroomTaskPanel.tsx` (190L)
- Types: `groomTasks.ts` — 336 lines, 8 task types, priority logic, scheduling helpers
- Tests: **54 passing**
- Key Features: Task type grid, priority assignment, scheduling with cooldown display

**7-4: Career Lifecycle Dashboard** (P1)

- Component: `GroomCareerPanel.tsx` (428L) — largest component
- Types: `groomCareer.ts` — 229 lines, XP formula, level thresholds, retirement logic
- Tests: **79 passing** — most comprehensive, covering XP math and retirement edge cases
- Key Features: XP progress bar, level display, retirement eligibility, career timeline

**7-5: Legacy System UI** (P2)

- Component: `GroomLegacyPanel.tsx` (392L)
- Types: `groomLegacy.ts` — 214 lines, 15 perks across 5 personalities, mentor eligibility
- Tests: **60 passing**
- Key Features: Mentor/protégé lineage, inherited perks, legacy bonuses, mentorship dates
- Notable: `within()` scoping required for duplicate testIds across panel sections

**7-6: Talent Tree Visualization** (P2)

- Component: `GroomTalentTree.tsx` (307L) with sub-components: TalentCard, TierRow, TierConnector
- Types: `groomTalent.ts` — 251 lines, 3 personalities × 5 talents each = 15 talents
- Tests: **75 passing**
- Key Features: 3-tier prerequisite chain (T1→T2→T3), locked/available/selected states, saving UX
- Notable: ESLint `@typescript-eslint/no-unused-vars` fires on named function type params in interfaces — must prefix with `_`

**7-7: Show Handling & Rare Traits** (P1)

- Components: `GroomShowHandlerPanel.tsx` (234L), `GroomBonusTraitPanel.tsx` (287L)
- Types: `groomShowHandler.ts` (168L) + `groomBonusTrait.ts` (112L)
- Tests: **120 passing** — largest test file in Epic 7
- Key Features: Conformation show scoring breakdown (65/20/8/7%), personality-discipline synergy, bonus trait list, eligibility gate (bond ≥60, coverage ≥75%), total probability display

### Total Deliverables

- **9 components** across `/frontend/src/components/groom/` — 2,275 lines total
- **7 type files** — 1,462 lines of typed helpers, constants, and business logic
- **464 tests** — all inline, all passing, 0 deferred
- **0 test debt** carried into Epic 8
- **Backend-frontend parity** — all type files mirror corresponding backend services

---

## Epic 6 Lessons Applied: Report Card

Epic 6's retrospective generated 4 P0 action items. Here's how Epic 7 performed against each:

### AI-6-1: Epic 6 Testing Sprint ✅ (Completed pre-Epic 7)

The 5-day Testing Sprint ran between Epic 6 and Epic 7, adding 90+ tests to Epic 6 features. Epic 7 therefore began on a verified foundation.

### AI-6-4: Story Definition of Done ✅ (Enforced)

**Old DoD:** Build → ship → (someday test)
**New DoD:** Build → test inline → lint → verify AC → commit

Every Epic 7 story followed this cycle. No story was marked complete without tests passing.

- **Result:** 464 tests, 0 deferred. The DoD change held.

### AI-6-3: Inline Testing for Critical Logic ✅ (Followed)

All helper functions tested immediately:

- `groomCareer.ts`: XP formula, retirement window, level threshold calculations
- `groomTalent.ts`: `getTalentTiersWithState()`, `formatTalentEffect()`, `countAllocatedTalents()`
- `groomShowHandler.ts`: `getHandlerBonusRange()`, `getPersonalitySynergyDisciplines()`
- `groomBonusTrait.ts`: `getTotalBonusPercent()`, `meetsBondRequirement()`, `getRemainingSlots()`

**Result:** All algorithmic logic verified before moving to next story.

### AI-6-2: Story Splitting ✅ (Implicitly applied)

Epic 7 stories were naturally well-scoped (1 component + 1 type file per story = ~50–130 tests). No story exceeded 1.5 days. Story 7-7 combined two related concerns (show handling + rare traits) but remained manageable at 120 tests.

---

## What Went Well

### 1. Zero Test Debt (10/10)

**Evidence:**

- 464 tests across 7 stories
- Every story linted and verified before commit
- No TODO tests, no "we'll add tests later" conversations
- Test count grew predictably: 25 → 51 → 54 → 79 → 60 → 75 → 120

**Quote:** "The test counts speak for themselves. Every story shipped complete." — Dana

### 2. Type File Architecture (9/10)

**Pattern:** One type file per story → exported constants, interfaces, helper functions → component imports from type file → tests cover both type helpers AND component rendering.

**Benefits:**

- Backend-frontend consistency (types mirror `groomHandlerService.mjs`, `groomTalentService.mjs`, etc.)
- Helper functions testable in isolation (no rendering needed)
- Component files stay focused on UI concerns
- Easy to update game constants in one place

**Type files created:**
| File | Lines | Helpers | Story |
|---|---|---|---|
| groomPersonality.ts | 152 | personality defs, trait effects | 7-1/7-2 |
| groomTasks.ts | 336 | 8 task types, priority logic | 7-3 |
| groomCareer.ts | 229 | XP formula, retirement, levels | 7-4 |
| groomLegacy.ts | 214 | 15 perks, 5 personalities | 7-5 |
| groomTalent.ts | 251 | 15 talents, tier state machine | 7-6 |
| groomShowHandler.ts | 168 | handler bonuses, synergy, scoring weights | 7-7 |
| groomBonusTrait.ts | 112 | bonus constraints, eligibility | 7-7 |
| **Total** | **1,462** | | |

### 3. Consistent Test Structure (9/10)

Every test file followed the same pattern:

1. **Type helper tests** — pure function unit tests (no rendering)
2. **Component tests grouped by AC** — `describe('ComponentName — AC1: ...')`, etc.

This made test files predictable to navigate and easy to maintain.

### 4. Backend Parity (8/10)

Every type file explicitly mirrors its backend counterpart:

- `TALENT_TREES` mirrors `groomTalentService.mjs`
- `HANDLER_SKILL_BONUSES` mirrors `groomHandlerService.mjs`
- `BONUS_TRAIT_CONSTANTS` mirrors `groomBonusTraitService.mjs`
- `CONFORMATION_SHOW_WEIGHTS` mirrors `conformationShowService.mjs`

When the backend updates constants, we know exactly which frontend file to update.

### 5. Pre-Push Hook Awareness (7/10)

The pre-push hook runs the full backend test suite (~3,500 tests, ~7–8 min). The team learned to push in background while implementing the next story. This eliminated idle wait time.

---

## What Didn't Go Well

### 1. Flaky Pre-Push Tests (4/10)

**Problem:** Two tests caused repeated push failures:

- `databaseOptimization.test.mjs` — p95 timing assertion (`< 300ms` threshold). Under load during full test run, occasionally hits 305–310ms. Non-deterministic.
- `userRoutes.test.mjs` — `POST /api/users/:id/add-xp` — gets 403 during parallel full-suite run due to test user UUID collision. Passes cleanly in isolation.

**Impact:**

- Story 7-5 push: 1 failure, retried
- Story 7-7 push: 1 failure, retried
- Total: ~4 push attempts that required retries

**Root Cause:** Both tests are environment-sensitive (timing, shared state) — they're not testing business logic incorrectly, they're testing under conditions the suite doesn't control.

**Quote:** "The test is right, the environment is wrong." — Charlie

### 2. ESLint `_` Prefix Gotcha (5/10)

**Problem:** TypeScript interface function type parameter names trigger `@typescript-eslint/no-unused-vars`. Example:

```typescript
// ❌ ESLint error
onSelectTalent?: (tier: 'tier1' | 'tier2' | 'tier3', talentId: string) => void;

// ✅ Correct
onSelectTalent?: (_tier: 'tier1' | 'tier2' | 'tier3', _talentId: string) => void;
```

This bit us in Stories 7-3, 7-4, and 7-6. The fix is simple but the rule is non-obvious — TypeScript type parameters in function signatures count as "declared but unused" variables.

**Impact:** Each occurrence required a post-write lint fix pass.

### 3. Story 7-5 `within()` Scoping Complexity (6/10)

**Problem:** `GroomLegacyPanel` has multiple sections with similar testIds (e.g., perk cards appearing in both "Inherited Perks" and "Available Perks" sections). Standard `screen.getByTestId()` threw duplicate element errors.

**Fix:** `within(section).getByTestId(id)` correctly scopes the query.

**Impact:** Added complexity to the test file. Required careful section identification.

### 4. Story 7-7 Blocked on Epic 6 (7/10)

**Context:** Story 7-7 had `prerequisites: [epic-6]` in sprint-status.yaml. Epic 6 was complete, but the prerequisite caused the story to sit as "backlog" until explicitly unblocked.

**Note:** This was correct behavior — Story 7-7 does legitimately depend on Epic 6 (bonus traits tie into the trait system). But the "blocked" state could have been cleared proactively since epic-6 was already marked completed.

---

## Critical Decisions

### Decision 1: Story-by-Story Delivery (Carried from AI-6-4)

**Approach:** Complete story fully (types + component + tests + lint) → commit → push → start next story.

**Result:** Every story is an atomic unit. Any commit in the history is a working, tested feature.

**Verdict:** ✅ Correct. This eliminated the compound debugging problem from Epic 6.

### Decision 2: Type File Per Story

**Approach:** Each story gets a dedicated type file (`groomCareer.ts`, `groomTalent.ts`, etc.) rather than one shared `groom.ts` or putting types inline in components.

**Result:** 7 focused type files totaling 1,462 lines. Clear ownership. Easy to test in isolation.

**Verdict:** ✅ Correct. Scales better than a monolithic file. Easy to find what you need.

### Decision 3: Push in Background While Implementing Next Story

**Approach:** Fire `git push` in background immediately after commit. The ~8-minute pre-push hook runs while the next story implementation begins.

**Result:** Eliminated nearly all idle time waiting for pushes.

**Verdict:** ✅ Correct. Saves ~8 minutes per story = ~56 minutes across 7 stories.

---

## Metrics

### Velocity

| Story                   | Priority | Tests   | Type File (lines)                    | Component (lines)       |
| ----------------------- | -------- | ------- | ------------------------------------ | ----------------------- |
| 7-1 Groom Hiring        | P0       | 25      | groomPersonality.ts (152)            | — (used 7-2 components) |
| 7-2 Personality Display | P0       | 51      | — (extended 7-1)                     | 162 + 43                |
| 7-3 Task Assignment     | P0       | 54      | groomTasks.ts (336)                  | 190                     |
| 7-4 Career Dashboard    | P1       | 79      | groomCareer.ts (229)                 | 428                     |
| 7-5 Legacy System       | P2       | 60      | groomLegacy.ts (214)                 | 392                     |
| 7-6 Talent Tree         | P2       | 75      | groomTalent.ts (251)                 | 307                     |
| 7-7 Show/Rare Traits    | P1       | 120     | showHandler (168) + bonusTrait (112) | 234 + 287               |
| **Total**               |          | **464** | **1,462**                            | **2,275**               |

### Quality

- **Tests written inline:** 464/464 (100%)
- **Tests deferred:** 0
- **Stories with 100% AC coverage:** 7/7
- **Lint errors at commit time:** 0
- **Known bugs at delivery:** 0

### Architecture

- **Components created:** 9 (groom subdirectory)
- **Type files created:** 7
- **Backend services mirrored:** 5 (groomTalentService, groomHandlerService, groomBonusTraitService, conformationShowService, groomProgressionService)
- **Component size range:** 43–428 lines (median ~250)
- **Type file size range:** 112–336 lines (median ~214)

### Comparison: Epic 6 vs Epic 7

| Metric                          | Epic 6             | Epic 7      |
| ------------------------------- | ------------------ | ----------- |
| Stories                         | 6                  | 7           |
| Tests written inline            | 0                  | 464         |
| Tests deferred                  | 90+                | 0           |
| Test debt carried forward       | Yes (~1,500 lines) | No          |
| Push failures (flaky)           | 0                  | 2 (retried) |
| Architectural debates           | 0                  | 0           |
| Post-epic testing sprint needed | Yes (5 days)       | No          |

---

## Known Issues Discovered

### Flaky Tests in Backend Suite

Two backend tests are non-deterministic under load and should be flagged for stabilization:

1. **`backend/tests/integration/databaseOptimization.test.mjs`**

   - Assertion: `p95Time < 300` (milliseconds)
   - Failure mode: Gets 305–315ms under full-suite load
   - Recommendation: Raise threshold to 500ms or use `toBeLessThan(500)` with a comment

2. **`backend/tests/integration/userRoutes.test.mjs`**
   - Assertion: `POST /api/users/:id/add-xp` returns 200
   - Failure mode: Gets 403 during parallel test runs due to UUID collision
   - Recommendation: Use unique UUIDs per test run (e.g., `crypto.randomUUID()`) instead of hardcoded test UUIDs

These are not Epic 7 bugs but pre-existing backend instability that surfaced through the pre-push hook.

---

## Action Items

### P0 Action Items

#### AI-7-1: Stabilize Flaky Pre-Push Tests

**Owner:** Charlie (Senior Dev)
**Priority:** P0
**Description:** Fix the two non-deterministic backend tests identified above to eliminate spurious push failures.

**Acceptance Criteria:**

- [ ] `databaseOptimization.test.mjs` p95 threshold raised to 500ms (or conditionally skipped under load)
- [ ] `userRoutes.test.mjs` uses `crypto.randomUUID()` for test user IDs
- [ ] Both tests pass in 5 consecutive full-suite runs without failure

**Rationale:** 2 push failures per epic = ~20 minutes of retry wait time + developer frustration. Small fix, high ROI.

---

#### AI-7-2: Document `_` Prefix Rule for Interface Function Params

**Owner:** Dana (QA Engineer)
**Priority:** P0
**Description:** Add a note to the PATTERN*LIBRARY.md documenting that TypeScript interface function type parameter names must be prefixed with `*`to satisfy`@typescript-eslint/no-unused-vars`.

**Acceptance Criteria:**

- [ ] Pattern documented in `.claude/rules/PATTERN_LIBRARY.md` under "TypeScript Patterns"
- [ ] Example showing the wrong and right syntax
- [ ] Note added to MEMORY.md for Claude persistence

**Example to document:**

```typescript
// ❌ ESLint error: 'tier' is defined but never used
onSelectTalent?: (tier: 'tier1', talentId: string) => void;

// ✅ Correct: prefix with _
onSelectTalent?: (_tier: 'tier1', _talentId: string) => void;
```

---

### P1 Action Items

#### AI-7-3: within() Pattern in Pattern Library

**Owner:** Elena (Junior Dev)
**Priority:** P1
**Description:** Document the `within()` scoping pattern for tests with duplicate testIds across component sections.

**Acceptance Criteria:**

- [ ] Pattern added to `.claude/rules/PATTERN_LIBRARY.md` under "Testing Patterns"
- [ ] Example showing when `screen.getByTestId()` fails (duplicates) vs `within(section).getByTestId(id)`

---

#### AI-7-4: Prerequisite Auto-Unblock Review

**Owner:** Bob (Scrum Master)
**Priority:** P1
**Description:** Review sprint-status.yaml prerequisite system. When a prerequisite epic/story is marked complete, downstream stories should be surfaced more proactively. Currently requires manual scanning.

**Acceptance Criteria:**

- [ ] Consider adding `bd ready` to the session start checklist
- [ ] Document how to verify prerequisites are met before starting a story
- [ ] Story 7-7's block on `epic-6` delayed ~1 session before being noticed

---

## Lessons Learned

### 1. The DoD Change Worked

Epic 6 ended with 0 inline tests and a 5-day testing sprint. Epic 7 ended with 464 inline tests and 0 testing debt. The Definition of Done update (AI-6-4) was the single most impactful change between epics.

**Learning:** Process changes, when enforced, produce measurable outcomes. Don't skip the retrospective action items.

### 2. Type Files Are the Architecture

Epic 7's architecture can be described as: **type file → component → tests**. The type file is where the real business logic lives. The component just renders it. The tests verify both.

This separation made Epic 7 exceptionally maintainable. When a backend constant changes, you update one type file. The component and tests follow automatically.

### 3. Backend Parity Is Worth the Effort

Taking 20 minutes to read `groomTalentService.mjs` before writing `groomTalent.ts` paid dividends: the frontend mirrors the backend exactly, meaning no surprises during API integration. The constants, business rules, and data shapes match.

**Future Application:** Always read the backend service before creating the frontend type file.

### 4. Push in Background = No Idle Time

The ~8-minute pre-push hook is a real cost. Pushing in background and starting the next story immediately converted that wait into productive time. This is standard practice now.

### 5. Flaky Tests Are Technical Debt

Two flaky tests caused 4 push failures across the epic. Each failure required a retry (~8 minutes) plus investigation time (~5 minutes). Total cost: ~50 minutes of team time for tests that pass in isolation.

**Learning:** Non-deterministic tests are technical debt. They erode confidence in the test suite and waste developer time.

### 6. 120-Test Stories Are Not Too Big

Story 7-7 produced 120 tests across two components and two type files. This felt large but was manageable because the tests were organized into clear categories (helper unit tests + AC-grouped component tests). Structure matters more than count.

---

## Epic 8 Preview

**Next Epic:** TBD — frontend integration layer (connecting existing components to live APIs)

**Foundation State:**

- ✅ Epic 6: 25 components, 464+ tests (post-testing-sprint)
- ✅ Epic 7: 9 groom components, 464 inline tests, 0 debt
- ✅ Backend: 100% complete, 3,500+ tests
- ⚠️ Frontend: ~80% complete (components built, API integration pending)

**Readiness Assessment:**

- All groom components built and tested against mock APIs
- Type files ready for real API response mapping
- React Query hooks exist (`useGrooms`, `useCompetitions`) but need live endpoint connection
- Auth tokens needed for protected endpoints

**Recommendation:** Epic 8 should focus on API integration (connecting frontend hooks to live backend), not new features. All the building blocks are in place.

---

## Team Sentiment

**Epic 7 Execution (Average: 9.0/10)**

- Charlie: 9/10 — "This is what quality delivery looks like. Clean commits, tested code, no debt."
- Dana: 10/10 — "464 tests inline. This is what I've been asking for since Epic 4."
- Elena: 8/10 — "Learned the type file pattern. Would use it on any project."
- Alice: 9/10 — "Every story felt done when it was marked done."
- Heirr: "This is what I wanted. Features that work _correctly_."

**DoD Change Assessment (Average: 9.6/10)**

- Charlie: 10/10 — "The DoD held. That's the story."
- Dana: 10/10 — "Zero deferred tests. Zero."
- Elena: 9/10 — "Takes a bit longer per story, but you're never behind on quality."
- Alice: 9/10 — "Predictable delivery. No cleanup sprints needed."
- Heirr: "Exactly right. Slow is smooth, smooth is fast."

---

## Conclusion

Epic 7 proved that the Epic 6 retrospective produced real change. The 5-day Testing Sprint was painful but necessary; the DoD update was the structural fix; and the story-by-story verification approach delivered a quality outcome every iteration.

**464 tests. 7 stories. 0 deferred. 0 debt.**

The groom system is complete: hiring, personality, task assignment, career progression, legacy mentorship, talent trees, show handling, and rare trait bonuses — all implemented, all tested, all ready for API integration.

**Key Takeaway:** "Slow is smooth, smooth is fast." The extra time spent testing each story inline was not wasted — it was the investment that made the overall delivery clean and confident.

Epic 8 begins on a verified foundation.

---

**Next Steps:**

1. ✅ Epic 7 retrospective complete
2. ⏳ AI-7-1: Stabilize flaky backend tests (P0)
3. ⏳ AI-7-2: Document `_` prefix rule (P0)
4. ⏳ Epic 8 planning (API integration layer)

---

_Retrospective facilitated by Bob (Scrum Master)_
_Document version: 1.0_
_Last updated: 2026-02-17_
