
    console.log
      [2025-12-19 16:44:21] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:21] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

    console.info
      [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

 PASS  tests/groomBondingSystem.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:22] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

    console.info
      [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

 PASS  tests/groomPersonalityEffects.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:22] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

    console.log
      [2025-12-19 16:44:22] info: [groomPersonalityEffects.calculatePersonalityEffects] Applying gentle personality effects for task brushing

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [groomPersonalityEffects.calculatePersonalityEffects] Applied gentle effects: task_specialty, trait_match

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [groomPersonalityEffects.calculatePersonalityEffects] Applying playful personality effects for task grooming_game

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [groomPersonalityEffects.calculatePersonalityEffects] Applied playful effects: task_specialty, age_match

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [groomPersonalityEffects.calculatePersonalityEffects] Applying firm personality effects for task hand_walking

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [groomPersonalityEffects.calculatePersonalityEffects] Applied firm effects: task_specialty, trait_match

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [groomPersonalityEffects.calculatePersonalityEffects] Applying patient personality effects for task puddle_training

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [groomPersonalityEffects.calculatePersonalityEffects] Applied patient effects: task_specialty, category_match

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [groomPersonalityEffects.calculatePersonalityEffects] Applying high_energy personality effects for task obstacle_course

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [groomPersonalityEffects.calculatePersonalityEffects] Applied high_energy effects: task_specialty, extra_trait_points

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [groomPersonalityEffects.calculatePersonalityEffects] Applying aloof personality effects for task brushing

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [groomPersonalityEffects.calculatePersonalityEffects] Applied aloof effects:

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] warn: [groomPersonalityEffects.calculatePersonalityEffects] Unknown personality: unknown_personality

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [groomPersonalityEffects.calculatePersonalityEffects] Applying patient personality effects for task puddle_training

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [groomPersonalityEffects.calculatePersonalityEffects] Applied patient effects: task_specialty, category_match

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [groomPersonalityEffects.calculatePersonalityEffects] Applying gentle personality effects for task brushing

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [groomPersonalityEffects.calculatePersonalityEffects] Applied gentle effects: task_specialty

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [groomPersonalityEffects.calculatePersonalityEffects] Applying playful personality effects for task grooming_game

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [groomPersonalityEffects.calculatePersonalityEffects] Applied playful effects: task_specialty

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [groomPersonalityEffects.calculatePersonalityEffects] Applying gentle personality effects for task brushing

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [groomPersonalityEffects.calculatePersonalityEffects] Applied gentle effects: task_specialty, trait_match

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

 PASS  tests/traitIntegration.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:22] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

    console.log
      [2025-12-19 16:44:22] info: [bondingModifiers] Bonding change for horse 1: 32 -> 50 (56.3% trait modifier)

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [bondingModifiers] Bonding change for horse 1: 1.5 -> 0.8 (-46.7% trait modifier)

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [bondingModifiers] Bonding change for horse 1: 6 -> 7.5 (25.0% trait modifier)

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [temperamentDrift] Temperament drift suppressed by traits for horse 1

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [temperamentDrift] Temperament drift suppressed by traits for horse 1

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] warn: [traitEffects.getTraitEffects] No effects defined for trait: unknown_trait

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:22] warn: [traitEffects.getTraitEffects] No effects defined for trait: another_unknown

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:22] info: [bondingModifiers] Bonding change for horse 1: 17 -> 17 (0.0% trait modifier)

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] info: [bondingModifiers] Bonding change for horse 1: 1.5 -> 1.5 (0.0% trait modifier)

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:22] error: [bondingModifiers] Error calculating bonding change: Unknown activity type: invalid_activity

      at Console.log (node_modules/winston/lib/winston/transports/console.js:59:25)

 PASS  tests/taskInfluenceConfig.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:23] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:23] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:23] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  tests/competitionRewards.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:23] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:23] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:23] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

    console.log
      [2025-12-19 16:44:23] info: [competitionRewards.calculateStatGains] 1st place winner gained +1 speed (10% chance)

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:23] info: [competitionRewards.calculateStatGains] 2nd place winner gained +1 balance (5% chance)

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:23] info: [competitionRewards.calculateStatGains] 3rd place winner gained +1 precision (3% chance)

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:23] info: [competitionRewards.calculateStatGains] 1st place winner gained +1 speed (10% chance)

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:23] info: [competitionRewards.calculateStatGains] 1st place winner gained +1 stamina (10% chance)

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:23] info: [competitionRewards.calculateStatGains] 1st place winner gained +1 focus (10% chance)

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

 PASS  tests/foalTaskExclusivity.integration.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:23] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:23] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:23] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

    console.info
      [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

 PASS  tests/groomMarketplace.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:23] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:23] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:23] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  tests/traitMetadataValidation.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:24] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:24] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:24] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  __tests__/utils/validateEnvironment.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:24] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:24] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:24] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  __tests__/unit/security/session-management.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:24] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:24] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:24] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

    console.info
      [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

 PASS  tests/task9IntegrationExample.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:25] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:25] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:25] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

    console.log
      [2025-12-19 16:44:25] info: [simulateCompetition] Horse JumpSpecialist: Discipline affinity bonus applied for discipline_affinity_show_jumping (+5 points)

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.map (<anonymous>)

    console.log
      [2025-12-19 16:44:25] warn: [traitCompetitionImpact] Unknown trait: discipline_affinity_show_jumping

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.forEach (<anonymous>)
          at Array.map (<anonymous>)

    console.log
      [2025-12-19 16:44:25] info: [traitCompetitionImpact] Horse 1: 0 traits applied, 0.0% modifier, 0.0 point adjustment

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.map (<anonymous>)

    console.log
      [2025-12-19 16:44:25] info: [simulateCompetition] Horse TraitHorse: Discipline affinity bonus applied for discipline_affinity_show_jumping (+5 points)

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.map (<anonymous>)

    console.log
      [2025-12-19 16:44:25] warn: [traitCompetitionImpact] Unknown trait: discipline_affinity_show_jumping

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.forEach (<anonymous>)
          at Array.map (<anonymous>)

    console.log
      [2025-12-19 16:44:25] info: [traitCompetitionImpact] Horse 1: 0 traits applied, 0.0% modifier, 0.0 point adjustment

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.map (<anonymous>)

    console.log
      [2025-12-19 16:44:25] info: [simulateCompetition] Horse RacingSpecialist: Discipline affinity bonus applied for discipline_affinity_racing (+5 points)

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.map (<anonymous>)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:25] warn: [traitCompetitionImpact] Unknown trait: discipline_affinity_racing

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.forEach (<anonymous>)
          at Array.map (<anonymous>)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:25] info: [traitCompetitionImpact] Horse 1: 0 traits applied, 0.0% modifier, 0.0 point adjustment

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.map (<anonymous>)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:25] info: [simulateCompetition] Horse DressageSpecialist: Discipline affinity bonus applied fordiscipline_affinity_dressage (+5 points)

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.map (<anonymous>)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:25] warn: [traitCompetitionImpact] Unknown trait: discipline_affinity_dressage

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.forEach (<anonymous>)
          at Array.map (<anonymous>)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:25] info: [traitCompetitionImpact] Horse 1: 0 traits applied, 0.0% modifier, 0.0 point adjustment

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.map (<anonymous>)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:25] info: [simulateCompetition] Horse Cross CountrySpecialist: Discipline affinity bonus applied for discipline_affinity_cross_country (+5 points)

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.map (<anonymous>)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:25] warn: [traitCompetitionImpact] Unknown trait: discipline_affinity_cross_country

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.forEach (<anonymous>)
          at Array.map (<anonymous>)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:25] info: [traitCompetitionImpact] Horse 1: 0 traits applied, 0.0% modifier, 0.0 point adjustment

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.map (<anonymous>)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:25] info: [simulateCompetition] Horse EnduranceSpecialist: Discipline affinity bonus applied for discipline_affinity_endurance (+5 points)

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.map (<anonymous>)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:25] warn: [traitCompetitionImpact] Unknown trait: discipline_affinity_endurance

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.forEach (<anonymous>)
          at Array.map (<anonymous>)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:25] info: [traitCompetitionImpact] Horse 1: 0 traits applied, 0.0% modifier, 0.0 point adjustment

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.map (<anonymous>)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:25] warn: [traitCompetitionImpact] Unknown trait: discipline_affinity_racing

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.forEach (<anonymous>)
          at Array.map (<anonymous>)

    console.log
      [2025-12-19 16:44:25] info: [traitCompetitionImpact] Horse 1: 0 traits applied, 0.0% modifier, 0.0 point adjustment

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.map (<anonymous>)

 PASS  tests/simulateCompetition.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:25] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:25] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:25] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  tests/horseConformation.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:25] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:25] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:25] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  tests/unit/epigeneticFlagInfluence.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:26] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

    console.log
      [2025-12-19 16:44:26] info: [epigeneticFlagInfluence] Applied influences from 1 flags to trait weights

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [epigeneticFlagInfluence] Applied influences from 1 flags to trait weights

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [epigeneticFlagInfluence] Applied influences from 2 flags to trait weights

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] warn: [epigeneticFlagInfluence] Unknown flag: unknown_flag

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:26] info: [epigeneticFlagInfluence] Applied influences from 1 flags to trait weights

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [epigeneticFlagInfluence] Applied influences from 1 flags to trait weights

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [epigeneticFlagInfluence] Calculated behavior modifiers from 1 flags

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [epigeneticFlagInfluence] Calculated behavior modifiers from 2 flags

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [epigeneticFlagInfluence] Calculated behavior modifiers from 2 flags

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [epigeneticFlagInfluence] Calculated behavior modifiers from 1 flags

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [epigeneticFlagInfluence] Calculated behavior modifiers from 1 flags

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [epigeneticFlagInfluence] Calculated behavior modifiers from 1 flags

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [epigeneticFlagInfluence] Calculated behavior modifiers from 1 flags

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [epigeneticFlagInfluence] Calculated behavior modifiers from 1 flags

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [epigeneticFlagInfluence] Calculated behavior modifiers from 1 flags

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [epigeneticFlagInfluence] Calculated behavior modifiers from 1 flags

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [epigeneticFlagInfluence] Calculated behavior modifiers from 1 flags

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [epigeneticFlagInfluence] Calculated behavior modifiers from 1 flags

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [epigeneticFlagInfluence] Calculated behavior modifiers from 2 flags

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [epigeneticFlagInfluence] Calculated behavior modifiers from 2 flags

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [epigeneticFlagInfluence] Calculated behavior modifiers from 4 flags

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

 PASS  tests/epigeneticTraits.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:26] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  tests/traitCalculation.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:26] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:26] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  tests/isHorseEligible.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:27] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:27] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:27] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  __tests__/unit/security/validate-environment.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:27] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:27] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:27] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

    console.log
      [2025-12-19 16:44:27] error: ‚ùå Environment validation failed:

      at Console.log (node_modules/winston/lib/winston/transports/console.js:59:25)

    console.log
      [2025-12-19 16:44:27] error:   - Missing required environment variable: DATABASE_URL

      at Console.log (node_modules/winston/lib/winston/transports/console.js:59:25)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:27] error:   - Missing required environment variable: JWT_SECRET

      at Console.log (node_modules/winston/lib/winston/transports/console.js:59:25)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:27] error:   - NODE_ENV must be one of: development, production, test (current: invalid)

      at Console.log (node_modules/winston/lib/winston/transports/console.js:59:25)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:27] error:   - PORT must be a number (current: abc)

      at Console.log (node_modules/winston/lib/winston/transports/console.js:59:25)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:27] error:
      Please fix the above errors in your .env file and restart.

      at Console.log (node_modules/winston/lib/winston/transports/console.js:59:25)

    console.log
      [2025-12-19 16:44:27] info: ‚úÖ Environment validation passed

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:27] warn: [validateEnvironment] SECURITY WARNING: ALLOWED_ORIGINS contains HTTP URLs in production

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:27] warn:   HTTP origins detected: http://example.com

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:27] warn:   These should be HTTPS in production to prevent man-in-the-middle attacks

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:27] warn: [validateEnvironment] SECURITY WARNING: PORT is set to 80 (HTTP) in production

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:27] warn:   Consider using HTTPS (443) or a reverse proxy with HTTPS termination

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:27] error: ‚ùå Environment validation failed:

      at Console.log (node_modules/winston/lib/winston/transports/console.js:59:25)

    console.log
      [2025-12-19 16:44:27] error:   - JWT_SECRET must be at least 32 characters (current: 17)

      at Console.log (node_modules/winston/lib/winston/transports/console.js:59:25)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:27] error:   - JWT_SECRET appears to be a placeholder value. Please generate a real secret.

      at Console.log (node_modules/winston/lib/winston/transports/console.js:59:25)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:27] error:   - DATABASE_URL contains a weak password. Please use a strong password.

      at Console.log (node_modules/winston/lib/winston/transports/console.js:59:25)
          at Array.forEach (<anonymous>)

    console.log
      [2025-12-19 16:44:27] error:
      Please fix the above errors in your .env file and restart.

      at Console.log (node_modules/winston/lib/winston/transports/console.js:59:25)

    console.log
      [2025-12-19 16:44:27] info: ‚úÖ Environment validation passed

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:27] info: ‚úÖ Environment validation passed

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

 PASS  tests/constants/schema.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:27] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:27] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:27] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  tests/applyEpigeneticTraitsAtBirth.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:28] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:28] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:28] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  __tests__/unit/security/security-middleware.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:28] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:28] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:28] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

    console.log
      [2025-12-19 16:44:28] warn: CORS blocked request from origin: http://evil.com

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:28] warn: [CORS] Request with no origin detected - API key validation required

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.error
      TypeError: Cannot read properties of undefined (reading 'get')
          at Object.trustProxy (C:\Users\heirr\OneDrive\Desktop\Equoria\backend\node_modules\express-rate-limit\dist\index.mjs:140:21)
          at Object.wrappedValidations.<computed> [as trustProxy] (C:\Users\heirr\OneDrive\Desktop\Equoria\backend\node_modules\express-rate-limit\dist\index.mjs:370:22)
          at Object.keyGenerator (C:\Users\heirr\OneDrive\Desktop\Equoria\backend\node_modules\express-rate-limit\dist\index.mjs:642:20)
          at C:\Users\heirr\OneDrive\Desktop\Equoria\backend\node_modules\express-rate-limit\dist\index.mjs:696:32
          at C:\Users\heirr\OneDrive\Desktop\Equoria\backend\node_modules\express-rate-limit\dist\index.mjs:676:5

      at Object.wrappedValidations.<computed> [as trustProxy] (node_modules/express-rate-limit/dist/index.mjs:378:21)
      at Object.keyGenerator (node_modules/express-rate-limit/dist/index.mjs:642:20)
      at node_modules/express-rate-limit/dist/index.mjs:696:32
      at node_modules/express-rate-limit/dist/index.mjs:676:5

    console.log
      [2025-12-19 16:44:28] warn: [API Key] API_KEY not configured - requests with no origin are allowed (INSECURE)

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:28] warn: [API Key] Invalid or missing API key

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:28] warn: [HTTPS] Insecure HTTP request detected, redirecting to HTTPS

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

 PASS  tests/middleware/errorHandler.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:28] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:28] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:28] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

    console.log
      [2025-12-19 16:44:28] error: Error Test error

      at Console.log (node_modules/winston/lib/winston/transports/console.js:59:25)

    console.log
      [2025-12-19 16:44:28] error: Error Generic error

      at Console.log (node_modules/winston/lib/winston/transports/console.js:59:25)

    console.log
      [2025-12-19 16:44:28] error: Error Unique constraint failed

      at Console.log (node_modules/winston/lib/winston/transports/console.js:59:25)

    console.log
      [2025-12-19 16:44:28] error: Error Record not found

      at Console.log (node_modules/winston/lib/winston/transports/console.js:59:25)

    console.log
      [2025-12-19 16:44:28] error: Error Test error

      at Console.log (node_modules/winston/lib/winston/transports/console.js:59:25)

    console.log
      [2025-12-19 16:44:28] error: Error Test error

      at Console.log (node_modules/winston/lib/winston/transports/console.js:59:25)

    console.log
      [2025-12-19 16:44:28] error: Error Test error

      at Console.log (node_modules/winston/lib/winston/transports/console.js:59:25)

 PASS  tests/taskTraitInfluence.integration.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:28] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:28] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:28] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  tests/ultraRareTraitsCore.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:29] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:29] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:29] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

    console.info
      [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

    console.log
      [2025-12-19 16:44:29] info: [groomRareTraitPerks] Perk revealed: Phoenix Whisperer for groom 1

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:29] info: [groomRareTraitPerks] Perk revealed: Phoenix Whisperer for groom 1

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

 PASS  tests/groomConfig.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:29] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:29] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:29] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  tests/traitEffects.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:29] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:29] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:29] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

    console.log
      [2025-12-19 16:44:29] warn: [traitEffects.getTraitEffects] No effects defined for trait: nonexistent_trait

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:29] warn: [traitEffects.getTraitEffects] Invalid trait name: null

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:29] warn: [traitEffects.getTraitEffects] Invalid trait name: undefined

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:29] warn: [traitEffects.getTraitEffects] Invalid trait name:

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:29] warn: [traitEffects.getTraitEffects] Invalid trait name: 123

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:29] warn: [traitEffects.getTraitEffects] No effects defined for trait: nonexistent_trait

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:29] warn: [traitEffects.getCombinedTraitEffects] Invalid trait names array

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:29] warn: [traitEffects.getTraitEffects] No effects defined for trait: invalid_trait

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)
          at Array.forEach (<anonymous>)

 PASS  tests/enhancedCompetitionLogic.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:30] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:30] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:30] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  tests/foalEnrichment.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:30] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:30] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:30] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  tests/errors/AppError.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:30] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:30] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:30] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  tests/integration/groomRoutes.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:30] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:30] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:30] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  tests/horseModelTraitHelpers.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:31] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:31] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:31] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  tests/traitDiscovery.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:31] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:31] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:31] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  tests/unit/epigeneticFlagDefinitions.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:31] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:31] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:31] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  tests/disciplineAffinityBonusTask9.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:32] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:32] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:32] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  tests/horseModel.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:32] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:32] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:32] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  tests/utils/epigeneticTraits.comprehensive.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:32] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:32] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:32] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  tests/training-fixed.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:32] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:32] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:32] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 PASS  models/horseModel.test.mjs
  ‚óè Console

    console.log
      [2025-12-19 16:44:33] info: [envValidator] Validating test environment configuration...

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:33] info: [envValidator] ‚úÖ All 5 required environment variables are present

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      [2025-12-19 16:44:33] info: [envValidator] Test environment validation complete. Success: true

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      üß™ Test environment loaded

      at tests/setup.mjs:37:9

    console.log
      üìä Database: postgresql://postgres:***@localhost:5432/equoria_test

      at tests/setup.mjs:38:9

 FAIL  __tests__/integration/security/rate-limit-enforcement.test.mjs
  ‚óè Test suite failed to run

    SyntaxError: Invalid regular expression: missing /

      at Runtime.loadEsmModule (node_modules/jest-runtime/build/index.js:516:20)

Summary of all failing tests
 FAIL  tests/integration/groomSalarySystem.test.mjs
  ‚óè Groom Salary System ‚Ä∫ API Endpoints ‚Ä∫ should validate groom ownership

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 404

      214 |         .set('Authorization', `Bearer ${authToken}`);
      215 |
    > 216 |       expect(response.status).toBe(403);
          |                               ^
      217 |       expect(response.body.success).toBe(false);
      218 |       expect(response.body.message).toContain('You do not own this groom');
      219 |

      at Object.<anonymous> (tests/integration/groomSalarySystem.test.mjs:216:31)

  ‚óè Groom Salary System ‚Ä∫ Salary Processing ‚Ä∫ should trigger salary processing via API

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      273 |         .set('Authorization', `Bearer ${authToken}`);
      274 |
    > 275 |       expect(response.status).toBe(200);
          |                               ^
      276 |       expect(response.body.success).toBe(true);
      277 |       expect(response.body.data).toHaveProperty('processed');
      278 |       expect(response.body.data).toHaveProperty('successful');

      at Object.<anonymous> (tests/integration/groomSalarySystem.test.mjs:275:31)

  ‚óè Groom Salary System ‚Ä∫ Authentication ‚Ä∫ should require authentication for GET /api/groom-salaries/summary

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 500

      292 |       const response = await request(app).get('/api/groom-salaries/summary');
      293 |
    > 294 |       expect(response.status).toBe(401);
          |                               ^
      295 |       expect(response.body.success).toBe(false);
      296 |     });
      297 |

      at Object.<anonymous> (tests/integration/groomSalarySystem.test.mjs:294:31)

  ‚óè Groom Salary System ‚Ä∫ Authentication ‚Ä∫ should require authentication for GET /api/groom-salaries/groom/:groomId/salary

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 403

      306 |       const response = await request(app).get(`/api/groom-salaries/groom/${testGroom.id}/salary`);
      307 |
    > 308 |       expect(response.status).toBe(401);
          |                               ^
      309 |       expect(response.body.success).toBe(false);
      310 |     });
      311 |

      at Object.<anonymous> (tests/integration/groomSalarySystem.test.mjs:308:31)

  ‚óè Groom Salary System ‚Ä∫ Authentication ‚Ä∫ should require authentication for POST /api/groom-salaries/process

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 200

      320 |       const response = await request(app).post('/api/groom-salaries/process');
      321 |
    > 322 |       expect(response.status).toBe(401);
          |                               ^
      323 |       expect(response.body.success).toBe(false);
      324 |     });
      325 |   });

      at Object.<anonymous> (tests/integration/groomSalarySystem.test.mjs:322:31)

 FAIL  __tests__/integration/security/sql-injection-attempts.test.mjs
  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Parameterized Query Validation ‚Ä∫ should use parameterized queries for ownership checks

    expected 200 "OK", got 404 "Not Found"

      582 |         .get(`/api/horses/${testHorse.id}`)
      583 |         .set('Authorization', `Bearer ${validToken}`)
    > 584 |         .expect(200);
          |          ^
      585 |
      586 |       expect(response.body.success).toBe(true);
      587 |       expect(response.body.data.id).toBe(testHorse.id);

      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:584:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

 FAIL  __tests__/integration/security/auth-bypass-attempts.test.mjs
  ‚óè Authentication Bypass Attempts Integration Tests ‚Ä∫ Direct Endpoint Access Without Authentication ‚Ä∫ should reject GET /api/users/profile without token

    expected 401 "Unauthorized", got 404 "Not Found"

      65 |       const response = await request(app)
      66 |         .get('/api/auth/profile')
    > 67 |         .expect(401);
         |          ^
      68 |
      69 |       expect(response.body).toEqual({
      70 |         success: false,

      at Object.<anonymous> (__tests__/integration/security/auth-bypass-attempts.test.mjs:67:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Authentication Bypass Attempts Integration Tests ‚Ä∫ Direct Endpoint Access Without Authentication ‚Ä∫ should reject PUT /api/users/profile without token

    expected 401 "Unauthorized", got 404 "Not Found"

      78 |         .put('/api/auth/profile')
      79 |         .send({ username: 'hacker' })
    > 80 |         .expect(401);
         |          ^
      81 |
      82 |       expect(response.body.success).toBe(false);
      83 |     });

      at Object.<anonymous> (__tests__/integration/security/auth-bypass-attempts.test.mjs:80:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Authentication Bypass Attempts Integration Tests ‚Ä∫ Direct Endpoint Access Without Authentication ‚Ä∫ should reject DELETE /api/users/account without token

    expected 401 "Unauthorized", got 400 "Bad Request"

      86 |       const response = await request(app)
      87 |         .delete('/api/users/account')
    > 88 |         .expect(401);
         |          ^
      89 |
      90 |       expect(response.body.success).toBe(false);
      91 |     });

      at Object.<anonymous> (__tests__/integration/security/auth-bypass-attempts.test.mjs:88:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Authentication Bypass Attempts Integration Tests ‚Ä∫ Direct Endpoint Access Without Authentication ‚Ä∫ should reject GET /api/horses without token

    expected 401 "Unauthorized", got 200 "OK"

      94 |       const response = await request(app)
      95 |         .get('/api/horses')
    > 96 |         .expect(401);
         |          ^
      97 |
      98 |       expect(response.body.success).toBe(false);
      99 |     });

      at Object.<anonymous> (__tests__/integration/security/auth-bypass-attempts.test.mjs:96:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Authentication Bypass Attempts Integration Tests ‚Ä∫ Direct Endpoint Access Without Authentication ‚Ä∫ should reject POST /api/horses without token

    expected 401 "Unauthorized", got 400 "Bad Request"

      103 |         .post('/api/horses')
      104 |         .send({ name: 'TestHorse' })
    > 105 |         .expect(401);
          |          ^
      106 |
      107 |       expect(response.body.success).toBe(false);
      108 |     });

      at Object.<anonymous> (__tests__/integration/security/auth-bypass-attempts.test.mjs:105:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Authentication Bypass Attempts Integration Tests ‚Ä∫ Authorization Header Manipulation ‚Ä∫ should reject empty Authorization header

    expected 401 "Unauthorized", got 404 "Not Found"

      303 |         .get('/api/auth/profile')
      304 |         .set('Authorization', '')
    > 305 |         .expect(401);
          |          ^
      306 |
      307 |       expectSuccessFlag(response, false);
      308 |     });

      at Object.<anonymous> (__tests__/integration/security/auth-bypass-attempts.test.mjs:305:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Authentication Bypass Attempts Integration Tests ‚Ä∫ Edge Cases and Attack Vectors ‚Ä∫ should reject token with non-numeric userId

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      493 |         .get('/api/users/profile')
      494 |         .set('Authorization', `Bearer ${invalidToken}`)
    > 495 |         .expect((res) => expect([401, 403]).toContain(res.status));
          |          ^
      496 |
      497 |       expectSuccessFlag(response, false);
      498 |     });

      at Object.<anonymous> (__tests__/integration/security/auth-bypass-attempts.test.mjs:495:10)
      ----
      at __tests__/integration/security/auth-bypass-attempts.test.mjs:495:45
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

 FAIL  __tests__/integration/security/parameter-pollution.test.mjs
  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ HTTP Parameter Pollution (HPP) ‚Ä∫ should use first parameter value when duplicates present

    expected 200 "OK", got 404 "Not Found"

       97 |         .get(`/api/horses/${testHorse.id}?sort=name&sort=age`)
       98 |         .set('Authorization', `Bearer ${validToken}`)
    >  99 |         .expect(200);
          |          ^
      100 |
      101 |       // Should use first 'sort=name' parameter
      102 |       expect(response.body.success).toBe(true);

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:99:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ HTTP Parameter Pollution (HPP) ‚Ä∫ should reject array-syntax parameters where not expected

    expected 400 "Bad Request", got 404 "Not Found"

      111 |           name: ['HorseName1', 'HorseName2'], // Array where string expected
      112 |         })
    > 113 |         .expect(400);
          |          ^
      114 |
      115 |       expect(response.body.success).toBe(false);
      116 |       expect(response.body.message).toContain('Invalid');

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:113:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ HTTP Parameter Pollution (HPP) ‚Ä∫ should reject mixed type parameters

    expected 400 "Bad Request", got 404 "Not Found"

      126 |           name: 123, // Number where string expected
      127 |         })
    > 128 |         .expect(400);
          |          ^
      129 |
      130 |       expect(response.body.success).toBe(false);
      131 |     });

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:128:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ JSON Parameter Pollution ‚Ä∫ should reject duplicate keys in JSON payload

    expected 400 "Bad Request", got 404 "Not Found"

      144 |         .set('Content-Type', 'application/json')
      145 |         .send(maliciousPayload)
    > 146 |         .expect(400);
          |          ^
      147 |
      148 |       expect(response.body.success).toBe(false);
      149 |

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:146:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ JSON Parameter Pollution ‚Ä∫ should reject nested parameter pollution

    expected 400 "Bad Request", got 404 "Not Found"

      165 |           },
      166 |         })
    > 167 |         .expect(400);
          |          ^
      168 |
      169 |       expect(response.body.success).toBe(false);
      170 |     });

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:167:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ JSON Parameter Pollution ‚Ä∫ should reject prototype pollution attempts

    expected 400 "Bad Request", got 404 "Not Found"

      181 |           },
      182 |         })
    > 183 |         .expect(400);
          |          ^
      184 |
      185 |       expect(response.body.success).toBe(false);
      186 |

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:183:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ JSON Parameter Pollution ‚Ä∫ should reject constructor pollution attempts

    expected 400 "Bad Request", got 404 "Not Found"

      202 |           },
      203 |         })
    > 204 |         .expect(400);
          |          ^
      205 |
      206 |       expect(response.body.success).toBe(false);
      207 |     });

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:204:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ JSON Parameter Pollution ‚Ä∫ should sanitize JSON keys with special characters

    expected 400 "Bad Request", got 404 "Not Found"

      216 |           'color\x00': 'HackedColor',
      217 |         })
    > 218 |         .expect(400);
          |          ^
      219 |
      220 |       expect(response.body.success).toBe(false);
      221 |     });

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:218:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Content-Type Manipulation ‚Ä∫ should reject Content-Type charset manipulation

    expected 400 "Bad Request", got 404 "Not Found"

      366 |         .set('Content-Type', 'application/json; charset=utf-7')
      367 |         .send({ name: 'HackedName' })
    > 368 |         .expect(400);
          |          ^
      369 |
      370 |       expect(response.body.success).toBe(false);
      371 |     });

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:368:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Content-Type Manipulation ‚Ä∫ should reject multipart/form-data without proper boundaries

    expected 400 "Bad Request", got 404 "Not Found"

      378 |         .set('Content-Type', 'multipart/form-data')
      379 |         .send('name=HackedName') // sending plain string to avoid implicit boundary handling
    > 380 |         .expect(400);
          |          ^
      381 |
      382 |       expect(response.body.success).toBe(false);
      383 |     });

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:380:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Content-Type Manipulation ‚Ä∫ should accept only allowed Content-Types

    expected 415 "Unsupported Media Type", got 404 "Not Found"

      390 |         .set('Content-Type', 'application/xml') // Not allowed
      391 |         .send('<name>HackedName</name>')
    > 392 |         .expect(415); // Unsupported Media Type
          |          ^
      393 |
      394 |       expect(response.body.success).toBe(false);
      395 |     });

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:392:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Nested Object Pollution ‚Ä∫ should reject excessive nesting depth

    expected 400 "Bad Request", got 404 "Not Found"

      405 |         .set('X-Test-Skip-Csrf', 'true')
      406 |         .send(deepObject)
    > 407 |         .expect(400);
          |          ^
      408 |
      409 |       expect(response.body.success).toBe(false);
      410 |       expect(response.body.message).toContain('nested');

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:407:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Nested Object Pollution ‚Ä∫ should reject circular references in objects

    expected 400 "Bad Request", got 404 "Not Found"

      420 |         .set('X-Test-Skip-Csrf', 'true')
      421 |         .send(circularObj)
    > 422 |         .expect(400);
          |          ^
      423 |
      424 |       expect(response.body.success).toBe(false);
      425 |     });

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:422:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Nested Object Pollution ‚Ä∫ should sanitize nested object keys

    expected 400 "Bad Request", got 404 "Not Found"

      437 |           },
      438 |         })
    > 439 |         .expect(400);
          |          ^
      440 |
      441 |       expect(response.body.success).toBe(false);
      442 |     });

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:439:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Nested Object Pollution ‚Ä∫ should reject objects with numeric string keys

    expected 400 "Bad Request", got 404 "Not Found"

      453 |           },
      454 |         })
    > 455 |         .expect(400);
          |          ^
      456 |
      457 |       expect(response.body.success).toBe(false);
      458 |     });

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:455:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Type Coercion Attacks ‚Ä∫ should reject boolean as string

    expected 400 "Bad Request", got 404 "Not Found"

      468 |           name: true, // Boolean where string expected
      469 |         })
    > 470 |         .expect(400);
          |          ^
      471 |
      472 |       expect(response.body.success).toBe(false);
      473 |     });

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:470:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Type Coercion Attacks ‚Ä∫ should reject object as number

    expected 400 "Bad Request", got 404 "Not Found"

      481 |           age: { value: 5 }, // Object where number expected
      482 |         })
    > 483 |         .expect(400);
          |          ^
      484 |
      485 |       expect(response.body.success).toBe(false);
      486 |     });

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:483:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Type Coercion Attacks ‚Ä∫ should reject array as string

    expected 400 "Bad Request", got 404 "Not Found"

      494 |           name: ['H', 'o', 'r', 's', 'e'], // Array where string expected
      495 |         })
    > 496 |         .expect(400);
          |          ^
      497 |
      498 |       expect(response.body.success).toBe(false);
      499 |     });

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:496:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Type Coercion Attacks ‚Ä∫ should reject numeric string with leading zeros

    expected 400 "Bad Request", got 404 "Not Found"

      507 |           age: '005', // Leading zeros
      508 |         })
    > 509 |         .expect(400);
          |          ^
      510 |
      511 |       expect(response.body.success).toBe(false);
      512 |     });

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:509:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Type Coercion Attacks ‚Ä∫ should reject scientific notation where integers expected

    expected 400 "Bad Request", got 404 "Not Found"

      520 |           age: 5e1, // Scientific notation (50)
      521 |         })
    > 522 |         .expect(400);
          |          ^
      523 |
      524 |       expect(response.body.success).toBe(false);
      525 |     });

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:522:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Type Coercion Attacks ‚Ä∫ should reject Infinity and NaN values

    expected 400 "Bad Request", got 404 "Not Found"

      533 |           age: Infinity,
      534 |         })
    > 535 |         .expect(400);
          |          ^
      536 |
      537 |       expect(response.body.success).toBe(false);
      538 |     });

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:535:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Mass Assignment Vulnerabilities ‚Ä∫ should reject attempts to modify protected fields

    expected 400 "Bad Request", got 404 "Not Found"

      550 |           id: 88888, // Attempting to change ID
      551 |         })
    > 552 |         .expect(400);
          |          ^
      553 |
      554 |       expect(response.body.success).toBe(false);
      555 |

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:552:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Mass Assignment Vulnerabilities ‚Ä∫ should reject attempts to set createdAt/updatedAt manually

    expected 400 "Bad Request", got 404 "Not Found"

      570 |           updatedAt: new Date('2020-01-01'),
      571 |         })
    > 572 |         .expect(400);
          |          ^
      573 |
      574 |       expect(response.body.success).toBe(false);
      575 |     });

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:572:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Mass Assignment Vulnerabilities ‚Ä∫ should only allow whitelisted fields in updates

    expected 400 "Bad Request", got 404 "Not Found"

      585 |           anotherBadField: 'AnotherHack',
      586 |         })
    > 587 |         .expect(400);
          |          ^
      588 |
      589 |       expect(response.body.success).toBe(false);
      590 |       expect(response.body.message).toContain('unexpected');

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:587:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Mass Assignment Vulnerabilities ‚Ä∫ should reject attempts to add new fields

    expected 400 "Bad Request", got 404 "Not Found"

      600 |           newCustomField: 'HackedValue',
      601 |         })
    > 602 |         .expect(400);
          |          ^
      603 |
      604 |       expect(response.body.success).toBe(false);
      605 |     });

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:602:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Parameter Injection via Headers ‚Ä∫ should reject parameter injection via custom headers

    expected 200 "OK", got 404 "Not Found"

      612 |         .set('Authorization', `Bearer ${validToken}`)
      613 |         .set('X-Horse-Id', '999') // Attempting to override ID via header
    > 614 |         .expect(200); // Should use URL param, not header
          |          ^
      615 |
      616 |       expect(response.body.data.id).toBe(testHorse.id);
      617 |       expect(response.body.data.id).not.toBe(999);

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:614:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Race Condition via Parameter Timing ‚Ä∫ should prevent race conditionsin concurrent updates

    expect(received).toContain(expected) // indexOf

    Expected value: 404
    Received array: [200, 409, 400]

      658 |
      659 |       // Both should succeed (200 OK) or gracefully conflict
    > 660 |       expect([200, 409, 400]).toContain(response1.status);
          |                               ^
      661 |       expect([200, 409, 400]).toContain(response2.status);
      662 |
      663 |       // Verify final state persisted without conflict

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:660:31)

 FAIL  tests/training.test.mjs
  ‚óè ÔøΩÔøΩÔ∏è INTEGRATION: Training System - Complete Business Logic Validation ‚Ä∫ BUSINESS RULE: Age Requirements (3+ years old) ‚Ä∫ BLOCKS training for horses under 3 years old

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 404

      233 |       });
      234 |
    > 235 |       expect(response.status).toBe(400);
          |                               ^
      236 |       expect(response.body.success).toBe(false);
      237 |       expect(response.body.message).toContain('age');
      238 |

      at Object.<anonymous> (tests/training.test.mjs:235:31)

  ‚óè ÔøΩÔøΩÔ∏è INTEGRATION: Training System - Complete Business Logic Validation ‚Ä∫ BUSINESS RULE: Age Requirements (3+ years old) ‚Ä∫ ALLOWS training for horses 3+ years old

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

      256 |       });
      257 |
    > 258 |       expect(response.status).toBe(200);
          |                               ^
      259 |       expect(response.body.success).toBe(true);
      260 |       expect(response.body.message).toContain('trained in Dressage');
      261 |

      at Object.<anonymous> (tests/training.test.mjs:258:31)

  ‚óè ÔøΩÔøΩÔ∏è INTEGRATION: Training System - Complete Business Logic Validation ‚Ä∫ BUSINESS RULE: Discipline Score Progression(+5 base) ‚Ä∫ INCREASES discipline scores by +5 for first-time training

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

      310 |       });
      311 |
    > 312 |       expect(response.status).toBe(200);
          |                               ^
      313 |       expect(response.body.success).toBe(true);
      314 |
      315 |       // VERIFY: Exact score increase in database

      at Object.<anonymous> (tests/training.test.mjs:312:31)

  ‚óè ÔøΩÔøΩÔ∏è INTEGRATION: Training System - Complete Business Logic Validation ‚Ä∫ BUSINESS RULE: Discipline Score Progression(+5 base) ‚Ä∫ ACCUMULATES discipline scores across multiple training sessions (different horses)

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

      382 |       });
      383 |
    > 384 |       expect(response1.status).toBe(200);
          |                                ^
      385 |
      386 |       // VERIFY: Horse 1 now has Cross Country score
      387 |       const horse1AfterTraining = await prisma.horse.findUnique({

      at Object.<anonymous> (tests/training.test.mjs:384:32)

  ‚óè ÔøΩÔøΩÔ∏è INTEGRATION: Training System - Complete Business Logic Validation ‚Ä∫ BUSINESS RULE: Global Cooldown (One Discipline Per Week) ‚Ä∫ BLOCKS training when horse has trained ANY discipline within 7 days

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 404

      413 |       });
      414 |
    > 415 |       expect(response.status).toBe(400);
          |                               ^
      416 |       expect(response.body.success).toBe(false);
      417 |       expect(response.body.message).toContain('Training cooldown active');
      418 |

      at Object.<anonymous> (tests/training.test.mjs:415:31)

  ‚óè ÔøΩÔøΩÔ∏è INTEGRATION: Training System - Complete Business Logic Validation ‚Ä∫ BUSINESS RULE: Global Cooldown (One Discipline Per Week) ‚Ä∫ ALLOWS training after 7-day cooldown expires

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

      471 |       });
      472 |
    > 473 |       expect(response.status).toBe(200);
          |                               ^
      474 |       expect(response.body.success).toBe(true);
      475 |
      476 |       // VERIFY: New discipline score created

      at Object.<anonymous> (tests/training.test.mjs:473:31)

  ‚óè ÔøΩÔøΩÔ∏è INTEGRATION: Training System - Complete Business Logic Validation ‚Ä∫ BUSINESS RULE: XP Award for Training ‚Ä∫ AWARDS XP to horse owner (Player) when training succeeds

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

      524 |       });
      525 |
    > 526 |       expect(response.status).toBe(200);
          |                               ^
      527 |       expect(response.body.success).toBe(true);
      528 |
      529 |       // VERIFY: Training completed successfully

      at Object.<anonymous> (tests/training.test.mjs:526:31)

  ‚óè ÔøΩÔøΩÔ∏è INTEGRATION: Training System - Complete Business Logic Validation ‚Ä∫ BUSINESS RULE: Training Log Creation ‚Ä∫ CREATES training log entry for successful training

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

      585 |       });
      586 |
    > 587 |       expect(response.status).toBe(200);
          |                               ^
      588 |
      589 |       // VERIFY: Training log exists with correct data
      590 |       const trainingLogs = await prisma.trainingLog.findMany({

      at Object.<anonymous> (tests/training.test.mjs:587:31)

  ‚óè ÔøΩÔøΩÔ∏è INTEGRATION: Training System - Complete Business Logic Validation ‚Ä∫ BUSINESS RULE: Error Handling and Data Integrity ‚Ä∫ MAINTAINS database integrity when training non-existent horse

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 404

      621 |       });
      622 |
    > 623 |       expect(response.status).toBe(400);
          |                               ^
      624 |       expect(response.body.success).toBe(false);
      625 |       expect(response.body.message).toContain('Horse not found');
      626 |

      at Object.<anonymous> (tests/training.test.mjs:623:31)

  ‚óè ÔøΩÔøΩÔ∏è INTEGRATION: Training System - Complete Business Logic Validation ‚Ä∫ BUSINESS RULE: Next Training Date Calculation ‚Ä∫ PROVIDES accurate next training date (7 days from training)

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

      674 |       });
      675 |
    > 676 |       expect(response.status).toBe(200);
          |                               ^
      677 |       expect(response.body.nextEligibleDate).toBeDefined();
      678 |
      679 |       // VERIFY: Next eligible date is approximately 7 days from now

      at Object.<anonymous> (tests/training.test.mjs:676:31)

 FAIL  tests/foalEnrichmentIntegration.test.mjs
  ‚óè ÔøΩÔøΩ INTEGRATION: Foal Enrichment API Integration - Complete API Workflow Validation ‚Ä∫ POST /api/foals/:foalId/enrichment ‚Ä∫ should complete enrichment activity successfully

    expected 200 "OK", got 404 "Not Found"

      138 |           activity: 'Trailer Exposure',
      139 |         })
    > 140 |         .expect(200);
          |          ^
      141 |
      142 |       expect(response.body.success).toBe(true);
      143 |       expect(response.body.message).toContain('Trailer Exposure');

      at Object.<anonymous> (tests/foalEnrichmentIntegration.test.mjs:140:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: Foal Enrichment API Integration - Complete API Workflow Validation ‚Ä∫ POST /api/foals/:foalId/enrichment ‚Ä∫ should update horse bond_score and stress_level in database

    expected 200 "OK", got 404 "Not Found"

      199 |           activity: 'Halter Introduction',
      200 |         })
    > 201 |         .expect(200);
          |          ^
      202 |
      203 |       // Verify horse was updated in database
      204 |       expect(mockPrisma.horse.update).toHaveBeenCalledWith({

      at Object.<anonymous> (tests/foalEnrichmentIntegration.test.mjs:201:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: Foal Enrichment API Integration - Complete API Workflow Validation ‚Ä∫ POST /api/foals/:foalId/enrichment ‚Ä∫ should validate request parameters

    expected 400 "Bad Request", got 404 "Not Found"

      223 |           activity: 'Trailer Exposure',
      224 |         })
    > 225 |         .expect(400);
          |          ^
      226 |
      227 |       // Missing activity
      228 |       await request(app)

      at Object.<anonymous> (tests/foalEnrichmentIntegration.test.mjs:225:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: Foal Enrichment API Integration - Complete API Workflow Validation ‚Ä∫ POST /api/foals/:foalId/enrichment ‚Ä∫ should return 400 for inappropriate activity for day

    expected 400 "Bad Request", got 404 "Not Found"

      288 |           activity: 'Trailer Exposure', // This is a day 3 activity
      289 |         })
    > 290 |         .expect(400);
          |          ^
      291 |
      292 |       expect(response.body.success).toBe(false);
      293 |       expect(response.body.message).toContain('not appropriate for day 0');

      at Object.<anonymous> (tests/foalEnrichmentIntegration.test.mjs:290:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: Foal Enrichment API Integration - Complete API Workflow Validation ‚Ä∫ POST /api/foals/:foalId/enrichment ‚Ä∫ should accept different activity name formats

    expected 200 "OK", got 404 "Not Found"

      303 |           activity: 'leading_practice',
      304 |         })
    > 305 |         .expect(200);
          |          ^
      306 |
      307 |       // Test exact name
      308 |       await request(app)

      at Object.<anonymous> (tests/foalEnrichmentIntegration.test.mjs:305:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: Foal Enrichment API Integration - Complete API Workflow Validation ‚Ä∫ POST /api/foals/:foalId/enrichment ‚Ä∫ should handle all day 3 activities

    expected 200 "OK", got 404 "Not Found"

      336 |             activity,
      337 |           })
    > 338 |           .expect(200);
          |            ^
      339 |
      340 |         expect(response.body.success).toBe(true);
      341 |         expect(response.body.data.activity.name).toBe(activity);

      at Object.<anonymous> (tests/foalEnrichmentIntegration.test.mjs:338:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: Foal Enrichment API Integration - Complete API Workflow Validation ‚Ä∫ POST /api/foals/:foalId/enrichment ‚Ä∫ should create training history records for each activity

    expected 200 "OK", got 404 "Not Found"

      367 |           activity: 'Feeding Assistance',
      368 |         })
    > 369 |         .expect(200);
          |          ^
      370 |
      371 |       // Verify training record was created
      372 |       expect(mockPrisma.foalTrainingHistory.create).toHaveBeenCalledWith({

      at Object.<anonymous> (tests/foalEnrichmentIntegration.test.mjs:369:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: Foal Enrichment API Integration - Complete API Workflow Validation ‚Ä∫ POST /api/foals/:foalId/enrichment ‚Ä∫ should handle edge cases with bond and stress levels

    expected 200 "OK", got 404 "Not Found"

      409 |           activity: 'Trailer Exposure',
      410 |         })
    > 411 |         .expect(200);
          |          ^
      412 |
      413 |       // Values should be capped at bounds
      414 |       expect(response.body.data.updatedLevels.bondScore).toBeLessThanOrEqual(100);

      at Object.<anonymous> (tests/foalEnrichmentIntegration.test.mjs:411:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

 FAIL  tests/auth.test.mjs
  ‚óè ÔøΩÔøΩ INTEGRATION: Authentication System - User Registration & Session Management ‚Ä∫ POST /api/auth/register ‚Ä∫ should register a new user and player successfully

    expect(received).toBe(expected) // Object.is equality

    Expected: "User registered successfully"
    Received: "User registered successfully. Please check your email to verify your account."

      136 |       const response = await request(app).post('/api/auth/register').send(userData).expect(201);
      137 |       expect(response.body.status).toBe('success'); // Check for status field
    > 138 |       expect(response.body.message).toBe('User registered successfully');
          |                                     ^
      139 |
      140 |       // User details assertions
      141 |       expect(response.body.data.user.email).toBe(userData.email);

      at Object.<anonymous> (tests/auth.test.mjs:138:37)

  ‚óè ÔøΩÔøΩ INTEGRATION: Authentication System - User Registration & Session Management ‚Ä∫ POST /api/auth/login ‚Ä∫ should login successfully with valid credentials

    expected 200 "OK", got 429 "Too Many Requests"

      223 |       });
      224 |
    > 225 |       const response = await request(app).post('/api/auth/login').send(loginData).expect(200);
          |                                                                                   ^
      226 |
      227 |       expect(response.body.status).toBe('success');
      228 |       expect(response.body.message).toBe('Login successful');

      at Object.<anonymous> (tests/auth.test.mjs:225:83)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: Authentication System - User Registration & Session Management ‚Ä∫ POST /api/auth/login ‚Ä∫ should reject login with invalid email

    expected 401 "Unauthorized", got 429 "Too Many Requests"

      245 |       });
      246 |
    > 247 |       const response = await request(app).post('/api/auth/login').send(loginData).set('x-test-require-auth', 'true').expect(401);
          |         ^
      248 |
      249 |       expect(response.body.success).toBe(false);
      250 |       expect(response.body.message).toBe('Invalid email or password');

      at Object.<anonymous> (tests/auth.test.mjs:247:118)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: Authentication System - User Registration & Session Management ‚Ä∫ POST /api/auth/login ‚Ä∫ should reject login with invalid password

    expected 401 "Unauthorized", got 429 "Too Many Requests"

      257 |       });
      258 |
    > 259 |       const response = await request(app).post('/api/auth/login').send(loginData).set('x-test-require-auth', 'true').expect(401);
          |         ^
      260 |
      261 |       expect(response.body.success).toBe(false);
      262 |       expect(response.body.message).toBe('Invalid email or password');

      at Object.<anonymous> (tests/auth.test.mjs:259:118)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: Authentication System - User Registration & Session Management ‚Ä∫ POST /api/auth/login ‚Ä∫ should reject login with malformed email

    expected 400 "Bad Request", got 429 "Too Many Requests"

      268 |       });
      269 |
    > 270 |       const response = await request(app).post('/api/auth/login').send(loginData).expect(400);
          |                                                                                   ^
      271 |
      272 |       expect(response.body.success).toBe(false);
      273 |       expect(response.body.message).toBe('Valid email is required');

      at Object.<anonymous> (tests/auth.test.mjs:270:83)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: Authentication System - User Registration & Session Management ‚Ä∫ POST /api/auth/refresh ‚Ä∫ should refresh token successfully with valid refresh token

    expected 200 "OK", got 429 "Too Many Requests"

      297 |         .post('/api/auth/refresh')
      298 |         .send({ refreshToken: refreshTokenValue })
    > 299 |         .expect(200);
          |          ^
      300 |       expect(response.body.status).toBe('success');
      301 |       expect(response.body.message).toBe('Token refreshed successfully');
      302 |

      at Object.<anonymous> (tests/auth.test.mjs:299:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: Authentication System - User Registration & Session Management ‚Ä∫ POST /api/auth/refresh ‚Ä∫ should reject refresh with invalid token

    expected 401 "Unauthorized", got 429 "Too Many Requests"

      309 |
      310 |     it('should reject refresh with invalid token', async () => {
    > 311 |       const response = await request(app).post('/api/auth/refresh').send({ refreshToken: 'invalid-token' }).set('x-test-require-auth', 'true').expect(401);
          |                                   ^
      312 |
      313 |       expect(response.body.success).toBe(false);
      314 |       expect(response.body.message).toBe('Invalid or expired refresh token');

      at Object.<anonymous> (tests/auth.test.mjs:311:144)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: Authentication System - User Registration & Session Management ‚Ä∫ POST /api/auth/refresh ‚Ä∫ should reject refresh without token

    expected 400 "Bad Request", got 429 "Too Many Requests"

      316 |
      317 |     it('should reject refresh without token', async () => {
    > 318 |       const response = await request(app).post('/api/auth/refresh').send({}).expect(400);
          |                                                                              ^
      319 |
      320 |       expect(response.body.success).toBe(false);
      321 |       expect(response.body.message).toBe('Refresh token is required');

      at Object.<anonymous> (tests/auth.test.mjs:318:78)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: Authentication System - User Registration & Session Management ‚Ä∫ GET /api/auth/me ‚Ä∫ should get userprofile successfully with valid token

    TypeError: Cannot read properties of undefined (reading 'user')

      340 |       const cookies = registerResponse.headers['set-cookie'];
      341 |       authToken = extractCookie(cookies, 'accessToken');
    > 342 |       testUser = registerResponse.body.data.user;
          |                                             ^
      343 |     });
      344 |
      345 |     it('should get user profile successfully with valid token', async () => {

      at Object.<anonymous> (tests/auth.test.mjs:342:45)

  ‚óè ÔøΩÔøΩ INTEGRATION: Authentication System - User Registration & Session Management ‚Ä∫ GET /api/auth/me ‚Ä∫ should reject profile request without token

    TypeError: Cannot read properties of undefined (reading 'user')

      340 |       const cookies = registerResponse.headers['set-cookie'];
      341 |       authToken = extractCookie(cookies, 'accessToken');
    > 342 |       testUser = registerResponse.body.data.user;
          |                                             ^
      343 |     });
      344 |
      345 |     it('should get user profile successfully with valid token', async () => {

      at Object.<anonymous> (tests/auth.test.mjs:342:45)

  ‚óè ÔøΩÔøΩ INTEGRATION: Authentication System - User Registration & Session Management ‚Ä∫ GET /api/auth/me ‚Ä∫ should reject profile request with invalid token

    TypeError: Cannot read properties of undefined (reading 'user')

      340 |       const cookies = registerResponse.headers['set-cookie'];
      341 |       authToken = extractCookie(cookies, 'accessToken');
    > 342 |       testUser = registerResponse.body.data.user;
          |                                             ^
      343 |     });
      344 |
      345 |     it('should get user profile successfully with valid token', async () => {

      at Object.<anonymous> (tests/auth.test.mjs:342:45)

  ‚óè ÔøΩÔøΩ INTEGRATION: Authentication System - User Registration & Session Management ‚Ä∫ POST /api/auth/logout ‚Ä∫ should logout successfully with valid token

    expected 200 "OK", got 401 "Unauthorized"

      390 |         .post('/api/auth/logout')
      391 |         .set('Authorization', `Bearer ${authToken}`)
    > 392 |         .expect(200);
          |          ^
      393 |
      394 |       expect(response.body.status).toBe('success');
      395 |       expect(response.body.message).toBe('Logout successful');

      at Object.<anonymous> (tests/auth.test.mjs:392:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

 FAIL  tests/integration/userProgressAPI.integration.test.mjs
  ‚óè ÔøΩÔøΩ INTEGRATION: User Progress API - Complete Progress Tracking ‚Ä∫ ÔøΩÔøΩ STEP 1: User Setup & Initial Progress State ‚Ä∫ should return correct initial progress data via API

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 1

    @@ -1,9 +1,9 @@
      Object {
        "level": 1,
        "progressPercentage": 0,
    -   "totalEarnings": 5000,
    +   "totalEarnings": 1000,
        "userId": "7e7630d4-0e39-40b8-8306-01f7e93c56ae",
        "username": "progresstest",
        "xp": 0,
        "xpForCurrentLevel": 0,
        "xpForNextLevel": 200,

      154 |
      155 |       expect(response.body.success).toBe(true);
    > 156 |       expect(response.body.data).toEqual({
          |                                  ^
      157 |         userId: testUser.id,
      158 |         username: testUser.username,
      159 |         level: 1,

      at Object.<anonymous> (tests/integration/userProgressAPI.integration.test.mjs:156:34)

  ‚óè ÔøΩÔøΩ INTEGRATION: User Progress API - Complete Progress Tracking ‚Ä∫ ÔøΩÔøΩÔ∏è STEP 3: XP Gain Through Training & Progress Updates ‚Ä∫ should gain XP from training and update progress correctly

    expected 200 "OK", got 403 "Forbidden"

      221 |           discipline: 'Racing',
      222 |         })
    > 223 |         .expect(200);
          |          ^
      224 |
      225 |       expect(trainingResponse.body.success).toBe(true);
      226 |

      at Object.<anonymous> (tests/integration/userProgressAPI.integration.test.mjs:223:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: User Progress API - Complete Progress Tracking ‚Ä∫ ÔøΩÔøΩÔ∏è STEP 3: XP Gain Through Training & Progress Updates ‚Ä∫ should handle multiple training sessions and XP accumulation

    expected 200 "OK", got 403 "Forbidden"

      273 |             discipline,
      274 |           })
    > 275 |           .expect(200);
          |            ^
      276 |       }
      277 |
      278 |       // STEP 2: Verify accumulated XP (should be 55 total, still level 1 - appropriate pacing)

      at Object.<anonymous> (tests/integration/userProgressAPI.integration.test.mjs:275:12)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: User Progress API - Complete Progress Tracking ‚Ä∫ ÔøΩÔøΩ STEP 4: Level-Up Detection & Multi-Level Progression ‚Ä∫ should level up when reaching XP threshold

    expected 200 "OK", got 403 "Forbidden"

      320 |           discipline: 'Cross Country',
      321 |         })
    > 322 |         .expect(200);
          |          ^
      323 |
      324 |       expect(trainingResponse.body.success).toBe(true);
      325 |

      at Object.<anonymous> (tests/integration/userProgressAPI.integration.test.mjs:322:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: User Progress API - Complete Progress Tracking ‚Ä∫ ÔøΩÔøΩ STEP 4: Level-Up Detection & Multi-Level Progression ‚Ä∫ should handle multiple level gains in single XP award

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 1

    @@ -1,9 +1,9 @@
      Object {
        "level": 3,
        "progressPercentage": 50,
    -   "totalEarnings": 5000,
    +   "totalEarnings": 1000,
        "userId": "7e7630d4-0e39-40b8-8306-01f7e93c56ae",
        "username": "progresstest",
        "xp": 350,
        "xpForCurrentLevel": 300,
        "xpForNextLevel": 400,

      360 |         .expect(200);
      361 |
    > 362 |       expect(progressResponse.body.data).toEqual({
          |                                          ^
      363 |         userId: testUser.id,
      364 |         username: testUser.username,
      365 |         level: 3,

      at Object.<anonymous> (tests/integration/userProgressAPI.integration.test.mjs:362:42)

  ‚óè ÔøΩÔøΩ INTEGRATION: User Progress API - Complete Progress Tracking ‚Ä∫ ÔøΩÔøΩ STEP 5: Dashboard Data Integration ‚Ä∫ should return comprehensive dashboard data with progress integration

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 1

    @@ -12,10 +12,10 @@
          "upcomingEntries": 0,
        },
        "user": Object {
          "id": "7e7630d4-0e39-40b8-8306-01f7e93c56ae",
          "level": 3,
    -     "money": 5000,
    +     "money": 1000,
          "username": "progresstest",
          "xp": 350,
        },
      }

      382 |
      383 |       expect(dashboardResponse.body.success).toBe(true);
    > 384 |       expect(dashboardResponse.body.data).toEqual({
          |                                           ^
      385 |         user: {
      386 |           id: testUser.id,
      387 |           username: testUser.username,

      at Object.<anonymous> (tests/integration/userProgressAPI.integration.test.mjs:384:43)

 FAIL  __tests__/routes/memoryManagementRoutes.test.mjs
  ‚óè Memory Management Routes ‚Ä∫ Real-time Monitoring Integration ‚Ä∫ status endpoint reflects current monitoring state

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      438 |         .expect(200);
      439 |
    > 440 |       expect(response.body.data.monitoring.isActive).toBe(true);
          |                                                      ^
      441 |       expect(response.body.data.monitoring.uptime).toBeGreaterThan(0);
      442 |     });
      443 |

      at Object.<anonymous> (__tests__/routes/memoryManagementRoutes.test.mjs:440:54)

 FAIL  tests/routes/groomRetirementRoutes.test.mjs
  ‚óè Groom Retirement Routes ‚Ä∫ Talent Endpoints ‚Ä∫ POST /api/grooms/:id/talents/validate should validate talent selection

    expected 200 "OK", got 403 "Forbidden"

      190 |           talentId: 'gentle_hands',
      191 |         })
    > 192 |         .expect(200);
          |          ^
      193 |
      194 |       expect(response.body.success).toBe(true);
      195 |       expect(response.body.data).toHaveProperty('valid');

      at Object.<anonymous> (tests/routes/groomRetirementRoutes.test.mjs:192:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Groom Retirement Routes ‚Ä∫ Talent Endpoints ‚Ä∫ POST /api/grooms/:id/talents/select should select talent

    expected 200 "OK", got 403 "Forbidden"

      204 |           talentId: 'gentle_hands',
      205 |         })
    > 206 |         .expect(200);
          |          ^
      207 |
      208 |       expect(response.body.success).toBe(true);
      209 |       expect(response.body.data).toHaveProperty('selection');

      at Object.<anonymous> (tests/routes/groomRetirementRoutes.test.mjs:206:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Groom Retirement Routes ‚Ä∫ Validation ‚Ä∫ should validate talent selection data

    expected 400 "Bad Request", got 403 "Forbidden"

      253 |           talentId: 'gentle_hands',
      254 |         })
    > 255 |         .expect(400);
          |          ^
      256 |     });
      257 |   });
      258 | });

      at Object.<anonymous> (tests/routes/groomRetirementRoutes.test.mjs:255:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

 FAIL  tests/routes/enhancedReportingRoutes.test.mjs
  ‚óè Enhanced Reporting API Routes ‚Ä∫ Multi-Horse Analysis Endpoints ‚Ä∫ POST /api/horses/compare-epigenetics should compare multiple horses

    expected 200 "OK", got 403 "Forbidden"

      256 |           horseIds: [testHorses[0].id, testHorses[1].id, testHorses[2].id],
      257 |         })
    > 258 |         .expect(200);
          |          ^
      259 |
      260 |       expect(response.body.success).toBe(true);
      261 |       expect(response.body.data).toBeDefined();

      at Object.<anonymous> (tests/routes/enhancedReportingRoutes.test.mjs:258:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Enhanced Reporting API Routes ‚Ä∫ Authentication and Validation ‚Ä∫ should validate horse ownership for reporting endpoints

    expected 403 "Forbidden", got 404 "Not Found"

      356 |         .get(`/api/horses/${otherHorse.id}/enhanced-trait-history`)
      357 |         .set('Authorization', `Bearer ${authToken}`)
    > 358 |         .expect(403);
          |          ^
      359 |
      360 |       // Cleanup
      361 |       await prisma.horse.delete({ where: { id: otherHorse.id } });

      at Object.<anonymous> (tests/routes/enhancedReportingRoutes.test.mjs:358:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Enhanced Reporting API Routes ‚Ä∫ Authentication and Validation ‚Ä∫ should validate input parameters for comparison endpoint

    expected 400 "Bad Request", got 403 "Forbidden"

      370 |           horseIds: [], // Empty array should be invalid
      371 |         })
    > 372 |         .expect(400);
          |          ^
      373 |     });
      374 |
      375 |     test('should handle non-existent horse IDs in reporting', async () => {

      at Object.<anonymous> (tests/routes/enhancedReportingRoutes.test.mjs:372:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

 FAIL  tests/routes/advancedEpigeneticRoutes.test.mjs
  ‚óè Advanced Epigenetic API Routes ‚Ä∫ Environmental Trigger Endpoints ‚Ä∫ POST /api/horses/:id/evaluate-trait-opportunity should evaluate trait development opportunity

    expected 200 "OK", got 403 "Forbidden"

      185 |           windowName: 'early_socialization',
      186 |         })
    > 187 |         .expect(200);
          |          ^
      188 |
      189 |       expect(response.body.success).toBe(true);
      190 |       expect(response.body.data).toBeDefined();

      at Object.<anonymous> (tests/routes/advancedEpigeneticRoutes.test.mjs:187:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Advanced Epigenetic API Routes ‚Ä∫ Environmental Trigger Endpoints ‚Ä∫ should validate horse ownership for environmental endpoints

    expected 403 "Forbidden", got 404 "Not Found"

      230 |         .get(`/api/horses/${otherHorse.id}/environmental-analysis`)
      231 |         .set('Authorization', `Bearer ${authToken}`)
    > 232 |         .expect(403);
          |          ^
      233 |
      234 |       // Cleanup
      235 |       await prisma.horse.delete({ where: { id: otherHorse.id } });

      at Object.<anonymous> (tests/routes/advancedEpigeneticRoutes.test.mjs:232:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Advanced Epigenetic API Routes ‚Ä∫ Developmental Window Endpoints ‚Ä∫ POST /api/horses/:id/coordinate-development should coordinate multi-window development

    expected 200 "OK", got 403 "Forbidden"

      339 |         .set('Authorization', `Bearer ${authToken}`)
      340 |         .send({})
    > 341 |         .expect(200);
          |          ^
      342 |
      343 |       expect(response.body.success).toBe(true);
      344 |       expect(response.body.data).toBeDefined();

      at Object.<anonymous> (tests/routes/advancedEpigeneticRoutes.test.mjs:341:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Advanced Epigenetic API Routes ‚Ä∫ Input Validation ‚Ä∫ should validate trait opportunity evaluation input

    expected 400 "Bad Request", got 403 "Forbidden"

      359 |           windowName: 'early_socialization',
      360 |         })
    > 361 |         .expect(400);
          |          ^
      362 |     });
      363 |
      364 |     test('should validate forecast days parameter', async () => {

      at Object.<anonymous> (tests/routes/advancedEpigeneticRoutes.test.mjs:361:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

 FAIL  tests/integration/groomPerformanceSystem.test.mjs
  ‚óè Groom Performance System ‚Ä∫ API Endpoints ‚Ä∫ should record performance via API

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 403

      189 |         });
      190 |
    > 191 |       expect(response.status).toBe(201);
          |                               ^
      192 |       expect(response.body.success).toBe(true);
      193 |       expect(response.body.data).toHaveProperty('id');
      194 |       expect(response.body.data.interactionType).toBe('enrichment');

      at Object.<anonymous> (tests/integration/groomPerformanceSystem.test.mjs:191:31)

  ‚óè Groom Performance System ‚Ä∫ API Endpoints ‚Ä∫ should validate groom ownership

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 404

      297 |         .set('Authorization', `Bearer ${authToken}`);
      298 |
    > 299 |       expect(response.status).toBe(403);
          |                               ^
      300 |       expect(response.body.success).toBe(false);
      301 |       expect(response.body.message).toContain('You do not own this groom');
      302 |

      at Object.<anonymous> (tests/integration/groomPerformanceSystem.test.mjs:299:31)

  ‚óè Groom Performance System ‚Ä∫ API Endpoints ‚Ä∫ should validate input parameters

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 403

      316 |         });
      317 |
    > 318 |       expect(response1.status).toBe(400);
          |                                ^
      319 |       expect(response1.body.success).toBe(false);
      320 |
      321 |       // Test invalid bond gain

      at Object.<anonymous> (tests/integration/groomPerformanceSystem.test.mjs:318:32)

  ‚óè Groom Performance System ‚Ä∫ Authentication ‚Ä∫ should require authentication for GET /api/groom-performance/groom/:groomId

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 403

      389 |       const response = await request(app).get(`/api/groom-performance/groom/${testGroom.id}`);
      390 |
    > 391 |       expect(response.status).toBe(401);
          |                               ^
      392 |       expect(response.body.success).toBe(false);
      393 |     });
      394 |

      at Object.<anonymous> (tests/integration/groomPerformanceSystem.test.mjs:391:31)

  ‚óè Groom Performance System ‚Ä∫ Authentication ‚Ä∫ should require authentication for GET /api/groom-performance/config

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 200

      403 |       const response = await request(app).get('/api/groom-performance/config');
      404 |
    > 405 |       expect(response.status).toBe(401);
          |                               ^
      406 |       expect(response.body.success).toBe(false);
      407 |     });
      408 |

      at Object.<anonymous> (tests/integration/groomPerformanceSystem.test.mjs:405:31)

 FAIL  tests/integration/enhancedGroomInteractions.test.mjs
  ‚óè Enhanced Groom Interactions Integration Tests ‚Ä∫ 2. Perform Enhanced Interactions ‚Ä∫ should perform a basic enhanced interaction

    ReferenceError: interactionData is not defined

      155 |         .set('Authorization', `Bearer ${authToken}`)
      156 |         .set('x-test-skip-csrf', 'true')
    > 157 |         .send(interactionData);
          |               ^
      158 |
      159 |       expect(response.status).toBe(201);
      160 |       expect(response.body.success).toBe(true);

      at Object.<anonymous> (tests/integration/enhancedGroomInteractions.test.mjs:157:15)

  ‚óè Enhanced Groom Interactions Integration Tests ‚Ä∫ 3. Relationship Details ‚Ä∫ should get detailed relationship information

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

      360 |       expect(statistics).toHaveProperty('totalBonding');
      361 |       expect(statistics).toHaveProperty('averageQuality');
    > 362 |       expect(statistics.totalInteractions).toBeGreaterThan(0);
          |                                            ^
      363 |
      364 |       // Check recent interactions
      365 |       const { recentInteractions } = response.body.data;

      at Object.<anonymous> (tests/integration/enhancedGroomInteractions.test.mjs:362:44)

 FAIL  tests/controllers/personalityEvolutionController.test.mjs
  ‚óè Personality Evolution Controller API ‚Ä∫ POST /api/personality-evolution/groom/:groomId/evolve ‚Ä∫ should evolve groom personality successfully

    expected 200 "OK", got 403 "Forbidden"

      133 |         .post(`/api/personality-evolution/groom/${testGroom.id}/evolve`)
      134 |         .set('Authorization', `Bearer ${authToken}`)
    > 135 |         .expect(200);
          |          ^
      136 |
      137 |       expect(response.body.success).toBe(true);
      138 |       expect(response.body.message).toContain('evolution');

      at Object.<anonymous> (tests/controllers/personalityEvolutionController.test.mjs:135:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Personality Evolution Controller API ‚Ä∫ POST /api/personality-evolution/groom/:groomId/evolve ‚Ä∫ should return 400 for invalid groom ID

    expected 400 "Bad Request", got 403 "Forbidden"

      146 |         .post('/api/personality-evolution/groom/invalid/evolve')
      147 |         .set('Authorization', `Bearer ${authToken}`)
    > 148 |         .expect(400);
          |          ^
      149 |
      150 |       expect(response.body.success).toBe(false);
      151 |       expect(response.body.message).toContain('Validation failed');

      at Object.<anonymous> (tests/controllers/personalityEvolutionController.test.mjs:148:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Personality Evolution Controller API ‚Ä∫ POST /api/personality-evolution/horse/:horseId/evolve ‚Ä∫ should evolve horse temperament successfully

    expected 200 "OK", got 403 "Forbidden"

      165 |         .post(`/api/personality-evolution/horse/${testHorse.id}/evolve`)
      166 |         .set('Authorization', `Bearer ${authToken}`)
    > 167 |         .expect(200);
          |          ^
      168 |
      169 |       expect(response.body.success).toBe(true);
      170 |       expect(response.body.message).toContain('evolution');

      at Object.<anonymous> (tests/controllers/personalityEvolutionController.test.mjs:167:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Personality Evolution Controller API ‚Ä∫ POST /api/personality-evolution/horse/:horseId/evolve ‚Ä∫ should return 400 for invalid horse ID

    expected 400 "Bad Request", got 403 "Forbidden"

      178 |         .post('/api/personality-evolution/horse/invalid/evolve')
      179 |         .set('Authorization', `Bearer ${authToken}`)
    > 180 |         .expect(400);
          |          ^
      181 |
      182 |       expect(response.body.success).toBe(false);
      183 |       expect(response.body.message).toContain('Validation failed');

      at Object.<anonymous> (tests/controllers/personalityEvolutionController.test.mjs:180:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Personality Evolution Controller API ‚Ä∫ GET /api/personality-evolution/:entityType/:entityId/triggers ‚Ä∫ should get evolution triggers for groom

    expected 200 "OK", got 404 "Not Found"

      190 |         .get(`/api/personality-evolution/groom/${testGroom.id}/triggers`)
      191 |         .set('Authorization', `Bearer ${authToken}`)
    > 192 |         .expect(200);
          |          ^
      193 |
      194 |       expect(response.body.success).toBe(true);
      195 |       expect(response.body.data).toBeDefined();

      at Object.<anonymous> (tests/controllers/personalityEvolutionController.test.mjs:192:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Personality Evolution Controller API ‚Ä∫ GET /api/personality-evolution/:entityType/:entityId/triggers ‚Ä∫ should get evolution triggers for horse

    expected 200 "OK", got 404 "Not Found"

      203 |         .get(`/api/personality-evolution/horse/${testHorse.id}/triggers`)
      204 |         .set('Authorization', `Bearer ${authToken}`)
    > 205 |         .expect(200);
          |          ^
      206 |
      207 |       expect(response.body.success).toBe(true);
      208 |       expect(response.body.data).toBeDefined();

      at Object.<anonymous> (tests/controllers/personalityEvolutionController.test.mjs:205:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Personality Evolution Controller API ‚Ä∫ GET /api/personality-evolution/:entityType/:entityId/stability ‚Ä∫ should analyze personality stability for groom

    expected 200 "OK", got 404 "Not Found"

      227 |         .get(`/api/personality-evolution/groom/${testGroom.id}/stability`)
      228 |         .set('Authorization', `Bearer ${authToken}`)
    > 229 |         .expect(200);
          |          ^
      230 |
      231 |       expect(response.body.success).toBe(true);
      232 |       expect(response.body.data).toBeDefined();

      at Object.<anonymous> (tests/controllers/personalityEvolutionController.test.mjs:229:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Personality Evolution Controller API ‚Ä∫ GET /api/personality-evolution/:entityType/:entityId/stability ‚Ä∫ should analyze personality stability for horse

    expected 200 "OK", got 404 "Not Found"

      240 |         .get(`/api/personality-evolution/horse/${testHorse.id}/stability`)
      241 |         .set('Authorization', `Bearer ${authToken}`)
    > 242 |         .expect(200);
          |          ^
      243 |
      244 |       expect(response.body.success).toBe(true);
      245 |       expect(response.body.data).toBeDefined();

      at Object.<anonymous> (tests/controllers/personalityEvolutionController.test.mjs:242:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Personality Evolution Controller API ‚Ä∫ GET /api/personality-evolution/:entityType/:entityId/predict ‚Ä∫ should predict personality evolution with default timeframe

    expected 200 "OK", got 404 "Not Found"

      254 |         .get(`/api/personality-evolution/groom/${testGroom.id}/predict`)
      255 |         .set('Authorization', `Bearer ${authToken}`)
    > 256 |         .expect(200);
          |          ^
      257 |
      258 |       expect(response.body.success).toBe(true);
      259 |       expect(response.body.data).toBeDefined();

      at Object.<anonymous> (tests/controllers/personalityEvolutionController.test.mjs:256:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Personality Evolution Controller API ‚Ä∫ GET /api/personality-evolution/:entityType/:entityId/predict ‚Ä∫ should predict personality evolution with custom timeframe

    expected 200 "OK", got 404 "Not Found"

      266 |         .get(`/api/personality-evolution/horse/${testHorse.id}/predict?timeframeDays=60`)
      267 |         .set('Authorization', `Bearer ${authToken}`)
    > 268 |         .expect(200);
          |          ^
      269 |
      270 |       expect(response.body.success).toBe(true);
      271 |       expect(response.body.data).toBeDefined();

      at Object.<anonymous> (tests/controllers/personalityEvolutionController.test.mjs:268:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Personality Evolution Controller API ‚Ä∫ GET /api/personality-evolution/:entityType/:entityId/history ‚Ä∫ should get personality evolution history

    expected 200 "OK", got 404 "Not Found"

      289 |         .get(`/api/personality-evolution/groom/${testGroom.id}/history`)
      290 |         .set('Authorization', `Bearer ${authToken}`)
    > 291 |         .expect(200);
          |          ^
      292 |
      293 |       expect(response.body.success).toBe(true);
      294 |       expect(response.body.data).toBeDefined();

      at Object.<anonymous> (tests/controllers/personalityEvolutionController.test.mjs:291:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Personality Evolution Controller API ‚Ä∫ POST /api/personality-evolution/apply-effects ‚Ä∫ should apply personality evolution effects successfully

    expected 200 "OK", got 403 "Forbidden"

      314 |         .set('Authorization', `Bearer ${authToken}`)
      315 |         .send(evolutionData)
    > 316 |         .expect(200);
          |          ^
      317 |
      318 |       expect(response.body.success).toBe(true);
      319 |       expect(response.body.data).toBeDefined();

      at Object.<anonymous> (tests/controllers/personalityEvolutionController.test.mjs:316:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Personality Evolution Controller API ‚Ä∫ POST /api/personality-evolution/apply-effects ‚Ä∫ should return 400 for missing required fields

    expected 400 "Bad Request", got 403 "Forbidden"

      331 |         .set('Authorization', `Bearer ${authToken}`)
      332 |         .send(invalidData)
    > 333 |         .expect(400);
          |          ^
      334 |
      335 |       expect(response.body.success).toBe(false);
      336 |       expect(response.body.message).toContain('Validation failed');

      at Object.<anonymous> (tests/controllers/personalityEvolutionController.test.mjs:333:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Personality Evolution Controller API ‚Ä∫ POST /api/personality-evolution/batch-evolve ‚Ä∫ should process batch evolution successfully

    expected 200 "OK", got 403 "Forbidden"

      351 |         .set('Authorization', `Bearer ${authToken}`)
      352 |         .send(batchData)
    > 353 |         .expect(200);
          |          ^
      354 |
      355 |       expect(response.body.success).toBe(true);
      356 |       expect(response.body.data).toBeDefined();

      at Object.<anonymous> (tests/controllers/personalityEvolutionController.test.mjs:353:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Personality Evolution Controller API ‚Ä∫ POST /api/personality-evolution/batch-evolve ‚Ä∫ should return 400 for empty entities array

    expected 400 "Bad Request", got 403 "Forbidden"

      366 |         .set('Authorization', `Bearer ${authToken}`)
      367 |         .send({ entities: [] })
    > 368 |         .expect(400);
          |          ^
      369 |
      370 |       expect(response.body.success).toBe(false);
      371 |       expect(response.body.message).toContain('Validation failed');

      at Object.<anonymous> (tests/controllers/personalityEvolutionController.test.mjs:368:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

 FAIL  tests/integration/competitionAPIEndpoints.integration.test.mjs
  ‚óè ÔøΩÔøΩ INTEGRATION: Competition API Endpoints ‚Ä∫ ÔøΩÔøΩ GET /api/competition/eligibility/:horseId/:discipline ‚Ä∫ should reject access to horse not owned by user

    expected 403 "Forbidden", got 404 "Not Found"

      150 |         .get(`/api/competition/eligibility/${otherHorse.id}/Racing`)
      151 |         .set('Authorization', `Bearer ${authToken}`)
    > 152 |         .expect(403);
          |          ^
      153 |
      154 |       expect(response.body.success).toBe(false);
      155 |       expect(response.body.message).toBe('You do not own this horse');

      at Object.<anonymous> (tests/integration/competitionAPIEndpoints.integration.test.mjs:152:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: Competition API Endpoints ‚Ä∫ ÔøΩÔøΩ POST /api/competition/enter ‚Ä∫ should successfully enter horse in competition

    expected 201 "Created", got 403 "Forbidden"

      166 |           showId: testShow.id,
      167 |         })
    > 168 |         .expect(201);
          |          ^
      169 |
      170 |       expect(response.body.success).toBe(true);
      171 |       expect(response.body.message).toBe('Horse successfully entered in competition');

      at Object.<anonymous> (tests/integration/competitionAPIEndpoints.integration.test.mjs:168:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: Competition API Endpoints ‚Ä∫ ÔøΩÔøΩ POST /api/competition/enter ‚Ä∫ should reject duplicate entry

    expected 400 "Bad Request", got 403 "Forbidden"

      195 |           showId: testShow.id,
      196 |         })
    > 197 |         .expect(400);
          |          ^
      198 |
      199 |       expect(response.body.success).toBe(false);
      200 |       expect(response.body.message).toBe('Horse is already entered in this competition');

      at Object.<anonymous> (tests/integration/competitionAPIEndpoints.integration.test.mjs:197:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: Competition API Endpoints ‚Ä∫ ÔøΩÔøΩ POST /api/competition/enter ‚Ä∫ should reject invalid input

    expected 400 "Bad Request", got 403 "Forbidden"

      209 |           showId: testShow.id,
      210 |         })
    > 211 |         .expect(400);
          |          ^
      212 |
      213 |       expect(response.body.success).toBe(false);
      214 |       expect(response.body.message).toBe('Validation failed');

      at Object.<anonymous> (tests/integration/competitionAPIEndpoints.integration.test.mjs:211:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: Competition API Endpoints ‚Ä∫ ÔøΩÔøΩ POST /api/competition/execute ‚Ä∫ should successfully execute competition

    expected 200 "OK", got 403 "Forbidden"

      236 |           showId: testShow.id,
      237 |         })
    > 238 |         .expect(200);
          |          ^
      239 |
      240 |       expect(response.body.success).toBe(true);
      241 |       expect(response.body.message).toBe('Competition executed successfully');

      at Object.<anonymous> (tests/integration/competitionAPIEndpoints.integration.test.mjs:238:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: Competition API Endpoints ‚Ä∫ ÔøΩÔøΩ POST /api/competition/execute ‚Ä∫ should reject execution by non-host user

    expect(received).toBe(expected) // Object.is equality

    Expected: "Only the show host can execute this competition"
    Received: "Invalid CSRF token. Please refresh the page and try again."

      282 |
      283 |       expect(response.body.success).toBe(false);
    > 284 |       expect(response.body.message).toBe('Only the show host can execute this competition');
          |                                     ^
      285 |     });
      286 |
      287 |     test('should reject invalid show ID', async () => {

      at Object.<anonymous> (tests/integration/competitionAPIEndpoints.integration.test.mjs:284:37)

  ‚óè ÔøΩÔøΩ INTEGRATION: Competition API Endpoints ‚Ä∫ ÔøΩÔøΩ POST /api/competition/execute ‚Ä∫ should reject invalid show ID

    expected 404 "Not Found", got 403 "Forbidden"

      292 |           showId: 99999,
      293 |         })
    > 294 |         .expect(404);
          |          ^
      295 |
      296 |       expect(response.body.success).toBe(false);
      297 |       expect(response.body.message).toBe('Show not found');

      at Object.<anonymous> (tests/integration/competitionAPIEndpoints.integration.test.mjs:294:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

 FAIL  tests/ultraRareTraits.test.mjs
  ‚óè Ultra-Rare & Exotic Traits System ‚Ä∫ API Endpoints ‚Ä∫ POST /api/ultra-rare-traits/evaluate/:horseId should evaluate traits for owned horse

    expected 200 "OK", got 403 "Forbidden"

      307 |           },
      308 |         })
    > 309 |         .expect(200);
          |          ^
      310 |
      311 |       expect(response.body.success).toBe(true);
      312 |       expect(response.body.data.ultraRareResults).toBeDefined();

      at Object.<anonymous> (tests/ultraRareTraits.test.mjs:309:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Ultra-Rare & Exotic Traits System ‚Ä∫ API Endpoints ‚Ä∫ GET /api/ultra-rare-traits/horse/:horseId should return horse ultra-rare traits

    expected 200 "OK", got 404 "Not Found"

      320 |         .get(`/api/ultra-rare-traits/horse/${testHorse.id}`)
      321 |         .set('Authorization', `Bearer ${testToken}`)
    > 322 |         .expect(200);
          |          ^
      323 |
      324 |       expect(response.body.success).toBe(true);
      325 |       expect(response.body.data.horse.id).toBe(testHorse.id);

      at Object.<anonymous> (tests/ultraRareTraits.test.mjs:322:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Ultra-Rare & Exotic Traits System ‚Ä∫ API Endpoints ‚Ä∫ POST /api/ultra-rare-traits/groom/:groomId/assign-perks should assign perks to owned groom

    expected 200 "OK", got 403 "Forbidden"

      333 |         .post(`/api/ultra-rare-traits/groom/${testGroom.id}/assign-perks`)
      334 |         .set('Authorization', `Bearer ${testToken}`)
    > 335 |         .expect(200);
          |          ^
      336 |
      337 |       expect(response.body.success).toBe(true);
      338 |       expect(response.body.data.groom.id).toBe(testGroom.id);

      at Object.<anonymous> (tests/ultraRareTraits.test.mjs:335:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Ultra-Rare & Exotic Traits System ‚Ä∫ API Endpoints ‚Ä∫ should reject access to non-owned horse

    expected 403 "Forbidden", got 404 "Not Found"

      376 |         .get(`/api/ultra-rare-traits/horse/${otherHorse.id}`)
      377 |         .set('Authorization', `Bearer ${testToken}`)
    > 378 |         .expect(403);
          |          ^
      379 |
      380 |       // Clean up
      381 |       await prisma.horse.delete({ where: { id: otherHorse.id } });

      at Object.<anonymous> (tests/ultraRareTraits.test.mjs:378:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

 FAIL  tests/integration/competitionWorkflow.integration.test.mjs
  ‚óè ÔøΩÔøΩ INTEGRATION: Complete Competition Workflow ‚Ä∫ ÔøΩÔøΩ STEP 3: Competition Entry & Validation ‚Ä∫ should successfully enter horse in competition using API endpoint

    expected 201 "Created", got 403 "Forbidden"

      218 |           showId: testShow.id,
      219 |         })
    > 220 |         .expect(201);
          |          ^
      221 |
      222 |       expect(response.body.success).toBe(true);
      223 |       expect(response.body.message).toBe('Horse successfully entered in competition');

      at Object.<anonymous> (tests/integration/competitionWorkflow.integration.test.mjs:220:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè ÔøΩÔøΩ INTEGRATION: Complete Competition Workflow ‚Ä∫ ÔøΩÔøΩ STEP 4: Competition Execution & Scoring ‚Ä∫ should execute competition and calculate results

    expect(received).toBeTruthy()

    Received: null

      270 |       });
      271 |
    > 272 |       expect(existingResult).toBeTruthy(); // Should exist from entry step
          |                              ^
      273 |
      274 |       // Update with actual competition results
      275 |       competitionResult = await prisma.competitionResult.update({

      at Object.<anonymous> (tests/integration/competitionWorkflow.integration.test.mjs:272:30)

  ‚óè ÔøΩÔøΩ INTEGRATION: Complete Competition Workflow ‚Ä∫ ÔøΩÔøΩ STEP 5: Prize Distribution & XP Awards ‚Ä∫ should award prize money and XP for competition performance

    TypeError: Cannot read properties of undefined (reading 'prizeWon')

      296 |
      297 |       // Award prize money
    > 298 |       const prizeAmount = Number(competitionResult.prizeWon);
          |                                                    ^
      299 |       const updatedUser = await prisma.user.update({
      300 |         where: { id: testUser.id },
      301 |         data: {

      at Object.<anonymous> (tests/integration/competitionWorkflow.integration.test.mjs:298:52)

  ‚óè ÔøΩÔøΩ INTEGRATION: Complete Competition Workflow ‚Ä∫ ÔøΩÔøΩ STEP 6: Leaderboard & Rankings ‚Ä∫ should track historical performance

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 0
    Received array:  []

      370 |       });
      371 |
    > 372 |       expect(competitionHistory).toHaveLength(1);
          |                                  ^
      373 |       expect(competitionHistory[0].show.name).toBe(testShow.name);
      374 |       expect(Number(competitionHistory[0].score)).toBe(Number(competitionResult.score));
      375 |

      at Object.<anonymous> (tests/integration/competitionWorkflow.integration.test.mjs:372:34)

  ‚óè ÔøΩÔøΩ INTEGRATION: Complete Competition Workflow ‚Ä∫ ÔøΩÔøΩ STEP 7: Performance Impact on Horse Value ‚Ä∫ should increase horse value based on competition success

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 0
    Received array:  []

      393 |       });
      394 |
    > 395 |       expect(horseWithResults.competitionResults).toHaveLength(1);
          |                                                   ^
      396 |
      397 |       // Calculate estimated value based on performance
      398 |       const baseValue = 10000; // Base horse value

      at Object.<anonymous> (tests/integration/competitionWorkflow.integration.test.mjs:395:51)

  ‚óè ÔøΩÔøΩ INTEGRATION: Complete Competition Workflow ‚Ä∫ ÔøΩÔøΩ STEP 9: End-to-End Competition Workflow Validation ‚Ä∫ should validate complete competition workflow integrity

    expect(received).toBeGreaterThan(expected)

    Expected: > 100
    Received:   0

      455 |
      456 |       // User progression
    > 457 |       expect(finalUser.xp).toBeGreaterThan(100); // Started with 100, gained more
          |                            ^
      458 |       expect(finalUser.money).toBeGreaterThan(15000 - testShow.entryFee); // Prize money added
      459 |
      460 |       // Horse competition record

      at Object.<anonymous> (tests/integration/competitionWorkflow.integration.test.mjs:457:28)

  ‚óè ÔøΩÔøΩ INTEGRATION: Complete Competition Workflow ‚Ä∫ ÔøΩÔøΩ STEP 9: End-to-End Competition Workflow Validation ‚Ä∫ should validate all business rules enforced throughout competition

    TypeError: Cannot read properties of undefined (reading 'prizeWon')

      484 |       // Financial transactions accurate
      485 |       const user = await prisma.user.findUnique({ where: { id: testUser.id } });
    > 486 |       const expectedMoney = 15000 - testShow.entryFee + Number(competitionResult.prizeWon);
          |                                                                                  ^
      487 |       expect(user.money).toBe(expectedMoney);
      488 |
      489 |       // Competition results realistic

      at Object.<anonymous> (tests/integration/competitionWorkflow.integration.test.mjs:486:82)

 FAIL  __tests__/services/cronJobService.test.mjs
  ‚óè Cron Job Service ‚Ä∫ initializeCronJobs() ‚Ä∫ should initialize weekly salary job

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "0 9 * * 1", Any<Function>, ObjectContaining {"scheduled": false, "timezone": "UTC"}

    Number of calls: 0

      48 |       initializeCronJobs();
      49 |
    > 50 |       expect(mockSchedule).toHaveBeenCalledWith(
         |                            ^
      51 |         '0 9 * * 1', // Monday 9AM
      52 |         expect.any(Function),
      53 |         expect.objectContaining({

      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:50:28)

  ‚óè Cron Job Service ‚Ä∫ initializeCronJobs() ‚Ä∫ should initialize token cleanup job

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "0 3 * * *", Any<Function>, ObjectContaining {"scheduled": false, "timezone": "UTC"}

    Number of calls: 0

      61 |       initializeCronJobs();
      62 |
    > 63 |       expect(mockSchedule).toHaveBeenCalledWith(
         |                            ^
      64 |         '0 3 * * *', // Daily 3AM
      65 |         expect.any(Function),
      66 |         expect.objectContaining({

      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:63:28)

  ‚óè Cron Job Service ‚Ä∫ initializeCronJobs() ‚Ä∫ should initialize exactly 2 cron jobs

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 2
    Received number of calls: 0

      83 |       initializeCronJobs();
      84 |
    > 85 |       expect(mockSchedule).toHaveBeenCalledTimes(2);
         |                            ^
      86 |     });
      87 |
      88 |     it('should use UTC timezone for all jobs', () => {

      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:85:28)

  ‚óè Cron Job Service ‚Ä∫ Token Cleanup Scheduling ‚Ä∫ should schedule daily cleanup at 3 AM UTC

    expect(received).toBeDefined()

    Received: undefined

      298 |       const tokenCleanupCall = mockSchedule.mock.calls.find((call) => call[0] === '0 3 * * *');
      299 |
    > 300 |       expect(tokenCleanupCall).toBeDefined();
          |                                ^
      301 |       expect(tokenCleanupCall[2].timezone).toBe('UTC');
      302 |     });
      303 |

      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:300:32)

  ‚óè Cron Job Service ‚Ä∫ Token Cleanup Scheduling ‚Ä∫ should execute token cleanup callback when triggered

    TypeError: Cannot read properties of undefined (reading '1')

      312 |       // Get the cleanup job callback
      313 |       const tokenCleanupCall = mockSchedule.mock.calls.find((call) => call[0] === '0 3 * * *');
    > 314 |       const cleanupCallback = tokenCleanupCall[1];
          |                                               ^
      315 |
      316 |       // Execute the callback
      317 |       await cleanupCallback();

      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:314:47)

 FAIL  __tests__/integration/security/ownership-violations.test.mjs
  ‚óè Ownership Violation Attempts Integration Tests ‚Ä∫ Cross-user horse access ‚Ä∫ allows owners to fetch their own horse

    expected 200 "OK", got 404 "Not Found"

      121 |         .get(`/api/horses/${horseA.id}`)
      122 |         .set('Authorization', `Bearer ${tokenA}`)
    > 123 |         .expect(200);
          |          ^
      124 |
      125 |       expect(response.body.success).toBe(true);
      126 |       expect(response.body.data.id).toBe(horseA.id);

      at Object.<anonymous> (__tests__/integration/security/ownership-violations.test.mjs:123:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Ownership Violation Attempts Integration Tests ‚Ä∫ Cross-user horse access ‚Ä∫ allows owners to update their horse witha valid payload

    expected 200 "OK", got 404 "Not Found"

      154 |           dateOfBirth: new Date().toISOString(),
      155 |         })
    > 156 |         .expect(200);
          |          ^
      157 |
      158 |       expect(response.body.success).toBe(true);
      159 |       expect(response.body.data.name).toBe(newName);

      at Object.<anonymous> (__tests__/integration/security/ownership-violations.test.mjs:156:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Ownership Violation Attempts Integration Tests ‚Ä∫ Cross-user horse access ‚Ä∫ blocks cross-user deletes and allows owner deletes

    expected 200 "OK", got 404 "Not Found"

      176 |         .set('Authorization', `Bearer ${tokenA}`)
      177 |         .set('x-test-skip-csrf', 'true')
    > 178 |         .expect(200);
          |          ^
      179 |
      180 |       expect(allowResponse.body.success).toBe(true);
      181 |

      at Object.<anonymous> (__tests__/integration/security/ownership-violations.test.mjs:178:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

 FAIL  tests/training-updated.test.mjs
  ‚óè ÔøΩÔøΩÔ∏è INTEGRATION: Training System Updated - User Model Integration ‚Ä∫ Training Status Tests ‚Ä∫ should get training status for a specific horse and discipline

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

      163 |         .set('Authorization', `Bearer ${authToken}`); // Ensure auth token is sent
      164 |
    > 165 |       expect(response.status).toBe(200);
          |                               ^
      166 |       expect(response.body.success).toBe(true);
      167 |       expect(response.body.data).toHaveProperty('eligible');
      168 |       expect(response.body.data).toHaveProperty('reason');

      at Object.<anonymous> (tests/training-updated.test.mjs:165:31)

  ‚óè ÔøΩÔøΩÔ∏è INTEGRATION: Training System Updated - User Model Integration ‚Ä∫ Training Status Tests ‚Ä∫ should get all trainingstatus for a horse

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

      180 |         .set('Authorization', `Bearer ${authToken}`); // Ensure auth token is sent
      181 |
    > 182 |       expect(response.status).toBe(200);
          |                               ^
      183 |       expect(response.body.success).toBe(true);
      184 |       expect(typeof response.body.data).toBe('object'); // Fixed: API returns object with discipline keys, not array
      185 |       expect(response.body.data).toHaveProperty('Racing'); // Fixed: Check for discipline properties

      at Object.<anonymous> (tests/training-updated.test.mjs:182:31)

  ‚óè ÔøΩÔøΩÔ∏è INTEGRATION: Training System Updated - User Model Integration ‚Ä∫ Error Handling Tests ‚Ä∫ should handle invalid horse ID gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 403

      217 |       });
      218 |
    > 219 |       expect(response.status).toBe(404);
          |                               ^
      220 |       expect(response.body.success).toBe(false);
      221 |       expect(response.body.message).toContain('not found');
      222 |     });

      at Object.<anonymous> (tests/training-updated.test.mjs:219:31)

  ‚óè ÔøΩÔøΩÔ∏è INTEGRATION: Training System Updated - User Model Integration ‚Ä∫ Error Handling Tests ‚Ä∫ should handle invalid discipline gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 403

      228 |       });
      229 |
    > 230 |       expect(response.status).toBe(404); // Ownership fails before discipline validation in test mode
          |                               ^
      231 |       expect(response.body.success).toBe(false);
      232 |     });
      233 |   });

      at Object.<anonymous> (tests/training-updated.test.mjs:230:31)

 FAIL  tests/integration/horseBreedingWorkflow.integration.test.mjs
  ‚óè ÔøΩÔøΩ INTEGRATION: Complete Horse Breeding Workflow ‚Ä∫ ÔøΩÔøΩ STEP 4: Groom Assignment & Care ‚Ä∫ should assign specialized foal care groom to newborn

    expect(received).toBe(expected) // Object.is equality

    Expected: "foal_care"
    Received: "foalCare"

      286 |
      287 |       expect(dbAssignment).toBeTruthy();
    > 288 |       expect(dbAssignment.groom.speciality).toBe('foal_care');
          |                                             ^
      289 |
      290 |       assignedGroom = dbAssignment.groom;
      291 |     });

      at Object.<anonymous> (tests/integration/horseBreedingWorkflow.integration.test.mjs:288:45)

  ‚óè ÔøΩÔøΩ INTEGRATION: Complete Horse Breeding Workflow ‚Ä∫ ÔøΩÔøΩ STEP 4: Groom Assignment & Care ‚Ä∫ should record groom interaction with foal

    TypeError: Cannot read properties of undefined (reading 'id')

      297 |       const interactionData = {
      298 |         foalId: foal.id,
    > 299 |         groomId: assignedGroom.id,
          |                                ^
      300 |         interactionType: 'daily_care',
      301 |         duration: 60, // 1 hour
      302 |         notes: 'Initial care for newborn foal',

      at Object.<anonymous> (tests/integration/horseBreedingWorkflow.integration.test.mjs:299:32)

  ‚óè ÔøΩÔøΩ INTEGRATION: Complete Horse Breeding Workflow ‚Ä∫ ÔøΩÔøΩ STEP 6: End-to-End Workflow Validation ‚Ä∫ should validate complete breeding workflow integrity

    expect(received).toBe(expected) // Object.is equality

    Expected: "foal_care"
    Received: "foalCare"

      371 |       // Groom care system
      372 |       expect(foalWithFamily.groomAssignments).toHaveLength(1);
    > 373 |       expect(foalWithFamily.groomAssignments[0].groom.speciality).toBe('foal_care');
          |                                                                   ^
      374 |       expect(foalWithFamily.groomInteractions).toHaveLength(1);
      375 |
      376 |       // Development tracking

      at Object.<anonymous> (tests/integration/horseBreedingWorkflow.integration.test.mjs:373:67)

  ‚óè ÔøΩÔøΩ INTEGRATION: Complete Horse Breeding Workflow ‚Ä∫ ÔøΩÔøΩ STEP 6: End-to-End Workflow Validation ‚Ä∫ should validate business rules are enforced throughout workflow

    TypeError: Cannot read properties of undefined (reading 'speciality')

      397 |
      398 |       // Groom specialization rules
    > 399 |       expect(assignedGroom.speciality).toBe('foal_care'); // Correct specialty for foal
          |                            ^
      400 |
      401 |       // Data integrity
      402 |       expect(foal.sireId).toBe(stallion.id);

      at Object.<anonymous> (tests/integration/horseBreedingWorkflow.integration.test.mjs:399:28)

 FAIL  tests/integration/groomHandlerSystem.test.mjs
  ‚óè Groom Handler System Integration Tests ‚Ä∫ 1. Handler Assignment ‚Ä∫ should validate horse ownership

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 404

      163 |           .set('Authorization', `Bearer ${authToken}`);
      164 |
    > 165 |         expect(response.status).toBe(403);
          |                                 ^
      166 |         expect(response.body.success).toBe(false);
      167 |         expect(response.body.message).toContain('do not own this horse');
      168 |       } finally {

      at Object.<anonymous> (tests/integration/groomHandlerSystem.test.mjs:165:33)

 FAIL  tests/controllers/dynamicCompatibilityController.test.mjs
  ‚óè Dynamic Compatibility Controller API ‚Ä∫ POST /api/compatibility/calculate ‚Ä∫ should calculate high compatibility for calm groom with fearful horse

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      142 |         .send(requestBody);
      143 |
    > 144 |       expect(response.status).toBe(200);
          |                               ^
      145 |       expect(response.body.success).toBe(true);
      146 |       expect(response.body.data).toBeDefined();
      147 |       expect(response.body.data.overallScore).toBeGreaterThan(0.7);

      at Object.<anonymous> (tests/controllers/dynamicCompatibilityController.test.mjs:144:31)

  ‚óè Dynamic Compatibility Controller API ‚Ä∫ POST /api/compatibility/calculate ‚Ä∫ should calculate low compatibility for energetic groom with fearful horse

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      172 |         .send(requestBody);
      173 |
    > 174 |       expect(response.status).toBe(200);
          |                               ^
      175 |       expect(response.body.success).toBe(true);
      176 |       expect(response.body.data.overallScore).toBeLessThan(0.4);
      177 |       expect(response.body.data.recommendationLevel).toBe('not_recommended');

      at Object.<anonymous> (tests/controllers/dynamicCompatibilityController.test.mjs:174:31)

  ‚óè Dynamic Compatibility Controller API ‚Ä∫ POST /api/compatibility/calculate ‚Ä∫ should return 400 for missing required fields

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 403

      187 |         });
      188 |
    > 189 |       expect(response.status).toBe(400);
          |                               ^
      190 |       expect(response.body.success).toBe(false);
      191 |     });
      192 |

      at Object.<anonymous> (tests/controllers/dynamicCompatibilityController.test.mjs:189:31)

  ‚óè Dynamic Compatibility Controller API ‚Ä∫ GET /api/compatibility/factors/:groomId/:horseId ‚Ä∫ should analyze compatibility factors comprehensively

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

      214 |         .set('Authorization', `Bearer ${testToken}`);
      215 |
    > 216 |       expect(response.status).toBe(200);
          |                               ^
      217 |       expect(response.body.success).toBe(true);
      218 |       expect(response.body.data).toBeDefined();
      219 |       expect(response.body.data.personalityMatch).toBeDefined();

      at Object.<anonymous> (tests/controllers/dynamicCompatibilityController.test.mjs:216:31)

  ‚óè Dynamic Compatibility Controller API ‚Ä∫ POST /api/compatibility/predict ‚Ä∫ should predict positive outcome for good compatibility

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      257 |         .send(requestBody);
      258 |
    > 259 |       expect(response.status).toBe(200);
          |                               ^
      260 |       expect(response.body.success).toBe(true);
      261 |       expect(response.body.data).toBeDefined();
      262 |       expect(response.body.data.predictedBondingChange).toBeGreaterThan(0);

      at Object.<anonymous> (tests/controllers/dynamicCompatibilityController.test.mjs:259:31)

  ‚óè Dynamic Compatibility Controller API ‚Ä∫ POST /api/compatibility/predict ‚Ä∫ should predict negative outcome for poor compatibility

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      286 |         .send(requestBody);
      287 |
    > 288 |       expect(response.status).toBe(200);
          |                               ^
      289 |       expect(response.body.success).toBe(true);
      290 |       expect(response.body.data.predictedBondingChange).toBeLessThan(2);
      291 |       expect(response.body.data.predictedStressChange).toBeGreaterThanOrEqual(1);

      at Object.<anonymous> (tests/controllers/dynamicCompatibilityController.test.mjs:288:31)

  ‚óè Dynamic Compatibility Controller API ‚Ä∫ POST /api/compatibility/recommendations ‚Ä∫ should recommend optimal grooms for specific horse and context

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      313 |         .send(requestBody);
      314 |
    > 315 |       expect(response.status).toBe(200);
          |                               ^
      316 |       expect(response.body.success).toBe(true);
      317 |       expect(response.body.data).toBeDefined();
      318 |       expect(Array.isArray(response.body.data.rankedGrooms)).toBe(true);

      at Object.<anonymous> (tests/controllers/dynamicCompatibilityController.test.mjs:315:31)

  ‚óè Dynamic Compatibility Controller API ‚Ä∫ GET /api/compatibility/trends/:groomId/:horseId ‚Ä∫ should analyze compatibility trends with insufficient data

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

      338 |         .set('Authorization', `Bearer ${testToken}`);
      339 |
    > 340 |       expect(response.status).toBe(200);
          |                               ^
      341 |       expect(response.body.success).toBe(true);
      342 |       expect(response.body.data).toBeDefined();
      343 |       expect(response.body.data.overallTrend).toBe('insufficient_data');

      at Object.<anonymous> (tests/controllers/dynamicCompatibilityController.test.mjs:340:31)

 FAIL  __tests__/routes/apiOptimizationRoutes.test.mjs
  ‚óè API Optimization Routes ‚Ä∫ GET /api/optimization/metrics ‚Ä∫ requires authentication

    expected 401 "Unauthorized", got 200 "OK"

      82 |       const response = await request(testApp)
      83 |         .get('/api/optimization/metrics')
    > 84 |         .expect(401);
         |          ^
      85 |
      86 |       expect(response.body.success).toBe(false);
      87 |       expect(response.body.message).toContain('token');

      at Object.<anonymous> (__tests__/routes/apiOptimizationRoutes.test.mjs:84:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè API Optimization Routes ‚Ä∫ Error Handling ‚Ä∫ handles missing authorization header

    expected 401 "Unauthorized", got 200 "OK"

      319 |       const response = await request(testApp)
      320 |         .get('/api/optimization/metrics')
    > 321 |         .expect(401);
          |          ^
      322 |
      323 |       expect(response.body.success).toBe(false);
      324 |     });

      at Object.<anonymous> (__tests__/routes/apiOptimizationRoutes.test.mjs:321:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

 FAIL  tests/trainingController.test.mjs
  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ canTrain ‚Ä∫ should return eligible true for horse that meets all requirements

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

      Object {
    -   "eligible": true,
    -   "reason": null,
    +   "eligible": false,
    +   "reason": "Horse not found",
      }

       97 |       const result = await canTrain(1, 'Dressage');
       98 |
    >  99 |       expect(result).toEqual({
          |                      ^
      100 |         eligible: true,
      101 |         reason: null,
      102 |       });

      at Object.<anonymous> (tests/trainingController.test.mjs:99:22)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ canTrain ‚Ä∫ should return eligible false for horse under 3 years old

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 1

      Object {
        "eligible": false,
    -   "reason": "Horse is under age",
    +   "reason": "Horse not found",
      }

      110 |       const result = await canTrain(1, 'Dressage');
      111 |
    > 112 |       expect(result).toEqual({
          |                      ^
      113 |         eligible: false,
      114 |         reason: 'Horse is under age',
      115 |       });

      at Object.<anonymous> (tests/trainingController.test.mjs:112:22)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ canTrain ‚Ä∫ should return eligible false for horse with recent training in any discipline

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 1

      Object {
        "eligible": false,
    -   "reason": "Training cooldown active for this horse",
    +   "reason": "Horse not found",
      }

      126 |       const result = await canTrain(1, 'Dressage');
      127 |
    > 128 |       expect(result).toEqual({
          |                      ^
      129 |         eligible: false,
      130 |         reason: 'Training cooldown active for this horse',
      131 |       });

      at Object.<anonymous> (tests/trainingController.test.mjs:128:22)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ canTrain ‚Ä∫ should return eligible true for horse with old training (8+ days ago)

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

      Object {
    -   "eligible": true,
    -   "reason": null,
    +   "eligible": false,
    +   "reason": "Horse not found",
      }

      142 |       const result = await canTrain(1, 'Dressage');
      143 |
    > 144 |       expect(result).toEqual({
          |                      ^
      145 |         eligible: true,
      146 |         reason: null,
      147 |       });

      at Object.<anonymous> (tests/trainingController.test.mjs:144:22)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ canTrain ‚Ä∫ should return eligible false for non-existent horse

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 999

    Number of calls: 0

      159 |         reason: 'Horse not found',
      160 |       });
    > 161 |       expect(mockGetHorseAge).toHaveBeenCalledWith(999);
          |                               ^
      162 |       expect(mockGetAnyRecentTraining).not.toHaveBeenCalled();
      163 |     });
      164 |

      at Object.<anonymous> (tests/trainingController.test.mjs:161:31)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ canTrain ‚Ä∫ should handle database errors gracefully

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"eligible": false, "reason": "Horse not found"}

      178 |       mockGetHorseAge.mockRejectedValue(new Error('Database connection failed'));
      179 |
    > 180 |       await expect(canTrain(1, 'Dressage')).rejects.toThrow('Training eligibility check failed');
          |             ^
      181 |     });
      182 |
      183 |     it('should calculate cooldown correctly for edge case (exactly 7 days)', async () => {

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/trainingController.test.mjs:180:13)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ canTrain ‚Ä∫ should calculate cooldown correctly for edge case (exactly 7 days)

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

      Object {
    -   "eligible": true,
    -   "reason": null,
    +   "eligible": false,
    +   "reason": "Horse not found",
      }

      190 |       const result = await canTrain(1, 'Dressage');
      191 |
    > 192 |       expect(result).toEqual({
          |                      ^
      193 |         eligible: true,
      194 |         reason: null,
      195 |       });

      at Object.<anonymous> (tests/trainingController.test.mjs:192:22)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ trainHorse ‚Ä∫ should successfully train eligible horse

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      246 |       const result = await trainHorse(1, 'Racing');
      247 |
    > 248 |       expect(result.success).toBe(true);
          |                              ^
      249 |       expect(result.message).toContain('Horse trained successfully in Racing. +5 added.');
      250 |       expect(result.updatedHorse.name).toBe('Test Horse');
      251 |       expect(result.nextEligible).toBeDefined();

      at Object.<anonymous> (tests/trainingController.test.mjs:248:30)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ trainHorse ‚Ä∫ should reject training for ineligible horse (under age)

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

      Object {
    -   "message": "Training not allowed: Horse is under age",
    +   "message": "Training not allowed: Horse not found",
        "nextEligible": null,
    -   "reason": "Horse is under age",
    +   "reason": "Horse not found",
        "success": false,
        "updatedHorse": null,
      }

      262 |       const result = await trainHorse(1, 'Racing');
      263 |
    > 264 |       expect(result).toEqual({
          |                      ^
      265 |         success: false,
      266 |         reason: 'Horse is under age',
      267 |         updatedHorse: null,

      at Object.<anonymous> (tests/trainingController.test.mjs:264:22)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ trainHorse ‚Ä∫ should reject training for horse in cooldown

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

      Object {
    -   "message": "Training not allowed: Training cooldown active for this horse",
    +   "message": "Training not allowed: Horse not found",
        "nextEligible": null,
    -   "reason": "Training cooldown active for this horse",
    +   "reason": "Horse not found",
        "success": false,
        "updatedHorse": null,
      }

      279 |       const result = await trainHorse(1, 'Racing');
      280 |
    > 281 |       expect(result).toEqual({
          |                      ^
      282 |         success: false,
      283 |         reason: 'Training cooldown active for this horse',
      284 |         updatedHorse: null,

      at Object.<anonymous> (tests/trainingController.test.mjs:281:22)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ trainHorse ‚Ä∫ should handle training log errors gracefully

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"message": "Training not allowed: Horse not found", "nextEligible": null, "reason": "Horse not found", "success": false, "updatedHorse": null}

      299 |       mockLogTrainingSession.mockRejectedValue(new Error('Failed to log training'));
      300 |
    > 301 |       await expect(trainHorse(1, 'Racing')).rejects.toThrow('Training failed: Failed to log training');
          |             ^
      302 |     });
      303 |
      304 |     it('should award +5 XP after successful training', async () => {

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/trainingController.test.mjs:301:13)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ trainHorse ‚Ä∫ should award +5 XP after successful training

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      344 |
      345 |       // Verify training success
    > 346 |       expect(result.success).toBe(true);
          |                              ^
      347 |       expect(result.message).toContain('Horse trained successfully in Dressage. +5 added.');
      348 |
      349 |       // Verify XP award system

      at Object.<anonymous> (tests/trainingController.test.mjs:346:30)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ trainHorse ‚Ä∫ should handle XP system errors gracefully without breaking training

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      386 |
      387 |       // Training should still succeed despite XP error
    > 388 |       expect(result.success).toBe(true);
          |                              ^
      389 |       expect(result.message).toContain('Horse trained successfully in Racing. +5 added.');
      390 |       expect(result.updatedHorse.name).toBe('Error Test Horse');
      391 |

      at Object.<anonymous> (tests/trainingController.test.mjs:388:30)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ getTrainingStatus ‚Ä∫ should return complete status for eligible horse with no training history

    expect(received).toEqual(expected) // deep equality

    - Expected  - 3
    + Received  + 3

      Object {
        "cooldown": null,
    -   "eligible": true,
    -   "horseAge": 5,
    +   "eligible": false,
    +   "horseAge": null,
        "lastTrainingDate": null,
    -   "reason": null,
    +   "reason": "Horse not found",
      }

      409 |       const result = await getTrainingStatus(1, 'Racing');
      410 |
    > 411 |       expect(result).toEqual({
          |                      ^
      412 |         eligible: true,
      413 |         reason: null,
      414 |         horseAge: 5,

      at Object.<anonymous> (tests/trainingController.test.mjs:411:22)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ getTrainingStatus ‚Ä∫ should return complete status for horse in active cooldown

    expect(received).toBe(expected) // Object.is equality

    Expected: "Training cooldown active for this horse"
    Received: "Horse not found"

      427 |
      428 |       expect(result.eligible).toBe(false);
    > 429 |       expect(result.reason).toBe('Training cooldown active for this horse');
          |                             ^
      430 |       expect(result.horseAge).toBe(4);
      431 |       expect(result.lastTrainingDate).toBe(null); // Still null for this specific discipline
      432 |       expect(result.cooldown.active).toBe(true);

      at Object.<anonymous> (tests/trainingController.test.mjs:429:29)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ getTrainingStatus ‚Ä∫ should return complete status for horse with expired cooldown

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      443 |       const result = await getTrainingStatus(1, 'Racing');
      444 |
    > 445 |       expect(result.eligible).toBe(true);
          |                               ^
      446 |       expect(result.reason).toBe(null);
      447 |       expect(result.horseAge).toBe(4);
      448 |       expect(result.lastTrainingDate).toEqual(eightDaysAgo);

      at Object.<anonymous> (tests/trainingController.test.mjs:445:31)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ getTrainingStatus ‚Ä∫ should return status for ineligible horse (under age)

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

      Object {
        "cooldown": null,
        "eligible": false,
    -   "horseAge": 2,
    +   "horseAge": null,
        "lastTrainingDate": null,
    -   "reason": "Horse is under age",
    +   "reason": "Horse not found",
      }

      458 |       const result = await getTrainingStatus(1, 'Racing');
      459 |
    > 460 |       expect(result).toEqual({
          |                      ^
      461 |         eligible: false,
      462 |         reason: 'Horse is under age',
      463 |         horseAge: 2,

      at Object.<anonymous> (tests/trainingController.test.mjs:460:22)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ getTrainingStatus ‚Ä∫ should handle database errors gracefully

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"cooldown": null, "eligible": false, "horseAge": null, "lastTrainingDate": null, "reason": "Horse not found"}

      470 |       mockGetHorseAge.mockRejectedValue(new Error('Database error'));
      471 |
    > 472 |       await expect(getTrainingStatus(1, 'Racing')).rejects.toThrow('Training status check failed');
          |             ^
      473 |     });
      474 |   });
      475 |

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/trainingController.test.mjs:472:13)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ Integration scenarios ‚Ä∫ should handle different disciplines with global cooldown

    expect(received).toBe(expected) // Object.is equality

    Expected: "Training cooldown active for this horse"
    Received: "Horse not found"

      491 |       // Both should be blocked due to global cooldown
      492 |       expect(racingResult.eligible).toBe(false);
    > 493 |       expect(racingResult.reason).toBe('Training cooldown active for this horse');
          |                                   ^
      494 |
      495 |       expect(jumpingResult.eligible).toBe(false);
      496 |       expect(jumpingResult.reason).toBe('Training cooldown active for this horse');

      at Object.<anonymous> (tests/trainingController.test.mjs:493:35)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ Integration scenarios ‚Ä∫ should handle edge case of exactly 7 days cooldown

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      504 |       const result = await canTrain(1, 'Racing');
      505 |
    > 506 |       expect(result.eligible).toBe(true);
          |                               ^
      507 |       expect(result.reason).toBe(null);
      508 |     });
      509 |

      at Object.<anonymous> (tests/trainingController.test.mjs:506:31)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ Integration scenarios ‚Ä∫ should handle complete training workflow

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      542 |
      543 |       const trainResult = await trainHorse(1, 'Racing');
    > 544 |       expect(trainResult.success).toBe(true);
          |                                   ^
      545 |
      546 |       // Now mock that the horse has recently trained
      547 |       const justNow = new Date();

      at Object.<anonymous> (tests/trainingController.test.mjs:544:35)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ getTrainableHorses ‚Ä∫ should return trainable horsesfor user with eligible horses

    expect(received).toHaveLength(expected)

    Expected length: 2
    Received length: 0
    Received array:  []

      577 |       const result = await getTrainableHorses(playerId);
      578 |
    > 579 |       expect(result).toHaveLength(2);
          |                      ^
      580 |       expect(result[0]).toEqual({
      581 |         horseId: 1,
      582 |         name: 'Thunder',

      at Object.<anonymous> (tests/trainingController.test.mjs:579:22)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ getTrainableHorses ‚Ä∫ should filter out horses under3 years old

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 0
    Received array:  []

      630 |       const result = await getTrainableHorses(playerId);
      631 |
    > 632 |       expect(result).toHaveLength(1);
          |                      ^
      633 |       expect(result[0].name).toBe('Adult Horse');
      634 |       expect(result[0].age).toBe(4);
      635 |     });

      at Object.<anonymous> (tests/trainingController.test.mjs:632:22)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ getTrainableHorses ‚Ä∫ should handle database errors gracefully for individual horses

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 0
    Received array:  []

      668 |       const result = await getTrainableHorses(playerId);
      669 |
    > 670 |       expect(result).toHaveLength(1);
          |                      ^
      671 |       expect(result[0].name).toBe('Good Horse');
      672 |       expect(result[0].trainableDisciplines).toEqual([
      673 |         'Racing',

      at Object.<anonymous> (tests/trainingController.test.mjs:670:22)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ getTrainableHorses ‚Ä∫ should handle player model errors

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: []

      688 |       mockGetUserWithHorses.mockRejectedValue(new Error('Player database error'));
      689 |
    > 690 |       await expect(getTrainableHorses(playerId)).rejects.toThrow(
          |             ^
      691 |         'Failed to get trainable horses: Player database error',
      692 |       );
      693 |     });

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/trainingController.test.mjs:690:13)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ trainRouteHandler ‚Ä∫ should return success response with correct format for successful training

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Nova trained in Dressage. +5 added.",
    -   "nextEligibleDate": Any<String>,
    -   "success": true,
    -   "traitEffects": ObjectContaining {
    -     "appliedTraits": Array [],
    -     "scoreModifier": 0,
    -     "xpModifier": 0,
    -   },
    -   "updatedScore": 25,
    +   "message": "Training not allowed: Horse not found",
    +   "success": false,
      },

    Number of calls: 1

      747 |       await trainRouteHandler(mockReq, mockRes);
      748 |
    > 749 |       expect(mockRes.json).toHaveBeenCalledWith({
          |                            ^
      750 |         success: true,
      751 |         message: 'Nova trained in Dressage. +5 added.',
      752 |         updatedScore: 25,

      at Object.<anonymous> (tests/trainingController.test.mjs:749:28)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ trainRouteHandler ‚Ä∫ should return failure response for ineligible horse (under age)

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Training not allowed: Horse is under age",
    +   "message": "Training not allowed: Horse not found",
        "success": false,
      },

    Number of calls: 1

      768 |
      769 |       expect(mockRes.status).toHaveBeenCalledWith(400);
    > 770 |       expect(mockRes.json).toHaveBeenCalledWith({
          |                            ^
      771 |         success: false,
      772 |         message: 'Training not allowed: Horse is under age',
      773 |       });

      at Object.<anonymous> (tests/trainingController.test.mjs:770:28)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ trainRouteHandler ‚Ä∫ should return failure response for horse in cooldown

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Training not allowed: Training cooldown active for this horse",
    +   "message": "Training not allowed: Horse not found",
        "success": false,
      },

    Number of calls: 1

      783 |
      784 |       expect(mockRes.status).toHaveBeenCalledWith(400);
    > 785 |       expect(mockRes.json).toHaveBeenCalledWith({
          |                            ^
      786 |         success: false,
      787 |         message: 'Training not allowed: Training cooldown active for this horse',
      788 |       });

      at Object.<anonymous> (tests/trainingController.test.mjs:785:28)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ trainRouteHandler ‚Ä∫ should handle missing discipline score gracefully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Nova trained in Dressage. +5 added.",
    -   "nextEligibleDate": Any<String>,
    -   "success": true,
    -   "traitEffects": ObjectContaining {
    -     "appliedTraits": Array [],
    -     "scoreModifier": 0,
    -     "xpModifier": 0,
    -   },
    -   "updatedScore": 0,
    +   "message": "Training not allowed: Horse not found",
    +   "success": false,
      },

    Number of calls: 1

      825 |       await trainRouteHandler(mockReq, mockRes);
      826 |
    > 827 |       expect(mockRes.json).toHaveBeenCalledWith({
          |                            ^
      828 |         success: true,
      829 |         message: 'Nova trained in Dressage. +5 added.',
      830 |         updatedScore: 0, // Should default to 0 when no scores exist

      at Object.<anonymous> (tests/trainingController.test.mjs:827:28)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ trainRouteHandler ‚Ä∫ should handle server errors gracefully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 500
    Received: 400

    Number of calls: 1

      844 |       await trainRouteHandler(mockReq, mockRes);
      845 |
    > 846 |       expect(mockRes.status).toHaveBeenCalledWith(500);
          |                              ^
      847 |       expect(mockRes.json).toHaveBeenCalledWith({
      848 |         success: false,
      849 |         message: 'Failed to train horse',

      at Object.<anonymous> (tests/trainingController.test.mjs:846:30)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Controller - Horse Training Business Logic ‚Ä∫ trainRouteHandler ‚Ä∫ should handle trait effects in training

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Intelligent Horse trained in Dressage. +6 added.",
    -   "nextEligibleDate": Any<String>,
    -   "success": true,
    -   "traitEffects": ObjectContaining {
    -     "appliedTraits": Array [
    -       "intelligent",
    -     ],
    -     "scoreModifier": 1,
    -     "xpModifier": 1,
    -   },
    -   "updatedScore": 6,
    +   "message": "Training not allowed: Horse not found",
    +   "success": false,
      },

    Number of calls: 1

      889 |       await trainRouteHandler(mockReq, mockRes);
      890 |
    > 891 |       expect(mockRes.json).toHaveBeenCalledWith({
          |                            ^
      892 |         success: true,
      893 |         message: 'Intelligent Horse trained in Dressage. +6 added.',
      894 |         updatedScore: 6,

      at Object.<anonymous> (tests/trainingController.test.mjs:891:28)

 FAIL  seed/horseSeed.test.mjs
  ‚óè Horse Seed Integration Tests ‚Ä∫ findOrCreateBreed - Real Database Operations ‚Ä∫ should return existing breed if foundin database

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[seed] Found existing breed: TestSeed_Thoroughbred (ID: 19760)"

    Number of calls: 0

      152 |       expect(result.name).toBe('TestSeed_Thoroughbred');
      153 |       expect(result.id).toBe(testBreed.id);
    > 154 |       expect(mockLogger.info).toHaveBeenCalledWith(
          |                               ^
      155 |         `[seed] Found existing breed: TestSeed_Thoroughbred (ID: ${testBreed.id})`,
      156 |       );
      157 |

      at Object.<anonymous> (seed/horseSeed.test.mjs:154:31)

  ‚óè Horse Seed Integration Tests ‚Ä∫ findOrCreateBreed - Real Database Operations ‚Ä∫ should create new breed if not found in database

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[seed] Breed \"TestSeed_NewArabian\" not found, creating new one."

    Number of calls: 0

      166 |       expect(result.name).toBe('TestSeed_NewArabian');
      167 |       expect(result.description).toBe('Seed-created TestSeed_NewArabian');
    > 168 |       expect(mockLogger.info).toHaveBeenCalledWith('[seed] Breed "TestSeed_NewArabian" not found, creating new one.');
          |                               ^
      169 |       expect(mockLogger.info).toHaveBeenCalledWith(`[seed] Created breed: TestSeed_NewArabian (ID: ${result.id})`);
      170 |
      171 |       // Verify it was actually created in database

      at Object.<anonymous> (seed/horseSeed.test.mjs:168:31)

  ‚óè Horse Seed Integration Tests ‚Ä∫ findOrCreateBreed - Real Database Operations ‚Ä∫ should return null for undefined breed name

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[seed] Breed name is undefined or null. Skipping breed creation/connection."

    Number of calls: 0

      182 |
      183 |       expect(result).toBeNull();
    > 184 |       expect(mockLogger.warn).toHaveBeenCalledWith(
          |                               ^
      185 |         '[seed] Breed name is undefined or null. Skipping breed creation/connection.',
      186 |       );
      187 |     });

      at Object.<anonymous> (seed/horseSeed.test.mjs:184:31)

  ‚óè Horse Seed Integration Tests ‚Ä∫ ensureReferencedRecordsExist - Real Database Operations ‚Ä∫ should create users and stables if they do not exist in database

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[seed] Ensured User owner1@example.com exists."

    Number of calls: 0

      220 |       expect(stable2.name).toBe('Second Stable');
      221 |
    > 222 |       expect(mockLogger.info).toHaveBeenCalledWith('[seed] Ensured User owner1@example.com exists.');
          |                               ^
      223 |       expect(mockLogger.info).toHaveBeenCalledWith('[seed] Ensured User owner2@example.com exists.');
      224 |       expect(mockLogger.info).toHaveBeenCalledWith('[seed] Ensured Stable ID 1 exists.');
      225 |       expect(mockLogger.info).toHaveBeenCalledWith('[seed] Ensured Stable ID 2 exists.');

      at Object.<anonymous> (seed/horseSeed.test.mjs:222:31)

  ‚óè Horse Seed Integration Tests ‚Ä∫ ensureReferencedRecordsExist - Real Database Operations ‚Ä∫ should update existing users and stables if they already exist

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[seed] Ensured User owner1@example.com exists."

    Number of calls: 0

      242 |       expect(user2).toBeTruthy();
      243 |
    > 244 |       expect(mockLogger.info).toHaveBeenCalledWith('[seed] Ensured User owner1@example.com exists.');
          |                               ^
      245 |       expect(mockLogger.info).toHaveBeenCalledWith('[seed] Ensured User owner2@example.com exists.');
      246 |     });
      247 |

      at Object.<anonymous> (seed/horseSeed.test.mjs:244:31)

  ‚óè Horse Seed Integration Tests ‚Ä∫ seedHorses - Real Database Operations ‚Ä∫ should log a warning and return an empty array if no users are provided

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "No users provided for horse seeding. Skipping horse creation."

    Number of calls: 0

      265 |     it('should log a warning and return an empty array if no users are provided', async () => {
      266 |       const result = await seedHorses(prisma, []);
    > 267 |       expect(mockLogger.warn).toHaveBeenCalledWith('No users provided for horse seeding. Skipping horse creation.');
          |                               ^
      268 |       expect(result).toEqual([]);
      269 |     });
      270 |

      at Object.<anonymous> (seed/horseSeed.test.mjs:267:31)

  ‚óè Horse Seed Integration Tests ‚Ä∫ seedHorses - Real Database Operations ‚Ä∫ should create breeds and horses for the provided user in database

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "Created horse:"

    Number of calls: 0

      302 |
      303 |       // Verify logging occurred
    > 304 |       expect(mockLogger.info).toHaveBeenCalledWith(
          |                               ^
      305 |         expect.stringContaining('Created horse:'),
      306 |       );
      307 |

      at Object.<anonymous> (seed/horseSeed.test.mjs:304:31)

  ‚óè Horse Seed Integration Tests ‚Ä∫ Complete Horse Seeding Integration Test ‚Ä∫ should execute complete seeding workflow with real database operations

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[seed] Ensured User owner1@example.com exists."

    Number of calls: 0

      386 |
      387 |       // Verify logging occurred
    > 388 |       expect(mockLogger.info).toHaveBeenCalledWith('[seed] Ensured User owner1@example.com exists.');
          |                               ^
      389 |
      390 |       if (result.length > 0) {
      391 |         expect(mockLogger.info).toHaveBeenCalledWith(

      at Object.<anonymous> (seed/horseSeed.test.mjs:388:31)

 FAIL  __tests__/middleware/validationErrorHandler.test.mjs
  ‚óè Validation Error Handler ‚Ä∫ handleValidationErrors() ‚Ä∫ should return 400 when validation errors exist

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 400

    Number of calls: 0

      57 |       handleValidationErrors(req, res, next);
      58 |
    > 59 |       expect(res.status).toHaveBeenCalledWith(400);
         |                          ^
      60 |       expect(res.json).toHaveBeenCalledWith({
      61 |         success: false,
      62 |         message: 'Email is required', // First error message

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:59:26)

  ‚óè Validation Error Handler ‚Ä∫ handleValidationErrors() ‚Ä∫ should handle single validation error

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 400

    Number of calls: 0

      77 |       handleValidationErrors(req, res, next);
      78 |
    > 79 |       expect(res.status).toHaveBeenCalledWith(400);
         |                          ^
      80 |       expect(res.json).toHaveBeenCalledWith({
      81 |         success: false,
      82 |         message: 'Invalid email format', // First error message

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:79:26)

  ‚óè Validation Error Handler ‚Ä∫ handleValidationErrors() ‚Ä∫ should handle nested field validation errors

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 400

    Number of calls: 0

      93 |       handleValidationErrors(req, res, next);
      94 |
    > 95 |       expect(res.status).toHaveBeenCalledWith(400);
         |                          ^
      96 |       expect(res.json).toHaveBeenCalledWith({
      97 |         success: false,
      98 |         message: 'Invalid address', // First error message

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:95:26)

  ‚óè Validation Error Handler ‚Ä∫ sanitizeRequestData() - XSS Prevention ‚Ä∫ No validation errors ‚Ä∫ should sanitize body data and remove extra fields

    expect(received).toEqual(expected) // deep equality

    - Expected  - 0
    + Received  + 1

      Object {
        "email": "test@example.com",
    +   "maliciousField": "<script>alert(\"XSS\")</script>",
        "password": "password123",
      }

      133 |         sanitizeRequestData(req, res, next);
      134 |
    > 135 |         expect(req.body).toEqual({
          |                          ^
      136 |           email: 'test@example.com',
      137 |           password: 'password123',
      138 |         });

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:135:26)

  ‚óè Validation Error Handler ‚Ä∫ sanitizeRequestData() - XSS Prevention ‚Ä∫ No validation errors ‚Ä∫ should sanitize query parameters

    expect(received).toEqual(expected) // deep equality

    - Expected  - 0
    + Received  + 1

      Object {
    +   "invalidParam": "<img src=x onerror=alert(1)>",
        "page": "1",
        "search": "thoroughbred",
      }

      155 |         sanitizeRequestData(req, res, next);
      156 |
    > 157 |         expect(req.query).toEqual({
          |                           ^
      158 |           search: 'thoroughbred',
      159 |           page: '1',
      160 |         });

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:157:27)

  ‚óè Validation Error Handler ‚Ä∫ sanitizeRequestData() - XSS Prevention ‚Ä∫ No validation errors ‚Ä∫ should sanitize route parameters

    expect(received).toEqual(expected) // deep equality

    - Expected  - 0
    + Received  + 1

      Object {
        "id": "123",
    +   "malicious": "\"><script>alert(1)</script>",
      }

      174 |         sanitizeRequestData(req, res, next);
      175 |
    > 176 |         expect(req.params).toEqual({
          |                            ^
      177 |           id: '123',
      178 |         });
      179 |         expect(req.params.malicious).toBeUndefined();

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:176:28)

  ‚óè Validation Error Handler ‚Ä∫ sanitizeRequestData() - XSS Prevention ‚Ä∫ No validation errors ‚Ä∫ should handle multiple request sources simultaneously

    expect(received).toEqual(expected) // deep equality

    - Expected  - 0
    + Received  + 1

      Object {
        "email": "test@example.com",
    +   "extraBody": "should be removed",
      }

      202 |         sanitizeRequestData(req, res, next);
      203 |
    > 204 |         expect(req.body).toEqual({ email: 'test@example.com' });
          |                          ^
      205 |         expect(req.query).toEqual({ page: '1' });
      206 |         expect(req.params).toEqual({ id: '456' });
      207 |       });

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:204:26)

  ‚óè Validation Error Handler ‚Ä∫ sanitizeRequestData() - XSS Prevention ‚Ä∫ XSS Attack Scenarios ‚Ä∫ should prevent <script> injection

    expect(received).toBeUndefined()

    Received: "<script>alert(\"XSS\")</script>"

      314 |         sanitizeRequestData(req, res, next);
      315 |
    > 316 |         expect(req.body.comment).toBeUndefined();
          |                                  ^
      317 |         expect(req.body.validField).toBe('safe data');
      318 |       });
      319 |

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:316:34)

  ‚óè Validation Error Handler ‚Ä∫ sanitizeRequestData() - XSS Prevention ‚Ä∫ XSS Attack Scenarios ‚Ä∫ should prevent event handler injection

    expect(received).toBeUndefined()

    Received: "<img src=x onerror=alert(1)>"

      330 |         sanitizeRequestData(req, res, next);
      331 |
    > 332 |         expect(req.body.bio).toBeUndefined();
          |                              ^
      333 |       });
      334 |
      335 |       it('should prevent iframe injection', () => {

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:332:30)

  ‚óè Validation Error Handler ‚Ä∫ sanitizeRequestData() - XSS Prevention ‚Ä∫ XSS Attack Scenarios ‚Ä∫ should prevent iframe injection

    expect(received).toBeUndefined()

    Received: "<iframe src=\"javascript:alert(1)\"></iframe>"

      345 |         sanitizeRequestData(req, res, next);
      346 |
    > 347 |         expect(req.body.description).toBeUndefined();
          |                                      ^
      348 |       });
      349 |
      350 |       it('should prevent SVG XSS', () => {

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:347:38)

  ‚óè Validation Error Handler ‚Ä∫ sanitizeRequestData() - XSS Prevention ‚Ä∫ XSS Attack Scenarios ‚Ä∫ should prevent SVG XSS

    expect(received).toBeUndefined()

    Received: "<svg><script>alert(1)</script></svg>"

      360 |         sanitizeRequestData(req, res, next);
      361 |
    > 362 |         expect(req.body.avatar).toBeUndefined();
          |                                 ^
      363 |       });
      364 |     });
      365 |

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:362:33)

  ‚óè Validation Error Handler ‚Ä∫ sanitizeRequestData() - XSS Prevention ‚Ä∫ Parameter Pollution Prevention (CWE-20) ‚Ä∫ should prevent array parameter pollution

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 4

      Object {
        "breed": "thoroughbred",
    -   "price": "100",
    +   "price": Array [
    +     "100",
    +     "200",
    +   ],
      }

      384 |         sanitizeRequestData(req, res, next);
      385 |
    > 386 |         expect(req.query).toEqual({
          |                           ^
      387 |           price: '100',
      388 |           breed: 'thoroughbred',
      389 |         });

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:386:27)

  ‚óè Validation Error Handler ‚Ä∫ sanitizeRequestData() - XSS Prevention ‚Ä∫ Parameter Pollution Prevention (CWE-20) ‚Ä∫ should prevent object parameter pollution

    expect(received).toEqual(expected) // deep equality

    - Expected  - 0
    + Received  + 4

      Object {
        "password": "pass123",
    +   "user": Object {
    +     "email": "test@example.com",
    +     "isAdmin": true,
    +   },
      }

      403 |         sanitizeRequestData(req, res, next);
      404 |
    > 405 |         expect(req.body).toEqual({
          |                          ^
      406 |           password: 'pass123',
      407 |         });
      408 |         expect(req.body.user).toBeUndefined();

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:405:26)

  ‚óè Validation Error Handler ‚Ä∫ sanitizeRequestData() - XSS Prevention ‚Ä∫ Parameter Pollution Prevention (CWE-20) ‚Ä∫ should prevent duplicate parameter names

    expect(received).toEqual(expected) // deep equality

    - Expected  - 0
    + Received  + 2

      Object {
    +   "extraParam1": "value1",
    +   "extraParam2": "value2",
        "sort": "price",
      }

      422 |         sanitizeRequestData(req, res, next);
      423 |
    > 424 |         expect(req.query).toEqual({
          |                           ^
      425 |           sort: 'price',
      426 |         });
      427 |       });

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:424:27)

 FAIL  tests/resultModel.test.mjs
  ‚óè ÔøΩÔøΩ UNIT: Result Model - Competition Result Management ‚Ä∫ saveResult ‚Ä∫ should save a competition result with all required fields

    Database error in saveResult:
    Invalid `prisma.competitionResult.create()` invocation:


    Foreign key constraint violated on the constraint: `competition_results_horseId_fkey`

      128 |   } catch (error) {
      129 |     logger.error('[resultModel.saveResult] Database error: %o', error);
    > 130 |     throw new Error(`Database error in saveResult: ${error.message}`);
          |           ^
      131 |   }
      132 | }
      133 |

      at saveResult (models/resultModel.mjs:130:11)
      at Object.<anonymous> (tests/resultModel.test.mjs:105:22)

  ‚óè ÔøΩÔøΩ UNIT: Result Model - Competition Result Management ‚Ä∫ saveResult ‚Ä∫ should save a result without placement (null for non-top-3)

    Database error in saveResult:
    Invalid `prisma.competitionResult.create()` invocation:


    Foreign key constraint violated on the constraint: `competition_results_horseId_fkey`

      128 |   } catch (error) {
      129 |     logger.error('[resultModel.saveResult] Database error: %o', error);
    > 130 |     throw new Error(`Database error in saveResult: ${error.message}`);
          |           ^
      131 |   }
      132 | }
      133 |

      at saveResult (models/resultModel.mjs:130:11)
      at Object.<anonymous> (tests/resultModel.test.mjs:146:22)

  ‚óè ÔøΩÔøΩ UNIT: Result Model - Competition Result Management ‚Ä∫ saveResult ‚Ä∫ should handle prizeWon as string and convert to float

    Database error in saveResult:
    Invalid `prisma.competitionResult.create()` invocation:


    Foreign key constraint violated on the constraint: `competition_results_horseId_fkey`

      128 |   } catch (error) {
      129 |     logger.error('[resultModel.saveResult] Database error: %o', error);
    > 130 |     throw new Error(`Database error in saveResult: ${error.message}`);
          |           ^
      131 |   }
      132 | }
      133 |

      at saveResult (models/resultModel.mjs:130:11)
      at Object.<anonymous> (tests/resultModel.test.mjs:329:7)

  ‚óè ÔøΩÔøΩ UNIT: Result Model - Competition Result Management ‚Ä∫ saveResult ‚Ä∫ should handle database errors gracefully

    expect(received).rejects.toThrow(expected)

    Expected substring: "Database error in saveResult: Database connection failed"
    Received message:   "Database error in saveResult:¬∑
    Invalid `prisma.competitionResult.create()` invocation:¬∑¬∑
    Foreign key constraint violated on the constraint: `competition_results_horseId_fkey`"

          128 |   } catch (error) {
          129 |     logger.error('[resultModel.saveResult] Database error: %o', error);
        > 130 |     throw new Error(`Database error in saveResult: ${error.message}`);
              |           ^
          131 |   }
          132 | }
          133 |

          at saveResult (models/resultModel.mjs:130:11)
          at Object.<anonymous> (tests/resultModel.test.mjs:352:7)

      350 |       mockPrisma.competitionResult.create.mockRejectedValue(new Error('Database connection failed'));
      351 |
    > 352 |       await expect(saveResult(resultData)).rejects.toThrow('Database error in saveResult: Database connection failed');
          |                                                    ^
      353 |     });
      354 |
      355 |     it('should update existing placeholder result instead of creating new one', async () => {

      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (tests/resultModel.test.mjs:352:52)

  ‚óè ÔøΩÔøΩ UNIT: Result Model - Competition Result Management ‚Ä∫ saveResult ‚Ä∫ should update existing placeholder result instead of creating new one

    Database error in saveResult:
    Invalid `prisma.competitionResult.create()` invocation:


    Foreign key constraint violated on the constraint: `competition_results_horseId_fkey`

      128 |   } catch (error) {
      129 |     logger.error('[resultModel.saveResult] Database error: %o', error);
    > 130 |     throw new Error(`Database error in saveResult: ${error.message}`);
          |           ^
      131 |   }
      132 | }
      133 |

      at saveResult (models/resultModel.mjs:130:11)
      at Object.<anonymous> (tests/resultModel.test.mjs:390:22)

  ‚óè ÔøΩÔøΩ UNIT: Result Model - Competition Result Management ‚Ä∫ saveResult ‚Ä∫ should create new result when no placeholder exists

    Database error in saveResult:
    Invalid `prisma.competitionResult.create()` invocation:


    Foreign key constraint violated on the constraint: `competition_results_horseId_fkey`

      128 |   } catch (error) {
      129 |     logger.error('[resultModel.saveResult] Database error: %o', error);
    > 130 |     throw new Error(`Database error in saveResult: ${error.message}`);
          |           ^
      131 |   }
      132 | }
      133 |

      at saveResult (models/resultModel.mjs:130:11)
      at Object.<anonymous> (tests/resultModel.test.mjs:447:22)

  ‚óè ÔøΩÔøΩ UNIT: Result Model - Competition Result Management ‚Ä∫ getResultsByHorse ‚Ä∫ should retrieve all results for a specific horse

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 1
    Received number of calls: 0

      517 |       const results = await getResultsByHorse(horseId);
      518 |
    > 519 |       expect(mockPrisma.competitionResult.findMany).toHaveBeenCalledTimes(1);
          |                                                     ^
      520 |       expect(mockPrisma.competitionResult.findMany).toHaveBeenCalledWith({
      521 |         where: { horseId: 1 },
      522 |         include: {

      at Object.<anonymous> (tests/resultModel.test.mjs:519:53)

  ‚óè ÔøΩÔøΩ UNIT: Result Model - Competition Result Management ‚Ä∫ getResultsByHorse ‚Ä∫ should handle database errors gracefully

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: []

      551 |       mockPrisma.competitionResult.findMany.mockRejectedValue(new Error('Database connection failed'));
      552 |
    > 553 |       await expect(getResultsByHorse(1)).rejects.toThrow(
          |             ^
      554 |         'Database error in getResultsByHorse: Database connection failed',
      555 |       );
      556 |     });

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/resultModel.test.mjs:553:13)

  ‚óè ÔøΩÔøΩ UNIT: Result Model - Competition Result Management ‚Ä∫ getResultsByShow ‚Ä∫ should retrieve all results for a specific show

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 1
    Received number of calls: 0

      589 |       const results = await getResultsByShow(showId);
      590 |
    > 591 |       expect(mockPrisma.competitionResult.findMany).toHaveBeenCalledTimes(1);
          |                                                     ^
      592 |       expect(mockPrisma.competitionResult.findMany).toHaveBeenCalledWith({
      593 |         where: { showId: 2 },
      594 |         include: {

      at Object.<anonymous> (tests/resultModel.test.mjs:591:53)

  ‚óè ÔøΩÔøΩ UNIT: Result Model - Competition Result Management ‚Ä∫ getResultsByShow ‚Ä∫ should handle database errors gracefully

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: []

      623 |       mockPrisma.competitionResult.findMany.mockRejectedValue(new Error('Database connection failed'));
      624 |
    > 625 |       await expect(getResultsByShow(1)).rejects.toThrow(
          |             ^
      626 |         'Database error in getResultsByShow: Database connection failed',
      627 |       );
      628 |     });

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/resultModel.test.mjs:625:13)

  ‚óè ÔøΩÔøΩ UNIT: Result Model - Competition Result Management ‚Ä∫ getResultById ‚Ä∫ should retrieve a specific result by ID

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 1
    Received number of calls: 0

      648 |       const result = await getResultById(resultId);
      649 |
    > 650 |       expect(mockPrisma.competitionResult.findUnique).toHaveBeenCalledTimes(1);
          |                                                       ^
      651 |       expect(mockPrisma.competitionResult.findUnique).toHaveBeenCalledWith({
      652 |         where: { id: 1 },
      653 |         include: {

      at Object.<anonymous> (tests/resultModel.test.mjs:650:55)

  ‚óè ÔøΩÔøΩ UNIT: Result Model - Competition Result Management ‚Ä∫ getResultById ‚Ä∫ should handle database errors gracefully

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: null

      681 |       mockPrisma.competitionResult.findUnique.mockRejectedValue(new Error('Database connection failed'));
      682 |
    > 683 |       await expect(getResultById(1)).rejects.toThrow('Database error in getResultById: Database connection failed');
          |             ^
      684 |     });
      685 |   });
      686 |

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/resultModel.test.mjs:683:13)

  ‚óè ÔøΩÔøΩ UNIT: Result Model - Competition Result Management ‚Ä∫ createResult ‚Ä∫ should be an alias for saveResult and work identically

    Database error in saveResult:
    Invalid `prisma.competitionResult.create()` invocation:


    Foreign key constraint violated on the constraint: `competition_results_horseId_fkey`

      128 |   } catch (error) {
      129 |     logger.error('[resultModel.saveResult] Database error: %o', error);
    > 130 |     throw new Error(`Database error in saveResult: ${error.message}`);
          |           ^
      131 |   }
      132 | }
      133 |

      at saveResult (models/resultModel.mjs:130:11)
      at createResult (models/resultModel.mjs:248:10)
      at Object.<anonymous> (tests/resultModel.test.mjs:702:22)

  ‚óè ÔøΩÔøΩ UNIT: Result Model - Competition Result Management ‚Ä∫ getResultsByUser ‚Ä∫ should retrieve results for all user horses with default options

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"include": {"horse": {"include": {"breed": true}}, "show": true}, "orderBy": {"runDate": "desc"}, "skip": 0, "take": 50, "where": {"horse": {"userId": "user123"}}}

    Number of calls: 0

      736 |       const results = await getResultsByUser(userId);
      737 |
    > 738 |       expect(mockPrisma.competitionResult.findMany).toHaveBeenCalledWith({
          |                                                     ^
      739 |         where: {
      740 |           horse: {
      741 |             userId: 'user123',

      at Object.<anonymous> (tests/resultModel.test.mjs:738:53)

  ‚óè ÔøΩÔøΩ UNIT: Result Model - Competition Result Management ‚Ä∫ getResultsByUser ‚Ä∫ should handle custom options (limit, offset, discipline)

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"include": Any<Object>, "orderBy": {"runDate": "desc"}, "skip": 5, "take": 10, "where": {"discipline": "Racing", "horse": {"userId": "user123"}}}

    Number of calls: 0

      767 |       await getResultsByUser(userId, options);
      768 |
    > 769 |       expect(mockPrisma.competitionResult.findMany).toHaveBeenCalledWith({
          |                                                     ^
      770 |         where: {
      771 |           horse: {
      772 |             userId: 'user123',

      at Object.<anonymous> (tests/resultModel.test.mjs:769:53)

  ‚óè ÔøΩÔøΩ UNIT: Result Model - Competition Result Management ‚Ä∫ getResultsByUser ‚Ä∫ should cap limit at 100 and ensure non-negative offset

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"skip": 0, "take": 100}

    Number of calls: 0

      789 |       await getResultsByUser(userId, options);
      790 |
    > 791 |       expect(mockPrisma.competitionResult.findMany).toHaveBeenCalledWith(
          |                                                     ^
      792 |         expect.objectContaining({
      793 |           take: 100, // Capped at 100
      794 |           skip: 0, // Non-negative

      at Object.<anonymous> (tests/resultModel.test.mjs:791:53)

  ‚óè ÔøΩÔøΩ UNIT: Result Model - Competition Result Management ‚Ä∫ getResultsByUser ‚Ä∫ should handle database errors gracefully

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: []

      800 |       mockPrisma.competitionResult.findMany.mockRejectedValue(new Error('Database error'));
      801 |
    > 802 |       await expect(getResultsByUser('user123')).rejects.toThrow('Database error');
          |             ^
      803 |     });
      804 |   });
      805 |

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/resultModel.test.mjs:802:13)

  ‚óè ÔøΩÔøΩ UNIT: Result Model - Competition Result Management ‚Ä∫ parseInt conversion edge cases ‚Ä∫ should handle string IDs in getResultsByHorse

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"horseId": 123}}

    Number of calls: 0

      810 |       await getResultsByHorse('123'); // String ID
      811 |
    > 812 |       expect(mockPrisma.competitionResult.findMany).toHaveBeenCalledWith(
          |                                                     ^
      813 |         expect.objectContaining({
      814 |           where: { horseId: 123 }, // Should be converted to number
      815 |         }),

      at Object.<anonymous> (tests/resultModel.test.mjs:812:53)

  ‚óè ÔøΩÔøΩ UNIT: Result Model - Competition Result Management ‚Ä∫ parseInt conversion edge cases ‚Ä∫ should handle string IDs in getResultsByShow

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"showId": 456}}

    Number of calls: 0

      822 |       await getResultsByShow('456'); // String ID
      823 |
    > 824 |       expect(mockPrisma.competitionResult.findMany).toHaveBeenCalledWith(
          |                                                     ^
      825 |         expect.objectContaining({
      826 |           where: { showId: 456 }, // Should be converted to number
      827 |         }),

      at Object.<anonymous> (tests/resultModel.test.mjs:824:53)

  ‚óè ÔøΩÔøΩ UNIT: Result Model - Competition Result Management ‚Ä∫ parseInt conversion edge cases ‚Ä∫ should handle string IDs in getResultById

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"id": 789}}

    Number of calls: 0

      834 |       await getResultById('789'); // String ID
      835 |
    > 836 |       expect(mockPrisma.competitionResult.findUnique).toHaveBeenCalledWith(
          |                                                       ^
      837 |         expect.objectContaining({
      838 |           where: { id: 789 }, // Should be converted to number
      839 |         }),

      at Object.<anonymous> (tests/resultModel.test.mjs:836:55)

 FAIL  __tests__/middleware/ownership.test.mjs
  ‚óè Ownership Middleware ‚Ä∫ requireOwnership() ‚Ä∫ Ownership validation - Horse ‚Ä∫ should allow access to owned horse

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"id": 1, "ownerId": "user-123"}}

    Number of calls: 0

      126 |         await middleware(req, res, next);
      127 |
    > 128 |         expect(prisma.horse.findFirst).toHaveBeenCalledWith(expect.objectContaining({
          |                                        ^
      129 |           where: {
      130 |             id: 1,
      131 |             ownerId: 'user-123',

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:128:40)

  ‚óè Ownership Middleware ‚Ä∫ requireOwnership() ‚Ä∫ Ownership validation - Other resource types ‚Ä∫ should validate foal ownership

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"id": 1, "ownerId": "user-123"}}

    Number of calls: 0

      159 |         await middleware(req, res, next);
      160 |
    > 161 |         expect(prisma.horse.findFirst).toHaveBeenCalledWith(expect.objectContaining({
          |                                        ^
      162 |           where: {
      163 |             id: 1,
      164 |             ownerId: 'user-123',

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:161:40)

  ‚óè Ownership Middleware ‚Ä∫ requireOwnership() ‚Ä∫ Ownership validation - Other resource types ‚Ä∫ should validate groom ownership

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"id": 1, "userId": "user-123"}}

    Number of calls: 0

      176 |         await middleware(req, res, next);
      177 |
    > 178 |         expect(prisma.groom.findFirst).toHaveBeenCalledWith(expect.objectContaining({
          |                                        ^
      179 |           where: {
      180 |             id: 1,
      181 |             userId: 'user-123',

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:178:40)

  ‚óè Ownership Middleware ‚Ä∫ requireOwnership() ‚Ä∫ Ownership validation - Other resource types ‚Ä∫ should validate groom-assignment ownership

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"id": 1, "userId": "user-123"}}

    Number of calls: 0

      193 |         await middleware(req, res, next);
      194 |
    > 195 |         expect(prisma.groomAssignment.findFirst).toHaveBeenCalledWith(expect.objectContaining({
          |                                                  ^
      196 |           where: {
      197 |             id: 1,
      198 |             userId: 'user-123',

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:195:50)

  ‚óè Ownership Middleware ‚Ä∫ requireOwnership() ‚Ä∫ Ownership validation - Other resource types ‚Ä∫ should validate breeding ownership (maps to horse)

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"id": 1, "ownerId": "user-123"}}

    Number of calls: 0

      210 |         await middleware(req, res, next);
      211 |
    > 212 |         expect(prisma.horse.findFirst).toHaveBeenCalledWith(expect.objectContaining({
          |                                        ^
      213 |           where: {
      214 |             id: 1,
      215 |             ownerId: 'user-123',

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:212:40)

  ‚óè Ownership Middleware ‚Ä∫ requireOwnership() ‚Ä∫ Ownership validation - Other resource types ‚Ä∫ should validate competition-entry ownership (maps to competitionResult)

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"horse": {"ownerId": "user-123"}, "id": 1}}

    Number of calls: 0

      227 |         await middleware(req, res, next);
      228 |
    > 229 |         expect(prisma.competitionResult.findFirst).toHaveBeenCalledWith(expect.objectContaining({
          |                                                    ^
      230 |           where: {
      231 |             id: 1,
      232 |             horse: { ownerId: 'user-123' }

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:229:52)

  ‚óè Ownership Middleware ‚Ä∫ requireOwnership() ‚Ä∫ Ownership validation - Other resource types ‚Ä∫ should validate training-session ownership (maps to trainingLog)

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"horse": {"ownerId": "user-123"}, "id": 1}}

    Number of calls: 0

      244 |         await middleware(req, res, next);
      245 |
    > 246 |         expect(prisma.trainingLog.findFirst).toHaveBeenCalledWith(expect.objectContaining({
          |                                              ^
      247 |           where: {
      248 |             id: 1,
      249 |             horse: { ownerId: 'user-123' }

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:246:46)

  ‚óè Ownership Middleware ‚Ä∫ requireOwnership() ‚Ä∫ Error handling ‚Ä∫ should handle database errors gracefully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 500
    Received: 404

    Number of calls: 1

      262 |         await middleware(req, res, next);
      263 |
    > 264 |         expect(res.status).toHaveBeenCalledWith(500);
          |                            ^
      265 |         expect(res.json).toHaveBeenCalledWith(expect.objectContaining({
      266 |           success: false,
      267 |           message: 'Ownership validation error',

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:264:28)

  ‚óè Ownership Middleware ‚Ä∫ findOwnedResource() ‚Ä∫ should return owned horse

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"id": 1, "ownerId": "user-123"}}

    Number of calls: 0

      278 |       const result = await findOwnedResource('horse', 1, 'user-123');
      279 |
    > 280 |       expect(prisma.horse.findFirst).toHaveBeenCalledWith(expect.objectContaining({
          |                                      ^
      281 |         where: {
      282 |           id: 1,
      283 |           ownerId: 'user-123',

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:280:38)

  ‚óè Ownership Middleware ‚Ä∫ validateBatchOwnership() ‚Ä∫ should return all owned horses

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"id": {"in": [1, 2]}, "ownerId": "user-123"}}

    Number of calls: 0

      298 |       const result = await validateBatchOwnership('horse', [1, 2], 'user-123');
      299 |
    > 300 |       expect(prisma.horse.findMany).toHaveBeenCalledWith(expect.objectContaining({
          |                                     ^
      301 |         where: {
      302 |           id: { in: [1, 2] },
      303 |           ownerId: 'user-123',

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:300:37)

  ‚óè Ownership Middleware ‚Ä∫ Security tests ‚Ä∫ should prevent TOCTOU vulnerabilities by using atomic single query

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 1
    Received number of calls: 0

      339 |       await middleware(req, res, next);
      340 |
    > 341 |       expect(prisma.horse.findFirst).toHaveBeenCalledTimes(1);
          |                                      ^
      342 |       expect(req.horse).toBe(mockHorse);
      343 |       expect(next).toHaveBeenCalled();
      344 |     });

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:341:38)

  ‚óè Ownership Middleware ‚Ä∫ Security tests ‚Ä∫ should validate user ID from token, not from request params

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"id": 1, "ownerId": "user-123"}}

    Number of calls: 0

      354 |       await middleware(req, res, next);
      355 |
    > 356 |       expect(prisma.horse.findFirst).toHaveBeenCalledWith(expect.objectContaining({
          |                                      ^
      357 |         where: {
      358 |           id: 1,
      359 |           ownerId: 'user-123',

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:356:38)

 FAIL  tests/unit/flagEvaluationEngine.test.mjs
  ‚óè Flag Evaluation Engine ‚Ä∫ evaluateHorseFlags ‚Ä∫ should evaluate and assign flags for eligible horse

    Horse with ID 1 not found

      49 |
      50 |     if (!horse) {
    > 51 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      52 |     }
      53 |
      54 |     // Check age eligibility

      at evaluateHorseFlags (utils/flagEvaluationEngine.mjs:51:13)
      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:124:22)

  ‚óè Flag Evaluation Engine ‚Ä∫ evaluateHorseFlags ‚Ä∫ should reject horse outside age range

    Horse with ID 1 not found

      49 |
      50 |     if (!horse) {
    > 51 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      52 |     }
      53 |
      54 |     // Check age eligibility

      at evaluateHorseFlags (utils/flagEvaluationEngine.mjs:51:13)
      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:147:22)

  ‚óè Flag Evaluation Engine ‚Ä∫ evaluateHorseFlags ‚Ä∫ should reject horse with maximum flags

    Horse with ID 1 not found

      49 |
      50 |     if (!horse) {
    > 51 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      52 |     }
      53 |
      54 |     // Check age eligibility

      at evaluateHorseFlags (utils/flagEvaluationEngine.mjs:51:13)
      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:162:22)

  ‚óè Flag Evaluation Engine ‚Ä∫ evaluateHorseFlags ‚Ä∫ should not assign duplicate flags

    Horse with ID 1 not found

      49 |
      50 |     if (!horse) {
    > 51 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      52 |     }
      53 |
      54 |     // Check age eligibility

      at evaluateHorseFlags (utils/flagEvaluationEngine.mjs:51:13)
      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:180:22)

  ‚óè Flag Evaluation Engine ‚Ä∫ evaluateHorseFlags ‚Ä∫ should respect flag limit during assignment

    Horse with ID 1 not found

      49 |
      50 |     if (!horse) {
    > 51 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      52 |     }
      53 |
      54 |     // Check age eligibility

      at evaluateHorseFlags (utils/flagEvaluationEngine.mjs:51:13)
      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:210:22)

  ‚óè Flag Evaluation Engine ‚Ä∫ evaluateHorseFlags ‚Ä∫ should handle care analysis ineligibility

    Horse with ID 1 not found

      49 |
      50 |     if (!horse) {
    > 51 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      52 |     }
      53 |
      54 |     // Check age eligibility

      at evaluateHorseFlags (utils/flagEvaluationEngine.mjs:51:13)
      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:224:22)

  ‚óè Flag Evaluation Engine ‚Ä∫ evaluateHorseFlags ‚Ä∫ should handle database errors

    expect(received).rejects.toThrow(expected)

    Expected substring: "Database error"
    Received message:   "Horse with ID 1 not found"

          49 |
          50 |     if (!horse) {
        > 51 |       throw new Error(`Horse with ID ${horseId} not found`);
             |             ^
          52 |     }
          53 |
          54 |     // Check age eligibility

          at evaluateHorseFlags (utils/flagEvaluationEngine.mjs:51:13)
          at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:241:7)

      239 |       mockPrisma.horse.findUnique.mockRejectedValue(new Error('Database error'));
      240 |
    > 241 |       await expect(evaluateHorseFlags(1)).rejects.toThrow('Database error');
          |                                                   ^
      242 |     });
      243 |   });
      244 |

      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:241:51)

  ‚óè Flag Evaluation Engine ‚Ä∫ Flag Trigger Evaluation ‚Ä∫ should trigger brave flag with correct conditions

    Horse with ID 1 not found

      49 |
      50 |     if (!horse) {
    > 51 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      52 |     }
      53 |
      54 |     // Check age eligibility

      at evaluateHorseFlags (utils/flagEvaluationEngine.mjs:51:13)
      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:278:22)

  ‚óè Flag Evaluation Engine ‚Ä∫ Flag Trigger Evaluation ‚Ä∫ should trigger fearful flag with correct conditions

    Horse with ID 1 not found

      49 |
      50 |     if (!horse) {
    > 51 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      52 |     }
      53 |
      54 |     // Check age eligibility

      at evaluateHorseFlags (utils/flagEvaluationEngine.mjs:51:13)
      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:318:22)

  ‚óè Flag Evaluation Engine ‚Ä∫ batchEvaluateFlags ‚Ä∫ should evaluate multiple horses

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      348 |
      349 |       expect(results).toHaveLength(3);
    > 350 |       expect(results.every(r => r.success)).toBe(true);
          |                                             ^
      351 |     });
      352 |
      353 |     test('should handle mixed success/failure in batch', async () => {

      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:350:45)

  ‚óè Flag Evaluation Engine ‚Ä∫ batchEvaluateFlags ‚Ä∫ should handle mixed success/failure in batch

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      373 |
      374 |       expect(results).toHaveLength(2);
    > 375 |       expect(results[0].success).toBe(true);
          |                                  ^
      376 |       expect(results[1].success).toBe(false);
      377 |       expect(results[1].error).toContain('Horse with ID 2 not found');
      378 |     });

      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:375:34)

  ‚óè Flag Evaluation Engine ‚Ä∫ getEligibleHorses ‚Ä∫ should return eligible horses within age range

    expect(received).toEqual(expected) // deep equality

    - Expected  - 4
    + Received  + 1

    - Array [
    -   1,
    -   2,
    - ]
    + Array []

      390 |       const result = await getEligibleHorses();
      391 |
    > 392 |       expect(result).toEqual([1, 2]);
          |                      ^
      393 |       expect(mockPrisma.horse.findMany).toHaveBeenCalledWith({
      394 |         where: {
      395 |           dateOfBirth: {

      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:392:22)

  ‚óè Flag Evaluation Engine ‚Ä∫ getEligibleHorses ‚Ä∫ should handle database errors in getEligibleHorses

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: []

      410 |       mockPrisma.horse.findMany.mockRejectedValue(new Error('Database error'));
      411 |
    > 412 |       await expect(getEligibleHorses()).rejects.toThrow('Database error');
          |             ^
      413 |     });
      414 |   });
      415 | });

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:412:13)

 FAIL  __tests__/unit/cacheHelper.test.mjs
  ‚óè CacheHelper ‚Ä∫ Connection Management ‚Ä∫ should initialize Redis connection successfully

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      147 |
      148 |       // Redis should have been initialized
    > 149 |       expect(mockRedisInstance.connect).toHaveBeenCalled();
          |                                         ^
      150 |     });
      151 |
      152 |     it('should handle connection failure gracefully', async () => {

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:149:41)

  ‚óè CacheHelper ‚Ä∫ getCachedQuery() ‚Ä∫ should execute query on cache miss and store result

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "horse:1"

    Number of calls: 0

      184 |       expect(queryFn).toHaveBeenCalledTimes(1);
      185 |       expect(result).toEqual({ id: 1, name: 'Horse' });
    > 186 |       expect(mockRedisInstance.get).toHaveBeenCalledWith('horse:1');
          |                                     ^
      187 |       expect(mockRedisInstance.setex).toHaveBeenCalledWith('horse:1', 120, JSON.stringify({ id: 1, name: 'Horse' }));
      188 |       expect(cacheStats.misses).toBe(1);
      189 |       expect(cacheStats.hits).toBe(0);

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:186:37)

  ‚óè CacheHelper ‚Ä∫ getCachedQuery() ‚Ä∫ should return cached result on cache hit without executing query

    expect(jest.fn()).not.toHaveBeenCalled()

    Expected number of calls: 0
    Received number of calls: 1

    1: called with 0 arguments

      207 |       const result = await getCachedQuery('horse:1', queryFn, 120);
      208 |
    > 209 |       expect(queryFn).not.toHaveBeenCalled();
          |                           ^
      210 |       expect(result).toEqual(cachedData);
      211 |       expect(cacheStats.hits).toBe(1);
      212 |       expect(cacheStats.misses).toBe(0);

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:209:27)

  ‚óè CacheHelper ‚Ä∫ getCachedQuery() ‚Ä∫ should use default TTL of 60 seconds when not specified

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "test:key", 60, Any<String>

    Number of calls: 0

      225 |       await getCachedQuery('test:key', queryFn);
      226 |
    > 227 |       expect(mockRedisInstance.setex).toHaveBeenCalledWith('test:key', 60, expect.any(String));
          |                                       ^
      228 |     });
      229 |
      230 |     it('should handle JSON parse errors gracefully', async () => {

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:227:39)

  ‚óè CacheHelper ‚Ä∫ getCachedQuery() ‚Ä∫ should handle cache write errors gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      275 |       // Should return query result despite cache write failure
      276 |       expect(result).toEqual({ data: 'result' });
    > 277 |       expect(cacheStats.errors).toBe(1);
          |                                 ^
      278 |     });
      279 |
      280 |     it('should bypass cache when Redis unavailable', async () => {

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:277:33)

  ‚óè CacheHelper ‚Ä∫ invalidateCache() ‚Ä∫ should delete single cache key successfully

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      302 |       const deleted = await invalidateCache('horse:1');
      303 |
    > 304 |       expect(deleted).toBe(1);
          |                       ^
      305 |       expect(mockRedisInstance.del).toHaveBeenCalledWith('horse:1');
      306 |       expect(cacheStats.invalidations).toBe(1);
      307 |     });

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:304:23)

  ‚óè CacheHelper ‚Ä∫ invalidateCache() ‚Ä∫ should handle invalidation errors gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      327 |
      328 |       expect(deleted).toBe(0);
    > 329 |       expect(cacheStats.errors).toBe(1);
          |                                 ^
      330 |     });
      331 |   });
      332 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:329:33)

  ‚óè CacheHelper ‚Ä∫ invalidateCachePattern() ‚Ä∫ should delete all keys matching pattern

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 0

      343 |       const deleted = await invalidateCachePattern('horse:*');
      344 |
    > 345 |       expect(deleted).toBe(3);
          |                       ^
      346 |       expect(mockRedisInstance.keys).toHaveBeenCalledWith('horse:*');
      347 |       expect(mockRedisInstance.del).toHaveBeenCalledWith('horse:1', 'horse:2', 'horse:3');
      348 |       expect(cacheStats.invalidations).toBe(3);

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:345:23)

  ‚óè CacheHelper ‚Ä∫ invalidateCachePattern() ‚Ä∫ should handle pattern errors gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      374 |
      375 |       expect(deleted).toBe(0);
    > 376 |       expect(cacheStats.errors).toBe(1);
          |                                 ^
      377 |     });
      378 |   });
      379 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:376:33)

  ‚óè CacheHelper ‚Ä∫ invalidateCacheMultiple() ‚Ä∫ should delete multiple keys at once

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 0

      389 |       const deleted = await invalidateCacheMultiple(['horse:1', 'horse:2', 'groom:1']);
      390 |
    > 391 |       expect(deleted).toBe(3);
          |                       ^
      392 |       expect(mockRedisInstance.del).toHaveBeenCalledWith('horse:1', 'horse:2', 'groom:1');
      393 |       expect(cacheStats.invalidations).toBe(3);
      394 |     });

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:391:23)

  ‚óè CacheHelper ‚Ä∫ invalidateCacheMultiple() ‚Ä∫ should handle errors gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      410 |
      411 |       expect(deleted).toBe(0);
    > 412 |       expect(cacheStats.errors).toBe(1);
          |                                 ^
      413 |     });
      414 |   });
      415 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:412:33)

  ‚óè CacheHelper ‚Ä∫ clearAllCache() ‚Ä∫ should clear all cache keys successfully

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      425 |       const success = await clearAllCache();
      426 |
    > 427 |       expect(success).toBe(true);
          |                       ^
      428 |       expect(mockRedisInstance.flushdb).toHaveBeenCalled();
      429 |       expect(cacheStats.invalidations).toBe(1);
      430 |     });

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:427:23)

  ‚óè CacheHelper ‚Ä∫ clearAllCache() ‚Ä∫ should handle errors gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      449 |
      450 |       expect(success).toBe(false);
    > 451 |       expect(cacheStats.errors).toBe(1);
          |                                 ^
      452 |     });
      453 |   });
      454 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:451:33)

  ‚óè CacheHelper ‚Ä∫ getCacheStatistics() ‚Ä∫ should include Redis statistics when available

    expect(received).toBeDefined()

    Received: undefined

      499 |       const stats = await getCacheStatistics();
      500 |
    > 501 |       expect(stats.redis).toBeDefined();
          |                           ^
      502 |       expect(stats.redis.totalKeys).toBe(42);
      503 |       expect(stats.redis.memoryUsed).toBe('10M');
      504 |     });

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:501:27)

  ‚óè CacheHelper ‚Ä∫ closeRedisConnection() ‚Ä∫ should close Redis connection gracefully

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      540 |       await closeRedisConnection();
      541 |
    > 542 |       expect(mockRedisInstance.quit).toHaveBeenCalled();
          |                                      ^
      543 |     });
      544 |
      545 |     it('should be idempotent (safe to call multiple times)', async () => {

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:542:38)

  ‚óè CacheHelper ‚Ä∫ Cache Invalidation Helpers ‚Ä∫ should invalidate all horses caches

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      585 |       const deleted = await cacheInvalidation.horses();
      586 |
    > 587 |       expect(deleted).toBe(2);
          |                       ^
      588 |       expect(mockRedisInstance.keys).toHaveBeenCalledWith('horses:*');
      589 |     });
      590 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:587:23)

  ‚óè CacheHelper ‚Ä∫ Cache Invalidation Helpers ‚Ä∫ should invalidate specific horse cache

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      599 |       const deleted = await cacheInvalidation.horse(123);
      600 |
    > 601 |       expect(deleted).toBe(1);
          |                       ^
      602 |       expect(mockRedisInstance.del).toHaveBeenCalledWith('horse:123');
      603 |     });
      604 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:601:23)

  ‚óè CacheHelper ‚Ä∫ Cache Invalidation Helpers ‚Ä∫ should invalidate all grooms caches

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      614 |       const deleted = await cacheInvalidation.grooms();
      615 |
    > 616 |       expect(deleted).toBe(1);
          |                       ^
      617 |       expect(mockRedisInstance.keys).toHaveBeenCalledWith('grooms:*');
      618 |     });
      619 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:616:23)

  ‚óè CacheHelper ‚Ä∫ Cache Invalidation Helpers ‚Ä∫ should invalidate specific groom cache

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      628 |       const deleted = await cacheInvalidation.groom(456);
      629 |
    > 630 |       expect(deleted).toBe(1);
          |                       ^
      631 |       expect(mockRedisInstance.del).toHaveBeenCalledWith('groom:456');
      632 |     });
      633 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:630:23)

  ‚óè CacheHelper ‚Ä∫ Cache Invalidation Helpers ‚Ä∫ should invalidate all leaderboards caches

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      643 |       const deleted = await cacheInvalidation.leaderboards();
      644 |
    > 645 |       expect(deleted).toBe(1);
          |                       ^
      646 |       expect(mockRedisInstance.keys).toHaveBeenCalledWith('leaderboard:*');
      647 |     });
      648 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:645:23)

  ‚óè CacheHelper ‚Ä∫ Cache Invalidation Helpers ‚Ä∫ should invalidate all competitions caches

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      658 |       const deleted = await cacheInvalidation.competitions();
      659 |
    > 660 |       expect(deleted).toBe(1);
          |                       ^
      661 |       expect(mockRedisInstance.keys).toHaveBeenCalledWith('competition:*');
      662 |     });
      663 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:660:23)

  ‚óè CacheHelper ‚Ä∫ Cache Invalidation Helpers ‚Ä∫ should invalidate specific competition cache

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      672 |       const deleted = await cacheInvalidation.competition(789);
      673 |
    > 674 |       expect(deleted).toBe(1);
          |                       ^
      675 |       expect(mockRedisInstance.del).toHaveBeenCalledWith('competition:789');
      676 |     });
      677 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:674:23)

  ‚óè CacheHelper ‚Ä∫ Cache Invalidation Helpers ‚Ä∫ should invalidate all users caches

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      687 |       const deleted = await cacheInvalidation.users();
      688 |
    > 689 |       expect(deleted).toBe(1);
          |                       ^
      690 |       expect(mockRedisInstance.keys).toHaveBeenCalledWith('user:*');
      691 |     });
      692 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:689:23)

  ‚óè CacheHelper ‚Ä∫ Cache Invalidation Helpers ‚Ä∫ should invalidate specific user cache

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      701 |       const deleted = await cacheInvalidation.user(999);
      702 |
    > 703 |       expect(deleted).toBe(1);
          |                       ^
      704 |       expect(mockRedisInstance.del).toHaveBeenCalledWith('user:999');
      705 |     });
      706 |   });

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:703:23)

 FAIL  tests/xpLogModel.test.mjs
  ‚óè ÔøΩÔøΩ UNIT: XP Log Model - Experience Point Event Tracking ‚Ä∫ logXpEvent ‚Ä∫ should log XP event successfully

    PrismaClientKnownRequestError:
    Invalid `prisma.xpEvent.create()` invocation:


    Foreign key constraint violated on the constraint: `xp_events_userId_fkey`

      38 |
      39 |     // Insert XP event into database using Prisma
    > 40 |     const xpEvent = await prisma.xpEvent.create({
         |                     ^
      41 |       data: {
      42 |         userId, // Changed userId to userId
      43 |         amount,

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at logXpEvent (models/xpLogModel.mjs:40:21)
      at Object.<anonymous> (tests/xpLogModel.test.mjs:98:22)

  ‚óè ÔøΩÔøΩ UNIT: XP Log Model - Experience Point Event Tracking ‚Ä∫ logXpEvent ‚Ä∫ should handle database errors

    expect(received).rejects.toThrow(expected)

    Expected substring: "Database connection failed"
    Received message:   "
    Invalid `prisma.xpEvent.create()` invocation:¬∑¬∑
    Foreign key constraint violated on the constraint: `xp_events_userId_fkey`"

          38 |
          39 |     // Insert XP event into database using Prisma
        > 40 |     const xpEvent = await prisma.xpEvent.create({
             |                     ^
          41 |       data: {
          42 |         userId, // Changed userId to userId
          43 |         amount,

          at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
          at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
          at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
          at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
          at logXpEvent (models/xpLogModel.mjs:40:21)
          at Object.<anonymous> (tests/xpLogModel.test.mjs:157:7)

      161 |           reason: 'Test reason',
      162 |         }),
    > 163 |       ).rejects.toThrow('Database connection failed');
          |                 ^
      164 |
      165 |       expect(mockLogger.error).toHaveBeenCalledWith(
      166 |         '[xpLogModel.logXpEvent] Error logging XP event: Database connection failed',

      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (tests/xpLogModel.test.mjs:163:17)

  ‚óè ÔøΩÔøΩ UNIT: XP Log Model - Experience Point Event Tracking ‚Ä∫ logXpEvent ‚Ä∫ should handle negative XP amounts

    PrismaClientKnownRequestError:
    Invalid `prisma.xpEvent.create()` invocation:


    Foreign key constraint violated on the constraint: `xp_events_userId_fkey`

      38 |
      39 |     // Insert XP event into database using Prisma
    > 40 |     const xpEvent = await prisma.xpEvent.create({
         |                     ^
      41 |       data: {
      42 |         userId, // Changed userId to userId
      43 |         amount,

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at logXpEvent (models/xpLogModel.mjs:40:21)
      at Object.<anonymous> (tests/xpLogModel.test.mjs:181:22)

  ‚óè ÔøΩÔøΩ UNIT: XP Log Model - Experience Point Event Tracking ‚Ä∫ getUserXpEvents ‚Ä∫ should retrieve XP events for a user

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"orderBy": {"timestamp": "desc"}, "skip": 0, "take": 50, "where": {"userId": "user-123"}}

    Number of calls: 0

      219 |       const result = await getUserXpEvents('user-123');
      220 |
    > 221 |       expect(mockPrismaXpEvent.findMany).toHaveBeenCalledWith({
          |                                          ^
      222 |         where: { userId: 'user-123' },
      223 |         orderBy: { timestamp: 'desc' },
      224 |         take: 50,

      at Object.<anonymous> (tests/xpLogModel.test.mjs:221:42)

  ‚óè ÔøΩÔøΩ UNIT: XP Log Model - Experience Point Event Tracking ‚Ä∫ getUserXpEvents ‚Ä∫ should handle date filters

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"orderBy": {"timestamp": "desc"}, "skip": 5, "take": 10, "where": {"timestamp": {"gte": 2024-01-01T00:00:00.000Z, "lte": 2024-01-02T00:00:00.000Z}, "userId": "user-123"}}

    Number of calls: 0

      245 |       });
      246 |
    > 247 |       expect(mockPrismaXpEvent.findMany).toHaveBeenCalledWith({
          |                                          ^
      248 |         where: {
      249 |           userId: 'user-123',
      250 |           timestamp: {

      at Object.<anonymous> (tests/xpLogModel.test.mjs:247:42)

  ‚óè ÔøΩÔøΩ UNIT: XP Log Model - Experience Point Event Tracking ‚Ä∫ getUserXpSummary ‚Ä∫ should calculate XP summary correctly

    expect(received).toEqual(expected) // deep equality

    - Expected  - 4
    + Received  + 4

      Object {
    -   "netTotal": 45,
    -   "totalEvents": 5,
    -   "totalGained": 50,
    -   "totalLost": 5,
    +   "netTotal": 0,
    +   "totalEvents": 0,
    +   "totalGained": 0,
    +   "totalLost": 0,
      }

      268 |       const result = await getUserXpSummary('user-123');
      269 |
    > 270 |       expect(result).toEqual({
          |                      ^
      271 |         totalGained: 50, // 20 + 15 + 5 + 10
      272 |         totalLost: 5, // abs(-5)
      273 |         netTotal: 45, // 20 + 15 + 5 - 5 + 10

      at Object.<anonymous> (tests/xpLogModel.test.mjs:270:22)

  ‚óè ÔøΩÔøΩ UNIT: XP Log Model - Experience Point Event Tracking ‚Ä∫ getUserXpSummary ‚Ä∫ should handle date filters in summary

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"select": {"amount": true}, "where": {"timestamp": {"gte": 2024-01-01T00:00:00.000Z, "lte": 2024-01-02T00:00:00.000Z}, "userId": "user-123"}}

    Number of calls: 0

      302 |       await getUserXpSummary('user-123', startDate, endDate);
      303 |
    > 304 |       expect(mockPrismaXpEvent.findMany).toHaveBeenCalledWith({
          |                                          ^
      305 |         where: {
      306 |           userId: 'user-123',
      307 |           timestamp: {

      at Object.<anonymous> (tests/xpLogModel.test.mjs:304:42)

  ‚óè ÔøΩÔøΩ UNIT: XP Log Model - Experience Point Event Tracking ‚Ä∫ getRecentXpEvents ‚Ä∫ should retrieve recent XP events across all users

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"include": {"user": {"select": {"id": true, "username": true}}}, "orderBy": {"timestamp": "desc"}, "skip": 0, "take": 10}

    Number of calls: 0

      338 |       const result = await getRecentXpEvents({ limit: 10, offset: 0 });
      339 |
    > 340 |       expect(mockPrismaXpEvent.findMany).toHaveBeenCalledWith({
          |                                          ^
      341 |         orderBy: { timestamp: 'desc' },
      342 |         take: 10,
      343 |         skip: 0,

      at Object.<anonymous> (tests/xpLogModel.test.mjs:340:42)

  ‚óè ÔøΩÔøΩ UNIT: XP Log Model - Experience Point Event Tracking ‚Ä∫ getRecentXpEvents ‚Ä∫ should use default options

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"include": {"user": {"select": {"id": true, "username": true}}}, "orderBy": {"timestamp": "desc"}, "skip": 0, "take": 100}

    Number of calls: 0

      363 |       await getRecentXpEvents();
      364 |
    > 365 |       expect(mockPrismaXpEvent.findMany).toHaveBeenCalledWith({
          |                                          ^
      366 |         orderBy: { timestamp: 'desc' },
      367 |         take: 100,
      368 |         skip: 0,

      at Object.<anonymous> (tests/xpLogModel.test.mjs:365:42)

 FAIL  __tests__/services/memoryResourceManagement.test.mjs
  ‚óè Memory and Resource Management System ‚Ä∫ Memory Monitoring ‚Ä∫ starts and stops monitoring correctly

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

       96 |
       97 |       memoryManager.startMonitoring();
    >  98 |       expect(memoryManager.isMonitoring).toBe(true);
          |                                          ^
       99 |       expect(memoryManager.monitoringTimer).toBeDefined();
      100 |
      101 |       memoryManager.stopMonitoring();

      at Object.<anonymous> (__tests__/services/memoryResourceManagement.test.mjs:98:42)

  ‚óè Memory and Resource Management System ‚Ä∫ Helper Functions ‚Ä∫ initializeMemoryManagement starts monitoring

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      422 |       });
      423 |
    > 424 |       expect(manager.isMonitoring).toBe(true);
          |                                    ^
      425 |
      426 |       shutdownMemoryManagement();
      427 |     });

      at Object.<anonymous> (__tests__/services/memoryResourceManagement.test.mjs:424:36)

  ‚óè Memory and Resource Management System ‚Ä∫ Event Handling ‚Ä∫ emits monitoring events correctly

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      442 |
      443 |       memoryManager.startMonitoring();
    > 444 |       expect(startEventEmitted).toBe(true);
          |                                 ^
      445 |
      446 |       memoryManager.stopMonitoring();
      447 |       expect(stopEventEmitted).toBe(true);

      at Object.<anonymous> (__tests__/services/memoryResourceManagement.test.mjs:444:33)

 FAIL  tests/unit/carePatternAnalysis.test.mjs
  ‚óè Care Pattern Analysis ‚Ä∫ analyzeCarePatterns ‚Ä∫ should analyze patterns for eligible horse

    Horse with ID 1 not found

      46 |
      47 |     if (!horse) {
    > 48 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      49 |     }
      50 |
      51 |     // Calculate horse age in days

      at analyzeCarePatterns (utils/carePatternAnalysis.mjs:48:13)
      at Object.<anonymous> (tests/unit/carePatternAnalysis.test.mjs:58:22)

  ‚óè Care Pattern Analysis ‚Ä∫ analyzeCarePatterns ‚Ä∫ should reject horse too old for evaluation

    Horse with ID 1 not found

      46 |
      47 |     if (!horse) {
    > 48 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      49 |     }
      50 |
      51 |     // Calculate horse age in days

      at analyzeCarePatterns (utils/carePatternAnalysis.mjs:48:13)
      at Object.<anonymous> (tests/unit/carePatternAnalysis.test.mjs:78:22)

  ‚óè Care Pattern Analysis ‚Ä∫ analyzeCarePatterns ‚Ä∫ should analyze consistent care patterns

    Horse with ID 1 not found

      46 |
      47 |     if (!horse) {
    > 48 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      49 |     }
      50 |
      51 |     // Calculate horse age in days

      at analyzeCarePatterns (utils/carePatternAnalysis.mjs:48:13)
      at Object.<anonymous> (tests/unit/carePatternAnalysis.test.mjs:123:22)

  ‚óè Care Pattern Analysis ‚Ä∫ analyzeCarePatterns ‚Ä∫ should analyze novelty exposure patterns

    Horse with ID 1 not found

      46 |
      47 |     if (!horse) {
    > 48 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      49 |     }
      50 |
      51 |     // Calculate horse age in days

      at analyzeCarePatterns (utils/carePatternAnalysis.mjs:48:13)
      at Object.<anonymous> (tests/unit/carePatternAnalysis.test.mjs:172:22)

  ‚óè Care Pattern Analysis ‚Ä∫ analyzeCarePatterns ‚Ä∫ should analyze stress management patterns

    Horse with ID 1 not found

      46 |
      47 |     if (!horse) {
    > 48 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      49 |     }
      50 |
      51 |     // Calculate horse age in days

      at analyzeCarePatterns (utils/carePatternAnalysis.mjs:48:13)
      at Object.<anonymous> (tests/unit/carePatternAnalysis.test.mjs:222:22)

  ‚óè Care Pattern Analysis ‚Ä∫ analyzeCarePatterns ‚Ä∫ should analyze bonding patterns

    Horse with ID 1 not found

      46 |
      47 |     if (!horse) {
    > 48 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      49 |     }
      50 |
      51 |     // Calculate horse age in days

      at analyzeCarePatterns (utils/carePatternAnalysis.mjs:48:13)
      at Object.<anonymous> (tests/unit/carePatternAnalysis.test.mjs:263:22)

  ‚óè Care Pattern Analysis ‚Ä∫ analyzeCarePatterns ‚Ä∫ should analyze neglect patterns

    Horse with ID 1 not found

      46 |
      47 |     if (!horse) {
    > 48 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      49 |     }
      50 |
      51 |     // Calculate horse age in days

      at analyzeCarePatterns (utils/carePatternAnalysis.mjs:48:13)
      at Object.<anonymous> (tests/unit/carePatternAnalysis.test.mjs:296:22)

  ‚óè Care Pattern Analysis ‚Ä∫ analyzeCarePatterns ‚Ä∫ should analyze environmental factors

    Horse with ID 1 not found

      46 |
      47 |     if (!horse) {
    > 48 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      49 |     }
      50 |
      51 |     // Calculate horse age in days

      at analyzeCarePatterns (utils/carePatternAnalysis.mjs:48:13)
      at Object.<anonymous> (tests/unit/carePatternAnalysis.test.mjs:338:22)

  ‚óè Care Pattern Analysis ‚Ä∫ Edge Cases ‚Ä∫ should handle horse with no interactions

    Horse with ID 1 not found

      46 |
      47 |     if (!horse) {
    > 48 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      49 |     }
      50 |
      51 |     // Calculate horse age in days

      at analyzeCarePatterns (utils/carePatternAnalysis.mjs:48:13)
      at Object.<anonymous> (tests/unit/carePatternAnalysis.test.mjs:355:22)

  ‚óè Care Pattern Analysis ‚Ä∫ Edge Cases ‚Ä∫ should handle database errors gracefully

    expect(received).rejects.toThrow(expected)

    Expected substring: "Database connection failed"
    Received message:   "Horse with ID 1 not found"

          46 |
          47 |     if (!horse) {
        > 48 |       throw new Error(`Horse with ID ${horseId} not found`);
             |             ^
          49 |     }
          50 |
          51 |     // Calculate horse age in days

          at analyzeCarePatterns (utils/carePatternAnalysis.mjs:48:13)
          at Object.<anonymous> (tests/unit/carePatternAnalysis.test.mjs:367:7)

      365 |       mockPrisma.horse.findUnique.mockRejectedValue(new Error('Database connection failed'));
      366 |
    > 367 |       await expect(analyzeCarePatterns(1)).rejects.toThrow('Database connection failed');
          |                                                    ^
      368 |     });
      369 |
      370 |     test('should handle invalid evaluation date', async () => {

      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (tests/unit/carePatternAnalysis.test.mjs:367:52)

  ‚óè Care Pattern Analysis ‚Ä∫ Edge Cases ‚Ä∫ should handle invalid evaluation date

    PrismaClientValidationError:
    Invalid `prisma.horse.findUnique()` invocation:

    {
      where: {
        id: 1
      },
      include: {
        groomInteractions: {
          where: {
            createdAt: {
              gte: new Date("Invalid Date")
                   ~~~~~~~~~~~~~~~~~~~~~~~~
            }
          },
          orderBy: {
            createdAt: "asc"
          }
        }
      }
    }

    Invalid value for argument `gte`: Provided Date object is invalid. Expected Date.

      at kn (../packages/database/node_modules/@prisma/client/runtime/library.js:29:1363)
      at e.throwValidationError (../packages/database/node_modules/@prisma/client/runtime/library.js:29:10051)
      at Ia (../packages/database/node_modules/@prisma/client/runtime/library.js:29:7488)
      at ka (../packages/database/node_modules/@prisma/client/runtime/library.js:29:8741)
      at Ia (../packages/database/node_modules/@prisma/client/runtime/library.js:29:8272)
      at ka (../packages/database/node_modules/@prisma/client/runtime/library.js:29:8741)
      at Ia (../packages/database/node_modules/@prisma/client/runtime/library.js:29:8272)
      at ka (../packages/database/node_modules/@prisma/client/runtime/library.js:29:8741)
      at Et (../packages/database/node_modules/@prisma/client/runtime/library.js:29:5845)
      at rm (../packages/database/node_modules/@prisma/client/runtime/library.js:29:6654)
      at em (../packages/database/node_modules/@prisma/client/runtime/library.js:29:6300)
      at Xd (../packages/database/node_modules/@prisma/client/runtime/library.js:29:6186)
      at Et (../packages/database/node_modules/@prisma/client/runtime/library.js:29:5863)
      at Nn (../packages/database/node_modules/@prisma/client/runtime/library.js:29:5747)
      at ../packages/database/node_modules/@prisma/client/runtime/library.js:130:10331
      at Object.runInChildSpan (../packages/database/node_modules/@prisma/client/runtime/library.js:121:1549)
      at Io.runInChildSpan (../packages/database/node_modules/@prisma/client/runtime/library.js:121:1913)
      at r._executeRequest (../packages/database/node_modules/@prisma/client/runtime/library.js:130:10310)
      at il (../packages/database/node_modules/@prisma/client/runtime/library.js:31:9835)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9784)
      at ../packages/database/node_modules/@prisma/client/runtime/library.js:130:10078
      at ../packages/database/node_modules/@prisma/client/runtime/library.js:130:10058
      at Object.runInChildSpan (../packages/database/node_modules/@prisma/client/runtime/library.js:121:1549)
      at Io.runInChildSpan (../packages/database/node_modules/@prisma/client/runtime/library.js:121:1913)
      at r._request (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9981)
      at e._createPrismaPromise.action (../packages/database/node_modules/@prisma/client/runtime/library.js:31:5390)
      at o (../packages/database/node_modules/@prisma/client/runtime/library.js:121:1018)
      at Proxy.then (../packages/database/node_modules/@prisma/client/runtime/library.js:121:1114)

 FAIL  tests/trainingModel.test.mjs
  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Model - Training Session Logging & Horse Data ‚Ä∫ logTrainingSession ‚Ä∫ should log a training session with all required fields

    Database error:
    Invalid `prisma.trainingLog.create()` invocation:


    Foreign key constraint violated on the constraint: `training_logs_horseId_fkey`

      47 |   } catch (error) {
      48 |     logger.error(`[trainingModel.logTrainingSession] Database error: ${error.message}`);
    > 49 |     throw new Error(`Database error: ${error.message}`);
         |           ^
      50 |   }
      51 | }
      52 |

      at logTrainingSession (models/trainingModel.mjs:49:11)
      at Object.<anonymous> (tests/trainingModel.test.mjs:86:22)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Model - Training Session Logging & Horse Data ‚Ä∫ logTrainingSession ‚Ä∫ should handle database errors gracefully

    expect(received).rejects.toThrow(expected)

    Expected substring: "Database error: Database connection failed"
    Received message:   "Database error:¬∑
    Invalid `prisma.trainingLog.create()` invocation:¬∑¬∑
    Foreign key constraint violated on the constraint: `training_logs_horseId_fkey`"

          47 |   } catch (error) {
          48 |     logger.error(`[trainingModel.logTrainingSession] Database error: ${error.message}`);
        > 49 |     throw new Error(`Database error: ${error.message}`);
             |           ^
          50 |   }
          51 | }
          52 |

          at logTrainingSession (models/trainingModel.mjs:49:11)
          at Object.<anonymous> (tests/trainingModel.test.mjs:123:7)

      121 |       mockTrainingLogCreate.mockRejectedValue(new Error('Database connection failed'));
      122 |
    > 123 |       await expect(logTrainingSession({ horseId: 5, discipline: 'Racing' })).rejects.toThrow(
          |                                                                                      ^
      124 |         'Database error: Database connection failed',
      125 |       );
      126 |     });

      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (tests/trainingModel.test.mjs:123:86)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Model - Training Session Logging & Horse Data ‚Ä∫ getLastTrainingDate ‚Ä∫ should return the most recent training date for horse and discipline

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"orderBy": {"trainedAt": "desc"}, "where": {"discipline": "Show Jumping", "horseId": 5}}

    Number of calls: 0

      136 |       const result = await getLastTrainingDate(5, 'Show Jumping');
      137 |
    > 138 |       expect(mockTrainingLogFindFirst).toHaveBeenCalledWith({
          |                                        ^
      139 |         where: {
      140 |           horseId: 5,
      141 |           discipline: 'Show Jumping',

      at Object.<anonymous> (tests/trainingModel.test.mjs:138:40)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Model - Training Session Logging & Horse Data ‚Ä∫ getLastTrainingDate ‚Ä∫ should handle database errors gracefully

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: null

      173 |       mockTrainingLogFindFirst.mockRejectedValue(new Error('Database connection failed'));
      174 |
    > 175 |       await expect(getLastTrainingDate(5, 'Racing')).rejects.toThrow('Database error: Database connection failed');
          |             ^
      176 |     });
      177 |   });
      178 |

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/trainingModel.test.mjs:175:13)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Model - Training Session Logging & Horse Data ‚Ä∫ getHorseAge ‚Ä∫ should return horse age from database

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"select": {"age": true}, "where": {"id": 10}}

    Number of calls: 0

      186 |       const result = await getHorseAge(10);
      187 |
    > 188 |       expect(mockHorseFindUnique).toHaveBeenCalledWith({
          |                                   ^
      189 |         where: { id: 10 },
      190 |         select: { age: true },
      191 |       });

      at Object.<anonymous> (tests/trainingModel.test.mjs:188:35)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Model - Training Session Logging & Horse Data ‚Ä∫ getHorseAge ‚Ä∫ should handle database errors gracefully

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: null

      212 |       mockHorseFindUnique.mockRejectedValue(new Error('Database connection failed'));
      213 |
    > 214 |       await expect(getHorseAge(5)).rejects.toThrow('Database error: Database connection failed');
          |             ^
      215 |     });
      216 |   });
      217 |

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/trainingModel.test.mjs:214:13)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Model - Training Session Logging & Horse Data ‚Ä∫ Integration scenarios ‚Ä∫ should handle multiple training sessions for same horse different disciplines

    Database error:
    Invalid `prisma.trainingLog.create()` invocation:


    Foreign key constraint violated on the constraint: `training_logs_horseId_fkey`

      47 |   } catch (error) {
      48 |     logger.error(`[trainingModel.logTrainingSession] Database error: ${error.message}`);
    > 49 |     throw new Error(`Database error: ${error.message}`);
         |           ^
      50 |   }
      51 | }
      52 |

      at logTrainingSession (models/trainingModel.mjs:49:11)
      at Object.<anonymous> (tests/trainingModel.test.mjs:228:7)

  ‚óè ÔøΩÔøΩÔ∏è UNIT: Training Model - Training Session Logging & Horse Data ‚Ä∫ Integration scenarios ‚Ä∫ should validate horse age before allowing training

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: null

      237 |
      238 |       const age = await getHorseAge(5);
    > 239 |       expect(age).toBe(2);
          |                   ^
      240 |
      241 |       // In the actual training logic, this would prevent training
      242 |       // since horse is under 3 years old

      at Object.<anonymous> (tests/trainingModel.test.mjs:239:19)

 FAIL  models/userModel.test.mjs
  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ createUser ‚Ä∫ should create a user successfully

    TypeError: mockPrisma.user.create.mockResolvedValue is not a function

      122 |       };
      123 |
    > 124 |       mockPrisma.user.create.mockResolvedValue(mockCreatedUser);
          |                              ^
      125 |
      126 |       const result = await createUser(baseUserData);
      127 |

      at Object.<anonymous> (models/userModel.test.mjs:124:30)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ createUser ‚Ä∫ should throw error on unique constraint violation for username

    TypeError: mockPrisma.user.create.mockRejectedValue is not a function

      154 |     it('should throw error on unique constraint violation for username', async () => {
      155 |       const dbError = { code: 'P2002', meta: { target: ['username'] } };
    > 156 |       mockPrisma.user.create.mockRejectedValue(dbError);
          |                              ^
      157 |       await expect(createUser(baseUserData)).rejects.toThrow('Duplicate value for username.');
      158 |     });
      159 |

      at Object.<anonymous> (models/userModel.test.mjs:156:30)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ createUser ‚Ä∫ should throw error on unique constraint violation for email

    TypeError: mockPrisma.user.create.mockRejectedValue is not a function

      160 |     it('should throw error on unique constraint violation for email', async () => {
      161 |       const dbError = { code: 'P2002', meta: { target: ['email'] } };
    > 162 |       mockPrisma.user.create.mockRejectedValue(dbError);
          |                              ^
      163 |       await expect(createUser(baseUserData)).rejects.toThrow('Duplicate value for email.');
      164 |     });
      165 |

      at Object.<anonymous> (models/userModel.test.mjs:162:30)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ createUser ‚Ä∫ should throw DatabaseError for other Prisma errors

    TypeError: mockPrisma.user.create.mockRejectedValue is not a function

      166 |     it('should throw DatabaseError for other Prisma errors', async () => {
      167 |       const dbError = new Error('Some other DB error');
    > 168 |       mockPrisma.user.create.mockRejectedValue(dbError);
          |                              ^
      169 |       await expect(createUser(baseUserData)).rejects.toThrow(
      170 |         new DatabaseError('Create user failed: Some other DB error'),
      171 |       );

      at Object.<anonymous> (models/userModel.test.mjs:168:30)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ getUserById ‚Ä∫ should return user if found

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      175 |     it('should return user if found', async () => {
      176 |       const mockUser = { id: 1, username: 'testuser', email: 'test@example.com' };
    > 177 |       mockPrisma.user.findUnique.mockResolvedValue(mockUser);
          |                                  ^
      178 |
      179 |       const result = await getUserById(1);
      180 |       expect(mockPrisma.user.findUnique).toHaveBeenCalledWith({ where: { id: 1 } });

      at Object.<anonymous> (models/userModel.test.mjs:177:34)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ getUserById ‚Ä∫ should return null if user not found

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      183 |
      184 |     it('should return null if user not found', async () => {
    > 185 |       mockPrisma.user.findUnique.mockResolvedValue(null);
          |                                  ^
      186 |       const user = await getUserById(99);
      187 |       expect(user).toBeNull();
      188 |     });

      at Object.<anonymous> (models/userModel.test.mjs:185:34)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ getUserByEmail ‚Ä∫ should return user by email (case insensitive)

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      197 |     it('should return user by email (case insensitive)', async () => {
      198 |       const mockUser = { id: 1, email: 'test@example.com' };
    > 199 |       mockPrisma.user.findUnique.mockResolvedValue(mockUser);
          |                                  ^
      200 |
      201 |       const user = await getUserByEmail('TEST@EXAMPLE.COM');
      202 |       expect(mockPrisma.user.findUnique).toHaveBeenCalledWith({

      at Object.<anonymous> (models/userModel.test.mjs:199:34)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ getUserWithHorses ‚Ä∫ should return user with horses if found

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      215 |     it('should return user with horses if found', async () => {
      216 |       const mockUser = { id: 1, horses: [{ id: 101, name: 'Spirit' }] };
    > 217 |       mockPrisma.user.findUnique.mockResolvedValue(mockUser);
          |                                  ^
      218 |
      219 |       const result = await getUserWithHorses(1);
      220 |       expect(mockPrisma.user.findUnique).toHaveBeenCalledWith({

      at Object.<anonymous> (models/userModel.test.mjs:217:34)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ updateUser ‚Ä∫ should update user successfully

    TypeError: mockPrisma.user.update.mockResolvedValue is not a function

      235 |     it('should update user successfully', async () => {
      236 |       const mockUpdatedUser = { id: 1, username: 'testuser', ...updateData };
    > 237 |       mockPrisma.user.update.mockResolvedValue(mockUpdatedUser);
          |                              ^
      238 |
      239 |       const result = await updateUser(1, updateData);
      240 |       expect(mockPrisma.user.update).toHaveBeenCalledWith({

      at Object.<anonymous> (models/userModel.test.mjs:237:30)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ updateUser ‚Ä∫ should handle Prisma update errors (user not found)

    TypeError: mockPrisma.user.update.mockRejectedValue is not a function

      253 |     it('should handle Prisma update errors (user not found)', async () => {
      254 |       const prismaError = { code: 'P2025', message: 'Record to update not found.' };
    > 255 |       mockPrisma.user.update.mockRejectedValue(prismaError);
          |                              ^
      256 |
      257 |       const result = await updateUser(1, updateData);
      258 |       expect(result).toBeNull(); // Returns null when user not found

      at Object.<anonymous> (models/userModel.test.mjs:255:30)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ updateUser ‚Ä∫ should handle general update errors

    TypeError: mockPrisma.user.update.mockRejectedValue is not a function

      261 |     it('should handle general update errors', async () => {
      262 |       const prismaError = { message: 'Some other update error' };
    > 263 |       mockPrisma.user.update.mockRejectedValue(prismaError);
          |                              ^
      264 |
      265 |       await expect(updateUser(1, updateData)).rejects.toThrow(
      266 |         new DatabaseError('Update failed: Some other update error'),

      at Object.<anonymous> (models/userModel.test.mjs:263:30)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ deleteUser ‚Ä∫ should delete user successfully

    TypeError: mockPrisma.user.delete.mockResolvedValue is not a function

      272 |     it('should delete user successfully', async () => {
      273 |       const deletedUser = { id: 1, username: 'testuser' };
    > 274 |       mockPrisma.user.delete.mockResolvedValue(deletedUser);
          |                              ^
      275 |
      276 |       const result = await deleteUser(1);
      277 |       expect(mockPrisma.user.delete).toHaveBeenCalledWith({ where: { id: 1 } });

      at Object.<anonymous> (models/userModel.test.mjs:274:30)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ deleteUser ‚Ä∫ should handle Prisma delete errors (user not found)

    TypeError: mockPrisma.user.delete.mockRejectedValue is not a function

      285 |     it('should handle Prisma delete errors (user not found)', async () => {
      286 |       const prismaError = { code: 'P2025', message: 'Record to delete not found.' };
    > 287 |       mockPrisma.user.delete.mockRejectedValue(prismaError);
          |                              ^
      288 |
      289 |       const result = await deleteUser(99);
      290 |       expect(result).toBeNull(); // Returns null when user not found

      at Object.<anonymous> (models/userModel.test.mjs:287:30)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ addXpToUser ‚Ä∫ should add XP without leveling up

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      296 |
      297 |     it('should add XP without leveling up', async () => {
    > 298 |       mockPrisma.user.findUnique.mockResolvedValue(baseUser);
          |                                  ^
      299 |       const updatedUser = { ...baseUser, xp: 70, level: 1 };
      300 |       mockPrisma.user.update.mockResolvedValue(updatedUser);
      301 |

      at Object.<anonymous> (models/userModel.test.mjs:298:34)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ addXpToUser ‚Ä∫ should add XP and level up

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      313 |
      314 |     it('should add XP and level up', async () => {
    > 315 |       mockPrisma.user.findUnique.mockResolvedValue(baseUser);
          |                                  ^
      316 |       const updatedUser = { ...baseUser, xp: 200, level: 2 };
      317 |       mockPrisma.user.update.mockResolvedValue(updatedUser);
      318 |

      at Object.<anonymous> (models/userModel.test.mjs:315:34)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ addXpToUser ‚Ä∫ should return error for invalid XP amount

    expect(received).toHaveBeenCalledWith(...expected)

    Matcher error: received value must be a mock or spy function

    Received has type:  function
    Received has value: [Function anonymous]

      337 |         }),
      338 |       );
    > 339 |       expect(mockLogger.error).toHaveBeenCalledWith(
          |                                ^
      340 |         expect.stringContaining('Error: XP amount must be a positive number.'),
      341 |       );
      342 |     });

      at Object.<anonymous> (models/userModel.test.mjs:339:32)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ addXpToUser ‚Ä∫ should return error for invalid user ID

    expect(received).toHaveBeenCalledWith(...expected)

    Matcher error: received value must be a mock or spy function

    Received has type:  function
    Received has value: [Function anonymous]

      350 |         }),
      351 |       );
    > 352 |       expect(mockLogger.error).toHaveBeenCalledWith(expect.stringContaining('Error: User ID is required.'));
          |                                ^
      353 |     });
      354 |
      355 |     it('should return error if user not found', async () => {

      at Object.<anonymous> (models/userModel.test.mjs:352:32)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ addXpToUser ‚Ä∫ should return error if user not found

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      354 |
      355 |     it('should return error if user not found', async () => {
    > 356 |       mockPrisma.user.findUnique.mockResolvedValue(null);
          |                                  ^
      357 |       const result = await addXpToUser(99, 20);
      358 |       expect(result).toEqual(
      359 |         expect.objectContaining({

      at Object.<anonymous> (models/userModel.test.mjs:356:34)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ getUserProgress ‚Ä∫ should return user progress

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      369 |     it('should return user progress', async () => {
      370 |       const mockUser = { id: 1, level: 1, xp: 50 };
    > 371 |       mockPrisma.user.findUnique.mockResolvedValue(mockUser);
          |                                  ^
      372 |
      373 |       const result = await getUserProgress(1);
      374 |

      at Object.<anonymous> (models/userModel.test.mjs:371:34)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ getUserProgress ‚Ä∫ should throw DatabaseError if user not found

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      389 |
      390 |     it('should throw DatabaseError if user not found', async () => {
    > 391 |       mockPrisma.user.findUnique.mockResolvedValue(null);
          |                                  ^
      392 |       await expect(getUserProgress(99)).rejects.toThrow(new DatabaseError('Progress fetch failed: User not found.'));
      393 |     });
      394 |   });

      at Object.<anonymous> (models/userModel.test.mjs:391:34)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ getUserStats ‚Ä∫ should return user stats with horses

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      409 |       };
      410 |
    > 411 |       mockPrisma.user.findUnique.mockResolvedValue(mockUser);
          |                                  ^
      412 |
      413 |       const result = await getUserStats(1);
      414 |

      at Object.<anonymous> (models/userModel.test.mjs:411:34)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ getUserStats ‚Ä∫ should handle user with no horses

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      442 |       };
      443 |
    > 444 |       mockPrisma.user.findUnique.mockResolvedValue(mockUser);
          |                                  ^
      445 |
      446 |       const result = await getUserStats(2);
      447 |

      at Object.<anonymous> (models/userModel.test.mjs:444:34)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ getUserStats ‚Ä∫ should handle user with null horses array

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      468 |       };
      469 |
    > 470 |       mockPrisma.user.findUnique.mockResolvedValue(mockUser);
          |                                  ^
      471 |
      472 |       const result = await getUserStats(3);
      473 |       expect(result).toEqual(

      at Object.<anonymous> (models/userModel.test.mjs:470:34)

  ‚óè ÔøΩÔøΩ UNIT: User Model - Database Operations & Business Logic ‚Ä∫ getUserStats ‚Ä∫ should return null for non-existent user

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      480 |
      481 |     it('should return null for non-existent user', async () => {
    > 482 |       mockPrisma.user.findUnique.mockResolvedValue(null);
          |                                  ^
      483 |
      484 |       const result = await getUserStats(999);
      485 |       expect(result).toBeNull();

      at Object.<anonymous> (models/userModel.test.mjs:482:34)

 FAIL  tests/trainingCooldown.test.mjs
  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ canTrain ‚Ä∫ should return true for horse with no cooldown

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ canTrain ‚Ä∫ should return true for horse with cooldown in the past

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ canTrain ‚Ä∫ should return false for horse with cooldown in the future

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ canTrain ‚Ä∫ should throw error for null horse

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ canTrain ‚Ä∫ should throw error for undefined horse

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ getCooldownTimeRemaining ‚Ä∫ should return null forhorse with no cooldown

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ getCooldownTimeRemaining ‚Ä∫ should return null forhorse with cooldown in the past

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ getCooldownTimeRemaining ‚Ä∫ should return positivemilliseconds for horse with cooldown in the future

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ getCooldownTimeRemaining ‚Ä∫ should return approximately correct time remaining

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ getCooldownTimeRemaining ‚Ä∫ should throw error fornull horse

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ getCooldownTimeRemaining ‚Ä∫ should throw error forundefined horse

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ setCooldown ‚Ä∫ should set cooldown 7 days in the future

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ setCooldown ‚Ä∫ should return updated horse with relations

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ setCooldown ‚Ä∫ should throw error for non-existenthorse ID

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ setCooldown ‚Ä∫ should throw error for null horse ID

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ setCooldown ‚Ä∫ should throw error for undefined horse ID

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ setCooldown ‚Ä∫ should throw error for invalid horse ID (string)

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ setCooldown ‚Ä∫ should throw error for invalid horse ID (negative)

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ setCooldown ‚Ä∫ should throw error for invalid horse ID (zero)

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ setCooldown ‚Ä∫ should handle string horse ID that can be parsed to integer

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ formatCooldown ‚Ä∫ should return "Ready to train" for null input

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ formatCooldown ‚Ä∫ should return "Ready to train" for zero milliseconds

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ formatCooldown ‚Ä∫ should return "Ready to train" for negative milliseconds

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ formatCooldown ‚Ä∫ should format minutes correctly

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ formatCooldown ‚Ä∫ should format hours and minutes correctly

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ formatCooldown ‚Ä∫ should format days and hours correctly

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ formatCooldown ‚Ä∫ should format exactly 7 days correctly

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ Integration Tests ‚Ä∫ should complete full trainingcooldown workflow

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ‚óè ‚è∞ UNIT: Training Cooldown System - Horse Training Restrictions ‚Ä∫ Integration Tests ‚Ä∫ should work with horse retrieved from database

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

 FAIL  tests/groomInteractionLimits.test.mjs
  ‚óè ÔøΩÔøΩ TDD: Groom Interaction Daily Limits - ALL Horses ‚Ä∫ Adult Horse Daily Limits (FAILING TESTS - Current Implementation Bug) ‚Ä∫ should FAIL: 1-year-old horse should be limited to once per day

    Horse with ID 1 not found

      423 |
      424 |     if (!horse) {
    > 425 |       throw new Error(`Horse with ID ${foalId} not found`);
          |             ^
      426 |     }
      427 |
      428 |     // ALL horses (regardless of age) are limited to 1 interaction per day

      at validateFoalInteractionLimits (utils/groomSystem.mjs:425:13)
      at Object.<anonymous> (tests/groomInteractionLimits.test.mjs:77:22)

  ‚óè ÔøΩÔøΩ TDD: Groom Interaction Daily Limits - ALL Horses ‚Ä∫ Adult Horse Daily Limits (FAILING TESTS - Current Implementation Bug) ‚Ä∫ should FAIL: 2-year-old horse should be limited to once per day

    Horse with ID 2 not found

      423 |
      424 |     if (!horse) {
    > 425 |       throw new Error(`Horse with ID ${foalId} not found`);
          |             ^
      426 |     }
      427 |
      428 |     // ALL horses (regardless of age) are limited to 1 interaction per day

      at validateFoalInteractionLimits (utils/groomSystem.mjs:425:13)
      at Object.<anonymous> (tests/groomInteractionLimits.test.mjs:105:22)

  ‚óè ÔøΩÔøΩ TDD: Groom Interaction Daily Limits - ALL Horses ‚Ä∫ Foal Daily Limits (Should PASS with current implementation) ‚Ä∫should correctly limit 3-day-old foal to once per day

    Horse with ID 3 not found

      423 |
      424 |     if (!horse) {
    > 425 |       throw new Error(`Horse with ID ${foalId} not found`);
          |             ^
      426 |     }
      427 |
      428 |     // ALL horses (regardless of age) are limited to 1 interaction per day

      at validateFoalInteractionLimits (utils/groomSystem.mjs:425:13)
      at Object.<anonymous> (tests/groomInteractionLimits.test.mjs:134:22)

  ‚óè ÔøΩÔøΩ TDD: Groom Interaction Daily Limits - ALL Horses ‚Ä∫ Edge Cases ‚Ä∫ should allow interaction when no previous interactions today

    Horse with ID 4 not found

      423 |
      424 |     if (!horse) {
    > 425 |       throw new Error(`Horse with ID ${foalId} not found`);
          |             ^
      426 |     }
      427 |
      428 |     // ALL horses (regardless of age) are limited to 1 interaction per day

      at validateFoalInteractionLimits (utils/groomSystem.mjs:425:13)
      at Object.<anonymous> (tests/groomInteractionLimits.test.mjs:164:22)

 FAIL  __tests__/unit/security/ownership-checks.test.mjs
  ‚óè Ownership Validation Unit Tests ‚Ä∫ Owned Resource Scenarios ‚Ä∫ should allow access to owned horse

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

  ‚óè Ownership Validation Unit Tests ‚Ä∫ Owned Resource Scenarios ‚Ä∫ should allow access to owned groom

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

  ‚óè Ownership Validation Unit Tests ‚Ä∫ Owned Resource Scenarios ‚Ä∫ should attach resource to request object and validatedResources

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

  ‚óè Ownership Validation Unit Tests ‚Ä∫ Owned Resource Scenarios ‚Ä∫ should work with custom idParam

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

  ‚óè Ownership Validation Unit Tests ‚Ä∫ Not Owned Resource Scenarios ‚Ä∫ should return 404 for horse owned by different user

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

  ‚óè Ownership Validation Unit Tests ‚Ä∫ Not Owned Resource Scenarios ‚Ä∫ should return 404 for groom owned by different user

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

  ‚óè Ownership Validation Unit Tests ‚Ä∫ Resource Type Validation ‚Ä∫ should handle training-session resource type (maps to trainingLog)

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

  ‚óè Ownership Validation Unit Tests ‚Ä∫ Resource Type Validation ‚Ä∫ should handle competition-entry resource type (maps tocompetitionResult)

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

  ‚óè Ownership Validation Unit Tests ‚Ä∫ findOwnedResource Helper Function ‚Ä∫ should find owned horse using ownerId

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

  ‚óè Ownership Validation Unit Tests ‚Ä∫ findOwnedResource Helper Function ‚Ä∫ should find owned groom using userId

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

  ‚óè Ownership Validation Unit Tests ‚Ä∫ validateBatchOwnership Helper Function ‚Ä∫ should validate ownership of multiple horses using ownerId

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

 FAIL  tests/traitEvaluation.test.mjs
  ‚óè ÔøΩÔøΩ UNIT: Trait Evaluation System - Trait Revelation & Validation ‚Ä∫ evaluateTraitRevelation ‚Ä∫ should use developmentage for young foals

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[traitEvaluation.evaluateTraitRevelation] Evaluating traits for foal 1 on day 5"

    Number of calls: 0

      210 |
      211 |       // Should use development day (5) instead of age (0) for trait evaluation
    > 212 |       expect(mockLogger.info).toHaveBeenCalledWith('[traitEvaluation.evaluateTraitRevelation] Evaluating traits for foal 1 on day 5');
          |                               ^
      213 |     });
      214 |
      215 |     it('should not reveal traits when random chance is too high', async () => {

      at Object.<anonymous> (tests/traitEvaluation.test.mjs:212:31)

  ‚óè ÔøΩÔøΩ UNIT: Trait Evaluation System - Trait Revelation & Validation ‚Ä∫ Error Handling ‚Ä∫ should handle errors gracefully

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      357 |       }).toThrow();
      358 |
    > 359 |       expect(mockLogger.error).toHaveBeenCalled();
          |                                ^
      360 |     });
      361 |
      362 |     it('should handle missing foal properties', () => {

      at Object.<anonymous> (tests/traitEvaluation.test.mjs:359:32)

 FAIL  __tests__/integration/security/rate-limit-enforcement.test.mjs
  ‚óè Test suite failed to run

    SyntaxError: Invalid regular expression: missing /

      at Runtime.loadEsmModule (node_modules/jest-runtime/build/index.js:516:20)


Test Suites: 42 failed, 1 skipped, 166 passed, 208 of 209 total
Tests:       377 failed, 18 skipped, 2970 passed, 3365 total
Snapshots:   0 total
Time:        253.241 s
Ran all test suites.
üßπ Running global teardown...
[Teardown] Disconnecting Prisma instances...
[Teardown] ‚úÖ Prisma instances disconnected
‚úÖ Global teardown completed successfully

Jest has detected the following 1 open handle potentially keeping Jest from exiting:

  ‚óè  TCPSERVERWRAP

      152 |     it('should perform a basic enhanced interaction', async () => {
      153 |       const response = await request(app)
    > 154 |         .post('/api/grooms/enhanced/interact')
          |          ^
      155 |         .set('Authorization', `Bearer ${authToken}`)
      156 |         .set('x-test-skip-csrf', 'true')
      157 |         .send(interactionData);

      at Test.serverAddress (node_modules/supertest/lib/test.js:63:35)
      at new Test (node_modules/supertest/lib/test.js:49:14)
      at Object.obj.<computed> [as post] (node_modules/supertest/index.js:39:18)
      at Object.<anonymous> (tests/integration/enhancedGroomInteractions.test.mjs:154:10)

PS C:\Users\heirr\OneDrive\Desktop\Equoria\backend>
