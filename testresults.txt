      49 |         password: 'TestPass123!',

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:46:8)

  ● CSRF Protection Integration Tests › Public Endpoints (No CSRF) › should not require CSRF token for password reset request

    TypeError: mime.getType is not a function

      44 |       .post('/auth/register')
      45 |       .set(rateLimitBypassHeader)
    > 46 |       .send({
         |        ^
      47 |         username: `csrftest${Date.now()}`,
      48 |         email: `csrftest${Date.now()}@test.com`,
      49 |         password: 'TestPass123!',

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:46:8)

 FAIL  backend/tests/groomBonusTraits.test.mjs
  ● Groom Bonus Traits System › Groom Bonus Trait Management › should assign bonus traits to a groom

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      53 |
      54 |     // Create test groom with bonus traits
    > 55 |     testGroom = await prisma.groom.create({
         |                 ^
      56 |       data: {
      57 |         name: `TestGroom_${Date.now()}`,
      58 |         speciality: 'foal_care',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/groomBonusTraits.test.mjs:55:17)

  ● Groom Bonus Traits System › Groom Bonus Trait Management › should assign bonus traits to a groom

    PrismaClientKnownRequestError:
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

      105 |     }
      106 |     if (testUser) {
    > 107 |       await prisma.user.delete({ where: { id: testUser.id } });
          |       ^
      108 |     }
      109 |     if (testBreed) {
      110 |       await prisma.breed.delete({ where: { id: testBreed.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/groomBonusTraits.test.mjs:107:7)

  ● Groom Bonus Traits System › Groom Bonus Trait Management › should validate bonus trait constraints

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

      102 |     }
      103 |     if (testGroom) {
    > 104 |       await prisma.groom.delete({ where: { id: testGroom.id } });
          |       ^
      105 |     }
      106 |     if (testUser) {
      107 |       await prisma.user.delete({ where: { id: testUser.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/groomBonusTraits.test.mjs:104:7)

  ● Groom Bonus Traits System › Groom Bonus Trait Management › should get groom bonus traits

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

       99 |     // Clean up test data
      100 |     if (testHorse) {
    > 101 |       await prisma.horse.delete({ where: { id: testHorse.id } });
          |       ^
      102 |     }
      103 |     if (testGroom) {
      104 |       await prisma.groom.delete({ where: { id: testGroom.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/groomBonusTraits.test.mjs:101:7)

  ● Groom Bonus Traits System › Trait Assignment Logic Integration › should not apply bonus when coverage is insufficient

    expect(received).toBe(expected) // Object.is equality

    Expected: "Insufficient assignment coverage"
    Received: "Bond score too low"

      302 |       expect(result.finalProbability).toBe(0.1); // No bonus applied
      303 |       expect(result.bonusApplied).toBe(false);
    > 304 |       expect(result.reason).toBe('Insufficient assignment coverage');
          |                             ^
      305 |     });
      306 |   });
      307 |

      at Object.<anonymous> (tests/groomBonusTraits.test.mjs:304:29)

  ● Groom Bonus Traits System › Trait Assignment Logic Integration › should not apply bonus when coverage is insufficient

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

       99 |     // Clean up test data
      100 |     if (testHorse) {
    > 101 |       await prisma.horse.delete({ where: { id: testHorse.id } });
          |       ^
      102 |     }
      103 |     if (testGroom) {
      104 |       await prisma.groom.delete({ where: { id: testGroom.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/groomBonusTraits.test.mjs:101:7)

  ● Groom Bonus Traits System › API Endpoints › should get groom bonus traits via API

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

       99 |     // Clean up test data
      100 |     if (testHorse) {
    > 101 |       await prisma.horse.delete({ where: { id: testHorse.id } });
          |       ^
      102 |     }
      103 |     if (testGroom) {
      104 |       await prisma.groom.delete({ where: { id: testGroom.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/groomBonusTraits.test.mjs:101:7)

  ● Groom Bonus Traits System › API Endpoints › should update groom bonus traits via API

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      53 |
      54 |     // Create test groom with bonus traits
    > 55 |     testGroom = await prisma.groom.create({
         |                 ^
      56 |       data: {
      57 |         name: `TestGroom_${Date.now()}`,
      58 |         speciality: 'foal_care',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/groomBonusTraits.test.mjs:55:17)

  ● Groom Bonus Traits System › API Endpoints › should update groom bonus traits via API

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

       99 |     // Clean up test data
      100 |     if (testHorse) {
    > 101 |       await prisma.horse.delete({ where: { id: testHorse.id } });
          |       ^
      102 |     }
      103 |     if (testGroom) {
      104 |       await prisma.groom.delete({ where: { id: testGroom.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/groomBonusTraits.test.mjs:101:7)

  ● Groom Bonus Traits System › API Endpoints › should reject invalid bonus trait updates

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      53 |
      54 |     // Create test groom with bonus traits
    > 55 |     testGroom = await prisma.groom.create({
         |                 ^
      56 |       data: {
      57 |         name: `TestGroom_${Date.now()}`,
      58 |         speciality: 'foal_care',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/groomBonusTraits.test.mjs:55:17)

  ● Groom Bonus Traits System › API Endpoints › should reject invalid bonus trait updates

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

       99 |     // Clean up test data
      100 |     if (testHorse) {
    > 101 |       await prisma.horse.delete({ where: { id: testHorse.id } });
          |       ^
      102 |     }
      103 |     if (testGroom) {
      104 |       await prisma.groom.delete({ where: { id: testGroom.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/groomBonusTraits.test.mjs:101:7)

  ● Groom Bonus Traits System › API Endpoints › should require authentication for bonus trait endpoints

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

       99 |     // Clean up test data
      100 |     if (testHorse) {
    > 101 |       await prisma.horse.delete({ where: { id: testHorse.id } });
          |       ^
      102 |     }
      103 |     if (testGroom) {
      104 |       await prisma.groom.delete({ where: { id: testGroom.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/groomBonusTraits.test.mjs:101:7)

 FAIL  backend/__tests__/integration/cookieIntegration.test.mjs
  ● Cookie Integration Tests › Registration Endpoint Cookies › should set accessToken cookie with correct attributes

    TypeError: mime.getType is not a function

      65 |         .post('/auth/register')
      66 |         .set(rateLimitBypassHeader)
    > 67 |         .send({
         |          ^
      68 |         username: 'cookietestuser1',
      69 |         email: 'cookietest1@test.com',
      70 |         password: 'TestPass123!',

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/integration/cookieIntegration.test.mjs:67:10)

  ● Cookie Integration Tests › Registration Endpoint Cookies › should set refreshToken cookie with correct attributes

    TypeError: mime.getType is not a function

       97 |
       98 |     test('should set refreshToken cookie with correct attributes', async () => {
    >  99 |       const response = await request(app).post('/auth/register').send({
          |                                                                  ^
      100 |         username: 'cookietestuser2',
      101 |         email: 'cookietest2@test.com',
      102 |         password: 'TestPass123!',

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/integration/cookieIntegration.test.mjs:99:66)

  ● Cookie Integration Tests › Registration Endpoint Cookies › should set both cookies in a single response

    TypeError: mime.getType is not a function

      127 |
      128 |     test('should set both cookies in a single response', async () => {
    > 129 |       const response = await request(app).post('/auth/register').send({
          |                                                                  ^
      130 |         username: 'cookietestuser3',
      131 |         email: 'cookietest3@test.com',
      132 |         password: 'TestPass123!',

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/integration/cookieIntegration.test.mjs:129:66)

  ● Cookie Integration Tests › Login Endpoint Cookies › should set cookies on successful login

    TypeError: mime.getType is not a function

      153 |         .post('/auth/register')
      154 |         .set(rateLimitBypassHeader)
    > 155 |         .send({
          |          ^
      156 |         username: 'logincookietest',
      157 |         email: 'logincookietest@test.com',
      158 |         password: 'TestPass123!',

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/integration/cookieIntegration.test.mjs:155:10)

  ● Cookie Integration Tests › Login Endpoint Cookies › should set accessToken cookie with correct attributes on login

    TypeError: mime.getType is not a function

      153 |         .post('/auth/register')
      154 |         .set(rateLimitBypassHeader)
    > 155 |         .send({
          |          ^
      156 |         username: 'logincookietest',
      157 |         email: 'logincookietest@test.com',
      158 |         password: 'TestPass123!',

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/integration/cookieIntegration.test.mjs:155:10)

  ● Cookie Integration Tests › Login Endpoint Cookies › should set refreshToken cookie with correct attributes on login

    TypeError: mime.getType is not a function

      153 |         .post('/auth/register')
      154 |         .set(rateLimitBypassHeader)
    > 155 |         .send({
          |          ^
      156 |         username: 'logincookietest',
      157 |         email: 'logincookietest@test.com',
      158 |         password: 'TestPass123!',

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/integration/cookieIntegration.test.mjs:155:10)

  ● Cookie Integration Tests › Token Refresh Endpoint Cookies › should set new cookies on token refresh

    TypeError: mime.getType is not a function

      229 |         .post('/auth/register')
      230 |         .set(rateLimitBypassHeader)
    > 231 |         .send({
          |          ^
      232 |         username: 'refreshcookietest',
      233 |         email: 'refreshcookietest@test.com',
      234 |         password: 'TestPass123!',

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/integration/cookieIntegration.test.mjs:231:10)

  ● Cookie Integration Tests › Token Refresh Endpoint Cookies › should set new accessToken cookie with correct attributes

    TypeError: mime.getType is not a function

      229 |         .post('/auth/register')
      230 |         .set(rateLimitBypassHeader)
    > 231 |         .send({
          |          ^
      232 |         username: 'refreshcookietest',
      233 |         email: 'refreshcookietest@test.com',
      234 |         password: 'TestPass123!',

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/integration/cookieIntegration.test.mjs:231:10)

  ● Cookie Integration Tests › Token Refresh Endpoint Cookies › should set new refreshToken cookie with correct attributes

    TypeError: mime.getType is not a function

      229 |         .post('/auth/register')
      230 |         .set(rateLimitBypassHeader)
    > 231 |         .send({
          |          ^
      232 |         username: 'refreshcookietest',
      233 |         email: 'refreshcookietest@test.com',
      234 |         password: 'TestPass123!',

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/integration/cookieIntegration.test.mjs:231:10)

  ● Cookie Integration Tests › Logout Endpoint Cookie Clearing › should clear accessToken cookie on logout

    TypeError: mime.getType is not a function

      316 |         .post('/auth/register')
      317 |         .set(rateLimitBypassHeader)
    > 318 |         .send({
          |          ^
      319 |         username: 'logoutcookietest',
      320 |         email: 'logoutcookietest@test.com',
      321 |         password: 'TestPass123!',

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/integration/cookieIntegration.test.mjs:318:10)

  ● Cookie Integration Tests › Logout Endpoint Cookie Clearing › should clear refreshToken cookie on logout

    TypeError: mime.getType is not a function

      316 |         .post('/auth/register')
      317 |         .set(rateLimitBypassHeader)
    > 318 |         .send({
          |          ^
      319 |         username: 'logoutcookietest',
      320 |         email: 'logoutcookietest@test.com',
      321 |         password: 'TestPass123!',

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/integration/cookieIntegration.test.mjs:318:10)

  ● Cookie Integration Tests › Logout Endpoint Cookie Clearing › should maintain same path when clearing cookies

    TypeError: mime.getType is not a function

      316 |         .post('/auth/register')
      317 |         .set(rateLimitBypassHeader)
    > 318 |         .send({
          |          ^
      319 |         username: 'logoutcookietest',
      320 |         email: 'logoutcookietest@test.com',
      321 |         password: 'TestPass123!',

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/integration/cookieIntegration.test.mjs:318:10)

  ● Cookie Integration Tests › Cookie Security Attributes › should use consistent security attributes across all endpoints

    TypeError: mime.getType is not a function

      409 |         .post('/auth/register')
      410 |         .set(rateLimitBypassHeader)
    > 411 |         .send({
          |          ^
      412 |         username: 'securitytest1',
      413 |         email: 'securitytest1@test.com',
      414 |         password: 'TestPass123!',

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/integration/cookieIntegration.test.mjs:411:10)

 FAIL  backend/tests/traitMilestoneIntegration.test.mjs
  ● Trait Milestone Integration › Age 1 Milestone Evaluation › should handle edge case of no task history

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No 'User' record (needed to inline the relation on 'Horse' record(s)) was found for a nested connect on one-to-many relation 'HorseToUser'.

      76 |
      77 |     // Create test foal approaching age 1
    > 78 |     testFoal = await prisma.horse.create({
         |                ^
      79 |       data: {
      80 |         name: 'Test Foal Milestone',
      81 |         sex: 'Colt',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/traitMilestoneIntegration.test.mjs:78:16)

  ● Trait Milestone Integration › Milestone Timing and Business Rules › should demonstrate age 1 milestone evaluation timing

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No 'User' record (needed to inline the relation on 'Horse' record(s)) was found for a nested connect on one-to-many relation 'HorseToUser'.

      76 |
      77 |     // Create test foal approaching age 1
    > 78 |     testFoal = await prisma.horse.create({
         |                ^
      79 |       data: {
      80 |         name: 'Test Foal Milestone',
      81 |         sex: 'Colt',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/traitMilestoneIntegration.test.mjs:78:16)

  ● Trait Milestone Integration › Milestone Timing and Business Rules › should support trait development progression tracking

    TypeError: Cannot read properties of null (reading 'age')

      356 |
      357 |         // Only evaluate at age 1 milestone
    > 358 |         if (foal.age >= 365) {
          |                  ^
      359 |           jest.spyOn(Math, 'random').mockReturnValue(0.2);
      360 |
      361 |           const assignedTraits = evaluateEpigeneticTagsFromFoalTasks(foal.taskLog, 0);

      at Object.<anonymous> (tests/traitMilestoneIntegration.test.mjs:358:18)

 FAIL  backend/tests/training-complete.test.mjs
  ● ��️ INTEGRATION: Training System Complete - End-to-End Workflow › Authentication and Setup › should have created test user and horses

    TypeError: mime.getType is not a function

      163 |     };
      164 |
    > 165 |     const registerResponse = await request(app).post('/api/auth/register').send(userData);
          |                                                                            ^
      166 |
      167 |     expect(registerResponse.status).toBe(201);
      168 |     authToken = registerResponse.body.data.token;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/training-complete.test.mjs:165:76)

  ● ��️ INTEGRATION: Training System Complete - End-to-End Workflow › Trainable Horses › should get trainable horses for authenticated user

    TypeError: mime.getType is not a function

      163 |     };
      164 |
    > 165 |     const registerResponse = await request(app).post('/api/auth/register').send(userData);
          |                                                                            ^
      166 |
      167 |     expect(registerResponse.status).toBe(201);
      168 |     authToken = registerResponse.body.data.token;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/training-complete.test.mjs:165:76)

  ● ��️ INTEGRATION: Training System Complete - End-to-End Workflow › Training Functionality › should successfully train an adult horse

    TypeError: mime.getType is not a function

      163 |     };
      164 |
    > 165 |     const registerResponse = await request(app).post('/api/auth/register').send(userData);
          |                                                                            ^
      166 |
      167 |     expect(registerResponse.status).toBe(201);
      168 |     authToken = registerResponse.body.data.token;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/training-complete.test.mjs:165:76)

  ● ��️ INTEGRATION: Training System Complete - End-to-End Workflow › Training Functionality › should reject training for young horse

    TypeError: mime.getType is not a function

      163 |     };
      164 |
    > 165 |     const registerResponse = await request(app).post('/api/auth/register').send(userData);
          |                                                                            ^
      166 |
      167 |     expect(registerResponse.status).toBe(201);
      168 |     authToken = registerResponse.body.data.token;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/training-complete.test.mjs:165:76)

  ● ��️ INTEGRATION: Training System Complete - End-to-End Workflow › Authentication Protection › should reject unauthenticated requests

    TypeError: mime.getType is not a function

      163 |     };
      164 |
    > 165 |     const registerResponse = await request(app).post('/api/auth/register').send(userData);
          |                                                                            ^
      166 |
      167 |     expect(registerResponse.status).toBe(201);
      168 |     authToken = registerResponse.body.data.token;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/training-complete.test.mjs:165:76)

 FAIL  backend/tests/foalTaskLoggingIntegration.test.mjs
  ● Foal Task Logging Integration › Task Log JSON Updates › should initialize task log with first enrichment task

    TypeError: mime.getType is not a function

      121 |   describe('Task Log JSON Updates', () => {
      122 |     it('should initialize task log with first enrichment task', async () => {
    > 123 |       const response = await request(app).post('/api/grooms/interact').send({
          |                                                                        ^
      124 |         foalId: testFoal.id,
      125 |         groomId: testGroom.id,
      126 |         assignmentId: testAssignment.id,

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/foalTaskLoggingIntegration.test.mjs:123:72)

  ● Foal Task Logging Integration › Task Log JSON Updates › should increment existing task count in task log

    TypeError: mime.getType is not a function

      158 |       });
      159 |
    > 160 |       const response = await request(app).post('/api/grooms/interact').send({
          |                                                                        ^
      161 |         foalId: testFoal.id,
      162 |         groomId: testGroom.id,
      163 |         assignmentId: testAssignment.id,

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/foalTaskLoggingIntegration.test.mjs:160:72)

  ● Foal Task Logging Integration › Task Log JSON Updates › should add new task to existing task log

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      81 |     foalBirthDate.setFullYear(foalBirthDate.getFullYear() - 1); // 1 year ago
      82 |
    > 83 |     testFoal = await prisma.horse.create({
         |                ^
      84 |       data: {
      85 |         name: `Test Foal ${testCounter}`,
      86 |         sex: 'Colt',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/foalTaskLoggingIntegration.test.mjs:83:16)

  ● Foal Task Logging Integration › Task Log JSON Updates › should handle multiple task types across different foals

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      65 |
      66 |     // Create test groom with unique name
    > 67 |     testGroom = await prisma.groom.create({
         |                 ^
      68 |       data: {
      69 |         name: `Task Logging Groom ${testCounter}`,
      70 |         speciality: 'foal_care',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/foalTaskLoggingIntegration.test.mjs:67:17)

  ● Foal Task Logging Integration › Streak Tracking Integration › should update lastGroomed timestamp on each interaction

    TypeError: mime.getType is not a function

      291 |       const beforeTime = new Date();
      292 |
    > 293 |       const response = await request(app).post('/api/grooms/interact').send({
          |                                                                        ^
      294 |         foalId: testFoal.id,
      295 |         groomId: testGroom.id,
      296 |         assignmentId: testAssignment.id,

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/foalTaskLoggingIntegration.test.mjs:293:72)

  ● Foal Task Logging Integration › Streak Tracking Integration › should enforce daily interaction limits correctly

    TypeError: mime.getType is not a function

      314 |     it('should enforce daily interaction limits correctly', async () => {
      315 |       // First interaction should succeed
    > 316 |       const response1 = await request(app).post('/api/grooms/interact').send({
          |                                                                         ^
      317 |         foalId: testFoal.id,
      318 |         groomId: testGroom.id,
      319 |         assignmentId: testAssignment.id,

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/foalTaskLoggingIntegration.test.mjs:316:73)

  ● Foal Task Logging Integration › Age-Based Task Eligibility Enforcement › should reject enrichment tasks for horses too old

    TypeError: mime.getType is not a function

      357 |       });
      358 |
    > 359 |       const response = await request(app).post('/api/grooms/interact').send({
          |                                                                        ^
      360 |         foalId: testFoal.id,
      361 |         groomId: testGroom.id,
      362 |         assignmentId: testAssignment.id,

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/foalTaskLoggingIntegration.test.mjs:359:72)

  ● Foal Task Logging Integration › Age-Based Task Eligibility Enforcement › should reject grooming tasks for horses too young

    TypeError: mime.getType is not a function

      384 |       });
      385 |
    > 386 |       const response = await request(app).post('/api/grooms/interact').send({
          |                                                                        ^
      387 |         foalId: testFoal.id,
      388 |         groomId: testGroom.id,
      389 |         assignmentId: testAssignment.id,

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/foalTaskLoggingIntegration.test.mjs:386:72)

 FAIL  backend/tests/integration/traitRoutes.test.mjs
  ● Trait Routes Integration Tests › POST /api/trait-discovery/discover/:horseId › should trigger trait discovery successfully

    TypeError: mime.getType is not a function

      104 |       const response = await request(app)
      105 |         .post(`/api/trait-discovery/discover/${testHorse.id}`)
    > 106 |         .send({
          |          ^
      107 |           checkEnrichment: true,
      108 |           forceCheck: false,
      109 |         })

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/traitRoutes.test.mjs:106:10)

  ● Trait Routes Integration Tests › POST /api/trait-discovery/discover/:horseId › should return validation error for invalid horse ID

    TypeError: mime.getType is not a function

      169 |
      170 |     it('should return validation error for invalid horse ID', async () => {
    > 171 |       const response = await request(app).post('/api/trait-discovery/discover/invalid').send({}).expect(400);
          |                                                                                         ^
      172 |
      173 |       expect(response.body.success).toBe(false);
      174 |       expect(response.body.message).toBe('Horse ID must be a positive integer');

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/traitRoutes.test.mjs:171:89)

  ● Trait Routes Integration Tests › POST /api/trait-discovery/discover/:horseId › should return 404 for non-existent horse

    TypeError: mime.getType is not a function

      179 |       const response = await request(app)
      180 |         .post('/api/trait-discovery/discover/99999')
    > 181 |         .send({
          |          ^
      182 |           checkEnrichment: true,
      183 |           forceCheck: false,
      184 |         })

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/traitRoutes.test.mjs:181:10)

  ● Trait Routes Integration Tests › POST /api/trait-discovery/discover/:horseId › should handle optional parameters correctly

    TypeError: mime.getType is not a function

      192 |       const response = await request(app)
      193 |         .post(`/api/trait-discovery/discover/${testHorse.id}`)
    > 194 |         .send({
          |          ^
      195 |           checkEnrichment: false,
      196 |           forceCheck: true,
      197 |         })

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/traitRoutes.test.mjs:194:10)

  ● Trait Routes Integration Tests › POST /api/trait-discovery/batch-discover › should process batch discovery successfully

    TypeError: mime.getType is not a function

      336 |       const response = await request(app)
      337 |         .post('/api/trait-discovery/batch-discover')
    > 338 |         .send({
          |          ^
      339 |           horseIds: [testHorse.id],
      340 |           checkEnrichment: true,
      341 |         })

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/traitRoutes.test.mjs:338:10)

  ● Trait Routes Integration Tests › POST /api/trait-discovery/batch-discover › should return validation error for empty horse IDs array

    TypeError: mime.getType is not a function

      358 |       const response = await request(app)
      359 |         .post('/api/trait-discovery/batch-discover')
    > 360 |         .send({
          |          ^
      361 |           horseIds: [],
      362 |         })
      363 |         .expect(400);

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/traitRoutes.test.mjs:360:10)

  ● Trait Routes Integration Tests › POST /api/trait-discovery/batch-discover › should return validation error for too many horse IDs

    TypeError: mime.getType is not a function

      372 |       const response = await request(app)
      373 |         .post('/api/trait-discovery/batch-discover')
    > 374 |         .send({
          |          ^
      375 |           horseIds: tooManyIds,
      376 |         })
      377 |         .expect(400);

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/traitRoutes.test.mjs:374:10)

  ● Trait Routes Integration Tests › POST /api/trait-discovery/batch-discover › should return validation error for invalid horse IDs

    TypeError: mime.getType is not a function

      384 |       const response = await request(app)
      385 |         .post('/api/trait-discovery/batch-discover')
    > 386 |         .send({
          |          ^
      387 |           horseIds: ['invalid', 'ids'],
      388 |         })
      389 |         .expect(400);

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/traitRoutes.test.mjs:386:10)

  ● Trait Routes Integration Tests › POST /api/trait-discovery/batch-discover › should handle mix of valid and invalid horse IDs

    TypeError: mime.getType is not a function

      396 |       const response = await request(app)
      397 |         .post('/api/trait-discovery/batch-discover')
    > 398 |         .send({
          |          ^
      399 |           horseIds: [testHorse.id, 99999], // One valid, one invalid
      400 |         })
      401 |         .expect(200);

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/traitRoutes.test.mjs:398:10)

 FAIL  backend/tests/integration/horseBreedingWorkflow.integration.test.mjs
  ● �� INTEGRATION: Complete Horse Breeding Workflow › �� STEP 1: User Registration & Authentication › should register user and obtain authentication token

    TypeError: mime.getType is not a function

      112 |         .post('/api/auth/register')
      113 |         .set('x-test-skip-csrf', 'true')
    > 114 |         .send(userData)
          |          ^
      115 |         .expect(201);
      116 |
      117 |       expect(response.body.status).toBe('success');

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/horseBreedingWorkflow.integration.test.mjs:114:10)

  ● �� INTEGRATION: Complete Horse Breeding Workflow › �� STEP 2: Horse Creation (Breeding Stock) › should create mare with quality traits

    TypeError: Cannot read properties of undefined (reading 'id')

      158 |           sex: 'Mare',
      159 |           healthStatus: 'Excellent',
    > 160 |           ownerId: testUser.id,
          |                             ^
      161 |           userId: testUser.id,
      162 |           dateOfBirth: new Date('2019-01-01'),
      163 |           disciplineScores: {

      at Object.<anonymous> (tests/integration/horseBreedingWorkflow.integration.test.mjs:160:29)

  ● �� INTEGRATION: Complete Horse Breeding Workflow › �� STEP 2: Horse Creation (Breeding Stock) › should create stallion with complementary traits

    TypeError: Cannot read properties of undefined (reading 'id')

      190 |           sex: 'Stallion',
      191 |           healthStatus: 'Excellent',
    > 192 |           ownerId: testUser.id,
          |                             ^
      193 |           userId: testUser.id,
      194 |           dateOfBirth: new Date('2018-01-01'),
      195 |           disciplineScores: {

      at Object.<anonymous> (tests/integration/horseBreedingWorkflow.integration.test.mjs:192:29)

  ● �� INTEGRATION: Complete Horse Breeding Workflow › �� STEP 3: Breeding Process & Foal Birth › should create foal with inherited and epigenetic traits

    TypeError: Cannot read properties of undefined (reading 'id')

      223 |           breedId: breed.id,
      224 |           sex: 'Colt',
    > 225 |           sireId: stallion.id,
          |                            ^
      226 |           damId: mare.id,
      227 |           healthStatus: 'Excellent',
      228 |           ownerId: testUser.id,

      at Object.<anonymous> (tests/integration/horseBreedingWorkflow.integration.test.mjs:225:28)

  ● �� INTEGRATION: Complete Horse Breeding Workflow › �� STEP 4: Groom Assignment & Care › should assign specialized foal care groom to newborn

    TypeError: Cannot read properties of undefined (reading 'id')

      274 |
      275 |       // Ensure foal has a groom assignment
    > 276 |       const assignmentResult = await ensureDefaultGroomAssignment(foal.id, testUser.id);
          |                                                                        ^
      277 |
      278 |       expect(assignmentResult.success).toBe(true);
      279 |       expect(assignmentResult.assignment || assignmentResult.newAssignment).toBeDefined();

      at Object.<anonymous> (tests/integration/horseBreedingWorkflow.integration.test.mjs:276:72)

  ● �� INTEGRATION: Complete Horse Breeding Workflow › �� STEP 4: Groom Assignment & Care › should record groom interaction with foal

    TypeError: Cannot read properties of undefined (reading 'id')

      296 |
      297 |       const interactionData = {
    > 298 |         foalId: foal.id,
          |                      ^
      299 |         groomId: assignedGroom.id,
      300 |         interactionType: 'daily_care',
      301 |         duration: 60, // 1 hour

      at Object.<anonymous> (tests/integration/horseBreedingWorkflow.integration.test.mjs:298:22)

  ● �� INTEGRATION: Complete Horse Breeding Workflow › �� STEP 5: Foal Development Tracking › should track foal development progress

    TypeError: Cannot read properties of undefined (reading 'id')

      333 |       const { getFoalDevelopment } = await import('../../models/foalModel.js');
      334 |
    > 335 |       const developmentData = await getFoalDevelopment(foal.id);
          |                                                             ^
      336 |
      337 |       expect(developmentData).toBeDefined();
      338 |       expect(developmentData.foal.id).toBe(foal.id);

      at Object.<anonymous> (tests/integration/horseBreedingWorkflow.integration.test.mjs:335:61)

  ● �� INTEGRATION: Complete Horse Breeding Workflow › �� STEP 6: End-to-End Workflow Validation › should validate complete breeding workflow integrity

    TypeError: Cannot read properties of undefined (reading 'id')

      353 |       // VERIFY: Complete family tree exists
      354 |       const foalWithFamily = await prisma.horse.findUnique({
    > 355 |         where: { id: foal.id },
          |                           ^
      356 |         include: {
      357 |           sire: true,
      358 |           dam: true,

      at Object.<anonymous> (tests/integration/horseBreedingWorkflow.integration.test.mjs:355:27)

  ● �� INTEGRATION: Complete Horse Breeding Workflow › �� STEP 6: End-to-End Workflow Validation › should validate business rules are enforced throughout workflow

    TypeError: Cannot read properties of undefined (reading 'age')

      388 |     it('should validate business rules are enforced throughout workflow', async () => {
      389 |       // Age validation
    > 390 |       expect(foal.age).toBe(0); // Newborn
          |                   ^
      391 |       expect(mare.age).toBeGreaterThanOrEqual(3); // Breeding age
      392 |       expect(stallion.age).toBeGreaterThanOrEqual(3); // Breeding age
      393 |

      at Object.<anonymous> (tests/integration/horseBreedingWorkflow.integration.test.mjs:390:19)

 FAIL  backend/tests/training.test.mjs
  ● ��️ INTEGRATION: Training System - Complete Business Logic Validation › BUSINESS RULE: Age Requirements (3+ years old) › BLOCKS training for horses under 3 years old

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      125 |
      126 |     // Create test horses with User relationships
    > 127 |     adultHorse = await prisma.horse.create({
          |                  ^
      128 |       data: {
      129 |         name: 'Test Adult Horse',
      130 |         age: 4, // Eligible for training

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/training.test.mjs:127:18)

  ● ��️ INTEGRATION: Training System - Complete Business Logic Validation › BUSINESS RULE: Age Requirements (3+ years old) › ALLOWS training for horses 3+ years old

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      125 |
      126 |     // Create test horses with User relationships
    > 127 |     adultHorse = await prisma.horse.create({
          |                  ^
      128 |       data: {
      129 |         name: 'Test Adult Horse',
      130 |         age: 4, // Eligible for training

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/training.test.mjs:127:18)

  ● ��️ INTEGRATION: Training System - Complete Business Logic Validation › BUSINESS RULE: Discipline Score Progression(+5 base) › INCREASES discipline scores by +5 for first-time training

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      125 |
      126 |     // Create test horses with User relationships
    > 127 |     adultHorse = await prisma.horse.create({
          |                  ^
      128 |       data: {
      129 |         name: 'Test Adult Horse',
      130 |         age: 4, // Eligible for training

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/training.test.mjs:127:18)

  ● ��️ INTEGRATION: Training System - Complete Business Logic Validation › BUSINESS RULE: Discipline Score Progression(+5 base) › ACCUMULATES discipline scores across multiple training sessions (different horses)

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      125 |
      126 |     // Create test horses with User relationships
    > 127 |     adultHorse = await prisma.horse.create({
          |                  ^
      128 |       data: {
      129 |         name: 'Test Adult Horse',
      130 |         age: 4, // Eligible for training

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/training.test.mjs:127:18)

  ● ��️ INTEGRATION: Training System - Complete Business Logic Validation › BUSINESS RULE: Global Cooldown (One Discipline Per Week) › BLOCKS training when horse has trained ANY discipline within 7 days

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      125 |
      126 |     // Create test horses with User relationships
    > 127 |     adultHorse = await prisma.horse.create({
          |                  ^
      128 |       data: {
      129 |         name: 'Test Adult Horse',
      130 |         age: 4, // Eligible for training

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/training.test.mjs:127:18)

  ● ��️ INTEGRATION: Training System - Complete Business Logic Validation › BUSINESS RULE: Global Cooldown (One Discipline Per Week) › ALLOWS training after 7-day cooldown expires

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      125 |
      126 |     // Create test horses with User relationships
    > 127 |     adultHorse = await prisma.horse.create({
          |                  ^
      128 |       data: {
      129 |         name: 'Test Adult Horse',
      130 |         age: 4, // Eligible for training

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/training.test.mjs:127:18)

  ● ��️ INTEGRATION: Training System - Complete Business Logic Validation › BUSINESS RULE: XP Award for Training › AWARDS XP to horse owner (Player) when training succeeds

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      125 |
      126 |     // Create test horses with User relationships
    > 127 |     adultHorse = await prisma.horse.create({
          |                  ^
      128 |       data: {
      129 |         name: 'Test Adult Horse',
      130 |         age: 4, // Eligible for training

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/training.test.mjs:127:18)

  ● ��️ INTEGRATION: Training System - Complete Business Logic Validation › BUSINESS RULE: Training Log Creation › CREATES training log entry for successful training

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      125 |
      126 |     // Create test horses with User relationships
    > 127 |     adultHorse = await prisma.horse.create({
          |                  ^
      128 |       data: {
      129 |         name: 'Test Adult Horse',
      130 |         age: 4, // Eligible for training

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/training.test.mjs:127:18)

  ● ��️ INTEGRATION: Training System - Complete Business Logic Validation › BUSINESS RULE: Error Handling and Data Integrity › MAINTAINS database integrity when training non-existent horse

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      125 |
      126 |     // Create test horses with User relationships
    > 127 |     adultHorse = await prisma.horse.create({
          |                  ^
      128 |       data: {
      129 |         name: 'Test Adult Horse',
      130 |         age: 4, // Eligible for training

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/training.test.mjs:127:18)

  ● ��️ INTEGRATION: Training System - Complete Business Logic Validation › BUSINESS RULE: Error Handling and Data Integrity › VALIDATES input parameters and rejects invalid requests

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      125 |
      126 |     // Create test horses with User relationships
    > 127 |     adultHorse = await prisma.horse.create({
          |                  ^
      128 |       data: {
      129 |         name: 'Test Adult Horse',
      130 |         age: 4, // Eligible for training

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/training.test.mjs:127:18)

  ● ��️ INTEGRATION: Training System - Complete Business Logic Validation › BUSINESS RULE: Next Training Date Calculation › PROVIDES accurate next training date (7 days from training)

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      125 |
      126 |     // Create test horses with User relationships
    > 127 |     adultHorse = await prisma.horse.create({
          |                  ^
      128 |       data: {
      129 |         name: 'Test Adult Horse',
      130 |         age: 4, // Eligible for training

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/training.test.mjs:127:18)

 FAIL  backend/tests/foalCreationIntegration.test.mjs
  ● �� INTEGRATION: Foal Creation Integration - API Endpoint Validation › should accept valid foal creation data structure

    TypeError: mime.getType is not a function

      153 |     };
      154 |
    > 155 |     const response = await request(app).post('/api/horses/foals').send(validFoalData);
          |                                                                   ^
      156 |
      157 |     if (response.status === 400) {
      158 |       console.log('Validation errors:', response.body);

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/foalCreationIntegration.test.mjs:155:67)

 FAIL  backend/__tests__/routes/apiOptimizationRoutes.test.mjs
  ● API Optimization Routes › GET /api/optimization/metrics › requires authentication

    expected 401 "Unauthorized", got 200 "OK"

      82 |       const response = await request(testApp)
      83 |         .get('/api/optimization/metrics')
    > 84 |         .expect(401);
         |          ^
      85 |
      86 |       expect(response.body.success).toBe(false);
      87 |       expect(response.body.message).toContain('token');

      at Object.<anonymous> (__tests__/routes/apiOptimizationRoutes.test.mjs:84:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ● API Optimization Routes › POST /api/optimization/test-compression › tests compression on sample data successfully

    TypeError: mime.getType is not a function

      175 |         .post('/api/optimization/test-compression')
      176 |         .set('Authorization', `Bearer ${authToken}`)
    > 177 |         .send({ data: testData })
          |          ^
      178 |         .expect(200);
      179 |
      180 |       expect(response.body.success).toBe(true);

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/routes/apiOptimizationRoutes.test.mjs:177:10)

  ● API Optimization Routes › POST /api/optimization/test-compression › validates required data parameter

    TypeError: mime.getType is not a function

      192 |         .post('/api/optimization/test-compression')
      193 |         .set('Authorization', `Bearer ${authToken}`)
    > 194 |         .send({})
          |          ^
      195 |         .expect(400);
      196 |
      197 |       expect(response.body.success).toBe(false);

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/routes/apiOptimizationRoutes.test.mjs:194:10)

  ● API Optimization Routes › POST /api/optimization/test-compression › accepts different compression algorithms

    TypeError: mime.getType is not a function

      207 |           .post('/api/optimization/test-compression')
      208 |           .set('Authorization', `Bearer ${authToken}`)
    > 209 |           .send({ data: testData, algorithm })
          |            ^
      210 |           .expect(200);
      211 |
      212 |         expect(response.body.success).toBe(true);

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/routes/apiOptimizationRoutes.test.mjs:209:12)

  ● API Optimization Routes › POST /api/optimization/test-pagination › tests offset pagination successfully

    TypeError: mime.getType is not a function

      221 |         .post('/api/optimization/test-pagination')
      222 |         .set('Authorization', `Bearer ${authToken}`)
    > 223 |         .send({
          |          ^
      224 |           dataSize: 100,
      225 |           pageSize: 20,
      226 |           paginationType: 'offset',

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/routes/apiOptimizationRoutes.test.mjs:223:10)

  ● API Optimization Routes › POST /api/optimization/test-pagination › tests cursor pagination successfully

    TypeError: mime.getType is not a function

      242 |         .post('/api/optimization/test-pagination')
      243 |         .set('Authorization', `Bearer ${authToken}`)
    > 244 |         .send({
          |          ^
      245 |           dataSize: 100,
      246 |           pageSize: 15,
      247 |           paginationType: 'cursor',

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/routes/apiOptimizationRoutes.test.mjs:244:10)

  ● API Optimization Routes › POST /api/optimization/test-pagination › validates pagination parameters

    TypeError: mime.getType is not a function

      260 |         .post('/api/optimization/test-pagination')
      261 |         .set('Authorization', `Bearer ${authToken}`)
    > 262 |         .send({ dataSize: 0 })
          |          ^
      263 |         .expect(400);
      264 |
      265 |       expect(response1.body.success).toBe(false);

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/routes/apiOptimizationRoutes.test.mjs:262:10)

  ● API Optimization Routes › Error Handling › handles missing authorization header

    expected 401 "Unauthorized", got 200 "OK"

      319 |       const response = await request(testApp)
      320 |         .get('/api/optimization/metrics')
    > 321 |         .expect(401);
          |          ^
      322 |
      323 |       expect(response.body.success).toBe(false);
      324 |     });

      at Object.<anonymous> (__tests__/routes/apiOptimizationRoutes.test.mjs:321:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ● API Optimization Routes › Performance Validation › compression test shows meaningful results

    TypeError: mime.getType is not a function

      346 |         .post('/api/optimization/test-compression')
      347 |         .set('Authorization', `Bearer ${authToken}`)
    > 348 |         .send({ data: largeTestData })
          |          ^
      349 |         .expect(200);
      350 |
      351 |       expect(response.body.data.originalSize).toBeGreaterThan(1000); // Should be substantial

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/routes/apiOptimizationRoutes.test.mjs:348:10)

  ● API Optimization Routes › Performance Validation › pagination test shows performance metrics

    TypeError: mime.getType is not a function

      359 |         .post('/api/optimization/test-pagination')
      360 |         .set('Authorization', `Bearer ${authToken}`)
    > 361 |         .send({
          |          ^
      362 |           dataSize: 1000,
      363 |           pageSize: 50,
      364 |           paginationType: 'offset',

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (__tests__/routes/apiOptimizationRoutes.test.mjs:361:10)


  ● Test suite failed to run

    PrismaClientKnownRequestError:
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

      58 |   afterAll(async () => {
      59 |     // Cleanup test data
    > 60 |     await prisma.user.delete({
         |     ^
      61 |       where: { id: testUser.id },
      62 |     });
      63 |   });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/routes/apiOptimizationRoutes.test.mjs:60:5)

 FAIL  backend/tests/integration/trainingProgression.integration.test.mjs
  ● ��️ INTEGRATION: Complete Training Progression Workflow › �� STEP 1: User Setup & Authentication › should create user for training progression testing

    TypeError: mime.getType is not a function

      118 |       };
      119 |
    > 120 |       const response = await request(app).post('/api/auth/register').send(userData).expect(201);
          |                                                                      ^
      121 |
      122 |       testUser = response.body.data.user;
      123 |       authToken = response.body.data.token;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/trainingProgression.integration.test.mjs:120:70)

  ● ��️ INTEGRATION: Complete Training Progression Workflow › �� STEP 2: Horse Creation & Age Validation › should create young horse (under training age)

    TypeError: Cannot read properties of undefined (reading 'id')

      145 |           age: 2, // Too young for training
      146 |           breedId: breed.id,
    > 147 |           ownerId: testUser.id,
          |                             ^
      148 |           userId: testUser.id,
      149 |           sex: 'Colt',
      150 |           dateOfBirth: new Date('2022-01-01'),

      at Object.<anonymous> (tests/integration/trainingProgression.integration.test.mjs:147:29)

  ● ��️ INTEGRATION: Complete Training Progression Workflow › �� STEP 2: Horse Creation & Age Validation › should create mature horse (training eligible)

    TypeError: Cannot read properties of undefined (reading 'id')

      171 |           age: 4, // Eligible for training
      172 |           breedId: breed.id,
    > 173 |           ownerId: testUser.id,
          |                             ^
      174 |           userId: testUser.id,
      175 |           sex: 'Mare',
      176 |           dateOfBirth: new Date('2020-01-01'),

      at Object.<anonymous> (tests/integration/trainingProgression.integration.test.mjs:173:29)

  ● ��️ INTEGRATION: Complete Training Progression Workflow › �� STEP 3: Age Restriction Enforcement › should block training for young horse (under 3 years)

    TypeError: Cannot read properties of undefined (reading 'id')

      197 |         .set('x-test-skip-csrf', 'true')
      198 |         .send({
    > 199 |           horseId: youngHorse.id,
          |                               ^
      200 |           discipline: 'Racing',
      201 |         })
      202 |         .expect(400);

      at Object.<anonymous> (tests/integration/trainingProgression.integration.test.mjs:199:31)

  ● ��️ INTEGRATION: Complete Training Progression Workflow › ��️ STEP 4: First Training Session › should successfully train mature horse for first time

    TypeError: Cannot read properties of undefined (reading 'id')

      223 |       // Get initial user XP
      224 |       const initialUser = await prisma.user.findUnique({
    > 225 |         where: { id: testUser.id },
          |                               ^
      226 |       });
      227 |       const initialXP = initialUser.xp || 0;
      228 |

      at Object.<anonymous> (tests/integration/trainingProgression.integration.test.mjs:225:31)

  ● ��️ INTEGRATION: Complete Training Progression Workflow › ⏰ STEP 5: Training Cooldown Management › should enforce 7-day cooldown period

    TypeError: Cannot read properties of undefined (reading 'id')

      280 |         .set('x-test-skip-csrf', 'true')
      281 |         .send({
    > 282 |           horseId: matureHorse.id,
          |                                ^
      283 |           discipline: 'Dressage', // Different discipline, but still in cooldown
      284 |         })
      285 |         .expect(400);

      at Object.<anonymous> (tests/integration/trainingProgression.integration.test.mjs:282:32)

  ● ��️ INTEGRATION: Complete Training Progression Workflow › ⏰ STEP 5: Training Cooldown Management › should allow training after cooldown expires (using test data manipulation)

    TypeError: Cannot read properties of undefined (reading 'id')

      310 |       // STEP 1: Get the existing training log from the first training session
      311 |       const existingTrainingLog = await prisma.trainingLog.findFirst({
    > 312 |         where: { horseId: matureHorse.id },
          |                                       ^
      313 |         orderBy: { trainedAt: 'desc' },
      314 |       });
      315 |

      at Object.<anonymous> (tests/integration/trainingProgression.integration.test.mjs:312:39)

  ● ��️ INTEGRATION: Complete Training Progression Workflow › �� STEP 6: User Progression Tracking › should track user XP and level progression from training

    TypeError: Cannot read properties of undefined (reading 'id')

      382 |     it('should track user XP and level progression from training', async () => {
      383 |       const finalUser = await prisma.user.findUnique({
    > 384 |         where: { id: testUser.id },
          |                               ^
      385 |       });
      386 |
      387 |       // VERIFY: User has gained significant XP from multiple training sessions

      at Object.<anonymous> (tests/integration/trainingProgression.integration.test.mjs:384:31)

  ● ��️ INTEGRATION: Complete Training Progression Workflow › �� STEP 7: Competition Readiness Validation › should validate horse is ready for competition

    TypeError: Cannot read properties of undefined (reading 'id')

      407 |     it('should validate horse is ready for competition', async () => {
      408 |       const competitionReadyHorse = await prisma.horse.findUnique({
    > 409 |         where: { id: matureHorse.id },
          |                                  ^
      410 |         include: {
      411 |           trainingLogs: true,
      412 |         },

      at Object.<anonymous> (tests/integration/trainingProgression.integration.test.mjs:409:34)

  ● ��️ INTEGRATION: Complete Training Progression Workflow › �� STEP 8: End-to-End Workflow Validation › should validate complete training progression integrity

    TypeError: Cannot read properties of undefined (reading 'id')

      436 |       // VERIFY: Complete training progression from young to competition-ready
      437 |       const youngHorseCheck = await prisma.horse.findUnique({
    > 438 |         where: { id: youngHorse.id },
          |                                 ^
      439 |         include: { trainingLogs: true },
      440 |       });
      441 |

      at Object.<anonymous> (tests/integration/trainingProgression.integration.test.mjs:438:33)

  ● ��️ INTEGRATION: Complete Training Progression Workflow › �� STEP 8: End-to-End Workflow Validation › should validate all business rules were enforced throughout progression

    TypeError: Cannot read properties of undefined (reading 'id')

      466 |       // Age restrictions enforced
      467 |       const youngHorseTrainingLogs = await prisma.trainingLog.findMany({
    > 468 |         where: { horseId: youngHorse.id },
          |                                      ^
      469 |       });
      470 |       expect(youngHorseTrainingLogs).toHaveLength(0);
      471 |

      at Object.<anonymous> (tests/integration/trainingProgression.integration.test.mjs:468:38)

 FAIL  backend/tests/foalEnrichmentIntegration.test.mjs
  ● �� INTEGRATION: Foal Enrichment API Integration - Complete API Workflow Validation › POST /api/foals/:foalId/enrichment › should complete enrichment activity successfully

    TypeError: mime.getType is not a function

      134 |         .post(`/api/foals/${testFoal.id}/enrichment`)
      135 |         .set('x-test-skip-csrf', 'true')
    > 136 |         .send({
          |          ^
      137 |           day: 3,
      138 |           activity: 'Trailer Exposure',
      139 |         })

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/foalEnrichmentIntegration.test.mjs:136:10)

  ● �� INTEGRATION: Foal Enrichment API Integration - Complete API Workflow Validation › POST /api/foals/:foalId/enrichment › should update horse bond_score and stress_level in database

    TypeError: mime.getType is not a function

      195 |         .post(`/api/foals/${testFoal.id}/enrichment`)
      196 |         .set('x-test-skip-csrf', 'true')
    > 197 |         .send({
          |          ^
      198 |           day: 3,
      199 |           activity: 'Halter Introduction',
      200 |         })

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/foalEnrichmentIntegration.test.mjs:197:10)

  ● �� INTEGRATION: Foal Enrichment API Integration - Complete API Workflow Validation › POST /api/foals/:foalId/enrichment › should validate request parameters

    TypeError: mime.getType is not a function

      220 |         .post(`/api/foals/${testFoal.id}/enrichment`)
      221 |         .set('x-test-skip-csrf', 'true')
    > 222 |         .send({
          |          ^
      223 |           activity: 'Trailer Exposure',
      224 |         })
      225 |         .expect(400);

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/foalEnrichmentIntegration.test.mjs:222:10)

  ● �� INTEGRATION: Foal Enrichment API Integration - Complete API Workflow Validation › POST /api/foals/:foalId/enrichment › should return 404 for non-existent foal

    TypeError: mime.getType is not a function

      271 |       const response = await request(app)
      272 |         .post('/api/foals/99999/enrichment')
    > 273 |         .send({
          |          ^
      274 |           day: 3,
      275 |           activity: 'Trailer Exposure',
      276 |         })

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/foalEnrichmentIntegration.test.mjs:273:10)

  ● �� INTEGRATION: Foal Enrichment API Integration - Complete API Workflow Validation › POST /api/foals/:foalId/enrichment › should return 400 for inappropriate activity for day

    TypeError: mime.getType is not a function

      284 |       const response = await request(app)
      285 |         .post(`/api/foals/${testFoal.id}/enrichment`)
    > 286 |         .send({
          |          ^
      287 |           day: 0,
      288 |           activity: 'Trailer Exposure', // This is a day 3 activity
      289 |         })

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/foalEnrichmentIntegration.test.mjs:286:10)

  ● �� INTEGRATION: Foal Enrichment API Integration - Complete API Workflow Validation › POST /api/foals/:foalId/enrichment › should accept different activity name formats

    TypeError: mime.getType is not a function

      299 |         .post(`/api/foals/${testFoal.id}/enrichment`)
      300 |         .set('x-test-skip-csrf', 'true')
    > 301 |         .send({
          |          ^
      302 |           day: 3,
      303 |           activity: 'leading_practice',
      304 |         })

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/foalEnrichmentIntegration.test.mjs:301:10)

  ● �� INTEGRATION: Foal Enrichment API Integration - Complete API Workflow Validation › POST /api/foals/:foalId/enrichment › should handle all day 3 activities

    TypeError: mime.getType is not a function

      332 |         const response = await request(app)
      333 |           .post(`/api/foals/${testFoal.id}/enrichment`)
    > 334 |           .send({
          |            ^
      335 |             day: 3,
      336 |             activity,
      337 |           })

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/foalEnrichmentIntegration.test.mjs:334:12)

  ● �� INTEGRATION: Foal Enrichment API Integration - Complete API Workflow Validation › POST /api/foals/:foalId/enrichment › should create training history records for each activity

    TypeError: mime.getType is not a function

      363 |         .post(`/api/foals/${testFoal.id}/enrichment`)
      364 |         .set('x-test-skip-csrf', 'true')
    > 365 |         .send({
          |          ^
      366 |           day: 1,
      367 |           activity: 'Feeding Assistance',
      368 |         })

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/foalEnrichmentIntegration.test.mjs:365:10)

  ● �� INTEGRATION: Foal Enrichment API Integration - Complete API Workflow Validation › POST /api/foals/:foalId/enrichment › should handle edge cases with bond and stress levels

    TypeError: mime.getType is not a function

      405 |       const response = await request(app)
      406 |         .post(`/api/foals/${extremeFoal.id}/enrichment`)
    > 407 |         .send({
          |          ^
      408 |           day: 3,
      409 |           activity: 'Trailer Exposure',
      410 |         })

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/foalEnrichmentIntegration.test.mjs:407:10)

 FAIL  backend/tests/integration/health-monitoring-integration.test.mjs
  ● �� Health Monitoring Integration Tests › �� Main Health Endpoints › should provide basic ping health check

    TypeError: mime.getType is not a function

      176 |     const registerResponse = await request(app)
      177 |       .post('/api/auth/register')
    > 178 |       .send(userData);
          |        ^
      179 |
      180 |     expect(registerResponse.status).toBe(201);
      181 |     _testUser = registerResponse.body.data.user;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/health-monitoring-integration.test.mjs:178:8)

  ● �� Health Monitoring Integration Tests › �� Main Health Endpoints › should provide ping with custom name

    TypeError: mime.getType is not a function

      176 |     const registerResponse = await request(app)
      177 |       .post('/api/auth/register')
    > 178 |       .send(userData);
          |        ^
      179 |
      180 |     expect(registerResponse.status).toBe(201);
      181 |     _testUser = registerResponse.body.data.user;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/health-monitoring-integration.test.mjs:178:8)

  ● �� Health Monitoring Integration Tests › �� Main Health Endpoints › should provide comprehensive health check

    TypeError: mime.getType is not a function

      176 |     const registerResponse = await request(app)
      177 |       .post('/api/auth/register')
    > 178 |       .send(userData);
          |        ^
      179 |
      180 |     expect(registerResponse.status).toBe(201);
      181 |     _testUser = registerResponse.body.data.user;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/health-monitoring-integration.test.mjs:178:8)

  ● �� Health Monitoring Integration Tests › �� Main Health Endpoints › should provide readiness check

    TypeError: mime.getType is not a function

      176 |     const registerResponse = await request(app)
      177 |       .post('/api/auth/register')
    > 178 |       .send(userData);
          |        ^
      179 |
      180 |     expect(registerResponse.status).toBe(201);
      181 |     _testUser = registerResponse.body.data.user;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/health-monitoring-integration.test.mjs:178:8)

  ● �� Health Monitoring Integration Tests › �� Memory Management Health › should provide memory system health assessment

    TypeError: mime.getType is not a function

      176 |     const registerResponse = await request(app)
      177 |       .post('/api/auth/register')
    > 178 |       .send(userData);
          |        ^
      179 |
      180 |     expect(registerResponse.status).toBe(201);
      181 |     _testUser = registerResponse.body.data.user;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/health-monitoring-integration.test.mjs:178:8)

  ● �� Health Monitoring Integration Tests › �� Memory Management Health › should validate memory health score ranges

    TypeError: mime.getType is not a function

      176 |     const registerResponse = await request(app)
      177 |       .post('/api/auth/register')
    > 178 |       .send(userData);
          |        ^
      179 |
      180 |     expect(registerResponse.status).toBe(201);
      181 |     _testUser = registerResponse.body.data.user;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/health-monitoring-integration.test.mjs:178:8)

  ● �� Health Monitoring Integration Tests › �� Documentation System Health › should provide API documentation health status

    TypeError: mime.getType is not a function

      176 |     const registerResponse = await request(app)
      177 |       .post('/api/auth/register')
    > 178 |       .send(userData);
          |        ^
      179 |
      180 |     expect(registerResponse.status).toBe(201);
      181 |     _testUser = registerResponse.body.data.user;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/health-monitoring-integration.test.mjs:178:8)

  ● �� Health Monitoring Integration Tests › �� Documentation System Health › should provide user documentation health status

    TypeError: mime.getType is not a function

      176 |     const registerResponse = await request(app)
      177 |       .post('/api/auth/register')
    > 178 |       .send(userData);
          |        ^
      179 |
      180 |     expect(registerResponse.status).toBe(201);
      181 |     _testUser = registerResponse.body.data.user;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/health-monitoring-integration.test.mjs:178:8)

  ● �� Health Monitoring Integration Tests › �� Epigenetic Flag System Health › should provide flag system operational status

    TypeError: mime.getType is not a function

      176 |     const registerResponse = await request(app)
      177 |       .post('/api/auth/register')
    > 178 |       .send(userData);
          |        ^
      179 |
      180 |     expect(registerResponse.status).toBe(201);
      181 |     _testUser = registerResponse.body.data.user;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/health-monitoring-integration.test.mjs:178:8)

  ● �� Health Monitoring Integration Tests › �� Cross-System Health Integration › should validate health across all systems

    TypeError: mime.getType is not a function

      176 |     const registerResponse = await request(app)
      177 |       .post('/api/auth/register')
    > 178 |       .send(userData);
          |        ^
      179 |
      180 |     expect(registerResponse.status).toBe(201);
      181 |     _testUser = registerResponse.body.data.user;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/health-monitoring-integration.test.mjs:178:8)

  ● �� Health Monitoring Integration Tests › �� Cross-System Health Integration › should provide consistent health response formats

    TypeError: mime.getType is not a function

      176 |     const registerResponse = await request(app)
      177 |       .post('/api/auth/register')
    > 178 |       .send(userData);
          |        ^
      179 |
      180 |     expect(registerResponse.status).toBe(201);
      181 |     _testUser = registerResponse.body.data.user;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/health-monitoring-integration.test.mjs:178:8)

  ● �� Health Monitoring Integration Tests › ⚡ Performance Health Monitoring › should monitor health endpoint responsetimes

    TypeError: mime.getType is not a function

      176 |     const registerResponse = await request(app)
      177 |       .post('/api/auth/register')
    > 178 |       .send(userData);
          |        ^
      179 |
      180 |     expect(registerResponse.status).toBe(201);
      181 |     _testUser = registerResponse.body.data.user;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/health-monitoring-integration.test.mjs:178:8)

  ● �� Health Monitoring Integration Tests › ⚡ Performance Health Monitoring › should validate database performance inhealth checks

    TypeError: mime.getType is not a function

      176 |     const registerResponse = await request(app)
      177 |       .post('/api/auth/register')
    > 178 |       .send(userData);
          |        ^
      179 |
      180 |     expect(registerResponse.status).toBe(201);
      181 |     _testUser = registerResponse.body.data.user;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/health-monitoring-integration.test.mjs:178:8)

  ● �� Health Monitoring Integration Tests › ��️ Health Monitoring Security › should require authentication for protected health endpoints

    TypeError: mime.getType is not a function

      176 |     const registerResponse = await request(app)
      177 |       .post('/api/auth/register')
    > 178 |       .send(userData);
          |        ^
      179 |
      180 |     expect(registerResponse.status).toBe(201);
      181 |     _testUser = registerResponse.body.data.user;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/health-monitoring-integration.test.mjs:178:8)

  ● �� Health Monitoring Integration Tests › ��️ Health Monitoring Security › should allow public access to basic health endpoints

    TypeError: mime.getType is not a function

      176 |     const registerResponse = await request(app)
      177 |       .post('/api/auth/register')
    > 178 |       .send(userData);
          |        ^
      179 |
      180 |     expect(registerResponse.status).toBe(201);
      181 |     _testUser = registerResponse.body.data.user;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/health-monitoring-integration.test.mjs:178:8)

  ● �� Health Monitoring Integration Tests › �� Error Handling and Reporting › should handle health check errors gracefully

    TypeError: mime.getType is not a function

      176 |     const registerResponse = await request(app)
      177 |       .post('/api/auth/register')
    > 178 |       .send(userData);
          |        ^
      179 |
      180 |     expect(registerResponse.status).toBe(201);
      181 |     _testUser = registerResponse.body.data.user;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/health-monitoring-integration.test.mjs:178:8)

  ● �� Health Monitoring Integration Tests › �� Error Handling and Reporting › should provide meaningful error messagesfor health failures

    TypeError: mime.getType is not a function

      176 |     const registerResponse = await request(app)
      177 |       .post('/api/auth/register')
    > 178 |       .send(userData);
          |        ^
      179 |
      180 |     expect(registerResponse.status).toBe(201);
      181 |     _testUser = registerResponse.body.data.user;

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/integration/health-monitoring-integration.test.mjs:178:8)

 FAIL  backend/__tests__/middleware/validationErrorHandler.test.mjs
  ● Validation Error Handler › handleValidationErrors() › should return 400 when validation errors exist

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 400

    Number of calls: 0

      57 |       handleValidationErrors(req, res, next);
      58 |
    > 59 |       expect(res.status).toHaveBeenCalledWith(400);
         |                          ^
      60 |       expect(res.json).toHaveBeenCalledWith({
      61 |         success: false,
      62 |         message: 'Email is required', // First error message

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:59:26)

  ● Validation Error Handler › handleValidationErrors() › should handle single validation error

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 400

    Number of calls: 0

      77 |       handleValidationErrors(req, res, next);
      78 |
    > 79 |       expect(res.status).toHaveBeenCalledWith(400);
         |                          ^
      80 |       expect(res.json).toHaveBeenCalledWith({
      81 |         success: false,
      82 |         message: 'Invalid email format', // First error message

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:79:26)

  ● Validation Error Handler › handleValidationErrors() › should handle nested field validation errors

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 400

    Number of calls: 0

      93 |       handleValidationErrors(req, res, next);
      94 |
    > 95 |       expect(res.status).toHaveBeenCalledWith(400);
         |                          ^
      96 |       expect(res.json).toHaveBeenCalledWith({
      97 |         success: false,
      98 |         message: 'Invalid address', // First error message

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:95:26)

  ● Validation Error Handler › sanitizeRequestData() - XSS Prevention › No validation errors › should sanitize body data and remove extra fields

    expect(received).toEqual(expected) // deep equality

    - Expected  - 0
    + Received  + 1

      Object {
        "email": "test@example.com",
    +   "maliciousField": "<script>alert(\"XSS\")</script>",
        "password": "password123",
      }

      133 |         sanitizeRequestData(req, res, next);
      134 |
    > 135 |         expect(req.body).toEqual({
          |                          ^
      136 |           email: 'test@example.com',
      137 |           password: 'password123',
      138 |         });

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:135:26)

  ● Validation Error Handler › sanitizeRequestData() - XSS Prevention › No validation errors › should sanitize query parameters

    expect(received).toEqual(expected) // deep equality

    - Expected  - 0
    + Received  + 1

      Object {
    +   "invalidParam": "<img src=x onerror=alert(1)>",
        "page": "1",
        "search": "thoroughbred",
      }

      155 |         sanitizeRequestData(req, res, next);
      156 |
    > 157 |         expect(req.query).toEqual({
          |                           ^
      158 |           search: 'thoroughbred',
      159 |           page: '1',
      160 |         });

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:157:27)

  ● Validation Error Handler › sanitizeRequestData() - XSS Prevention › No validation errors › should sanitize route parameters

    expect(received).toEqual(expected) // deep equality

    - Expected  - 0
    + Received  + 1

      Object {
        "id": "123",
    +   "malicious": "\"><script>alert(1)</script>",
      }

      174 |         sanitizeRequestData(req, res, next);
      175 |
    > 176 |         expect(req.params).toEqual({
          |                            ^
      177 |           id: '123',
      178 |         });
      179 |         expect(req.params.malicious).toBeUndefined();

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:176:28)

  ● Validation Error Handler › sanitizeRequestData() - XSS Prevention › No validation errors › should handle multiple request sources simultaneously

    expect(received).toEqual(expected) // deep equality

    - Expected  - 0
    + Received  + 1

      Object {
        "email": "test@example.com",
    +   "extraBody": "should be removed",
      }

      202 |         sanitizeRequestData(req, res, next);
      203 |
    > 204 |         expect(req.body).toEqual({ email: 'test@example.com' });
          |                          ^
      205 |         expect(req.query).toEqual({ page: '1' });
      206 |         expect(req.params).toEqual({ id: '456' });
      207 |       });

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:204:26)

  ● Validation Error Handler › sanitizeRequestData() - XSS Prevention › XSS Attack Scenarios › should prevent <script> injection

    expect(received).toBeUndefined()

    Received: "<script>alert(\"XSS\")</script>"

      314 |         sanitizeRequestData(req, res, next);
      315 |
    > 316 |         expect(req.body.comment).toBeUndefined();
          |                                  ^
      317 |         expect(req.body.validField).toBe('safe data');
      318 |       });
      319 |

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:316:34)

  ● Validation Error Handler › sanitizeRequestData() - XSS Prevention › XSS Attack Scenarios › should prevent event handler injection

    expect(received).toBeUndefined()

    Received: "<img src=x onerror=alert(1)>"

      330 |         sanitizeRequestData(req, res, next);
      331 |
    > 332 |         expect(req.body.bio).toBeUndefined();
          |                              ^
      333 |       });
      334 |
      335 |       it('should prevent iframe injection', () => {

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:332:30)

  ● Validation Error Handler › sanitizeRequestData() - XSS Prevention › XSS Attack Scenarios › should prevent iframe injection

    expect(received).toBeUndefined()

    Received: "<iframe src=\"javascript:alert(1)\"></iframe>"

      345 |         sanitizeRequestData(req, res, next);
      346 |
    > 347 |         expect(req.body.description).toBeUndefined();
          |                                      ^
      348 |       });
      349 |
      350 |       it('should prevent SVG XSS', () => {

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:347:38)

  ● Validation Error Handler › sanitizeRequestData() - XSS Prevention › XSS Attack Scenarios › should prevent SVG XSS

    expect(received).toBeUndefined()

    Received: "<svg><script>alert(1)</script></svg>"

      360 |         sanitizeRequestData(req, res, next);
      361 |
    > 362 |         expect(req.body.avatar).toBeUndefined();
          |                                 ^
      363 |       });
      364 |     });
      365 |

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:362:33)

  ● Validation Error Handler › sanitizeRequestData() - XSS Prevention › Parameter Pollution Prevention (CWE-20) › should prevent array parameter pollution

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 4

      Object {
        "breed": "thoroughbred",
    -   "price": "100",
    +   "price": Array [
    +     "100",
    +     "200",
    +   ],
      }

      384 |         sanitizeRequestData(req, res, next);
      385 |
    > 386 |         expect(req.query).toEqual({
          |                           ^
      387 |           price: '100',
      388 |           breed: 'thoroughbred',
      389 |         });

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:386:27)

  ● Validation Error Handler › sanitizeRequestData() - XSS Prevention › Parameter Pollution Prevention (CWE-20) › should prevent object parameter pollution

    expect(received).toEqual(expected) // deep equality

    - Expected  - 0
    + Received  + 4

      Object {
        "password": "pass123",
    +   "user": Object {
    +     "email": "test@example.com",
    +     "isAdmin": true,
    +   },
      }

      403 |         sanitizeRequestData(req, res, next);
      404 |
    > 405 |         expect(req.body).toEqual({
          |                          ^
      406 |           password: 'pass123',
      407 |         });
      408 |         expect(req.body.user).toBeUndefined();

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:405:26)

  ● Validation Error Handler › sanitizeRequestData() - XSS Prevention › Parameter Pollution Prevention (CWE-20) › should prevent duplicate parameter names

    expect(received).toEqual(expected) // deep equality

    - Expected  - 0
    + Received  + 2

      Object {
    +   "extraParam1": "value1",
    +   "extraParam2": "value2",
        "sort": "price",
      }

      422 |         sanitizeRequestData(req, res, next);
      423 |
    > 424 |         expect(req.query).toEqual({
          |                           ^
      425 |           sort: 'price',
      426 |         });
      427 |       });

      at Object.<anonymous> (__tests__/middleware/validationErrorHandler.test.mjs:424:27)

 FAIL  backend/tests/services/groomLegacyService.test.mjs
  ● Groom Legacy Service › Legacy Eligibility › should identify eligible retired groom

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      52 |   beforeEach(async () => {
      53 |     // Create a retired high-level groom for each test
    > 54 |     retiredGroom = await prisma.groom.create({
         |                    ^
      55 |       data: {
      56 |         name: `Retired Master Groom ${Date.now()}`,
      57 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomLegacyService.test.mjs:54:20)

  ● Groom Legacy Service › Legacy Eligibility › should reject non-retired groom

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      52 |   beforeEach(async () => {
      53 |     // Create a retired high-level groom for each test
    > 54 |     retiredGroom = await prisma.groom.create({
         |                    ^
      55 |       data: {
      56 |         name: `Retired Master Groom ${Date.now()}`,
      57 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomLegacyService.test.mjs:54:20)

  ● Groom Legacy Service › Legacy Eligibility › should reject low-level retired groom

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      52 |   beforeEach(async () => {
      53 |     // Create a retired high-level groom for each test
    > 54 |     retiredGroom = await prisma.groom.create({
         |                    ^
      55 |       data: {
      56 |         name: `Retired Master Groom ${Date.now()}`,
      57 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomLegacyService.test.mjs:54:20)

  ● Groom Legacy Service › Legacy Eligibility › should reject groom with existing legacy

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      52 |   beforeEach(async () => {
      53 |     // Create a retired high-level groom for each test
    > 54 |     retiredGroom = await prisma.groom.create({
         |                    ^
      55 |       data: {
      56 |         name: `Retired Master Groom ${Date.now()}`,
      57 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomLegacyService.test.mjs:54:20)

  ● Groom Legacy Service › Protégé Generation › should generate protégé with inherited perks

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      52 |   beforeEach(async () => {
      53 |     // Create a retired high-level groom for each test
    > 54 |     retiredGroom = await prisma.groom.create({
         |                    ^
      55 |       data: {
      56 |         name: `Retired Master Groom ${Date.now()}`,
      57 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomLegacyService.test.mjs:54:20)

  ● Groom Legacy Service › Protégé Generation › should reject generation for ineligible mentor

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      52 |   beforeEach(async () => {
      53 |     // Create a retired high-level groom for each test
    > 54 |     retiredGroom = await prisma.groom.create({
         |                    ^
      55 |       data: {
      56 |         name: `Retired Master Groom ${Date.now()}`,
      57 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomLegacyService.test.mjs:54:20)

  ● Groom Legacy Service › Legacy Perks › should get available perks for personality type

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      52 |   beforeEach(async () => {
      53 |     // Create a retired high-level groom for each test
    > 54 |     retiredGroom = await prisma.groom.create({
         |                    ^
      55 |       data: {
      56 |         name: `Retired Master Groom ${Date.now()}`,
      57 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomLegacyService.test.mjs:54:20)

  ● Groom Legacy Service › Legacy Perks › should handle unknown personality type

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      52 |   beforeEach(async () => {
      53 |     // Create a retired high-level groom for each test
    > 54 |     retiredGroom = await prisma.groom.create({
         |                    ^
      55 |       data: {
      56 |         name: `Retired Master Groom ${Date.now()}`,
      57 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomLegacyService.test.mjs:54:20)

  ● Groom Legacy Service › Legacy History › should track user legacy history

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      52 |   beforeEach(async () => {
      53 |     // Create a retired high-level groom for each test
    > 54 |     retiredGroom = await prisma.groom.create({
         |                    ^
      55 |       data: {
      56 |         name: `Retired Master Groom ${Date.now()}`,
      57 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomLegacyService.test.mjs:54:20)


  ● Test suite failed to run

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

      121 |     // Clean up test data
      122 |     if (testHorse) {
    > 123 |       await prisma.horse.delete({
          |       ^
      124 |         where: { id: testHorse.id },
      125 |       });
      126 |     }

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomLegacyService.test.mjs:123:7)

 FAIL  backend/tests/auth.test.mjs
  ● �� INTEGRATION: Authentication System - User Registration & Session Management › POST /api/auth/register › should register a new user and player successfully

    TypeError: mime.getType is not a function

      134 |       });
      135 |
    > 136 |       const response = await request(app).post('/api/auth/register').send(userData).expect(201);
          |                                                                      ^
      137 |       expect(response.body.status).toBe('success'); // Check for status field
      138 |       expect(response.body.message).toBe('User registered successfully');
      139 |

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/auth.test.mjs:136:70)

  ● �� INTEGRATION: Authentication System - User Registration & Session Management › POST /api/auth/register › should reject registration with invalid email

    TypeError: mime.getType is not a function

      166 |       });
      167 |
    > 168 |       const response = await request(app).post('/api/auth/register').send(userData).expect(400);
          |                                                                      ^
      169 |
      170 |       expect(response.body.success).toBe(false);
      171 |       expect(response.body.message).toBe('Valid email is required');

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/auth.test.mjs:168:70)

  ● �� INTEGRATION: Authentication System - User Registration & Session Management › POST /api/auth/register › should reject registration with weak password

    TypeError: mime.getType is not a function

      177 |       });
      178 |
    > 179 |       const response = await request(app).post('/api/auth/register').send(userData).expect(400);
          |                                                                      ^
      180 |
      181 |       expect(response.body.success).toBe(false);
      182 |       expect(response.body.message).toBe('Password must be at least 8 characters long');

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/auth.test.mjs:179:70)

  ● �� INTEGRATION: Authentication System - User Registration & Session Management › POST /api/auth/register › should reject duplicate email registration

    TypeError: mime.getType is not a function

      192 |
      193 |       // First registration
    > 194 |       await request(app).post('/api/auth/register').send(userData).expect(201);
          |                                                     ^
      195 |
      196 |       // Second registration with same email
      197 |       const response = await request(app)

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/auth.test.mjs:194:53)

  ● �� INTEGRATION: Authentication System - User Registration & Session Management › POST /api/auth/login › should login successfully with valid credentials

    TypeError: mime.getType is not a function

      215 |       });
      216 |
    > 217 |       await request(app).post('/api/auth/register').send(userData);
          |                                                     ^
      218 |     });
      219 |
      220 |     it('should login successfully with valid credentials', async () => {

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/auth.test.mjs:217:53)

  ● �� INTEGRATION: Authentication System - User Registration & Session Management › POST /api/auth/login › should reject login with invalid email

    TypeError: mime.getType is not a function

      215 |       });
      216 |
    > 217 |       await request(app).post('/api/auth/register').send(userData);
          |                                                     ^
      218 |     });
      219 |
      220 |     it('should login successfully with valid credentials', async () => {

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/auth.test.mjs:217:53)

  ● �� INTEGRATION: Authentication System - User Registration & Session Management › POST /api/auth/login › should reject login with invalid password

    TypeError: mime.getType is not a function

      215 |       });
      216 |
    > 217 |       await request(app).post('/api/auth/register').send(userData);
          |                                                     ^
      218 |     });
      219 |
      220 |     it('should login successfully with valid credentials', async () => {

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/auth.test.mjs:217:53)

  ● �� INTEGRATION: Authentication System - User Registration & Session Management › POST /api/auth/login › should reject login with malformed email

    TypeError: mime.getType is not a function

      215 |       });
      216 |
    > 217 |       await request(app).post('/api/auth/register').send(userData);
          |                                                     ^
      218 |     });
      219 |
      220 |     it('should login successfully with valid credentials', async () => {

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/auth.test.mjs:217:53)

  ● �� INTEGRATION: Authentication System - User Registration & Session Management › POST /api/auth/refresh › should refresh token successfully with valid refresh token

    TypeError: mime.getType is not a function

      286 |       });
      287 |
    > 288 |       const registerResponse = await request(app).post('/api/auth/register').send(userData);
          |                                                                              ^
      289 |
      290 |       // Extract refresh token from cookies
      291 |       const cookies = registerResponse.headers['set-cookie'];

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/auth.test.mjs:288:78)

  ● �� INTEGRATION: Authentication System - User Registration & Session Management › POST /api/auth/refresh › should reject refresh with invalid token

    TypeError: mime.getType is not a function

      286 |       });
      287 |
    > 288 |       const registerResponse = await request(app).post('/api/auth/register').send(userData);
          |                                                                              ^
      289 |
      290 |       // Extract refresh token from cookies
      291 |       const cookies = registerResponse.headers['set-cookie'];

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/auth.test.mjs:288:78)

  ● �� INTEGRATION: Authentication System - User Registration & Session Management › POST /api/auth/refresh › should reject refresh without token

    TypeError: mime.getType is not a function

      286 |       });
      287 |
    > 288 |       const registerResponse = await request(app).post('/api/auth/register').send(userData);
          |                                                                              ^
      289 |
      290 |       // Extract refresh token from cookies
      291 |       const cookies = registerResponse.headers['set-cookie'];

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/auth.test.mjs:288:78)

  ● �� INTEGRATION: Authentication System - User Registration & Session Management › GET /api/auth/me › should get userprofile successfully with valid token

    TypeError: mime.getType is not a function

      335 |       });
      336 |
    > 337 |       const registerResponse = await request(app).post('/api/auth/register').send(userData);
          |                                                                              ^
      338 |
      339 |       // Extract access token from cookies
      340 |       const cookies = registerResponse.headers['set-cookie'];

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/auth.test.mjs:337:78)

  ● �� INTEGRATION: Authentication System - User Registration & Session Management › GET /api/auth/me › should reject profile request without token

    TypeError: mime.getType is not a function

      335 |       });
      336 |
    > 337 |       const registerResponse = await request(app).post('/api/auth/register').send(userData);
          |                                                                              ^
      338 |
      339 |       // Extract access token from cookies
      340 |       const cookies = registerResponse.headers['set-cookie'];

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/auth.test.mjs:337:78)

  ● �� INTEGRATION: Authentication System - User Registration & Session Management › GET /api/auth/me › should reject profile request with invalid token

    TypeError: mime.getType is not a function

      335 |       });
      336 |
    > 337 |       const registerResponse = await request(app).post('/api/auth/register').send(userData);
          |                                                                              ^
      338 |
      339 |       // Extract access token from cookies
      340 |       const cookies = registerResponse.headers['set-cookie'];

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/auth.test.mjs:337:78)

  ● �� INTEGRATION: Authentication System - User Registration & Session Management › POST /api/auth/logout › should logout successfully with valid token

    TypeError: mime.getType is not a function

      379 |       });
      380 |
    > 381 |       const registerResponse = await request(app).post('/api/auth/register').send(userData);
          |                                                                              ^
      382 |
      383 |       // Extract access token from cookies
      384 |       const cookies = registerResponse.headers['set-cookie'];

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/auth.test.mjs:381:78)

  ● �� INTEGRATION: Authentication System - User Registration & Session Management › POST /api/auth/logout › should reject logout without token

    TypeError: mime.getType is not a function

      379 |       });
      380 |
    > 381 |       const registerResponse = await request(app).post('/api/auth/register').send(userData);
          |                                                                              ^
      382 |
      383 |       // Extract access token from cookies
      384 |       const cookies = registerResponse.headers['set-cookie'];

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:350:38)
      at Test.type (node_modules/superagent/src/request-base.js:666:19)
      at Object.<anonymous> (tests/auth.test.mjs:381:78)

 FAIL  backend/tests/resultModel.test.mjs
  ● �� UNIT: Result Model - Competition Result Management › saveResult › should save a competition result with all required fields

    Database error in saveResult:
    Invalid `prisma.competitionResult.create()` invocation:


    Foreign key constraint violated on the constraint: `competition_results_horseId_fkey`

      128 |   } catch (error) {
      129 |     logger.error('[resultModel.saveResult] Database error: %o', error);
    > 130 |     throw new Error(`Database error in saveResult: ${error.message}`);
          |           ^
      131 |   }
      132 | }
      133 |

      at saveResult (models/resultModel.mjs:130:11)
      at Object.<anonymous> (tests/resultModel.test.mjs:105:22)

  ● �� UNIT: Result Model - Competition Result Management › saveResult › should save a result without placement (null for non-top-3)

    Database error in saveResult:
    Invalid `prisma.competitionResult.create()` invocation:


    Foreign key constraint violated on the constraint: `competition_results_horseId_fkey`

      128 |   } catch (error) {
      129 |     logger.error('[resultModel.saveResult] Database error: %o', error);
    > 130 |     throw new Error(`Database error in saveResult: ${error.message}`);
          |           ^
      131 |   }
      132 | }
      133 |

      at saveResult (models/resultModel.mjs:130:11)
      at Object.<anonymous> (tests/resultModel.test.mjs:146:22)

  ● �� UNIT: Result Model - Competition Result Management › saveResult › should handle prizeWon as string and convert to float

    Database error in saveResult:
    Invalid `prisma.competitionResult.create()` invocation:


    Foreign key constraint violated on the constraint: `competition_results_horseId_fkey`

      128 |   } catch (error) {
      129 |     logger.error('[resultModel.saveResult] Database error: %o', error);
    > 130 |     throw new Error(`Database error in saveResult: ${error.message}`);
          |           ^
      131 |   }
      132 | }
      133 |

      at saveResult (models/resultModel.mjs:130:11)
      at Object.<anonymous> (tests/resultModel.test.mjs:329:7)

  ● �� UNIT: Result Model - Competition Result Management › saveResult › should handle database errors gracefully

    expect(received).rejects.toThrow(expected)

    Expected substring: "Database error in saveResult: Database connection failed"
    Received message:   "Database error in saveResult:·
    Invalid `prisma.competitionResult.create()` invocation:··
    Foreign key constraint violated on the constraint: `competition_results_horseId_fkey`"

          128 |   } catch (error) {
          129 |     logger.error('[resultModel.saveResult] Database error: %o', error);
        > 130 |     throw new Error(`Database error in saveResult: ${error.message}`);
              |           ^
          131 |   }
          132 | }
          133 |

          at saveResult (backend/models/resultModel.mjs:130:11)
          at Object.<anonymous> (backend/tests/resultModel.test.mjs:352:7)

      350 |       mockPrisma.competitionResult.create.mockRejectedValue(new Error('Database connection failed'));
      351 |
    > 352 |       await expect(saveResult(resultData)).rejects.toThrow('Database error in saveResult: Database connection failed');
          |                                                    ^
      353 |     });
      354 |
      355 |     it('should update existing placeholder result instead of creating new one', async () => {

      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (tests/resultModel.test.mjs:352:52)

  ● �� UNIT: Result Model - Competition Result Management › saveResult › should update existing placeholder result instead of creating new one

    Database error in saveResult:
    Invalid `prisma.competitionResult.create()` invocation:


    Foreign key constraint violated on the constraint: `competition_results_horseId_fkey`

      128 |   } catch (error) {
      129 |     logger.error('[resultModel.saveResult] Database error: %o', error);
    > 130 |     throw new Error(`Database error in saveResult: ${error.message}`);
          |           ^
      131 |   }
      132 | }
      133 |

      at saveResult (models/resultModel.mjs:130:11)
      at Object.<anonymous> (tests/resultModel.test.mjs:390:22)

  ● �� UNIT: Result Model - Competition Result Management › saveResult › should create new result when no placeholder exists

    Database error in saveResult:
    Invalid `prisma.competitionResult.create()` invocation:


    Foreign key constraint violated on the constraint: `competition_results_horseId_fkey`

      128 |   } catch (error) {
      129 |     logger.error('[resultModel.saveResult] Database error: %o', error);
    > 130 |     throw new Error(`Database error in saveResult: ${error.message}`);
          |           ^
      131 |   }
      132 | }
      133 |

      at saveResult (models/resultModel.mjs:130:11)
      at Object.<anonymous> (tests/resultModel.test.mjs:447:22)

  ● �� UNIT: Result Model - Competition Result Management › getResultsByHorse › should retrieve all results for a specific horse

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 1
    Received number of calls: 0

      517 |       const results = await getResultsByHorse(horseId);
      518 |
    > 519 |       expect(mockPrisma.competitionResult.findMany).toHaveBeenCalledTimes(1);
          |                                                     ^
      520 |       expect(mockPrisma.competitionResult.findMany).toHaveBeenCalledWith({
      521 |         where: { horseId: 1 },
      522 |         include: {

      at Object.<anonymous> (tests/resultModel.test.mjs:519:53)

  ● �� UNIT: Result Model - Competition Result Management › getResultsByHorse › should handle database errors gracefully

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: []

      551 |       mockPrisma.competitionResult.findMany.mockRejectedValue(new Error('Database connection failed'));
      552 |
    > 553 |       await expect(getResultsByHorse(1)).rejects.toThrow(
          |             ^
      554 |         'Database error in getResultsByHorse: Database connection failed',
      555 |       );
      556 |     });

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/resultModel.test.mjs:553:13)

  ● �� UNIT: Result Model - Competition Result Management › getResultsByShow › should retrieve all results for a specific show

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 1
    Received number of calls: 0

      589 |       const results = await getResultsByShow(showId);
      590 |
    > 591 |       expect(mockPrisma.competitionResult.findMany).toHaveBeenCalledTimes(1);
          |                                                     ^
      592 |       expect(mockPrisma.competitionResult.findMany).toHaveBeenCalledWith({
      593 |         where: { showId: 2 },
      594 |         include: {

      at Object.<anonymous> (tests/resultModel.test.mjs:591:53)

  ● �� UNIT: Result Model - Competition Result Management › getResultsByShow › should handle database errors gracefully

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: []

      623 |       mockPrisma.competitionResult.findMany.mockRejectedValue(new Error('Database connection failed'));
      624 |
    > 625 |       await expect(getResultsByShow(1)).rejects.toThrow(
          |             ^
      626 |         'Database error in getResultsByShow: Database connection failed',
      627 |       );
      628 |     });

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/resultModel.test.mjs:625:13)

  ● �� UNIT: Result Model - Competition Result Management › getResultById › should retrieve a specific result by ID

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 1
    Received number of calls: 0

      648 |       const result = await getResultById(resultId);
      649 |
    > 650 |       expect(mockPrisma.competitionResult.findUnique).toHaveBeenCalledTimes(1);
          |                                                       ^
      651 |       expect(mockPrisma.competitionResult.findUnique).toHaveBeenCalledWith({
      652 |         where: { id: 1 },
      653 |         include: {

      at Object.<anonymous> (tests/resultModel.test.mjs:650:55)

  ● �� UNIT: Result Model - Competition Result Management › getResultById › should handle database errors gracefully

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: null

      681 |       mockPrisma.competitionResult.findUnique.mockRejectedValue(new Error('Database connection failed'));
      682 |
    > 683 |       await expect(getResultById(1)).rejects.toThrow('Database error in getResultById: Database connection failed');
          |             ^
      684 |     });
      685 |   });
      686 |

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/resultModel.test.mjs:683:13)

  ● �� UNIT: Result Model - Competition Result Management › createResult › should be an alias for saveResult and work identically

    Database error in saveResult:
    Invalid `prisma.competitionResult.create()` invocation:


    Foreign key constraint violated on the constraint: `competition_results_horseId_fkey`

      128 |   } catch (error) {
      129 |     logger.error('[resultModel.saveResult] Database error: %o', error);
    > 130 |     throw new Error(`Database error in saveResult: ${error.message}`);
          |           ^
      131 |   }
      132 | }
      133 |

      at saveResult (models/resultModel.mjs:130:11)
      at createResult (models/resultModel.mjs:248:10)
      at Object.<anonymous> (tests/resultModel.test.mjs:702:22)

  ● �� UNIT: Result Model - Competition Result Management › getResultsByUser › should retrieve results for all user horses with default options

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"include": {"horse": {"include": {"breed": true}}, "show": true}, "orderBy": {"runDate": "desc"}, "skip": 0, "take": 50, "where": {"horse": {"userId": "user123"}}}

    Number of calls: 0

      736 |       const results = await getResultsByUser(userId);
      737 |
    > 738 |       expect(mockPrisma.competitionResult.findMany).toHaveBeenCalledWith({
          |                                                     ^
      739 |         where: {
      740 |           horse: {
      741 |             userId: 'user123',

      at Object.<anonymous> (tests/resultModel.test.mjs:738:53)

  ● �� UNIT: Result Model - Competition Result Management › getResultsByUser › should handle custom options (limit, offset, discipline)

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"include": Any<Object>, "orderBy": {"runDate": "desc"}, "skip": 5, "take": 10, "where": {"discipline": "Racing", "horse": {"userId": "user123"}}}

    Number of calls: 0

      767 |       await getResultsByUser(userId, options);
      768 |
    > 769 |       expect(mockPrisma.competitionResult.findMany).toHaveBeenCalledWith({
          |                                                     ^
      770 |         where: {
      771 |           horse: {
      772 |             userId: 'user123',

      at Object.<anonymous> (tests/resultModel.test.mjs:769:53)

  ● �� UNIT: Result Model - Competition Result Management › getResultsByUser › should cap limit at 100 and ensure non-negative offset

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"skip": 0, "take": 100}

    Number of calls: 0

      789 |       await getResultsByUser(userId, options);
      790 |
    > 791 |       expect(mockPrisma.competitionResult.findMany).toHaveBeenCalledWith(
          |                                                     ^
      792 |         expect.objectContaining({
      793 |           take: 100, // Capped at 100
      794 |           skip: 0, // Non-negative

      at Object.<anonymous> (tests/resultModel.test.mjs:791:53)

  ● �� UNIT: Result Model - Competition Result Management › getResultsByUser › should handle database errors gracefully

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: []

      800 |       mockPrisma.competitionResult.findMany.mockRejectedValue(new Error('Database error'));
      801 |
    > 802 |       await expect(getResultsByUser('user123')).rejects.toThrow('Database error');
          |             ^
      803 |     });
      804 |   });
      805 |

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/resultModel.test.mjs:802:13)

  ● �� UNIT: Result Model - Competition Result Management › parseInt conversion edge cases › should handle string IDs in getResultsByHorse

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"horseId": 123}}

    Number of calls: 0

      810 |       await getResultsByHorse('123'); // String ID
      811 |
    > 812 |       expect(mockPrisma.competitionResult.findMany).toHaveBeenCalledWith(
          |                                                     ^
      813 |         expect.objectContaining({
      814 |           where: { horseId: 123 }, // Should be converted to number
      815 |         }),

      at Object.<anonymous> (tests/resultModel.test.mjs:812:53)

  ● �� UNIT: Result Model - Competition Result Management › parseInt conversion edge cases › should handle string IDs in getResultsByShow

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"showId": 456}}

    Number of calls: 0

      822 |       await getResultsByShow('456'); // String ID
      823 |
    > 824 |       expect(mockPrisma.competitionResult.findMany).toHaveBeenCalledWith(
          |                                                     ^
      825 |         expect.objectContaining({
      826 |           where: { showId: 456 }, // Should be converted to number
      827 |         }),

      at Object.<anonymous> (tests/resultModel.test.mjs:824:53)

  ● �� UNIT: Result Model - Competition Result Management › parseInt conversion edge cases › should handle string IDs in getResultById

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"id": 789}}

    Number of calls: 0

      834 |       await getResultById('789'); // String ID
      835 |
    > 836 |       expect(mockPrisma.competitionResult.findUnique).toHaveBeenCalledWith(
          |                                                       ^
      837 |         expect.objectContaining({
      838 |           where: { id: 789 }, // Should be converted to number
      839 |         }),

      at Object.<anonymous> (tests/resultModel.test.mjs:836:55)

 FAIL  backend/tests/foalTaskLogStreakIntegration.test.mjs
  ● Foal Task Log and Streak Data Integration › Real-World Foal Development Scenarios › should handle week 1 of foal care with enrichment tasks

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      59 |
      60 |     // Create test foal
    > 61 |     testFoal = await prisma.horse.create({
         |                ^
      62 |       data: {
      63 |         name: 'Test Foal Integration',
      64 |         sex: 'Filly',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/foalTaskLogStreakIntegration.test.mjs:61:16)

  ● Foal Task Log and Streak Data Integration › Task Log and Trait Evaluation Integration › should track task progression over time

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.update()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor an update.

      228 |       // Week 1: Enrichment focus
      229 |       let taskLog = { trust_building: 3, desensitization: 2 };
    > 230 |       await prisma.horse.update({
          |       ^
      231 |         where: { id: testFoal.id },
      232 |         data: { taskLog },
      233 |       });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/foalTaskLogStreakIntegration.test.mjs:230:7)

  ● Foal Task Log and Streak Data Integration › Grace Period and Streak Maintenance › should maintain streak within 2-day grace period

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.update()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor an update.

      288 |
      289 |       careData = updateFoalCareData(foal, 'desensitization', day3);
    > 290 |       await prisma.horse.update({
          |       ^
      291 |         where: { id: testFoal.id },
      292 |         data: careData,
      293 |       });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/foalTaskLogStreakIntegration.test.mjs:290:7)

  ● Foal Task Log and Streak Data Integration › Grace Period and Streak Maintenance › should break streak beyond grace period

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No 'User' record (needed to inline the relation on 'Horse' record(s)) was found for a nested connect on one-to-many relation 'HorseToUser'.

      59 |
      60 |     // Create test foal
    > 61 |     testFoal = await prisma.horse.create({
         |                ^
      62 |       data: {
      63 |         name: 'Test Foal Integration',
      64 |         sex: 'Filly',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/foalTaskLogStreakIntegration.test.mjs:61:16)

  ● Foal Task Log and Streak Data Integration › Care Summary Statistics › should provide comprehensive care statistics

    TypeError: Cannot read properties of null (reading 'taskLog')

      258 | export function getFoalCareSummary(foalData) {
      259 |   try {
    > 260 |     const taskLog = foalData.taskLog || {};
          |                              ^
      261 |     const totalTasks = getTotalTaskCount(taskLog);
      262 |     const completedTaskTypes = getCompletedTasks(taskLog);
      263 |     const consecutiveDays = foalData.daysGroomedInARow || 0;

      at getFoalCareSummary (utils/foalTaskLogManager.mjs:260:30)
      at Object.<anonymous> (tests/foalTaskLogStreakIntegration.test.mjs:356:23)

 FAIL  backend/tests/breedingPrediction.test.mjs
  ● Breeding Prediction System › Inheritance Probability Logic › should calculate trait inheritance probabilities from parent history

    PrismaClientKnownRequestError:
    Invalid `prisma.traitHistoryLog.create()` invocation:


    Foreign key constraint violated on the constraint: `trait_history_logs_horseId_fkey`

      138 |
      139 |       for (const trait of stallionTraits) {
    > 140 |         await prisma.traitHistoryLog.create({
          |         ^
      141 |           data: {
      142 |             horseId: testStallion.id,
      143 |             traitName: trait.traitName,

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/breedingPrediction.test.mjs:140:9)

  ● Breeding Prediction System › Inheritance Probability Logic › should calculate trait inheritance probabilities from parent history

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

      112 |     // Clean up test data
      113 |     if (testStallion) {
    > 114 |       await prisma.horse.delete({ where: { id: testStallion.id } });
          |       ^
      115 |     }
      116 |     if (testMare) {
      117 |       await prisma.horse.delete({ where: { id: testMare.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/breedingPrediction.test.mjs:114:7)

  ● Breeding Prediction System › Inheritance Probability Logic › should calculate flag inheritance scores

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

      112 |     // Clean up test data
      113 |     if (testStallion) {
    > 114 |       await prisma.horse.delete({ where: { id: testStallion.id } });
          |       ^
      115 |     }
      116 |     if (testMare) {
      117 |       await prisma.horse.delete({ where: { id: testMare.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/breedingPrediction.test.mjs:114:7)

  ● Breeding Prediction System › Inheritance Probability Logic › should handle horses with no trait history

    PrismaClientKnownRequestError:
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

      121 |     }
      122 |     if (testUser) {
    > 123 |       await prisma.user.delete({ where: { id: testUser.id } });
          |       ^
      124 |     }
      125 |     if (testBreed) {
      126 |       await prisma.breed.delete({ where: { id: testBreed.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/breedingPrediction.test.mjs:123:7)

  ● Breeding Prediction System › Inheritance Probability Logic › should calculate temperament influence modifiers

    PrismaClientKnownRequestError:
    Invalid `prisma.traitHistoryLog.create()` invocation:


    Foreign key constraint violated on the constraint: `trait_history_logs_horseId_fkey`

      254 |     it('should calculate temperament influence modifiers', async () => {
      255 |       // Create trait history with temperament-related traits
    > 256 |       await prisma.traitHistoryLog.create({
          |       ^
      257 |         data: {
      258 |           horseId: testStallion.id,
      259 |           traitName: 'bold',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/breedingPrediction.test.mjs:256:7)

  ● Breeding Prediction System › Inheritance Probability Logic › should calculate temperament influence modifiers

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

      112 |     // Clean up test data
      113 |     if (testStallion) {
    > 114 |       await prisma.horse.delete({ where: { id: testStallion.id } });
          |       ^
      115 |     }
      116 |     if (testMare) {
      117 |       await prisma.horse.delete({ where: { id: testMare.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/breedingPrediction.test.mjs:114:7)

  ● Breeding Prediction System › Child Prediction Algorithms › should predict trait categories with probability ranges

    PrismaClientKnownRequestError:
    Invalid `prisma.traitHistoryLog.create()` invocation:


    Foreign key constraint violated on the constraint: `trait_history_logs_horseId_fkey`

      307 |
      308 |       for (const trait of parentTraits) {
    > 309 |         await prisma.traitHistoryLog.create({
          |         ^
      310 |           data: {
      311 |             horseId: trait.horseId,
      312 |             traitName: trait.traitName,

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/breedingPrediction.test.mjs:309:9)

  ● Breeding Prediction System › Child Prediction Algorithms › should predict trait categories with probability ranges

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

      112 |     // Clean up test data
      113 |     if (testStallion) {
    > 114 |       await prisma.horse.delete({ where: { id: testStallion.id } });
          |       ^
      115 |     }
      116 |     if (testMare) {
      117 |       await prisma.horse.delete({ where: { id: testMare.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/breedingPrediction.test.mjs:114:7)

  ● Breeding Prediction System › Child Prediction Algorithms › should handle epigenetic flag inheritance with stacking limits

    PrismaClientKnownRequestError:
    Invalid `prisma.traitHistoryLog.create()` invocation:


    Foreign key constraint violated on the constraint: `trait_history_logs_horseId_fkey`

      344 |
      345 |       for (const traitName of matchingTraits) {
    > 346 |         await prisma.traitHistoryLog.create({
          |         ^
      347 |           data: {
      348 |             horseId: testStallion.id,
      349 |             traitName,

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/breedingPrediction.test.mjs:346:9)

  ● Breeding Prediction System › Child Prediction Algorithms › should handle epigenetic flag inheritance with stacking limits

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

      112 |     // Clean up test data
      113 |     if (testStallion) {
    > 114 |       await prisma.horse.delete({ where: { id: testStallion.id } });
          |       ^
      115 |     }
      116 |     if (testMare) {
      117 |       await prisma.horse.delete({ where: { id: testMare.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/breedingPrediction.test.mjs:114:7)

  ● Breeding Prediction System › API Extension › should extend breeding-data endpoint with prediction data

    PrismaClientKnownRequestError:
    Invalid `prisma.traitHistoryLog.create()` invocation:


    Foreign key constraint violated on the constraint: `trait_history_logs_horseId_fkey`

      389 |     it('should extend breeding-data endpoint with prediction data', async () => {
      390 |       // Create some trait history
    > 391 |       await prisma.traitHistoryLog.create({
          |       ^
      392 |         data: {
      393 |           horseId: testStallion.id,
      394 |           traitName: 'noble',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/breedingPrediction.test.mjs:391:7)

  ● Breeding Prediction System › API Extension › should extend breeding-data endpoint with prediction data

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

      112 |     // Clean up test data
      113 |     if (testStallion) {
    > 114 |       await prisma.horse.delete({ where: { id: testStallion.id } });
          |       ^
      115 |     }
      116 |     if (testMare) {
      117 |       await prisma.horse.delete({ where: { id: testMare.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/breedingPrediction.test.mjs:114:7)

  ● Breeding Prediction System › API Extension › should require authentication for breeding-data endpoint

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      56 |
      57 |     // Create test groom
    > 58 |     testGroom = await prisma.groom.create({
         |                 ^
      59 |       data: {
      60 |         name: `TestGroom_${Date.now()}`,
      61 |         speciality: 'foal_care',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/breedingPrediction.test.mjs:58:17)

  ● Breeding Prediction System › API Extension › should require authentication for breeding-data endpoint

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

      112 |     // Clean up test data
      113 |     if (testStallion) {
    > 114 |       await prisma.horse.delete({ where: { id: testStallion.id } });
          |       ^
      115 |     }
      116 |     if (testMare) {
      117 |       await prisma.horse.delete({ where: { id: testMare.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/breedingPrediction.test.mjs:114:7)

  ● Breeding Prediction System › API Extension › should handle horses with minimal breeding data

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

      112 |     // Clean up test data
      113 |     if (testStallion) {
    > 114 |       await prisma.horse.delete({ where: { id: testStallion.id } });
          |       ^
      115 |     }
      116 |     if (testMare) {
      117 |       await prisma.horse.delete({ where: { id: testMare.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/breedingPrediction.test.mjs:114:7)

 FAIL  backend/tests/services/groomRetirementService.test.mjs
  ● Groom Retirement Service › Career Week Tracking › should increment career weeks correctly

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      56 |   beforeEach(async () => {
      57 |     // Create fresh test groom for each test
    > 58 |     testGroom = await prisma.groom.create({
         |                 ^
      59 |       data: {
      60 |         name: `Test Groom ${Date.now()}`,
      61 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomRetirementService.test.mjs:58:17)

  ● Groom Retirement Service › Career Week Tracking › should handle multiple career week increments

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      56 |   beforeEach(async () => {
      57 |     // Create fresh test groom for each test
    > 58 |     testGroom = await prisma.groom.create({
         |                 ^
      59 |       data: {
      60 |         name: `Test Groom ${Date.now()}`,
      61 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomRetirementService.test.mjs:58:17)

  ● Groom Retirement Service › Career Week Tracking › should throw error for non-existent groom

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      56 |   beforeEach(async () => {
      57 |     // Create fresh test groom for each test
    > 58 |     testGroom = await prisma.groom.create({
         |                 ^
      59 |       data: {
      60 |         name: `Test Groom ${Date.now()}`,
      61 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomRetirementService.test.mjs:58:17)

  ● Groom Retirement Service › Retirement Eligibility › should identify groom not eligible for retirement

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      56 |   beforeEach(async () => {
      57 |     // Create fresh test groom for each test
    > 58 |     testGroom = await prisma.groom.create({
         |                 ^
      59 |       data: {
      60 |         name: `Test Groom ${Date.now()}`,
      61 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomRetirementService.test.mjs:58:17)

  ● Groom Retirement Service › Retirement Eligibility › should identify mandatory retirement at 104 weeks

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      56 |   beforeEach(async () => {
      57 |     // Create fresh test groom for each test
    > 58 |     testGroom = await prisma.groom.create({
         |                 ^
      59 |       data: {
      60 |         name: `Test Groom ${Date.now()}`,
      61 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomRetirementService.test.mjs:58:17)

  ● Groom Retirement Service › Retirement Eligibility › should identify early retirement at level 10

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      56 |   beforeEach(async () => {
      57 |     // Create fresh test groom for each test
    > 58 |     testGroom = await prisma.groom.create({
         |                 ^
      59 |       data: {
      60 |         name: `Test Groom ${Date.now()}`,
      61 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomRetirementService.test.mjs:58:17)

  ● Groom Retirement Service › Retirement Eligibility › should identify early retirement with 12+ assignments

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      56 |   beforeEach(async () => {
      57 |     // Create fresh test groom for each test
    > 58 |     testGroom = await prisma.groom.create({
         |                 ^
      59 |       data: {
      60 |         name: `Test Groom ${Date.now()}`,
      61 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomRetirementService.test.mjs:58:17)

  ● Groom Retirement Service › Retirement Eligibility › should identify retirement notice period

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      56 |   beforeEach(async () => {
      57 |     // Create fresh test groom for each test
    > 58 |     testGroom = await prisma.groom.create({
         |                 ^
      59 |       data: {
      60 |         name: `Test Groom ${Date.now()}`,
      61 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomRetirementService.test.mjs:58:17)

  ● Groom Retirement Service › Retirement Eligibility › should handle already retired groom

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      56 |   beforeEach(async () => {
      57 |     // Create fresh test groom for each test
    > 58 |     testGroom = await prisma.groom.create({
         |                 ^
      59 |       data: {
      60 |         name: `Test Groom ${Date.now()}`,
      61 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomRetirementService.test.mjs:58:17)

  ● Groom Retirement Service › Retirement Processing › should process mandatory retirement correctly

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      56 |   beforeEach(async () => {
      57 |     // Create fresh test groom for each test
    > 58 |     testGroom = await prisma.groom.create({
         |                 ^
      59 |       data: {
      60 |         name: `Test Groom ${Date.now()}`,
      61 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomRetirementService.test.mjs:58:17)

  ● Groom Retirement Service › Retirement Processing › should process voluntary retirement

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      56 |   beforeEach(async () => {
      57 |     // Create fresh test groom for each test
    > 58 |     testGroom = await prisma.groom.create({
         |                 ^
      59 |       data: {
      60 |         name: `Test Groom ${Date.now()}`,
      61 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomRetirementService.test.mjs:58:17)

  ● Groom Retirement Service › Retirement Processing › should remove active assignments on retirement

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      56 |   beforeEach(async () => {
      57 |     // Create fresh test groom for each test
    > 58 |     testGroom = await prisma.groom.create({
         |                 ^
      59 |       data: {
      60 |         name: `Test Groom ${Date.now()}`,
      61 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomRetirementService.test.mjs:58:17)

  ● Groom Retirement Service › Retirement Processing › should reject retirement for ineligible groom

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      56 |   beforeEach(async () => {
      57 |     // Create fresh test groom for each test
    > 58 |     testGroom = await prisma.groom.create({
         |                 ^
      59 |       data: {
      60 |         name: `Test Groom ${Date.now()}`,
      61 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomRetirementService.test.mjs:58:17)

  ● Groom Retirement Service › Weekly Career Progression › should process weekly career progression for all active grooms

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      56 |   beforeEach(async () => {
      57 |     // Create fresh test groom for each test
    > 58 |     testGroom = await prisma.groom.create({
         |                 ^
      59 |       data: {
      60 |         name: `Test Groom ${Date.now()}`,
      61 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomRetirementService.test.mjs:58:17)

  ● Groom Retirement Service › Weekly Career Progression › should handle errors gracefully during weekly progression

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      56 |   beforeEach(async () => {
      57 |     // Create fresh test groom for each test
    > 58 |     testGroom = await prisma.groom.create({
         |                 ^
      59 |       data: {
      60 |         name: `Test Groom ${Date.now()}`,
      61 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomRetirementService.test.mjs:58:17)

  ● Groom Retirement Service › Weekly Career Progression › should skip already retired grooms

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      56 |   beforeEach(async () => {
      57 |     // Create fresh test groom for each test
    > 58 |     testGroom = await prisma.groom.create({
         |                 ^
      59 |       data: {
      60 |         name: `Test Groom ${Date.now()}`,
      61 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomRetirementService.test.mjs:58:17)

  ● Groom Retirement Service › Weekly Career Progression › should provide detailed statistics

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      56 |   beforeEach(async () => {
      57 |     // Create fresh test groom for each test
    > 58 |     testGroom = await prisma.groom.create({
         |                 ^
      59 |       data: {
      60 |         name: `Test Groom ${Date.now()}`,
      61 |         personality: 'calm',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomRetirementService.test.mjs:58:17)


  ● Test suite failed to run

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

       96 |     // Clean up test data
       97 |     if (testHorse) {
    >  98 |       await prisma.horse.delete({
          |       ^
       99 |         where: { id: testHorse.id },
      100 |       });
      101 |     }

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomRetirementService.test.mjs:98:7)

 FAIL  backend/tests/services/groomPersonalityTraits.test.mjs
  ● Groom Personality Trait System › getGroomPersonalityTraits › should return detailed personality traits for calm groom

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      44 |
      45 |     // Create test grooms with different personalities and experience levels
    > 46 |     testGrooms = await Promise.all([
         |                  ^
      47 |       // Calm personality groom
      48 |       prisma.groom.create({
      49 |         data: {

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
          at async Promise.all (index 2)
      at Object.<anonymous> (tests/services/groomPersonalityTraits.test.mjs:46:18)

  ● Groom Personality Trait System › getGroomPersonalityTraits › should return detailed personality traits for energetic groom

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      44 |
      45 |     // Create test grooms with different personalities and experience levels
    > 46 |     testGrooms = await Promise.all([
         |                  ^
      47 |       // Calm personality groom
      48 |       prisma.groom.create({
      49 |         data: {

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
          at async Promise.all (index 2)
      at Object.<anonymous> (tests/services/groomPersonalityTraits.test.mjs:46:18)

  ● Groom Personality Trait System › getGroomPersonalityTraits › should return detailed personality traits for methodical groom

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      44 |
      45 |     // Create test grooms with different personalities and experience levels
    > 46 |     testGrooms = await Promise.all([
         |                  ^
      47 |       // Calm personality groom
      48 |       prisma.groom.create({
      49 |         data: {

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
          at async Promise.all (index 2)
      at Object.<anonymous> (tests/services/groomPersonalityTraits.test.mjs:46:18)

  ● Groom Personality Trait System › calculatePersonalityModifiers › should calculate modifiers for calm groom with nervous horse

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      44 |
      45 |     // Create test grooms with different personalities and experience levels
    > 46 |     testGrooms = await Promise.all([
         |                  ^
      47 |       // Calm personality groom
      48 |       prisma.groom.create({
      49 |         data: {

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
          at async Promise.all (index 2)
      at Object.<anonymous> (tests/services/groomPersonalityTraits.test.mjs:46:18)

  ● Groom Personality Trait System › calculatePersonalityModifiers › should calculate modifiers for energetic groom with confident horse

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      44 |
      45 |     // Create test grooms with different personalities and experience levels
    > 46 |     testGrooms = await Promise.all([
         |                  ^
      47 |       // Calm personality groom
      48 |       prisma.groom.create({
      49 |         data: {

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
          at async Promise.all (index 2)
      at Object.<anonymous> (tests/services/groomPersonalityTraits.test.mjs:46:18)

  ● Groom Personality Trait System › calculatePersonalityModifiers › should calculate modifiers for energetic groom with nervous horse

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      44 |
      45 |     // Create test grooms with different personalities and experience levels
    > 46 |     testGrooms = await Promise.all([
         |                  ^
      47 |       // Calm personality groom
      48 |       prisma.groom.create({
      49 |         data: {

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
          at async Promise.all (index 2)
      at Object.<anonymous> (tests/services/groomPersonalityTraits.test.mjs:46:18)

  ● Groom Personality Trait System › calculatePersonalityModifiers › should calculate modifiers for methodical groom with any horse

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      44 |
      45 |     // Create test grooms with different personalities and experience levels
    > 46 |     testGrooms = await Promise.all([
         |                  ^
      47 |       // Calm personality groom
      48 |       prisma.groom.create({
      49 |         data: {

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
          at async Promise.all (index 2)
      at Object.<anonymous> (tests/services/groomPersonalityTraits.test.mjs:46:18)

  ● Groom Personality Trait System › analyzePersonalityCompatibility › should analyze compatibility between groom and horse personalities

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      44 |
      45 |     // Create test grooms with different personalities and experience levels
    > 46 |     testGrooms = await Promise.all([
         |                  ^
      47 |       // Calm personality groom
      48 |       prisma.groom.create({
      49 |         data: {

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
          at async Promise.all (index 2)
      at Object.<anonymous> (tests/services/groomPersonalityTraits.test.mjs:46:18)

  ● Groom Personality Trait System › analyzePersonalityCompatibility › should identify poor compatibility combinations

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      44 |
      45 |     // Create test grooms with different personalities and experience levels
    > 46 |     testGrooms = await Promise.all([
         |                  ^
      47 |       // Calm personality groom
      48 |       prisma.groom.create({
      49 |         data: {

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
          at async Promise.all (index 2)
      at Object.<anonymous> (tests/services/groomPersonalityTraits.test.mjs:46:18)

  ● Groom Personality Trait System › updatePersonalityTraits › should update personality traits based on interaction outcomes

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      44 |
      45 |     // Create test grooms with different personalities and experience levels
    > 46 |     testGrooms = await Promise.all([
         |                  ^
      47 |       // Calm personality groom
      48 |       prisma.groom.create({
      49 |         data: {

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
          at async Promise.all (index 2)
      at Object.<anonymous> (tests/services/groomPersonalityTraits.test.mjs:46:18)

  ● Groom Personality Trait System › getPersonalityTraitDefinitions › should return comprehensive trait definitions

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      44 |
      45 |     // Create test grooms with different personalities and experience levels
    > 46 |     testGrooms = await Promise.all([
         |                  ^
      47 |       // Calm personality groom
      48 |       prisma.groom.create({
      49 |         data: {

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
          at async Promise.all (index 2)
      at Object.<anonymous> (tests/services/groomPersonalityTraits.test.mjs:46:18)


  ● Test suite failed to run

    PrismaClientKnownRequestError:
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

      147 |       where: { id: { in: testHorses.map(h => h.id) } },
      148 |     });
    > 149 |     await prisma.user.delete({ where: { id: testUser.id } });
          |     ^
      150 |   });
      151 |
      152 |   describe('getGroomPersonalityTraits', () => {

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/groomPersonalityTraits.test.mjs:149:5)

 FAIL  backend/tests/unit/flagEvaluationEngine.test.mjs
  ● Flag Evaluation Engine › evaluateHorseFlags › should evaluate and assign flags for eligible horse

    Horse with ID 1 not found

      49 |
      50 |     if (!horse) {
    > 51 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      52 |     }
      53 |
      54 |     // Check age eligibility

      at evaluateHorseFlags (utils/flagEvaluationEngine.mjs:51:13)
      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:124:22)

  ● Flag Evaluation Engine › evaluateHorseFlags › should reject horse outside age range

    Horse with ID 1 not found

      49 |
      50 |     if (!horse) {
    > 51 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      52 |     }
      53 |
      54 |     // Check age eligibility

      at evaluateHorseFlags (utils/flagEvaluationEngine.mjs:51:13)
      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:147:22)

  ● Flag Evaluation Engine › evaluateHorseFlags › should reject horse with maximum flags

    Horse with ID 1 not found

      49 |
      50 |     if (!horse) {
    > 51 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      52 |     }
      53 |
      54 |     // Check age eligibility

      at evaluateHorseFlags (utils/flagEvaluationEngine.mjs:51:13)
      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:162:22)

  ● Flag Evaluation Engine › evaluateHorseFlags › should not assign duplicate flags

    Horse with ID 1 not found

      49 |
      50 |     if (!horse) {
    > 51 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      52 |     }
      53 |
      54 |     // Check age eligibility

      at evaluateHorseFlags (utils/flagEvaluationEngine.mjs:51:13)
      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:180:22)

  ● Flag Evaluation Engine › evaluateHorseFlags › should respect flag limit during assignment

    Horse with ID 1 not found

      49 |
      50 |     if (!horse) {
    > 51 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      52 |     }
      53 |
      54 |     // Check age eligibility

      at evaluateHorseFlags (utils/flagEvaluationEngine.mjs:51:13)
      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:210:22)

  ● Flag Evaluation Engine › evaluateHorseFlags › should handle care analysis ineligibility

    Horse with ID 1 not found

      49 |
      50 |     if (!horse) {
    > 51 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      52 |     }
      53 |
      54 |     // Check age eligibility

      at evaluateHorseFlags (utils/flagEvaluationEngine.mjs:51:13)
      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:224:22)

  ● Flag Evaluation Engine › evaluateHorseFlags › should handle database errors

    expect(received).rejects.toThrow(expected)

    Expected substring: "Database error"
    Received message:   "Horse with ID 1 not found"

          49 |
          50 |     if (!horse) {
        > 51 |       throw new Error(`Horse with ID ${horseId} not found`);
             |             ^
          52 |     }
          53 |
          54 |     // Check age eligibility

          at evaluateHorseFlags (backend/utils/flagEvaluationEngine.mjs:51:13)
          at Object.<anonymous> (backend/tests/unit/flagEvaluationEngine.test.mjs:241:7)

      239 |       mockPrisma.horse.findUnique.mockRejectedValue(new Error('Database error'));
      240 |
    > 241 |       await expect(evaluateHorseFlags(1)).rejects.toThrow('Database error');
          |                                                   ^
      242 |     });
      243 |   });
      244 |

      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:241:51)

  ● Flag Evaluation Engine › Flag Trigger Evaluation › should trigger brave flag with correct conditions

    Horse with ID 1 not found

      49 |
      50 |     if (!horse) {
    > 51 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      52 |     }
      53 |
      54 |     // Check age eligibility

      at evaluateHorseFlags (utils/flagEvaluationEngine.mjs:51:13)
      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:278:22)

  ● Flag Evaluation Engine › Flag Trigger Evaluation › should trigger fearful flag with correct conditions

    Horse with ID 1 not found

      49 |
      50 |     if (!horse) {
    > 51 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      52 |     }
      53 |
      54 |     // Check age eligibility

      at evaluateHorseFlags (utils/flagEvaluationEngine.mjs:51:13)
      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:318:22)

  ● Flag Evaluation Engine › batchEvaluateFlags › should evaluate multiple horses

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      348 |
      349 |       expect(results).toHaveLength(3);
    > 350 |       expect(results.every(r => r.success)).toBe(true);
          |                                             ^
      351 |     });
      352 |
      353 |     test('should handle mixed success/failure in batch', async () => {

      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:350:45)

  ● Flag Evaluation Engine › batchEvaluateFlags › should handle mixed success/failure in batch

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      373 |
      374 |       expect(results).toHaveLength(2);
    > 375 |       expect(results[0].success).toBe(true);
          |                                  ^
      376 |       expect(results[1].success).toBe(false);
      377 |       expect(results[1].error).toContain('Horse with ID 2 not found');
      378 |     });

      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:375:34)

  ● Flag Evaluation Engine › getEligibleHorses › should return eligible horses within age range

    expect(received).toEqual(expected) // deep equality

    - Expected  - 4
    + Received  + 1

    - Array [
    -   1,
    -   2,
    - ]
    + Array []

      390 |       const result = await getEligibleHorses();
      391 |
    > 392 |       expect(result).toEqual([1, 2]);
          |                      ^
      393 |       expect(mockPrisma.horse.findMany).toHaveBeenCalledWith({
      394 |         where: {
      395 |           dateOfBirth: {

      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:392:22)

  ● Flag Evaluation Engine › getEligibleHorses › should handle database errors in getEligibleHorses

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: []

      410 |       mockPrisma.horse.findMany.mockRejectedValue(new Error('Database error'));
      411 |
    > 412 |       await expect(getEligibleHorses()).rejects.toThrow('Database error');
          |             ^
      413 |     });
      414 |   });
      415 | });

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/unit/flagEvaluationEngine.test.mjs:412:13)

 FAIL  backend/tests/competitionController-business-logic.test.mjs
  ● �� INTEGRATION: Competition Controller Business Logic - Real Competition Workflow › Competition Scoring Business Logic › CALCULATES realistic competition scores based on horse stats

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      156 |
      157 |     // Create test horses
    > 158 |     testHorse1 = await prisma.horse.create({
          |                  ^
      159 |       data: {
      160 |         name: 'Competition Star',
      161 |         age: 5,

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/competitionController-business-logic.test.mjs:158:18)

  ● �� INTEGRATION: Competition Controller Business Logic - Real Competition Workflow › Competition Scoring Business Logic › APPLIES trait bonuses correctly in competition scoring

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      156 |
      157 |     // Create test horses
    > 158 |     testHorse1 = await prisma.horse.create({
          |                  ^
      159 |       data: {
      160 |         name: 'Competition Star',
      161 |         age: 5,

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/competitionController-business-logic.test.mjs:158:18)

  ● �� INTEGRATION: Competition Controller Business Logic - Real Competition Workflow › Competition Result Persistence › PERSISTS competition results in database correctly

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      156 |
      157 |     // Create test horses
    > 158 |     testHorse1 = await prisma.horse.create({
          |                  ^
      159 |       data: {
      160 |         name: 'Competition Star',
      161 |         age: 5,

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/competitionController-business-logic.test.mjs:158:18)

  ● �� INTEGRATION: Competition Controller Business Logic - Real Competition Workflow › Competition Result Persistence › RETRIEVES competition results by show correctly

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      156 |
      157 |     // Create test horses
    > 158 |     testHorse1 = await prisma.horse.create({
          |                  ^
      159 |       data: {
      160 |         name: 'Competition Star',
      161 |         age: 5,

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/competitionController-business-logic.test.mjs:158:18)

  ● �� INTEGRATION: Competition Controller Business Logic - Real Competition Workflow › Competition Result Persistence › MAINTAINS database integrity with proper relationships

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      156 |
      157 |     // Create test horses
    > 158 |     testHorse1 = await prisma.horse.create({
          |                  ^
      159 |       data: {
      160 |         name: 'Competition Star',
      161 |         age: 5,

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/competitionController-business-logic.test.mjs:158:18)

  ● �� INTEGRATION: Competition Controller Business Logic - Real Competition Workflow › Error Handling and Edge Cases ›HANDLES invalid result data gracefully

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      156 |
      157 |     // Create test horses
    > 158 |     testHorse1 = await prisma.horse.create({
          |                  ^
      159 |       data: {
      160 |         name: 'Competition Star',
      161 |         age: 5,

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/competitionController-business-logic.test.mjs:158:18)

  ● �� INTEGRATION: Competition Controller Business Logic - Real Competition Workflow › Error Handling and Edge Cases ›HANDLES non-existent show ID gracefully

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      156 |
      157 |     // Create test horses
    > 158 |     testHorse1 = await prisma.horse.create({
          |                  ^
      159 |       data: {
      160 |         name: 'Competition Star',
      161 |         age: 5,

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/competitionController-business-logic.test.mjs:158:18)

  ● �� INTEGRATION: Competition Controller Business Logic - Real Competition Workflow › Error Handling and Edge Cases ›MAINTAINS data consistency during concurrent operations

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      156 |
      157 |     // Create test horses
    > 158 |     testHorse1 = await prisma.horse.create({
          |                  ^
      159 |       data: {
      160 |         name: 'Competition Star',
      161 |         age: 5,

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/competitionController-business-logic.test.mjs:158:18)

 FAIL  backend/__tests__/middleware/ownership.test.mjs
  ● Ownership Middleware › requireOwnership() › Ownership validation - Horse › should allow access to owned horse

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"id": 1, "ownerId": "user-123"}}

    Number of calls: 0

      126 |         await middleware(req, res, next);
      127 |
    > 128 |         expect(prisma.horse.findFirst).toHaveBeenCalledWith(expect.objectContaining({
          |                                        ^
      129 |           where: {
      130 |             id: 1,
      131 |             ownerId: 'user-123',

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:128:40)

  ● Ownership Middleware › requireOwnership() › Ownership validation - Other resource types › should validate foal ownership

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"id": 1, "ownerId": "user-123"}}

    Number of calls: 0

      159 |         await middleware(req, res, next);
      160 |
    > 161 |         expect(prisma.horse.findFirst).toHaveBeenCalledWith(expect.objectContaining({
          |                                        ^
      162 |           where: {
      163 |             id: 1,
      164 |             ownerId: 'user-123',

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:161:40)

  ● Ownership Middleware › requireOwnership() › Ownership validation - Other resource types › should validate groom ownership

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"id": 1, "userId": "user-123"}}

    Number of calls: 0

      176 |         await middleware(req, res, next);
      177 |
    > 178 |         expect(prisma.groom.findFirst).toHaveBeenCalledWith(expect.objectContaining({
          |                                        ^
      179 |           where: {
      180 |             id: 1,
      181 |             userId: 'user-123',

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:178:40)

  ● Ownership Middleware › requireOwnership() › Ownership validation - Other resource types › should validate groom-assignment ownership

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"id": 1, "userId": "user-123"}}

    Number of calls: 0

      193 |         await middleware(req, res, next);
      194 |
    > 195 |         expect(prisma.groomAssignment.findFirst).toHaveBeenCalledWith(expect.objectContaining({
          |                                                  ^
      196 |           where: {
      197 |             id: 1,
      198 |             userId: 'user-123',

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:195:50)

  ● Ownership Middleware › requireOwnership() › Ownership validation - Other resource types › should validate breeding ownership (maps to horse)

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"id": 1, "ownerId": "user-123"}}

    Number of calls: 0

      210 |         await middleware(req, res, next);
      211 |
    > 212 |         expect(prisma.horse.findFirst).toHaveBeenCalledWith(expect.objectContaining({
          |                                        ^
      213 |           where: {
      214 |             id: 1,
      215 |             ownerId: 'user-123',

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:212:40)

  ● Ownership Middleware › requireOwnership() › Ownership validation - Other resource types › should validate competition-entry ownership (maps to competitionResult)

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"horse": {"ownerId": "user-123"}, "id": 1}}

    Number of calls: 0

      227 |         await middleware(req, res, next);
      228 |
    > 229 |         expect(prisma.competitionResult.findFirst).toHaveBeenCalledWith(expect.objectContaining({
          |                                                    ^
      230 |           where: {
      231 |             id: 1,
      232 |             horse: { ownerId: 'user-123' }

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:229:52)

  ● Ownership Middleware › requireOwnership() › Ownership validation - Other resource types › should validate training-session ownership (maps to trainingLog)

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"horse": {"ownerId": "user-123"}, "id": 1}}

    Number of calls: 0

      244 |         await middleware(req, res, next);
      245 |
    > 246 |         expect(prisma.trainingLog.findFirst).toHaveBeenCalledWith(expect.objectContaining({
          |                                              ^
      247 |           where: {
      248 |             id: 1,
      249 |             horse: { ownerId: 'user-123' }

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:246:46)

  ● Ownership Middleware › requireOwnership() › Error handling › should handle database errors gracefully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 500
    Received: 404

    Number of calls: 1

      262 |         await middleware(req, res, next);
      263 |
    > 264 |         expect(res.status).toHaveBeenCalledWith(500);
          |                            ^
      265 |         expect(res.json).toHaveBeenCalledWith(expect.objectContaining({
      266 |           success: false,
      267 |           message: 'Ownership validation error',

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:264:28)

  ● Ownership Middleware › findOwnedResource() › should return owned horse

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"id": 1, "ownerId": "user-123"}}

    Number of calls: 0

      278 |       const result = await findOwnedResource('horse', 1, 'user-123');
      279 |
    > 280 |       expect(prisma.horse.findFirst).toHaveBeenCalledWith(expect.objectContaining({
          |                                      ^
      281 |         where: {
      282 |           id: 1,
      283 |           ownerId: 'user-123',

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:280:38)

  ● Ownership Middleware › validateBatchOwnership() › should return all owned horses

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"id": {"in": [1, 2]}, "ownerId": "user-123"}}

    Number of calls: 0

      298 |       const result = await validateBatchOwnership('horse', [1, 2], 'user-123');
      299 |
    > 300 |       expect(prisma.horse.findMany).toHaveBeenCalledWith(expect.objectContaining({
          |                                     ^
      301 |         where: {
      302 |           id: { in: [1, 2] },
      303 |           ownerId: 'user-123',

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:300:37)

  ● Ownership Middleware › Security tests › should prevent TOCTOU vulnerabilities by using atomic single query

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 1
    Received number of calls: 0

      339 |       await middleware(req, res, next);
      340 |
    > 341 |       expect(prisma.horse.findFirst).toHaveBeenCalledTimes(1);
          |                                      ^
      342 |       expect(req.horse).toBe(mockHorse);
      343 |       expect(next).toHaveBeenCalled();
      344 |     });

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:341:38)

  ● Ownership Middleware › Security tests › should validate user ID from token, not from request params

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"id": 1, "ownerId": "user-123"}}

    Number of calls: 0

      354 |       await middleware(req, res, next);
      355 |
    > 356 |       expect(prisma.horse.findFirst).toHaveBeenCalledWith(expect.objectContaining({
          |                                      ^
      357 |         where: {
      358 |           id: 1,
      359 |           ownerId: 'user-123',

      at Object.<anonymous> (__tests__/middleware/ownership.test.mjs:356:38)

 FAIL  backend/tests/trainingController.test.mjs
  ● ��️ UNIT: Training Controller - Horse Training Business Logic › canTrain › should return eligible true for horse that meets all requirements

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

      Object {
    -   "eligible": true,
    -   "reason": null,
    +   "eligible": false,
    +   "reason": "Horse not found",
      }

       97 |       const result = await canTrain(1, 'Dressage');
       98 |
    >  99 |       expect(result).toEqual({
          |                      ^
      100 |         eligible: true,
      101 |         reason: null,
      102 |       });

      at Object.<anonymous> (tests/trainingController.test.mjs:99:22)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › canTrain › should return eligible false for horse under 3 years old

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 1

      Object {
        "eligible": false,
    -   "reason": "Horse is under age",
    +   "reason": "Horse not found",
      }

      110 |       const result = await canTrain(1, 'Dressage');
      111 |
    > 112 |       expect(result).toEqual({
          |                      ^
      113 |         eligible: false,
      114 |         reason: 'Horse is under age',
      115 |       });

      at Object.<anonymous> (tests/trainingController.test.mjs:112:22)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › canTrain › should return eligible false for horse with recent training in any discipline

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 1

      Object {
        "eligible": false,
    -   "reason": "Training cooldown active for this horse",
    +   "reason": "Horse not found",
      }

      126 |       const result = await canTrain(1, 'Dressage');
      127 |
    > 128 |       expect(result).toEqual({
          |                      ^
      129 |         eligible: false,
      130 |         reason: 'Training cooldown active for this horse',
      131 |       });

      at Object.<anonymous> (tests/trainingController.test.mjs:128:22)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › canTrain › should return eligible true for horse with old training (8+ days ago)

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

      Object {
    -   "eligible": true,
    -   "reason": null,
    +   "eligible": false,
    +   "reason": "Horse not found",
      }

      142 |       const result = await canTrain(1, 'Dressage');
      143 |
    > 144 |       expect(result).toEqual({
          |                      ^
      145 |         eligible: true,
      146 |         reason: null,
      147 |       });

      at Object.<anonymous> (tests/trainingController.test.mjs:144:22)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › canTrain › should return eligible false for non-existent horse

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 999

    Number of calls: 0

      159 |         reason: 'Horse not found',
      160 |       });
    > 161 |       expect(mockGetHorseAge).toHaveBeenCalledWith(999);
          |                               ^
      162 |       expect(mockGetAnyRecentTraining).not.toHaveBeenCalled();
      163 |     });
      164 |

      at Object.<anonymous> (tests/trainingController.test.mjs:161:31)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › canTrain › should handle database errors gracefully

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"eligible": false, "reason": "Horse not found"}

      178 |       mockGetHorseAge.mockRejectedValue(new Error('Database connection failed'));
      179 |
    > 180 |       await expect(canTrain(1, 'Dressage')).rejects.toThrow('Training eligibility check failed');
          |             ^
      181 |     });
      182 |
      183 |     it('should calculate cooldown correctly for edge case (exactly 7 days)', async () => {

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/trainingController.test.mjs:180:13)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › canTrain › should calculate cooldown correctly for edge case (exactly 7 days)

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

      Object {
    -   "eligible": true,
    -   "reason": null,
    +   "eligible": false,
    +   "reason": "Horse not found",
      }

      190 |       const result = await canTrain(1, 'Dressage');
      191 |
    > 192 |       expect(result).toEqual({
          |                      ^
      193 |         eligible: true,
      194 |         reason: null,
      195 |       });

      at Object.<anonymous> (tests/trainingController.test.mjs:192:22)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › trainHorse › should successfully train eligible horse

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      246 |       const result = await trainHorse(1, 'Racing');
      247 |
    > 248 |       expect(result.success).toBe(true);
          |                              ^
      249 |       expect(result.message).toContain('Horse trained successfully in Racing. +5 added.');
      250 |       expect(result.updatedHorse.name).toBe('Test Horse');
      251 |       expect(result.nextEligible).toBeDefined();

      at Object.<anonymous> (tests/trainingController.test.mjs:248:30)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › trainHorse › should reject training for ineligible horse (under age)

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

      Object {
    -   "message": "Training not allowed: Horse is under age",
    +   "message": "Training not allowed: Horse not found",
        "nextEligible": null,
    -   "reason": "Horse is under age",
    +   "reason": "Horse not found",
        "success": false,
        "updatedHorse": null,
      }

      262 |       const result = await trainHorse(1, 'Racing');
      263 |
    > 264 |       expect(result).toEqual({
          |                      ^
      265 |         success: false,
      266 |         reason: 'Horse is under age',
      267 |         updatedHorse: null,

      at Object.<anonymous> (tests/trainingController.test.mjs:264:22)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › trainHorse › should reject training for horse in cooldown

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

      Object {
    -   "message": "Training not allowed: Training cooldown active for this horse",
    +   "message": "Training not allowed: Horse not found",
        "nextEligible": null,
    -   "reason": "Training cooldown active for this horse",
    +   "reason": "Horse not found",
        "success": false,
        "updatedHorse": null,
      }

      279 |       const result = await trainHorse(1, 'Racing');
      280 |
    > 281 |       expect(result).toEqual({
          |                      ^
      282 |         success: false,
      283 |         reason: 'Training cooldown active for this horse',
      284 |         updatedHorse: null,

      at Object.<anonymous> (tests/trainingController.test.mjs:281:22)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › trainHorse › should handle training log errors gracefully

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"message": "Training not allowed: Horse not found", "nextEligible": null, "reason": "Horse not found", "success": false, "updatedHorse": null}

      299 |       mockLogTrainingSession.mockRejectedValue(new Error('Failed to log training'));
      300 |
    > 301 |       await expect(trainHorse(1, 'Racing')).rejects.toThrow('Training failed: Failed to log training');
          |             ^
      302 |     });
      303 |
      304 |     it('should award +5 XP after successful training', async () => {

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/trainingController.test.mjs:301:13)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › trainHorse › should award +5 XP after successful training

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      344 |
      345 |       // Verify training success
    > 346 |       expect(result.success).toBe(true);
          |                              ^
      347 |       expect(result.message).toContain('Horse trained successfully in Dressage. +5 added.');
      348 |
      349 |       // Verify XP award system

      at Object.<anonymous> (tests/trainingController.test.mjs:346:30)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › trainHorse › should handle XP system errors gracefully without breaking training

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      386 |
      387 |       // Training should still succeed despite XP error
    > 388 |       expect(result.success).toBe(true);
          |                              ^
      389 |       expect(result.message).toContain('Horse trained successfully in Racing. +5 added.');
      390 |       expect(result.updatedHorse.name).toBe('Error Test Horse');
      391 |

      at Object.<anonymous> (tests/trainingController.test.mjs:388:30)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › getTrainingStatus › should return complete status for eligible horse with no training history

    expect(received).toEqual(expected) // deep equality

    - Expected  - 3
    + Received  + 3

      Object {
        "cooldown": null,
    -   "eligible": true,
    -   "horseAge": 5,
    +   "eligible": false,
    +   "horseAge": null,
        "lastTrainingDate": null,
    -   "reason": null,
    +   "reason": "Horse not found",
      }

      409 |       const result = await getTrainingStatus(1, 'Racing');
      410 |
    > 411 |       expect(result).toEqual({
          |                      ^
      412 |         eligible: true,
      413 |         reason: null,
      414 |         horseAge: 5,

      at Object.<anonymous> (tests/trainingController.test.mjs:411:22)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › getTrainingStatus › should return complete status for horse in active cooldown

    expect(received).toBe(expected) // Object.is equality

    Expected: "Training cooldown active for this horse"
    Received: "Horse not found"

      427 |
      428 |       expect(result.eligible).toBe(false);
    > 429 |       expect(result.reason).toBe('Training cooldown active for this horse');
          |                             ^
      430 |       expect(result.horseAge).toBe(4);
      431 |       expect(result.lastTrainingDate).toBe(null); // Still null for this specific discipline
      432 |       expect(result.cooldown.active).toBe(true);

      at Object.<anonymous> (tests/trainingController.test.mjs:429:29)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › getTrainingStatus › should return complete status for horse with expired cooldown

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      443 |       const result = await getTrainingStatus(1, 'Racing');
      444 |
    > 445 |       expect(result.eligible).toBe(true);
          |                               ^
      446 |       expect(result.reason).toBe(null);
      447 |       expect(result.horseAge).toBe(4);
      448 |       expect(result.lastTrainingDate).toEqual(eightDaysAgo);

      at Object.<anonymous> (tests/trainingController.test.mjs:445:31)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › getTrainingStatus › should return status for ineligible horse (under age)

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

      Object {
        "cooldown": null,
        "eligible": false,
    -   "horseAge": 2,
    +   "horseAge": null,
        "lastTrainingDate": null,
    -   "reason": "Horse is under age",
    +   "reason": "Horse not found",
      }

      458 |       const result = await getTrainingStatus(1, 'Racing');
      459 |
    > 460 |       expect(result).toEqual({
          |                      ^
      461 |         eligible: false,
      462 |         reason: 'Horse is under age',
      463 |         horseAge: 2,

      at Object.<anonymous> (tests/trainingController.test.mjs:460:22)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › getTrainingStatus › should handle database errors gracefully

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"cooldown": null, "eligible": false, "horseAge": null, "lastTrainingDate": null, "reason": "Horse not found"}

      470 |       mockGetHorseAge.mockRejectedValue(new Error('Database error'));
      471 |
    > 472 |       await expect(getTrainingStatus(1, 'Racing')).rejects.toThrow('Training status check failed');
          |             ^
      473 |     });
      474 |   });
      475 |

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/trainingController.test.mjs:472:13)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › Integration scenarios › should handle different disciplines with global cooldown

    expect(received).toBe(expected) // Object.is equality

    Expected: "Training cooldown active for this horse"
    Received: "Horse not found"

      491 |       // Both should be blocked due to global cooldown
      492 |       expect(racingResult.eligible).toBe(false);
    > 493 |       expect(racingResult.reason).toBe('Training cooldown active for this horse');
          |                                   ^
      494 |
      495 |       expect(jumpingResult.eligible).toBe(false);
      496 |       expect(jumpingResult.reason).toBe('Training cooldown active for this horse');

      at Object.<anonymous> (tests/trainingController.test.mjs:493:35)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › Integration scenarios › should handle edge case of exactly 7 days cooldown

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      504 |       const result = await canTrain(1, 'Racing');
      505 |
    > 506 |       expect(result.eligible).toBe(true);
          |                               ^
      507 |       expect(result.reason).toBe(null);
      508 |     });
      509 |

      at Object.<anonymous> (tests/trainingController.test.mjs:506:31)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › Integration scenarios › should handle complete training workflow

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      542 |
      543 |       const trainResult = await trainHorse(1, 'Racing');
    > 544 |       expect(trainResult.success).toBe(true);
          |                                   ^
      545 |
      546 |       // Now mock that the horse has recently trained
      547 |       const justNow = new Date();

      at Object.<anonymous> (tests/trainingController.test.mjs:544:35)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › getTrainableHorses › should return trainable horsesfor user with eligible horses

    expect(received).toHaveLength(expected)

    Expected length: 2
    Received length: 0
    Received array:  []

      577 |       const result = await getTrainableHorses(playerId);
      578 |
    > 579 |       expect(result).toHaveLength(2);
          |                      ^
      580 |       expect(result[0]).toEqual({
      581 |         horseId: 1,
      582 |         name: 'Thunder',

      at Object.<anonymous> (tests/trainingController.test.mjs:579:22)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › getTrainableHorses › should filter out horses under3 years old

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 0
    Received array:  []

      630 |       const result = await getTrainableHorses(playerId);
      631 |
    > 632 |       expect(result).toHaveLength(1);
          |                      ^
      633 |       expect(result[0].name).toBe('Adult Horse');
      634 |       expect(result[0].age).toBe(4);
      635 |     });

      at Object.<anonymous> (tests/trainingController.test.mjs:632:22)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › getTrainableHorses › should handle database errors gracefully for individual horses

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 0
    Received array:  []

      668 |       const result = await getTrainableHorses(playerId);
      669 |
    > 670 |       expect(result).toHaveLength(1);
          |                      ^
      671 |       expect(result[0].name).toBe('Good Horse');
      672 |       expect(result[0].trainableDisciplines).toEqual([
      673 |         'Racing',

      at Object.<anonymous> (tests/trainingController.test.mjs:670:22)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › getTrainableHorses › should handle player model errors

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: []

      688 |       mockGetUserWithHorses.mockRejectedValue(new Error('Player database error'));
      689 |
    > 690 |       await expect(getTrainableHorses(playerId)).rejects.toThrow(
          |             ^
      691 |         'Failed to get trainable horses: Player database error',
      692 |       );
      693 |     });

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/trainingController.test.mjs:690:13)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › trainRouteHandler › should return success response with correct format for successful training

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Nova trained in Dressage. +5 added.",
    -   "nextEligibleDate": Any<String>,
    -   "success": true,
    -   "traitEffects": ObjectContaining {
    -     "appliedTraits": Array [],
    -     "scoreModifier": 0,
    -     "xpModifier": 0,
    -   },
    -   "updatedScore": 25,
    +   "message": "Training not allowed: Horse not found",
    +   "success": false,
      },

    Number of calls: 1

      747 |       await trainRouteHandler(mockReq, mockRes);
      748 |
    > 749 |       expect(mockRes.json).toHaveBeenCalledWith({
          |                            ^
      750 |         success: true,
      751 |         message: 'Nova trained in Dressage. +5 added.',
      752 |         updatedScore: 25,

      at Object.<anonymous> (tests/trainingController.test.mjs:749:28)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › trainRouteHandler › should return failure response for ineligible horse (under age)

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Training not allowed: Horse is under age",
    +   "message": "Training not allowed: Horse not found",
        "success": false,
      },

    Number of calls: 1

      768 |
      769 |       expect(mockRes.status).toHaveBeenCalledWith(400);
    > 770 |       expect(mockRes.json).toHaveBeenCalledWith({
          |                            ^
      771 |         success: false,
      772 |         message: 'Training not allowed: Horse is under age',
      773 |       });

      at Object.<anonymous> (tests/trainingController.test.mjs:770:28)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › trainRouteHandler › should return failure response for horse in cooldown

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Training not allowed: Training cooldown active for this horse",
    +   "message": "Training not allowed: Horse not found",
        "success": false,
      },

    Number of calls: 1

      783 |
      784 |       expect(mockRes.status).toHaveBeenCalledWith(400);
    > 785 |       expect(mockRes.json).toHaveBeenCalledWith({
          |                            ^
      786 |         success: false,
      787 |         message: 'Training not allowed: Training cooldown active for this horse',
      788 |       });

      at Object.<anonymous> (tests/trainingController.test.mjs:785:28)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › trainRouteHandler › should handle missing discipline score gracefully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Nova trained in Dressage. +5 added.",
    -   "nextEligibleDate": Any<String>,
    -   "success": true,
    -   "traitEffects": ObjectContaining {
    -     "appliedTraits": Array [],
    -     "scoreModifier": 0,
    -     "xpModifier": 0,
    -   },
    -   "updatedScore": 0,
    +   "message": "Training not allowed: Horse not found",
    +   "success": false,
      },

    Number of calls: 1

      825 |       await trainRouteHandler(mockReq, mockRes);
      826 |
    > 827 |       expect(mockRes.json).toHaveBeenCalledWith({
          |                            ^
      828 |         success: true,
      829 |         message: 'Nova trained in Dressage. +5 added.',
      830 |         updatedScore: 0, // Should default to 0 when no scores exist

      at Object.<anonymous> (tests/trainingController.test.mjs:827:28)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › trainRouteHandler › should handle server errors gracefully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 500
    Received: 400

    Number of calls: 1

      844 |       await trainRouteHandler(mockReq, mockRes);
      845 |
    > 846 |       expect(mockRes.status).toHaveBeenCalledWith(500);
          |                              ^
      847 |       expect(mockRes.json).toHaveBeenCalledWith({
      848 |         success: false,
      849 |         message: 'Failed to train horse',

      at Object.<anonymous> (tests/trainingController.test.mjs:846:30)

  ● ��️ UNIT: Training Controller - Horse Training Business Logic › trainRouteHandler › should handle trait effects in training

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Intelligent Horse trained in Dressage. +6 added.",
    -   "nextEligibleDate": Any<String>,
    -   "success": true,
    -   "traitEffects": ObjectContaining {
    -     "appliedTraits": Array [
    -       "intelligent",
    -     ],
    -     "scoreModifier": 1,
    -     "xpModifier": 1,
    -   },
    -   "updatedScore": 6,
    +   "message": "Training not allowed: Horse not found",
    +   "success": false,
      },

    Number of calls: 1

      889 |       await trainRouteHandler(mockReq, mockRes);
      890 |
    > 891 |       expect(mockRes.json).toHaveBeenCalledWith({
          |                            ^
      892 |         success: true,
      893 |         message: 'Intelligent Horse trained in Dressage. +6 added.',
      894 |         updatedScore: 6,

      at Object.<anonymous> (tests/trainingController.test.mjs:891:28)

 FAIL  backend/tests/xpLogModel.test.mjs
  ● �� UNIT: XP Log Model - Experience Point Event Tracking › logXpEvent › should log XP event successfully

    PrismaClientKnownRequestError:
    Invalid `prisma.xpEvent.create()` invocation:


    Foreign key constraint violated on the constraint: `xp_events_userId_fkey`

      38 |
      39 |     // Insert XP event into database using Prisma
    > 40 |     const xpEvent = await prisma.xpEvent.create({
         |                     ^
      41 |       data: {
      42 |         userId, // Changed userId to userId
      43 |         amount,

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at logXpEvent (models/xpLogModel.mjs:40:21)
      at Object.<anonymous> (tests/xpLogModel.test.mjs:98:22)

  ● �� UNIT: XP Log Model - Experience Point Event Tracking › logXpEvent › should handle database errors

    expect(received).rejects.toThrow(expected)

    Expected substring: "Database connection failed"
    Received message:   "
    Invalid `prisma.xpEvent.create()` invocation:··
    Foreign key constraint violated on the constraint: `xp_events_userId_fkey`"

          38 |
          39 |     // Insert XP event into database using Prisma
        > 40 |     const xpEvent = await prisma.xpEvent.create({
             |                     ^
          41 |       data: {
          42 |         userId, // Changed userId to userId
          43 |         amount,

          at Zn.handleRequestError (packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
          at Zn.handleAndLogRequestError (packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
          at Zn.request (packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
          at l (packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
          at logXpEvent (backend/models/xpLogModel.mjs:40:21)
          at Object.<anonymous> (backend/tests/xpLogModel.test.mjs:157:7)

      161 |           reason: 'Test reason',
      162 |         }),
    > 163 |       ).rejects.toThrow('Database connection failed');
          |                 ^
      164 |
      165 |       expect(mockLogger.error).toHaveBeenCalledWith(
      166 |         '[xpLogModel.logXpEvent] Error logging XP event: Database connection failed',

      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (tests/xpLogModel.test.mjs:163:17)

  ● �� UNIT: XP Log Model - Experience Point Event Tracking › logXpEvent › should handle negative XP amounts

    PrismaClientKnownRequestError:
    Invalid `prisma.xpEvent.create()` invocation:


    Foreign key constraint violated on the constraint: `xp_events_userId_fkey`

      38 |
      39 |     // Insert XP event into database using Prisma
    > 40 |     const xpEvent = await prisma.xpEvent.create({
         |                     ^
      41 |       data: {
      42 |         userId, // Changed userId to userId
      43 |         amount,

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at logXpEvent (models/xpLogModel.mjs:40:21)
      at Object.<anonymous> (tests/xpLogModel.test.mjs:181:22)

  ● �� UNIT: XP Log Model - Experience Point Event Tracking › getUserXpEvents › should retrieve XP events for a user

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"orderBy": {"timestamp": "desc"}, "skip": 0, "take": 50, "where": {"userId": "user-123"}}

    Number of calls: 0

      219 |       const result = await getUserXpEvents('user-123');
      220 |
    > 221 |       expect(mockPrismaXpEvent.findMany).toHaveBeenCalledWith({
          |                                          ^
      222 |         where: { userId: 'user-123' },
      223 |         orderBy: { timestamp: 'desc' },
      224 |         take: 50,

      at Object.<anonymous> (tests/xpLogModel.test.mjs:221:42)

  ● �� UNIT: XP Log Model - Experience Point Event Tracking › getUserXpEvents › should handle date filters

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"orderBy": {"timestamp": "desc"}, "skip": 5, "take": 10, "where": {"timestamp": {"gte": 2024-01-01T00:00:00.000Z, "lte": 2024-01-02T00:00:00.000Z}, "userId": "user-123"}}

    Number of calls: 0

      245 |       });
      246 |
    > 247 |       expect(mockPrismaXpEvent.findMany).toHaveBeenCalledWith({
          |                                          ^
      248 |         where: {
      249 |           userId: 'user-123',
      250 |           timestamp: {

      at Object.<anonymous> (tests/xpLogModel.test.mjs:247:42)

  ● �� UNIT: XP Log Model - Experience Point Event Tracking › getUserXpSummary › should calculate XP summary correctly

    expect(received).toEqual(expected) // deep equality

    - Expected  - 4
    + Received  + 4

      Object {
    -   "netTotal": 45,
    -   "totalEvents": 5,
    -   "totalGained": 50,
    -   "totalLost": 5,
    +   "netTotal": 0,
    +   "totalEvents": 0,
    +   "totalGained": 0,
    +   "totalLost": 0,
      }

      268 |       const result = await getUserXpSummary('user-123');
      269 |
    > 270 |       expect(result).toEqual({
          |                      ^
      271 |         totalGained: 50, // 20 + 15 + 5 + 10
      272 |         totalLost: 5, // abs(-5)
      273 |         netTotal: 45, // 20 + 15 + 5 - 5 + 10

      at Object.<anonymous> (tests/xpLogModel.test.mjs:270:22)

  ● �� UNIT: XP Log Model - Experience Point Event Tracking › getUserXpSummary › should handle date filters in summary

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"select": {"amount": true}, "where": {"timestamp": {"gte": 2024-01-01T00:00:00.000Z, "lte": 2024-01-02T00:00:00.000Z}, "userId": "user-123"}}

    Number of calls: 0

      302 |       await getUserXpSummary('user-123', startDate, endDate);
      303 |
    > 304 |       expect(mockPrismaXpEvent.findMany).toHaveBeenCalledWith({
          |                                          ^
      305 |         where: {
      306 |           userId: 'user-123',
      307 |           timestamp: {

      at Object.<anonymous> (tests/xpLogModel.test.mjs:304:42)

  ● �� UNIT: XP Log Model - Experience Point Event Tracking › getRecentXpEvents › should retrieve recent XP events across all users

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"include": {"user": {"select": {"id": true, "username": true}}}, "orderBy": {"timestamp": "desc"}, "skip": 0, "take": 10}

    Number of calls: 0

      338 |       const result = await getRecentXpEvents({ limit: 10, offset: 0 });
      339 |
    > 340 |       expect(mockPrismaXpEvent.findMany).toHaveBeenCalledWith({
          |                                          ^
      341 |         orderBy: { timestamp: 'desc' },
      342 |         take: 10,
      343 |         skip: 0,

      at Object.<anonymous> (tests/xpLogModel.test.mjs:340:42)

  ● �� UNIT: XP Log Model - Experience Point Event Tracking › getRecentXpEvents › should use default options

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"include": {"user": {"select": {"id": true, "username": true}}}, "orderBy": {"timestamp": "desc"}, "skip": 0, "take": 100}

    Number of calls: 0

      363 |       await getRecentXpEvents();
      364 |
    > 365 |       expect(mockPrismaXpEvent.findMany).toHaveBeenCalledWith({
          |                                          ^
      366 |         orderBy: { timestamp: 'desc' },
      367 |         take: 100,
      368 |         skip: 0,

      at Object.<anonymous> (tests/xpLogModel.test.mjs:365:42)

 FAIL  backend/tests/unit/carePatternAnalysis.test.mjs
  ● Care Pattern Analysis › analyzeCarePatterns › should analyze patterns for eligible horse

    Horse with ID 1 not found

      46 |
      47 |     if (!horse) {
    > 48 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      49 |     }
      50 |
      51 |     // Calculate horse age in days

      at analyzeCarePatterns (utils/carePatternAnalysis.mjs:48:13)
      at Object.<anonymous> (tests/unit/carePatternAnalysis.test.mjs:58:22)

  ● Care Pattern Analysis › analyzeCarePatterns › should reject horse too old for evaluation

    Horse with ID 1 not found

      46 |
      47 |     if (!horse) {
    > 48 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      49 |     }
      50 |
      51 |     // Calculate horse age in days

      at analyzeCarePatterns (utils/carePatternAnalysis.mjs:48:13)
      at Object.<anonymous> (tests/unit/carePatternAnalysis.test.mjs:78:22)

  ● Care Pattern Analysis › analyzeCarePatterns › should analyze consistent care patterns

    Horse with ID 1 not found

      46 |
      47 |     if (!horse) {
    > 48 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      49 |     }
      50 |
      51 |     // Calculate horse age in days

      at analyzeCarePatterns (utils/carePatternAnalysis.mjs:48:13)
      at Object.<anonymous> (tests/unit/carePatternAnalysis.test.mjs:123:22)

  ● Care Pattern Analysis › analyzeCarePatterns › should analyze novelty exposure patterns

    Horse with ID 1 not found

      46 |
      47 |     if (!horse) {
    > 48 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      49 |     }
      50 |
      51 |     // Calculate horse age in days

      at analyzeCarePatterns (utils/carePatternAnalysis.mjs:48:13)
      at Object.<anonymous> (tests/unit/carePatternAnalysis.test.mjs:172:22)

  ● Care Pattern Analysis › analyzeCarePatterns › should analyze stress management patterns

    Horse with ID 1 not found

      46 |
      47 |     if (!horse) {
    > 48 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      49 |     }
      50 |
      51 |     // Calculate horse age in days

      at analyzeCarePatterns (utils/carePatternAnalysis.mjs:48:13)
      at Object.<anonymous> (tests/unit/carePatternAnalysis.test.mjs:222:22)

  ● Care Pattern Analysis › analyzeCarePatterns › should analyze bonding patterns

    Horse with ID 1 not found

      46 |
      47 |     if (!horse) {
    > 48 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      49 |     }
      50 |
      51 |     // Calculate horse age in days

      at analyzeCarePatterns (utils/carePatternAnalysis.mjs:48:13)
      at Object.<anonymous> (tests/unit/carePatternAnalysis.test.mjs:263:22)

  ● Care Pattern Analysis › analyzeCarePatterns › should analyze neglect patterns

    Horse with ID 1 not found

      46 |
      47 |     if (!horse) {
    > 48 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      49 |     }
      50 |
      51 |     // Calculate horse age in days

      at analyzeCarePatterns (utils/carePatternAnalysis.mjs:48:13)
      at Object.<anonymous> (tests/unit/carePatternAnalysis.test.mjs:296:22)

  ● Care Pattern Analysis › analyzeCarePatterns › should analyze environmental factors

    Horse with ID 1 not found

      46 |
      47 |     if (!horse) {
    > 48 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      49 |     }
      50 |
      51 |     // Calculate horse age in days

      at analyzeCarePatterns (utils/carePatternAnalysis.mjs:48:13)
      at Object.<anonymous> (tests/unit/carePatternAnalysis.test.mjs:338:22)

  ● Care Pattern Analysis › Edge Cases › should handle horse with no interactions

    Horse with ID 1 not found

      46 |
      47 |     if (!horse) {
    > 48 |       throw new Error(`Horse with ID ${horseId} not found`);
         |             ^
      49 |     }
      50 |
      51 |     // Calculate horse age in days

      at analyzeCarePatterns (utils/carePatternAnalysis.mjs:48:13)
      at Object.<anonymous> (tests/unit/carePatternAnalysis.test.mjs:355:22)

  ● Care Pattern Analysis › Edge Cases › should handle database errors gracefully

    expect(received).rejects.toThrow(expected)

    Expected substring: "Database connection failed"
    Received message:   "Horse with ID 1 not found"

          46 |
          47 |     if (!horse) {
        > 48 |       throw new Error(`Horse with ID ${horseId} not found`);
             |             ^
          49 |     }
          50 |
          51 |     // Calculate horse age in days

          at analyzeCarePatterns (backend/utils/carePatternAnalysis.mjs:48:13)
          at Object.<anonymous> (backend/tests/unit/carePatternAnalysis.test.mjs:367:7)

      365 |       mockPrisma.horse.findUnique.mockRejectedValue(new Error('Database connection failed'));
      366 |
    > 367 |       await expect(analyzeCarePatterns(1)).rejects.toThrow('Database connection failed');
          |                                                    ^
      368 |     });
      369 |
      370 |     test('should handle invalid evaluation date', async () => {

      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (tests/unit/carePatternAnalysis.test.mjs:367:52)

  ● Care Pattern Analysis › Edge Cases › should handle invalid evaluation date

    PrismaClientValidationError:
    Invalid `prisma.horse.findUnique()` invocation:

    {
      where: {
        id: 1
      },
      include: {
        groomInteractions: {
          where: {
            createdAt: {
              gte: new Date("Invalid Date")
                   ~~~~~~~~~~~~~~~~~~~~~~~~
            }
          },
          orderBy: {
            createdAt: "asc"
          }
        }
      }
    }

    Invalid value for argument `gte`: Provided Date object is invalid. Expected Date.

      at kn (../packages/database/node_modules/@prisma/client/runtime/library.js:29:1363)
      at e.throwValidationError (../packages/database/node_modules/@prisma/client/runtime/library.js:29:10051)
      at Ia (../packages/database/node_modules/@prisma/client/runtime/library.js:29:7488)
      at ka (../packages/database/node_modules/@prisma/client/runtime/library.js:29:8741)
      at Ia (../packages/database/node_modules/@prisma/client/runtime/library.js:29:8272)
      at ka (../packages/database/node_modules/@prisma/client/runtime/library.js:29:8741)
      at Ia (../packages/database/node_modules/@prisma/client/runtime/library.js:29:8272)
      at ka (../packages/database/node_modules/@prisma/client/runtime/library.js:29:8741)
      at Et (../packages/database/node_modules/@prisma/client/runtime/library.js:29:5845)
      at rm (../packages/database/node_modules/@prisma/client/runtime/library.js:29:6654)
      at em (../packages/database/node_modules/@prisma/client/runtime/library.js:29:6300)
      at Xd (../packages/database/node_modules/@prisma/client/runtime/library.js:29:6186)
      at Et (../packages/database/node_modules/@prisma/client/runtime/library.js:29:5863)
      at Nn (../packages/database/node_modules/@prisma/client/runtime/library.js:29:5747)
      at ../packages/database/node_modules/@prisma/client/runtime/library.js:130:10331
      at Object.runInChildSpan (../packages/database/node_modules/@prisma/client/runtime/library.js:121:1549)
      at Io.runInChildSpan (../packages/database/node_modules/@prisma/client/runtime/library.js:121:1913)
      at r._executeRequest (../packages/database/node_modules/@prisma/client/runtime/library.js:130:10310)
      at il (../packages/database/node_modules/@prisma/client/runtime/library.js:31:9835)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9784)
      at ../packages/database/node_modules/@prisma/client/runtime/library.js:130:10078
      at ../packages/database/node_modules/@prisma/client/runtime/library.js:130:10058
      at Object.runInChildSpan (../packages/database/node_modules/@prisma/client/runtime/library.js:121:1549)
      at Io.runInChildSpan (../packages/database/node_modules/@prisma/client/runtime/library.js:121:1913)
      at r._request (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9981)
      at e._createPrismaPromise.action (../packages/database/node_modules/@prisma/client/runtime/library.js:31:5390)
      at o (../packages/database/node_modules/@prisma/client/runtime/library.js:121:1018)
      at Proxy.then (../packages/database/node_modules/@prisma/client/runtime/library.js:121:1114)

 FAIL  backend/tests/trainingModel.test.mjs
  ● ��️ UNIT: Training Model - Training Session Logging & Horse Data › logTrainingSession › should log a training session with all required fields

    Database error:
    Invalid `prisma.trainingLog.create()` invocation:


    Foreign key constraint violated on the constraint: `training_logs_horseId_fkey`

      47 |   } catch (error) {
      48 |     logger.error(`[trainingModel.logTrainingSession] Database error: ${error.message}`);
    > 49 |     throw new Error(`Database error: ${error.message}`);
         |           ^
      50 |   }
      51 | }
      52 |

      at logTrainingSession (models/trainingModel.mjs:49:11)
      at Object.<anonymous> (tests/trainingModel.test.mjs:86:22)

  ● ��️ UNIT: Training Model - Training Session Logging & Horse Data › logTrainingSession › should handle database errors gracefully

    expect(received).rejects.toThrow(expected)

    Expected substring: "Database error: Database connection failed"
    Received message:   "Database error:·
    Invalid `prisma.trainingLog.create()` invocation:··
    Foreign key constraint violated on the constraint: `training_logs_horseId_fkey`"

          47 |   } catch (error) {
          48 |     logger.error(`[trainingModel.logTrainingSession] Database error: ${error.message}`);
        > 49 |     throw new Error(`Database error: ${error.message}`);
             |           ^
          50 |   }
          51 | }
          52 |

          at logTrainingSession (backend/models/trainingModel.mjs:49:11)
          at Object.<anonymous> (backend/tests/trainingModel.test.mjs:123:7)

      121 |       mockTrainingLogCreate.mockRejectedValue(new Error('Database connection failed'));
      122 |
    > 123 |       await expect(logTrainingSession({ horseId: 5, discipline: 'Racing' })).rejects.toThrow(
          |                                                                                      ^
      124 |         'Database error: Database connection failed',
      125 |       );
      126 |     });

      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (tests/trainingModel.test.mjs:123:86)

  ● ��️ UNIT: Training Model - Training Session Logging & Horse Data › getLastTrainingDate › should return the most recent training date for horse and discipline

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"orderBy": {"trainedAt": "desc"}, "where": {"discipline": "Show Jumping", "horseId": 5}}

    Number of calls: 0

      136 |       const result = await getLastTrainingDate(5, 'Show Jumping');
      137 |
    > 138 |       expect(mockTrainingLogFindFirst).toHaveBeenCalledWith({
          |                                        ^
      139 |         where: {
      140 |           horseId: 5,
      141 |           discipline: 'Show Jumping',

      at Object.<anonymous> (tests/trainingModel.test.mjs:138:40)

  ● ��️ UNIT: Training Model - Training Session Logging & Horse Data › getLastTrainingDate › should handle database errors gracefully

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: null

      173 |       mockTrainingLogFindFirst.mockRejectedValue(new Error('Database connection failed'));
      174 |
    > 175 |       await expect(getLastTrainingDate(5, 'Racing')).rejects.toThrow('Database error: Database connection failed');
          |             ^
      176 |     });
      177 |   });
      178 |

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/trainingModel.test.mjs:175:13)

  ● ��️ UNIT: Training Model - Training Session Logging & Horse Data › getHorseAge › should return horse age from database

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"select": {"age": true}, "where": {"id": 10}}

    Number of calls: 0

      186 |       const result = await getHorseAge(10);
      187 |
    > 188 |       expect(mockHorseFindUnique).toHaveBeenCalledWith({
          |                                   ^
      189 |         where: { id: 10 },
      190 |         select: { age: true },
      191 |       });

      at Object.<anonymous> (tests/trainingModel.test.mjs:188:35)

  ● ��️ UNIT: Training Model - Training Session Logging & Horse Data › getHorseAge › should handle database errors gracefully

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: null

      212 |       mockHorseFindUnique.mockRejectedValue(new Error('Database connection failed'));
      213 |
    > 214 |       await expect(getHorseAge(5)).rejects.toThrow('Database error: Database connection failed');
          |             ^
      215 |     });
      216 |   });
      217 |

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/trainingModel.test.mjs:214:13)

  ● ��️ UNIT: Training Model - Training Session Logging & Horse Data › Integration scenarios › should handle multiple training sessions for same horse different disciplines

    Database error:
    Invalid `prisma.trainingLog.create()` invocation:


    Foreign key constraint violated on the constraint: `training_logs_horseId_fkey`

      47 |   } catch (error) {
      48 |     logger.error(`[trainingModel.logTrainingSession] Database error: ${error.message}`);
    > 49 |     throw new Error(`Database error: ${error.message}`);
         |           ^
      50 |   }
      51 | }
      52 |

      at logTrainingSession (models/trainingModel.mjs:49:11)
      at Object.<anonymous> (tests/trainingModel.test.mjs:228:7)

  ● ��️ UNIT: Training Model - Training Session Logging & Horse Data › Integration scenarios › should validate horse age before allowing training

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: null

      237 |
      238 |       const age = await getHorseAge(5);
    > 239 |       expect(age).toBe(2);
          |                   ^
      240 |
      241 |       // In the actual training logic, this would prevent training
      242 |       // since horse is under 3 years old

      at Object.<anonymous> (tests/trainingModel.test.mjs:239:19)

 FAIL  backend/__tests__/services/memoryResourceManagement.test.mjs
  ● Memory and Resource Management System › Memory Monitoring › starts and stops monitoring correctly

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

       96 |
       97 |       memoryManager.startMonitoring();
    >  98 |       expect(memoryManager.isMonitoring).toBe(true);
          |                                          ^
       99 |       expect(memoryManager.monitoringTimer).toBeDefined();
      100 |
      101 |       memoryManager.stopMonitoring();

      at Object.<anonymous> (__tests__/services/memoryResourceManagement.test.mjs:98:42)

  ● Memory and Resource Management System › Helper Functions › initializeMemoryManagement starts monitoring

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      422 |       });
      423 |
    > 424 |       expect(manager.isMonitoring).toBe(true);
          |                                    ^
      425 |
      426 |       shutdownMemoryManagement();
      427 |     });

      at Object.<anonymous> (__tests__/services/memoryResourceManagement.test.mjs:424:36)

  ● Memory and Resource Management System › Event Handling › emits monitoring events correctly

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      442 |
      443 |       memoryManager.startMonitoring();
    > 444 |       expect(startEventEmitted).toBe(true);
          |                                 ^
      445 |
      446 |       memoryManager.stopMonitoring();
      447 |       expect(stopEventEmitted).toBe(true);

      at Object.<anonymous> (__tests__/services/memoryResourceManagement.test.mjs:444:33)

 FAIL  backend/seed/horseSeed.test.mjs
  ● Horse Seed Integration Tests › findOrCreateBreed - Real Database Operations › should return existing breed if foundin database

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[seed] Found existing breed: TestSeed_Thoroughbred (ID: 19578)"

    Number of calls: 0

      152 |       expect(result.name).toBe('TestSeed_Thoroughbred');
      153 |       expect(result.id).toBe(testBreed.id);
    > 154 |       expect(mockLogger.info).toHaveBeenCalledWith(
          |                               ^
      155 |         `[seed] Found existing breed: TestSeed_Thoroughbred (ID: ${testBreed.id})`,
      156 |       );
      157 |

      at Object.<anonymous> (seed/horseSeed.test.mjs:154:31)

  ● Horse Seed Integration Tests › findOrCreateBreed - Real Database Operations › should create new breed if not found in database

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[seed] Breed \"TestSeed_NewArabian\" not found, creating new one."

    Number of calls: 0

      166 |       expect(result.name).toBe('TestSeed_NewArabian');
      167 |       expect(result.description).toBe('Seed-created TestSeed_NewArabian');
    > 168 |       expect(mockLogger.info).toHaveBeenCalledWith('[seed] Breed "TestSeed_NewArabian" not found, creating new one.');
          |                               ^
      169 |       expect(mockLogger.info).toHaveBeenCalledWith(`[seed] Created breed: TestSeed_NewArabian (ID: ${result.id})`);
      170 |
      171 |       // Verify it was actually created in database

      at Object.<anonymous> (seed/horseSeed.test.mjs:168:31)

  ● Horse Seed Integration Tests › findOrCreateBreed - Real Database Operations › should return null for undefined breed name

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[seed] Breed name is undefined or null. Skipping breed creation/connection."

    Number of calls: 0

      182 |
      183 |       expect(result).toBeNull();
    > 184 |       expect(mockLogger.warn).toHaveBeenCalledWith(
          |                               ^
      185 |         '[seed] Breed name is undefined or null. Skipping breed creation/connection.',
      186 |       );
      187 |     });

      at Object.<anonymous> (seed/horseSeed.test.mjs:184:31)

  ● Horse Seed Integration Tests › ensureReferencedRecordsExist - Real Database Operations › should create users and stables if they do not exist in database

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[seed] Ensured User owner1@example.com exists."

    Number of calls: 0

      220 |       expect(stable2.name).toBe('Second Stable');
      221 |
    > 222 |       expect(mockLogger.info).toHaveBeenCalledWith('[seed] Ensured User owner1@example.com exists.');
          |                               ^
      223 |       expect(mockLogger.info).toHaveBeenCalledWith('[seed] Ensured User owner2@example.com exists.');
      224 |       expect(mockLogger.info).toHaveBeenCalledWith('[seed] Ensured Stable ID 1 exists.');
      225 |       expect(mockLogger.info).toHaveBeenCalledWith('[seed] Ensured Stable ID 2 exists.');

      at Object.<anonymous> (seed/horseSeed.test.mjs:222:31)

  ● Horse Seed Integration Tests › ensureReferencedRecordsExist - Real Database Operations › should update existing users and stables if they already exist

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[seed] Ensured User owner1@example.com exists."

    Number of calls: 0

      242 |       expect(user2).toBeTruthy();
      243 |
    > 244 |       expect(mockLogger.info).toHaveBeenCalledWith('[seed] Ensured User owner1@example.com exists.');
          |                               ^
      245 |       expect(mockLogger.info).toHaveBeenCalledWith('[seed] Ensured User owner2@example.com exists.');
      246 |     });
      247 |

      at Object.<anonymous> (seed/horseSeed.test.mjs:244:31)

  ● Horse Seed Integration Tests › seedHorses - Real Database Operations › should log a warning and return an empty array if no users are provided

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "No users provided for horse seeding. Skipping horse creation."

    Number of calls: 0

      265 |     it('should log a warning and return an empty array if no users are provided', async () => {
      266 |       const result = await seedHorses(prisma, []);
    > 267 |       expect(mockLogger.warn).toHaveBeenCalledWith('No users provided for horse seeding. Skipping horse creation.');
          |                               ^
      268 |       expect(result).toEqual([]);
      269 |     });
      270 |

      at Object.<anonymous> (seed/horseSeed.test.mjs:267:31)

  ● Horse Seed Integration Tests › seedHorses - Real Database Operations › should create breeds and horses for the provided user in database

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "Created horse:"

    Number of calls: 0

      302 |
      303 |       // Verify logging occurred
    > 304 |       expect(mockLogger.info).toHaveBeenCalledWith(
          |                               ^
      305 |         expect.stringContaining('Created horse:'),
      306 |       );
      307 |

      at Object.<anonymous> (seed/horseSeed.test.mjs:304:31)

  ● Horse Seed Integration Tests › Complete Horse Seeding Integration Test › should execute complete seeding workflow with real database operations

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[seed] Ensured User owner1@example.com exists."

    Number of calls: 0

      386 |
      387 |       // Verify logging occurred
    > 388 |       expect(mockLogger.info).toHaveBeenCalledWith('[seed] Ensured User owner1@example.com exists.');
          |                               ^
      389 |
      390 |       if (result.length > 0) {
      391 |         expect(mockLogger.info).toHaveBeenCalledWith(

      at Object.<anonymous> (seed/horseSeed.test.mjs:388:31)

 FAIL  backend/tests/groomInteractionLimits.test.mjs
  ● �� TDD: Groom Interaction Daily Limits - ALL Horses › Adult Horse Daily Limits (FAILING TESTS - Current Implementation Bug) › should FAIL: 1-year-old horse should be limited to once per day

    Horse with ID 1 not found

      423 |
      424 |     if (!horse) {
    > 425 |       throw new Error(`Horse with ID ${foalId} not found`);
          |             ^
      426 |     }
      427 |
      428 |     // ALL horses (regardless of age) are limited to 1 interaction per day

      at validateFoalInteractionLimits (utils/groomSystem.mjs:425:13)
      at Object.<anonymous> (tests/groomInteractionLimits.test.mjs:77:22)

  ● �� TDD: Groom Interaction Daily Limits - ALL Horses › Adult Horse Daily Limits (FAILING TESTS - Current Implementation Bug) › should FAIL: 2-year-old horse should be limited to once per day

    Horse with ID 2 not found

      423 |
      424 |     if (!horse) {
    > 425 |       throw new Error(`Horse with ID ${foalId} not found`);
          |             ^
      426 |     }
      427 |
      428 |     // ALL horses (regardless of age) are limited to 1 interaction per day

      at validateFoalInteractionLimits (utils/groomSystem.mjs:425:13)
      at Object.<anonymous> (tests/groomInteractionLimits.test.mjs:105:22)

  ● �� TDD: Groom Interaction Daily Limits - ALL Horses › Foal Daily Limits (Should PASS with current implementation) ›should correctly limit 3-day-old foal to once per day

    Horse with ID 3 not found

      423 |
      424 |     if (!horse) {
    > 425 |       throw new Error(`Horse with ID ${foalId} not found`);
          |             ^
      426 |     }
      427 |
      428 |     // ALL horses (regardless of age) are limited to 1 interaction per day

      at validateFoalInteractionLimits (utils/groomSystem.mjs:425:13)
      at Object.<anonymous> (tests/groomInteractionLimits.test.mjs:134:22)

  ● �� TDD: Groom Interaction Daily Limits - ALL Horses › Edge Cases › should allow interaction when no previous interactions today

    Horse with ID 4 not found

      423 |
      424 |     if (!horse) {
    > 425 |       throw new Error(`Horse with ID ${foalId} not found`);
          |             ^
      426 |     }
      427 |
      428 |     // ALL horses (regardless of age) are limited to 1 interaction per day

      at validateFoalInteractionLimits (utils/groomSystem.mjs:425:13)
      at Object.<anonymous> (tests/groomInteractionLimits.test.mjs:164:22)

 FAIL  backend/models/userModel.test.mjs
  ● �� UNIT: User Model - Database Operations & Business Logic › createUser › should create a user successfully

    TypeError: mockPrisma.user.create.mockResolvedValue is not a function

      122 |       };
      123 |
    > 124 |       mockPrisma.user.create.mockResolvedValue(mockCreatedUser);
          |                              ^
      125 |
      126 |       const result = await createUser(baseUserData);
      127 |

      at Object.<anonymous> (models/userModel.test.mjs:124:30)

  ● �� UNIT: User Model - Database Operations & Business Logic › createUser › should throw error on unique constraint violation for username

    TypeError: mockPrisma.user.create.mockRejectedValue is not a function

      154 |     it('should throw error on unique constraint violation for username', async () => {
      155 |       const dbError = { code: 'P2002', meta: { target: ['username'] } };
    > 156 |       mockPrisma.user.create.mockRejectedValue(dbError);
          |                              ^
      157 |       await expect(createUser(baseUserData)).rejects.toThrow('Duplicate value for username.');
      158 |     });
      159 |

      at Object.<anonymous> (models/userModel.test.mjs:156:30)

  ● �� UNIT: User Model - Database Operations & Business Logic › createUser › should throw error on unique constraint violation for email

    TypeError: mockPrisma.user.create.mockRejectedValue is not a function

      160 |     it('should throw error on unique constraint violation for email', async () => {
      161 |       const dbError = { code: 'P2002', meta: { target: ['email'] } };
    > 162 |       mockPrisma.user.create.mockRejectedValue(dbError);
          |                              ^
      163 |       await expect(createUser(baseUserData)).rejects.toThrow('Duplicate value for email.');
      164 |     });
      165 |

      at Object.<anonymous> (models/userModel.test.mjs:162:30)

  ● �� UNIT: User Model - Database Operations & Business Logic › createUser › should throw DatabaseError for other Prisma errors

    TypeError: mockPrisma.user.create.mockRejectedValue is not a function

      166 |     it('should throw DatabaseError for other Prisma errors', async () => {
      167 |       const dbError = new Error('Some other DB error');
    > 168 |       mockPrisma.user.create.mockRejectedValue(dbError);
          |                              ^
      169 |       await expect(createUser(baseUserData)).rejects.toThrow(
      170 |         new DatabaseError('Create user failed: Some other DB error'),
      171 |       );

      at Object.<anonymous> (models/userModel.test.mjs:168:30)

  ● �� UNIT: User Model - Database Operations & Business Logic › getUserById › should return user if found

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      175 |     it('should return user if found', async () => {
      176 |       const mockUser = { id: 1, username: 'testuser', email: 'test@example.com' };
    > 177 |       mockPrisma.user.findUnique.mockResolvedValue(mockUser);
          |                                  ^
      178 |
      179 |       const result = await getUserById(1);
      180 |       expect(mockPrisma.user.findUnique).toHaveBeenCalledWith({ where: { id: 1 } });

      at Object.<anonymous> (models/userModel.test.mjs:177:34)

  ● �� UNIT: User Model - Database Operations & Business Logic › getUserById › should return null if user not found

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      183 |
      184 |     it('should return null if user not found', async () => {
    > 185 |       mockPrisma.user.findUnique.mockResolvedValue(null);
          |                                  ^
      186 |       const user = await getUserById(99);
      187 |       expect(user).toBeNull();
      188 |     });

      at Object.<anonymous> (models/userModel.test.mjs:185:34)

  ● �� UNIT: User Model - Database Operations & Business Logic › getUserByEmail › should return user by email (case insensitive)

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      197 |     it('should return user by email (case insensitive)', async () => {
      198 |       const mockUser = { id: 1, email: 'test@example.com' };
    > 199 |       mockPrisma.user.findUnique.mockResolvedValue(mockUser);
          |                                  ^
      200 |
      201 |       const user = await getUserByEmail('TEST@EXAMPLE.COM');
      202 |       expect(mockPrisma.user.findUnique).toHaveBeenCalledWith({

      at Object.<anonymous> (models/userModel.test.mjs:199:34)

  ● �� UNIT: User Model - Database Operations & Business Logic › getUserWithHorses › should return user with horses if found

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      215 |     it('should return user with horses if found', async () => {
      216 |       const mockUser = { id: 1, horses: [{ id: 101, name: 'Spirit' }] };
    > 217 |       mockPrisma.user.findUnique.mockResolvedValue(mockUser);
          |                                  ^
      218 |
      219 |       const result = await getUserWithHorses(1);
      220 |       expect(mockPrisma.user.findUnique).toHaveBeenCalledWith({

      at Object.<anonymous> (models/userModel.test.mjs:217:34)

  ● �� UNIT: User Model - Database Operations & Business Logic › updateUser › should update user successfully

    TypeError: mockPrisma.user.update.mockResolvedValue is not a function

      235 |     it('should update user successfully', async () => {
      236 |       const mockUpdatedUser = { id: 1, username: 'testuser', ...updateData };
    > 237 |       mockPrisma.user.update.mockResolvedValue(mockUpdatedUser);
          |                              ^
      238 |
      239 |       const result = await updateUser(1, updateData);
      240 |       expect(mockPrisma.user.update).toHaveBeenCalledWith({

      at Object.<anonymous> (models/userModel.test.mjs:237:30)

  ● �� UNIT: User Model - Database Operations & Business Logic › updateUser › should handle Prisma update errors (user not found)

    TypeError: mockPrisma.user.update.mockRejectedValue is not a function

      253 |     it('should handle Prisma update errors (user not found)', async () => {
      254 |       const prismaError = { code: 'P2025', message: 'Record to update not found.' };
    > 255 |       mockPrisma.user.update.mockRejectedValue(prismaError);
          |                              ^
      256 |
      257 |       const result = await updateUser(1, updateData);
      258 |       expect(result).toBeNull(); // Returns null when user not found

      at Object.<anonymous> (models/userModel.test.mjs:255:30)

  ● �� UNIT: User Model - Database Operations & Business Logic › updateUser › should handle general update errors

    TypeError: mockPrisma.user.update.mockRejectedValue is not a function

      261 |     it('should handle general update errors', async () => {
      262 |       const prismaError = { message: 'Some other update error' };
    > 263 |       mockPrisma.user.update.mockRejectedValue(prismaError);
          |                              ^
      264 |
      265 |       await expect(updateUser(1, updateData)).rejects.toThrow(
      266 |         new DatabaseError('Update failed: Some other update error'),

      at Object.<anonymous> (models/userModel.test.mjs:263:30)

  ● �� UNIT: User Model - Database Operations & Business Logic › deleteUser › should delete user successfully

    TypeError: mockPrisma.user.delete.mockResolvedValue is not a function

      272 |     it('should delete user successfully', async () => {
      273 |       const deletedUser = { id: 1, username: 'testuser' };
    > 274 |       mockPrisma.user.delete.mockResolvedValue(deletedUser);
          |                              ^
      275 |
      276 |       const result = await deleteUser(1);
      277 |       expect(mockPrisma.user.delete).toHaveBeenCalledWith({ where: { id: 1 } });

      at Object.<anonymous> (models/userModel.test.mjs:274:30)

  ● �� UNIT: User Model - Database Operations & Business Logic › deleteUser › should handle Prisma delete errors (user not found)

    TypeError: mockPrisma.user.delete.mockRejectedValue is not a function

      285 |     it('should handle Prisma delete errors (user not found)', async () => {
      286 |       const prismaError = { code: 'P2025', message: 'Record to delete not found.' };
    > 287 |       mockPrisma.user.delete.mockRejectedValue(prismaError);
          |                              ^
      288 |
      289 |       const result = await deleteUser(99);
      290 |       expect(result).toBeNull(); // Returns null when user not found

      at Object.<anonymous> (models/userModel.test.mjs:287:30)

  ● �� UNIT: User Model - Database Operations & Business Logic › addXpToUser › should add XP without leveling up

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      296 |
      297 |     it('should add XP without leveling up', async () => {
    > 298 |       mockPrisma.user.findUnique.mockResolvedValue(baseUser);
          |                                  ^
      299 |       const updatedUser = { ...baseUser, xp: 70, level: 1 };
      300 |       mockPrisma.user.update.mockResolvedValue(updatedUser);
      301 |

      at Object.<anonymous> (models/userModel.test.mjs:298:34)

  ● �� UNIT: User Model - Database Operations & Business Logic › addXpToUser › should add XP and level up

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      313 |
      314 |     it('should add XP and level up', async () => {
    > 315 |       mockPrisma.user.findUnique.mockResolvedValue(baseUser);
          |                                  ^
      316 |       const updatedUser = { ...baseUser, xp: 200, level: 2 };
      317 |       mockPrisma.user.update.mockResolvedValue(updatedUser);
      318 |

      at Object.<anonymous> (models/userModel.test.mjs:315:34)

  ● �� UNIT: User Model - Database Operations & Business Logic › addXpToUser › should return error for invalid XP amount

    expect(received).toHaveBeenCalledWith(...expected)

    Matcher error: received value must be a mock or spy function

    Received has type:  function
    Received has value: [Function anonymous]

      337 |         }),
      338 |       );
    > 339 |       expect(mockLogger.error).toHaveBeenCalledWith(
          |                                ^
      340 |         expect.stringContaining('Error: XP amount must be a positive number.'),
      341 |       );
      342 |     });

      at Object.<anonymous> (models/userModel.test.mjs:339:32)

  ● �� UNIT: User Model - Database Operations & Business Logic › addXpToUser › should return error for invalid user ID

    expect(received).toHaveBeenCalledWith(...expected)

    Matcher error: received value must be a mock or spy function

    Received has type:  function
    Received has value: [Function anonymous]

      350 |         }),
      351 |       );
    > 352 |       expect(mockLogger.error).toHaveBeenCalledWith(expect.stringContaining('Error: User ID is required.'));
          |                                ^
      353 |     });
      354 |
      355 |     it('should return error if user not found', async () => {

      at Object.<anonymous> (models/userModel.test.mjs:352:32)

  ● �� UNIT: User Model - Database Operations & Business Logic › addXpToUser › should return error if user not found

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      354 |
      355 |     it('should return error if user not found', async () => {
    > 356 |       mockPrisma.user.findUnique.mockResolvedValue(null);
          |                                  ^
      357 |       const result = await addXpToUser(99, 20);
      358 |       expect(result).toEqual(
      359 |         expect.objectContaining({

      at Object.<anonymous> (models/userModel.test.mjs:356:34)

  ● �� UNIT: User Model - Database Operations & Business Logic › getUserProgress › should return user progress

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      369 |     it('should return user progress', async () => {
      370 |       const mockUser = { id: 1, level: 1, xp: 50 };
    > 371 |       mockPrisma.user.findUnique.mockResolvedValue(mockUser);
          |                                  ^
      372 |
      373 |       const result = await getUserProgress(1);
      374 |

      at Object.<anonymous> (models/userModel.test.mjs:371:34)

  ● �� UNIT: User Model - Database Operations & Business Logic › getUserProgress › should throw DatabaseError if user not found

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      389 |
      390 |     it('should throw DatabaseError if user not found', async () => {
    > 391 |       mockPrisma.user.findUnique.mockResolvedValue(null);
          |                                  ^
      392 |       await expect(getUserProgress(99)).rejects.toThrow(new DatabaseError('Progress fetch failed: User not found.'));
      393 |     });
      394 |   });

      at Object.<anonymous> (models/userModel.test.mjs:391:34)

  ● �� UNIT: User Model - Database Operations & Business Logic › getUserStats › should return user stats with horses

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      409 |       };
      410 |
    > 411 |       mockPrisma.user.findUnique.mockResolvedValue(mockUser);
          |                                  ^
      412 |
      413 |       const result = await getUserStats(1);
      414 |

      at Object.<anonymous> (models/userModel.test.mjs:411:34)

  ● �� UNIT: User Model - Database Operations & Business Logic › getUserStats › should handle user with no horses

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      442 |       };
      443 |
    > 444 |       mockPrisma.user.findUnique.mockResolvedValue(mockUser);
          |                                  ^
      445 |
      446 |       const result = await getUserStats(2);
      447 |

      at Object.<anonymous> (models/userModel.test.mjs:444:34)

  ● �� UNIT: User Model - Database Operations & Business Logic › getUserStats › should handle user with null horses array

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      468 |       };
      469 |
    > 470 |       mockPrisma.user.findUnique.mockResolvedValue(mockUser);
          |                                  ^
      471 |
      472 |       const result = await getUserStats(3);
      473 |       expect(result).toEqual(

      at Object.<anonymous> (models/userModel.test.mjs:470:34)

  ● �� UNIT: User Model - Database Operations & Business Logic › getUserStats › should return null for non-existent user

    TypeError: mockPrisma.user.findUnique.mockResolvedValue is not a function

      480 |
      481 |     it('should return null for non-existent user', async () => {
    > 482 |       mockPrisma.user.findUnique.mockResolvedValue(null);
          |                                  ^
      483 |
      484 |       const result = await getUserStats(999);
      485 |       expect(result).toBeNull();

      at Object.<anonymous> (models/userModel.test.mjs:482:34)

 FAIL  backend/tests/trainingCooldown.test.mjs
  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › canTrain › should return true for horse with no cooldown

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › canTrain › should return true for horse with cooldown in the past

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › canTrain › should return false for horse with cooldown in the future

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › canTrain › should throw error for null horse

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › canTrain › should throw error for undefined horse

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › getCooldownTimeRemaining › should return null forhorse with no cooldown

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › getCooldownTimeRemaining › should return null forhorse with cooldown in the past

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › getCooldownTimeRemaining › should return positivemilliseconds for horse with cooldown in the future

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › getCooldownTimeRemaining › should return approximately correct time remaining

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › getCooldownTimeRemaining › should throw error fornull horse

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › getCooldownTimeRemaining › should throw error forundefined horse

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › setCooldown › should set cooldown 7 days in the future

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › setCooldown › should return updated horse with relations

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › setCooldown › should throw error for non-existenthorse ID

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › setCooldown › should throw error for null horse ID

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › setCooldown › should throw error for undefined horse ID

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › setCooldown › should throw error for invalid horse ID (string)

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › setCooldown › should throw error for invalid horse ID (negative)

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › setCooldown › should throw error for invalid horse ID (zero)

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › setCooldown › should handle string horse ID that can be parsed to integer

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › formatCooldown › should return "Ready to train" for null input

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › formatCooldown › should return "Ready to train" for zero milliseconds

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › formatCooldown › should return "Ready to train" for negative milliseconds

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › formatCooldown › should format minutes correctly

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › formatCooldown › should format hours and minutes correctly

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › formatCooldown › should format days and hours correctly

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › formatCooldown › should format exactly 7 days correctly

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › Integration Tests › should complete full trainingcooldown workflow

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

  ● ⏰ UNIT: Training Cooldown System - Horse Training Restrictions › Integration Tests › should work with horse retrieved from database

    TypeError: createHorse.mockResolvedValue is not a function

       99 |
      100 |     // Setup default mock responses
    > 101 |     createHorse.mockResolvedValue(testHorse);
          |                 ^
      102 |     getHorseById.mockResolvedValue(testHorse);
      103 |     mockPrisma.horse.update.mockResolvedValue(testHorse);
      104 |     mockPrisma.horse.findUnique.mockResolvedValue(testHorse);

      at Object.<anonymous> (tests/trainingCooldown.test.mjs:101:17)

 FAIL  backend/tests/traitEvaluation.test.mjs
  ● �� UNIT: Trait Evaluation System - Trait Revelation & Validation › evaluateTraitRevelation › should use developmentage for young foals

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[traitEvaluation.evaluateTraitRevelation] Evaluating traits for foal 1 on day 5"

    Number of calls: 0

      210 |
      211 |       // Should use development day (5) instead of age (0) for trait evaluation
    > 212 |       expect(mockLogger.info).toHaveBeenCalledWith('[traitEvaluation.evaluateTraitRevelation] Evaluating traits for foal 1 on day 5');
          |                               ^
      213 |     });
      214 |
      215 |     it('should not reveal traits when random chance is too high', async () => {

      at Object.<anonymous> (tests/traitEvaluation.test.mjs:212:31)

  ● �� UNIT: Trait Evaluation System - Trait Revelation & Validation › Error Handling › should handle errors gracefully

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      357 |       }).toThrow();
      358 |
    > 359 |       expect(mockLogger.error).toHaveBeenCalled();
          |                                ^
      360 |     });
      361 |
      362 |     it('should handle missing foal properties', () => {

      at Object.<anonymous> (tests/traitEvaluation.test.mjs:359:32)

 FAIL  backend/__tests__/unit/security/ownership-checks.test.mjs
  ● Ownership Validation Unit Tests › Owned Resource Scenarios › should allow access to owned horse

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

  ● Ownership Validation Unit Tests › Owned Resource Scenarios › should allow access to owned groom

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

  ● Ownership Validation Unit Tests › Owned Resource Scenarios › should attach resource to request object and validatedResources

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

  ● Ownership Validation Unit Tests › Owned Resource Scenarios › should work with custom idParam

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

  ● Ownership Validation Unit Tests › Not Owned Resource Scenarios › should return 404 for horse owned by different user

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

  ● Ownership Validation Unit Tests › Not Owned Resource Scenarios › should return 404 for groom owned by different user

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

  ● Ownership Validation Unit Tests › Resource Type Validation › should handle training-session resource type (maps to trainingLog)

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

  ● Ownership Validation Unit Tests › Resource Type Validation › should handle competition-entry resource type (maps tocompetitionResult)

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

  ● Ownership Validation Unit Tests › findOwnedResource Helper Function › should find owned horse using ownerId

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

  ● Ownership Validation Unit Tests › findOwnedResource Helper Function › should find owned groom using userId

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

  ● Ownership Validation Unit Tests › validateBatchOwnership Helper Function › should validate ownership of multiple horses using ownerId

    TypeError: mockHorseFindFirst.mockImplementation is not a function

      109 |   // Set up mock implementations to read from mockState dynamically
      110 |   // This allows tests to mutate mockState and have mocks return the current value
    > 111 |   mockHorseFindFirst.mockImplementation(async () => mockState.horseFindFirst);
          |                      ^
      112 |   mockHorseFindUnique.mockImplementation(async () => mockState.horseFindUnique);
      113 |   mockHorseFindMany.mockImplementation(async () => mockState.horseFindMany);
      114 |   mockGroomFindFirst.mockImplementation(async () => mockState.groomFindFirst);

      at Object.<anonymous> (__tests__/unit/security/ownership-checks.test.mjs:111:22)

 FAIL  backend/__tests__/unit/cacheHelper.test.mjs
  ● CacheHelper › Connection Management › should initialize Redis connection successfully

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      147 |
      148 |       // Redis should have been initialized
    > 149 |       expect(mockRedisInstance.connect).toHaveBeenCalled();
          |                                         ^
      150 |     });
      151 |
      152 |     it('should handle connection failure gracefully', async () => {

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:149:41)

  ● CacheHelper › getCachedQuery() › should execute query on cache miss and store result

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "horse:1"

    Number of calls: 0

      184 |       expect(queryFn).toHaveBeenCalledTimes(1);
      185 |       expect(result).toEqual({ id: 1, name: 'Horse' });
    > 186 |       expect(mockRedisInstance.get).toHaveBeenCalledWith('horse:1');
          |                                     ^
      187 |       expect(mockRedisInstance.setex).toHaveBeenCalledWith('horse:1', 120, JSON.stringify({ id: 1, name: 'Horse' }));
      188 |       expect(cacheStats.misses).toBe(1);
      189 |       expect(cacheStats.hits).toBe(0);

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:186:37)

  ● CacheHelper › getCachedQuery() › should return cached result on cache hit without executing query

    expect(jest.fn()).not.toHaveBeenCalled()

    Expected number of calls: 0
    Received number of calls: 1

    1: called with 0 arguments

      207 |       const result = await getCachedQuery('horse:1', queryFn, 120);
      208 |
    > 209 |       expect(queryFn).not.toHaveBeenCalled();
          |                           ^
      210 |       expect(result).toEqual(cachedData);
      211 |       expect(cacheStats.hits).toBe(1);
      212 |       expect(cacheStats.misses).toBe(0);

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:209:27)

  ● CacheHelper › getCachedQuery() › should use default TTL of 60 seconds when not specified

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "test:key", 60, Any<String>

    Number of calls: 0

      225 |       await getCachedQuery('test:key', queryFn);
      226 |
    > 227 |       expect(mockRedisInstance.setex).toHaveBeenCalledWith('test:key', 60, expect.any(String));
          |                                       ^
      228 |     });
      229 |
      230 |     it('should handle JSON parse errors gracefully', async () => {

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:227:39)

  ● CacheHelper › getCachedQuery() › should handle cache write errors gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      275 |       // Should return query result despite cache write failure
      276 |       expect(result).toEqual({ data: 'result' });
    > 277 |       expect(cacheStats.errors).toBe(1);
          |                                 ^
      278 |     });
      279 |
      280 |     it('should bypass cache when Redis unavailable', async () => {

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:277:33)

  ● CacheHelper › invalidateCache() › should delete single cache key successfully

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      302 |       const deleted = await invalidateCache('horse:1');
      303 |
    > 304 |       expect(deleted).toBe(1);
          |                       ^
      305 |       expect(mockRedisInstance.del).toHaveBeenCalledWith('horse:1');
      306 |       expect(cacheStats.invalidations).toBe(1);
      307 |     });

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:304:23)

  ● CacheHelper › invalidateCache() › should handle invalidation errors gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      327 |
      328 |       expect(deleted).toBe(0);
    > 329 |       expect(cacheStats.errors).toBe(1);
          |                                 ^
      330 |     });
      331 |   });
      332 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:329:33)

  ● CacheHelper › invalidateCachePattern() › should delete all keys matching pattern

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 0

      343 |       const deleted = await invalidateCachePattern('horse:*');
      344 |
    > 345 |       expect(deleted).toBe(3);
          |                       ^
      346 |       expect(mockRedisInstance.keys).toHaveBeenCalledWith('horse:*');
      347 |       expect(mockRedisInstance.del).toHaveBeenCalledWith('horse:1', 'horse:2', 'horse:3');
      348 |       expect(cacheStats.invalidations).toBe(3);

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:345:23)

  ● CacheHelper › invalidateCachePattern() › should handle pattern errors gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      374 |
      375 |       expect(deleted).toBe(0);
    > 376 |       expect(cacheStats.errors).toBe(1);
          |                                 ^
      377 |     });
      378 |   });
      379 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:376:33)

  ● CacheHelper › invalidateCacheMultiple() › should delete multiple keys at once

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 0

      389 |       const deleted = await invalidateCacheMultiple(['horse:1', 'horse:2', 'groom:1']);
      390 |
    > 391 |       expect(deleted).toBe(3);
          |                       ^
      392 |       expect(mockRedisInstance.del).toHaveBeenCalledWith('horse:1', 'horse:2', 'groom:1');
      393 |       expect(cacheStats.invalidations).toBe(3);
      394 |     });

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:391:23)

  ● CacheHelper › invalidateCacheMultiple() › should handle errors gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      410 |
      411 |       expect(deleted).toBe(0);
    > 412 |       expect(cacheStats.errors).toBe(1);
          |                                 ^
      413 |     });
      414 |   });
      415 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:412:33)

  ● CacheHelper › clearAllCache() › should clear all cache keys successfully

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      425 |       const success = await clearAllCache();
      426 |
    > 427 |       expect(success).toBe(true);
          |                       ^
      428 |       expect(mockRedisInstance.flushdb).toHaveBeenCalled();
      429 |       expect(cacheStats.invalidations).toBe(1);
      430 |     });

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:427:23)

  ● CacheHelper › clearAllCache() › should handle errors gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      449 |
      450 |       expect(success).toBe(false);
    > 451 |       expect(cacheStats.errors).toBe(1);
          |                                 ^
      452 |     });
      453 |   });
      454 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:451:33)

  ● CacheHelper › getCacheStatistics() › should include Redis statistics when available

    expect(received).toBeDefined()

    Received: undefined

      499 |       const stats = await getCacheStatistics();
      500 |
    > 501 |       expect(stats.redis).toBeDefined();
          |                           ^
      502 |       expect(stats.redis.totalKeys).toBe(42);
      503 |       expect(stats.redis.memoryUsed).toBe('10M');
      504 |     });

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:501:27)

  ● CacheHelper › closeRedisConnection() › should close Redis connection gracefully

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      540 |       await closeRedisConnection();
      541 |
    > 542 |       expect(mockRedisInstance.quit).toHaveBeenCalled();
          |                                      ^
      543 |     });
      544 |
      545 |     it('should be idempotent (safe to call multiple times)', async () => {

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:542:38)

  ● CacheHelper › Cache Invalidation Helpers › should invalidate all horses caches

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      585 |       const deleted = await cacheInvalidation.horses();
      586 |
    > 587 |       expect(deleted).toBe(2);
          |                       ^
      588 |       expect(mockRedisInstance.keys).toHaveBeenCalledWith('horses:*');
      589 |     });
      590 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:587:23)

  ● CacheHelper › Cache Invalidation Helpers › should invalidate specific horse cache

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      599 |       const deleted = await cacheInvalidation.horse(123);
      600 |
    > 601 |       expect(deleted).toBe(1);
          |                       ^
      602 |       expect(mockRedisInstance.del).toHaveBeenCalledWith('horse:123');
      603 |     });
      604 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:601:23)

  ● CacheHelper › Cache Invalidation Helpers › should invalidate all grooms caches

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      614 |       const deleted = await cacheInvalidation.grooms();
      615 |
    > 616 |       expect(deleted).toBe(1);
          |                       ^
      617 |       expect(mockRedisInstance.keys).toHaveBeenCalledWith('grooms:*');
      618 |     });
      619 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:616:23)

  ● CacheHelper › Cache Invalidation Helpers › should invalidate specific groom cache

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      628 |       const deleted = await cacheInvalidation.groom(456);
      629 |
    > 630 |       expect(deleted).toBe(1);
          |                       ^
      631 |       expect(mockRedisInstance.del).toHaveBeenCalledWith('groom:456');
      632 |     });
      633 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:630:23)

  ● CacheHelper › Cache Invalidation Helpers › should invalidate all leaderboards caches

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      643 |       const deleted = await cacheInvalidation.leaderboards();
      644 |
    > 645 |       expect(deleted).toBe(1);
          |                       ^
      646 |       expect(mockRedisInstance.keys).toHaveBeenCalledWith('leaderboard:*');
      647 |     });
      648 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:645:23)

  ● CacheHelper › Cache Invalidation Helpers › should invalidate all competitions caches

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      658 |       const deleted = await cacheInvalidation.competitions();
      659 |
    > 660 |       expect(deleted).toBe(1);
          |                       ^
      661 |       expect(mockRedisInstance.keys).toHaveBeenCalledWith('competition:*');
      662 |     });
      663 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:660:23)

  ● CacheHelper › Cache Invalidation Helpers › should invalidate specific competition cache

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      672 |       const deleted = await cacheInvalidation.competition(789);
      673 |
    > 674 |       expect(deleted).toBe(1);
          |                       ^
      675 |       expect(mockRedisInstance.del).toHaveBeenCalledWith('competition:789');
      676 |     });
      677 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:674:23)

  ● CacheHelper › Cache Invalidation Helpers › should invalidate all users caches

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      687 |       const deleted = await cacheInvalidation.users();
      688 |
    > 689 |       expect(deleted).toBe(1);
          |                       ^
      690 |       expect(mockRedisInstance.keys).toHaveBeenCalledWith('user:*');
      691 |     });
      692 |

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:689:23)

  ● CacheHelper › Cache Invalidation Helpers › should invalidate specific user cache

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      701 |       const deleted = await cacheInvalidation.user(999);
      702 |
    > 703 |       expect(deleted).toBe(1);
          |                       ^
      704 |       expect(mockRedisInstance.del).toHaveBeenCalledWith('user:999');
      705 |     });
      706 |   });

      at Object.<anonymous> (__tests__/unit/cacheHelper.test.mjs:703:23)

 FAIL  backend/tests/unit/advancedLineageAnalysis.test.mjs
  ● �� Advanced Lineage Analysis System › �� Visualization Data Generation › should create visualization-ready data structure

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

      362 |
      363 |       // Cleanup
    > 364 |       await prisma.horse.delete({ where: { id: stallion.id } });
          |       ^
      365 |       await prisma.horse.delete({ where: { id: mare.id } });
      366 |     });
      367 |   });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/unit/advancedLineageAnalysis.test.mjs:364:7)

 FAIL  backend/tests/trainingController-business-logic.test.mjs
  ● ��️ INTEGRATION: Training Controller Business Logic - Complete Training Workflow › BUSINESS RULE: getTrainingStatus() Function Validation › RETURNS accurate status for horse with no training history

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

    - ObjectContaining {
    + Object {
        "cooldown": null,
        "eligible": true,
    -   "horseAge": Any<Number>,
    +   "horseAge": null,
        "lastTrainingDate": null,
        "reason": null,
      }

      463 |       const result = await getTrainingStatus(adultHorse.id, 'Dressage'); // Fixed: added required discipline parameter
      464 |
    > 465 |       expect(result).toEqual(
          |                      ^
      466 |         expect.objectContaining({
      467 |           eligible: true, // Fixed: match actual API structure
      468 |           reason: null, // Fixed: when eligible=true, reason is null

      at Object.<anonymous> (tests/trainingController-business-logic.test.mjs:465:22)

  ● ��️ INTEGRATION: Training Controller Business Logic - Complete Training Workflow › BUSINESS RULE: getTrainingStatus() Function Validation › RETURNS accurate status for horse with training history

    expect(received).toEqual(expected) // deep equality

    - Expected  - 8
    + Received  + 5

    - ObjectContaining {
    -   "cooldown": ObjectContaining {
    -     "active": true,
    -     "remainingDays": Any<Number>,
    -   },
    + Object {
    +   "cooldown": null,
        "eligible": false,
    -   "horseAge": Any<Number>,
    -   "lastTrainingDate": Any<Date>,
    -   "reason": Any<String>,
    +   "horseAge": null,
    +   "lastTrainingDate": null,
    +   "reason": "Horse not found",
      }

      477 |       const result = await getTrainingStatus(trainedHorse.id, 'Racing'); // Fixed: added required discipline parameter
      478 |
    > 479 |       expect(result).toEqual(
          |                      ^
      480 |         expect.objectContaining({
      481 |           eligible: false, // Fixed: match actual API structure
      482 |           reason: expect.any(String),

      at Object.<anonymous> (tests/trainingController-business-logic.test.mjs:479:22)

  ● ��️ INTEGRATION: Training Controller Business Logic - Complete Training Workflow › BUSINESS RULE: getTrainableHorses() Function Validation › RETURNS array of trainable horses for user

    expect(received).toEqual(expected) // deep equality

    Expected: ArrayContaining [ObjectContaining {"age": 3, "horseId": Any<Number>, "name": "Controller Horse 2", "trainableDisciplines": ArrayContaining ["Racing", "Dressage"]}]
    Received: []

      514 |       const result = await getTrainableHorses(userWithHorses.id);
      515 |
    > 516 |       expect(result).toEqual(
          |                      ^
      517 |         expect.arrayContaining([
      518 |           expect.objectContaining({
      519 |             horseId: expect.any(Number), // Fixed: match actual API structure

      at Object.<anonymous> (tests/trainingController-business-logic.test.mjs:516:22)

  ● ��️ INTEGRATION: Training Controller Business Logic - Complete Training Workflow › API INTEGRATION: trainRouteHandler() Function Validation › PROCESSES valid training request and RETURNS success response

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_breedId_fkey`

      540 |     it('PROCESSES valid training request and RETURNS success response', async () => {
      541 |       // Fixed: Create a fresh horse for this test since adultHorse may be in cooldown
    > 542 |       const freshHorse = await prisma.horse.create({
          |                          ^
      543 |         data: {
      544 |           name: 'Fresh Route Test Horse',
      545 |           age: 4,

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/trainingController-business-logic.test.mjs:542:26)

  ● ��️ INTEGRATION: Training Controller Business Logic - Complete Training Workflow › API INTEGRATION: trainRouteHandler() Function Validation › RETURNS error response for ineligible horse

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"message": StringContaining "Horse is under age", "success": false}
    Received: {"message": "Training not allowed: Horse not found", "success": false}

    Number of calls: 1

      595 |
      596 |       expect(mockRes.status).toHaveBeenCalledWith(400);
    > 597 |       expect(mockRes.json).toHaveBeenCalledWith(
          |                            ^
      598 |         expect.objectContaining({
      599 |           success: false,
      600 |           message: expect.stringContaining('Horse is under age'), // Fixed: match actual error message

      at Object.<anonymous> (tests/trainingController-business-logic.test.mjs:597:28)

  ● ��️ INTEGRATION: Training Controller Business Logic - Complete Training Workflow › API INTEGRATION: trainRouteHandler() Function Validation › RETURNS error response for horse in cooldown

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"message": StringContaining "Training cooldown active", "success": false}
    Received: {"message": "Training not allowed: Horse not found", "success": false}

    Number of calls: 1

      618 |
      619 |       expect(mockRes.status).toHaveBeenCalledWith(400);
    > 620 |       expect(mockRes.json).toHaveBeenCalledWith(
          |                            ^
      621 |         expect.objectContaining({
      622 |           success: false,
      623 |           message: expect.stringContaining('Training cooldown active'), // Fixed: match actual error message

      at Object.<anonymous> (tests/trainingController-business-logic.test.mjs:620:28)

 FAIL  backend/tests/services/personalityEvolutionSystem.test.mjs
  ● Personality Evolution System › Groom Personality Evolution › should not evolve personality with insufficient interaction data

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      141 |     test('should not evolve personality with insufficient interaction data', async () => {
      142 |       // Create new groom with minimal interactions
    > 143 |       const newGroom = await prisma.groom.create({
          |                        ^
      144 |         data: {
      145 |           userId: testUser.id,
      146 |           name: 'Minimal Interaction Groom',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/personalityEvolutionSystem.test.mjs:143:24)

  ● Personality Evolution System › Horse Temperament Evolution › should evolve horse temperament based on care history

    PrismaClientKnownRequestError:
    Invalid `prisma.groomInteraction.create()` invocation:


    Foreign key constraint violated on the constraint: `groom_interactions_foalId_fkey`

      185 |       // Create consistent positive care history
      186 |       for (let i = 0; i < 15; i++) {
    > 187 |         await prisma.groomInteraction.create({
          |         ^
      188 |           data: {
      189 |             groomId: testGroom.id,
      190 |             foalId: testHorse.id,

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/personalityEvolutionSystem.test.mjs:187:9)

  ● Personality Evolution System › Horse Temperament Evolution › should maintain temperament stability with mixed care patterns

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No 'Breed' record (needed to inline the relation on 'Horse' record(s)) was found for a nested connect on one-to-many relation 'BreedToHorse'.

      214 |     test('should maintain temperament stability with mixed care patterns', async () => {
      215 |       // Create new horse for mixed care testing
    > 216 |       const mixedCareHorse = await prisma.horse.create({
          |                              ^
      217 |         data: {
      218 |           ownerId: testUser.id,
      219 |           breed: { connect: { id: testBreed.id } },

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/personalityEvolutionSystem.test.mjs:216:30)

  ● Personality Evolution System › Cross-Species Personality Influence › should detect personality convergence between groom and horse

    PrismaClientKnownRequestError:
    Invalid `prisma.groomInteraction.create()` invocation:


    Foreign key constraint violated on the constraint: `groom_interactions_foalId_fkey`

      338 |       // Create long-term interaction history
      339 |       for (let i = 0; i < 30; i++) {
    > 340 |         await prisma.groomInteraction.create({
          |         ^
      341 |           data: {
      342 |             groomId: testGroom.id,
      343 |             foalId: testHorse.id,

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/personalityEvolutionSystem.test.mjs:340:9)


  ● Test suite failed to run

    PrismaClientKnownRequestError:
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

      103 |     await prisma.horse.deleteMany({ where: { ownerId: testUser.id } });
      104 |     await prisma.groom.deleteMany({ where: { userId: testUser.id } });
    > 105 |     await prisma.user.delete({ where: { id: testUser.id } });
          |     ^
      106 |   });
      107 |
      108 |   describe('Groom Personality Evolution', () => {

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/services/personalityEvolutionSystem.test.mjs:105:5)

 FAIL  backend/tests/horseAgingIntegration.test.mjs
  ● Horse Aging Integration › Complete Aging Workflow › should process foal birthday with trait milestone evaluation

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 5

      144 |
      145 |       // Verify aging process results
    > 146 |       expect(result.totalProcessed).toBe(1);
          |                                     ^
      147 |       expect(result.birthdaysFound).toBe(1);
      148 |       expect(result.milestonesTriggered).toBe(1);
      149 |       expect(result.errors).toBe(0);

      at Object.<anonymous> (tests/horseAgingIntegration.test.mjs:146:37)

 FAIL  backend/tests/integration/horseOverview.test.mjs
  ● �� INTEGRATION: Horse Overview API - Real Database Integration › GET /api/horses/:id/overview › should handle missing optional fields gracefully

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

      90 |
      91 |     // Create test horse with real data
    > 92 |     testHorse = await prisma.horse.create({
         |                 ^
      93 |       data: {
      94 |         name: 'TestHorse Nova',
      95 |         age: 5,

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/integration/horseOverview.test.mjs:92:17)

 FAIL  backend/tests/traitTimeline.test.mjs
  ● Trait Timeline System › Trait Timeline Data Aggregation › should include detailed trait context and groom involvement

    PrismaClientKnownRequestError:
    Invalid `prisma.traitHistoryLog.create()` invocation:


    Foreign key constraint violated on the constraint: `trait_history_logs_horseId_fkey`

      175 |     it('should include detailed trait context and groom involvement', async () => {
      176 |       // Create trait with detailed groom context
    > 177 |       await prisma.traitHistoryLog.create({
          |       ^
      178 |         data: {
      179 |           horseId: testHorse.id,
      180 |           traitName: 'empathic',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/traitTimeline.test.mjs:177:7)

  ● Trait Timeline System › Trait Timeline Data Aggregation › should include detailed trait context and groom involvement

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

       96 |     // Clean up test data
       97 |     if (testHorse) {
    >  98 |       await prisma.horse.delete({ where: { id: testHorse.id } });
          |       ^
       99 |     }
      100 |     if (testGroom) {
      101 |       await prisma.groom.delete({ where: { id: testGroom.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/traitTimeline.test.mjs:98:7)

  ● Trait Timeline System › Trait Timeline Data Aggregation › should filter traits by age cutoff (before age 4)

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_breedId_fkey`

      69 |
      70 |     // Create test horse (3 years old)
    > 71 |     testHorse = await prisma.horse.create({
         |                 ^
      72 |       data: {
      73 |         name: `TestHorse_${Date.now()}`,
      74 |         sex: 'stallion',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/traitTimeline.test.mjs:71:17)

  ● Trait Timeline System › Trait Timeline Data Aggregation › should filter traits by age cutoff (before age 4)

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

       96 |     // Clean up test data
       97 |     if (testHorse) {
    >  98 |       await prisma.horse.delete({ where: { id: testHorse.id } });
          |       ^
       99 |     }
      100 |     if (testGroom) {
      101 |       await prisma.groom.delete({ where: { id: testGroom.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/traitTimeline.test.mjs:98:7)

  ● Trait Timeline System › Trait Timeline Data Aggregation › should categorize traits by type and rarity

    PrismaClientKnownRequestError:
    Invalid `prisma.traitHistoryLog.create()` invocation:


    Foreign key constraint violated on the constraint: `trait_history_logs_horseId_fkey`

      265 |
      266 |       for (const trait of traitHistory) {
    > 267 |         await prisma.traitHistoryLog.create({
          |         ^
      268 |           data: {
      269 |             horseId: testHorse.id,
      270 |             traitName: trait.traitName,

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/traitTimeline.test.mjs:267:9)

  ● Trait Timeline System › Trait Timeline Data Aggregation › should categorize traits by type and rarity

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

       96 |     // Clean up test data
       97 |     if (testHorse) {
    >  98 |       await prisma.horse.delete({ where: { id: testHorse.id } });
          |       ^
       99 |     }
      100 |     if (testGroom) {
      101 |       await prisma.groom.delete({ where: { id: testGroom.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/traitTimeline.test.mjs:98:7)

  ● Trait Timeline System › Trait Timeline Data Aggregation › should handle horses with no trait history

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

       96 |     // Clean up test data
       97 |     if (testHorse) {
    >  98 |       await prisma.horse.delete({ where: { id: testHorse.id } });
          |       ^
       99 |     }
      100 |     if (testGroom) {
      101 |       await prisma.groom.delete({ where: { id: testGroom.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/traitTimeline.test.mjs:98:7)

  ● Trait Timeline System › Timeline Formatting and Organization › should organize events by age ranges

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_breedId_fkey`

      69 |
      70 |     // Create test horse (3 years old)
    > 71 |     testHorse = await prisma.horse.create({
         |                 ^
      72 |       data: {
      73 |         name: `TestHorse_${Date.now()}`,
      74 |         sex: 'stallion',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/traitTimeline.test.mjs:71:17)

  ● Trait Timeline System › Timeline Formatting and Organization › should organize events by age ranges

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

       96 |     // Clean up test data
       97 |     if (testHorse) {
    >  98 |       await prisma.horse.delete({ where: { id: testHorse.id } });
          |       ^
       99 |     }
      100 |     if (testGroom) {
      101 |       await prisma.groom.delete({ where: { id: testGroom.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/traitTimeline.test.mjs:98:7)

  ● Trait Timeline System › Timeline Formatting and Organization › should include bond and stress trend analysis

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      55 |
      56 |     // Create test groom
    > 57 |     testGroom = await prisma.groom.create({
         |                 ^
      58 |       data: {
      59 |         name: `TestGroom_${Date.now()}`,
      60 |         speciality: 'foal_care',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/traitTimeline.test.mjs:57:17)

  ● Trait Timeline System › Timeline Formatting and Organization › should include bond and stress trend analysis

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

       96 |     // Clean up test data
       97 |     if (testHorse) {
    >  98 |       await prisma.horse.delete({ where: { id: testHorse.id } });
          |       ^
       99 |     }
      100 |     if (testGroom) {
      101 |       await prisma.groom.delete({ where: { id: testGroom.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/traitTimeline.test.mjs:98:7)

  ● Trait Timeline System › API Endpoints › should get trait timeline card via API

    PrismaClientKnownRequestError:
    Invalid `prisma.traitHistoryLog.create()` invocation:


    Foreign key constraint violated on the constraint: `trait_history_logs_horseId_fkey`

      385 |     it('should get trait timeline card via API', async () => {
      386 |       // Create some trait history
    > 387 |       await prisma.traitHistoryLog.create({
          |       ^
      388 |         data: {
      389 |           horseId: testHorse.id,
      390 |           traitName: 'noble',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/traitTimeline.test.mjs:387:7)

  ● Trait Timeline System › API Endpoints › should get trait timeline card via API

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

       96 |     // Clean up test data
       97 |     if (testHorse) {
    >  98 |       await prisma.horse.delete({ where: { id: testHorse.id } });
          |       ^
       99 |     }
      100 |     if (testGroom) {
      101 |       await prisma.groom.delete({ where: { id: testGroom.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/traitTimeline.test.mjs:98:7)

  ● Trait Timeline System › API Endpoints › should require authentication for trait card endpoint

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      55 |
      56 |     // Create test groom
    > 57 |     testGroom = await prisma.groom.create({
         |                 ^
      58 |       data: {
      59 |         name: `TestGroom_${Date.now()}`,
      60 |         speciality: 'foal_care',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/traitTimeline.test.mjs:57:17)

  ● Trait Timeline System › API Endpoints › should require authentication for trait card endpoint

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

       96 |     // Clean up test data
       97 |     if (testHorse) {
    >  98 |       await prisma.horse.delete({ where: { id: testHorse.id } });
          |       ^
       99 |     }
      100 |     if (testGroom) {
      101 |       await prisma.groom.delete({ where: { id: testGroom.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/traitTimeline.test.mjs:98:7)

  ● Trait Timeline System › API Endpoints › should return 404 for non-existent horse

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

       96 |     // Clean up test data
       97 |     if (testHorse) {
    >  98 |       await prisma.horse.delete({ where: { id: testHorse.id } });
          |       ^
       99 |     }
      100 |     if (testGroom) {
      101 |       await prisma.groom.delete({ where: { id: testGroom.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/traitTimeline.test.mjs:98:7)

  ● Trait Timeline System › API Endpoints › should handle horses with empty trait timeline

    PrismaClientKnownRequestError:
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

      55 |
      56 |     // Create test groom
    > 57 |     testGroom = await prisma.groom.create({
         |                 ^
      58 |       data: {
      59 |         name: `TestGroom_${Date.now()}`,
      60 |         speciality: 'foal_care',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/traitTimeline.test.mjs:57:17)

  ● Trait Timeline System › API Endpoints › should handle horses with empty trait timeline

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was foundfor a delete.

       96 |     // Clean up test data
       97 |     if (testHorse) {
    >  98 |       await prisma.horse.delete({ where: { id: testHorse.id } });
          |       ^
       99 |     }
      100 |     if (testGroom) {
      101 |       await prisma.groom.delete({ where: { id: testGroom.id } });

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (tests/traitTimeline.test.mjs:98:7)

 FAIL  backend/tests/integration/leaderboardRoutes.test.mjs
  ● �� INTEGRATION: Leaderboard API - Real Database Integration › GET /api/leaderboards/horses/earnings › should returntop horses by earnings

    expected 200 "OK", got 500 "Internal Server Error"

      370 |         .get('/api/leaderboards/horses/earnings')
      371 |         .set('Authorization', `Bearer ${testToken}`)
    > 372 |         .expect(200);
          |          ^
      373 |
      374 |       expect(response.body.success).toBe(true);
      375 |       expect(response.body.message).toBe('Top horses by earnings retrieved successfully');

      at Object.<anonymous> (tests/integration/leaderboardRoutes.test.mjs:372:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ● �� INTEGRATION: Leaderboard API - Real Database Integration › GET /api/leaderboards/recent-winners › should return recent competition winners

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No 'User' record (needed to inline the relation on 'Horse' record(s)) was found for a nested connect on one-to-many relation 'HorseToUser'.

      159 |
      160 |     // Create test horses with varying earnings
    > 161 |     testHorses = await Promise.all([
          |                  ^
      162 |       prisma.horse.create({
      163 |         data: {
      164 |           name: 'TestLeaderboard Champion',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
          at async Promise.all (index 0)
      at Object.<anonymous> (tests/integration/leaderboardRoutes.test.mjs:161:18)

  ● �� INTEGRATION: Leaderboard API - Real Database Integration › GET /api/leaderboards/recent-winners › should filter by discipline

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No 'User' record (needed to inline the relation on 'Horse' record(s)) was found for a nested connect on one-to-many relation 'HorseToUser'.

      159 |
      160 |     // Create test horses with varying earnings
    > 161 |     testHorses = await Promise.all([
          |                  ^
      162 |       prisma.horse.create({
      163 |         data: {
      164 |           name: 'TestLeaderboard Champion',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
          at async Promise.all (index 2)
      at Object.<anonymous> (tests/integration/leaderboardRoutes.test.mjs:161:18)

  ● �� INTEGRATION: Leaderboard API - Real Database Integration › GET /api/leaderboards/stats › should return comprehensive leaderboard statistics

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No 'User' record (needed to inline the relation on 'Horse' record(s)) was found for a nested connect on one-to-many relation 'HorseToUser'.

      159 |
      160 |     // Create test horses with varying earnings
    > 161 |     testHorses = await Promise.all([
          |                  ^
      162 |       prisma.horse.create({
      163 |         data: {
      164 |           name: 'TestLeaderboard Champion',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
          at async Promise.all (index 2)
      at Object.<anonymous> (tests/integration/leaderboardRoutes.test.mjs:161:18)

 FAIL  backend/tests/integration/dashboardRoutes.test.mjs
  ● �� INTEGRATION: Dashboard API - Real Database Integration › GET /api/user/dashboard/:userId › should handle user with no horses gracefully

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

       98 |
       99 |     // Create test horses with real data
    > 100 |     testHorses = await Promise.all([
          |                  ^
      101 |       prisma.horse.create({
      102 |         data: {
      103 |           name: 'TestDashboard Horse 1',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
          at async Promise.all (index 0)
      at Object.<anonymous> (tests/integration/dashboardRoutes.test.mjs:100:18)

  ● �� INTEGRATION: Dashboard API - Real Database Integration › GET /api/user/dashboard/:userId › should handle user with horses but no activity gracefully

    PrismaClientKnownRequestError:
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

       98 |
       99 |     // Create test horses with real data
    > 100 |     testHorses = await Promise.all([
          |                  ^
      101 |       prisma.horse.create({
      102 |         data: {
      103 |           name: 'TestDashboard Horse 1',

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
          at async Promise.all (index 0)
      at Object.<anonymous> (tests/integration/dashboardRoutes.test.mjs:100:18)

 FAIL  backend/tests/load/rate-limiting.test.js
  ● Test suite failed to run

    Cannot find module 'k6/http' from 'tests/load/rate-limiting.test.js'

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)

 FAIL  backend/tests/load/concurrent-sessions.test.js
  ● Test suite failed to run

    Cannot find module 'k6/http' from 'tests/load/concurrent-sessions.test.js'

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)

 FAIL  backend/tests/load/distributed-rate-limiting.test.js
  ● Test suite failed to run

    Cannot find module 'k6/http' from 'tests/load/distributed-rate-limiting.test.js'

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)

 FAIL  backend/__tests__/integration/security/rate-limit-enforcement.test.mjs
  ● Test suite failed to run

    SyntaxError: Invalid regular expression: missing /

      at Runtime.loadEsmModule (../node_modules/jest-runtime/build/index.js:516:20)

 FAIL  backend/tests/load/auth-under-load.test.js
  ● Test suite failed to run

    Cannot find module 'k6/http' from 'tests/load/auth-under-load.test.js'

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)


Test Suites: 102 failed, 1 skipped, 111 passed, 213 of 214 total
Tests:       989 failed, 18 skipped, 2359 passed, 3366 total
Snapshots:   0 total
Time:        100.59 s
Ran all test suites in 2 projects.
🧹 Running global teardown...
[Teardown] Disconnecting Prisma instances...
[Teardown] ✅ Prisma instances disconnected
✅ Global teardown completed successfully
PS C:\Users\heirr\OneDrive\Desktop\Equoria>
