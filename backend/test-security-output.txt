
> equoria-backend@1.0.0 test:security
> node --experimental-vm-modules node_modules/jest/bin/jest.js --config=jest.config.security.mjs

  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

(node:27432) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:3516) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:27092) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
[2025-12-12 06:13:03] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:03] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] Stopped job: weeklySalaries
[2025-12-12 06:13:03] info: [cronJobService] Stopped job: tokenCleanup
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:03] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:03] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] Stopped job: weeklySalaries
[2025-12-12 06:13:03] info: [cronJobService] Stopped job: tokenCleanup
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:03] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:03] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] Stopped job: weeklySalaries
[2025-12-12 06:13:03] info: [cronJobService] Stopped job: tokenCleanup
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs stopped
(node:17180) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
[2025-12-12 06:13:03] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:03] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] Stopped job: weeklySalaries
[2025-12-12 06:13:03] info: [cronJobService] Stopped job: tokenCleanup
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:03] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:03] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] Stopped job: weeklySalaries
[2025-12-12 06:13:03] info: [cronJobService] Stopped job: tokenCleanup
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:03] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:03] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] Stopped job: weeklySalaries
[2025-12-12 06:13:03] info: [cronJobService] Stopped job: tokenCleanup
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:03] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:03] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:03] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:03] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:03] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] Stopped job: weeklySalaries
[2025-12-12 06:13:03] info: [cronJobService] Stopped job: tokenCleanup
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:03] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:03] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:03] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] Stopped job: weeklySalaries
[2025-12-12 06:13:03] info: [cronJobService] Stopped job: tokenCleanup
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:03] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:03] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:03] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] Stopped job: weeklySalaries
[2025-12-12 06:13:03] info: [cronJobService] Stopped job: tokenCleanup
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:03] info: [auth] Authenticated user 2501 for GET /api/test
[2025-12-12 06:13:03] info: [cronJobService] Manually triggering token cleanup...
[2025-12-12 06:13:03] info: [cronJobService] Starting expired token cleanup...
[2025-12-12 06:13:03] info: [TokenRotation] Token cleanup completed
[2025-12-12 06:13:03] info: [cronJobService] Token cleanup completed. Removed 0 expired/invalidated tokens
[2025-12-12 06:13:03] info: [cronJobService] Manual token cleanup completed: {"removed":0,"expired":0,"invalidated":0,"timestamp":"2025-12-12T11:13:03.813Z"}
[2025-12-12 06:13:03] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:03] info: [auth] Authenticated user 1387 for GET /api/test
[2025-12-12 06:13:03] info: [auth] Authenticated user 1 for GET /api/test
[2025-12-12 06:13:03] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:03] info: [auth] Authenticated user 6635 for GET /api/test
[2025-12-12 06:13:03] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:03] warn: [auth] Session expired due to age for GET /api/test from 127.0.0.1 (8 days old)
[2025-12-12 06:13:03] warn: [auth] Session expired. Please login again. for GET /api/test from 127.0.0.1
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:03] info: [auth] Authenticated user 2812 for GET /api/test
[2025-12-12 06:13:03] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:03] warn: [auth] Session expired due to age for GET /api/test from 127.0.0.1 (7 days old)
[2025-12-12 06:13:03] warn: [auth] Session expired. Please login again. for GET /api/test from 127.0.0.1
[2025-12-12 06:13:03] warn: [auth] Token decode failed for GET /api/test from 127.0.0.1: Unexpected token 'ÔøΩ', "ÔøΩ{⁄ñ'" is not valid JSON
[2025-12-12 06:13:03] warn: [auth] Invalid or expired token for GET /api/test from 127.0.0.1
[2025-12-12 06:13:03] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:03] warn: [auth] Invalid token for GET /api/test from 127.0.0.1: invalid signature
[2025-12-12 06:13:03] warn: [auth] Invalid or expired token for GET /api/test from 127.0.0.1
[2025-12-12 06:13:03] warn: [auth] Invalid or expired token for GET /api/test from 127.0.0.1
[2025-12-12 06:13:03] info: [cronJobService] Manually triggering token cleanup...
[2025-12-12 06:13:03] info: [cronJobService] Starting expired token cleanup...
[2025-12-12 06:13:03] warn: [auth] Access token is required for GET /api/test from 127.0.0.1
[2025-12-12 06:13:03] warn: [auth] Access token is required for GET /api/test from 127.0.0.1
[2025-12-12 06:13:03] info: [TokenRotation] Token cleanup completed
[2025-12-12 06:13:03] info: [cronJobService] Token cleanup completed. Removed 0 expired/invalidated tokens
[2025-12-12 06:13:03] info: [cronJobService] Manual token cleanup completed: {"removed":0,"expired":0,"invalidated":0,"timestamp":"2025-12-12T11:13:03.983Z"}
[2025-12-12 06:13:03] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:03] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:04] info: [cronJobService] Manually triggering token cleanup...
[2025-12-12 06:13:04] info: [cronJobService] Starting expired token cleanup...
[2025-12-12 06:13:04] info: [TokenRotation] Token cleanup completed
[2025-12-12 06:13:04] info: [cronJobService] Token cleanup completed. Removed 0 expired/invalidated tokens
[2025-12-12 06:13:04] info: [cronJobService] Manual token cleanup completed: {"removed":0,"expired":0,"invalidated":0,"timestamp":"2025-12-12T11:13:04.005Z"}
[2025-12-12 06:13:04] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:04] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:04] warn: [auth] Access token is required for GET /api/test from 127.0.0.1
[2025-12-12 06:13:04] warn: [auth] Access token is required for GET /api/test from 127.0.0.1
[2025-12-12 06:13:04] warn: [auth] Access token is required for GET /api/test from 127.0.0.1
[2025-12-12 06:13:04] warn: [auth] Access token is required for GET /api/test from 127.0.0.1
[2025-12-12 06:13:04] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:04] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:04] warn: [auth] Access token is required for GET /api/test from 127.0.0.1
[2025-12-12 06:13:04] info: [auth] Authenticated user 12345 for GET /api/test
[2025-12-12 06:13:04] info: [cronJobService] Manually triggering token cleanup...
[2025-12-12 06:13:04] info: [cronJobService] Starting expired token cleanup...
[2025-12-12 06:13:04] info: [auth] Authenticated user 99999 for GET /api/test
[2025-12-12 06:13:04] error: [TokenRotation] Error cleaning up tokens: Database connection failed
[2025-12-12 06:13:04] error: [cronJobService] Token cleanup error: Database connection failed
[2025-12-12 06:13:04] info: [cronJobService] Manual token cleanup completed: {"removed":0,"timestamp":"2025-12-12T11:13:04.047Z","error":"Database connection failed"}
[2025-12-12 06:13:04] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:04] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:04] info: [auth] Authenticated user 6817 for GET /api/test
[2025-12-12 06:13:04] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:04] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:04] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:04] info: [cronJobService] Stopped job: weeklySalaries
[2025-12-12 06:13:04] info: [cronJobService] Stopped job: tokenCleanup
[2025-12-12 06:13:04] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:04] info: [auth] Authenticated user 6829 for GET /api/test
[2025-12-12 06:13:04] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:04] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:04] warn: [auth] Invalid or expired token for GET /api/test from 127.0.0.1
[2025-12-12 06:13:04] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:04] info: [cronJobService] Stopped job: weeklySalaries
[2025-12-12 06:13:04] info: [cronJobService] Stopped job: tokenCleanup
[2025-12-12 06:13:04] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:04] info: [cronJobService] Manually triggering token cleanup...
[2025-12-12 06:13:04] info: [cronJobService] Starting expired token cleanup...
[2025-12-12 06:13:04] info: [TokenRotation] Token cleanup completed
[2025-12-12 06:13:04] info: [cronJobService] Token cleanup completed. Removed 0 expired/invalidated tokens
[2025-12-12 06:13:04] info: [auth] Authenticated user undefined for GET /api/test
[2025-12-12 06:13:04] info: [cronJobService] Manual token cleanup completed: {"removed":0,"expired":0,"invalidated":0,"timestamp":"2025-12-12T11:13:04.069Z"}
[2025-12-12 06:13:04] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:04] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:04] warn: [auth] Invalid or expired token for GET /api/test from 127.0.0.1
[2025-12-12 06:13:04] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:04] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:04] info: [cronJobService] Manually triggering token cleanup...
[2025-12-12 06:13:04] info: [cronJobService] Starting expired token cleanup...
[2025-12-12 06:13:04] info: [TokenRotation] Token cleanup completed
[2025-12-12 06:13:04] info: [cronJobService] Token cleanup completed. Removed 1 expired/invalidated tokens
[2025-12-12 06:13:04] info: [cronJobService] Manual token cleanup completed: {"removed":1,"expired":1,"invalidated":0,"timestamp":"2025-12-12T11:13:04.119Z"}
[2025-12-12 06:13:04] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:04] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:04] info: [cronJobService] Manually triggering token cleanup...
[2025-12-12 06:13:04] info: [cronJobService] Starting expired token cleanup...
[2025-12-12 06:13:04] info: [TokenRotation] Token cleanup completed
[2025-12-12 06:13:04] info: [cronJobService] Token cleanup completed. Removed 0 expired/invalidated tokens
[2025-12-12 06:13:04] info: [cronJobService] Manual token cleanup completed: {"removed":0,"expired":0,"invalidated":0,"timestamp":"2025-12-12T11:13:04.152Z"}
[2025-12-12 06:13:04] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:04] info: [cronJobService] All cron jobs stopped
[2025-12-12 06:13:04] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:04] info: [cronJobService] Stopping all cron jobs...
[2025-12-12 06:13:04] info: [cronJobService] All cron jobs stopped
FAIL __tests__/unit/security/token-validation.test.mjs
  Token Validation Unit Tests
    Valid Token Scenarios
      ‚àö should authenticate with valid token in cookie (29 ms)
      ‚àö should authenticate with valid token in Authorization header (24 ms)
      ‚àö should prefer cookie token over Authorization header (20 ms)
      ‚àö should accept token with additional custom payload (25 ms)
    Expired Token Scenarios
      ‚àö should reject expired token (11 ms)
      ‚àö should reject token older than 7 days (CWE-613) (30 ms)
      ‚àö should accept token exactly 7 days old (26 ms)
      ‚àö should reject token slightly over 7 days old (14 ms)
    Malformed Token Scenarios
      ‚àö should reject malformed token (8 ms)
      ‚àö should reject token with invalid signature (12 ms)
      ‚àö should reject completely invalid token string (3 ms)
      ‚àö should reject empty token string (6 ms)
      √ó should reject null token (21 ms)
      ‚àö should reject undefined token (3 ms)
    Missing Token Scenarios
      ‚àö should return 401 when no token in cookie or header (2 ms)
      ‚àö should return 401 when Authorization header has no Bearer token (4 ms)
      ‚àö should return 401 when Authorization header has wrong scheme (3 ms)
      ‚àö should return 401 when Authorization header has no space (4 ms)
    Token Payload Validation
      ‚àö should extract userId from token payload (15 ms)
      ‚àö should handle legacy id field mapping (6 ms)
      ‚àö should include iat (issued at) timestamp in user object (6 ms)
      ‚àö should include exp (expiration) timestamp in user object (7 ms)
    Security Edge Cases
      ‚àö should reject token with modified payload (5 ms)
      ‚àö should reject token without userId field (7 ms)
      ‚àö should reject token signed with algorithm none (10 ms)

  ‚óè Token Validation Unit Tests ‚Ä∫ Malformed Token Scenarios ‚Ä∫ should reject null token

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Invalid or expired token",
    -   "status": Anything,
    +   "message": "Access token is required",
    +   "status": "error",
        "success": false,
      },

    Number of calls: 1

    [0m [90m 114 |[39m         expect(next)[33m.[39mnot[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m 115 |[39m         expect(res[33m.[39mstatus)[33m.[39mtoHaveBeenCalledWith([35m401[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 116 |[39m         expect(res[33m.[39mjson)[33m.[39mtoHaveBeenCalledWith({
     [90m     |[39m                          [31m[1m^[22m[39m
     [90m 117 |[39m           success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 118 |[39m           message[33m:[39m [32m'Invalid or expired token'[39m[33m,[39m
     [90m 119 |[39m           status[33m:[39m expect[33m.[39manything()[33m,[39m[0m

      at Timeout._onTimeout (__tests__/unit/security/token-validation.test.mjs:116:26)

[2025-12-12 06:13:04] info: [TokenRotation] Created new token pair
FAIL __tests__/services/cronJobService.test.mjs
  Cron Job Service
    initializeCronJobs()
      ‚àö should initialize weekly salary job (23 ms)
      ‚àö should initialize token cleanup job (6 ms)
      ‚àö should start all jobs after initialization (3 ms)
      ‚àö should initialize exactly 2 cron jobs (16 ms)
      ‚àö should use UTC timezone for all jobs (14 ms)
    stopCronJobs()
      ‚àö should stop all running jobs (20 ms)
      ‚àö should handle stopping when no jobs initialized (16 ms)
      ‚àö should clear all job references (18 ms)
    getCronJobStatus()
      ‚àö should return status for all initialized jobs (15 ms)
      ‚àö should return empty status when no jobs initialized (13 ms)
      ‚àö should include running and scheduled flags (20 ms)
    triggerTokenCleanup() - Manual Execution
      √ó should remove expired tokens (50 ms)
      √ó should NOT remove valid tokens (31 ms)
      √ó should remove multiple expired tokens (45 ms)
      √ó should remove expired tokens for all users (48 ms)
      √ó should remove only expired tokens from mixed set (28 ms)
      ‚àö should return timestamp of cleanup (13 ms)
      ‚àö should handle cleanup when no expired tokens exist (21 ms)
      √ó should handle tokens expiring at exact current time (15 ms)
      ‚àö should include error message on failure (28 ms)
    Token Cleanup Scheduling
      ‚àö should schedule daily cleanup at 3 AM UTC (5 ms)
      √ó should execute token cleanup callback when triggered (10 ms)
    Edge Cases
      ‚àö should handle tokens with null expiresAt (should not crash) (5 ms)
      √ó should handle concurrent cleanup executions (32 ms)
      ‚àö should handle very old expired tokens (19 ms)
      ‚àö should handle tokens expiring in the future (31 ms)
    Performance
      √ó should efficiently remove large number of expired tokens (74 ms)

  ‚óè Cron Job Service ‚Ä∫ triggerTokenCleanup() - Manual Execution ‚Ä∫ should remove expired tokens

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

    [0m [90m 167 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m triggerTokenCleanup()[33m;[39m
     [90m 168 |[39m
    [31m[1m>[22m[39m[90m 169 |[39m       expect(result[33m.[39mremoved)[33m.[39mtoBe([35m1[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 170 |[39m
     [90m 171 |[39m       [90m// Verify token was deleted[39m
     [90m 172 |[39m       [36mconst[39m deletedToken [33m=[39m [36mawait[39m prisma[33m.[39mrefreshToken[33m.[39mfindUnique({[0m

      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:169:30)

  ‚óè Cron Job Service ‚Ä∫ triggerTokenCleanup() - Manual Execution ‚Ä∫ should NOT remove valid tokens

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 178 |[39m     it([32m'should NOT remove valid tokens'[39m[33m,[39m [36masync[39m () [33m=>[39m {
     [90m 179 |[39m       [90m// Create valid token (expires in 7 days)[39m
    [31m[1m>[22m[39m[90m 180 |[39m       [36mconst[39m validToken [33m=[39m [36mawait[39m createTestRefreshToken(user[33m.[39mid[33m,[39m {
     [90m     |[39m                          [31m[1m^[22m[39m
     [90m 181 |[39m         expiresAt[33m:[39m [36mnew[39m [33mDate[39m([33mDate[39m[33m.[39mnow() [33m+[39m [35m7[39m [33m*[39m [35m24[39m [33m*[39m [35m60[39m [33m*[39m [35m60[39m [33m*[39m [35m1000[39m)[33m,[39m
     [90m 182 |[39m       })[33m;[39m
     [90m 183 |[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:180:26)

  ‚óè Cron Job Service ‚Ä∫ triggerTokenCleanup() - Manual Execution ‚Ä∫ should remove multiple expired tokens

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 196 |[39m       [90m// Create 5 expired tokens[39m
     [90m 197 |[39m       [36mfor[39m ([36mlet[39m i [33m=[39m [35m0[39m[33m;[39m i [33m<[39m [35m5[39m[33m;[39m i[33m++[39m) {
    [31m[1m>[22m[39m[90m 198 |[39m         [36mawait[39m createTestRefreshToken(user[33m.[39mid[33m,[39m {
     [90m     |[39m         [31m[1m^[22m[39m
     [90m 199 |[39m           expiresAt[33m:[39m [36mnew[39m [33mDate[39m([33mDate[39m[33m.[39mnow() [33m-[39m [35m24[39m [33m*[39m [35m60[39m [33m*[39m [35m60[39m [33m*[39m [35m1000[39m)[33m,[39m
     [90m 200 |[39m         })[33m;[39m
     [90m 201 |[39m       }[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:198:9)

  ‚óè Cron Job Service ‚Ä∫ triggerTokenCleanup() - Manual Execution ‚Ä∫ should remove expired tokens for all users

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 210 |[39m
     [90m 211 |[39m       [90m// Create expired tokens for both users[39m
    [31m[1m>[22m[39m[90m 212 |[39m       [36mawait[39m createTestRefreshToken(user[33m.[39mid[33m,[39m {
     [90m     |[39m       [31m[1m^[22m[39m
     [90m 213 |[39m         expiresAt[33m:[39m [36mnew[39m [33mDate[39m([33mDate[39m[33m.[39mnow() [33m-[39m [35m24[39m [33m*[39m [35m60[39m [33m*[39m [35m60[39m [33m*[39m [35m1000[39m)[33m,[39m
     [90m 214 |[39m       })[33m;[39m
     [90m 215 |[39m       [36mawait[39m createTestRefreshToken(user2[33m.[39mid[33m,[39m {[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:212:7)

  ‚óè Cron Job Service ‚Ä∫ triggerTokenCleanup() - Manual Execution ‚Ä∫ should remove only expired tokens from mixed set

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 225 |[39m       [90m// 3 expired tokens[39m
     [90m 226 |[39m       [36mfor[39m ([36mlet[39m i [33m=[39m [35m0[39m[33m;[39m i [33m<[39m [35m3[39m[33m;[39m i[33m++[39m) {
    [31m[1m>[22m[39m[90m 227 |[39m         [36mawait[39m createTestRefreshToken(user[33m.[39mid[33m,[39m {
     [90m     |[39m         [31m[1m^[22m[39m
     [90m 228 |[39m           expiresAt[33m:[39m [36mnew[39m [33mDate[39m([33mDate[39m[33m.[39mnow() [33m-[39m [35m24[39m [33m*[39m [35m60[39m [33m*[39m [35m60[39m [33m*[39m [35m1000[39m)[33m,[39m
     [90m 229 |[39m         })[33m;[39m
     [90m 230 |[39m       }[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:227:9)

  ‚óè Cron Job Service ‚Ä∫ triggerTokenCleanup() - Manual Execution ‚Ä∫ should handle tokens expiring at exact current time

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 269 |[39m
     [90m 270 |[39m       [90m// Token expires exactly now[39m
    [31m[1m>[22m[39m[90m 271 |[39m       [36mawait[39m createTestRefreshToken(user[33m.[39mid[33m,[39m {
     [90m     |[39m       [31m[1m^[22m[39m
     [90m 272 |[39m         expiresAt[33m:[39m now[33m,[39m
     [90m 273 |[39m       })[33m;[39m
     [90m 274 |[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:271:7)

  ‚óè Cron Job Service ‚Ä∫ Token Cleanup Scheduling ‚Ä∫ should execute token cleanup callback when triggered

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 306 |[39m
     [90m 307 |[39m       [36mconst[39m user [33m=[39m [36mawait[39m createTestUser()[33m;[39m
    [31m[1m>[22m[39m[90m 308 |[39m       [36mawait[39m createTestRefreshToken(user[33m.[39mid[33m,[39m {
     [90m     |[39m       [31m[1m^[22m[39m
     [90m 309 |[39m         expiresAt[33m:[39m [36mnew[39m [33mDate[39m([33mDate[39m[33m.[39mnow() [33m-[39m [35m24[39m [33m*[39m [35m60[39m [33m*[39m [35m60[39m [33m*[39m [35m1000[39m)[33m,[39m
     [90m 310 |[39m       })[33m;[39m
     [90m 311 |[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:308:7)

  ‚óè Cron Job Service ‚Ä∫ Edge Cases ‚Ä∫ should handle concurrent cleanup executions

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 340 |[39m       [90m// Create 10 expired tokens[39m
     [90m 341 |[39m       [36mfor[39m ([36mlet[39m i [33m=[39m [35m0[39m[33m;[39m i [33m<[39m [35m10[39m[33m;[39m i[33m++[39m) {
    [31m[1m>[22m[39m[90m 342 |[39m         [36mawait[39m createTestRefreshToken(user[33m.[39mid[33m,[39m {
     [90m     |[39m         [31m[1m^[22m[39m
     [90m 343 |[39m           expiresAt[33m:[39m [36mnew[39m [33mDate[39m([33mDate[39m[33m.[39mnow() [33m-[39m [35m24[39m [33m*[39m [35m60[39m [33m*[39m [35m60[39m [33m*[39m [35m1000[39m)[33m,[39m
     [90m 344 |[39m         })[33m;[39m
     [90m 345 |[39m       }[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:342:9)

  ‚óè Cron Job Service ‚Ä∫ Performance ‚Ä∫ should efficiently remove large number of expired tokens

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 399 |[39m         )[33m;[39m
     [90m 400 |[39m       }
    [31m[1m>[22m[39m[90m 401 |[39m       [36mawait[39m [33mPromise[39m[33m.[39mall(tokenPromises)[33m;[39m
     [90m     |[39m       [31m[1m^[22m[39m
     [90m 402 |[39m
     [90m 403 |[39m       [36mconst[39m startTime [33m=[39m [33mDate[39m[33m.[39mnow()[33m;[39m
     [90m 404 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m triggerTokenCleanup()[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
          at async Promise.all (index 28)
      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:401:7)

[2025-12-12 06:13:04] info: [TokenRotation] Created new token pair
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:04] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:04] info: [TokenRotation] Created new token pair
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:05] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:05] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:05] warn: [TokenRotation] Token reuse detected
[2025-12-12 06:13:05] info: [EmailVerification] Created verification token
[2025-12-12 06:13:05] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:05] info: [EmailVerification] Created verification token
[2025-12-12 06:13:06] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:06] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:06] warn: [TokenRotation] Token reuse detected
[2025-12-12 06:13:06] info: [EmailVerification] Created verification token
[2025-12-12 06:13:06] info: [EmailVerification] Created verification token
[2025-12-12 06:13:06] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:06] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:06] info: [rateLimiting] Using in-memory rate limiting for test/disabled Redis environment
[2025-12-12 06:13:06] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:06] error: [EmailVerification] Error creating verification token: Maximum pending verification tokens (5) reached
[2025-12-12 06:13:06] info: [SwaggerSetup] OpenAPI specification loaded successfully
[2025-12-12 06:13:06] info: [SwaggerSetup] API documentation setup completed
[2025-12-12 06:13:06] info: [SwaggerSetup] Interactive docs available at: /api-docs
[2025-12-12 06:13:06] info: [SwaggerSetup] OpenAPI JSON available at: /api-docs/swagger.json
[2025-12-12 06:13:06] info: [SwaggerSetup] OpenAPI YAML available at: /api-docs/swagger.yaml
[2025-12-12 06:13:06] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:06] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:06] info: [MemoryManager] Starting memory and resource monitoring
(node:24608) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
[2025-12-12 06:13:06] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:06] info: [rateLimiting] Using in-memory rate limiting for test/disabled Redis environment
[2025-12-12 06:13:06] info: [rateLimiting] Using in-memory rate limiting for test/disabled Redis environment
[2025-12-12 06:13:06] info: [EmailVerification] Created verification token
[2025-12-12 06:13:06] warn: [TokenRotation] Token reuse detected
[2025-12-12 06:13:06] info: [rateLimiting] Using in-memory rate limiting for test/disabled Redis environment
[2025-12-12 06:13:06] error: [EmailVerification] Error creating verification token: Please wait 300 seconds before requesting another verification email
[2025-12-12 06:13:06] info: [rateLimiting] Using in-memory rate limiting for test/disabled Redis environment
[2025-12-12 06:13:06] warn: [TokenRotation] Token family invalidated
[2025-12-12 06:13:06] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:06] info: [rateLimiting] Using in-memory rate limiting for test/disabled Redis environment
[2025-12-12 06:13:06] info: [rateLimiting] Using in-memory rate limiting for test/disabled Redis environment
[2025-12-12 06:13:06] info: [SwaggerSetup] OpenAPI specification loaded successfully
[2025-12-12 06:13:06] info: [SwaggerSetup] API documentation setup completed
[2025-12-12 06:13:06] info: [SwaggerSetup] Interactive docs available at: /api-docs
[2025-12-12 06:13:06] info: [SwaggerSetup] OpenAPI JSON available at: /api-docs/swagger.json
[2025-12-12 06:13:06] info: [SwaggerSetup] OpenAPI YAML available at: /api-docs/swagger.yaml
[2025-12-12 06:13:06] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:06] info: [SwaggerSetup] OpenAPI specification loaded successfully
[2025-12-12 06:13:06] info: [SwaggerSetup] API documentation setup completed
[2025-12-12 06:13:06] info: [SwaggerSetup] Interactive docs available at: /api-docs
[2025-12-12 06:13:06] info: [SwaggerSetup] OpenAPI JSON available at: /api-docs/swagger.json
[2025-12-12 06:13:06] info: [SwaggerSetup] OpenAPI YAML available at: /api-docs/swagger.yaml
[2025-12-12 06:13:06] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:06] info: [SwaggerSetup] OpenAPI specification loaded successfully
[2025-12-12 06:13:06] info: [SwaggerSetup] API documentation setup completed
[2025-12-12 06:13:06] info: [SwaggerSetup] Interactive docs available at: /api-docs
[2025-12-12 06:13:06] info: [SwaggerSetup] OpenAPI JSON available at: /api-docs/swagger.json
[2025-12-12 06:13:06] info: [SwaggerSetup] OpenAPI YAML available at: /api-docs/swagger.yaml
[2025-12-12 06:13:06] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:06] info: [SwaggerSetup] OpenAPI specification loaded successfully
[2025-12-12 06:13:06] info: [SwaggerSetup] API documentation setup completed
[2025-12-12 06:13:06] info: [SwaggerSetup] Interactive docs available at: /api-docs
[2025-12-12 06:13:06] info: [SwaggerSetup] OpenAPI JSON available at: /api-docs/swagger.json
[2025-12-12 06:13:06] info: [SwaggerSetup] OpenAPI YAML available at: /api-docs/swagger.yaml
[2025-12-12 06:13:06] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:07] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:07] info: [MemoryManager] Starting memory and resource monitoring
[2025-12-12 06:13:07] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:07] info: [MemoryManager] Starting memory and resource monitoring
[2025-12-12 06:13:07] info: [SwaggerSetup] OpenAPI specification loaded successfully
[2025-12-12 06:13:07] info: [SwaggerSetup] API documentation setup completed
[2025-12-12 06:13:07] info: [SwaggerSetup] Interactive docs available at: /api-docs
[2025-12-12 06:13:07] info: [SwaggerSetup] OpenAPI JSON available at: /api-docs/swagger.json
[2025-12-12 06:13:07] info: [SwaggerSetup] OpenAPI YAML available at: /api-docs/swagger.yaml
[2025-12-12 06:13:07] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:07] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:07] info: [MemoryManager] Starting memory and resource monitoring
[2025-12-12 06:13:07] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:07] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:07] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:07] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:07] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:07] info: [SwaggerSetup] OpenAPI specification loaded successfully
[2025-12-12 06:13:07] info: [SwaggerSetup] API documentation setup completed
[2025-12-12 06:13:07] info: [SwaggerSetup] Interactive docs available at: /api-docs
[2025-12-12 06:13:07] info: [SwaggerSetup] OpenAPI JSON available at: /api-docs/swagger.json
[2025-12-12 06:13:07] info: [SwaggerSetup] OpenAPI YAML available at: /api-docs/swagger.yaml
(node:21512) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
[2025-12-12 06:13:07] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:07] info: [cronJobService] All cron jobs initialized and started
(node:7008) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
[2025-12-12 06:13:07] info: [MemoryManager] Starting memory and resource monitoring
(node:7404) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
[2025-12-12 06:13:07] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:07] info: [MemoryManager] Starting memory and resource monitoring
(node:23936) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:19124) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
[2025-12-12 06:13:07] info: [POST] /api/horses/foals
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for POST /horses/foals
[2025-12-12 06:13:07] info: [POST] /api/horses/foals - 403
[2025-12-12 06:13:07] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:07] info: [MemoryManager] Starting memory and resource monitoring
[2025-12-12 06:13:07] info: [GET] /api/horses/64116/environmental-analysis
(node:1872) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /horses/64116/environmental-analysis
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /horses/64116/environmental-analysis
[2025-12-12 06:13:07] warn: [ownership] horse 64116 not found or not owned by user 9525c9b8-c6ea-4721-be48-9ceadfb84276
[2025-12-12 06:13:07] info: [GET] /api/horses/64116/environmental-analysis - 404
[2025-12-12 06:13:07] info: [rateLimiting] Using in-memory rate limiting for test/disabled Redis environment
[2025-12-12 06:13:07] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:07] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:07] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:07] info: [GET] /api/horses/64116
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /horses/64116
[2025-12-12 06:13:07] warn: [ownership] horse 64116 not found or not owned by user 9525c9b8-c6ea-4721-be48-9ceadfb84276
[2025-12-12 06:13:07] info: [GET] /api/horses/64116 - 404
[2025-12-12 06:13:07] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:07] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:07] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:07] info: [GET] /api/leaderboards/competition?discipline=Racing&timeframe=all
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /leaderboards/competition
[2025-12-12 06:13:07] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /competition
[2025-12-12 06:13:07] info: [leaderboardRoutes.GET /competition] Getting competition leaderboard: discipline=Racing, period=all, metric=wins
[2025-12-12 06:13:07] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:07] info: [POST] /auth/register
[2025-12-12 06:13:07] warn: [TokenRotation] Token family invalidated
[2025-12-12 06:13:07] info: [leaderboardRoutes.GET /competition] Retrieved 0 leaderboard entries
[2025-12-12 06:13:07] info: [GET] /api/leaderboards/competition?discipline=Racing&timeframe=all - 200
[2025-12-12 06:13:07] info: [SwaggerSetup] OpenAPI specification loaded successfully
[2025-12-12 06:13:07] info: [SwaggerSetup] API documentation setup completed
[2025-12-12 06:13:07] info: [SwaggerSetup] Interactive docs available at: /api-docs
[2025-12-12 06:13:07] info: [SwaggerSetup] OpenAPI JSON available at: /api-docs/swagger.json
[2025-12-12 06:13:07] info: [SwaggerSetup] OpenAPI YAML available at: /api-docs/swagger.yaml
[2025-12-12 06:13:07] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:07] info: [GET] /api/horses?id=1&id=2&id=3
[2025-12-12 06:13:07] info: [GET] /api/grooms/user/9525c9b8-c6ea-4721-be48-9ceadfb84276
[2025-12-12 06:13:07] info: [auth] Authenticated user 0c0d9132-1ba8-4e4c-b451-6c99ac1fa008 for GET /horses
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /grooms/user/9525c9b8-c6ea-4721-be48-9ceadfb84276
[2025-12-12 06:13:07] info: [GET] /api/horses?id=1&id=2&id=3 - 400
[2025-12-12 06:13:07] info: [groomController.getUserGrooms] Getting grooms for user 9525c9b8-c6ea-4721-be48-9ceadfb84276
[2025-12-12 06:13:07] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:07] info: [GET] /api/grooms/user/9525c9b8-c6ea-4721-be48-9ceadfb84276 - 200
[2025-12-12 06:13:07] info: [POST] /api/grooms/interact
[2025-12-12 06:13:07] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:07] info: [MemoryManager] Starting memory and resource monitoring
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for POST /grooms/interact
[2025-12-12 06:13:07] info: [POST] /api/grooms/interact - 403
[2025-12-12 06:13:07] info: [GET] /api/horses/64120?sort=name&sort=age
[2025-12-12 06:13:07] info: [auth] Authenticated user f9d9767c-5d10-4e09-ac03-5bf93104a730 for GET /horses/64120
[2025-12-12 06:13:07] info: [POST] /api/grooms/assign
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for POST /grooms/assign
[2025-12-12 06:13:07] info: [POST] /api/grooms/assign - 403
[2025-12-12 06:13:07] warn: [ownership] horse 64120 not found or not owned by user f9d9767c-5d10-4e09-ac03-5bf93104a730
[2025-12-12 06:13:07] info: [GET] /api/horses/64120?sort=name&sort=age - 404
[2025-12-12 06:13:07] info: [GET] /api/memory/status
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /memory/status
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /status
[2025-12-12 06:13:07] info: [MemoryManagement] Getting memory status
[2025-12-12 06:13:07] info: [GET] /api/memory/status - 200
[2025-12-12 06:13:07] info: [POST] /api/auth/login
[2025-12-12 06:13:07] warn: [TokenRotation] Token family invalidated
[2025-12-12 06:13:07] info: [GET] /api/horses
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /horses
[2025-12-12 06:13:07] info: [GET] /api/horses
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /horses
[2025-12-12 06:13:07] info: [GET] /api/horses
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /horses
[2025-12-12 06:13:07] info: [GET] /api/horses
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /horses
[2025-12-12 06:13:07] info: [GET] /api/horses
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /horses
[2025-12-12 06:13:07] info: [GET] /api/horses
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /horses
[2025-12-12 06:13:07] info: [GET] /api/horses
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /horses
[2025-12-12 06:13:07] info: [GET] /api/horses
[2025-12-12 06:13:07] info: [PUT] /api/horses/64121
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /horses
[2025-12-12 06:13:07] info: [GET] /api/horses
[2025-12-12 06:13:07] info: [auth] Authenticated user 0e0dfbd3-3fba-4dff-a6e0-fcc2920fda47 for PUT /horses/64121
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /horses
[2025-12-12 06:13:07] info: [GET] /api/horses
FAIL __tests__/integration/systemWideIntegration.test.mjs (6.091 s)
  ‚óè System-Wide Integration Tests ‚Ä∫ Complete User Journey: Registration to Competition ‚Ä∫ End-to-end user workflow: registration ‚Üí horse purchase ‚Üí training ‚Üí competition

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 64 |[39m
     [90m 65 |[39m     [90m// Create test horse for global tests[39m
    [31m[1m>[22m[39m[90m 66 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 67 |[39m       data[33m:[39m {
     [90m 68 |[39m         name[33m:[39m [32m'Global Test Horse'[39m[33m,[39m
     [90m 69 |[39m         age[33m:[39m [35m5[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/systemWideIntegration.test.mjs:66:17)

  ‚óè System-Wide Integration Tests ‚Ä∫ System Integration Validation ‚Ä∫ Documentation system integration

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 64 |[39m
     [90m 65 |[39m     [90m// Create test horse for global tests[39m
    [31m[1m>[22m[39m[90m 66 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 67 |[39m       data[33m:[39m {
     [90m 68 |[39m         name[33m:[39m [32m'Global Test Horse'[39m[33m,[39m
     [90m 69 |[39m         age[33m:[39m [35m5[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/systemWideIntegration.test.mjs:66:17)

  ‚óè System-Wide Integration Tests ‚Ä∫ System Integration Validation ‚Ä∫ Groom career progression and talent system integration

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 64 |[39m
     [90m 65 |[39m     [90m// Create test horse for global tests[39m
    [31m[1m>[22m[39m[90m 66 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 67 |[39m       data[33m:[39m {
     [90m 68 |[39m         name[33m:[39m [32m'Global Test Horse'[39m[33m,[39m
     [90m 69 |[39m         age[33m:[39m [35m5[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/systemWideIntegration.test.mjs:66:17)

  ‚óè System-Wide Integration Tests ‚Ä∫ System Integration Validation ‚Ä∫ Documentation system integration with API endpoints

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 64 |[39m
     [90m 65 |[39m     [90m// Create test horse for global tests[39m
    [31m[1m>[22m[39m[90m 66 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 67 |[39m       data[33m:[39m {
     [90m 68 |[39m         name[33m:[39m [32m'Global Test Horse'[39m[33m,[39m
     [90m 69 |[39m         age[33m:[39m [35m5[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/systemWideIntegration.test.mjs:66:17)

  ‚óè System-Wide Integration Tests ‚Ä∫ Performance and Load Testing ‚Ä∫ API response times under load

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 64 |[39m
     [90m 65 |[39m     [90m// Create test horse for global tests[39m
    [31m[1m>[22m[39m[90m 66 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 67 |[39m       data[33m:[39m {
     [90m 68 |[39m         name[33m:[39m [32m'Global Test Horse'[39m[33m,[39m
     [90m 69 |[39m         age[33m:[39m [35m5[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/systemWideIntegration.test.mjs:66:17)

  ‚óè System-Wide Integration Tests ‚Ä∫ Performance and Load Testing ‚Ä∫ Memory usage monitoring during operations

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 64 |[39m
     [90m 65 |[39m     [90m// Create test horse for global tests[39m
    [31m[1m>[22m[39m[90m 66 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 67 |[39m       data[33m:[39m {
     [90m 68 |[39m         name[33m:[39m [32m'Global Test Horse'[39m[33m,[39m
     [90m 69 |[39m         age[33m:[39m [35m5[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/systemWideIntegration.test.mjs:66:17)

  ‚óè System-Wide Integration Tests ‚Ä∫ Data Consistency Validation ‚Ä∫ Database transaction integrity across systems

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 64 |[39m
     [90m 65 |[39m     [90m// Create test horse for global tests[39m
    [31m[1m>[22m[39m[90m 66 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 67 |[39m       data[33m:[39m {
     [90m 68 |[39m         name[33m:[39m [32m'Global Test Horse'[39m[33m,[39m
     [90m 69 |[39m         age[33m:[39m [35m5[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/systemWideIntegration.test.mjs:66:17)

  ‚óè System-Wide Integration Tests ‚Ä∫ Data Consistency Validation ‚Ä∫ User progress tracking accuracy

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 64 |[39m
     [90m 65 |[39m     [90m// Create test horse for global tests[39m
    [31m[1m>[22m[39m[90m 66 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 67 |[39m       data[33m:[39m {
     [90m 68 |[39m         name[33m:[39m [32m'Global Test Horse'[39m[33m,[39m
     [90m 69 |[39m         age[33m:[39m [35m5[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/systemWideIntegration.test.mjs:66:17)


  ‚óè Test suite failed to run

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 101 |[39m     }
     [90m 102 |[39m     [36mif[39m (testUser) {
    [31m[1m>[22m[39m[90m 103 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({ where[33m:[39m { id[33m:[39m testUser[33m.[39mid } })[33m;[39m
     [90m     |[39m       [31m[1m^[22m[39m
     [90m 104 |[39m     }
     [90m 105 |[39m     [36mif[39m (testBreed) {
     [90m 106 |[39m       [36mawait[39m prisma[33m.[39mbreed[33m.[39m[36mdelete[39m({ where[33m:[39m { id[33m:[39m testBreed[33m.[39mid } })[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/systemWideIntegration.test.mjs:103:7)

[2025-12-12 06:13:07] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:07] warn: [ownership] horse 64121 not found or not owned by user 0e0dfbd3-3fba-4dff-a6e0-fcc2920fda47
[2025-12-12 06:13:07] info: [PUT] /api/horses/64121 - 404
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /horses
[2025-12-12 06:13:07] info: [POST] /auth/register
[2025-12-12 06:13:07] info: [PUT] /api/horses/64122
[2025-12-12 06:13:07] info: [auth] Authenticated user 1aa3f30f-b984-4295-9ed0-a49482356853 for PUT /horses/64122
[2025-12-12 06:13:07] info: [ownership] Validated ownership: user 1aa3f30f-b984-4295-9ed0-a49482356853 owns horse 64122
[2025-12-12 06:13:07] info: [PUT] /api/horses/64122 - 400
[2025-12-12 06:13:07] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:07] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:07] info: [GET] /api/horses - 200
[2025-12-12 06:13:07] info: [GET] /api/horses - 200
[2025-12-12 06:13:07] info: [GET] /api/horses - 200
[2025-12-12 06:13:07] info: [GET] /api/horses - 200
[2025-12-12 06:13:07] info: [GET] /api/horses - 200
[2025-12-12 06:13:07] info: [GET] /api/horses - 200
[2025-12-12 06:13:07] info: [GET] /api/horses - 200
[2025-12-12 06:13:07] info: [GET] /api/horses - 200
[2025-12-12 06:13:07] info: [GET] /api/horses - 200
[2025-12-12 06:13:07] info: [PUT] /api/horses/64123
[2025-12-12 06:13:07] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:07] info: [auth] Authenticated user 6903b0ee-6ea0-45fe-a896-db04dfed1a16 for PUT /horses/64123
[2025-12-12 06:13:07] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:07] info: [GET] /api/horses - 200
[2025-12-12 06:13:07] warn: [ownership] horse 64123 not found or not owned by user 6903b0ee-6ea0-45fe-a896-db04dfed1a16
[2025-12-12 06:13:07] info: [PUT] /api/horses/64123 - 404
[2025-12-12 06:13:07] info: [GET] /api/memory/status
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /memory/status
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /status
[2025-12-12 06:13:07] info: [MemoryManagement] Getting memory status
[2025-12-12 06:13:07] info: [GET] /api/memory/status - 200
[2025-12-12 06:13:07] info: [POST] /api/memory/gc
[2025-12-12 06:13:07] info: [PUT] /api/horses/64124
[2025-12-12 06:13:07] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for POST /memory/gc
[2025-12-12 06:13:07] info: [auth] Authenticated user b1e9089b-2607-4748-b994-3616d438d59b for PUT /horses/64124
[2025-12-12 06:13:07] info: [POST] /api/memory/gc - 403
[2025-12-12 06:13:07] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:07] info: [ownership] Validated ownership: user b1e9089b-2607-4748-b994-3616d438d59b owns horse 64124
[2025-12-12 06:13:07] info: [PUT] /api/horses/64124 - 400
[2025-12-12 06:13:07] info: [GET] /api/horses
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /horses
[2025-12-12 06:13:07] info: [GET] /api/horses - 200
[2025-12-12 06:13:07] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:07] info: [GET] /api/horses?page=1&limit=5
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /horses
[2025-12-12 06:13:07] info: [GET] /api/horses?page=1&limit=5 - 200
[2025-12-12 06:13:07] info: [POST] /api/auth/login
[2025-12-12 06:13:07] info: [PUT] /api/horses/64125
[2025-12-12 06:13:07] info: [GET] /api-docs/swagger.json
[2025-12-12 06:13:07] info: [auth] Authenticated user 90a702b7-f8c6-4c53-a818-1ec99f57b38c for PUT /horses/64125
[2025-12-12 06:13:07] info: [GET] /api-docs/swagger.json - 200
[2025-12-12 06:13:07] info: [GET] /api/docs/health
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /docs/health
[2025-12-12 06:13:07] warn: 404 - Route not found: GET /api/docs/health from ::ffff:127.0.0.1
[2025-12-12 06:13:07] info: [GET] /api/docs/health - 404
[2025-12-12 06:13:07] warn: [ownership] horse 64125 not found or not owned by user 90a702b7-f8c6-4c53-a818-1ec99f57b38c
[2025-12-12 06:13:07] info: [PUT] /api/horses/64125 - 404
[2025-12-12 06:13:07] info: [GET] /api/user-docs/search?q=competition
[2025-12-12 06:13:07] warn: [auth] Access token is required for GET /user-docs/search from ::ffff:127.0.0.1
[2025-12-12 06:13:07] info: [GET] /api/user-docs/search?q=competition - 401
[2025-12-12 06:13:07] info: [GET] /health
[2025-12-12 06:13:07] info: [GET] /health - 200
[2025-12-12 06:13:07] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:07] info: [GET] /ping
[2025-12-12 06:13:07] info: [GET] /ping - 200
[2025-12-12 06:13:07] warn: [TokenRotation] Token family invalidated
[2025-12-12 06:13:07] info: [PUT] /api/horses/64126
[2025-12-12 06:13:07] info: [auth] Authenticated user 7f4f37fb-f242-4b28-a231-f0f114d5cb2e for PUT /horses/64126
[2025-12-12 06:13:07] info: [GET] /api/memory/health
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /memory/health
[2025-12-12 06:13:07] info: [auth] Authenticated user 9525c9b8-c6ea-4721-be48-9ceadfb84276 for GET /health
[2025-12-12 06:13:07] info: [ownership] Validated ownership: user 7f4f37fb-f242-4b28-a231-f0f114d5cb2e owns horse 64126
[2025-12-12 06:13:07] info: [MemoryManagement] Getting system health assessment
[2025-12-12 06:13:07] info: [PUT] /api/horses/64126 - 400
[2025-12-12 06:13:07] info: [GET] /api/memory/health - 200
[2025-12-12 06:13:07] info: [GET] /api/user-docs/health
[2025-12-12 06:13:07] warn: [auth] Access token is required for GET /user-docs/health from ::ffff:127.0.0.1
[2025-12-12 06:13:07] info: [GET] /api/user-docs/health - 401
[2025-12-12 06:13:07] info: [PUT] /api/horses/64127
[2025-12-12 06:13:07] info: [rateLimiting] Using in-memory rate limiting for test/disabled Redis environment
[2025-12-12 06:13:07] info: [auth] Authenticated user 23fa8c91-10ca-43fd-9d07-90a8ec8cc866 for PUT /horses/64127
[2025-12-12 06:13:07] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:07] info: [POST] /api/auth/refresh-token - 200
[2025-12-12 06:13:07] info: [ownership] Validated ownership: user 23fa8c91-10ca-43fd-9d07-90a8ec8cc866 owns horse 64127
[2025-12-12 06:13:07] info: [PUT] /api/horses/64127 - 400
[2025-12-12 06:13:07] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:07] info: [POST] /api/horses/batch-update
[2025-12-12 06:13:07] info: [auth] Authenticated user deff3ea4-1128-40c0-bc5f-6aa3af6c9476 for POST /horses/batch-update
[2025-12-12 06:13:07] info: [auth] Authenticated user deff3ea4-1128-40c0-bc5f-6aa3af6c9476 for POST /batch-update
[2025-12-12 06:13:07] info: [POST] /api/horses/batch-update - 400
[2025-12-12 06:13:07] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:07] info: [POST] /api/horses/batch-update
[2025-12-12 06:13:07] info: [auth] Authenticated user 1c68d45a-dae3-4911-a1b7-97797fb4fc3f for POST /horses/batch-update
[2025-12-12 06:13:07] info: [auth] Authenticated user 1c68d45a-dae3-4911-a1b7-97797fb4fc3f for POST /batch-update
[2025-12-12 06:13:07] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:07] info: [POST] /api/horses/batch-update - 400
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:07] info: [POST] /api/horses/batch-update
[2025-12-12 06:13:07] info: [auth] Authenticated user 018e42fe-899f-48c0-af5f-9daf9548b86e for POST /horses/batch-update
[2025-12-12 06:13:07] info: [auth] Authenticated user 018e42fe-899f-48c0-af5f-9daf9548b86e for POST /batch-update
[2025-12-12 06:13:07] info: [POST] /api/horses/batch-update - 400
[2025-12-12 06:13:07] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:07] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:07] info: [POST] /api/horses/batch-update
[2025-12-12 06:13:07] info: [auth] Authenticated user 5b55498b-4166-41b8-b31f-c3126291e317 for POST /horses/batch-update
[2025-12-12 06:13:07] info: [auth] Authenticated user 5b55498b-4166-41b8-b31f-c3126291e317 for POST /batch-update
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:07] info: [POST] /api/horses/batch-update - 400
[2025-12-12 06:13:07] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:07] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:07] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:07] error: [POST] /auth/register - ERROR
[2025-12-12 06:13:07] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:07] info: [POST] /auth/register - 500
[2025-12-12 06:13:07] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:07] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:07] info: [SwaggerSetup] OpenAPI specification loaded successfully
[2025-12-12 06:13:07] info: [SwaggerSetup] API documentation setup completed
[2025-12-12 06:13:07] info: [SwaggerSetup] Interactive docs available at: /api-docs
[2025-12-12 06:13:07] info: [SwaggerSetup] OpenAPI JSON available at: /api-docs/swagger.json
[2025-12-12 06:13:07] info: [SwaggerSetup] OpenAPI YAML available at: /api-docs/swagger.yaml
[2025-12-12 06:13:07] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:07] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:08] info: [TokenRotation] Token cleanup completed
[2025-12-12 06:13:08] info: [POST] /api/horses/batch-update
[2025-12-12 06:13:08] info: [auth] Authenticated user 9072ddf0-6639-4297-a912-818eafa89e31 for POST /horses/batch-update
[2025-12-12 06:13:08] info: [auth] Authenticated user 9072ddf0-6639-4297-a912-818eafa89e31 for POST /batch-update
[2025-12-12 06:13:08] info: [POST] /api/horses/batch-update - 400
[2025-12-12 06:13:08] info: [POST] /auth/register
[2025-12-12 06:13:08] info: [POST] /api/auth/login
[2025-12-12 06:13:08] info: [POST] /api/auth/login
[2025-12-12 06:13:08] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:08] info: [MemoryManager] Starting memory and resource monitoring
[2025-12-12 06:13:08] info: [GET] /api/horses?breed=Thoroughbred%27%20OR%20%271%27=%271
[2025-12-12 06:13:08] info: [auth] Authenticated user cb77cbdd-e5e2-421e-ba7f-2d609e282111 for GET /horses
[2025-12-12 06:13:08] info: [GET] /api/horses?breed=Thoroughbred%27%20OR%20%271%27=%271 - 400
FAIL __tests__/integration/crossSystemValidation.test.mjs (6.586 s)
  ‚óè Cross-System Validation Tests ‚Ä∫ Epigenetic Trait System Integration ‚Ä∫ Trait discovery integration with groom care patterns

    expected 201 "Created", got 403 "Forbidden"

    [0m [90m 127 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)
     [90m 128 |[39m         [33m.[39msend(foalData)
    [31m[1m>[22m[39m[90m 129 |[39m         [33m.[39mexpect([35m201[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 130 |[39m
     [90m 131 |[39m       [36mconst[39m { foal } [33m=[39m foalResponse[33m.[39mbody[33m.[39mdata[33m;[39m
     [90m 132 |[39m[0m

      at Object.<anonymous> (__tests__/integration/crossSystemValidation.test.mjs:129:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Cross-System Validation Tests ‚Ä∫ Epigenetic Trait System Integration ‚Ä∫ Environmental trigger system integration

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 200 |[39m         [33m.[39m[36mget[39m([32m`/api/horses/${testHorse.id}/environmental-analysis`[39m)
     [90m 201 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)
    [31m[1m>[22m[39m[90m 202 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 203 |[39m
     [90m 204 |[39m       expect(environmentalResponse[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 205 |[39m[0m

      at Object.<anonymous> (__tests__/integration/crossSystemValidation.test.mjs:202:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Cross-System Validation Tests ‚Ä∫ Competition System Integration ‚Ä∫ Training system integration with competition performance

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 221 |[39m         [33m.[39m[36mget[39m([32m`/api/horses/${testHorse.id}`[39m)
     [90m 222 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)
    [31m[1m>[22m[39m[90m 223 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 224 |[39m
     [90m 225 |[39m       [36mconst[39m initialStats [33m=[39m initialHorseResponse[33m.[39mbody[33m.[39mdata[33m;[39m
     [90m 226 |[39m[0m

      at Object.<anonymous> (__tests__/integration/crossSystemValidation.test.mjs:223:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Cross-System Validation Tests ‚Ä∫ Groom System Integration ‚Ä∫ Groom career progression with horse development

    expected 200 "OK", got 403 "Forbidden"

    [0m [90m 356 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)
     [90m 357 |[39m         [33m.[39msend(interactionData)
    [31m[1m>[22m[39m[90m 358 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 359 |[39m
     [90m 360 |[39m       expect(interactionResponse[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 361 |[39m[0m

      at Object.<anonymous> (__tests__/integration/crossSystemValidation.test.mjs:358:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Cross-System Validation Tests ‚Ä∫ Groom System Integration ‚Ä∫ Groom assignment integration with horse care

    expected 201 "Created", got 403 "Forbidden"

    [0m [90m 403 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)
     [90m 404 |[39m         [33m.[39msend(assignmentData)
    [31m[1m>[22m[39m[90m 405 |[39m         [33m.[39mexpect([35m201[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 406 |[39m
     [90m 407 |[39m       expect(assignmentResponse[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 408 |[39m[0m

      at Object.<anonymous> (__tests__/integration/crossSystemValidation.test.mjs:405:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Cross-System Validation Tests ‚Ä∫ Performance System Integration ‚Ä∫ Memory management integration with API operations

    expected 400 "Bad Request", got 403 "Forbidden"

    [0m [90m 463 |[39m         [33m.[39mpost([32m'/api/memory/gc'[39m)
     [90m 464 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)
    [31m[1m>[22m[39m[90m 465 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 466 |[39m
     [90m 467 |[39m       expect(gcResponse[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 468 |[39m       expect(gcResponse[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'Garbage collection not exposed'[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/crossSystemValidation.test.mjs:465:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Cross-System Validation Tests ‚Ä∫ Documentation System Integration ‚Ä∫ API documentation integration with live endpoints

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 514 |[39m         [33m.[39m[36mget[39m([32m'/api/docs/health'[39m)
     [90m 515 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)
    [31m[1m>[22m[39m[90m 516 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 517 |[39m
     [90m 518 |[39m       expect(docHealthResponse[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 519 |[39m       expect(docHealthResponse[33m.[39mbody[33m.[39mdata[33m.[39mstatus)[33m.[39mtoBe([32m'healthy'[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/crossSystemValidation.test.mjs:516:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Cross-System Validation Tests ‚Ä∫ Documentation System Integration ‚Ä∫ User documentation integration with search functionality

    expected 200 "OK", got 401 "Unauthorized"

    [0m [90m 524 |[39m       [36mconst[39m searchResponse [33m=[39m [36mawait[39m request(app)
     [90m 525 |[39m         [33m.[39m[36mget[39m([32m'/api/user-docs/search?q=competition'[39m)
    [31m[1m>[22m[39m[90m 526 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 527 |[39m
     [90m 528 |[39m       expect(searchResponse[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 529 |[39m       expect(searchResponse[33m.[39mbody[33m.[39mdata[33m.[39mresults[33m.[39mlength)[33m.[39mtoBeGreaterThan([35m0[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/crossSystemValidation.test.mjs:526:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Cross-System Validation Tests ‚Ä∫ System Health and Monitoring ‚Ä∫ Overall system health validation

    expected 200 "OK", got 401 "Unauthorized"

    [0m [90m 575 |[39m       [36mconst[39m docHealthResponse [33m=[39m [36mawait[39m request(app)
     [90m 576 |[39m         [33m.[39m[36mget[39m([32m'/api/user-docs/health'[39m)
    [31m[1m>[22m[39m[90m 577 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 578 |[39m
     [90m 579 |[39m       expect(docHealthResponse[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 580 |[39m       expect(docHealthResponse[33m.[39mbody[33m.[39mdata[33m.[39mstatus)[33m.[39mtoBe([32m'healthy'[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/crossSystemValidation.test.mjs:577:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)


  ‚óè Test suite failed to run

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 106 |[39m     [36mawait[39m prisma[33m.[39mhorse[33m.[39mdeleteMany({ where[33m:[39m { ownerId[33m:[39m testUser[33m.[39mid } })[33m;[39m
     [90m 107 |[39m     [36mawait[39m prisma[33m.[39mgroom[33m.[39mdeleteMany({ where[33m:[39m { userId[33m:[39m testUser[33m.[39mid } })[33m;[39m
    [31m[1m>[22m[39m[90m 108 |[39m     [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({ where[33m:[39m { id[33m:[39m testUser[33m.[39mid } })[33m;[39m
     [90m     |[39m     [31m[1m^[22m[39m
     [90m 109 |[39m     [36mawait[39m prisma[33m.[39mbreed[33m.[39m[36mdelete[39m({ where[33m:[39m { id[33m:[39m testBreed[33m.[39mid } })[33m;[39m
     [90m 110 |[39m   })[33m;[39m
     [90m 111 |[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/crossSystemValidation.test.mjs:108:5)

[2025-12-12 06:13:08] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:08] info: [TokenRotation] Token cleanup completed
[2025-12-12 06:13:08] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:08] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:08] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:08] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:08] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:08] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:08] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:08] error: [POST] /auth/register - ERROR
[2025-12-12 06:13:08] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:08] info: [POST] /auth/register - 500
[2025-12-12 06:13:08] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:08] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:08] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:08] info: [POST] /api/auth/logout
[2025-12-12 06:13:08] info: [GET] /api/horses?name=Horse%00Admin
[2025-12-12 06:13:08] info: [auth] Authenticated user e84eeff1-a266-48d6-b722-0d8a044c3936 for POST /logout
[2025-12-12 06:13:08] info: [auth] Authenticated user 2fea4e7d-7993-4c31-b128-d6d3b50e9473 for GET /horses
[2025-12-12 06:13:08] info: [GET] /api/horses?name=Horse%00Admin - 400
[2025-12-12 06:13:08] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:08] info: [POST] /api/auth/logout - 200
[2025-12-12 06:13:08] info: [POST] /auth/register
[2025-12-12 06:13:08] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:08] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:08] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:08] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:08] error: [PUT] /api/horses/64138 - ERROR
[2025-12-12 06:13:08] error: Error Unexpected token 'n', "name=HackedName" is not valid JSON
[2025-12-12 06:13:08] info: [POST] /api/auth/login
[2025-12-12 06:13:08] info: [PUT] /api/horses/64139
[2025-12-12 06:13:08] info: [auth] Authenticated user 5ed2df5c-a05c-413d-abb9-2a502ca0bba0 for PUT /horses/64139
[2025-12-12 06:13:08] warn: [ownership] horse 64139 not found or not owned by user 5ed2df5c-a05c-413d-abb9-2a502ca0bba0
[2025-12-12 06:13:08] info: [PUT] /api/horses/64139 - 404
[2025-12-12 06:13:08] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:08] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:08] info: [POST] /api/auth/refresh-token - 200
[2025-12-12 06:13:08] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:08] info: [POST] /auth/register
[2025-12-12 06:13:08] info: [PUT] /api/horses/64141
[2025-12-12 06:13:08] info: [auth] Authenticated user 02bc6bb3-288b-4d51-a082-62aa53ad0c20 for PUT /horses/64141
[2025-12-12 06:13:08] warn: [ownership] horse 64141 not found or not owned by user 02bc6bb3-288b-4d51-a082-62aa53ad0c20
[2025-12-12 06:13:08] info: [PUT] /api/horses/64141 - 404
[2025-12-12 06:13:08] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:08] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:08] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:08] info: [POST] /api/auth/login - 200
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:08] info: [PUT] /api/horses/64144
[2025-12-12 06:13:08] info: [auth] Authenticated user d02cd3cb-647b-4470-ad06-1dc6abd68c2d for PUT /horses/64144
[2025-12-12 06:13:08] warn: [ownership] horse 64144 not found or not owned by user d02cd3cb-647b-4470-ad06-1dc6abd68c2d
[2025-12-12 06:13:08] info: [PUT] /api/horses/64144 - 404
[2025-12-12 06:13:08] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:08] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:08] info: [POST] /api/auth/login
[2025-12-12 06:13:08] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:08] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:08] info: [POST] /api/auth/refresh-token - 200
[2025-12-12 06:13:08] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:08] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:08] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:08] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:08] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:08] info: [PUT] /api/horses/64147
[2025-12-12 06:13:08] error: [POST] /auth/register - ERROR
[2025-12-12 06:13:08] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:08] info: [POST] /auth/register - 500
[2025-12-12 06:13:08] info: [auth] Authenticated user ad45b246-782a-4156-8101-ed90bf97b903 for PUT /horses/64147
[2025-12-12 06:13:08] info: [ownership] Validated ownership: user ad45b246-782a-4156-8101-ed90bf97b903 owns horse 64147
[2025-12-12 06:13:08] info: [PUT] /api/horses/64147 - 400
[2025-12-12 06:13:08] info: [POST] /auth/register
[2025-12-12 06:13:08] info: [PUT] /api/horses/64148
[2025-12-12 06:13:08] info: [auth] Authenticated user 4510a611-ed3a-4b68-adbf-7606d70e647b for PUT /horses/64148
[2025-12-12 06:13:08] info: [ownership] Validated ownership: user 4510a611-ed3a-4b68-adbf-7606d70e647b owns horse 64148
[2025-12-12 06:13:08] info: [PUT] /api/horses/64148 - 400
[2025-12-12 06:13:08] info: [PUT] /api/horses/64149
[2025-12-12 06:13:08] info: [auth] Authenticated user 3ab48f77-295e-4a5d-ab83-023c738e191b for PUT /horses/64149
[2025-12-12 06:13:08] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:08] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:08] info: [ownership] Validated ownership: user 3ab48f77-295e-4a5d-ab83-023c738e191b owns horse 64149
[2025-12-12 06:13:08] info: [PUT] /api/horses/64149 - 400
PASS __tests__/utils/cookieConfig.test.mjs
  Cookie Configuration Module
    Access Token Cookie Options
      ‚àö should have correct security properties in development (23 ms)
      ‚àö should have correct security properties in production (8 ms)
      ‚àö should use custom domain when COOKIE_DOMAIN is set (7 ms)
      ‚àö should have httpOnly true (XSS protection) (11 ms)
      ‚àö should have sameSite strict (CSRF protection) (13 ms)
      ‚àö should have maxAge matching access token expiry (15 minutes) (22 ms)
      ‚àö should have path set to root (24 ms)
    Refresh Token Cookie Options
      ‚àö should have correct security properties (12 ms)
      ‚àö should have maxAge matching refresh token expiry (7 days) (14 ms)
      ‚àö should have path scoped to refresh endpoint (least privilege) (11 ms)
    CSRF Token Cookie Options
      ‚àö should have httpOnly false (client must read for X-CSRF-Token header) (16 ms)
      ‚àö should have correct security properties (12 ms)
      ‚àö should have maxAge matching access token (session-tied) (19 ms)
    Clear Cookie Options
      ‚àö should match access token options (except maxAge) (16 ms)
      ‚àö should match refresh token options (except maxAge) (9 ms)
      ‚àö should have same path as original cookie (required for proper deletion) (15 ms)
      ‚àö should have same domain as original cookie (required for proper deletion) (6 ms)
    Environment-Specific Behavior
      ‚àö should have secure: false in development (6 ms)
      ‚àö should have secure: false in test (5 ms)
      ‚àö should have secure: true in production (6 ms)
    Cookie Configuration Summary
      ‚àö should return configuration summary (13 ms)
      ‚àö should show production environment correctly (24 ms)
      ‚àö should show custom domain when set (6 ms)
      ‚àö should show same-domain when COOKIE_DOMAIN not set (6 ms)
    Security Compliance
      ‚àö should have all security flags enabled in production (7 ms)
      ‚àö should prevent JavaScript access to auth tokens (XSS mitigation) (6 ms)
      ‚àö should require HTTPS in production (MitM mitigation) (10 ms)
      ‚àö should prevent cross-site requests (CSRF mitigation) (13 ms)
    Exports
      ‚àö should export all required constants (14 ms)

[2025-12-12 06:13:08] info: [POST] /api/auth/change-password
[2025-12-12 06:13:08] info: [auth] Authenticated user 3eac9d7c-a8f3-4ea7-9e75-76172ab76fee for POST /change-password
[2025-12-12 06:13:08] info: [PUT] /api/horses/64150
[2025-12-12 06:13:08] info: [auth] Authenticated user 8ef60293-5930-4690-b1ff-8eda4caf3320 for PUT /horses/64150
[2025-12-12 06:13:08] error: [authController.changePassword] Error changing password: User not found
[2025-12-12 06:13:08] info: [POST] /api/auth/login
[2025-12-12 06:13:08] error: [POST] /api/auth/change-password - ERROR
[2025-12-12 06:13:08] error: Error User not found
[2025-12-12 06:13:08] info: [POST] /api/auth/change-password - 404
[2025-12-12 06:13:08] info: [ownership] Validated ownership: user 8ef60293-5930-4690-b1ff-8eda4caf3320 owns horse 64150
[2025-12-12 06:13:08] info: [PUT] /api/horses/64150 - 400
[2025-12-12 06:13:08] info: [POST] /api/auth/login
[2025-12-12 06:13:08] info: [PUT] /api/horses/64151
[2025-12-12 06:13:08] info: [auth] Authenticated user 557f9524-245d-491a-90f7-3ea50afeccb4 for PUT /horses/64151
[2025-12-12 06:13:08] info: [ownership] Validated ownership: user 557f9524-245d-491a-90f7-3ea50afeccb4 owns horse 64151
[2025-12-12 06:13:08] info: [PUT] /api/horses/64151 - 400
[2025-12-12 06:13:08] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:08] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:08] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:08] info: [POST] /api/auth/change-password
[2025-12-12 06:13:08] info: [PUT] /api/horses/64152
[2025-12-12 06:13:08] info: [auth] Authenticated user 51c5e19a-e76f-45a3-b8f8-0a1126c3674b for POST /change-password
[2025-12-12 06:13:08] info: [auth] Authenticated user 1be10181-e70d-45c7-aa68-9478ccd49bbb for PUT /horses/64152
[2025-12-12 06:13:08] warn: [Validation] Input validation failed
[2025-12-12 06:13:08] info: [POST] /api/auth/change-password - 400
[2025-12-12 06:13:08] info: [ownership] Validated ownership: user 1be10181-e70d-45c7-aa68-9478ccd49bbb owns horse 64152
[2025-12-12 06:13:08] info: [PUT] /api/horses/64152 - 400
[2025-12-12 06:13:08] info: [POST] /api/auth/login
[2025-12-12 06:13:08] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:08] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:08] info: [PUT] /api/horses/64153
[2025-12-12 06:13:08] info: [auth] Authenticated user fbf12ebc-107a-46b8-88ca-ac5fb481fce3 for PUT /horses/64153
[2025-12-12 06:13:08] info: [GET] /api/auth/profile
[2025-12-12 06:13:08] warn: [auth] Session expired due to age for GET /profile from ::ffff:127.0.0.1 (8 days old)
[2025-12-12 06:13:08] warn: [auth] Session expired. Please login again. for GET /profile from ::ffff:127.0.0.1
[2025-12-12 06:13:08] info: [GET] /api/auth/profile - 401
[2025-12-12 06:13:08] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:08] info: [ownership] Validated ownership: user fbf12ebc-107a-46b8-88ca-ac5fb481fce3 owns horse 64153
[2025-12-12 06:13:08] info: [PUT] /api/horses/64153 - 400
[2025-12-12 06:13:08] info: [PUT] /api/horses/64154
[2025-12-12 06:13:08] info: [auth] Authenticated user 1a3000c6-216e-4fec-8427-23e4e8a0b945 for PUT /horses/64154
[2025-12-12 06:13:08] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:08] warn: [AuthRateLimiter] resetAuthRateLimit() is deprecated with Redis
[2025-12-12 06:13:08] info: [ownership] Validated ownership: user 1a3000c6-216e-4fec-8427-23e4e8a0b945 owns horse 64154
[2025-12-12 06:13:08] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:08] info: [PUT] /api/horses/64154 - 400
[2025-12-12 06:13:08] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:08] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:08] error: [POST] /auth/register - ERROR
[2025-12-12 06:13:08] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:08] info: [POST] /auth/register - 500
[2025-12-12 06:13:08] info: [POST] /api/auth/login
[2025-12-12 06:13:08] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:08] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:08] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:08] info: [PUT] /api/horses/64155
[2025-12-12 06:13:08] info: [auth] Authenticated user b8ef35d5-6121-4be8-b34d-1ecf36e3a274 for PUT /horses/64155
[2025-12-12 06:13:08] info: [ownership] Validated ownership: user b8ef35d5-6121-4be8-b34d-1ecf36e3a274 owns horse 64155
[2025-12-12 06:13:08] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:08] warn: [authController.refreshToken] Token family invalidated due to reuse detection
[2025-12-12 06:13:08] info: [PUT] /api/horses/64155 - 400
[2025-12-12 06:13:08] error: [authController.refreshToken] Error refreshing token: Token reuse detected - please login again
[2025-12-12 06:13:08] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:08] error: Error Token reuse detected - please login again
[2025-12-12 06:13:08] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:08] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:08] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:08] error: [POST] /auth/register - ERROR
[2025-12-12 06:13:08] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:08] info: [POST] /auth/register - 500
[2025-12-12 06:13:08] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:08] info: [POST] /auth/register
[2025-12-12 06:13:08] info: [rateLimiting] Using in-memory rate limiting for test/disabled Redis environment
[2025-12-12 06:13:08] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:08] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:08] info: [GET] /api/horses
[2025-12-12 06:13:08] info: [auth] Authenticated user aac09c24-c072-49af-a074-e5167e33bb98 for GET /horses
[2025-12-12 06:13:08] info: [GET] /api/horses - 400
[2025-12-12 06:13:08] info: [GET] /api/horses/64158
[2025-12-12 06:13:08] info: [auth] Authenticated user 367abb2d-9d4d-44bc-bd64-7cbcde49d272 for GET /horses/64158
[2025-12-12 06:13:08] info: [GET] /api/horses/64158 - 406
[2025-12-12 06:13:08] info: [PUT] /api/horses/64159
[2025-12-12 06:13:08] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:08] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:08] info: [auth] Authenticated user 41b8e77b-9a39-4226-9982-b0f0a0559dbc for PUT /horses/64159
[2025-12-12 06:13:08] info: [PUT] /api/horses/64159
[2025-12-12 06:13:08] info: [auth] Authenticated user 41b8e77b-9a39-4226-9982-b0f0a0559dbc for PUT /horses/64159
[2025-12-12 06:13:08] info: [GET] /api/auth/profile
[2025-12-12 06:13:08] info: [ownership] Validated ownership: user 41b8e77b-9a39-4226-9982-b0f0a0559dbc owns horse 64159
[2025-12-12 06:13:08] info: [PUT] /api/horses/64159 - 400
[2025-12-12 06:13:08] info: [auth] Authenticated user a9128e8a-fe51-47a6-a992-a81f08c3b5e0 for GET /profile
[2025-12-12 06:13:08] info: [ownership] Validated ownership: user 41b8e77b-9a39-4226-9982-b0f0a0559dbc owns horse 64159
[2025-12-12 06:13:08] info: [PUT] /api/horses/64159 - 400
[2025-12-12 06:13:08] info: [GET] /api/auth/profile - 200
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:08] info: [SwaggerSetup] OpenAPI specification loaded successfully
[2025-12-12 06:13:08] info: [SwaggerSetup] API documentation setup completed
[2025-12-12 06:13:08] info: [SwaggerSetup] Interactive docs available at: /api-docs
[2025-12-12 06:13:08] info: [SwaggerSetup] OpenAPI JSON available at: /api-docs/swagger.json
[2025-12-12 06:13:08] info: [SwaggerSetup] OpenAPI YAML available at: /api-docs/swagger.yaml
[2025-12-12 06:13:08] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:08] info: [POST] /api/auth/login
[2025-12-12 06:13:09] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:09] info: [MemoryManager] Starting memory and resource monitoring
[2025-12-12 06:13:09] info: [EmailVerification] Verification status check
[2025-12-12 06:13:09] info: [POST] /auth/register
[2025-12-12 06:13:09] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:09] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:09] info: [POST] /api/auth/login
[2025-12-12 06:13:09] info: [GET] /api/auth/profile
[2025-12-12 06:13:09] info: [auth] Authenticated user fd751130-a3df-45d6-9eda-b966e92dab03 for GET /profile
[2025-12-12 06:13:09] info: [GET] /api/auth/profile - 200
[2025-12-12 06:13:09] info: [TokenRotation] Created new token pair
FAIL __tests__/unit/token-rotation.test.mjs (7.544 s)
  Token Rotation Service - Unit Tests
    generateTokenFamily()
      ‚àö should_create_unique_family_id (198 ms)
      ‚àö should_include_timestamp_in_family_id (156 ms)
    createTokenPair()
      ‚àö should_create_access_and_refresh_token_pair (171 ms)
      ‚àö should_create_refresh_token_with_family_id (160 ms)
      ‚àö should_store_refresh_token_in_database (201 ms)
      ‚àö should_set_correct_expiration_times (147 ms)
    validateRefreshToken()
      ‚àö should_validate_legitimate_refresh_token (168 ms)
      ‚àö should_reject_expired_refresh_token (168 ms)
      ‚àö should_reject_token_with_invalid_signature (171 ms)
      ‚àö should_reject_inactive_token_from_database (170 ms)
      ‚àö should_reject_malformed_token (147 ms)
    detectTokenReuse()
      ‚àö should_detect_reuse_of_invalidated_token (177 ms)
      ‚àö should_not_flag_first_use_as_reuse (190 ms)
      ‚àö should_identify_family_for_invalidation (234 ms)
    rotateRefreshToken()
      √ó should_create_new_token_and_invalidate_old (205 ms)
      ‚àö should_fail_rotation_for_invalid_token (201 ms)
      ‚àö should_fail_rotation_if_reuse_detected (316 ms)
      √ó should_handle_concurrent_rotation_attempts (193 ms)
    invalidateTokenFamily()
      √ó should_invalidate_all_tokens_in_family (347 ms)
      ‚àö should_handle_family_that_does_not_exist (161 ms)
      ‚àö should_log_invalidation_for_security_audit (260 ms)
    cleanupExpiredTokens()
      √ó should_remove_expired_tokens_from_database (176 ms)
      √ó should_remove_old_invalidated_tokens (173 ms)
      √ó should_return_cleanup_statistics (143 ms)
    Error Handling and Edge Cases
      ‚àö should_handle_database_connection_errors (149 ms)
      ‚àö should_handle_jwt_verification_errors_gracefully (142 ms)
      ‚àö should_validate_token_family_id_format (138 ms)

  ‚óè Token Rotation Service - Unit Tests ‚Ä∫ rotateRefreshToken() ‚Ä∫ should_create_new_token_and_invalidate_old

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 285 |[39m       [36mconst[39m rotationResult [33m=[39m [36mawait[39m rotateRefreshToken(oldTokenPair[33m.[39mrefreshToken)[33m;[39m
     [90m 286 |[39m
    [31m[1m>[22m[39m[90m 287 |[39m       expect(rotationResult[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                                      [31m[1m^[22m[39m
     [90m 288 |[39m       expect(rotationResult[33m.[39mnewTokenPair)[33m.[39mtoBeDefined()[33m;[39m
     [90m 289 |[39m       expect(rotationResult[33m.[39mnewTokenPair[33m.[39maccessToken)[33m.[39mtoBeDefined()[33m;[39m
     [90m 290 |[39m       expect(rotationResult[33m.[39mnewTokenPair[33m.[39mrefreshToken)[33m.[39mtoBeDefined()[33m;[39m[0m

      at Object.<anonymous> (__tests__/unit/token-rotation.test.mjs:287:38)

  ‚óè Token Rotation Service - Unit Tests ‚Ä∫ rotateRefreshToken() ‚Ä∫ should_handle_concurrent_rotation_attempts

    expect(received).toBeGreaterThanOrEqual(expected)

    Expected: >= 1
    Received:    0

    [0m [90m 345 |[39m
     [90m 346 |[39m       [90m// Expect at least one success; multiple successes tolerated in current impl[39m
    [31m[1m>[22m[39m[90m 347 |[39m       expect(successfulResults[33m.[39mlength)[33m.[39mtoBeGreaterThanOrEqual([35m1[39m)[33m;[39m
     [90m     |[39m                                        [31m[1m^[22m[39m
     [90m 348 |[39m     })[33m;[39m
     [90m 349 |[39m   })[33m;[39m
     [90m 350 |[39m[0m

      at Object.<anonymous> (__tests__/unit/token-rotation.test.mjs:347:40)

  ‚óè Token Rotation Service - Unit Tests ‚Ä∫ invalidateTokenFamily() ‚Ä∫ should_invalidate_all_tokens_in_family

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 0

    [0m [90m 361 |[39m
     [90m 362 |[39m       expect(invalidationResult[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 363 |[39m       expect(invalidationResult[33m.[39minvalidatedCount)[33m.[39mtoBe([35m3[39m)[33m;[39m
     [90m     |[39m                                                   [31m[1m^[22m[39m
     [90m 364 |[39m
     [90m 365 |[39m       [90m// Verify all tokens are invalidated[39m
     [90m 366 |[39m       [36mconst[39m allTokens [33m=[39m [36mawait[39m prisma[33m.[39mrefreshToken[33m.[39mfindMany({[0m

      at Object.<anonymous> (__tests__/unit/token-rotation.test.mjs:363:51)

  ‚óè Token Rotation Service - Unit Tests ‚Ä∫ cleanupExpiredTokens() ‚Ä∫ should_remove_expired_tokens_from_database

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

    [0m [90m 423 |[39m       [36mconst[39m cleanupResult [33m=[39m [36mawait[39m cleanupExpiredTokens()[33m;[39m
     [90m 424 |[39m
    [31m[1m>[22m[39m[90m 425 |[39m       expect(cleanupResult[33m.[39mremovedCount)[33m.[39mtoBe([35m1[39m)[33m;[39m
     [90m     |[39m                                          [31m[1m^[22m[39m
     [90m 426 |[39m
     [90m 427 |[39m       [90m// Verify expired token is removed[39m
     [90m 428 |[39m       [36mconst[39m expiredTokenRecord [33m=[39m [36mawait[39m prisma[33m.[39mrefreshToken[33m.[39mfindFirst({[0m

      at Object.<anonymous> (__tests__/unit/token-rotation.test.mjs:425:42)

  ‚óè Token Rotation Service - Unit Tests ‚Ä∫ cleanupExpiredTokens() ‚Ä∫ should_remove_old_invalidated_tokens

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

    [0m [90m 456 |[39m       [36mconst[39m cleanupResult [33m=[39m [36mawait[39m cleanupExpiredTokens({ olderThanDays[33m:[39m [35m7[39m })[33m;[39m
     [90m 457 |[39m
    [31m[1m>[22m[39m[90m 458 |[39m       expect(cleanupResult[33m.[39mremovedCount)[33m.[39mtoBe([35m1[39m)[33m;[39m
     [90m     |[39m                                          [31m[1m^[22m[39m
     [90m 459 |[39m     })[33m;[39m
     [90m 460 |[39m
     [90m 461 |[39m     it([32m'should_return_cleanup_statistics'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (__tests__/unit/token-rotation.test.mjs:458:42)

  ‚óè Token Rotation Service - Unit Tests ‚Ä∫ cleanupExpiredTokens() ‚Ä∫ should_return_cleanup_statistics

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 465 |[39m
     [90m 466 |[39m       [90m// Expired but not invalidated[39m
    [31m[1m>[22m[39m[90m 467 |[39m       [36mawait[39m prisma[33m.[39mrefreshToken[33m.[39mcreate({
     [90m     |[39m       [31m[1m^[22m[39m
     [90m 468 |[39m         data[33m:[39m {
     [90m 469 |[39m           token[33m:[39m [32m'expired-1'[39m[33m,[39m
     [90m 470 |[39m           userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/unit/token-rotation.test.mjs:467:7)

[2025-12-12 06:13:09] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:09] info: [cronJobService] Manually triggering token cleanup...
[2025-12-12 06:13:09] info: [cronJobService] Starting expired token cleanup...
[2025-12-12 06:13:09] info: [TokenRotation] Token cleanup completed
[2025-12-12 06:13:09] info: [cronJobService] Token cleanup completed. Removed 1 expired/invalidated tokens
[2025-12-12 06:13:09] info: [cronJobService] Manual token cleanup completed: {"removed":1,"expired":1,"invalidated":0,"timestamp":"2025-12-12T11:13:09.124Z"}
[2025-12-12 06:13:09] info: [EmailVerification] Created verification token
[2025-12-12 06:13:09] info: [EmailService] Email verification (DEV MODE - not sent)
  console.log
    
    === EMAIL VERIFICATION (DEV MODE) ===

      at sendVerificationEmail (utils/emailService.mjs:227:15)

  console.log
    To: csrftest1765537988556@test.com

      at sendVerificationEmail (utils/emailService.mjs:228:15)

  console.log
    Subject: Verify Your Email Address - Equoria

      at sendVerificationEmail (utils/emailService.mjs:229:15)

  console.log
    Verification URL: http://localhost:3000/verify-email?token=a589e390b12bc898eeb0b1c33cb1a3394945d4d3f8ee608b56fa672c227b639c

      at sendVerificationEmail (utils/emailService.mjs:230:15)

  console.log
    =====================================

      at sendVerificationEmail (utils/emailService.mjs:231:15)

[2025-12-12 06:13:09] info: [authController.register] Verification email sent
[2025-12-12 06:13:09] info: [POST] /auth/register - 201
[2025-12-12 06:13:09] info: [GET] /auth/csrf-token
[2025-12-12 06:13:09] info: [CSRF] Token generated
[2025-12-12 06:13:09] info: [GET] /auth/csrf-token - 200
[2025-12-12 06:13:09] info: [cronJobService] Manually triggering token cleanup...
[2025-12-12 06:13:09] info: [cronJobService] Starting expired token cleanup...
[2025-12-12 06:13:09] info: [GET] /auth/csrf-token
[2025-12-12 06:13:09] info: [CSRF] Token generated
[2025-12-12 06:13:09] info: [GET] /auth/csrf-token - 200
[2025-12-12 06:13:09] info: [TokenRotation] Token cleanup completed
[2025-12-12 06:13:09] info: [cronJobService] Token cleanup completed. Removed 1 expired/invalidated tokens
[2025-12-12 06:13:09] info: [cronJobService] Manual token cleanup completed: {"removed":1,"expired":1,"invalidated":0,"timestamp":"2025-12-12T11:13:09.189Z"}
[2025-12-12 06:13:09] info: [POST] /auth/register
[2025-12-12 06:13:09] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:09] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:09] warn: [AuthRateLimiter] resetAuthRateLimit() is deprecated with Redis
[2025-12-12 06:13:09] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:09] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:09] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:09] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:09] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:09] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:09] info: [POST] /api/auth/register
[2025-12-12 06:13:09] warn: [Validation] Input validation failed
[2025-12-12 06:13:09] info: [POST] /api/auth/register - 400
FAIL __tests__/integration/security/parameter-pollution.test.mjs (7.824 s)
  Parameter Pollution Attack Integration Tests
    HTTP Parameter Pollution (HPP)
      √ó should reject duplicate id parameters in query string (48 ms)
      ‚àö should reject duplicate id parameters in different positions (74 ms)
      √ó should use first parameter value when duplicates present (47 ms)
      √ó should reject array-syntax parameters where not expected (81 ms)
      ‚àö should reject mixed type parameters (32 ms)
    JSON Parameter Pollution
      √ó should reject duplicate keys in JSON payload (50 ms)
      ‚àö should reject nested parameter pollution (55 ms)
      √ó should reject prototype pollution attempts (38 ms)
      ‚àö should reject constructor pollution attempts (47 ms)
      ‚àö should sanitize JSON keys with special characters (48 ms)
    Array Parameter Manipulation
      ‚àö should reject oversized arrays in batch operations (26 ms)
      ‚àö should reject mixed-type arrays (22 ms)
      ‚àö should reject negative indices in array parameters (19 ms)
      ‚àö should reject sparse arrays with undefined holes (23 ms)
      ‚àö should enforce maximum array nesting depth (38 ms)
    Query String Pollution
      ‚àö should reject SQL injection in query parameters (83 ms)
      √ó should reject NoSQL injection in query parameters (50 ms)
      √ó should reject encoded special characters in parameters (42 ms)
      ‚àö should reject null bytes in query strings (36 ms)
      √ó should enforce query string length limits (26 ms)
    Content-Type Manipulation
      ‚àö should reject mismatched Content-Type and body format (32 ms)
      √ó should reject Content-Type charset manipulation (39 ms)
      √ó should reject multipart/form-data without proper boundaries (38 ms)
      √ó should accept only allowed Content-Types (48 ms)
    Nested Object Pollution
      √ó should reject excessive nesting depth (21 ms)
      √ó should reject circular references in objects (8 ms)
      √ó should sanitize nested object keys (23 ms)
      √ó should reject objects with numeric string keys (23 ms)
    Type Coercion Attacks
      √ó should reject boolean as string (18 ms)
      ‚àö should reject object as number (30 ms)
      ‚àö should reject array as string (49 ms)
      ‚àö should reject numeric string with leading zeros (30 ms)
      ‚àö should reject scientific notation where integers expected (42 ms)
      ‚àö should reject Infinity and NaN values (43 ms)
    Mass Assignment Vulnerabilities
      ‚àö should reject attempts to modify protected fields (30 ms)
      ‚àö should reject attempts to set createdAt/updatedAt manually (68 ms)
      ‚àö should only allow whitelisted fields in updates (22 ms)
      ‚àö should reject attempts to add new fields (35 ms)
    Parameter Injection via Headers
      √ó should reject parameter injection via custom headers (30 ms)
      ‚àö should reject SQL injection in custom headers (28 ms)
      ‚àö should reject malicious values in Accept header (28 ms)
    Race Condition via Parameter Timing
      ‚àö should prevent race conditions in concurrent updates (43 ms)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ HTTP Parameter Pollution (HPP) ‚Ä∫ should reject duplicate id parameters in query string

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 42 |[39m
     [90m 43 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 44 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 45 |[39m       data[33m:[39m {
     [90m 46 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 47 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:44:17)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ HTTP Parameter Pollution (HPP) ‚Ä∫ should use first parameter value when duplicates present

    expected 200 "OK", got 404 "Not Found"

    [0m [90m  97 |[39m         [33m.[39m[36mget[39m([32m`/api/horses/${testHorse.id}?sort=name&sort=age`[39m)
     [90m  98 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${validToken}`[39m)
    [31m[1m>[22m[39m[90m  99 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 100 |[39m
     [90m 101 |[39m       [90m// Should use first 'sort=name' parameter[39m
     [90m 102 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:99:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ HTTP Parameter Pollution (HPP) ‚Ä∫ should reject array-syntax parameters where not expected

    expected 400 "Bad Request", got 404 "Not Found"

    [0m [90m 111 |[39m           name[33m:[39m [[32m'HorseName1'[39m[33m,[39m [32m'HorseName2'[39m][33m,[39m [90m// Array where string expected[39m
     [90m 112 |[39m         })
    [31m[1m>[22m[39m[90m 113 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 114 |[39m
     [90m 115 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 116 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'Invalid'[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:113:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ JSON Parameter Pollution ‚Ä∫ should reject duplicate keys in JSON payload

    expected 400 "Bad Request", got 404 "Not Found"

    [0m [90m 144 |[39m         [33m.[39m[36mset[39m([32m'Content-Type'[39m[33m,[39m [32m'application/json'[39m)
     [90m 145 |[39m         [33m.[39msend(maliciousPayload)
    [31m[1m>[22m[39m[90m 146 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 147 |[39m
     [90m 148 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 149 |[39m[0m

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:146:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ JSON Parameter Pollution ‚Ä∫ should reject prototype pollution attempts

    expected 400 "Bad Request", got 404 "Not Found"

    [0m [90m 181 |[39m           }[33m,[39m
     [90m 182 |[39m         })
    [31m[1m>[22m[39m[90m 183 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 184 |[39m
     [90m 185 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 186 |[39m[0m

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:183:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Query String Pollution ‚Ä∫ should reject NoSQL injection in query parameters

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 42 |[39m
     [90m 43 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 44 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 45 |[39m       data[33m:[39m {
     [90m 46 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 47 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:44:17)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Query String Pollution ‚Ä∫ should reject encoded special characters in parameters

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 42 |[39m
     [90m 43 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 44 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 45 |[39m       data[33m:[39m {
     [90m 46 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 47 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:44:17)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Query String Pollution ‚Ä∫ should enforce query string length limits

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 42 |[39m
     [90m 43 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 44 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 45 |[39m       data[33m:[39m {
     [90m 46 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 47 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:44:17)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Content-Type Manipulation ‚Ä∫ should reject Content-Type charset manipulation

    expected 400 "Bad Request", got 404 "Not Found"

    [0m [90m 366 |[39m         [33m.[39m[36mset[39m([32m'Content-Type'[39m[33m,[39m [32m'application/json; charset=utf-7'[39m)
     [90m 367 |[39m         [33m.[39msend({ name[33m:[39m [32m'HackedName'[39m })
    [31m[1m>[22m[39m[90m 368 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 369 |[39m
     [90m 370 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 371 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:368:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Content-Type Manipulation ‚Ä∫ should reject multipart/form-data without proper boundaries

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 42 |[39m
     [90m 43 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 44 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 45 |[39m       data[33m:[39m {
     [90m 46 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 47 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:44:17)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Content-Type Manipulation ‚Ä∫ should accept only allowed Content-Types

    expected 415 "Unsupported Media Type", got 404 "Not Found"

    [0m [90m 390 |[39m         [33m.[39m[36mset[39m([32m'Content-Type'[39m[33m,[39m [32m'application/xml'[39m) [90m// Not allowed[39m
     [90m 391 |[39m         [33m.[39msend([32m'<name>HackedName</name>'[39m)
    [31m[1m>[22m[39m[90m 392 |[39m         [33m.[39mexpect([35m415[39m)[33m;[39m [90m// Unsupported Media Type[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 393 |[39m
     [90m 394 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 395 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:392:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Nested Object Pollution ‚Ä∫ should reject excessive nesting depth

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 42 |[39m
     [90m 43 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 44 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 45 |[39m       data[33m:[39m {
     [90m 46 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 47 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:44:17)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Nested Object Pollution ‚Ä∫ should reject circular references in objects

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 42 |[39m
     [90m 43 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 44 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 45 |[39m       data[33m:[39m {
     [90m 46 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 47 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:44:17)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Nested Object Pollution ‚Ä∫ should sanitize nested object keys

    expected 400 "Bad Request", got 404 "Not Found"

    [0m [90m 437 |[39m           }[33m,[39m
     [90m 438 |[39m         })
    [31m[1m>[22m[39m[90m 439 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 440 |[39m
     [90m 441 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 442 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:439:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Nested Object Pollution ‚Ä∫ should reject objects with numeric string keys

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 42 |[39m
     [90m 43 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 44 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 45 |[39m       data[33m:[39m {
     [90m 46 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 47 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:44:17)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Type Coercion Attacks ‚Ä∫ should reject boolean as string

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 42 |[39m
     [90m 43 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 44 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 45 |[39m       data[33m:[39m {
     [90m 46 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 47 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:44:17)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Parameter Injection via Headers ‚Ä∫ should reject parameter injection via custom headers

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 42 |[39m
     [90m 43 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 44 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 45 |[39m       data[33m:[39m {
     [90m 46 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 47 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:44:17)

[2025-12-12 06:13:09] info: [EmailVerification] Created verification token
[2025-12-12 06:13:09] info: [EmailVerification] Resent verification email
[2025-12-12 06:13:09] info: [EmailVerification] Created verification token
[2025-12-12 06:13:09] info: [EmailService] Email verification (DEV MODE - not sent)
  console.log
    
    === EMAIL VERIFICATION (DEV MODE) ===

      at sendVerificationEmail (utils/emailService.mjs:227:15)

  console.log
    To: cookietest2@test.com

      at sendVerificationEmail (utils/emailService.mjs:228:15)

  console.log
    Subject: Verify Your Email Address - Equoria

      at sendVerificationEmail (utils/emailService.mjs:229:15)

  console.log
    Verification URL: http://localhost:3000/verify-email?token=9b05281aa5afc3ab0515fc677e479836d461d7c29da8c3c9a07cfce5604532c3

      at sendVerificationEmail (utils/emailService.mjs:230:15)

  console.log
    =====================================

      at sendVerificationEmail (utils/emailService.mjs:231:15)

[2025-12-12 06:13:09] info: [authController.register] Verification email sent
[2025-12-12 06:13:09] info: [POST] /auth/register - 201
[2025-12-12 06:13:09] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:09] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:09] info: [POST] /api/auth/refresh-token - 200
[2025-12-12 06:13:09] info: [POST] /auth/register
[2025-12-12 06:13:09] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:09] info: [rateLimiting] Using in-memory rate limiting for test/disabled Redis environment
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:09] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:09] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:09] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:09] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:09] error: [POST] /auth/register - ERROR
[2025-12-12 06:13:09] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:09] info: [POST] /auth/register - 500
[2025-12-12 06:13:09] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:09] info: [SwaggerSetup] OpenAPI specification loaded successfully
[2025-12-12 06:13:09] info: [SwaggerSetup] API documentation setup completed
[2025-12-12 06:13:09] info: [SwaggerSetup] Interactive docs available at: /api-docs
[2025-12-12 06:13:09] info: [SwaggerSetup] OpenAPI JSON available at: /api-docs/swagger.json
[2025-12-12 06:13:09] info: [SwaggerSetup] OpenAPI YAML available at: /api-docs/swagger.yaml
[2025-12-12 06:13:09] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:09] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:09] info: [POST] /api/auth/refresh-token - 200
[2025-12-12 06:13:09] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:09] info: [MemoryManager] Starting memory and resource monitoring
[2025-12-12 06:13:09] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:09] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:09] info: [EmailVerification] Created verification token
[2025-12-12 06:13:09] info: [PUT] /api/horses/64163
[2025-12-12 06:13:09] info: [EmailVerification] Created verification token
[2025-12-12 06:13:09] info: [EmailService] Email verification (DEV MODE - not sent)
  console.log
    
    === EMAIL VERIFICATION (DEV MODE) ===

      at sendVerificationEmail (utils/emailService.mjs:227:15)

  console.log
    To: csrftest1765537989205@test.com

      at sendVerificationEmail (utils/emailService.mjs:228:15)

[2025-12-12 06:13:09] info: [auth] Authenticated user f51fb96a-1eec-4be2-a5f1-41753940ca0e for PUT /horses/64163
  console.log
    Subject: Verify Your Email Address - Equoria

      at sendVerificationEmail (utils/emailService.mjs:229:15)

  console.log
    Verification URL: http://localhost:3000/verify-email?token=3be0270dbe43ac21865e72628c0a30f11faa4ba3f75938c925806cc5203ad59c

      at sendVerificationEmail (utils/emailService.mjs:230:15)

  console.log
    =====================================

      at sendVerificationEmail (utils/emailService.mjs:231:15)

[2025-12-12 06:13:09] info: [authController.register] Verification email sent
[2025-12-12 06:13:09] info: [POST] /auth/register - 201
[2025-12-12 06:13:09] info: [GET] /auth/verify-email?token=74adf173b418ee32b46c5e2af6814974b31af3b14e2a3ed6d6e33c4848a5c209
[2025-12-12 06:13:09] info: [ownership] Validated ownership: user f51fb96a-1eec-4be2-a5f1-41753940ca0e owns horse 64163
[2025-12-12 06:13:09] info: [GET] /auth/csrf-token
[2025-12-12 06:13:09] info: [CSRF] Token generated
[2025-12-12 06:13:09] info: [GET] /auth/csrf-token - 200
FAIL __tests__/integration/session-lifecycle.test.mjs (8.245 s)
  Session Lifecycle Management
    CWE-384: Token Regeneration on Login
      √ó should delete all existing refresh tokens on login (125 ms)
      √ó should create fresh token pair on login (244 ms)
    CWE-613: Token Cleanup on Logout
      √ó should delete all refresh tokens on logout (54 ms)
      ‚àö should clear auth cookies on logout (236 ms)
    Force Logout on Password Change
      √ó should invalidate all sessions when password is changed (220 ms)
      √ó should reject password change with incorrect old password (201 ms)
      ‚àö should validate new password requirements (69 ms)
    CWE-613: Absolute Session Expiry
      ‚àö should reject tokens older than 7 days (72 ms)
      ‚àö should accept tokens less than 7 days old (186 ms)
      ‚àö should calculate token age correctly at the boundary (exactly 7 days) (59 ms)
    Token Cleanup Cron Job
      ‚àö should remove expired refresh tokens (99 ms)
      ‚àö should remove old invalidated tokens (30+ days) (46 ms)
      √ó should not remove valid active tokens (119 ms)
    Integration: Complete Session Lifecycle
      ‚àö should handle complete user journey: register -> login -> use session -> change password -> re-login (75 ms)

  ‚óè Session Lifecycle Management ‚Ä∫ CWE-384: Token Regeneration on Login ‚Ä∫ should delete all existing refresh tokens on login

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 0

    [0m [90m 130 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 131 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 132 |[39m       expect(tokensBefore)[33m.[39mtoBe([35m3[39m)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 133 |[39m
     [90m 134 |[39m       [90m// Login[39m
     [90m 135 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)[0m

      at Object.<anonymous> (__tests__/integration/session-lifecycle.test.mjs:132:28)

  ‚óè Session Lifecycle Management ‚Ä∫ CWE-384: Token Regeneration on Login ‚Ä∫ should create fresh token pair on login

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

    [0m [90m 181 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 182 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 183 |[39m       expect(tokens[33m.[39mlength)[33m.[39mtoBe([35m1[39m)[33m;[39m
     [90m     |[39m                             [31m[1m^[22m[39m
     [90m 184 |[39m       expect(tokens[[35m0[39m][33m.[39misActive)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 185 |[39m       expect(tokens[[35m0[39m][33m.[39misInvalidated)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 186 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/session-lifecycle.test.mjs:183:29)

  ‚óè Session Lifecycle Management ‚Ä∫ CWE-613: Token Cleanup on Logout ‚Ä∫ should delete all refresh tokens on logout

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

    [0m [90m 197 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 198 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 199 |[39m       expect(tokensBefore)[33m.[39mtoBe([35m2[39m)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 200 |[39m
     [90m 201 |[39m       [90m// Login to get auth cookies[39m
     [90m 202 |[39m       [36mconst[39m loginResponse [33m=[39m [36mawait[39m request(app)[0m

      at Object.<anonymous> (__tests__/integration/session-lifecycle.test.mjs:199:28)

  ‚óè Session Lifecycle Management ‚Ä∫ Force Logout on Password Change ‚Ä∫ should invalidate all sessions when password is changed

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

    [0m [90m 279 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 280 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 281 |[39m       expect(tokensBefore)[33m.[39mtoBe([35m1[39m)[33m;[39m [90m// Login creates 1 token (after deleting old ones)[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 282 |[39m
     [90m 283 |[39m       [90m// Change password[39m
     [90m 284 |[39m       [36mconst[39m newPassword [33m=[39m [32m'NewPassword456!'[39m[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/session-lifecycle.test.mjs:281:28)

  ‚óè Session Lifecycle Management ‚Ä∫ Force Logout on Password Change ‚Ä∫ should reject password change with incorrect old password

    expected 401 "Unauthorized", got 404 "Not Found"

    [0m [90m 337 |[39m           newPassword[33m:[39m [32m'NewPassword456!'[39m[33m,[39m
     [90m 338 |[39m         })
    [31m[1m>[22m[39m[90m 339 |[39m         [33m.[39mexpect([35m401[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 340 |[39m
     [90m 341 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 342 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'incorrect'[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/session-lifecycle.test.mjs:339:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Session Lifecycle Management ‚Ä∫ Token Cleanup Cron Job ‚Ä∫ should not remove valid active tokens

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

    [0m [90m 562 |[39m         }[33m,[39m
     [90m 563 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 564 |[39m       expect(countBefore)[33m.[39mtoBe([35m2[39m)[33m;[39m
     [90m     |[39m                           [31m[1m^[22m[39m
     [90m 565 |[39m
     [90m 566 |[39m       [90m// Run cleanup[39m
     [90m 567 |[39m       [36mawait[39m triggerTokenCleanup()[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/session-lifecycle.test.mjs:564:27)

[2025-12-12 06:13:09] error: [EmailVerification] Error verifying email token: Verification token has already been used
[2025-12-12 06:13:09] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:09] error: [authController.verifyEmail] Error verifying email: Verification token has already been used
[2025-12-12 06:13:09] error: [GET] /auth/verify-email?token=74adf173b418ee32b46c5e2af6814974b31af3b14e2a3ed6d6e33c4848a5c209 - ERROR
[2025-12-12 06:13:09] error: Error Verification token has already been used
[2025-12-12 06:13:09] info: [GET] /auth/verify-email?token=74adf173b418ee32b46c5e2af6814974b31af3b14e2a3ed6d6e33c4848a5c209 - 400
[2025-12-12 06:13:09] error: [EmailVerification] Error resending verification email: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:09] info: [horseRoutes] User f51fb96a-1eec-4be2-a5f1-41753940ca0e updated horse: Updated Horse Name (ID: 64163)
[2025-12-12 06:13:09] info: [PUT] /api/users/82803e63-0916-4237-80e3-8191a1e1a1fe
[2025-12-12 06:13:09] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:09] info: [auth] Authenticated user 82803e63-0916-4237-80e3-8191a1e1a1fe for PUT /users/82803e63-0916-4237-80e3-8191a1e1a1fe
[2025-12-12 06:13:09] info: [POST] /api/auth/login
[2025-12-12 06:13:09] info: [PUT] /api/users/82803e63-0916-4237-80e3-8191a1e1a1fe - 403
[2025-12-12 06:13:09] error: [authController.login] Error logging in user: Invalid credentials
[2025-12-12 06:13:09] error: [POST] /api/auth/login - ERROR
[2025-12-12 06:13:09] error: Error Invalid credentials
[2025-12-12 06:13:09] info: [POST] /api/auth/login - 401
[2025-12-12 06:13:09] info: [PUT] /api/horses/64163 - 200
[2025-12-12 06:13:09] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:09] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:09] warn: [authController.refreshToken] Token family invalidated due to reuse detection
[2025-12-12 06:13:09] error: [authController.refreshToken] Error refreshing token: Token reuse detected - please login again
[2025-12-12 06:13:09] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:09] error: Error Token reuse detected - please login again
[2025-12-12 06:13:09] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:09] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:09] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:09] warn: [authController.refreshToken] Token family invalidated due to reuse detection
[2025-12-12 06:13:09] error: [authController.refreshToken] Error refreshing token: Token reuse detected - please login again
[2025-12-12 06:13:09] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:09] error: Error Token reuse detected - please login again
[2025-12-12 06:13:09] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:09] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:09] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:09] warn: [authController.refreshToken] Token family invalidated due to reuse detection
[2025-12-12 06:13:09] error: [authController.refreshToken] Error refreshing token: Token reuse detected - please login again
[2025-12-12 06:13:09] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:09] error: Error Token reuse detected - please login again
[2025-12-12 06:13:09] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:09] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:09] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:09] info: [POST] /auth/register
[2025-12-12 06:13:09] warn: [authController.refreshToken] Token family invalidated due to reuse detection
[2025-12-12 06:13:09] error: [authController.refreshToken] Error refreshing token: Token reuse detected - please login again
[2025-12-12 06:13:09] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:09] error: Error Token reuse detected - please login again
[2025-12-12 06:13:09] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:09] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:09] info: [GET] /api/grooms/30977/profile
[2025-12-12 06:13:09] info: [auth] Authenticated user 9a6bd2de-5eba-4a29-b50a-94d69e0fe961 for GET /grooms/30977/profile
[2025-12-12 06:13:09] info: [GET] /auth/verify-email?token=e00544ea79caf5dffdffad5ddd07de241bcdadb6664f28e1f04fc56f67a28cdf
[2025-12-12 06:13:09] warn: [ownership] groom 30977 not found or not owned by user 9a6bd2de-5eba-4a29-b50a-94d69e0fe961
[2025-12-12 06:13:09] info: [GET] /api/grooms/30977/profile - 404
[2025-12-12 06:13:09] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:09] info: [EmailVerification] Created verification token
[2025-12-12 06:13:09] info: [EmailService] Email verification (DEV MODE - not sent)
  console.log
    
    === EMAIL VERIFICATION (DEV MODE) ===

      at sendVerificationEmail (utils/emailService.mjs:227:15)

  console.log
    To: cookietest3@test.com

      at sendVerificationEmail (utils/emailService.mjs:228:15)

  console.log
    Subject: Verify Your Email Address - Equoria

      at sendVerificationEmail (utils/emailService.mjs:229:15)

  console.log
    Verification URL: http://localhost:3000/verify-email?token=15844626bdd0726600869865ae33c900230cd0432ea950e818da6521eab5810a

      at sendVerificationEmail (utils/emailService.mjs:230:15)

  console.log
    =====================================

      at sendVerificationEmail (utils/emailService.mjs:231:15)

[2025-12-12 06:13:09] info: [authController.register] Verification email sent
[2025-12-12 06:13:09] info: [POST] /auth/register - 201
[2025-12-12 06:13:09] info: [rateLimiting] Using in-memory rate limiting for test/disabled Redis environment
[2025-12-12 06:13:10] info: [POST] /api/auth/login
[2025-12-12 06:13:10] info: [SwaggerSetup] OpenAPI specification loaded successfully
[2025-12-12 06:13:10] info: [SwaggerSetup] API documentation setup completed
[2025-12-12 06:13:10] info: [SwaggerSetup] Interactive docs available at: /api-docs
[2025-12-12 06:13:10] info: [SwaggerSetup] OpenAPI JSON available at: /api-docs/swagger.json
[2025-12-12 06:13:10] info: [SwaggerSetup] OpenAPI YAML available at: /api-docs/swagger.yaml
[2025-12-12 06:13:10] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:10] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:10] info: [MemoryManager] Starting memory and resource monitoring
[2025-12-12 06:13:10] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:10] warn: [AuthRateLimiter] resetAuthRateLimit() is deprecated with Redis
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:10] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:10] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:10] info: [TokenRotation] Token rotation successful
[2025-12-12 06:13:10] info: [authController.refreshToken] Token rotation successful
[2025-12-12 06:13:10] info: [POST] /api/auth/refresh-token - 200
[2025-12-12 06:13:10] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:10] warn: [TokenRotation] Token reuse detected
[2025-12-12 06:13:10] warn: [TokenRotation] Token family invalidated
[2025-12-12 06:13:10] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:10] warn: [authController.refreshToken] Token family invalidated due to reuse detection
[2025-12-12 06:13:10] error: [authController.refreshToken] Error refreshing token: Token reuse detected - please login again
[2025-12-12 06:13:10] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:10] error: Error Token reuse detected - please login again
[2025-12-12 06:13:10] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:10] info: [POST] /api/auth/login
[2025-12-12 06:13:10] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:10] warn: [AuthRateLimiter] resetAuthRateLimit() is deprecated with Redis
[2025-12-12 06:13:10] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:10] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:10] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:10] info: [EmailVerification] Created verification token
[2025-12-12 06:13:10] info: [EmailService] Email verification (DEV MODE - not sent)
  console.log
    
    === EMAIL VERIFICATION (DEV MODE) ===

      at sendVerificationEmail (utils/emailService.mjs:227:15)

  console.log
    To: csrftest1765537989854@test.com

      at sendVerificationEmail (utils/emailService.mjs:228:15)

  console.log
    Subject: Verify Your Email Address - Equoria

      at sendVerificationEmail (utils/emailService.mjs:229:15)

  console.log
    Verification URL: http://localhost:3000/verify-email?token=cd2fbdca832b3a8bda68232ef6e319c864d068d6c4cb955e7e5ea88ba5c46053

      at sendVerificationEmail (utils/emailService.mjs:230:15)

  console.log
    =====================================

      at sendVerificationEmail (utils/emailService.mjs:231:15)

[2025-12-12 06:13:10] info: [authController.register] Verification email sent
[2025-12-12 06:13:10] info: [POST] /auth/register - 201
[2025-12-12 06:13:10] info: [TokenRotation] Token rotation successful
[2025-12-12 06:13:10] info: [authController.refreshToken] Token rotation successful
[2025-12-12 06:13:10] info: [POST] /api/auth/refresh-token - 200
[2025-12-12 06:13:10] info: [GET] /auth/csrf-token
[2025-12-12 06:13:10] info: [CSRF] Token generated
[2025-12-12 06:13:10] info: [GET] /auth/csrf-token - 200
[2025-12-12 06:13:10] info: [PUT] /api/users/9bcaebf3-de4d-4201-9c35-a6fa6e8f6e08
[2025-12-12 06:13:10] info: [auth] Authenticated user 9bcaebf3-de4d-4201-9c35-a6fa6e8f6e08 for PUT /users/9bcaebf3-de4d-4201-9c35-a6fa6e8f6e08
[2025-12-12 06:13:10] info: [PUT] /api/users/9bcaebf3-de4d-4201-9c35-a6fa6e8f6e08 - 403
[2025-12-12 06:13:10] info: [EmailVerification] Created verification token
[2025-12-12 06:13:10] info: [EmailVerification] Resent verification email
[2025-12-12 06:13:10] info: [EmailVerification] Email verified successfully
[2025-12-12 06:13:10] info: [EmailService] Welcome email (DEV MODE - not sent)
[2025-12-12 06:13:10] warn: [Performance] Slow request detected: GET /verify-email took 1024ms
[2025-12-12 06:13:10] info: [GET] /auth/verify-email?token=e00544ea79caf5dffdffad5ddd07de241bcdadb6664f28e1f04fc56f67a28cdf - 200
[2025-12-12 06:13:10] error: [EmailVerification] Error creating verification token: Please wait 299 seconds before requesting another verification email
[2025-12-12 06:13:10] error: [EmailVerification] Error resending verification email: Please wait 299 seconds before requesting another verification email
  console.error
    Error cleaning database: 
    Invalid `prisma.user.deleteMany()` invocation:
    
    
    Error occurred during query execution:
    ConnectorError(ConnectorError { user_facing_error: None, kind: QueryError(PostgresError { code: "40P01", message: "deadlock detected", severity: "ERROR", detail: Some("Process 31128 waits for ShareLock on transaction 1400386; blocked by process 28776.\nProcess 28776 waits for ShareLock on transaction 1400385; blocked by process 31128."), column: None, hint: Some("See server log for query details.") }), transient: false })

    [0m [90m 74 |[39m     [90m// Ignore "table does not exist" errors[39m
     [90m 75 |[39m     [36mif[39m ([33m![39merror[33m.[39mmessage[33m?[39m[33m.[39mincludes([32m'does not exist'[39m)) {
    [31m[1m>[22m[39m[90m 76 |[39m       console[33m.[39merror([32m'Error cleaning database:'[39m[33m,[39m error[33m.[39mmessage)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 77 |[39m     }
     [90m 78 |[39m   }
     [90m 79 |[39m }[0m

      at cleanupDatabase (__tests__/setup.mjs:76:15)
      at Object.<anonymous> (__tests__/setup.mjs:47:3)

[2025-12-12 06:13:10] info: [POST] /auth/register
[2025-12-12 06:13:10] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:10] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:11] info: [POST] /auth/register
[2025-12-12 06:13:11] info: [MemoryManager] Starting memory and resource monitoring
[2025-12-12 06:13:11] info: [POST] /api/auth/register
[2025-12-12 06:13:11] warn: [UserDocService] Documentation directory not found
[2025-12-12 06:13:11] info: [UserDocService] Built search index with 0 terms
[2025-12-12 06:13:11] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:11] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:11] info: [UserDocService] Built search index with 111 terms
[2025-12-12 06:13:11] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /status
[2025-12-12 06:13:11] info: [MemoryManagement] Getting memory status
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] info: [UserDocRoutes] Getting all documentation list
[2025-12-12 06:13:11] warn: [auth] Access token is required for GET /profile from ::ffff:127.0.0.1
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 401
[2025-12-12 06:13:11] info: [UserDocRoutes] Getting all documentation list
[2025-12-12 06:13:11] warn: [auth] Access token is required for GET /status from ::ffff:127.0.0.1
[2025-12-12 06:13:11] info: [UserDocRoutes] Searching documentation for: "horse training"
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /metrics
[2025-12-12 06:13:11] info: [MemoryManagement] Getting memory metrics for timeframe: 1h
[2025-12-12 06:13:11] info: [POST] /api/auth/login
[2025-12-12 06:13:11] info: [GET] /auth/verify-email?token=ad2e98bdd7df913314a8500ab814d8c266da27fd82ca26d96ef7effb9f84eb16
[2025-12-12 06:13:11] info: [PUT] /api/auth/profile
[2025-12-12 06:13:11] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:11] warn: [auth] Access token is required for PUT /profile from ::ffff:127.0.0.1
[2025-12-12 06:13:11] info: [PUT] /api/auth/profile - 401
[2025-12-12 06:13:11] info: [UserDocRoutes] Searching documentation for: "horse"
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /metrics
[2025-12-12 06:13:11] info: [MemoryManagement] Getting memory metrics for timeframe: 1h
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /metrics
[2025-12-12 06:13:11] info: [MemoryManagement] Getting memory metrics for timeframe: 6h
[2025-12-12 06:13:11] info: [DELETE] /api/users/account
[2025-12-12 06:13:11] warn: [auth] Access token is required for DELETE /users/account from ::ffff:127.0.0.1
[2025-12-12 06:13:11] info: [DELETE] /api/users/account - 401
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /metrics
[2025-12-12 06:13:11] info: [MemoryManagement] Getting memory metrics for timeframe: 24h
[2025-12-12 06:13:11] info: [UserDocRoutes] Searching documentation for: "nonexistentterm12345"
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /metrics
[2025-12-12 06:13:11] info: [MemoryManagement] Getting memory metrics for timeframe: 7d
[2025-12-12 06:13:11] info: [UserDocRoutes] Getting document: feature-guide
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /metrics
[2025-12-12 06:13:11] info: [GET] /api/horses
[2025-12-12 06:13:11] info: [MemoryManagement] Getting memory metrics for timeframe: 1h
[2025-12-12 06:13:11] info: [UserDocRoutes] Getting document: strategy-guide
[2025-12-12 06:13:11] warn: [auth] Access token is required for GET /horses from ::ffff:127.0.0.1
[2025-12-12 06:13:11] info: [GET] /api/horses - 401
[2025-12-12 06:13:11] info: [UserDocRoutes] Searching documentation for: "horse"
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /metrics
[2025-12-12 06:13:11] info: [UserDocRoutes] Getting documentation analytics
[2025-12-12 06:13:11] info: [UserDocRoutes] Getting table of contents
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /resources
[2025-12-12 06:13:11] info: [MemoryManagement] Getting resource analytics
[2025-12-12 06:13:11] info: [UserDocRoutes] Getting document: feature-guide
[2025-12-12 06:13:11] info: [POST] /api/horses
[2025-12-12 06:13:11] warn: [auth] Access token is required for POST /horses from ::ffff:127.0.0.1
[2025-12-12 06:13:11] info: [POST] /api/horses - 401
[2025-12-12 06:13:11] info: [UserDocRoutes] Getting document: non-existent
[2025-12-12 06:13:11] warn: [UserDocService] Document not found: non-existent
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for POST /gc
[2025-12-12 06:13:11] error: [authController.verifyEmail] Error verifying email: Invalid or expired verification token
[2025-12-12 06:13:11] info: [MemoryManagement] Manual GC trigger requested (force: false)
[2025-12-12 06:13:11] error: [GET] /auth/verify-email?token=ad2e98bdd7df913314a8500ab814d8c266da27fd82ca26d96ef7effb9f84eb16 - ERROR
[2025-12-12 06:13:11] error: Error Invalid or expired verification token
[2025-12-12 06:13:11] info: [GET] /auth/verify-email?token=ad2e98bdd7df913314a8500ab814d8c266da27fd82ca26d96ef7effb9f84eb16 - 400
[2025-12-12 06:13:11] info: [UserDocRoutes] Getting document: feature-guide
[2025-12-12 06:13:11] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:11] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for POST /gc
[2025-12-12 06:13:11] warn: [AuthRateLimiter] resetAuthRateLimit() is deprecated with Redis
[2025-12-12 06:13:11] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:11] info: [UserDocRoutes] Getting document: feature-guide
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:11] warn: [auth] Invalid token for GET /profile from ::ffff:127.0.0.1: invalid signature
[2025-12-12 06:13:11] warn: [auth] Invalid or expired token for GET /profile from ::ffff:127.0.0.1
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 401
[2025-12-12 06:13:11] info: [UserDocRoutes] Getting document: feature-guide
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for POST /cleanup
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:11] info: [rateLimiting] Using in-memory rate limiting for test/disabled Redis environment
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:11] info: [UserDocRoutes] Getting document: feature-guide
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:11] info: [MemoryManagement] Resource cleanup requested for: all
[2025-12-12 06:13:11] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:11] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] info: [UserDocRoutes] Getting document: feature-guide
[2025-12-12 06:13:11] warn: [auth] Invalid token for GET /profile from ::ffff:127.0.0.1: invalid algorithm
[2025-12-12 06:13:11] warn: [auth] Invalid or expired token for GET /profile from ::ffff:127.0.0.1
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 401
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:11] info: [UserDocRoutes] Getting sections for document: feature-guide
[2025-12-12 06:13:11] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:11] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:11] warn: [authController.refreshToken] Token family invalidated due to reuse detection
[2025-12-12 06:13:11] error: [authController.refreshToken] Error refreshing token: Token reuse detected - please login again
[2025-12-12 06:13:11] info: [UserDocRoutes] Getting sections for document: non-existent
[2025-12-12 06:13:11] warn: [UserDocService] Document not found: non-existent
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for POST /cleanup
[2025-12-12 06:13:11] info: [MemoryManagement] Resource cleanup requested for: timers, intervals
[2025-12-12 06:13:11] warn: [MemoryManagement] Selective cleanup not yet implemented
[2025-12-12 06:13:11] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:11] error: Error Token reuse detected - please login again
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:11] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:11] warn: [authController.refreshToken] Token family invalidated due to reuse detection
[2025-12-12 06:13:11] error: [authController.refreshToken] Error refreshing token: Token reuse detected - please login again
[2025-12-12 06:13:11] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:11] error: Error Token reuse detected - please login again
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:11] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:11] warn: [authController.refreshToken] Token family invalidated due to reuse detection
[2025-12-12 06:13:11] error: [authController.refreshToken] Error refreshing token: Token reuse detected - please login again
[2025-12-12 06:13:11] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:11] error: Error Token reuse detected - please login again
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:11] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:11] warn: [authController.refreshToken] Token family invalidated due to reuse detection
[2025-12-12 06:13:11] error: [authController.refreshToken] Error refreshing token: Token reuse detected - please login again
[2025-12-12 06:13:11] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:11] error: Error Token reuse detected - please login again
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:11] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:11] warn: [authController.refreshToken] Token family invalidated due to reuse detection
[2025-12-12 06:13:11] error: [authController.refreshToken] Error refreshing token: Token reuse detected - please login again
[2025-12-12 06:13:11] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:11] error: Error Token reuse detected - please login again
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] warn: [auth] Invalid or expired token for GET /profile from ::ffff:127.0.0.1
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 401
[2025-12-12 06:13:11] info: [UserDocRoutes] Searching in document "feature-guide" for: "training"
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for POST /cleanup
[2025-12-12 06:13:11] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /alerts
[2025-12-12 06:13:11] info: [MemoryManagement] Getting memory alerts
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] warn: [auth] Invalid or expired token for GET /profile from ::ffff:127.0.0.1
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 401
[2025-12-12 06:13:11] info: [UserDocRoutes] Searching in document "feature-guide" for: "horse"
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /alerts
[2025-12-12 06:13:11] info: [MemoryManagement] Getting memory alerts
[2025-12-12 06:13:11] info: [UserDocRoutes] Searching in document "non-existent" for: "test"
[2025-12-12 06:13:11] warn: [UserDocService] Document not found: non-existent
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /alerts
[2025-12-12 06:13:11] info: [MemoryManagement] Getting memory alerts
[2025-12-12 06:13:11] info: [UserDocRoutes] Refreshing documentation cache
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /alerts
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] info: [MemoryManagement] Getting memory alerts
[2025-12-12 06:13:11] warn: [auth] Invalid or expired token for GET /profile from ::ffff:127.0.0.1
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 401
[2025-12-12 06:13:11] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:11] info: [UserDocService] Built search index with 111 terms
[2025-12-12 06:13:11] info: [UserDocService] Documentation refreshed successfully
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /alerts
[2025-12-12 06:13:11] info: [MemoryManagement] Getting memory alerts
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /alerts
[2025-12-12 06:13:11] info: [UserDocRoutes] Searching documentation for: "horse"
[2025-12-12 06:13:11] info: [SwaggerSetup] OpenAPI specification loaded successfully
[2025-12-12 06:13:11] info: [SwaggerSetup] API documentation setup completed
[2025-12-12 06:13:11] info: [SwaggerSetup] Interactive docs available at: /api-docs
[2025-12-12 06:13:11] info: [SwaggerSetup] OpenAPI JSON available at: /api-docs/swagger.json
[2025-12-12 06:13:11] info: [SwaggerSetup] OpenAPI YAML available at: /api-docs/swagger.yaml
[2025-12-12 06:13:11] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:11] info: [UserDocRoutes] Searching documentation for: "training"
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] warn: [auth] Token expired (precheck) for GET /profile from ::ffff:127.0.0.1
[2025-12-12 06:13:11] warn: [auth] Token expired for GET /profile from ::ffff:127.0.0.1
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 401
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /alerts
[2025-12-12 06:13:11] info: [UserDocRoutes] Searching documentation for: "competition"
[2025-12-12 06:13:11] info: [UserDocRoutes] Getting documentation analytics
[2025-12-12 06:13:11] info: [GET] /auth/verify-email
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /health
[2025-12-12 06:13:11] info: [MemoryManagement] Getting system health assessment
[2025-12-12 06:13:11] info: [UserDocRoutes] Getting document: feature-guide
[2025-12-12 06:13:11] error: [authController.verifyEmail] Error verifying email: Verification token is required
[2025-12-12 06:13:11] error: [GET] /auth/verify-email - ERROR
[2025-12-12 06:13:11] error: Error Verification token is required
[2025-12-12 06:13:11] info: [GET] /auth/verify-email - 400
[2025-12-12 06:13:11] info: [UserDocRoutes] Getting document: feature-guide
FAIL __tests__/integration/security/ownership-violations.test.mjs
  Ownership Violation Attempts Integration Tests
    Cross-user horse access
      √ó denies access to an unowned horse (173 ms)
      √ó allows owners to fetch their own horse (164 ms)
      √ó blocks cross-user updates and preserves data integrity (52 ms)
      ‚àö allows owners to update their horse with a valid payload (226 ms)
      √ó blocks cross-user deletes and allows owner deletes (34 ms)
    Groom ownership
      ‚àö denies access to an unowned groom profile (1110 ms)
      √ó allows owners to view their groom profile (88 ms)
    Parameter validation and enumeration safety
      √ó rejects invalid horse identifiers (59 ms)
      √ó returns the same 404 for missing and unowned horses (75 ms)

  ‚óè Ownership Violation Attempts Integration Tests ‚Ä∫ Cross-user horse access ‚Ä∫ denies access to an unowned horse

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 56 |[39m     tokenB [33m=[39m createMockToken(userB[33m.[39mid)[33m;[39m
     [90m 57 |[39m
    [31m[1m>[22m[39m[90m 58 |[39m     horseA [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m              [31m[1m^[22m[39m
     [90m 59 |[39m       data[33m:[39m {
     [90m 60 |[39m         name[33m:[39m [32m`HorseA-${Date.now()}`[39m[33m,[39m
     [90m 61 |[39m         userId[33m:[39m userA[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/ownership-violations.test.mjs:58:14)

  ‚óè Ownership Violation Attempts Integration Tests ‚Ä∫ Cross-user horse access ‚Ä∫ allows owners to fetch their own horse

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 56 |[39m     tokenB [33m=[39m createMockToken(userB[33m.[39mid)[33m;[39m
     [90m 57 |[39m
    [31m[1m>[22m[39m[90m 58 |[39m     horseA [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m              [31m[1m^[22m[39m
     [90m 59 |[39m       data[33m:[39m {
     [90m 60 |[39m         name[33m:[39m [32m`HorseA-${Date.now()}`[39m[33m,[39m
     [90m 61 |[39m         userId[33m:[39m userA[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/ownership-violations.test.mjs:58:14)

  ‚óè Ownership Violation Attempts Integration Tests ‚Ä∫ Cross-user horse access ‚Ä∫ blocks cross-user updates and preserves data integrity

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 56 |[39m     tokenB [33m=[39m createMockToken(userB[33m.[39mid)[33m;[39m
     [90m 57 |[39m
    [31m[1m>[22m[39m[90m 58 |[39m     horseA [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m              [31m[1m^[22m[39m
     [90m 59 |[39m       data[33m:[39m {
     [90m 60 |[39m         name[33m:[39m [32m`HorseA-${Date.now()}`[39m[33m,[39m
     [90m 61 |[39m         userId[33m:[39m userA[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/ownership-violations.test.mjs:58:14)

  ‚óè Ownership Violation Attempts Integration Tests ‚Ä∫ Cross-user horse access ‚Ä∫ blocks cross-user deletes and allows owner deletes

    PrismaClientKnownRequestError: 
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

    [0m [90m 74 |[39m     })[33m;[39m
     [90m 75 |[39m
    [31m[1m>[22m[39m[90m 76 |[39m     groomA [33m=[39m [36mawait[39m prisma[33m.[39mgroom[33m.[39mcreate({
     [90m    |[39m              [31m[1m^[22m[39m
     [90m 77 |[39m       data[33m:[39m {
     [90m 78 |[39m         name[33m:[39m [32m`GroomA-${Date.now()}`[39m[33m,[39m
     [90m 79 |[39m         userId[33m:[39m userA[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/ownership-violations.test.mjs:76:14)

  ‚óè Ownership Violation Attempts Integration Tests ‚Ä∫ Groom ownership ‚Ä∫ allows owners to view their groom profile

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 56 |[39m     tokenB [33m=[39m createMockToken(userB[33m.[39mid)[33m;[39m
     [90m 57 |[39m
    [31m[1m>[22m[39m[90m 58 |[39m     horseA [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m              [31m[1m^[22m[39m
     [90m 59 |[39m       data[33m:[39m {
     [90m 60 |[39m         name[33m:[39m [32m`HorseA-${Date.now()}`[39m[33m,[39m
     [90m 61 |[39m         userId[33m:[39m userA[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/ownership-violations.test.mjs:58:14)

  ‚óè Ownership Violation Attempts Integration Tests ‚Ä∫ Parameter validation and enumeration safety ‚Ä∫ rejects invalid horse identifiers

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 56 |[39m     tokenB [33m=[39m createMockToken(userB[33m.[39mid)[33m;[39m
     [90m 57 |[39m
    [31m[1m>[22m[39m[90m 58 |[39m     horseA [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m              [31m[1m^[22m[39m
     [90m 59 |[39m       data[33m:[39m {
     [90m 60 |[39m         name[33m:[39m [32m`HorseA-${Date.now()}`[39m[33m,[39m
     [90m 61 |[39m         userId[33m:[39m userA[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/ownership-violations.test.mjs:58:14)

  ‚óè Ownership Violation Attempts Integration Tests ‚Ä∫ Parameter validation and enumeration safety ‚Ä∫ returns the same 404 for missing and unowned horses

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 56 |[39m     tokenB [33m=[39m createMockToken(userB[33m.[39mid)[33m;[39m
     [90m 57 |[39m
    [31m[1m>[22m[39m[90m 58 |[39m     horseA [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m              [31m[1m^[22m[39m
     [90m 59 |[39m       data[33m:[39m {
     [90m 60 |[39m         name[33m:[39m [32m`HorseA-${Date.now()}`[39m[33m,[39m
     [90m 61 |[39m         userId[33m:[39m userA[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/ownership-violations.test.mjs:58:14)

[2025-12-12 06:13:11] info: [UserDocRoutes] Getting document: strategy-guide
[2025-12-12 06:13:11] info: [UserDocRoutes] Getting documentation analytics
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:11] warn: [auth] Session expired due to age for GET /profile from ::ffff:127.0.0.1 (8 days old)
[2025-12-12 06:13:11] warn: [auth] Session expired. Please login again. for GET /profile from ::ffff:127.0.0.1
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 401
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /health
[2025-12-12 06:13:11] info: [MemoryManagement] Getting system health assessment
[2025-12-12 06:13:11] info: [UserDocRoutes] Getting document: feature-guide
[2025-12-12 06:13:11] info: [POST] /api/auth/login
[2025-12-12 06:13:11] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:11] info: [MemoryManager] Starting memory and resource monitoring
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /health
[2025-12-12 06:13:11] info: [MemoryManagement] Getting system health assessment
[2025-12-12 06:13:11] error: [authController.login] Error logging in user: Invalid credentials
[2025-12-12 06:13:11] info: [UserDocRoutes] Getting document: feature-guide
[2025-12-12 06:13:11] error: [POST] /api/auth/login - ERROR
[2025-12-12 06:13:11] error: Error Invalid credentials
[2025-12-12 06:13:11] info: [POST] /api/auth/login - 401
[2025-12-12 06:13:11] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] warn: [auth] Invalid or expired token for GET /status from ::ffff:127.0.0.1
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:11] info: [auth] Authenticated user f21b02f2-7a02-4221-b7f8-41898f1e1c88 for GET /profile
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:11] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:11] warn: [authController.refreshToken] Token family invalidated due to reuse detection
[2025-12-12 06:13:11] error: [authController.refreshToken] Error refreshing token: Token reuse detected - please login again
[2025-12-12 06:13:11] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:11] error: Error Token reuse detected - please login again
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:11] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:11] warn: [authController.refreshToken] Token family invalidated due to reuse detection
[2025-12-12 06:13:11] error: [authController.refreshToken] Error refreshing token: Token reuse detected - please login again
[2025-12-12 06:13:11] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:11] error: Error Token reuse detected - please login again
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:11] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:11] warn: [authController.refreshToken] Token family invalidated due to reuse detection
[2025-12-12 06:13:11] error: [authController.refreshToken] Error refreshing token: Token reuse detected - please login again
[2025-12-12 06:13:11] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:11] error: Error Token reuse detected - please login again
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:11] warn: [auth] Access token is required for GET /status from ::ffff:127.0.0.1
[2025-12-12 06:13:11] error: [authController.getProfile] Error retrieving profile: User not found
[2025-12-12 06:13:11] error: [GET] /api/auth/profile - ERROR
[2025-12-12 06:13:11] error: Error User not found
[2025-12-12 06:13:11] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 404
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /metrics
[2025-12-12 06:13:11] info: [MemoryManagement] Getting memory metrics for timeframe: 1h
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /resources
[2025-12-12 06:13:11] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:11] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:11] info: [MemoryManagement] Getting resource analytics
[2025-12-12 06:13:11] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:11] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:11] info: [auth] Authenticated user 027bb106-215b-4579-af17-ca044d008624 for GET /profile
[2025-12-12 06:13:11] error: [POST] /auth/register - ERROR
[2025-12-12 06:13:11] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:11] info: [POST] /auth/register - 500
[2025-12-12 06:13:11] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:11] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:11] error: [POST] /auth/register - ERROR
[2025-12-12 06:13:11] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:11] info: [POST] /auth/register - 500
[2025-12-12 06:13:11] error: [authController.getProfile] Error retrieving profile: User not found
[2025-12-12 06:13:11] error: [GET] /api/auth/profile - ERROR
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /health
[2025-12-12 06:13:11] info: [MemoryManagement] Getting system health assessment
[2025-12-12 06:13:11] error: Error User not found
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 404
[2025-12-12 06:13:11] info: [POST] /auth/login
[2025-12-12 06:13:11] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /status
[2025-12-12 06:13:11] info: [MemoryManagement] Getting memory status
[2025-12-12 06:13:11] info: [POST] /auth/register
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] info: [auth] Authenticated user a6d2292f-55ae-478b-98eb-763ca22c4c95 for GET /profile
[2025-12-12 06:13:11] error: [authController.getProfile] Error retrieving profile: User not found
[2025-12-12 06:13:11] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:11] error: [GET] /api/auth/profile - ERROR
[2025-12-12 06:13:11] error: Error User not found
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 404
[2025-12-12 06:13:11] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:11] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:11] error: [POST] /api/auth/register - ERROR
[2025-12-12 06:13:11] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] info: [POST] /api/auth/register - 500
[2025-12-12 06:13:11] warn: [auth] Access token is required for GET /profile from ::ffff:127.0.0.1
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 401
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] warn: [auth] Access token is required for GET /profile from ::ffff:127.0.0.1
[2025-12-12 06:13:11] info: [GET] /auth/verify-email?token=invalid_token_here
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 401
[2025-12-12 06:13:11] info: [POST] /api/auth/register
PASS __tests__/routes/userDocumentationRoutes.test.mjs
  User Documentation Routes
    GET /api/user-docs
      ‚àö retrieves all documentation successfully (57 ms)
      ‚àö includes table of contents in response (14 ms)
    GET /api/user-docs/search
      ‚àö searches documentation successfully (18 ms)
      ‚àö validates search query parameter (17 ms)
      ‚àö respects search parameters (14 ms)
      ‚àö handles empty search results (34 ms)
    GET /api/user-docs/analytics
      ‚àö retrieves analytics successfully (33 ms)
    GET /api/user-docs/toc
      ‚àö retrieves table of contents successfully (8 ms)
    GET /api/user-docs/:docName
      ‚àö retrieves specific document successfully (13 ms)
      ‚àö returns 404 for non-existent document (13 ms)
      ‚àö serves markdown format correctly (13 ms)
      ‚àö serves text format correctly (12 ms)
      ‚àö tracks view analytics (21 ms)
    GET /api/user-docs/:docName/sections
      ‚àö retrieves document sections successfully (10 ms)
      ‚àö returns 404 for non-existent document sections (7 ms)
    GET /api/user-docs/:docName/search
      ‚àö searches within specific document successfully (19 ms)
      ‚àö validates search query for document search (8 ms)
      ‚àö highlights search terms in document search (8 ms)
      ‚àö returns 404 for document search on non-existent document (8 ms)
    POST /api/user-docs/refresh
      ‚àö refreshes documentation cache successfully (12 ms)
    GET /api/user-docs/health
      ‚àö returns system health status (7 ms)
    Error Handling
      ‚àö handles invalid route gracefully (9 ms)
      ‚àö handles malformed search parameters (6 ms)
    Integration with Documentation Service
      ‚àö search analytics are tracked across API calls (31 ms)
      ‚àö view analytics are tracked across API calls (23 ms)
      ‚àö document content is consistent across different endpoints (24 ms)

[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] warn: [auth] Access token is required for GET /profile from ::ffff:127.0.0.1
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 401
[2025-12-12 06:13:11] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] warn: [auth] Access token is required for GET /profile from ::ffff:127.0.0.1
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 401
[2025-12-12 06:13:11] info: [POST] /api/auth/login
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:11] info: [POST] /auth/login - 200
[2025-12-12 06:13:11] info: [auth] Authenticated user 2adfbed8-d671-450a-b1f6-751af90bfd17 for GET /profile
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 200
[2025-12-12 06:13:11] info: [POST] /auth/register
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] info: [auth] Authenticated user 3daf39c3-256a-4868-81d3-6c72a5c85fe3 for GET /profile
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 200
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] info: [auth] Authenticated user 3daf39c3-256a-4868-81d3-6c72a5c85fe3 for GET /profile
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 200
[2025-12-12 06:13:11] error: [authController.verifyEmail] Error verifying email: Invalid or expired verification token
[2025-12-12 06:13:11] error: [GET] /auth/verify-email?token=invalid_token_here - ERROR
[2025-12-12 06:13:11] error: Error Invalid or expired verification token
[2025-12-12 06:13:11] info: [GET] /auth/verify-email?token=invalid_token_here - 400
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] info: [auth] Authenticated user b97457bd-4f7a-46fd-b0d8-143aad6cf7a3 for GET /profile
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 200
[2025-12-12 06:13:11] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:11] info: [GET] /api/users/d91b3570-55fb-47da-aa61-5c6ce4d97a83
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:11] info: [auth] Authenticated user 1971b8f2-df48-4588-aa11-103201c2bdaf for GET /users/d91b3570-55fb-47da-aa61-5c6ce4d97a83
[2025-12-12 06:13:11] info: [auth] Authenticated user 1971b8f2-df48-4588-aa11-103201c2bdaf for GET /d91b3570-55fb-47da-aa61-5c6ce4d97a83
[2025-12-12 06:13:11] warn: [userRoutes] Self-access violation: user 1971b8f2-df48-4588-aa11-103201c2bdaf attempted to access user d91b3570-55fb-47da-aa61-5c6ce4d97a83
[2025-12-12 06:13:11] info: [GET] /api/users/d91b3570-55fb-47da-aa61-5c6ce4d97a83 - 403
[2025-12-12 06:13:11] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] info: [auth] Authenticated user 47dde4eb-910e-4ac0-80fe-815e0dd1501b for GET /profile
[2025-12-12 06:13:11] error: [authController.getProfile] Error retrieving profile: User not found
[2025-12-12 06:13:11] error: [GET] /api/auth/profile - ERROR
[2025-12-12 06:13:11] error: Error User not found
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 404
[2025-12-12 06:13:11] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:11] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] warn: [AuthRateLimiter] resetAuthRateLimit() is deprecated with Redis
[2025-12-12 06:13:11] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:11] info: [auth] Authenticated user a5939be5-8269-4489-8e88-ee95e0542f8d for GET /profile
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 200
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] info: [auth] Authenticated user a5939be5-8269-4489-8e88-ee95e0542f8d for GET /profile
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 200
[2025-12-12 06:13:11] error: [TokenRotation] Error rotating refresh token: 
Invalid `prisma.refreshToken.update()` invocation:


An operation failed because it depends on one or more records that were required but not found. No record was found for an update.
[2025-12-12 06:13:11] warn: [authController.refreshToken] Token rotation failed:
[2025-12-12 06:13:11] error: [authController.refreshToken] Error refreshing token: Invalid refresh token
[2025-12-12 06:13:11] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:11] error: Error Invalid refresh token
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:11] warn: [auth] Invalid token for GET /profile from ::ffff:127.0.0.1: invalid signature
[2025-12-12 06:13:11] warn: [auth] Invalid or expired token for GET /profile from ::ffff:127.0.0.1
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 401
[2025-12-12 06:13:11] info: [POST] /api/auth/login
[2025-12-12 06:13:11] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:11] warn: [authController.refreshToken] Token family invalidated due to reuse detection
[2025-12-12 06:13:11] error: [authController.refreshToken] Error refreshing token: Token reuse detected - please login again
[2025-12-12 06:13:11] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:11] error: Error Token reuse detected - please login again
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:11] warn: [authController.refreshToken] Token family invalidated due to reuse detection
[2025-12-12 06:13:11] error: [authController.refreshToken] Error refreshing token: Token reuse detected - please login again
[2025-12-12 06:13:11] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:11] error: Error Token reuse detected - please login again
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:11] warn: [auth] Invalid or expired token for GET /profile from ::ffff:127.0.0.1
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 401
[2025-12-12 06:13:11] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:11] error: [authController.login] Error logging in user: Invalid credentials
[2025-12-12 06:13:11] error: [POST] /api/auth/login - ERROR
[2025-12-12 06:13:11] error: Error Invalid credentials
[2025-12-12 06:13:11] info: [POST] /api/auth/login - 401
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] info: [auth] Authenticated user 1' OR '1'='1 for GET /profile
[2025-12-12 06:13:11] error: [authController.getProfile] Error retrieving profile: User not found
[2025-12-12 06:13:11] error: [GET] /api/auth/profile - ERROR
[2025-12-12 06:13:11] error: Error User not found
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 404
[2025-12-12 06:13:11] info: [POST] /api/auth/login
[2025-12-12 06:13:11] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:11] error: [authController.login] Error logging in user: Invalid credentials
[2025-12-12 06:13:11] error: [POST] /api/auth/login - ERROR
[2025-12-12 06:13:11] error: Error Invalid credentials
[2025-12-12 06:13:11] info: [CSRF] Token generated
[2025-12-12 06:13:11] info: [POST] /api/auth/login - 401
[2025-12-12 06:13:11] info: [GET] /api/auth/profile
[2025-12-12 06:13:11] info: [auth] Authenticated user undefined for GET /profile
[2025-12-12 06:13:11] error: [authController.getProfile] Error retrieving profile: Authentication error, user not found in request
[2025-12-12 06:13:11] error: [GET] /api/auth/profile - ERROR
[2025-12-12 06:13:11] error: Error Authentication error, user not found in request
[2025-12-12 06:13:11] info: [GET] /api/auth/profile - 401
[2025-12-12 06:13:11] info: [POST] /api/auth/login
[2025-12-12 06:13:11] error: [CSRF] Token generation failed: Token generation failed
[2025-12-12 06:13:11] error: [authController.login] Error logging in user: Invalid credentials
[2025-12-12 06:13:11] error: [POST] /api/auth/login - ERROR
[2025-12-12 06:13:11] error: Error Invalid credentials
[2025-12-12 06:13:11] info: [POST] /api/auth/login - 401
[2025-12-12 06:13:11] info: [CSRF] Token generated
[2025-12-12 06:13:11] info: [POST] /api/auth/login
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:11] info: [GET] /api/users/profile
[2025-12-12 06:13:11] error: [authController.login] Error logging in user: Invalid credentials
[2025-12-12 06:13:11] error: [POST] /api/auth/login - ERROR
[2025-12-12 06:13:11] error: Error Invalid credentials
[2025-12-12 06:13:11] info: [POST] /api/auth/login - 401
[2025-12-12 06:13:11] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:11] info: [auth] Authenticated user not-a-number for GET /users/profile
[2025-12-12 06:13:11] info: [auth] Authenticated user not-a-number for GET /profile
[2025-12-12 06:13:11] warn: [userRoutes] Self-access violation: user not-a-number attempted to access user profile
[2025-12-12 06:13:11] info: [GET] /api/users/profile - 403
[2025-12-12 06:13:11] info: [POST] /api/auth/login
[2025-12-12 06:13:11] warn: [CSRF] Invalid token detected
[2025-12-12 06:13:11] error: [authController.login] Error logging in user: Invalid credentials
[2025-12-12 06:13:11] error: [POST] /api/auth/login - ERROR
[2025-12-12 06:13:11] error: Error Invalid credentials
[2025-12-12 06:13:11] info: [POST] /api/auth/login - 401
[2025-12-12 06:13:11] warn: [CSRF] Invalid token detected
[2025-12-12 06:13:11] warn: [CSRF] Invalid token detected
[2025-12-12 06:13:11] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:11] warn: [CSRF] Invalid token detected
[2025-12-12 06:13:11] warn: [CSRF] Invalid token detected
[2025-12-12 06:13:11] info: [POST] /api/auth/login
[2025-12-12 06:13:11] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:11] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:11] warn: [CSRF] Invalid token detected
[2025-12-12 06:13:11] info: [CSRF] Token generated
[2025-12-12 06:13:11] info: [CSRF] Token generated
[2025-12-12 06:13:11] info: [CSRF] Token generated
[2025-12-12 06:13:11] info: [POST] /api/auth/login
[2025-12-12 06:13:11] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:11] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:11] info: [POST] /api/auth/login
[2025-12-12 06:13:11] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:11] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:11] info: [POST] /api/auth/login
[2025-12-12 06:13:11] info: [POST] /api/auth/login
[2025-12-12 06:13:11] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:11] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:11] error: [authController.login] Error logging in user: Invalid credentials
[2025-12-12 06:13:11] error: [POST] /api/auth/login - ERROR
[2025-12-12 06:13:11] error: Error Invalid credentials
[2025-12-12 06:13:11] info: [POST] /api/auth/login - 401
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:11] info: [POST] /api/auth/login
[2025-12-12 06:13:11] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:11] warn: [authController.refreshToken] Token family invalidated due to reuse detection
[2025-12-12 06:13:11] error: [authController.refreshToken] Error refreshing token: Token reuse detected - please login again
[2025-12-12 06:13:11] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:11] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:11] error: Error Token reuse detected - please login again
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:11] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:11] info: [POST] /api/auth/login
[2025-12-12 06:13:11] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:11] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:11] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:11] warn: [authController.refreshToken] Token family invalidated due to reuse detection
[2025-12-12 06:13:11] error: [authController.refreshToken] Error refreshing token: Token reuse detected - please login again
[2025-12-12 06:13:11] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:11] error: Error Token reuse detected - please login again
[2025-12-12 06:13:11] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:11] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:11] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:11] info: [POST] /api/auth/login
[2025-12-12 06:13:11] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:11] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:11] info: [POST] /api/auth/login
[2025-12-12 06:13:11] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:11] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:11] info: [GET] /auth/verify-email?token=746af0b99a67354b5ea568c9651f770e2cbeb36eef37ffb5827e2d5cf48b3fc0
[2025-12-12 06:13:11] info: [POST] /api/auth/login
[2025-12-12 06:13:11] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:11] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:11] info: [EmailVerification] Email verified successfully
[2025-12-12 06:13:11] info: [EmailService] Welcome email (DEV MODE - not sent)
[2025-12-12 06:13:12] info: [GET] /auth/verify-email?token=746af0b99a67354b5ea568c9651f770e2cbeb36eef37ffb5827e2d5cf48b3fc0 - 200
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] info: [GET] /auth/verify-email?token=746af0b99a67354b5ea568c9651f770e2cbeb36eef37ffb5827e2d5cf48b3fc0
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] info: [EmailVerification] Created verification token
[2025-12-12 06:13:12] info: [EmailService] Email verification (DEV MODE - not sent)
  console.log
    
    === EMAIL VERIFICATION (DEV MODE) ===

      at sendVerificationEmail (utils/emailService.mjs:227:15)

  console.log
    To: csrftest1765537991538@test.com

      at sendVerificationEmail (utils/emailService.mjs:228:15)

  console.log
    Subject: Verify Your Email Address - Equoria

      at sendVerificationEmail (utils/emailService.mjs:229:15)

  console.log
    Verification URL: http://localhost:3000/verify-email?token=ac21d787e1d5d3daed4a1d3f227c79f3eb50bc5385ab6a15e6ea72d6da2e0ccc

      at sendVerificationEmail (utils/emailService.mjs:230:15)

  console.log
    =====================================

      at sendVerificationEmail (utils/emailService.mjs:231:15)

[2025-12-12 06:13:12] info: [authController.register] Verification email sent
[2025-12-12 06:13:12] error: [EmailVerification] Error verifying email token: Verification token has already been used
[2025-12-12 06:13:12] error: [authController.verifyEmail] Error verifying email: Verification token has already been used
[2025-12-12 06:13:12] error: [GET] /auth/verify-email?token=746af0b99a67354b5ea568c9651f770e2cbeb36eef37ffb5827e2d5cf48b3fc0 - ERROR
[2025-12-12 06:13:12] error: Error Verification token has already been used
[2025-12-12 06:13:12] info: [POST] /auth/register - 201
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] info: [GET] /auth/verify-email?token=746af0b99a67354b5ea568c9651f770e2cbeb36eef37ffb5827e2d5cf48b3fc0 - 400
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] info: [GET] /auth/csrf-token
[2025-12-12 06:13:12] info: [CSRF] Token generated
[2025-12-12 06:13:12] info: [GET] /auth/csrf-token - 200
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] warn: [MemoryManager] Memory threshold alert: 98MB used
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] info: [PATCH] /api/users/eca90385-0d94-414b-9df2-72870d336dc2
[2025-12-12 06:13:12] info: [auth] Authenticated user eca90385-0d94-414b-9df2-72870d336dc2 for PATCH /users/eca90385-0d94-414b-9df2-72870d336dc2
[2025-12-12 06:13:12] info: [PATCH] /api/users/eca90385-0d94-414b-9df2-72870d336dc2 - 403
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] info: [POST] /auth/register
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] info: [POST] /api/auth/login
FAIL __tests__/integration/security/auth-bypass-attempts.test.mjs
  Authentication Bypass Attempts Integration Tests
    Direct Endpoint Access Without Authentication
      ‚àö should reject GET /api/users/profile without token (86 ms)
      ‚àö should reject PUT /api/users/profile without token (67 ms)
      ‚àö should reject DELETE /api/users/account without token (26 ms)
      ‚àö should reject GET /api/horses without token (34 ms)
      ‚àö should reject POST /api/horses without token (33 ms)
    Forged JWT Tokens
      ‚àö should reject token with wrong signature (38 ms)
      ‚àö should reject token signed with different algorithm (19 ms)
      ‚àö should reject token with modified payload (29 ms)
      ‚àö should reject token with algorithm none (17 ms)
      ‚àö should reject completely malformed token (19 ms)
    Expired Token Usage
      ‚àö should reject JWT token past expiration time (48 ms)
      ‚àö should reject token older than 7 days (CWE-613) (41 ms)
      √ó should accept token exactly 7 days old (44 ms)
    Token Replay Attacks
      √ó should allow same token for multiple valid requests (expected behavior) (28 ms)
      √ó should accept token from both cookie and header (cookie preferred) (30 ms)
    Authorization Header Manipulation
      ‚àö should reject token without Bearer prefix (14 ms)
      ‚àö should reject token with wrong scheme (20 ms)
      ‚àö should reject empty Authorization header (20 ms)
      ‚àö should reject Authorization header with only Bearer (34 ms)
      ‚àö should reject multiple Authorization headers (20 ms)
    Cookie Theft Simulation
      ‚àö should reject stolen cookie with different IP (if IP binding enabled) (28 ms)
      ‚àö should reject cookie with HttpOnly flag missing (client-side) (18 ms)
    Multi-User Session Conflicts
      ‚àö should prevent user A from accessing user B resources with valid token (33 ms)
      √ó should allow user to access their own resources only (20 ms)
      ‚àö should prevent concurrent logins from invalidating each other (stateless tokens) (30 ms)
    Edge Cases and Attack Vectors
      ‚àö should reject token with null bytes in payload (14 ms)
      ‚àö should reject extremely long token (DoS prevention) (25 ms)
      ‚àö should reject token with SQL injection in payload (22 ms)
      ‚àö should handle token with missing userId gracefully (20 ms)
      ‚àö should reject token with non-numeric userId (25 ms)

  ‚óè Authentication Bypass Attempts Integration Tests ‚Ä∫ Expired Token Usage ‚Ä∫ should accept token exactly 7 days old

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 239 |[39m         [33m.[39m[36mget[39m([32m'/api/auth/profile'[39m)
     [90m 240 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${sevenDayToken}`[39m)
    [31m[1m>[22m[39m[90m 241 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 242 |[39m
     [90m 243 |[39m       expectSuccessFlag(response[33m,[39m [36mtrue[39m)[33m;[39m
     [90m 244 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/security/auth-bypass-attempts.test.mjs:241:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Authentication Bypass Attempts Integration Tests ‚Ä∫ Token Replay Attacks ‚Ä∫ should allow same token for multiple valid requests (expected behavior)

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 251 |[39m         [33m.[39m[36mget[39m([32m'/api/auth/profile'[39m)
     [90m 252 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${validToken}`[39m)
    [31m[1m>[22m[39m[90m 253 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 254 |[39m
     [90m 255 |[39m       expectSuccessFlag(response1[33m,[39m [36mtrue[39m)[33m;[39m
     [90m 256 |[39m[0m

      at Object.<anonymous> (__tests__/integration/security/auth-bypass-attempts.test.mjs:253:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Authentication Bypass Attempts Integration Tests ‚Ä∫ Token Replay Attacks ‚Ä∫ should accept token from both cookie and header (cookie preferred)

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 272 |[39m         [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [32m`accessToken=${cookieToken}`[39m)
     [90m 273 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${headerToken}`[39m)
    [31m[1m>[22m[39m[90m 274 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 275 |[39m
     [90m 276 |[39m       expectSuccessFlag(response[33m,[39m [36mtrue[39m)[33m;[39m
     [90m 277 |[39m       [36mconst[39m responseUserId [33m=[39m response[33m.[39mbody[33m?[39m[33m.[39mdata[33m?[39m[33m.[39muser[33m?[39m[33m.[39mid [33m?[39m[33m?[39m response[33m.[39mbody[33m?[39m[33m.[39mdata[33m?[39m[33m.[39mid[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/security/auth-bypass-attempts.test.mjs:274:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Authentication Bypass Attempts Integration Tests ‚Ä∫ Multi-User Session Conflicts ‚Ä∫ should allow user to access their own resources only

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 401 |[39m         [33m.[39m[36mget[39m([32m'/api/auth/profile'[39m)
     [90m 402 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${validToken}`[39m)
    [31m[1m>[22m[39m[90m 403 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 404 |[39m
     [90m 405 |[39m       expectSuccessFlag(response[33m,[39m [36mtrue[39m)[33m;[39m
     [90m 406 |[39m       [36mconst[39m responseUserId [33m=[39m response[33m.[39mbody[33m?[39m[33m.[39mdata[33m?[39m[33m.[39muser[33m?[39m[33m.[39mid [33m?[39m[33m?[39m response[33m.[39mbody[33m?[39m[33m.[39mdata[33m?[39m[33m.[39mid[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/security/auth-bypass-attempts.test.mjs:403:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:12] info: [POST] /api/auth/login
PASS __tests__/middleware/csrf.test.mjs
  CSRF Protection Middleware
    getCsrfToken
      ‚àö should generate and return CSRF token (11 ms)
      ‚àö should handle token generation failure (14 ms)
      ‚àö should generate token without user (unauthenticated) (4 ms)
    applyCsrfProtection
      ‚àö should apply CSRF protection to POST requests (5 ms)
      ‚àö should apply CSRF protection to PUT requests (2 ms)
      ‚àö should apply CSRF protection to DELETE requests (2 ms)
      ‚àö should apply CSRF protection to PATCH requests (2 ms)
      ‚àö should skip CSRF protection for GET requests (2 ms)
      ‚àö should skip CSRF protection for HEAD requests (2 ms)
      ‚àö should skip CSRF protection for OPTIONS requests (2 ms)
    csrfErrorHandler
      ‚àö should handle CSRF validation errors (EBADCSRFTOKEN) (2 ms)
      ‚àö should pass non-CSRF errors to next handler (2 ms)
      ‚àö should handle CSRF error without user context (3 ms)
      ‚àö should include security logging context on CSRF error (3 ms)
    Security Scenarios
      ‚àö should protect against missing CSRF token (3 ms)
      ‚àö should protect against invalid CSRF token (4 ms)
      ‚àö should provide user-friendly error message (2 ms)
    Integration with Cookie Configuration
      ‚àö getCsrfToken should work without authentication (3 ms)
      ‚àö should handle concurrent token generation (3 ms)
    HTTP Method Classification
      ‚àö should NOT require CSRF token for GET requests (2 ms)
      ‚àö should NOT require CSRF token for HEAD requests (3 ms)
      ‚àö should NOT require CSRF token for OPTIONS requests (4 ms)
      ‚àö should require CSRF token for POST requests (2 ms)
      ‚àö should require CSRF token for PUT requests (4 ms)
      ‚àö should require CSRF token for DELETE requests (1 ms)
      ‚àö should require CSRF token for PATCH requests (4 ms)

[2025-12-12 06:13:12] error: [authController.login] Error logging in user: Invalid credentials
[2025-12-12 06:13:12] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:12] error: [POST] /api/auth/login - ERROR
[2025-12-12 06:13:12] error: Error Invalid credentials
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 401
[2025-12-12 06:13:12] info: [EmailVerification] Created verification token
[2025-12-12 06:13:12] info: [EmailService] Email verification (DEV MODE - not sent)
[2025-12-12 06:13:12] info: [POST] /api/auth/login
  console.log
    
    === EMAIL VERIFICATION (DEV MODE) ===

      at sendVerificationEmail (utils/emailService.mjs:227:15)

  console.log
    To: cookietest2@example.com

      at sendVerificationEmail (utils/emailService.mjs:228:15)

  console.log
    Subject: Verify Your Email Address - Equoria

      at sendVerificationEmail (utils/emailService.mjs:229:15)

  console.log
    Verification URL: http://localhost:3000/verify-email?token=f37234e614445c522662fd139bc42135b8872ccde7aa1db386b1ffd460793ade

      at sendVerificationEmail (utils/emailService.mjs:230:15)

  console.log
    =====================================

      at sendVerificationEmail (utils/emailService.mjs:231:15)

[2025-12-12 06:13:12] info: [authController.register] Verification email sent
[2025-12-12 06:13:12] error: [authController.login] Error logging in user: Invalid credentials
[2025-12-12 06:13:12] error: [POST] /api/auth/login - ERROR
[2025-12-12 06:13:12] error: Error Invalid credentials
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 401
[2025-12-12 06:13:12] info: [POST] /api/auth/register - 201
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] error: [authController.login] Error logging in user: Invalid credentials
[2025-12-12 06:13:12] error: [POST] /api/auth/login - ERROR
[2025-12-12 06:13:12] error: Error Invalid credentials
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 401
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:12] error: [authController.login] Error logging in user: Invalid credentials
[2025-12-12 06:13:12] error: [POST] /api/auth/login - ERROR
[2025-12-12 06:13:12] error: Error Invalid credentials
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 401
[2025-12-12 06:13:12] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:12] warn: [authController.refreshToken] Token family invalidated due to reuse detection
[2025-12-12 06:13:12] error: [authController.refreshToken] Error refreshing token: Token reuse detected - please login again
[2025-12-12 06:13:12] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:12] error: Error Token reuse detected - please login again
[2025-12-12 06:13:12] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:12] error: [authController.login] Error logging in user: Invalid credentials
[2025-12-12 06:13:12] error: [POST] /api/auth/login - ERROR
[2025-12-12 06:13:12] error: Error Invalid credentials
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 401
[2025-12-12 06:13:12] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:12] error: [POST] /auth/register - ERROR
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:12] info: [POST] /auth/register - 500
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] error: [authController.login] Error logging in user: Invalid credentials
[2025-12-12 06:13:12] error: [POST] /api/auth/login - ERROR
[2025-12-12 06:13:12] error: Error Invalid credentials
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 401
[2025-12-12 06:13:12] info: [POST] /auth/login
[2025-12-12 06:13:12] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:12] info: [GET] /auth/verify-email?token=9f4fa965b8e7f77b7ad025095272647e4e3ae9fdbb265caa4fe66eea3a7a38ea
[2025-12-12 06:13:12] info: [POST] /api/auth/register
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/register - 429
[2025-12-12 06:13:12] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:12] info: [POST] /api/auth/register
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/register - 429
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:12] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
FAIL __tests__/unit/email-verification.test.mjs (7.704 s)
  Email Verification Service - Unit Tests
    generateVerificationToken()
      ‚àö should_generate_unique_tokens (192 ms)
      ‚àö should_generate_64_character_hex_tokens (149 ms)
      ‚àö should_generate_cryptographically_secure_tokens (145 ms)
    createVerificationToken()
      ‚àö should_create_token_with_valid_user_id (169 ms)
      ‚àö should_store_token_in_database (163 ms)
      ‚àö should_set_expiration_to_24_hours (158 ms)
      ‚àö should_store_ip_address_and_user_agent (175 ms)
      ‚àö should_enforce_maximum_pending_tokens_limit (259 ms)
      ‚àö should_enforce_rate_limiting_cooldown (269 ms)
      √ó should_allow_token_creation_after_cooldown (188 ms)
    verifyEmailToken()
      √ó should_verify_valid_token (272 ms)
      √ó should_mark_user_email_as_verified (173 ms)
      √ó should_mark_token_as_used (181 ms)
      ‚àö should_reject_invalid_token (278 ms)
      √ó should_reject_already_used_token (182 ms)
      √ó should_reject_expired_token (157 ms)
      √ó should_use_atomic_transaction_for_verification (158 ms)
      ‚àö should_implement_timing_safe_response_for_invalid_tokens (261 ms)
    checkVerificationStatus()
      √ó should_return_verification_status_for_verified_user (174 ms)
      ‚àö should_return_verification_status_for_unverified_user (132 ms)
      ‚àö should_handle_non_existent_user (143 ms)
    resendVerificationEmail()
      ‚àö should_create_new_token_for_unverified_user (241 ms)
      √ó should_reject_resend_for_verified_user (185 ms)
      √ó should_cleanup_expired_tokens_before_creating_new (216 ms)
      ‚àö should_enforce_rate_limiting_on_resend (1190 ms)
    cleanupExpiredTokens()
      √ó should_delete_expired_tokens (164 ms)
      √ó should_delete_old_used_tokens (162 ms)
      √ó should_keep_active_valid_tokens (172 ms)
    getTokenInfo()
      √ó should_return_token_information (148 ms)
      √ó should_indicate_used_token (128 ms)
      √ó should_indicate_expired_token (145 ms)
      ‚àö should_return_null_for_invalid_token (119 ms)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ createVerificationToken() ‚Ä∫ should_allow_token_creation_after_cooldown

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:170:26)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ verifyEmailToken() ‚Ä∫ should_verify_valid_token

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:194:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ verifyEmailToken() ‚Ä∫ should_mark_user_email_as_verified

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:206:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ verifyEmailToken() ‚Ä∫ should_mark_token_as_used

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:219:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ verifyEmailToken() ‚Ä∫ should_reject_already_used_token

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:240:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ verifyEmailToken() ‚Ä∫ should_reject_expired_token

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:259:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ verifyEmailToken() ‚Ä∫ should_use_atomic_transaction_for_verification

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:275:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ checkVerificationStatus() ‚Ä∫ should_return_verification_status_for_verified_user

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:305:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ resendVerificationEmail() ‚Ä∫ should_reject_resend_for_verified_user

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:342:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ resendVerificationEmail() ‚Ä∫ should_cleanup_expired_tokens_before_creating_new

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at resendVerificationEmail (utils/emailVerificationService.mjs:318:23)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:366:7)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ cleanupExpiredTokens() ‚Ä∫ should_delete_expired_tokens

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:387:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ cleanupExpiredTokens() ‚Ä∫ should_delete_old_used_tokens

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:406:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ cleanupExpiredTokens() ‚Ä∫ should_keep_active_valid_tokens

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:421:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ getTokenInfo() ‚Ä∫ should_return_token_information

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:435:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ getTokenInfo() ‚Ä∫ should_indicate_used_token

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:448:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ getTokenInfo() ‚Ä∫ should_indicate_expired_token

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:459:25)

[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] error: [authController.verifyEmail] Error verifying email: Invalid or expired verification token
[2025-12-12 06:13:12] error: [GET] /auth/verify-email?token=9f4fa965b8e7f77b7ad025095272647e4e3ae9fdbb265caa4fe66eea3a7a38ea - ERROR
[2025-12-12 06:13:12] error: Error Invalid or expired verification token
[2025-12-12 06:13:12] info: [GET] /auth/verify-email?token=9f4fa965b8e7f77b7ad025095272647e4e3ae9fdbb265caa4fe66eea3a7a38ea - 400
[2025-12-12 06:13:12] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:12] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:12] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:12] error: [authController.login] Error logging in user: Invalid credentials
[2025-12-12 06:13:12] error: [POST] /api/auth/login - ERROR
[2025-12-12 06:13:12] error: Error Invalid credentials
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 401
[2025-12-12 06:13:12] info: [POST] /api/auth/logout
[2025-12-12 06:13:12] warn: [auth] Access token is required for POST /logout from ::ffff:127.0.0.1
[2025-12-12 06:13:12] info: [POST] /api/auth/logout - 401
[2025-12-12 06:13:12] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:12] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] info: [POST] /auth/login - 200
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] error: [authController.login] Error logging in user: Invalid credentials
[2025-12-12 06:13:12] error: [POST] /api/auth/login - ERROR
[2025-12-12 06:13:12] error: Error Invalid credentials
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 401
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:12] info: [POST] /auth/register
[2025-12-12 06:13:12] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:12] warn: [authController.refreshToken] Token family invalidated due to reuse detection
[2025-12-12 06:13:12] error: [authController.refreshToken] Error refreshing token: Token reuse detected - please login again
[2025-12-12 06:13:12] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:12] error: Error Token reuse detected - please login again
[2025-12-12 06:13:12] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:12] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:12] warn: [TokenRotation] Token reuse detected during rotation
[2025-12-12 06:13:12] warn: [authController.refreshToken] Token family invalidated due to reuse detection
[2025-12-12 06:13:12] error: [authController.refreshToken] Error refreshing token: Token reuse detected - please login again
[2025-12-12 06:13:12] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:12] error: Error Token reuse detected - please login again
[2025-12-12 06:13:12] info: [POST] /api/auth/refresh-token - 401
[2025-12-12 06:13:12] info: [POST] /api/auth/cleanup-tokens
[2025-12-12 06:13:12] warn: [auth] Access token is required for POST /auth/cleanup-tokens from ::ffff:127.0.0.1
[2025-12-12 06:13:12] info: [POST] /api/auth/cleanup-tokens - 401
[2025-12-12 06:13:12] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:12] info: [POST] /auth/resend-verification
[2025-12-12 06:13:12] info: [auth] Authenticated user 0cbd607c-368e-455b-af4c-eb422163479f for POST /resend-verification
[2025-12-12 06:13:12] info: [EmailVerification] Created verification token
[2025-12-12 06:13:12] info: [EmailVerification] Resent verification email
[2025-12-12 06:13:12] info: [EmailService] Email verification (DEV MODE - not sent)
[2025-12-12 06:13:12] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 200
  console.log
    
    === EMAIL VERIFICATION (DEV MODE) ===

      at sendVerificationEmail (utils/emailService.mjs:227:15)

  console.log
    To: emailint_1765537992290@example.com

      at sendVerificationEmail (utils/emailService.mjs:228:15)

  console.log
    Subject: Verify Your Email Address - Equoria

      at sendVerificationEmail (utils/emailService.mjs:229:15)

  console.log
    Verification URL: http://localhost:3000/verify-email?token=ca0620a7810e96f84e733b2b297baa8d74cb7d8a05c627bf7622d1f29f30a253

      at sendVerificationEmail (utils/emailService.mjs:230:15)

[2025-12-12 06:13:12] info: [POST] /api/auth/login
  console.log
    =====================================

      at sendVerificationEmail (utils/emailService.mjs:231:15)

[2025-12-12 06:13:12] info: [POST] /auth/resend-verification - 200
[2025-12-12 06:13:12] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:12] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:12] info: [GET] /api/auth/profile
[2025-12-12 06:13:12] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:12] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:12] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:12] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:12] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:12] error: [POST] /auth/register - ERROR
[2025-12-12 06:13:12] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:12] info: [POST] /auth/register - 500
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:12] info: [POST] /auth/register
[2025-12-12 06:13:12] warn: CORS blocked request from origin: http://evil.com
[2025-12-12 06:13:12] warn: [CORS] Request with no origin detected - API key validation required
  console.error
    TypeError: Cannot read properties of undefined (reading 'get')
        at Object.trustProxy (C:\Users\heirr\OneDrive\Desktop\Equoria\backend\node_modules\express-rate-limit\dist\index.mjs:140:21)
        at Object.wrappedValidations.<computed> [as trustProxy] (C:\Users\heirr\OneDrive\Desktop\Equoria\backend\node_modules\express-rate-limit\dist\index.mjs:370:22)
        at Object.keyGenerator (C:\Users\heirr\OneDrive\Desktop\Equoria\backend\node_modules\express-rate-limit\dist\index.mjs:642:20)
        at C:\Users\heirr\OneDrive\Desktop\Equoria\backend\node_modules\express-rate-limit\dist\index.mjs:696:32
        at C:\Users\heirr\OneDrive\Desktop\Equoria\backend\node_modules\express-rate-limit\dist\index.mjs:676:5

      at Object.wrappedValidations.<computed> [as trustProxy] (node_modules/express-rate-limit/dist/index.mjs:378:21)
      at Object.keyGenerator (node_modules/express-rate-limit/dist/index.mjs:642:20)
      at node_modules/express-rate-limit/dist/index.mjs:696:32
      at node_modules/express-rate-limit/dist/index.mjs:676:5

[2025-12-12 06:13:12] warn: [API Key] API_KEY not configured - requests with no origin are allowed (INSECURE)
[2025-12-12 06:13:12] info: [POST] /auth/resend-verification
[2025-12-12 06:13:12] warn: [API Key] Invalid or missing API key
[2025-12-12 06:13:12] warn: [auth] Access token is required for POST /resend-verification from ::ffff:127.0.0.1
[2025-12-12 06:13:12] info: [POST] /auth/resend-verification - 401
[2025-12-12 06:13:12] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:12] info: [GET] /api/auth/profile - 200
[2025-12-12 06:13:12] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:12] warn: [HTTPS] Insecure HTTP request detected, redirecting to HTTPS
[2025-12-12 06:13:12] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:12] info: [POST] /api/auth/refresh-token - 200
[2025-12-12 06:13:12] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:12] info: [GET] /api/auth/profile
[2025-12-12 06:13:12] warn: [auth] Access token is required for GET /profile from ::ffff:127.0.0.1
[2025-12-12 06:13:12] info: [GET] /api/auth/profile - 401
[2025-12-12 06:13:12] info: [GET] /api/auth/profile
[2025-12-12 06:13:12] warn: [auth] Invalid or expired token for GET /profile from ::ffff:127.0.0.1
[2025-12-12 06:13:12] info: [GET] /api/auth/profile - 401
[2025-12-12 06:13:12] info: [POST] /api/auth/login
[2025-12-12 06:13:12] info: [ApiDocService] OpenAPI specification saved successfully
[2025-12-12 06:13:12] error: [ApiDocService] Failed to load specification: OpenAPI specification file not found
[2025-12-12 06:13:12] info: [ApiDocService] OpenAPI specification saved successfully
[2025-12-12 06:13:12] info: [ApiDocService] Documentation generated for 2 endpoints
[2025-12-12 06:13:12] info: [ApiDocService] OpenAPI specification saved successfully
[2025-12-12 06:13:12] info: [ApiDocService] Documentation generated for 0 endpoints
[2025-12-12 06:13:12] info: [POST] /auth/resend-verification
[2025-12-12 06:13:12] info: [auth] Authenticated user f553d8bf-3339-4027-84bc-259849b43879 for POST /resend-verification
[2025-12-12 06:13:12] info: [ApiDocService] OpenAPI specification saved successfully
[2025-12-12 06:13:12] error: [EmailVerification] Error resending verification email: Email is already verified
[2025-12-12 06:13:12] error: [authController.resendVerification] Error resending verification: Email is already verified
[2025-12-12 06:13:12] error: [POST] /auth/resend-verification - ERROR
[2025-12-12 06:13:12] error: Error Email is already verified
[2025-12-12 06:13:12] info: [ApiDocService] Documentation generated for 1 endpoints
[2025-12-12 06:13:12] info: [POST] /auth/resend-verification - 500
[2025-12-12 06:13:12] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:12] info: [POST] /api/auth/refresh-token - 200
[2025-12-12 06:13:12] info: [ApiDocService] OpenAPI specification validation passed
[2025-12-12 06:13:12] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:12] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:12] warn: [ApiDocService] OpenAPI specification validation found 1 issues
[2025-12-12 06:13:12] warn: [ApiDocService] OpenAPI specification validation found 1 issues
[2025-12-12 06:13:12] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:12] warn: [ApiDocService] OpenAPI specification validation found 1 issues
[2025-12-12 06:13:12] info: [rateLimiting] Using in-memory rate limiting for test/disabled Redis environment
[2025-12-12 06:13:12] info: [ApiDocService] OpenAPI specification saved successfully
[2025-12-12 06:13:12] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:12] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:12] error: [POST] /auth/register - ERROR
[2025-12-12 06:13:12] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:12] info: [POST] /auth/register - 500
[2025-12-12 06:13:12] info: [ApiDocService] Documentation generated for 2 endpoints
PASS __tests__/unit/security/security-middleware.test.mjs
  security middleware
    corsOptions
      ‚àö allows known origins and rejects unknown (11 ms)
      ‚àö allows no-origin requests (legacy) and supports ALLOWED_ORIGINS env (4 ms)
    createRateLimiter
      ‚àö returns an express-rate-limit instance (18 ms)
    validateApiKey
      ‚àö skips when API_KEY not set (18 ms)
      ‚àö rejects missing or invalid key when configured (5 ms)
      ‚àö allows valid key (3 ms)
    enforceHttps
      ‚àö bypasses in non-production (7 ms)
      ‚àö redirects http in production (4 ms)
    addSecurityHeaders
      ‚àö sets baseline headers (14 ms)
    createSecurityMiddleware
      ‚àö returns middleware array including helmet, cors, and rate limiter (7 ms)

[2025-12-12 06:13:12] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:12] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:12] info: [POST] /auth/login
[2025-12-12 06:13:12] info: [ApiDocService] OpenAPI specification saved successfully
[2025-12-12 06:13:12] info: [ApiDocService] Documentation generated for 1 endpoints
[2025-12-12 06:13:12] info: [ApiDocService] OpenAPI specification validation passed
[2025-12-12 06:13:12] info: [ApiDocService] OpenAPI specification saved successfully
[2025-12-12 06:13:12] info: [ApiDocService] Documentation generated for 2 endpoints
[2025-12-12 06:13:12] warn: [ApiDocService] OpenAPI specification validation found 2 issues
[2025-12-12 06:13:12] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:12] info: [ApiDocService] OpenAPI specification validation passed
[2025-12-12 06:13:12] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for GET /health
[2025-12-12 06:13:12] info: [DocumentationRoutes] Getting documentation health status
[2025-12-12 06:13:12] info: [SwaggerSetup] OpenAPI specification loaded successfully
[2025-12-12 06:13:12] info: [POST] /auth/resend-verification
[2025-12-12 06:13:12] info: [SwaggerSetup] API documentation setup completed
[2025-12-12 06:13:12] info: [SwaggerSetup] Interactive docs available at: /api-docs
[2025-12-12 06:13:12] info: [SwaggerSetup] OpenAPI JSON available at: /api-docs/swagger.json
[2025-12-12 06:13:12] info: [SwaggerSetup] OpenAPI YAML available at: /api-docs/swagger.yaml
[2025-12-12 06:13:12] info: [cronJobService] Initializing cron jobs...
[2025-12-12 06:13:13] info: [auth] Authenticated user eed0e8b5-d93e-4804-a3ee-e72971729242 for POST /resend-verification
[2025-12-12 06:13:13] info: [ApiDocService] OpenAPI specification validation passed
[2025-12-12 06:13:13] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:13] info: [POST] /api/auth/refresh-token - 200
[2025-12-12 06:13:13] info: [cronJobService] All cron jobs initialized and started
[2025-12-12 06:13:13] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:13] info: [MemoryManager] Starting memory and resource monitoring
[2025-12-12 06:13:13] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:13] error: [EmailVerification] Error resending verification email: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:13] error: [authController.resendVerification] Error resending verification: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:13] error: [POST] /auth/resend-verification - ERROR
[2025-12-12 06:13:13] error: Error Failed to resend verification email due to an unexpected error.
[2025-12-12 06:13:13] info: [POST] /auth/resend-verification - 500
[2025-12-12 06:13:13] warn: [auth] Access token is required for GET /health from ::ffff:127.0.0.1
[2025-12-12 06:13:13] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:13] info: [POST] /api/auth/refresh-token - 200
[2025-12-12 06:13:13] info: [POST] /auth/resend-verification
[2025-12-12 06:13:13] info: [auth] Authenticated user eed0e8b5-d93e-4804-a3ee-e72971729242 for POST /resend-verification
[2025-12-12 06:13:13] warn: [MemoryManager] Memory threshold alert: 98MB used
[2025-12-12 06:13:13] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:13] error: [EmailVerification] Error resending verification email: User not found
[2025-12-12 06:13:13] error: [authController.resendVerification] Error resending verification: User not found
[2025-12-12 06:13:13] error: [POST] /auth/resend-verification - ERROR
[2025-12-12 06:13:13] info: [POST] /auth/login - 200
[2025-12-12 06:13:13] error: Error User not found
[2025-12-12 06:13:13] info: [POST] /auth/resend-verification - 404
[2025-12-12 06:13:13] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:13] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:13] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:13] info: [POST] /api/auth/refresh-token - 200
[2025-12-12 06:13:13] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for GET /metrics
[2025-12-12 06:13:13] info: [POST] /auth/register
[2025-12-12 06:13:13] info: [DocumentationRoutes] Getting documentation metrics
[2025-12-12 06:13:13] info: [auth] Authenticated user 9259191d-68e4-4f9b-a899-1aae8fb75036 for GET /metrics
[2025-12-12 06:13:13] info: [MemoryManagement] Getting memory metrics for timeframe: 1h
[2025-12-12 06:13:13] info: [POST] /api/auth/refresh-token
[2025-12-12 06:13:13] info: [MemoryManager] Stopping memory and resource monitoring
[2025-12-12 06:13:13] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:13] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:13] error: [authController.refreshToken] Error refreshing token: Refresh token is required
[2025-12-12 06:13:13] error: [POST] /api/auth/refresh-token - ERROR
[2025-12-12 06:13:13] error: Error Refresh token is required
[2025-12-12 06:13:13] info: [POST] /api/auth/refresh-token - 400
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for GET /metrics
[2025-12-12 06:13:13] info: [DocumentationRoutes] Getting documentation metrics
[2025-12-12 06:13:13] info: [POST] /api/auth/login
PASS __tests__/services/apiDocumentation.test.mjs
  API Documentation Service
    Specification Loading and Saving
      ‚àö loads OpenAPI specification correctly (14 ms)
      ‚àö saves OpenAPI specification correctly (9 ms)
      ‚àö throws error when specification file not found (10 ms)
    Endpoint Registration
      ‚àö registers endpoint correctly (9 ms)
      ‚àö registers multiple endpoints correctly (4 ms)
      ‚àö handles endpoint registration with minimal options (4 ms)
    Schema Registration
      ‚àö registers schema correctly (3 ms)
      ‚àö registers multiple schemas correctly (4 ms)
    Documentation Generation
      ‚àö generates documentation with registered endpoints (10 ms)
      ‚àö generates documentation with registered schemas (8 ms)
      ‚àö adds generation metadata to specification (18 ms)
    Specification Validation
      ‚àö validates correct specification (8 ms)
      ‚àö detects missing responses (5 ms)
      ‚àö detects missing summaries (5 ms)
      ‚àö detects missing tags (7 ms)
    Metrics and Analytics
      ‚àö calculates metrics correctly (17 ms)
      ‚àö generates health report correctly (16 ms)
      ‚àö provides recommendations based on metrics (11 ms)
    Example Generation
      ‚àö generates string examples correctly (3 ms)
      ‚àö generates email format examples (3 ms)
      ‚àö generates UUID format examples (3 ms)
      ‚àö generates object examples correctly (3 ms)
      ‚àö generates array examples correctly (5 ms)
    Helper Functions
      ‚àö registerEndpoint helper function works (3 ms)
      ‚àö registerSchema helper function works (3 ms)
      ‚àö getDocumentationMetrics helper function works (4 ms)
      ‚àö getDocumentationHealth helper function works (6 ms)

[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for GET /validation
[2025-12-12 06:13:13] info: [DocumentationRoutes] Validating OpenAPI specification
[2025-12-12 06:13:13] info: [ApiDocService] OpenAPI specification validation passed
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for POST /generate
[2025-12-12 06:13:13] info: [DocumentationRoutes] Generating API documentation
[2025-12-12 06:13:13] info: [ApiDocService] OpenAPI specification saved successfully
[2025-12-12 06:13:13] info: [ApiDocService] Documentation generated for 1 endpoints
[2025-12-12 06:13:13] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for POST /endpoints
[2025-12-12 06:13:13] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:13] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:13] error: [POST] /auth/register - ERROR
[2025-12-12 06:13:13] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:13] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:13] info: [POST] /auth/register - 500
[2025-12-12 06:13:13] info: [DocumentationRoutes] Registering endpoint: POST /api/horses
[2025-12-12 06:13:13] info: [POST] /api/auth/refresh-token - 200
[2025-12-12 06:13:13] info: [POST] /auth/register
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for POST /endpoints
[2025-12-12 06:13:13] info: [POST] /auth/resend-verification
[2025-12-12 06:13:13] info: [auth] Authenticated user ad3d4c74-9c81-44b0-8b54-e8d0005dac5a for POST /resend-verification
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for POST /endpoints
[2025-12-12 06:13:13] info: [DocumentationRoutes] Registering endpoint: GET /api/test-get
[2025-12-12 06:13:13] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:13] error: [EmailVerification] Error resending verification email: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:13] error: [authController.resendVerification] Error resending verification: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:13] error: [POST] /auth/resend-verification - ERROR
[2025-12-12 06:13:13] error: Error Failed to resend verification email due to an unexpected error.
[2025-12-12 06:13:13] info: [POST] /auth/resend-verification - 500
[2025-12-12 06:13:13] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:13] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for POST /endpoints
[2025-12-12 06:13:13] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:13] info: [DocumentationRoutes] Registering endpoint: POST /api/test-post
[2025-12-12 06:13:13] info: [POST] /api/auth/logout
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for POST /endpoints
[2025-12-12 06:13:13] info: [DocumentationRoutes] Registering endpoint: PUT /api/test-put
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for POST /endpoints
[2025-12-12 06:13:13] info: [DocumentationRoutes] Registering endpoint: DELETE /api/test-delete
[2025-12-12 06:13:13] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for POST /endpoints
[2025-12-12 06:13:13] info: [DocumentationRoutes] Registering endpoint: PATCH /api/test-patch
[2025-12-12 06:13:13] info: [GET] /api/horses/1;%20DROP%20TABLE%20horses;%20--
[2025-12-12 06:13:13] info: [auth] Authenticated user d239a5b0-e295-43f5-9771-b52a5dee5b78 for GET /horses/1;%20DROP%20TABLE%20horses;%20--
FAIL __tests__/routes/memoryManagementRoutes.test.mjs


  ‚óè Test suite failed to run

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 74 |[39m
     [90m 75 |[39m     [90m// Cleanup test data[39m
    [31m[1m>[22m[39m[90m 76 |[39m     [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 77 |[39m       where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 78 |[39m     })[33m;[39m
     [90m 79 |[39m   })[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/routes/memoryManagementRoutes.test.mjs:76:5)

[2025-12-12 06:13:13] info: [GET] /api/horses/1;%20DROP%20TABLE%20horses;%20-- - 400
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for POST /schemas
[2025-12-12 06:13:13] info: [DocumentationRoutes] Registering schema: Horse
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for POST /schemas
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for GET /coverage
[2025-12-12 06:13:13] info: [DocumentationRoutes] Getting documentation coverage analysis
[2025-12-12 06:13:13] info: [GET] /api/horses/1%20UNION%20SELECT%20*%20FROM%20users
[2025-12-12 06:13:13] info: [auth] Authenticated user 432d3aac-a8da-41af-9860-2fcceca62a78 for GET /horses/1%20UNION%20SELECT%20*%20FROM%20users
[2025-12-12 06:13:13] info: [GET] /api/horses/1%20UNION%20SELECT%20*%20FROM%20users - 400
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for GET /analytics
[2025-12-12 06:13:13] info: [DocumentationRoutes] Getting documentation analytics for timeframe: 30d
[2025-12-12 06:13:13] info: [ApiDocService] OpenAPI specification validation passed
[2025-12-12 06:13:13] info: [POST] /api/auth/logout - 200
[2025-12-12 06:13:13] info: [GET] /api/horses/1%20AND%20(SELECT%20COUNT(*)%20FROM%20users)%20%3E%200
[2025-12-12 06:13:13] info: [auth] Authenticated user ed928871-2522-4eb6-88bd-6142656e54a0 for GET /horses/1%20AND%20(SELECT%20COUNT(*)%20FROM%20users)%20%3E%200
[2025-12-12 06:13:13] info: [GET] /api/horses/1%20AND%20(SELECT%20COUNT(*)%20FROM%20users)%20%3E%200 - 400
[2025-12-12 06:13:13] info: [GET] /auth/verification-status
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for GET /analytics
[2025-12-12 06:13:13] info: [DocumentationRoutes] Getting documentation analytics for timeframe: 1d
[2025-12-12 06:13:13] info: [auth] Authenticated user 434d51c0-9ddf-484a-a244-2c7faa62eae0 for GET /verification-status
[2025-12-12 06:13:13] info: [POST] /api/auth/login
[2025-12-12 06:13:13] error: [authController.getVerificationStatus] Error checking status: User not found
[2025-12-12 06:13:13] error: [GET] /auth/verification-status - ERROR
[2025-12-12 06:13:13] error: Error User not found
[2025-12-12 06:13:13] info: [GET] /auth/verification-status - 404
[2025-12-12 06:13:13] info: [ApiDocService] OpenAPI specification validation passed
[2025-12-12 06:13:13] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for GET /analytics
[2025-12-12 06:13:13] info: [DocumentationRoutes] Getting documentation analytics for timeframe: 7d
[2025-12-12 06:13:13] info: [ApiDocService] OpenAPI specification validation passed
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for GET /analytics
[2025-12-12 06:13:13] info: [DocumentationRoutes] Getting documentation analytics for timeframe: 30d
[2025-12-12 06:13:13] info: [GET] /api/horses/0x31
[2025-12-12 06:13:13] info: [ApiDocService] OpenAPI specification validation passed
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:13] info: [auth] Authenticated user 5ad036e1-123f-4d13-98b6-e9547a3f6e0c for GET /horses/0x31
[2025-12-12 06:13:13] info: [GET] /api/horses/0x31 - 400
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for GET /analytics
[2025-12-12 06:13:13] warn: [auth] Invalid or expired token for GET /health from ::ffff:127.0.0.1
[2025-12-12 06:13:13] warn: [auth] Access token is required for GET /health from ::ffff:127.0.0.1
FAIL __tests__/integration/token-rotation.test.mjs (11.861 s)
  Token Rotation and Reuse Detection System
    Basic Token Rotation
      ‚àö should_rotate_refresh_token_on_each_use (572 ms)
      ‚àö should_invalidate_old_refresh_token_after_rotation (616 ms)
      ‚àö should_track_token_families_in_database (376 ms)
    Token Reuse Detection
      ‚àö should_detect_refresh_token_reuse (755 ms)
      ‚àö should_invalidate_entire_token_family_on_reuse_detection (232 ms)
      ‚àö should_require_reauthentication_after_family_invalidation (490 ms)
    Concurrent Token Usage
      √ó should_handle_concurrent_refresh_requests_gracefully (982 ms)
      √ó should_prevent_race_conditions_in_token_rotation (160 ms)
    Token Compromise Scenarios
      ‚àö should_handle_legitimate_user_concurrent_with_attacker (332 ms)
      ‚àö should_log_security_events_for_monitoring (147 ms)
    Token Expiration and Cleanup
      √ó should_reject_expired_refresh_tokens (155 ms)
      ‚àö should_clean_up_invalidated_token_families (265 ms)
    Database Constraints and Security
      ‚àö should_enforce_unique_constraints_on_token_families (149 ms)
      ‚àö should_validate_token_structure_and_signatures (633 ms)

  ‚óè Token Rotation and Reuse Detection System ‚Ä∫ Concurrent Token Usage ‚Ä∫ should_handle_concurrent_refresh_requests_gracefully

    expect(received).toMatch(expected)

    Expected pattern: /already used|invalid/i
    Received string:  "Token reuse detected - please login again"

    [0m [90m 375 |[39m       [90m// All failures should indicate token was already used[39m
     [90m 376 |[39m       failureResponses[33m.[39mforEach(response [33m=>[39m {
    [31m[1m>[22m[39m[90m 377 |[39m         expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoMatch([35m/already used|invalid/i[39m)[33m;[39m
     [90m     |[39m                                       [31m[1m^[22m[39m
     [90m 378 |[39m       })[33m;[39m
     [90m 379 |[39m     })[33m;[39m
     [90m 380 |[39m[0m

      at __tests__/integration/token-rotation.test.mjs:377:39
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (__tests__/integration/token-rotation.test.mjs:376:24)

  ‚óè Token Rotation and Reuse Detection System ‚Ä∫ Concurrent Token Usage ‚Ä∫ should_prevent_race_conditions_in_token_rotation

    expect(received).toBeGreaterThanOrEqual(expected)

    Expected: >= 1
    Received:    0

    [0m [90m 407 |[39m       [90m// Verify at least one succeeded (implementation allows multiple)[39m
     [90m 408 |[39m       [36mconst[39m successCount [33m=[39m statuses[33m.[39mfilter(s [33m=>[39m s [33m===[39m [35m200[39m)[33m.[39mlength[33m;[39m
    [31m[1m>[22m[39m[90m 409 |[39m       expect(successCount)[33m.[39mtoBeGreaterThanOrEqual([35m1[39m)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 410 |[39m     })[33m;[39m
     [90m 411 |[39m   })[33m;[39m
     [90m 412 |[39m[0m

      at Object.<anonymous> (__tests__/integration/token-rotation.test.mjs:409:28)

  ‚óè Token Rotation and Reuse Detection System ‚Ä∫ Token Expiration and Cleanup ‚Ä∫ should_reject_expired_refresh_tokens

    expect(received).toMatch(expected)

    Expected pattern: /expired|invalid/i
    Received string:  "Token reuse detected - please login again"

    [0m [90m 523 |[39m       expect([[35m401[39m[33m,[39m [35m403[39m])[33m.[39mtoContain(expiredResponse[33m.[39mstatus)[33m;[39m
     [90m 524 |[39m       [36mif[39m (expiredResponse[33m.[39mbody[33m?[39m[33m.[39mmessage) {
    [31m[1m>[22m[39m[90m 525 |[39m         expect(expiredResponse[33m.[39mbody[33m.[39mmessage)[33m.[39mtoMatch([35m/expired|invalid/i[39m)[33m;[39m
     [90m     |[39m                                              [31m[1m^[22m[39m
     [90m 526 |[39m       }
     [90m 527 |[39m     })[33m;[39m
     [90m 528 |[39m[0m

      at Object.<anonymous> (__tests__/integration/token-rotation.test.mjs:525:46)

[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for POST /endpoints
[2025-12-12 06:13:13] info: [DocumentationRoutes] Registering endpoint: GET /api/users
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for POST /endpoints
[2025-12-12 06:13:13] info: [DocumentationRoutes] Registering endpoint: POST /api/users
[2025-12-12 06:13:13] warn: [Session] Session expired due to inactivity
[2025-12-12 06:13:13] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:13] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:13] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for POST /endpoints
[2025-12-12 06:13:13] info: [DocumentationRoutes] Registering endpoint: GET /api/horses
[2025-12-12 06:13:13] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:13] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:13] error: [POST] /auth/register - ERROR
[2025-12-12 06:13:13] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:13] info: [POST] /auth/register - 500
[2025-12-12 06:13:13] info: [POST] /api/auth/logout
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for GET /metrics
[2025-12-12 06:13:13] info: [DocumentationRoutes] Getting documentation metrics
[2025-12-12 06:13:13] info: [GET] /auth/verification-status
[2025-12-12 06:13:13] info: [auth] Authenticated user 92cd1d6c-2075-4e65-8603-56c872a8608c for GET /verification-status
[2025-12-12 06:13:13] info: [POST] /auth/login
[2025-12-12 06:13:13] info: [EmailVerification] Verification status check
[2025-12-12 06:13:13] info: [GET] /auth/verification-status - 200
[2025-12-12 06:13:13] error: [Session] Error tracking session activity: 
Invalid `prisma.refreshToken.delete()` invocation:


An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.
[2025-12-12 06:13:13] info: [GET] /api/horses/1'%20AND%20(SELECT%201/0)
[2025-12-12 06:13:13] info: [auth] Authenticated user 53ea3c25-a6a6-4a09-82cb-3a3b2285e631 for GET /horses/1'%20AND%20(SELECT%201/0)
[2025-12-12 06:13:13] warn: 404 - Route not found: GET /api/horses/1'%20AND%20(SELECT%201/0) from ::ffff:127.0.0.1
[2025-12-12 06:13:13] info: [GET] /api/horses/1'%20AND%20(SELECT%201/0) - 404
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for POST /schemas
[2025-12-12 06:13:13] info: [DocumentationRoutes] Registering schema: User
[2025-12-12 06:13:13] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for POST /schemas
[2025-12-12 06:13:13] info: [DocumentationRoutes] Registering schema: Horse
[2025-12-12 06:13:13] info: [auth] Authenticated user e8006d77-4667-43f4-9382-5878bd5bb5b4 for POST /generate
[2025-12-12 06:13:13] info: [DocumentationRoutes] Generating API documentation
[2025-12-12 06:13:13] info: [ApiDocService] OpenAPI specification saved successfully
[2025-12-12 06:13:13] info: [ApiDocService] Documentation generated for 0 endpoints
[2025-12-12 06:13:13] info: [GET] /api/horses/1%20UNION%20SELECT%20id,email,password,NULL,NULL,NULL%20FROM%20users
[2025-12-12 06:13:13] info: [auth] Authenticated user ffb9dbea-e5c7-4685-acdd-6cb62921a42d for GET /horses/1%20UNION%20SELECT%20id,email,password,NULL,NULL,NULL%20FROM%20users
[2025-12-12 06:13:13] info: [GET] /api/horses/1%20UNION%20SELECT%20id,email,password,NULL,NULL,NULL%20FROM%20users - 400
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:13] error: [Session] Error tracking session activity: Database connection error
[2025-12-12 06:13:13] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:13] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:13] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:13] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:13] error: [POST] /auth/register - ERROR
[2025-12-12 06:13:13] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:13] info: [POST] /auth/register - 500
[2025-12-12 06:13:13] info: [POST] /api/auth/logout - 200
[2025-12-12 06:13:13] info: [POST] /auth/register
[2025-12-12 06:13:13] info: [POST] /api/auth/register
[2025-12-12 06:13:13] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:13] info: [POST] /auth/login - 200
[2025-12-12 06:13:13] info: [GET] /auth/verification-status
[2025-12-12 06:13:13] warn: [auth] Access token is required for GET /verification-status from ::ffff:127.0.0.1
[2025-12-12 06:13:13] info: [POST] /auth/refresh-token
[2025-12-12 06:13:13] info: [GET] /auth/verification-status - 401
[2025-12-12 06:13:13] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:13] info: [GET] /api/horses?name=Test%27;%20DROP%20TABLE%20horses;%20--
[2025-12-12 06:13:13] info: [auth] Authenticated user a3d790dc-93fa-4855-b60b-85076b12a1ab for GET /horses
[2025-12-12 06:13:13] info: [GET] /api/horses?name=Test%27;%20DROP%20TABLE%20horses;%20-- - 200
FAIL __tests__/routes/documentationRoutes.test.mjs


  ‚óè Test suite failed to run

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 63 |[39m   afterAll([36masync[39m () [33m=>[39m {
     [90m 64 |[39m     [90m// Cleanup test data[39m
    [31m[1m>[22m[39m[90m 65 |[39m     [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 66 |[39m       where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 67 |[39m     })[33m;[39m
     [90m 68 |[39m   })[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/routes/documentationRoutes.test.mjs:65:5)

[2025-12-12 06:13:13] info: [GET] /api/horses?sort=name;%20UPDATE%20horses%20SET%20name=%27Hacked%27
[2025-12-12 06:13:13] info: [auth] Authenticated user 32844271-1696-4e0e-8950-7df05cefddfa for GET /horses
[2025-12-12 06:13:13] info: [GET] /api/horses?sort=name;%20UPDATE%20horses%20SET%20name=%27Hacked%27 - 200
[2025-12-12 06:13:13] info: [GET] /api/horses?name=%%27%20OR%20%271%27=%271
[2025-12-12 06:13:13] info: [auth] Authenticated user 4328be27-888e-4f38-b8e5-620226b8b9a7 for GET /horses
[2025-12-12 06:13:13] info: [GET] /api/horses?name=%%27%20OR%20%271%27=%271 - 200
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:13] info: [GET] /auth/verification-status
[2025-12-12 06:13:13] info: [auth] Authenticated user ebea5b54-250b-428f-8946-c6815a19e9fc for GET /verification-status
[2025-12-12 06:13:13] error: [authController.getVerificationStatus] Error checking status: User not found
[2025-12-12 06:13:13] error: [GET] /auth/verification-status - ERROR
[2025-12-12 06:13:13] error: Error User not found
[2025-12-12 06:13:13] info: [GET] /auth/verification-status - 404
[2025-12-12 06:13:13] error: [Session] Error enforcing concurrent sessions: Database query failed
[2025-12-12 06:13:13] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:13] info: [POST] /auth/refresh-token - 200
[2025-12-12 06:13:13] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:13] info: [POST] /auth/register
[2025-12-12 06:13:14] info: [POST] /auth/register
[2025-12-12 06:13:14] info: [POST] /api/horses
[2025-12-12 06:13:14] info: [auth] Authenticated user bf99aab2-4edf-4c97-861c-3e5a227021b8 for POST /horses
[2025-12-12 06:13:14] info: [POST] /api/horses - 403
[2025-12-12 06:13:14] error: [Session] Error fetching active sessions: Database connection lost
[2025-12-12 06:13:14] error: [Session] Error revoking session: 
Invalid `prisma.refreshToken.deleteMany()` invocation:

{
  where: {
    userId: "invalid-user",
+   id: {
+     equals: Int | IntFieldRefInput,
+     in: Int[] | ListIntFieldRefInput,
+     notIn: Int[] | ListIntFieldRefInput,
+     lt: Int | IntFieldRefInput,
+     lte: Int | IntFieldRefInput,
+     gt: Int | IntFieldRefInput,
+     gte: Int | IntFieldRefInput,
+     not: Int | NestedIntFilter
+   }
  }
}

Argument `id` is missing.
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:14] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:14] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:14] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:14] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:14] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:14] error: [POST] /auth/register - ERROR
[2025-12-12 06:13:14] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:14] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:14] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:14] error: [POST] /api/auth/register - ERROR
[2025-12-12 06:13:14] info: [POST] /auth/register - 500
[2025-12-12 06:13:14] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:14] info: [POST] /api/auth/register - 500
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for GET /metrics
[2025-12-12 06:13:14] info: [GET] /api/horses/1;%20SELECT%20lo_create(1234)
[2025-12-12 06:13:14] info: [POST] /auth/register
[2025-12-12 06:13:14] info: [auth] Authenticated user 71fbfd0b-4c09-43ad-be17-bdf207c5da1d for GET /horses/1;%20SELECT%20lo_create(1234)
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] info: [GET] /api/horses/1;%20SELECT%20lo_create(1234) - 400
[2025-12-12 06:13:14] warn: [auth] Access token is required for GET /metrics from ::ffff:127.0.0.1
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for GET /performance
[2025-12-12 06:13:14] info: [ApiOptimization] Getting performance metrics for timeframe: 24h
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for GET /performance
[2025-12-12 06:13:14] info: [ApiOptimization] Getting performance metrics for timeframe: 1h
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for GET /performance
[2025-12-12 06:13:14] info: [ApiOptimization] Getting performance metrics for timeframe: 24h
[2025-12-12 06:13:14] info: [GET] /api/horses/invalid-sql-injection
[2025-12-12 06:13:14] info: [auth] Authenticated user 8791f5d2-62bd-4ebe-940d-101f0a0f037c for GET /horses/invalid-sql-injection
[2025-12-12 06:13:14] info: [GET] /api/horses/invalid-sql-injection - 400
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for GET /performance
[2025-12-12 06:13:14] info: [ApiOptimization] Getting performance metrics for timeframe: 7d
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for GET /performance
[2025-12-12 06:13:14] info: [ApiOptimization] Getting performance metrics for timeframe: 30d
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for GET /performance
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for GET /compression-stats
[2025-12-12 06:13:14] info: [ApiOptimization] Getting compression statistics
[2025-12-12 06:13:14] info: [GET] /api/horses/64220
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for GET /cache-analytics
[2025-12-12 06:13:14] info: [ApiOptimization] Getting cache analytics
[2025-12-12 06:13:14] info: [auth] Authenticated user 39059bcd-7952-497f-9557-183fb38ba85b for GET /horses/64220
[2025-12-12 06:13:14] warn: [ownership] horse 64220 not found or not owned by user 39059bcd-7952-497f-9557-183fb38ba85b
[2025-12-12 06:13:14] info: [GET] /api/horses/64220 - 404
[2025-12-12 06:13:14] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] info: [POST] /api/horses
[2025-12-12 06:13:14] info: [auth] Authenticated user 14b1ffb3-1368-4296-8717-a7b33a9e438e for POST /horses
[2025-12-12 06:13:14] info: [POST] /api/horses - 403
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for POST /test-compression
[2025-12-12 06:13:14] info: [ApiOptimization] Testing compression with algorithm: gzip
FAIL __tests__/middleware/sessionManagement.test.mjs
  Session Management Middleware
    trackSessionActivity()
      ‚àö should skip tracking for unauthenticated requests (9 ms)
      ‚àö should skip tracking when no user ID (7 ms)
      ‚àö should skip tracking when no refresh token cookie (21 ms)
      Active session tracking
        √ó should update lastActivityAt for valid session (23 ms)
        √ó should allow session within timeout window (14 minutes) (19 ms)
        √ó should expire session after 15 minutes of inactivity (10 ms)
        √ó should clear cookies when session expires (43 ms)
        ‚àö should use createdAt if lastActivityAt is null (12 ms)
        ‚àö should handle database errors gracefully (34 ms)
        ‚àö should catch and log Prisma errors during activity tracking (16 ms)
      Custom timeout configuration
        ‚àö should respect custom SESSION_TIMEOUT_MS (10 ms)
    enforceConcurrentSessions()
      ‚àö should skip enforcement for unauthenticated requests (4 ms)
      √ó should allow user with 1 session (9 ms)
      √ó should allow user with exactly MAX_CONCURRENT_SESSIONS (5) (13 ms)
      √ó should delete oldest session when limit exceeded (6 sessions) (42 ms)
      √ó should delete multiple oldest sessions when far over limit (10 sessions) (30 ms)
      √ó should keep most recent sessions (82 ms)
      ‚àö should handle database errors gracefully (25 ms)
      ‚àö should catch and log Prisma errors during session enforcement (16 ms)
      Custom limit configuration
        √ó should respect custom MAX_CONCURRENT_SESSIONS (21 ms)
    addSessionSecurityHeaders()
      ‚àö should add cache control headers (14 ms)
      ‚àö should add pragma header (3 ms)
      ‚àö should add expires header (6 ms)
      ‚àö should call next() to continue middleware chain (17 ms)
    getActiveSessions()
      ‚àö should return 401 for unauthenticated requests (9 ms)
      √ó should return empty array for user with no sessions (5 ms)
      √ó should return all active sessions for user (34 ms)
      ‚àö should NOT expose token values in response (51 ms)
      ‚àö should handle database errors (9 ms)
    revokeSession()
      ‚àö should return 401 for unauthenticated requests (6 ms)
      ‚àö should return 400 when sessionId missing (9 ms)
      √ó should successfully revoke own session (38 ms)
      ‚àö should return 404 when session not found (10 ms)
      √ó should NOT allow revoking another user's session (11 ms)
      ‚àö should handle database errors (25 ms)

  ‚óè Session Management Middleware ‚Ä∫ trackSessionActivity() ‚Ä∫ Active session tracking ‚Ä∫ should update lastActivityAt for valid session

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 67 |[39m       beforeEach([36masync[39m () [33m=>[39m {
     [90m 68 |[39m         user [33m=[39m [36mawait[39m createTestUser()[33m;[39m
    [31m[1m>[22m[39m[90m 69 |[39m         token [33m=[39m [36mawait[39m createTestRefreshToken(user[33m.[39mid[33m,[39m {
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 70 |[39m           lastActivityAt[33m:[39m [36mnew[39m [33mDate[39m([33mDate[39m[33m.[39mnow() [33m-[39m [35m5[39m [33m*[39m [35m60[39m [33m*[39m [35m1000[39m)[33m,[39m [90m// 5 minutes ago[39m
     [90m 71 |[39m         })[33m;[39m
     [90m 72 |[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:69:17)

  ‚óè Session Management Middleware ‚Ä∫ trackSessionActivity() ‚Ä∫ Active session tracking ‚Ä∫ should allow session within timeout window (14 minutes)

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.update()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for an update.

    [0m [90m 91 |[39m       it([32m'should allow session within timeout window (14 minutes)'[39m[33m,[39m [36masync[39m () [33m=>[39m {
     [90m 92 |[39m         [90m// Update to 14 minutes ago (still within 15 min window)[39m
    [31m[1m>[22m[39m[90m 93 |[39m         [36mawait[39m prisma[33m.[39mrefreshToken[33m.[39mupdate({
     [90m    |[39m         [31m[1m^[22m[39m
     [90m 94 |[39m           where[33m:[39m { id[33m:[39m token[33m.[39mid }[33m,[39m
     [90m 95 |[39m           data[33m:[39m { lastActivityAt[33m:[39m [36mnew[39m [33mDate[39m([33mDate[39m[33m.[39mnow() [33m-[39m [35m14[39m [33m*[39m [35m60[39m [33m*[39m [35m1000[39m) }[33m,[39m
     [90m 96 |[39m         })[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:93:9)

  ‚óè Session Management Middleware ‚Ä∫ trackSessionActivity() ‚Ä∫ Active session tracking ‚Ä∫ should expire session after 15 minutes of inactivity

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 67 |[39m       beforeEach([36masync[39m () [33m=>[39m {
     [90m 68 |[39m         user [33m=[39m [36mawait[39m createTestUser()[33m;[39m
    [31m[1m>[22m[39m[90m 69 |[39m         token [33m=[39m [36mawait[39m createTestRefreshToken(user[33m.[39mid[33m,[39m {
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 70 |[39m           lastActivityAt[33m:[39m [36mnew[39m [33mDate[39m([33mDate[39m[33m.[39mnow() [33m-[39m [35m5[39m [33m*[39m [35m60[39m [33m*[39m [35m1000[39m)[33m,[39m [90m// 5 minutes ago[39m
     [90m 71 |[39m         })[33m;[39m
     [90m 72 |[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:69:17)

  ‚óè Session Management Middleware ‚Ä∫ trackSessionActivity() ‚Ä∫ Active session tracking ‚Ä∫ should clear cookies when session expires

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "accessToken"

    Number of calls: 0

    [0m [90m 134 |[39m         [36mawait[39m trackSessionActivity(req[33m,[39m res[33m,[39m next)[33m;[39m
     [90m 135 |[39m
    [31m[1m>[22m[39m[90m 136 |[39m         expect(res[33m.[39mclearCookie)[33m.[39mtoHaveBeenCalledWith([32m'accessToken'[39m)[33m;[39m
     [90m     |[39m                                 [31m[1m^[22m[39m
     [90m 137 |[39m         expect(res[33m.[39mclearCookie)[33m.[39mtoHaveBeenCalledWith([32m'refreshToken'[39m)[33m;[39m
     [90m 138 |[39m       })[33m;[39m
     [90m 139 |[39m[0m

      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:136:33)

  ‚óè Session Management Middleware ‚Ä∫ enforceConcurrentSessions() ‚Ä∫ should allow user with 1 session

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 230 |[39m     it([32m'should allow user with 1 session'[39m[33m,[39m [36masync[39m () [33m=>[39m {
     [90m 231 |[39m       [36mconst[39m user [33m=[39m [36mawait[39m createTestUser()[33m;[39m
    [31m[1m>[22m[39m[90m 232 |[39m       [36mawait[39m createTestRefreshToken(user[33m.[39mid)[33m;[39m
     [90m     |[39m       [31m[1m^[22m[39m
     [90m 233 |[39m
     [90m 234 |[39m       req[33m.[39muser [33m=[39m { id[33m:[39m user[33m.[39mid }[33m;[39m
     [90m 235 |[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:232:7)

  ‚óè Session Management Middleware ‚Ä∫ enforceConcurrentSessions() ‚Ä∫ should allow user with exactly MAX_CONCURRENT_SESSIONS (5)

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 249 |[39m       [90m// Create exactly 5 sessions[39m
     [90m 250 |[39m       [36mfor[39m ([36mlet[39m i [33m=[39m [35m0[39m[33m;[39m i [33m<[39m [35m5[39m[33m;[39m i[33m++[39m) {
    [31m[1m>[22m[39m[90m 251 |[39m         [36mawait[39m createTestRefreshToken(user[33m.[39mid)[33m;[39m
     [90m     |[39m         [31m[1m^[22m[39m
     [90m 252 |[39m       }
     [90m 253 |[39m
     [90m 254 |[39m       req[33m.[39muser [33m=[39m { id[33m:[39m user[33m.[39mid }[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:251:9)

  ‚óè Session Management Middleware ‚Ä∫ enforceConcurrentSessions() ‚Ä∫ should delete oldest session when limit exceeded (6 sessions)

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 270 |[39m       [36mconst[39m sessions [33m=[39m [][33m;[39m
     [90m 271 |[39m       [36mfor[39m ([36mlet[39m i [33m=[39m [35m0[39m[33m;[39m i [33m<[39m [35m6[39m[33m;[39m i[33m++[39m) {
    [31m[1m>[22m[39m[90m 272 |[39m         [36mconst[39m session [33m=[39m [36mawait[39m createTestRefreshToken(user[33m.[39mid)[33m;[39m
     [90m     |[39m                         [31m[1m^[22m[39m
     [90m 273 |[39m         sessions[33m.[39mpush(session)[33m;[39m
     [90m 274 |[39m
     [90m 275 |[39m         [90m// Wait 10ms between each to ensure different createdAt[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:272:25)

  ‚óè Session Management Middleware ‚Ä∫ enforceConcurrentSessions() ‚Ä∫ should delete multiple oldest sessions when far over limit (10 sessions)

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 303 |[39m       [90m// Create 10 sessions[39m
     [90m 304 |[39m       [36mfor[39m ([36mlet[39m i [33m=[39m [35m0[39m[33m;[39m i [33m<[39m [35m10[39m[33m;[39m i[33m++[39m) {
    [31m[1m>[22m[39m[90m 305 |[39m         [36mawait[39m createTestRefreshToken(user[33m.[39mid)[33m;[39m
     [90m     |[39m         [31m[1m^[22m[39m
     [90m 306 |[39m         [36mawait[39m [36mnew[39m [33mPromise[39m((resolve) [33m=>[39m setTimeout(resolve[33m,[39m [35m10[39m))[33m;[39m
     [90m 307 |[39m       }
     [90m 308 |[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:305:9)

  ‚óè Session Management Middleware ‚Ä∫ enforceConcurrentSessions() ‚Ä∫ should keep most recent sessions

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 324 |[39m       [36mconst[39m sessions [33m=[39m [][33m;[39m
     [90m 325 |[39m       [36mfor[39m ([36mlet[39m i [33m=[39m [35m0[39m[33m;[39m i [33m<[39m [35m7[39m[33m;[39m i[33m++[39m) {
    [31m[1m>[22m[39m[90m 326 |[39m         [36mconst[39m session [33m=[39m [36mawait[39m createTestRefreshToken(user[33m.[39mid)[33m;[39m
     [90m     |[39m                         [31m[1m^[22m[39m
     [90m 327 |[39m         sessions[33m.[39mpush(session)[33m;[39m
     [90m 328 |[39m         [36mawait[39m [36mnew[39m [33mPromise[39m((resolve) [33m=>[39m setTimeout(resolve[33m,[39m [35m10[39m))[33m;[39m
     [90m 329 |[39m       }[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:326:25)

  ‚óè Session Management Middleware ‚Ä∫ enforceConcurrentSessions() ‚Ä∫ Custom limit configuration ‚Ä∫ should respect custom MAX_CONCURRENT_SESSIONS

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 392 |[39m         [90m// Create 5 sessions[39m
     [90m 393 |[39m         [36mfor[39m ([36mlet[39m i [33m=[39m [35m0[39m[33m;[39m i [33m<[39m [35m5[39m[33m;[39m i[33m++[39m) {
    [31m[1m>[22m[39m[90m 394 |[39m           [36mawait[39m createTestRefreshToken(user[33m.[39mid)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 395 |[39m           [36mawait[39m [36mnew[39m [33mPromise[39m((resolve) [33m=>[39m setTimeout(resolve[33m,[39m [35m10[39m))[33m;[39m
     [90m 396 |[39m         }
     [90m 397 |[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:394:11)

  ‚óè Session Management Middleware ‚Ä∫ getActiveSessions() ‚Ä∫ should return empty array for user with no sessions

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.create()` invocation:


    Unique constraint failed on the fields: (`email`)

    [0m [90m 467 |[39m
     [90m 468 |[39m     it([32m'should return empty array for user with no sessions'[39m[33m,[39m [36masync[39m () [33m=>[39m {
    [31m[1m>[22m[39m[90m 469 |[39m       [36mconst[39m user [33m=[39m [36mawait[39m createTestUser()[33m;[39m
     [90m     |[39m                    [31m[1m^[22m[39m
     [90m 470 |[39m       req[33m.[39muser [33m=[39m { id[33m:[39m user[33m.[39mid }[33m;[39m
     [90m 471 |[39m
     [90m 472 |[39m       [36mawait[39m getActiveSessions(req[33m,[39m res[33m,[39m next)[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:469:20)

  ‚óè Session Management Middleware ‚Ä∫ getActiveSessions() ‚Ä∫ should return all active sessions for user

    expect(received).toHaveLength(expected)

    Expected length: 2
    Received length: 0
    Received array:  []

    [0m [90m 496 |[39m       [36mconst[39m responseData [33m=[39m res[33m.[39mjson[33m.[39mmock[33m.[39mcalls[[35m0[39m][[35m0[39m][33m;[39m
     [90m 497 |[39m       expect(responseData[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 498 |[39m       expect(responseData[33m.[39mdata[33m.[39msessions)[33m.[39mtoHaveLength([35m2[39m)[33m;[39m
     [90m     |[39m                                          [31m[1m^[22m[39m
     [90m 499 |[39m       expect(responseData[33m.[39mdata[33m.[39mmaxConcurrent)[33m.[39mtoBe([35m5[39m)[33m;[39m
     [90m 500 |[39m       expect(responseData[33m.[39mdata[33m.[39msessionTimeout)[33m.[39mtoBe([35m900000[39m)[33m;[39m
     [90m 501 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:498:42)

  ‚óè Session Management Middleware ‚Ä∫ revokeSession() ‚Ä∫ should successfully revoke own session

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 564 |[39m     it([32m'should successfully revoke own session'[39m[33m,[39m [36masync[39m () [33m=>[39m {
     [90m 565 |[39m       [36mconst[39m user [33m=[39m [36mawait[39m createTestUser()[33m;[39m
    [31m[1m>[22m[39m[90m 566 |[39m       [36mconst[39m token [33m=[39m [36mawait[39m createTestRefreshToken(user[33m.[39mid)[33m;[39m
     [90m     |[39m                     [31m[1m^[22m[39m
     [90m 567 |[39m
     [90m 568 |[39m       req[33m.[39muser [33m=[39m { id[33m:[39m user[33m.[39mid }[33m;[39m
     [90m 569 |[39m       req[33m.[39mparams [33m=[39m { sessionId[33m:[39m token[33m.[39mid[33m.[39mtoString() }[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:566:21)

  ‚óè Session Management Middleware ‚Ä∫ revokeSession() ‚Ä∫ should NOT allow revoking another user's session

    expect(received).not.toBeNull()

    Received: null

    [0m [90m 614 |[39m         where[33m:[39m { id[33m:[39m user2Token[33m.[39mid }[33m,[39m
     [90m 615 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 616 |[39m       expect(user2Session)[33m.[39mnot[33m.[39mtoBeNull()[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 617 |[39m     })[33m;[39m
     [90m 618 |[39m
     [90m 619 |[39m     it([32m'should handle database errors'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:616:32)

[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for POST /test-compression
[2025-12-12 06:13:14] warn: [ResourceManagement] Slow request detected: GET /test-slow took 11ms
[2025-12-12 06:13:14] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:14] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:14] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:14] warn: [MemoryMonitoring] Memory threshold exceeded: 62MB
[2025-12-12 06:13:14] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:14] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:14] error: [POST] /auth/register - ERROR
[2025-12-12 06:13:14] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:14] info: [POST] /auth/register - 500
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for POST /test-compression
[2025-12-12 06:13:14] info: [ApiOptimization] Testing compression with algorithm: gzip
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for POST /test-compression
[2025-12-12 06:13:14] info: [ApiOptimization] Testing compression with algorithm: brotli
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for POST /test-compression
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] info: [ApiOptimization] Testing compression with algorithm: deflate
[2025-12-12 06:13:14] info: [POST] /auth/login
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] warn: [DatabaseMonitoring] High query count: 15 queries in 1ms for GET /test-many-queries
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for POST /test-pagination
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] info: [ApiOptimization] Testing offset pagination with 100 items
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for POST /test-pagination
[2025-12-12 06:13:14] info: [ApiOptimization] Testing cursor pagination with 100 items
[2025-12-12 06:13:14] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:14] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:14] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:14] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 200
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for POST /test-pagination
[2025-12-12 06:13:14] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for POST /test-pagination
[2025-12-12 06:13:14] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:14] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:14] error: [POST] /auth/register - ERROR
[2025-12-12 06:13:14] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:14] info: [POST] /auth/register - 500
[2025-12-12 06:13:14] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for POST /test-pagination
[2025-12-12 06:13:14] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for GET /recommendations
[2025-12-12 06:13:14] info: [ApiOptimization] Generating optimization recommendations
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] info: [rateLimiting] Using in-memory rate limiting for test/disabled Redis environment
[2025-12-12 06:13:14] warn: [auth] Invalid or expired token for GET /metrics from ::ffff:127.0.0.1
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] warn: [auth] Access token is required for GET /metrics from ::ffff:127.0.0.1
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for POST /test-compression
[2025-12-12 06:13:14] info: [ApiOptimization] Testing compression with algorithm: gzip
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] info: [auth] Authenticated user 50bba9bc-797b-4f60-aa47-e105a955aa36 for POST /test-pagination
[2025-12-12 06:13:14] info: [ApiOptimization] Testing offset pagination with 1000 items
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] info: [POST] /auth/login - 200
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] info: [POST] /auth/refresh-token
[2025-12-12 06:13:14] info: [POST] /api/auth/login
[2025-12-12 06:13:14] warn: [RateLimit] Limit exceeded
[2025-12-12 06:13:14] info: [POST] /api/auth/login - 429
[2025-12-12 06:13:14] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:14] info: [GET] /api/auth/profile
[2025-12-12 06:13:14] info: [GET] /auth/verification-status
[2025-12-12 06:13:14] info: [auth] Authenticated user cf8e8090-08f3-4350-a220-0e33da9ee466 for GET /verification-status
[2025-12-12 06:13:14] info: [EmailVerification] Verification status check
[2025-12-12 06:13:14] info: [GET] /auth/verification-status - 200
[2025-12-12 06:13:14] info: [POST] /auth/resend-verification
[2025-12-12 06:13:14] info: [auth] Authenticated user cf8e8090-08f3-4350-a220-0e33da9ee466 for POST /resend-verification
[2025-12-12 06:13:14] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:14] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:14] error: [EmailVerification] Error resending verification email: User not found
[2025-12-12 06:13:14] error: [authController.resendVerification] Error resending verification: User not found
[2025-12-12 06:13:14] error: [POST] /auth/resend-verification - ERROR
[2025-12-12 06:13:14] error: Error User not found
[2025-12-12 06:13:14] info: [POST] /auth/resend-verification - 404
[2025-12-12 06:13:14] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:14] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:14] error: [POST] /auth/register - ERROR
[2025-12-12 06:13:14] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:14] info: [POST] /auth/register - 500
[2025-12-12 06:13:14] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:14] info: [POST] /auth/register
[2025-12-12 06:13:14] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:14] info: [POST] /auth/refresh-token - 200
[2025-12-12 06:13:14] info: [POST] /auth/register
[2025-12-12 06:13:14] warn: [ResourceManagement] Request timeout: GET /test-timeout
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:14] error: [ResponseOptimization] Response size exceeds limit: 12715 bytes for GET /test/oversized
[2025-12-12 06:13:14] error: [authController.getProfile] Error retrieving profile: User not found
[2025-12-12 06:13:14] error: [GET] /api/auth/profile - ERROR
[2025-12-12 06:13:14] error: Error User not found
FAIL __tests__/routes/apiOptimizationRoutes.test.mjs


  ‚óè Test suite failed to run

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 58 |[39m   afterAll([36masync[39m () [33m=>[39m {
     [90m 59 |[39m     [90m// Cleanup test data[39m
    [31m[1m>[22m[39m[90m 60 |[39m     [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 61 |[39m       where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 62 |[39m     })[33m;[39m
     [90m 63 |[39m   })[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/routes/apiOptimizationRoutes.test.mjs:60:5)

[2025-12-12 06:13:14] info: [GET] /api/auth/profile - 404
FAIL __tests__/integration/security/sql-injection-attempts.test.mjs
  SQL Injection Attempts Integration Tests
    Classic SQL Injection in ID Parameters
      √ó should reject SQL injection in horse ID (50 ms)
      ‚àö should reject SQL injection with comment syntax (72 ms)
      ‚àö should reject SQL injection with union select (45 ms)
      ‚àö should reject SQL injection with nested queries (43 ms)
      ‚àö should reject SQL injection with hex encoding (67 ms)
    Blind SQL Injection Attempts
      √ó should reject boolean-based blind injection (28 ms)
      √ó should reject time-based blind injection (33 ms)
      √ó should reject PostgreSQL-specific time injection (25 ms)
      ‚àö should reject error-based blind injection (43 ms)
    Union-Based SQL Injection
      ‚àö should reject UNION SELECT attacks (48 ms)
      √ó should reject UNION ALL attacks (10 ms)
      √ó should reject UNION with ORDER BY column enumeration (11 ms)
      √ó should reject UNION with NULL padding (12 ms)
    Stacked Queries
      √ó should reject semicolon-separated queries (11 ms)
      √ó should reject multiple statements in ownership check (16 ms)
      √ó should reject batch operations via stacking (20 ms)
    SQL Injection in Search/Filter Parameters
      √ó should reject SQL injection in breed filter (16 ms)
      ‚àö should reject SQL injection in name search (45 ms)
      ‚àö should reject SQL injection in sort parameter (29 ms)
      ‚àö should reject SQL injection in LIKE wildcards (54 ms)
      √ó should reject SQL injection in IN clause (20 ms)
    SQL Injection in JSON/JSONB Queries
      √ó should reject SQL injection in JSONB path (23 ms)
      √ó should reject SQL injection in JSON operators (31 ms)
      √ó should reject SQL injection in JSON array queries (30 ms)
    Second-Order SQL Injection
      ‚àö should sanitize stored data used in subsequent queries (61 ms)
      √ó should prevent injection via profile data used in ownership checks (20 ms)
    ORM Bypass Attempts (Prisma)
      √ó should reject raw query injection via Prisma (29 ms)
      √ó should reject Prisma findRaw injection attempts (22 ms)
      √ó should reject $queryRaw parameter injection (9 ms)
    PostgreSQL-Specific Injection Attacks
      √ó should reject PostgreSQL function calls (25 ms)
      √ó should reject PostgreSQL COPY command (15 ms)
      √ó should reject pg_read_file attempts (21 ms)
      ‚àö should reject large object manipulation (26 ms)
      √ó should reject PostgreSQL stored procedure execution (16 ms)
    SQL Injection in Batch Operations
      √ó should reject SQL injection in batch horse updates (21 ms)
      √ó should reject SQL injection in batch groom deletion (17 ms)
    SQL Injection Error Handling
      ‚àö should not leak database structure in error messages (34 ms)
      √ó should return consistent error format for all injection attempts (16 ms)
    Parameterized Query Validation
      √ó should use parameterized queries for ownership checks (45 ms)
      ‚àö should properly escape special characters in valid data (17 ms)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Classic SQL Injection in ID Parameters ‚Ä∫ should reject SQL injection in horse ID

    PrismaClientKnownRequestError: 
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

    [0m [90m 72 |[39m
     [90m 73 |[39m     [90m// Create test groom owned by user[39m
    [31m[1m>[22m[39m[90m 74 |[39m     testGroom [33m=[39m [36mawait[39m prisma[33m.[39mgroom[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 75 |[39m       data[33m:[39m {
     [90m 76 |[39m         name[33m:[39m [32m`TestGroom-${Date.now()}`[39m[33m,[39m
     [90m 77 |[39m         userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:74:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Blind SQL Injection Attempts ‚Ä∫ should reject boolean-based blind injection

    PrismaClientKnownRequestError: 
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

    [0m [90m 72 |[39m
     [90m 73 |[39m     [90m// Create test groom owned by user[39m
    [31m[1m>[22m[39m[90m 74 |[39m     testGroom [33m=[39m [36mawait[39m prisma[33m.[39mgroom[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 75 |[39m       data[33m:[39m {
     [90m 76 |[39m         name[33m:[39m [32m`TestGroom-${Date.now()}`[39m[33m,[39m
     [90m 77 |[39m         userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:74:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Blind SQL Injection Attempts ‚Ä∫ should reject time-based blind injection

    PrismaClientKnownRequestError: 
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

    [0m [90m 72 |[39m
     [90m 73 |[39m     [90m// Create test groom owned by user[39m
    [31m[1m>[22m[39m[90m 74 |[39m     testGroom [33m=[39m [36mawait[39m prisma[33m.[39mgroom[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 75 |[39m       data[33m:[39m {
     [90m 76 |[39m         name[33m:[39m [32m`TestGroom-${Date.now()}`[39m[33m,[39m
     [90m 77 |[39m         userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:74:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Blind SQL Injection Attempts ‚Ä∫ should reject PostgreSQL-specific time injection

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.create()` invocation:


    Unique constraint failed on the fields: (`email`)

    [0m [90m 47 |[39m   beforeEach([36masync[39m () [33m=>[39m {
     [90m 48 |[39m     [90m// Create test user in database[39m
    [31m[1m>[22m[39m[90m 49 |[39m     testUser [33m=[39m [36mawait[39m prisma[33m.[39muser[33m.[39mcreate({
     [90m    |[39m                [31m[1m^[22m[39m
     [90m 50 |[39m       data[33m:[39m {
     [90m 51 |[39m         email[33m:[39m [32m`test-${Date.now()}@example.com`[39m[33m,[39m
     [90m 52 |[39m         username[33m:[39m [32m`testuser-${Date.now()}`[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:49:16)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Union-Based SQL Injection ‚Ä∫ should reject UNION ALL attacks

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Union-Based SQL Injection ‚Ä∫ should reject UNION with ORDER BY column enumeration

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Union-Based SQL Injection ‚Ä∫ should reject UNION with NULL padding

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Stacked Queries ‚Ä∫ should reject semicolon-separated queries

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Stacked Queries ‚Ä∫ should reject multiple statements in ownership check

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Stacked Queries ‚Ä∫ should reject batch operations via stacking

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ SQL Injection in Search/Filter Parameters ‚Ä∫ should reject SQL injection in breed filter

    PrismaClientKnownRequestError: 
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

    [0m [90m 72 |[39m
     [90m 73 |[39m     [90m// Create test groom owned by user[39m
    [31m[1m>[22m[39m[90m 74 |[39m     testGroom [33m=[39m [36mawait[39m prisma[33m.[39mgroom[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 75 |[39m       data[33m:[39m {
     [90m 76 |[39m         name[33m:[39m [32m`TestGroom-${Date.now()}`[39m[33m,[39m
     [90m 77 |[39m         userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:74:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ SQL Injection in Search/Filter Parameters ‚Ä∫ should reject SQL injection in IN clause

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ SQL Injection in JSON/JSONB Queries ‚Ä∫ should reject SQL injection in JSONB path

    PrismaClientKnownRequestError: 
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

    [0m [90m 72 |[39m
     [90m 73 |[39m     [90m// Create test groom owned by user[39m
    [31m[1m>[22m[39m[90m 74 |[39m     testGroom [33m=[39m [36mawait[39m prisma[33m.[39mgroom[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 75 |[39m       data[33m:[39m {
     [90m 76 |[39m         name[33m:[39m [32m`TestGroom-${Date.now()}`[39m[33m,[39m
     [90m 77 |[39m         userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:74:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ SQL Injection in JSON/JSONB Queries ‚Ä∫ should reject SQL injection in JSON operators

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ SQL Injection in JSON/JSONB Queries ‚Ä∫ should reject SQL injection in JSON array queries

    PrismaClientKnownRequestError: 
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

    [0m [90m 72 |[39m
     [90m 73 |[39m     [90m// Create test groom owned by user[39m
    [31m[1m>[22m[39m[90m 74 |[39m     testGroom [33m=[39m [36mawait[39m prisma[33m.[39mgroom[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 75 |[39m       data[33m:[39m {
     [90m 76 |[39m         name[33m:[39m [32m`TestGroom-${Date.now()}`[39m[33m,[39m
     [90m 77 |[39m         userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:74:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Second-Order SQL Injection ‚Ä∫ should prevent injection via profile data used in ownership checks

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ ORM Bypass Attempts (Prisma) ‚Ä∫ should reject raw query injection via Prisma

    PrismaClientKnownRequestError: 
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

    [0m [90m 72 |[39m
     [90m 73 |[39m     [90m// Create test groom owned by user[39m
    [31m[1m>[22m[39m[90m 74 |[39m     testGroom [33m=[39m [36mawait[39m prisma[33m.[39mgroom[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 75 |[39m       data[33m:[39m {
     [90m 76 |[39m         name[33m:[39m [32m`TestGroom-${Date.now()}`[39m[33m,[39m
     [90m 77 |[39m         userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:74:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ ORM Bypass Attempts (Prisma) ‚Ä∫ should reject Prisma findRaw injection attempts

    PrismaClientKnownRequestError: 
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

    [0m [90m 72 |[39m
     [90m 73 |[39m     [90m// Create test groom owned by user[39m
    [31m[1m>[22m[39m[90m 74 |[39m     testGroom [33m=[39m [36mawait[39m prisma[33m.[39mgroom[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 75 |[39m       data[33m:[39m {
     [90m 76 |[39m         name[33m:[39m [32m`TestGroom-${Date.now()}`[39m[33m,[39m
     [90m 77 |[39m         userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:74:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ ORM Bypass Attempts (Prisma) ‚Ä∫ should reject $queryRaw parameter injection

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ PostgreSQL-Specific Injection Attacks ‚Ä∫ should reject PostgreSQL function calls

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ PostgreSQL-Specific Injection Attacks ‚Ä∫ should reject PostgreSQL COPY command

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ PostgreSQL-Specific Injection Attacks ‚Ä∫ should reject pg_read_file attempts

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ PostgreSQL-Specific Injection Attacks ‚Ä∫ should reject PostgreSQL stored procedure execution

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ SQL Injection in Batch Operations ‚Ä∫ should reject SQL injection in batch horse updates

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ SQL Injection in Batch Operations ‚Ä∫ should reject SQL injection in batch groom deletion

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ SQL Injection Error Handling ‚Ä∫ should return consistent error format for all injection attempts

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Parameterized Query Validation ‚Ä∫ should use parameterized queries for ownership checks

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 582 |[39m         [33m.[39m[36mget[39m([32m`/api/horses/${testHorse.id}`[39m)
     [90m 583 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${validToken}`[39m)
    [31m[1m>[22m[39m[90m 584 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 585 |[39m
     [90m 586 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 587 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mid)[33m.[39mtoBe(testHorse[33m.[39mid)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:584:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

[2025-12-12 06:13:14] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:14] warn: [ResourceManagement] Slow request detected: GET /test-thresholds took 5ms
[2025-12-12 06:13:14] warn: [ResourceManagement] High memory usage: GET /test-thresholds used 0MB
PASS __tests__/integration/rate-limiting.test.mjs (5.777 s)
  Rate Limiting System
    Login Rate Limiting (Brute Force Protection)
      ‚àö should_allow_up_to_5_failed_login_attempts (156 ms)
      ‚àö should_block_6th_failed_login_attempt_with_429 (57 ms)
      ‚àö should_reset_rate_limit_after_successful_authentication (59 ms)
      ‚àö should_include_retry_after_in_rate_limit_response (49 ms)
      ‚àö should_track_rate_limits_per_ip_address (70 ms)
    Registration Rate Limiting
      ‚àö should_rate_limit_registration_attempts (14 ms)
      ‚àö should_include_rate_limit_headers_on_registration (17 ms)
    Token Refresh Rate Limiting
      ‚àö should_rate_limit_token_refresh_attempts (5 ms)
    Rate Limit Headers
      ‚àö should_include_standard_rate_limit_headers (26 ms)
      ‚àö should_update_ratelimit_remaining_with_each_request (40 ms)
      ‚àö should_provide_accurate_reset_timestamp (31 ms)
    Rate Limit Reset Mechanism
      ‚àö should_reset_rate_limit_after_time_window (2106 ms)
    Concurrent Request Handling
      ‚àö should_handle_concurrent_requests_correctly (86 ms)
    Edge Cases
      ‚àö should_handle_missing_ip_address_gracefully (20 ms)
      ‚àö should_handle_malformed_requests_with_rate_limiting (48 ms)
      ‚àö should_not_leak_user_existence_through_rate_limiting (48 ms)
    Test Environment Configuration
      ‚àö should_respect_test_environment_rate_limit_config (2 ms)

FAIL __tests__/performance/apiResponseOptimization.test.mjs


  ‚óè Test suite failed to run

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 155 |[39m       where[33m:[39m { ownerId[33m:[39m testUserId }[33m,[39m
     [90m 156 |[39m     })[33m;[39m
    [31m[1m>[22m[39m[90m 157 |[39m     [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m     |[39m     [31m[1m^[22m[39m
     [90m 158 |[39m       where[33m:[39m { id[33m:[39m testUserId }[33m,[39m
     [90m 159 |[39m     })[33m;[39m
     [90m 160 |[39m     [36mawait[39m prisma[33m.[39mbreed[33m.[39mdeleteMany({[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/performance/apiResponseOptimization.test.mjs:157:5)

PASS __tests__/unit/security/rate-limit-keys.test.mjs
  Rate Limit Key Generation Unit Tests
    IP-Based Key Generation
      ‚àö should generate key based on IP address (9 ms)
      ‚àö should handle IPv4 addresses (9 ms)
      ‚àö should handle IPv6 addresses (4 ms)
      ‚àö should handle localhost IPv4 (7 ms)
      ‚àö should handle localhost IPv6 (8 ms)
      ‚àö should handle IP from X-Forwarded-For header (4 ms)
      ‚àö should handle IP from X-Real-IP header (2 ms)
    User-Based Key Generation
      ‚àö should generate key based on user ID when authenticated (1 ms)
      ‚àö should handle authenticated user with IP fallback (2 ms)
      ‚àö should handle unauthenticated user (null) (4 ms)
      ‚àö should handle unauthenticated user (undefined) (2 ms)
      ‚àö should handle user with string ID (5 ms)
      ‚àö should handle user with numeric ID (2 ms)
    Route-Based Key Generation
      ‚àö should generate different keys for different routes (3 ms)
      ‚àö should handle parameterized routes (2 ms)
      ‚àö should handle query parameters (1 ms)
      ‚àö should handle nested routes (3 ms)
      ‚àö should handle trailing slashes (6 ms)
      ‚àö should handle root path (1 ms)
    Combined Key Generation
      ‚àö should generate unique keys for user+route combination (2 ms)
      ‚àö should generate unique keys for IP+route combination (2 ms)
      ‚àö should generate unique keys for user+IP+route combination (2 ms)
      ‚àö should generate different keys for same user on different IPs (3 ms)
      ‚àö should generate different keys for different users on same IP (3 ms)
    Key Consistency
      ‚àö should generate consistent keys for same request parameters (2 ms)
      ‚àö should generate consistent keys across requests (3 ms)
      ‚àö should not be affected by request method (2 ms)
      ‚àö should not be affected by request headers (except proxy headers) (2 ms)
      ‚àö should not be affected by request body (2 ms)
    Key Security
      ‚àö should not expose sensitive user information in key (2 ms)
      ‚àö should handle SQL injection attempts in user ID (2 ms)
      ‚àö should handle special characters in IP (1 ms)
      ‚àö should handle null bytes in path (1 ms)
      ‚àö should handle extremely long user IDs (2 ms)
      ‚àö should handle extremely long IPs (IPv6) (2 ms)
    Key Storage Format
      ‚àö should generate Redis-compatible keys (2 ms)
      ‚àö should use colon as delimiter (2 ms)
      ‚àö should handle paths with slashes in keys (2 ms)
    Edge Cases
      ‚àö should handle missing IP address (2 ms)
      ‚àö should handle missing path (1 ms)
      ‚àö should handle empty string IP (2 ms)
      ‚àö should handle empty string path (3 ms)
      ‚àö should handle object as IP (edge case) (12 ms)
      ‚àö should handle array as path (edge case) (12 ms)

[2025-12-12 06:13:14] info: [GET] /auth/verify-email?token=999e09380d4bdc17adb0ed78c6e5c0d6a8f4c86625962ac39db55e566fca074a
[2025-12-12 06:13:14] info: [GET] /auth/verify-email?token=999e09380d4bdc17adb0ed78c6e5c0d6a8f4c86625962ac39db55e566fca074a
[2025-12-12 06:13:14] info: [EmailVerification] Email verified successfully
[2025-12-12 06:13:14] info: [EmailService] Welcome email (DEV MODE - not sent)
[2025-12-12 06:13:14] info: [GET] /auth/verify-email?token=999e09380d4bdc17adb0ed78c6e5c0d6a8f4c86625962ac39db55e566fca074a - 200
PASS __tests__/middleware/resourceManagement.test.mjs
  Resource Management Middleware
    Resource Management Middleware
      ‚àö adds resource tracking helpers to request (57 ms)
      ‚àö tracks and cleans up timers automatically (16 ms)
      ‚àö adds performance headers to response (26 ms)
      ‚àö handles request errors gracefully (129 ms)
      ‚àö tracks memory usage per request (25 ms)
      ‚àö warns about slow requests (30 ms)
    Memory Monitoring Middleware
      ‚àö adds memory headers to response (11 ms)
      ‚àö handles memory threshold checking (13 ms)
      ‚àö triggers GC when enabled and threshold exceeded (3 ms)
    Database Connection Middleware
      ‚àö tracks database queries (12 ms)
      ‚àö warns about high query counts (11 ms)
      ‚àö restores original methods after request (131 ms)
    Request Timeout Middleware
      ‚àö handles normal requests without timeout (18 ms)
      ‚àö times out slow requests (133 ms)
      ‚àö tracks timeout timer as resource (18 ms)
      ‚àö cleans up timeout timer on completion (20 ms)
    Middleware Integration
      ‚àö multiple middleware work together correctly (17 ms)
      ‚àö handles errors across middleware stack (25 ms)
    Configuration Options
      ‚àö respects disabled tracking options (11 ms)
      ‚àö uses custom thresholds correctly (15 ms)

[2025-12-12 06:13:14] error: [EmailVerification] Error verifying email token: Verification token has already been used
[2025-12-12 06:13:14] error: [authController.verifyEmail] Error verifying email: Verification token has already been used
[2025-12-12 06:13:14] error: [GET] /auth/verify-email?token=999e09380d4bdc17adb0ed78c6e5c0d6a8f4c86625962ac39db55e566fca074a - ERROR
[2025-12-12 06:13:14] error: Error Verification token has already been used
[2025-12-12 06:13:14] info: [GET] /auth/verify-email?token=999e09380d4bdc17adb0ed78c6e5c0d6a8f4c86625962ac39db55e566fca074a - 400
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
FAIL __tests__/integration/auth-cookies.test.mjs (6.961 s)
  Authentication with HttpOnly Cookies
    POST /api/auth/register - Cookie Setting
      √ó should set httpOnly cookies on successful registration (1630 ms)
      √ó should NOT expose tokens in response body (XSS protection) (528 ms)
    POST /api/auth/login - Cookie Setting
      ‚àö should set httpOnly cookies on successful login (199 ms)
      ‚àö should include SameSite=Strict for CSRF protection (183 ms)
    GET /api/auth/profile - Cookie Authentication
      ‚àö should authenticate with httpOnly cookies (177 ms)
      ‚àö should reject request without cookies (16 ms)
      ‚àö should reject request with invalid cookies (9 ms)
    POST /api/auth/refresh-token - Cookie Refresh
      ‚àö should refresh accessToken using httpOnly refreshToken cookie (150 ms)
      ‚àö should reject refresh without refreshToken cookie (20 ms)
    POST /api/auth/logout - Cookie Clearing
      ‚àö should clear httpOnly cookies on logout (313 ms)
      ‚àö should invalidate refresh tokens in database on logout (319 ms)
    Security: XSS Protection Verification
      √ó should never include JWT tokens in any response body (484 ms)
    Security: CSRF Protection Verification
      ‚àö should set SameSite=Strict on all auth cookies (163 ms)
    Production Security: HTTPS Enforcement
      ‚àö should set Secure flag in production environment (157 ms)
    Backward Compatibility: Authorization Header Fallback
      √ó should still accept Authorization header for backward compatibility (166 ms)

  ‚óè Authentication with HttpOnly Cookies ‚Ä∫ POST /api/auth/register - Cookie Setting ‚Ä∫ should set httpOnly cookies on successful registration

    expected 201 "Created", got 500 "Internal Server Error"

    [0m [90m 78 |[39m         [33m.[39m[36mset[39m(rateLimitBypassHeader)
     [90m 79 |[39m         [33m.[39msend(registrationUser)
    [31m[1m>[22m[39m[90m 80 |[39m         [33m.[39mexpect([35m201[39m)[33m;[39m
     [90m    |[39m          [31m[1m^[22m[39m
     [90m 81 |[39m
     [90m 82 |[39m       [90m// Verify response structure[39m
     [90m 83 |[39m       expect(response[33m.[39mbody[33m.[39mstatus)[33m.[39mtoBe([32m'success'[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/auth-cookies.test.mjs:80:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Authentication with HttpOnly Cookies ‚Ä∫ POST /api/auth/register - Cookie Setting ‚Ä∫ should NOT expose tokens in response body (XSS protection)

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 135 |[39m
     [90m 136 |[39m       [90m// Clean up[39m
    [31m[1m>[22m[39m[90m 137 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m     |[39m       [31m[1m^[22m[39m
     [90m 138 |[39m         where[33m:[39m { email[33m:[39m [32m'cookietest2@example.com'[39m }[33m,[39m
     [90m 139 |[39m       })[33m;[39m
     [90m 140 |[39m     })[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/auth-cookies.test.mjs:137:7)

  ‚óè Authentication with HttpOnly Cookies ‚Ä∫ Security: XSS Protection Verification ‚Ä∫ should never include JWT tokens in any response body

    expected 201 "Created", got 500 "Internal Server Error"

    [0m [90m 349 |[39m           username[33m:[39m [32m'xsstest'[39m[33m,[39m
     [90m 350 |[39m         })
    [31m[1m>[22m[39m[90m 351 |[39m         [33m.[39mexpect([35m201[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 352 |[39m
     [90m 353 |[39m       [36mconst[39m loginResponse [33m=[39m [36mawait[39m request(app)
     [90m 354 |[39m         [33m.[39mpost([32m'/api/auth/login'[39m)[0m

      at Object.<anonymous> (__tests__/integration/auth-cookies.test.mjs:351:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Authentication with HttpOnly Cookies ‚Ä∫ Backward Compatibility: Authorization Header Fallback ‚Ä∫ should still accept Authorization header for backward compatibility

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 454 |[39m         [33m.[39m[36mset[39m([32m'X-Test-Bypass-Auth'[39m[33m,[39m [32m'true'[39m)
     [90m 455 |[39m         [33m.[39m[36mset[39m([32m'X-Test-Email'[39m[33m,[39m [32m'fallback@example.com'[39m)
    [31m[1m>[22m[39m[90m 456 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 457 |[39m
     [90m 458 |[39m       expect(response[33m.[39mbody[33m.[39mstatus)[33m.[39mtoBe([32m'success'[39m)[33m;[39m
     [90m 459 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39muser[33m.[39memail)[33m.[39mtoBe([32m'fallback@example.com'[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/auth-cookies.test.mjs:456:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:15] info: [rateLimiting] Using in-memory rate limiting for test/disabled Redis environment
[2025-12-12 06:13:15] info: [GET] /auth/verify-email?token=definitely_invalid_token_123
[2025-12-12 06:13:15] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:15] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:15] info: [EmailVerification] Created verification token
[2025-12-12 06:13:15] info: [EmailService] Email verification (DEV MODE - not sent)
  console.log
    
    === EMAIL VERIFICATION (DEV MODE) ===

      at sendVerificationEmail (utils/emailService.mjs:227:15)

  console.log
    To: refreshcookietest@test.com

      at sendVerificationEmail (utils/emailService.mjs:228:15)

  console.log
    Subject: Verify Your Email Address - Equoria

      at sendVerificationEmail (utils/emailService.mjs:229:15)

  console.log
    Verification URL: http://localhost:3000/verify-email?token=df7a26e9af0f7328a48ca4112c90033a4bd6c3e03ffdb08ac36991966a5883a0

      at sendVerificationEmail (utils/emailService.mjs:230:15)

  console.log
    =====================================

      at sendVerificationEmail (utils/emailService.mjs:231:15)

[2025-12-12 06:13:15] info: [authController.register] Verification email sent
[2025-12-12 06:13:15] info: [POST] /auth/register - 201
[2025-12-12 06:13:15] info: [EmailVerification] Created verification token
[2025-12-12 06:13:15] info: [EmailService] Email verification (DEV MODE - not sent)
  console.log
    
    === EMAIL VERIFICATION (DEV MODE) ===

      at sendVerificationEmail (utils/emailService.mjs:227:15)

  console.log
    To: csrftest1765537994710@test.com

      at sendVerificationEmail (utils/emailService.mjs:228:15)

  console.log
    Subject: Verify Your Email Address - Equoria

      at sendVerificationEmail (utils/emailService.mjs:229:15)

  console.log
    Verification URL: http://localhost:3000/verify-email?token=66663771b151ac510d40f41dc18b2417238e758b9d0810c2781df8032affa79b

      at sendVerificationEmail (utils/emailService.mjs:230:15)

  console.log
    =====================================

      at sendVerificationEmail (utils/emailService.mjs:231:15)

[2025-12-12 06:13:15] info: [authController.register] Verification email sent
[2025-12-12 06:13:15] info: [POST] /auth/register - 201
[2025-12-12 06:13:15] info: [POST] /auth/login
[2025-12-12 06:13:15] info: [DELETE] /api/users/9cc72b59-c0fa-422e-90fb-43220dfa176d
[2025-12-12 06:13:15] info: [auth] Authenticated user 9cc72b59-c0fa-422e-90fb-43220dfa176d for DELETE /users/9cc72b59-c0fa-422e-90fb-43220dfa176d
[2025-12-12 06:13:15] info: [DELETE] /api/users/9cc72b59-c0fa-422e-90fb-43220dfa176d - 403
[2025-12-12 06:13:15] info: [POST] /auth/register
[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:15] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:15] info: [POST] /auth/login - 200
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] info: [POST] /auth/refresh-token
[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] error: [authController.verifyEmail] Error verifying email: Invalid or expired verification token
[2025-12-12 06:13:15] warn: [Validation] Input validation failed
[2025-12-12 06:13:15] error: [GET] /auth/verify-email?token=definitely_invalid_token_123 - ERROR
[2025-12-12 06:13:15] error: Error Invalid or expired verification token
[2025-12-12 06:13:15] info: [GET] /auth/verify-email?token=definitely_invalid_token_123 - 400
[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:15] warn: [Validation] Input validation failed
[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] info: [ownership] Validated ownership: user 1 owns horse 1
[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] warn: [Validation] Input validation failed
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] info: [ownership] Validated ownership: user 1 owns groom 5
[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] info: [ownership] Validated ownership: user 1 owns horse 10
[2025-12-12 06:13:15] info: [ownership] Validated ownership: user 1 owns horse 20
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] info: [ownership] Validated ownership: user 1 owns horse 1
[2025-12-12 06:13:15] warn: [ownership] horse 1 not found or not owned by user 1
[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] warn: [ownership] groom 5 not found or not owned by user 1
[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] warn: [ownership] horse 999 not found or not owned by user 1
[2025-12-12 06:13:15] info: [GET] /auth/verify-email?token=
[2025-12-12 06:13:15] error: [authController.verifyEmail] Error verifying email: Verification token is required
[2025-12-12 06:13:15] error: [GET] /auth/verify-email?token= - ERROR
[2025-12-12 06:13:15] error: Error Verification token is required
[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] info: [GET] /auth/verify-email?token= - 400
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] warn: [ownership] horse 10 not found or not owned by user 42
[2025-12-12 06:13:15] info: [GET] /auth/verify-email?token=
[2025-12-12 06:13:15] error: [authController.verifyEmail] Error verifying email: Verification token is required
[2025-12-12 06:13:15] error: [GET] /auth/verify-email?token= - ERROR
[2025-12-12 06:13:15] error: Error Verification token is required
[2025-12-12 06:13:15] info: [GET] /auth/verify-email?token= - 400
[2025-12-12 06:13:15] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:15] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:15] info: [POST] /auth/refresh-token - 200
[2025-12-12 06:13:15] info: [GET] /auth/verify-email?token=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
[2025-12-12 06:13:15] warn: [ownership] horse 99999 not found or not owned by user 1
[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] warn: [UserDocService] Documentation directory not found
[2025-12-12 06:13:15] info: [POST] /auth/register
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 0 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] warn: [ownership] foal 1 not found or not owned by user 1
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] warn: [ownership] Invalid horse ID: abc
[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] warn: [ownership] Invalid horse ID: -5
[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] warn: [ownership] Invalid horse ID: 1.5
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] warn: [UserDocService] Document not found: non-existent
[2025-12-12 06:13:15] info: [CSRF] Token generated
[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] error: [authController.verifyEmail] Error verifying email: Invalid or expired verification token
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] error: [GET] /auth/verify-email?token=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa - ERROR
[2025-12-12 06:13:15] error: Error Invalid or expired verification token
[2025-12-12 06:13:15] warn: [ownership] Invalid horse ID: 1; DROP TABLE horses;
[2025-12-12 06:13:15] info: [GET] /auth/verify-email?token=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa - 400
[2025-12-12 06:13:15] info: [GET] /auth/verify-email?token=%3Cscript%3Ealert(%22xss%22)%3C/script%3E
[2025-12-12 06:13:15] warn: [AuthRateLimiter] createAuthRateLimiter() is deprecated, using Redis-backed limiter
[2025-12-12 06:13:15] warn: [AuthRateLimiter] resetAllAuthRateLimits() is deprecated with Redis
[2025-12-12 06:13:15] info: [CSRF] Token generated
[2025-12-12 06:13:15] warn: [ownership] Missing user for horse ownership check
[2025-12-12 06:13:15] warn: [ownership] Missing user for horse ownership check
[2025-12-12 06:13:15] info: [CSRF] Token generated
[2025-12-12 06:13:15] info: [CSRF] Token generated
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] info: [CSRF] Token generated
[2025-12-12 06:13:15] info: [CSRF] Token generated
[2025-12-12 06:13:15] info: [ownership] Found owned horse 1 for user 1
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] warn: [HTTPS] Insecure HTTP request detected, redirecting to HTTPS
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] warn: [ownership] horse 1 not found or not owned by user 2
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [ownership] Found owned horse 1 for user 1
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] warn: [HTTPS] Insecure HTTP request detected, redirecting to HTTPS
[2025-12-12 06:13:15] error: [ownership] Error finding owned horse: Database connection lost
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] info: [ownership] Batch validation: user 1 owns 3/3 horses
[2025-12-12 06:13:15] info: [ownership] Batch validation: user 1 owns 2/3 horses
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] info: [ownership] Batch validation: user 2 owns 0/3 horses
[2025-12-12 06:13:15] info: [ownership] Batch validation: user 1 owns 0/0 horses
[2025-12-12 06:13:15] info: [ownership] Batch validation: user 1 owns 1/1 horses
[2025-12-12 06:13:15] info: [ownership] Validated ownership: user 1 owns training-session 1
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] info: [ownership] Validated ownership: user 1 owns competition-entry 1
[2025-12-12 06:13:15] error: [ownership] Invalid resource type: invalid-resource-type
[2025-12-12 06:13:15] info: [ownership] Validated ownership: user 1 owns horse 1
[2025-12-12 06:13:15] info: [ownership] Batch validation: user 1 owns 2/2 horses
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] warn: [API Key] Invalid or missing API key
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] warn: [API Key] Invalid or missing API key
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] warn: [API Key] Invalid or missing API key
[2025-12-12 06:13:15] warn: [API Key] API_KEY not configured - requests with no origin are allowed (INSECURE)
[2025-12-12 06:13:15] warn: [API Key] API_KEY not configured - requests with no origin are allowed (INSECURE)
[2025-12-12 06:13:15] error: [authController.verifyEmail] Error verifying email: Invalid or expired verification token
[2025-12-12 06:13:15] error: [GET] /auth/verify-email?token=%3Cscript%3Ealert(%22xss%22)%3C/script%3E - ERROR
[2025-12-12 06:13:15] error: Error Invalid or expired verification token
[2025-12-12 06:13:15] info: [GET] /auth/verify-email?token=%3Cscript%3Ealert(%22xss%22)%3C/script%3E - 400
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] info: [GET] /auth/verify-email?token=%27;%20DROP%20TABLE%20users;%20--
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] warn: CORS blocked request from origin: https://evil.com
PASS __tests__/unit/auth-rate-limiter.test.mjs
  Authentication Rate Limiter (Unit)
    Rate Limiter Configuration
      ‚àö should_create_rate_limiter_with_default_config (10 ms)
      ‚àö should_create_rate_limiter_with_custom_config (15 ms)
      ‚àö should_validate_configuration_parameters (3 ms)
    Request Tracking
      ‚àö should_track_requests_by_ip_address (4 ms)
      ‚àö should_allow_requests_within_limit (9 ms)
      ‚àö should_block_requests_exceeding_limit (12 ms)
    Rate Limit Headers
      ‚àö should_set_ratelimit_headers_on_every_request (6 ms)
      ‚àö should_update_remaining_count_with_each_request (10 ms)
      ‚àö should_calculate_accurate_reset_timestamp (15 ms)
    Time Window Reset
      ‚àö should_reset_count_after_time_window (18 ms)
      ‚àö should_maintain_separate_windows_for_different_ips (42 ms)
    Success Reset Mechanism
      ‚àö should_reset_count_on_successful_authentication (19 ms)
      ‚àö should_provide_method_to_reset_specific_ip (19 ms)
    Error Handling
      ‚àö should_handle_missing_ip_address (38 ms)
      ‚àö should_handle_concurrent_requests_atomically (24 ms)
      ‚àö should_not_crash_on_invalid_configuration (13 ms)
    Memory Management
      ‚àö should_clean_up_expired_entries (11 ms)
      ‚àö should_have_configurable_cleanup_interval (22 ms)
      ‚àö should_limit_maximum_storage_size (4 ms)
    Integration with Express
      ‚àö should_work_as_express_middleware (22 ms)
      ‚àö should_call_next_when_within_limit (19 ms)
      ‚àö should_not_call_next_when_rate_limited (14 ms)
    Response Format
      ‚àö should_send_consistent_429_response_format (10 ms)
      ‚àö should_include_retry_after_in_seconds (12 ms)

PASS __tests__/middleware/validationErrorHandler.test.mjs
  Validation Error Handler
    handleValidationErrors()
      ‚àö should call next() when no validation errors (19 ms)
      ‚àö should return 400 when validation errors exist (23 ms)
      ‚àö should handle single validation error (14 ms)
      ‚àö should handle nested field validation errors (13 ms)
    sanitizeRequestData() - XSS Prevention
      No validation errors
        ‚àö should sanitize body data and remove extra fields (15 ms)
        ‚àö should sanitize query parameters (10 ms)
        ‚àö should sanitize route parameters (18 ms)
        ‚àö should handle multiple request sources simultaneously (6 ms)
        ‚àö should preserve validated data with special characters (39 ms)
        ‚àö should handle empty validated data (16 ms)
        ‚àö should handle optional fields (57 ms)
      With validation errors
        ‚àö should NOT modify request data when validation failed (20 ms)
        ‚àö should still call next() to allow handleValidationErrors to run (8 ms)
      XSS Attack Scenarios
        ‚àö should prevent <script> injection (11 ms)
        ‚àö should prevent event handler injection (5 ms)
        ‚àö should prevent iframe injection (20 ms)
        ‚àö should prevent SVG XSS (37 ms)
      Parameter Pollution Prevention (CWE-20)
        ‚àö should prevent array parameter pollution (29 ms)
        ‚àö should prevent object parameter pollution (9 ms)
        ‚àö should prevent duplicate parameter names (5 ms)

[2025-12-12 06:13:15] warn: [CORS] Request with no origin detected - API key validation required
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] warn: [CORS] Request with no origin detected - API key validation required
[2025-12-12 06:13:15] info: [CSRF] Token generated
[2025-12-12 06:13:15] info: [CSRF] Token generated
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] info: [CSRF] Token generated
[2025-12-12 06:13:15] info: [CSRF] Token generated
[2025-12-12 06:13:15] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:15] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
PASS __tests__/unit/featureFlagService.test.mjs
  Feature Flag Service
    isFeatureEnabled
      ‚àö should return false for undefined flags (15 ms)
      ‚àö should return true for flags set to "true" in environment (28 ms)
      ‚àö should return false for flags set to "false" in environment (2 ms)
      ‚àö should handle case-insensitive boolean strings (4 ms)
      ‚àö should use default value from FLAG_DEFINITIONS (5 ms)
      ‚àö should respect environment override over defaults (3 ms)
    Percentage-based rollout
      ‚àö should consistently hash same user to same bucket (4 ms)
      ‚àö should return false when percentage is 0 (3 ms)
      ‚àö should return true when percentage is 100 (3 ms)
    getFeatureVariant
      ‚àö should return string value from environment (3 ms)
      ‚àö should return default value for undefined flags (24 ms)
      ‚àö should return default when value is not a string (5 ms)
    getAllFlags
      ‚àö should return all defined flags (10 ms)
      ‚àö should evaluate flags with provided context (10 ms)
    getEvaluationStats
      ‚àö should track flag evaluations (8 ms)
      ‚àö should calculate enabled rate correctly (7 ms)
    overrideFlag
      ‚àö should allow runtime flag override (5 ms)
    clearOverrides
      ‚àö should clear all runtime overrides (8 ms)
    Error Handling
      ‚àö should return false on evaluation error (4 ms)

[2025-12-12 06:13:15] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:15] error: [POST] /auth/register - ERROR
[2025-12-12 06:13:15] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] info: [POST] /auth/register - 500
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] info: [POST] /auth/register
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
  console.error
    TypeError: Cannot read properties of undefined (reading 'get')
        at Object.trustProxy (C:\Users\heirr\OneDrive\Desktop\Equoria\backend\node_modules\express-rate-limit\dist\index.mjs:140:21)
        at Object.wrappedValidations.<computed> [as trustProxy] (C:\Users\heirr\OneDrive\Desktop\Equoria\backend\node_modules\express-rate-limit\dist\index.mjs:370:22)
        at Object.keyGenerator (C:\Users\heirr\OneDrive\Desktop\Equoria\backend\node_modules\express-rate-limit\dist\index.mjs:642:20)
        at C:\Users\heirr\OneDrive\Desktop\Equoria\backend\node_modules\express-rate-limit\dist\index.mjs:696:32
        at C:\Users\heirr\OneDrive\Desktop\Equoria\backend\node_modules\express-rate-limit\dist\index.mjs:676:5
        at Object.<anonymous> (C:\Users\heirr\OneDrive\Desktop\Equoria\backend\__tests__\middleware\security.test.mjs:447:7)

    [0m [90m 445 |[39m
     [90m 446 |[39m       [90m// First request should succeed[39m
    [31m[1m>[22m[39m[90m 447 |[39m       [36mawait[39m testLimiter(req[33m,[39m res[33m,[39m next)[33m;[39m
     [90m     |[39m       [31m[1m^[22m[39m
     [90m 448 |[39m       expect(next)[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m 449 |[39m
     [90m 450 |[39m       [90m// Reset mocks[39m[0m

      at Object.wrappedValidations.<computed> [as trustProxy] (node_modules/express-rate-limit/dist/index.mjs:378:21)
      at Object.keyGenerator (node_modules/express-rate-limit/dist/index.mjs:642:20)
      at node_modules/express-rate-limit/dist/index.mjs:696:32
      at node_modules/express-rate-limit/dist/index.mjs:676:5
      at Object.<anonymous> (__tests__/middleware/security.test.mjs:447:7)

[2025-12-12 06:13:15] warn: Rate limit exceeded for IP: 192.168.1.100
PASS __tests__/unit/security/ownership-checks.test.mjs
  Ownership Validation Unit Tests
    Owned Resource Scenarios
      ‚àö should allow access to owned horse (22 ms)
      ‚àö should allow access to owned groom (11 ms)
      ‚àö should attach resource to request object (11 ms)
      ‚àö should work with custom idParam (9 ms)
      ‚àö should include relations when specified (24 ms)
    Not Owned Resource Scenarios
      ‚àö should return 404 for horse owned by different user (28 ms)
      ‚àö should return 404 for groom owned by different user (32 ms)
      ‚àö should not disclose ownership information in error message (29 ms)
      ‚àö should query with both id AND userId in WHERE clause (22 ms)
    Non-Existent Resource Scenarios
      ‚àö should return 404 for non-existent horse (18 ms)
      ‚àö should return 404 for non-existent foal (12 ms)
      ‚àö should allow null resource when required=false (11 ms)
    Invalid Resource ID Scenarios
      ‚àö should return 400 for non-numeric ID (23 ms)
      ‚àö should return 400 for negative ID (53 ms)
      ‚àö should return 400 for decimal ID (11 ms)
      ‚àö should return 400 for ID with special characters (14 ms)
      ‚àö should return 401 when user not authenticated (9 ms)
      ‚àö should return 401 when user.id is missing (9 ms)
    findOwnedResource Helper Function
      ‚àö should find owned resource (11 ms)
      ‚àö should return null for not owned resource (7 ms)
      ‚àö should include relations when specified (10 ms)
      ‚àö should handle database errors gracefully (14 ms)
    validateBatchOwnership Helper Function
      ‚àö should validate ownership of multiple resources (4 ms)
      ‚àö should return partial results when some resources not owned (2 ms)
      ‚àö should return empty array when no resources owned (2 ms)
      ‚àö should handle empty resource ID array (2 ms)
      ‚àö should include relations when specified (3 ms)
    Resource Type Validation
      ‚àö should handle training-session resource type (2 ms)
      ‚àö should handle competition-entry resource type (3 ms)
      ‚àö should return 500 for invalid resource type (5 ms)
    Performance Validation
      ‚àö should use single query for ownership check (2 ms)
      ‚àö should use single query with IN clause for batch validation (2 ms)

[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] info: [UserDocService] Loaded 5 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation refreshed successfully
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] warn: [UserDocService] Documentation directory not found
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 0 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation refreshed successfully
[2025-12-12 06:13:15] error: [authController.verifyEmail] Error verifying email: Invalid or expired verification token
[2025-12-12 06:13:15] error: [GET] /auth/verify-email?token=%27;%20DROP%20TABLE%20users;%20-- - ERROR
[2025-12-12 06:13:15] error: Error Invalid or expired verification token
[2025-12-12 06:13:15] info: [GET] /auth/verify-email?token=%27;%20DROP%20TABLE%20users;%20-- - 400
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] info: [GET] /auth/verify-email?token=
[2025-12-12 06:13:15] error: [authController.verifyEmail] Error verifying email: Verification token is required
[2025-12-12 06:13:15] error: [GET] /auth/verify-email?token= - ERROR
[2025-12-12 06:13:15] error: Error Verification token is required
[2025-12-12 06:13:15] info: [GET] /auth/verify-email?token= - 400
[2025-12-12 06:13:15] info: [GET] /auth/verify-email?token=
[2025-12-12 06:13:15] error: [authController.verifyEmail] Error verifying email: Verification token is required
[2025-12-12 06:13:15] error: [GET] /auth/verify-email?token= - ERROR
[2025-12-12 06:13:15] error: Error Verification token is required
[2025-12-12 06:13:15] info: [GET] /auth/verify-email?token= - 400
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
[2025-12-12 06:13:15] info: [UserDocService] Loaded 4 documentation files
[2025-12-12 06:13:15] info: [UserDocService] Built search index with 95 terms
[2025-12-12 06:13:15] info: [UserDocService] Documentation system initialized successfully
PASS __tests__/unit/security/csrf-validation.test.mjs
  CSRF Token Validation Unit Tests
    CSRF Token Generation
      ‚àö should generate a CSRF token (19 ms)
      ‚àö should store CSRF token in session (11 ms)
      ‚àö should generate unique tokens for each request (8 ms)
      ‚àö should generate token with sufficient length (4 ms)
      ‚àö should generate token with cryptographically secure randomness (3 ms)
    CSRF Token Validation - Valid Scenarios
      ‚àö should accept valid CSRF token in body (4 ms)
      ‚àö should accept valid CSRF token in header (2 ms)
      ‚àö should prefer body token over header token (4 ms)
      ‚àö should skip CSRF for GET requests (10 ms)
      ‚àö should skip CSRF for HEAD requests (5 ms)
      ‚àö should skip CSRF for OPTIONS requests (5 ms)
    CSRF Token Validation - Invalid Scenarios
      ‚àö should reject POST request without CSRF token (3 ms)
      ‚àö should reject PUT request without CSRF token (3 ms)
      ‚àö should reject DELETE request without CSRF token (4 ms)
      ‚àö should reject PATCH request without CSRF token (7 ms)
      ‚àö should reject mismatched CSRF token (5 ms)
      ‚àö should reject empty CSRF token (6 ms)
      ‚àö should reject null CSRF token (4 ms)
      ‚àö should reject undefined CSRF token (3 ms)
      ‚àö should reject when session has no CSRF token (3 ms)
      ‚àö should reject when session is missing (3 ms)
    CSRF Token Security Edge Cases
      ‚àö should reject token with extra whitespace (7 ms)
      ‚àö should reject token with newline characters (5 ms)
      ‚àö should reject token with special characters appended (5 ms)
      ‚àö should be case-sensitive for token validation (3 ms)
      ‚àö should reject partial token match (3 ms)
      ‚àö should use timing-safe comparison for tokens (4 ms)
    CSRF Error Handling
      ‚àö should return proper error response for CSRF failure (3 ms)
      ‚àö should not leak session token in error message (3 ms)
      ‚àö should not leak provided token in error message (11 ms)
    CSRF Token Rotation
      ‚àö should allow token regeneration (9 ms)
      ‚àö should invalidate old token after regeneration (21 ms)
    CSRF Double-Submit Cookie Pattern
      ‚àö should validate CSRF token from cookie (5 ms)
    CSRF Integration with Different Content Types
      ‚àö should validate CSRF for application/json (7 ms)
      ‚àö should validate CSRF for application/x-www-form-urlencoded (5 ms)
      ‚àö should validate CSRF for multipart/form-data (7 ms)

PASS __tests__/utils/validateEnvironment.test.mjs
  validateEnvironment()
    Required variables validation
      ‚àö should pass with all required variables present (9 ms)
      ‚àö should fail when DATABASE_URL is missing (11 ms)
      ‚àö should fail when JWT_SECRET is missing (10 ms)
      ‚àö should fail when NODE_ENV is missing (8 ms)
      ‚àö should fail when PORT is missing (6 ms)
    Minimum length validation
      ‚àö should fail when DATABASE_URL is too short (<20 chars) (4 ms)
      ‚àö should fail when JWT_SECRET is too short (<32 chars) (5 ms)
      ‚àö should pass when JWT_SECRET is exactly 32 characters (6 ms)
    Allowed values validation
      ‚àö should pass when NODE_ENV is "development" (3 ms)
      ‚àö should pass when NODE_ENV is "production" (8 ms)
      ‚àö should pass when NODE_ENV is "test" (4 ms)
      ‚àö should fail when NODE_ENV is invalid (3 ms)
    Type validation
      ‚àö should pass when PORT is a valid number (6 ms)
      ‚àö should fail when PORT is not a number (11 ms)
    JWT_SECRET strength validation
      ‚àö should reject placeholder "your-super-secret" (5 ms)
      ‚àö should reject placeholder "change-this" (6 ms)
      ‚àö should reject placeholder "REPLACE_WITH" (3 ms)
      ‚àö should reject placeholder "example" (3 ms)
      ‚àö should warn when JWT_SECRET lacks character variety (line 72) (3 ms)
    DATABASE_URL format validation
      ‚àö should pass with postgresql:// prefix (14 ms)
      ‚àö should pass with postgres:// prefix (9 ms)
      ‚àö should fail without postgresql prefix (18 ms)
      ‚àö should reject weak password "password" (6 ms)
      ‚àö should reject weak password "admin" (7 ms)
      ‚àö should reject weak password "123456" (8 ms)
      ‚àö should reject weak password "postgres" (8 ms)
    Production HTTPS warnings
      ‚àö should warn about HTTP origins in production (9 ms)
      ‚àö should NOT warn about HTTPS origins in production (12 ms)
      ‚àö should warn about PORT 80 in production (2 ms)
      ‚àö should NOT warn about PORT 443 in production (2 ms)
    Multiple errors
      ‚àö should report all validation errors at once (14 ms)

PASS __tests__/middleware/security.test.mjs
  Security Middleware
    enforceHttps()
      Development environment
        ‚àö should allow HTTP requests in development (12 ms)
      Production environment
        ‚àö should allow HTTPS requests (req.secure) (13 ms)
        ‚àö should allow HTTPS requests (x-forwarded-proto header) (5 ms)
        ‚àö should allow HTTPS requests (x-forwarded-ssl header) (5 ms)
        ‚àö should redirect HTTP to HTTPS with 301 status (18 ms)
        ‚àö should preserve query parameters in redirect (10 ms)
    addSecurityHeaders()
      ‚àö should add HSTS header in production (8 ms)
      ‚àö should NOT add HSTS header in development (3 ms)
      ‚àö should add X-Frame-Options header (3 ms)
      ‚àö should add X-Content-Type-Options header (4 ms)
      ‚àö should add X-XSS-Protection header (7 ms)
      ‚àö should add Referrer-Policy header (2 ms)
      ‚àö should add Permissions-Policy header (4 ms)
      ‚àö should add all 6 security headers in production (5 ms)
    validateApiKey()
      Requests WITH origin header
        ‚àö should skip API key validation for browser requests (3 ms)
        ‚àö should skip validation even if X-API-Key is missing (4 ms)
      Requests WITHOUT origin header (mobile/API clients)
        ‚àö should accept valid API key (8 ms)
        ‚àö should reject missing API key (3 ms)
        ‚àö should reject invalid API key (3 ms)
        ‚àö should be case-sensitive for API key (4 ms)
      Missing API_KEY environment variable
        ‚àö should allow requests without API key (backward compatibility) (3 ms)
        ‚àö should log warning when API_KEY not configured (3 ms)
    CORS Configuration
      ‚àö should have credentials enabled (11 ms)
      ‚àö should allow standard HTTP methods (16 ms)
      ‚àö should allow required headers (9 ms)
      corsOptions.origin()
        ‚àö should allow localhost:3000 (4 ms)
        ‚àö should allow localhost:3001 (2 ms)
        ‚àö should allow 127.0.0.1:3000 (3 ms)
        ‚àö should allow additional origins from environment (3 ms)
        ‚àö should block unknown origins (6 ms)
        ‚àö should allow requests with no origin (mobile apps) (6 ms)
        ‚àö should allow requests with null origin (6 ms)
    createRateLimiter()
      ‚àö should create a rate limiter with custom window and max (8 ms)
      ‚àö should create rate limiter with default values (4 ms)
      ‚àö should return rate limiter middleware (4 ms)
    Rate Limiter Instances
      ‚àö should export apiLimiter (3 ms)
      ‚àö should trigger rate limit handler when limit exceeded (16 ms)
    createSecurityMiddleware()
      ‚àö should return an array of middleware functions (23 ms)
      ‚àö should include all required middleware in correct order (8 ms)

[2025-12-12 06:13:16] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:16] info: [EmailVerification] Created verification token
[2025-12-12 06:13:16] info: [EmailService] Email verification (DEV MODE - not sent)
  console.log
    
    === EMAIL VERIFICATION (DEV MODE) ===

      at sendVerificationEmail (utils/emailService.mjs:227:15)

  console.log
    To: logoutcookietest@test.com

      at sendVerificationEmail (utils/emailService.mjs:228:15)

  console.log
    Subject: Verify Your Email Address - Equoria

      at sendVerificationEmail (utils/emailService.mjs:229:15)

  console.log
    Verification URL: http://localhost:3000/verify-email?token=84142a53235a2cbd73608c7e0d66ab5265cff13b36b3305a913ae26c435f6867

      at sendVerificationEmail (utils/emailService.mjs:230:15)

  console.log
    =====================================

      at sendVerificationEmail (utils/emailService.mjs:231:15)

[2025-12-12 06:13:16] info: [authController.register] Verification email sent
[2025-12-12 06:13:16] info: [POST] /auth/register - 201
[2025-12-12 06:13:16] info: [POST] /auth/login
[2025-12-12 06:13:16] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:16] info: [POST] /auth/login - 200
[2025-12-12 06:13:16] info: [POST] /auth/logout
PASS __tests__/services/userDocumentation.test.mjs
  User Documentation Service
    Documentation Loading
      ‚àö loads all documentation files correctly (41 ms)
      ‚àö extracts document metadata correctly (15 ms)
      ‚àö extracts sections correctly (23 ms)
      ‚àö builds search index correctly (17 ms)
    Document Retrieval
      ‚àö retrieves existing document correctly (29 ms)
      ‚àö returns null for non-existent document (11 ms)
      ‚àö tracks view analytics correctly (14 ms)
      ‚àö gets all documents correctly (18 ms)
    Search Functionality
      ‚àö searches documentation content successfully (13 ms)
      ‚àö handles single word searches (11 ms)
      ‚àö returns empty results for non-matching search (11 ms)
      ‚àö tracks search analytics (12 ms)
      ‚àö finds matching sections in search results (10 ms)
      ‚àö respects search options (16 ms)
    Analytics and Reporting
      ‚àö generates analytics correctly (13 ms)
      ‚àö tracks popular documents correctly (12 ms)
      ‚àö limits search query history (11 ms)
    Table of Contents
      ‚àö generates table of contents correctly (12 ms)
      ‚àö creates proper anchors for sections (12 ms)
    Content Parsing
      ‚àö counts words correctly (20 ms)
      ‚àö extracts searchable words correctly (13 ms)
      ‚àö normalizes search queries correctly (12 ms)
      ‚àö identifies stop words correctly (12 ms)
    System Management
      ‚àö refreshes documentation successfully (26 ms)
      ‚àö handles refresh errors gracefully (10 ms)
    Helper Functions
      ‚àö getDocument helper function works (14 ms)
      ‚àö searchDocumentation helper function works (17 ms)
      ‚àö getAllDocuments helper function works (9 ms)
      ‚àö getDocumentationAnalytics helper function works (10 ms)
      ‚àö getTableOfContents helper function works (12 ms)

  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

FAIL __tests__/integration/email-verification.test.mjs (14.624 s)
  Email Verification System - Integration Tests
    POST /auth/register - Email Verification Integration
      √ó should_create_verification_token_on_registration (844 ms)
      √ó should_include_email_verified_status_in_response (659 ms)
      √ó should_log_verification_email_in_development_mode (706 ms)
    GET /auth/verify-email
      √ó should_verify_email_with_valid_token (215 ms)
      √ó should_update_user_email_verified_status (1188 ms)
      √ó should_mark_token_as_used (287 ms)
      ‚àö should_reject_missing_token (175 ms)
      ‚àö should_reject_invalid_token (262 ms)
      √ó should_reject_expired_token (155 ms)
      ‚àö should_reject_already_used_token (152 ms)
      √ó should_be_publicly_accessible_without_authentication (267 ms)
    POST /auth/resend-verification
      ‚àö should_create_new_verification_token (241 ms)
      ‚àö should_require_authentication (167 ms)
      ‚àö should_reject_if_email_already_verified (151 ms)
      √ó should_enforce_rate_limiting (199 ms)
      ‚àö should_cleanup_expired_tokens (195 ms)
    GET /auth/verification-status
      √ó should_return_unverified_status_for_new_user (170 ms)
      ‚àö should_return_verified_status_after_verification (163 ms)
      ‚àö should_require_authentication (155 ms)
      √ó should_return_user_email_address (141 ms)
    Complete Email Verification Workflow
      √ó should_complete_full_registration_to_verification_flow (649 ms)
      √ó should_handle_resend_and_verify_workflow (178 ms)
      √ó should_prevent_multiple_verification_attempts (132 ms)
    Security and Edge Cases
      ‚àö should_handle_concurrent_verification_requests (169 ms)
      ‚àö should_sanitize_error_messages_to_prevent_enumeration (349 ms)
      ‚àö should_handle_malformed_token_input (613 ms)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ POST /auth/register - Email Verification Integration ‚Ä∫ should_create_verification_token_on_registration

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 70 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)[33m.[39mpost([32m'/auth/register'[39m)[33m.[39msend(newUser)[33m;[39m
     [90m 71 |[39m
    [31m[1m>[22m[39m[90m 72 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                               [31m[1m^[22m[39m
     [90m 73 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39memailVerificationSent)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 74 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39muser[33m.[39memailVerified)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 75 |[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:72:31)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ POST /auth/register - Email Verification Integration ‚Ä∫ should_include_email_verified_status_in_response

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m  95 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)[33m.[39mpost([32m'/auth/register'[39m)[33m.[39msend(newUser)[33m;[39m
     [90m  96 |[39m
    [31m[1m>[22m[39m[90m  97 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m  98 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39muser)[33m.[39mtoHaveProperty([32m'emailVerified'[39m)[33m;[39m
     [90m  99 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39muser[33m.[39memailVerified)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 100 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'verify your account'[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:97:31)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ POST /auth/register - Email Verification Integration ‚Ä∫ should_log_verification_email_in_development_mode

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 114 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)[33m.[39mpost([32m'/auth/register'[39m)[33m.[39msend(newUser)[33m;[39m
     [90m 115 |[39m
    [31m[1m>[22m[39m[90m 116 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 117 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39memailVerificationSent)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 118 |[39m
     [90m 119 |[39m       [90m// In development, email should be logged (check via token existence)[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:116:31)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ GET /auth/verify-email ‚Ä∫ should_verify_email_with_valid_token

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

    [0m [90m 141 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)[33m.[39m[36mget[39m([32m`/auth/verify-email?token=${token.token}`[39m)[33m;[39m
     [90m 142 |[39m
    [31m[1m>[22m[39m[90m 143 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 144 |[39m       expect(response[33m.[39mbody[33m.[39mstatus)[33m.[39mtoBe([32m'success'[39m)[33m;[39m
     [90m 145 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoBe([32m'Email verified successfully'[39m)[33m;[39m
     [90m 146 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mverified)[33m.[39mtoBe([36mtrue[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:143:31)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ GET /auth/verify-email ‚Ä∫ should_update_user_email_verified_status

    TypeError: Cannot read properties of null (reading 'emailVerified')

    [0m [90m 164 |[39m       })[33m;[39m
     [90m 165 |[39m
    [31m[1m>[22m[39m[90m 166 |[39m       expect(user[33m.[39memailVerified)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                   [31m[1m^[22m[39m
     [90m 167 |[39m       expect(user[33m.[39memailVerifiedAt)[33m.[39mtoBeDefined()[33m;[39m
     [90m 168 |[39m       expect(user[33m.[39memailVerifiedAt)[33m.[39mtoBeInstanceOf([33mDate[39m)[33m;[39m
     [90m 169 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:166:19)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ GET /auth/verify-email ‚Ä∫ should_mark_token_as_used

    TypeError: Cannot read properties of null (reading 'usedAt')

    [0m [90m 185 |[39m       })[33m;[39m
     [90m 186 |[39m
    [31m[1m>[22m[39m[90m 187 |[39m       expect(tokenRecord[33m.[39musedAt)[33m.[39mtoBeDefined()[33m;[39m
     [90m     |[39m                          [31m[1m^[22m[39m
     [90m 188 |[39m       expect(tokenRecord[33m.[39musedAt)[33m.[39mtoBeInstanceOf([33mDate[39m)[33m;[39m
     [90m 189 |[39m     })[33m;[39m
     [90m 190 |[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:187:26)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ GET /auth/verify-email ‚Ä∫ should_reject_expired_token

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 206 |[39m
     [90m 207 |[39m     it([32m'should_reject_expired_token'[39m[33m,[39m [36masync[39m () [33m=>[39m {
    [31m[1m>[22m[39m[90m 208 |[39m       [36mconst[39m token [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m     |[39m                     [31m[1m^[22m[39m
     [90m 209 |[39m         data[33m:[39m {
     [90m 210 |[39m           token[33m:[39m generateVerificationToken()[33m,[39m
     [90m 211 |[39m           userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:208:21)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ GET /auth/verify-email ‚Ä∫ should_be_publicly_accessible_without_authentication

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

    [0m [90m 254 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)[33m.[39m[36mget[39m([32m`/auth/verify-email?token=${token.token}`[39m)[33m;[39m
     [90m 255 |[39m
    [31m[1m>[22m[39m[90m 256 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 257 |[39m       expect(response[33m.[39mbody[33m.[39mstatus)[33m.[39mtoBe([32m'success'[39m)[33m;[39m
     [90m 258 |[39m     })[33m;[39m
     [90m 259 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:256:31)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ POST /auth/resend-verification ‚Ä∫ should_enforce_rate_limiting

    expect(received).toBe(expected) // Object.is equality

    Expected: 500
    Received: 404

    [0m [90m 313 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)[33m;[39m
     [90m 314 |[39m
    [31m[1m>[22m[39m[90m 315 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m500[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 316 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'wait'[39m)[33m;[39m
     [90m 317 |[39m     })[33m;[39m
     [90m 318 |[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:315:31)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ GET /auth/verification-status ‚Ä∫ should_return_unverified_status_for_new_user

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 350 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)[33m;[39m
     [90m 351 |[39m
    [31m[1m>[22m[39m[90m 352 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 353 |[39m       expect(response[33m.[39mbody[33m.[39mstatus)[33m.[39mtoBe([32m'success'[39m)[33m;[39m
     [90m 354 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mverified)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 355 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39memail)[33m.[39mtoBe(testUser[33m.[39memail)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:352:31)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ GET /auth/verification-status ‚Ä∫ should_return_user_email_address

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 387 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)[33m;[39m
     [90m 388 |[39m
    [31m[1m>[22m[39m[90m 389 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 390 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39memail)[33m.[39mtoBe(testUser[33m.[39memail)[33m;[39m
     [90m 391 |[39m     })[33m;[39m
     [90m 392 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:389:31)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ Complete Email Verification Workflow ‚Ä∫ should_complete_full_registration_to_verification_flow

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 406 |[39m       [36mconst[39m registerResponse [33m=[39m [36mawait[39m request(app)[33m.[39mpost([32m'/auth/register'[39m)[33m.[39msend(newUser)[33m;[39m
     [90m 407 |[39m
    [31m[1m>[22m[39m[90m 408 |[39m       expect(registerResponse[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m     |[39m                                       [31m[1m^[22m[39m
     [90m 409 |[39m       expect(registerResponse[33m.[39mbody[33m.[39mdata[33m.[39muser[33m.[39memailVerified)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 410 |[39m
     [90m 411 |[39m       [90m// Step 2: Get verification token from database[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:408:39)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ Complete Email Verification Workflow ‚Ä∫ should_handle_resend_and_verify_workflow

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 447 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)[33m;[39m
     [90m 448 |[39m
    [31m[1m>[22m[39m[90m 449 |[39m       expect(resendResponse[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                     [31m[1m^[22m[39m
     [90m 450 |[39m
     [90m 451 |[39m       [90m// Step 4: Get new token[39m
     [90m 452 |[39m       [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mfindFirst({[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:449:37)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ Complete Email Verification Workflow ‚Ä∫ should_prevent_multiple_verification_attempts

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 471 |[39m
     [90m 472 |[39m     it([32m'should_prevent_multiple_verification_attempts'[39m[33m,[39m [36masync[39m () [33m=>[39m {
    [31m[1m>[22m[39m[90m 473 |[39m       [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m     |[39m                           [31m[1m^[22m[39m
     [90m 474 |[39m         data[33m:[39m {
     [90m 475 |[39m           token[33m:[39m generateVerificationToken()[33m,[39m
     [90m 476 |[39m           userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:473:27)

  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:16] info: [POST] /auth/logout - 200
[2025-12-12 06:13:16] info: [POST] /auth/register
[2025-12-12 06:13:16] warn: [ownership] Missing user for horse ownership check
[2025-12-12 06:13:16] warn: [ownership] Missing user for horse ownership check
[2025-12-12 06:13:16] warn: [ownership] Missing user for horse ownership check
[2025-12-12 06:13:16] warn: [ownership] Invalid horse ID: invalid
[2025-12-12 06:13:16] warn: [TokenRotation] Skipping refresh token persistence in test env
[2025-12-12 06:13:16] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:16] warn: [ownership] Invalid horse ID: -5
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:16] error: [EmailVerification] Error creating verification token: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:16] error: [authController.register] Error registering user: 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:16] error: [POST] /auth/register - ERROR
[2025-12-12 06:13:16] error: Error 
Invalid `prisma.emailVerificationToken.create()` invocation:


Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`
[2025-12-12 06:13:16] info: [POST] /auth/register - 500
[2025-12-12 06:13:16] warn: [ownership] horse 0 not found or not owned by user user-123
[2025-12-12 06:13:16] error: ‚ùå Environment validation failed:
[2025-12-12 06:13:16] error:   - Missing required environment variable: DATABASE_URL
[2025-12-12 06:13:16] error:   - Missing required environment variable: JWT_SECRET
[2025-12-12 06:13:16] error:   - NODE_ENV must be one of: development, production, test (current: invalid)
[2025-12-12 06:13:16] error:   - PORT must be a number (current: abc)
[2025-12-12 06:13:16] error: 
Please fix the above errors in your .env file and restart.
[2025-12-12 06:13:16] info: ‚úÖ Environment validation passed
[2025-12-12 06:13:16] warn: [ownership] Invalid horse ID: 1.5
[2025-12-12 06:13:16] info: [ownership] Validated ownership: user user-123 owns horse 1
[2025-12-12 06:13:16] warn: [validateEnvironment] SECURITY WARNING: ALLOWED_ORIGINS contains HTTP URLs in production
[2025-12-12 06:13:16] info: [POST] /auth/register
[2025-12-12 06:13:16] warn:   HTTP origins detected: http://example.com
[2025-12-12 06:13:16] warn:   These should be HTTPS in production to prevent man-in-the-middle attacks
[2025-12-12 06:13:16] warn: [validateEnvironment] SECURITY WARNING: PORT is set to 80 (HTTP) in production
[2025-12-12 06:13:16] warn:   Consider using HTTPS (443) or a reverse proxy with HTTPS termination
[2025-12-12 06:13:16] error: ‚ùå Environment validation failed:
[2025-12-12 06:13:16] error:   - JWT_SECRET must be at least 32 characters (current: 17)
[2025-12-12 06:13:16] error:   - JWT_SECRET appears to be a placeholder value. Please generate a real secret.
[2025-12-12 06:13:16] error:   - DATABASE_URL contains a weak password. Please use a strong password.
[2025-12-12 06:13:16] error: 
Please fix the above errors in your .env file and restart.
[2025-12-12 06:13:16] info: ‚úÖ Environment validation passed
[2025-12-12 06:13:16] warn: [ownership] horse 1 not found or not owned by user user-123
[2025-12-12 06:13:16] info: ‚úÖ Environment validation passed
[2025-12-12 06:13:16] warn: [ownership] horse 1 not found or not owned by user user-123
[2025-12-12 06:13:16] info: [ownership] Validated ownership: user user-123 owns horse 42
[2025-12-12 06:13:16] info: [ownership] Validated ownership: user user-123 owns horse 1
[2025-12-12 06:13:16] info: [ownership] Validated ownership: user user-123 owns horse 1
[2025-12-12 06:13:16] info: [ownership] Validated ownership: user user-123 owns foal 1
[2025-12-12 06:13:16] info: [ownership] Validated ownership: user user-123 owns groom 1
[2025-12-12 06:13:16] info: [ownership] Validated ownership: user user-123 owns groom-assignment 1
[2025-12-12 06:13:16] info: [ownership] Validated ownership: user user-123 owns breeding 1
  console.info
    [PrismaClient] Jest cleanup registered successfully.

      at ../packages/database/prismaClient.mjs:55:13

[2025-12-12 06:13:16] info: [ownership] Validated ownership: user user-123 owns competition-entry 1
[2025-12-12 06:13:16] info: [ownership] Validated ownership: user user-123 owns training-session 1
[2025-12-12 06:13:16] error: [ownership] Unexpected error: Database connection error

ReferenceError: You are trying to `import` a file after the Jest environment has been torn down. From __tests__/unit/cacheHelper.test.mjs.



ReferenceError: You are trying to `import` a file after the Jest environment has been torn down. From __tests__/unit/cacheHelper.test.mjs.


FAIL __tests__/unit/cacheHelper.test.mjs
  ‚óè Test suite failed to run

    Cannot find module 'vitest' from '__tests__/unit/cacheHelper.test.mjs'

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)

[2025-12-12 06:13:16] error: [ownership] Invalid resource type: invalid-resource
[2025-12-12 06:13:16] error: [ownership] Unexpected error: Query failed
[2025-12-12 06:13:16] warn: [ownership] horse 1 not found or not owned by user user-123
[2025-12-12 06:13:16] info: [ownership] Found owned horse 1 for user user-123
[2025-12-12 06:13:16] warn: [ownership] horse 999 not found or not owned by user user-123
[2025-12-12 06:13:16] warn: [ownership] horse 1 not found or not owned by user different-user
[2025-12-12 06:13:16] info: [ownership] Found owned horse 1 for user user-123
[2025-12-12 06:13:16] error: [ownership] Error finding owned horse: Database error
[2025-12-12 06:13:16] info: [ownership] Found owned groom 5 for user user-456
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [ownership] Batch validation: user user-123 owns 3/3 horses
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [ownership] Batch validation: user user-123 owns 2/3 horses
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] warn: [Validation] Input validation failed
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [ownership] Batch validation: user different-user owns 0/3 horses
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [ownership] Batch validation: user user-123 owns 1/1 horses
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] error: [ownership] Error in batch validation: Database error
[2025-12-12 06:13:16] info: [MemoryManager] Starting memory and resource monitoring
[2025-12-12 06:13:16] info: [ownership] Batch validation: user user-456 owns 2/2 grooms
[2025-12-12 06:13:16] info: [MemoryManager] Stopping memory and resource monitoring
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [ownership] Batch validation: user user-123 owns 0/0 horses
[2025-12-12 06:13:16] warn: [ownership] horse 1 not found or not owned by user user-123
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [ownership] Validated ownership: user user-123 owns horse 1
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [ownership] Validated ownership: user user-123 owns horse 1
[2025-12-12 06:13:16] warn: [ownership] horse 42 not found or not owned by user user-123
[2025-12-12 06:13:16] info: [ownership] Validated ownership: user user-123 owns horse 1
PASS __tests__/unit/security/validate-environment.test.mjs
  validateEnvironment
    ‚àö throws when required envs are missing or invalid (17 ms)
    ‚àö warns about weak JWT secrets and HTTP origins in production (15 ms)
    ‚àö passes for valid configuration (12 ms)

[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
PASS __tests__/unit/security/session-management.test.mjs
  sessionManagement middleware
    sessionTimeout
      ‚àö allows when no session (9 ms)
      ‚àö blocks expired session (19 ms)
      ‚àö refreshes active session (6 ms)
    sessionConcurrencyLimit
      ‚àö allows when no limit set (6 ms)
      ‚àö blocks when concurrency exceeded (12 ms)
    sessionCleanup
      ‚àö removes expired sessions and continues (15 ms)

[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
(node:21512) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 exit listeners added to [process]. MaxListeners is 10. Use emitter.setMaxListeners() to increase limit
(node:21512) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 SIGTERM listeners added to [process]. MaxListeners is 10. Use emitter.setMaxListeners() to increase limit
(node:21512) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 SIGINT listeners added to [process]. MaxListeners is 10. Use emitter.setMaxListeners() to increase limit
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 1 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
(node:21512) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 uncaughtException listeners added to [process]. MaxListeners is 10. Use emitter.setMaxListeners() to increase limit
(node:21512) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 unhandledRejection listeners added to [process]. MaxListeners is 10. Use emitter.setMaxListeners() to increase limit
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 2 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 3 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 1 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] warn: [MemoryManager] Potential memory leak detected: 2MB per sample
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] warn: [MemoryManager] Memory threshold alert: 90MB used
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 1 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 1 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting memory and resource monitoring
[2025-12-12 06:13:16] info: [MemoryManager] Stopping memory and resource monitoring
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting memory and resource monitoring
[2025-12-12 06:13:16] info: [MemoryManager] Stopping memory and resource monitoring
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
[2025-12-12 06:13:16] info: [MemoryManager] Starting resource cleanup
[2025-12-12 06:13:16] info: [MemoryManager] Resource cleanup completed: 0 resources cleaned
PASS __tests__/unit/security/validation-error-handler.test.mjs
  validationErrorHandler
    ‚àö passes through when no errors (7 ms)
    ‚àö returns 400 on validation errors (8 ms)
    ‚àö sanitizes request body by keeping only validated fields (4 ms)

PASS __tests__/middleware/ownership.test.mjs
  Ownership Middleware
    requireOwnership()
      Authentication validation
        ‚àö should return 401 if user is not authenticated (13 ms)
        ‚àö should return 401 if user.id is missing (4 ms)
        ‚àö should return 401 if user object is undefined (4 ms)
      Resource ID validation
        ‚àö should return 400 if resource ID is not a number (15 ms)
        ‚àö should return 400 if resource ID is negative (6 ms)
        ‚àö should return 404 if resource ID is zero (parseInt converts but DB query fails) (10 ms)
        ‚àö should return 400 for decimal IDs (13 ms)
      Ownership validation - Horse
        ‚àö should allow access to owned horse (9 ms)
        ‚àö should return 404 if horse does not exist (8 ms)
        ‚àö should return 404 if horse exists but not owned by user (8 ms)
        ‚àö should use custom idParam option (4 ms)
        ‚àö should include relations when specified (3 ms)
        ‚àö should include multiple relations (3 ms)
      Ownership validation - Other resource types
        ‚àö should validate foal ownership (8 ms)
        ‚àö should validate groom ownership (4 ms)
        ‚àö should validate groom-assignment ownership (8 ms)
        ‚àö should validate breeding ownership (3 ms)
        ‚àö should validate competition-entry ownership (4 ms)
        ‚àö should validate training-session ownership (3 ms)
      Error handling
        ‚àö should handle database errors gracefully (4 ms)
        ‚àö should handle invalid resource type (5 ms)
        ‚àö should handle Prisma query errors (5 ms)
      Required option
        ‚àö should allow missing resource when required=false (2 ms)
        ‚àö should block missing resource when required=true (default) (2 ms)
    findOwnedResource()
      ‚àö should return owned horse (4 ms)
      ‚àö should return null if horse not found (3 ms)
      ‚àö should return null if horse not owned by user (1 ms)
      ‚àö should include relations when specified (2 ms)
      ‚àö should handle database errors (6 ms)
      ‚àö should work with different resource types (2 ms)
    validateBatchOwnership()
      ‚àö should return all owned horses (5 ms)
      ‚àö should return partial results if some horses not owned (3 ms)
      ‚àö should return empty array if no horses owned (3 ms)
      ‚àö should include relations when specified (2 ms)
      ‚àö should handle database errors (2 ms)
      ‚àö should work with different resource types (3 ms)
      ‚àö should handle empty resource ID array (3 ms)
    Security tests
      ‚àö should prevent ownership disclosure (CWE-639) (2 ms)
      ‚àö should prevent TOCTOU vulnerabilities (3 ms)
      ‚àö should use atomic ownership validation (2 ms)
      ‚àö should prevent parameter tampering (2 ms)
      ‚àö should validate user ID from token, not from request params (2 ms)

[2025-12-12 06:13:16] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:16] info: [EmailVerification] Created verification token
[2025-12-12 06:13:16] info: [EmailService] Email verification (DEV MODE - not sent)
  console.log
    
    === EMAIL VERIFICATION (DEV MODE) ===

      at sendVerificationEmail (utils/emailService.mjs:227:15)

  console.log
    To: logoutcookietest@test.com

      at sendVerificationEmail (utils/emailService.mjs:228:15)

  console.log
    Subject: Verify Your Email Address - Equoria

      at sendVerificationEmail (utils/emailService.mjs:229:15)

  console.log
    Verification URL: http://localhost:3000/verify-email?token=30eccbad86477fc0f5fdbf79ebcedd30fc4d7ba957468fdaaa9682e5e717dc9c

      at sendVerificationEmail (utils/emailService.mjs:230:15)

  console.log
    =====================================

      at sendVerificationEmail (utils/emailService.mjs:231:15)

[2025-12-12 06:13:16] info: [authController.register] Verification email sent
[2025-12-12 06:13:16] info: [POST] /auth/register - 201
PASS __tests__/services/memoryResourceManagement.test.mjs
  Memory and Resource Management System
    Memory Manager Initialization
      ‚àö creates memory manager with default options (9 ms)
      ‚àö creates memory manager with custom options (7 ms)
      ‚àö returns singleton instance (3 ms)
    Memory Monitoring
      ‚àö starts and stops monitoring correctly (6 ms)
      ‚àö collects memory metrics correctly (4 ms)
      ‚àö stores memory metrics history (2 ms)
      ‚àö limits memory metrics history to 1000 entries (22 ms)
    Resource Tracking
      ‚àö tracks and untracks timers correctly (8 ms)
      ‚àö tracks and untracks intervals correctly (3 ms)
      ‚àö tracks event listeners correctly (3 ms)
      ‚àö gets resource counts correctly (2 ms)
    Resource Cleanup
      ‚àö cleans up all tracked resources (2 ms)
      ‚àö handles cleanup errors gracefully (2 ms)
    Memory Leak Detection
      ‚àö calculates memory trend correctly (2 ms)
      ‚àö detects memory leaks with consistent growth (3 ms)
    Memory Threshold Monitoring
      ‚àö triggers alert when memory threshold exceeded (2 ms)
      ‚àö does not trigger alert when memory is below threshold (2 ms)
    Garbage Collection
      ‚àö optimizes garbage collection when available (1 ms)
      ‚àö handles GC unavailability gracefully (2 ms)
    Comprehensive Report Generation
      ‚àö generates complete memory and resource report (3 ms)
    Helper Functions
      ‚àö trackResource helper function works correctly (2 ms)
      ‚àö untrackResource helper function works correctly (2 ms)
      ‚àö getMemoryReport helper function works correctly (2 ms)
      ‚àö initializeMemoryManagement starts monitoring (3 ms)
    Event Handling
      ‚àö emits monitoring events correctly (2 ms)
      ‚àö emits metrics collection events (2 ms)

[2025-12-12 06:13:16] info: [POST] /auth/login
[2025-12-12 06:13:16] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:16] info: [POST] /auth/login - 200
[2025-12-12 06:13:16] info: [POST] /auth/logout
[2025-12-12 06:13:16] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:16] info: [EmailVerification] Created verification token
[2025-12-12 06:13:16] info: [EmailService] Email verification (DEV MODE - not sent)
  console.log
    
    === EMAIL VERIFICATION (DEV MODE) ===

      at sendVerificationEmail (utils/emailService.mjs:227:15)

  console.log
    To: csrftest1765537996396@test.com

      at sendVerificationEmail (utils/emailService.mjs:228:15)

  console.log
    Subject: Verify Your Email Address - Equoria

      at sendVerificationEmail (utils/emailService.mjs:229:15)

  console.log
    Verification URL: http://localhost:3000/verify-email?token=052a30bbde8e8593bc9570b0f019d8f45541b9bff3d2a628e7bed1fca8c567b2

      at sendVerificationEmail (utils/emailService.mjs:230:15)

  console.log
    =====================================

      at sendVerificationEmail (utils/emailService.mjs:231:15)

[2025-12-12 06:13:16] info: [authController.register] Verification email sent
[2025-12-12 06:13:16] info: [POST] /auth/register - 201
[2025-12-12 06:13:16] info: [POST] /api/users/me
[2025-12-12 06:13:16] info: [auth] Authenticated user d069b090-634c-4429-96f5-2974351c2354 for POST /users/me
[2025-12-12 06:13:16] info: [POST] /api/users/me - 403
[2025-12-12 06:13:16] info: [POST] /auth/register
[2025-12-12 06:13:16] info: [POST] /auth/logout - 200
[2025-12-12 06:13:16] info: [POST] /auth/register
[2025-12-12 06:13:17] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:17] info: [EmailVerification] Created verification token
[2025-12-12 06:13:17] info: [EmailService] Email verification (DEV MODE - not sent)
  console.log
    
    === EMAIL VERIFICATION (DEV MODE) ===

      at sendVerificationEmail (utils/emailService.mjs:227:15)

  console.log
    To: logoutcookietest@test.com

      at sendVerificationEmail (utils/emailService.mjs:228:15)

  console.log
    Subject: Verify Your Email Address - Equoria

      at sendVerificationEmail (utils/emailService.mjs:229:15)

  console.log
    Verification URL: http://localhost:3000/verify-email?token=aab6d25f3e06f74330064cc62110bfb56c8c7dfbb4413f1e114a1422cd38ca2b

      at sendVerificationEmail (utils/emailService.mjs:230:15)

  console.log
    =====================================

      at sendVerificationEmail (utils/emailService.mjs:231:15)

[2025-12-12 06:13:17] info: [authController.register] Verification email sent
[2025-12-12 06:13:17] info: [POST] /auth/register - 201
[2025-12-12 06:13:17] info: [POST] /auth/login
[2025-12-12 06:13:17] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:17] info: [POST] /auth/login - 200
[2025-12-12 06:13:17] info: [POST] /auth/logout
[2025-12-12 06:13:17] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:17] info: [EmailVerification] Created verification token
[2025-12-12 06:13:17] info: [EmailService] Email verification (DEV MODE - not sent)
  console.log
    
    === EMAIL VERIFICATION (DEV MODE) ===

      at sendVerificationEmail (utils/emailService.mjs:227:15)

  console.log
    To: csrftest1765537996803@test.com

      at sendVerificationEmail (utils/emailService.mjs:228:15)

  console.log
    Subject: Verify Your Email Address - Equoria

      at sendVerificationEmail (utils/emailService.mjs:229:15)

  console.log
    Verification URL: http://localhost:3000/verify-email?token=1ea2dd62b2d9cb64b646901d1e3e887cf30f07fd29e5cdeabe5f1f2f978b6a86

      at sendVerificationEmail (utils/emailService.mjs:230:15)

  console.log
    =====================================

      at sendVerificationEmail (utils/emailService.mjs:231:15)

[2025-12-12 06:13:17] info: [authController.register] Verification email sent
[2025-12-12 06:13:17] info: [POST] /auth/register - 201
[2025-12-12 06:13:17] info: [POST] /auth/register
[2025-12-12 06:13:17] info: [POST] /auth/logout - 200
[2025-12-12 06:13:17] info: [POST] /auth/register
[2025-12-12 06:13:17] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:17] info: [EmailVerification] Created verification token
[2025-12-12 06:13:17] info: [EmailService] Email verification (DEV MODE - not sent)
  console.log
    
    === EMAIL VERIFICATION (DEV MODE) ===

      at sendVerificationEmail (utils/emailService.mjs:227:15)

  console.log
    To: csrftest1765537997183@test.com

      at sendVerificationEmail (utils/emailService.mjs:228:15)

  console.log
    Subject: Verify Your Email Address - Equoria

      at sendVerificationEmail (utils/emailService.mjs:229:15)

  console.log
    Verification URL: http://localhost:3000/verify-email?token=bcedb5345896923a3315daa780fa7b0ce838544c43b57811f53ae293942d54df

      at sendVerificationEmail (utils/emailService.mjs:230:15)

  console.log
    =====================================

      at sendVerificationEmail (utils/emailService.mjs:231:15)

[2025-12-12 06:13:17] info: [authController.register] Verification email sent
[2025-12-12 06:13:17] info: [POST] /auth/register - 201
[2025-12-12 06:13:17] info: [POST] /auth/login
[2025-12-12 06:13:17] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:17] info: [EmailVerification] Created verification token
[2025-12-12 06:13:17] info: [EmailService] Email verification (DEV MODE - not sent)
  console.log
    
    === EMAIL VERIFICATION (DEV MODE) ===

      at sendVerificationEmail (utils/emailService.mjs:227:15)

  console.log
    To: securitytest1@test.com

      at sendVerificationEmail (utils/emailService.mjs:228:15)

  console.log
    Subject: Verify Your Email Address - Equoria

      at sendVerificationEmail (utils/emailService.mjs:229:15)

  console.log
    Verification URL: http://localhost:3000/verify-email?token=b9443f823d694a14dc0d22e0ed8544b841297e1076fc459f40f4bd4a47663b86

      at sendVerificationEmail (utils/emailService.mjs:230:15)

  console.log
    =====================================

      at sendVerificationEmail (utils/emailService.mjs:231:15)

[2025-12-12 06:13:17] info: [authController.register] Verification email sent
[2025-12-12 06:13:17] info: [POST] /auth/register - 201
[2025-12-12 06:13:17] info: [POST] /auth/login
[2025-12-12 06:13:17] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:17] info: [POST] /auth/login - 200
[2025-12-12 06:13:17] info: [POST] /auth/refresh-token
[2025-12-12 06:13:17] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:17] info: [POST] /auth/refresh-token - 200
[2025-12-12 06:13:17] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:17] warn: [AuthRateLimiter] resetAuthRateLimit() is deprecated with Redis
[2025-12-12 06:13:17] info: [POST] /auth/login - 200
[2025-12-12 06:13:17] info: [POST] /auth/register
FAIL __tests__/integration/cookieIntegration.test.mjs (13.606 s)
  Cookie Integration Tests
    Registration Endpoint Cookies
      √ó should set accessToken cookie with correct attributes (635 ms)
      ‚àö should set refreshToken cookie with correct attributes (581 ms)
      ‚àö should set both cookies in a single response (555 ms)
    Login Endpoint Cookies
      ‚àö should set cookies on successful login (1680 ms)
      ‚àö should set accessToken cookie with correct attributes on login (673 ms)
      ‚àö should set refreshToken cookie with correct attributes on login (703 ms)
    Token Refresh Endpoint Cookies
      ‚àö should set new cookies on token refresh (836 ms)
      ‚àö should set new accessToken cookie with correct attributes (855 ms)
      √ó should set new refreshToken cookie with correct attributes (825 ms)
    Logout Endpoint Cookie Clearing
      ‚àö should clear accessToken cookie on logout (726 ms)
      √ó should clear refreshToken cookie on logout (538 ms)
      √ó should maintain same path when clearing cookies (414 ms)
    Cookie Security Attributes
      ‚àö should use consistent security attributes across all endpoints (480 ms)

  ‚óè Cookie Integration Tests ‚Ä∫ Registration Endpoint Cookies ‚Ä∫ should set accessToken cookie with correct attributes

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 73 |[39m       })[33m;[39m
     [90m 74 |[39m
    [31m[1m>[22m[39m[90m 75 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                               [31m[1m^[22m[39m
     [90m 76 |[39m
     [90m 77 |[39m       [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m][33m;[39m
     [90m 78 |[39m       expect(cookies)[33m.[39mtoBeDefined()[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/cookieIntegration.test.mjs:75:31)

  ‚óè Cookie Integration Tests ‚Ä∫ Token Refresh Endpoint Cookies ‚Ä∫ should set new refreshToken cookie with correct attributes

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 42 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 43 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 44 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 45 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 46 |[39m       })[33m;[39m
     [90m 47 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/cookieIntegration.test.mjs:44:7)

  ‚óè Cookie Integration Tests ‚Ä∫ Logout Endpoint Cookie Clearing ‚Ä∫ should clear refreshToken cookie on logout

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 42 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 43 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 44 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 45 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 46 |[39m       })[33m;[39m
     [90m 47 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/cookieIntegration.test.mjs:44:7)

  ‚óè Cookie Integration Tests ‚Ä∫ Logout Endpoint Cookie Clearing ‚Ä∫ should maintain same path when clearing cookies

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 42 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 43 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 44 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 45 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 46 |[39m       })[33m;[39m
     [90m 47 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/cookieIntegration.test.mjs:44:7)

[2025-12-12 06:13:18] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:18] info: [EmailVerification] Created verification token
[2025-12-12 06:13:18] info: [EmailService] Email verification (DEV MODE - not sent)
  console.log
    
    === EMAIL VERIFICATION (DEV MODE) ===

      at sendVerificationEmail (utils/emailService.mjs:227:15)

  console.log
    To: csrftest1765537997874@test.com

      at sendVerificationEmail (utils/emailService.mjs:228:15)

  console.log
    Subject: Verify Your Email Address - Equoria

      at sendVerificationEmail (utils/emailService.mjs:229:15)

  console.log
    Verification URL: http://localhost:3000/verify-email?token=460bea7b8e1f2c9f5b5dd020a203918c32e08d032b619f46a05fecd8e44294ec

      at sendVerificationEmail (utils/emailService.mjs:230:15)

  console.log
    =====================================

      at sendVerificationEmail (utils/emailService.mjs:231:15)

[2025-12-12 06:13:18] info: [authController.register] Verification email sent
[2025-12-12 06:13:18] info: [POST] /auth/register - 201
[2025-12-12 06:13:18] info: [POST] /auth/register
[2025-12-12 06:13:18] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:18] info: [EmailVerification] Created verification token
[2025-12-12 06:13:18] info: [EmailService] Email verification (DEV MODE - not sent)
  console.log
    
    === EMAIL VERIFICATION (DEV MODE) ===

      at sendVerificationEmail (utils/emailService.mjs:227:15)

  console.log
    To: newuser1765537998222@test.com

      at sendVerificationEmail (utils/emailService.mjs:228:15)

  console.log
    Subject: Verify Your Email Address - Equoria

      at sendVerificationEmail (utils/emailService.mjs:229:15)

  console.log
    Verification URL: http://localhost:3000/verify-email?token=37def4e1f7096e6889f916fa6be9b59677f8e5eb145123dceda7d1e97844bdf1

      at sendVerificationEmail (utils/emailService.mjs:230:15)

  console.log
    =====================================

      at sendVerificationEmail (utils/emailService.mjs:231:15)

[2025-12-12 06:13:18] info: [authController.register] Verification email sent
[2025-12-12 06:13:18] info: [POST] /auth/register - 201
[2025-12-12 06:13:18] info: [POST] /auth/register
[2025-12-12 06:13:18] info: [TokenRotation] Created new token pair
[2025-12-12 06:13:18] info: [EmailVerification] Created verification token
[2025-12-12 06:13:18] info: [EmailService] Email verification (DEV MODE - not sent)
  console.log
    
    === EMAIL VERIFICATION (DEV MODE) ===

      at sendVerificationEmail (utils/emailService.mjs:227:15)

  console.log
    To: csrftest1765537998580@test.com

      at sendVerificationEmail (utils/emailService.mjs:228:15)

  console.log
    Subject: Verify Your Email Address - Equoria

      at sendVerificationEmail (utils/emailService.mjs:229:15)

  console.log
    Verification URL: http://localhost:3000/verify-email?token=1b8f3d727e0b54ed8560e0b9bd49c9d034c8e14787291f819a2b074ae0dd1115

      at sendVerificationEmail (utils/emailService.mjs:230:15)

  console.log
    =====================================

      at sendVerificationEmail (utils/emailService.mjs:231:15)

[2025-12-12 06:13:18] info: [authController.register] Verification email sent
[2025-12-12 06:13:18] info: [POST] /auth/register - 201
[2025-12-12 06:13:18] info: [POST] /auth/forgot-password
[2025-12-12 06:13:18] warn: 404 - Route not found: POST /auth/forgot-password from ::ffff:127.0.0.1
[2025-12-12 06:13:18] info: [POST] /auth/forgot-password - 404
FAIL __tests__/integration/csrf-integration.test.mjs (17.602 s)
  CSRF Protection Integration Tests
    CSRF Token Acquisition
      √ó should get CSRF token from /auth/csrf-token endpoint (679 ms)
      √ó should set CSRF token in cookie (529 ms)
      ‚àö should generate unique tokens for different requests (648 ms)
    CSRF Protection for State-Changing Operations
      √ó should reject POST request without CSRF token (639 ms)
      ‚àö should reject PUT request without CSRF token (549 ms)
      √ó should reject DELETE request without CSRF token (1152 ms)
      √ó should reject PATCH request without CSRF token (511 ms)
    Safe HTTP Methods (No CSRF Required)
      √ó should allow GET requests without CSRF token (578 ms)
      √ó should allow HEAD requests without CSRF token (565 ms)
      √ó should allow OPTIONS requests without CSRF token (507 ms)
    CSRF Error Messages
      √ó should provide clear error message for missing token (497 ms)
      √ó should include error code in response (515 ms)
      √ó should return 403 status for CSRF failures (586 ms)
    CSRF Token Lifecycle
      √ó should accept newly generated token (591 ms)
      √ó should generate new token on each request to /auth/csrf-token (502 ms)
    CORS and CSRF Integration
      ‚àö should require X-CSRF-Token header for cross-origin requests (414 ms)
      ‚àö should allow CORS preflight without CSRF token (380 ms)
    Public Endpoints (No CSRF)
      ‚àö should not require CSRF token for login (691 ms)
      ‚àö should not require CSRF token for registration (707 ms)
      ‚àö should not require CSRF token for password reset request (362 ms)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Token Acquisition ‚Ä∫ should get CSRF token from /auth/csrf-token endpoint

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 52 |[39m       })[33m;[39m
     [90m 53 |[39m
    [31m[1m>[22m[39m[90m 54 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 55 |[39m
     [90m 56 |[39m     [90m// Extract accessToken from cookie[39m
     [90m 57 |[39m     [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m] [33m||[39m [][33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:54:29)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Token Acquisition ‚Ä∫ should set CSRF token in cookie

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 52 |[39m       })[33m;[39m
     [90m 53 |[39m
    [31m[1m>[22m[39m[90m 54 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 55 |[39m
     [90m 56 |[39m     [90m// Extract accessToken from cookie[39m
     [90m 57 |[39m     [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m] [33m||[39m [][33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:54:29)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Protection for State-Changing Operations ‚Ä∫ should reject POST request without CSRF token

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 71 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 72 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 73 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 74 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 75 |[39m       })[33m;[39m
     [90m 76 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:73:7)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Protection for State-Changing Operations ‚Ä∫ should reject DELETE request without CSRF token

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 52 |[39m       })[33m;[39m
     [90m 53 |[39m
    [31m[1m>[22m[39m[90m 54 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 55 |[39m
     [90m 56 |[39m     [90m// Extract accessToken from cookie[39m
     [90m 57 |[39m     [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m] [33m||[39m [][33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:54:29)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Protection for State-Changing Operations ‚Ä∫ should reject PATCH request without CSRF token

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 71 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 72 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 73 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 74 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 75 |[39m       })[33m;[39m
     [90m 76 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:73:7)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ Safe HTTP Methods (No CSRF Required) ‚Ä∫ should allow GET requests without CSRF token

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 52 |[39m       })[33m;[39m
     [90m 53 |[39m
    [31m[1m>[22m[39m[90m 54 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 55 |[39m
     [90m 56 |[39m     [90m// Extract accessToken from cookie[39m
     [90m 57 |[39m     [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m] [33m||[39m [][33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:54:29)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ Safe HTTP Methods (No CSRF Required) ‚Ä∫ should allow GET requests without CSRF token

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 71 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 72 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 73 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 74 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 75 |[39m       })[33m;[39m
     [90m 76 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:73:7)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ Safe HTTP Methods (No CSRF Required) ‚Ä∫ should allow HEAD requests without CSRF token

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 52 |[39m       })[33m;[39m
     [90m 53 |[39m
    [31m[1m>[22m[39m[90m 54 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 55 |[39m
     [90m 56 |[39m     [90m// Extract accessToken from cookie[39m
     [90m 57 |[39m     [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m] [33m||[39m [][33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:54:29)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ Safe HTTP Methods (No CSRF Required) ‚Ä∫ should allow HEAD requests without CSRF token

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 71 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 72 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 73 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 74 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 75 |[39m       })[33m;[39m
     [90m 76 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:73:7)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ Safe HTTP Methods (No CSRF Required) ‚Ä∫ should allow OPTIONS requests without CSRF token

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 52 |[39m       })[33m;[39m
     [90m 53 |[39m
    [31m[1m>[22m[39m[90m 54 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 55 |[39m
     [90m 56 |[39m     [90m// Extract accessToken from cookie[39m
     [90m 57 |[39m     [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m] [33m||[39m [][33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:54:29)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ Safe HTTP Methods (No CSRF Required) ‚Ä∫ should allow OPTIONS requests without CSRF token

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 71 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 72 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 73 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 74 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 75 |[39m       })[33m;[39m
     [90m 76 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:73:7)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Error Messages ‚Ä∫ should provide clear error message for missing token

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 52 |[39m       })[33m;[39m
     [90m 53 |[39m
    [31m[1m>[22m[39m[90m 54 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 55 |[39m
     [90m 56 |[39m     [90m// Extract accessToken from cookie[39m
     [90m 57 |[39m     [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m] [33m||[39m [][33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:54:29)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Error Messages ‚Ä∫ should provide clear error message for missing token

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 71 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 72 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 73 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 74 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 75 |[39m       })[33m;[39m
     [90m 76 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:73:7)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Error Messages ‚Ä∫ should include error code in response

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 52 |[39m       })[33m;[39m
     [90m 53 |[39m
    [31m[1m>[22m[39m[90m 54 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 55 |[39m
     [90m 56 |[39m     [90m// Extract accessToken from cookie[39m
     [90m 57 |[39m     [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m] [33m||[39m [][33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:54:29)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Error Messages ‚Ä∫ should include error code in response

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 71 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 72 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 73 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 74 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 75 |[39m       })[33m;[39m
     [90m 76 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:73:7)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Error Messages ‚Ä∫ should return 403 status for CSRF failures

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 71 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 72 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 73 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 74 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 75 |[39m       })[33m;[39m
     [90m 76 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:73:7)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Token Lifecycle ‚Ä∫ should accept newly generated token

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 52 |[39m       })[33m;[39m
     [90m 53 |[39m
    [31m[1m>[22m[39m[90m 54 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 55 |[39m
     [90m 56 |[39m     [90m// Extract accessToken from cookie[39m
     [90m 57 |[39m     [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m] [33m||[39m [][33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:54:29)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Token Lifecycle ‚Ä∫ should accept newly generated token

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 71 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 72 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 73 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 74 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 75 |[39m       })[33m;[39m
     [90m 76 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:73:7)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Token Lifecycle ‚Ä∫ should generate new token on each request to /auth/csrf-token

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 52 |[39m       })[33m;[39m
     [90m 53 |[39m
    [31m[1m>[22m[39m[90m 54 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 55 |[39m
     [90m 56 |[39m     [90m// Extract accessToken from cookie[39m
     [90m 57 |[39m     [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m] [33m||[39m [][33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:54:29)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Token Lifecycle ‚Ä∫ should generate new token on each request to /auth/csrf-token

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 71 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 72 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 73 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 74 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 75 |[39m       })[33m;[39m
     [90m 76 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:73:7)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
-----------------------------|---------|----------|---------|---------|----------------------------
File                         | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s          
-----------------------------|---------|----------|---------|---------|----------------------------
All files                    |   94.93 |    89.88 |   96.29 |   94.71 |                            
 middleware                  |   93.44 |    87.78 |   95.65 |   93.18 |                            
  security.mjs               |     100 |       96 |     100 |     100 | 22                         
  sessionManagement.mjs      |   87.75 |    81.08 |    92.3 |   87.62 | 45,136-139,185-207,316-321 
  validationErrorHandler.mjs |     100 |    96.87 |     100 |     100 | 26                         
 utils                       |     100 |    95.74 |     100 |     100 |                            
  validateEnvironment.mjs    |     100 |    95.74 |     100 |     100 | 101,118                    
-----------------------------|---------|----------|---------|---------|----------------------------
Summary of all failing tests
FAIL __tests__/unit/security/token-validation.test.mjs
  ‚óè Token Validation Unit Tests ‚Ä∫ Malformed Token Scenarios ‚Ä∫ should reject null token

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Invalid or expired token",
    -   "status": Anything,
    +   "message": "Access token is required",
    +   "status": "error",
        "success": false,
      },

    Number of calls: 1

    [0m [90m 114 |[39m         expect(next)[33m.[39mnot[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m 115 |[39m         expect(res[33m.[39mstatus)[33m.[39mtoHaveBeenCalledWith([35m401[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 116 |[39m         expect(res[33m.[39mjson)[33m.[39mtoHaveBeenCalledWith({
     [90m     |[39m                          [31m[1m^[22m[39m
     [90m 117 |[39m           success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 118 |[39m           message[33m:[39m [32m'Invalid or expired token'[39m[33m,[39m
     [90m 119 |[39m           status[33m:[39m expect[33m.[39manything()[33m,[39m[0m

      at Timeout._onTimeout (__tests__/unit/security/token-validation.test.mjs:116:26)

FAIL __tests__/services/cronJobService.test.mjs
  ‚óè Cron Job Service ‚Ä∫ triggerTokenCleanup() - Manual Execution ‚Ä∫ should remove expired tokens

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

    [0m [90m 167 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m triggerTokenCleanup()[33m;[39m
     [90m 168 |[39m
    [31m[1m>[22m[39m[90m 169 |[39m       expect(result[33m.[39mremoved)[33m.[39mtoBe([35m1[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 170 |[39m
     [90m 171 |[39m       [90m// Verify token was deleted[39m
     [90m 172 |[39m       [36mconst[39m deletedToken [33m=[39m [36mawait[39m prisma[33m.[39mrefreshToken[33m.[39mfindUnique({[0m

      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:169:30)

  ‚óè Cron Job Service ‚Ä∫ triggerTokenCleanup() - Manual Execution ‚Ä∫ should NOT remove valid tokens

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 178 |[39m     it([32m'should NOT remove valid tokens'[39m[33m,[39m [36masync[39m () [33m=>[39m {
     [90m 179 |[39m       [90m// Create valid token (expires in 7 days)[39m
    [31m[1m>[22m[39m[90m 180 |[39m       [36mconst[39m validToken [33m=[39m [36mawait[39m createTestRefreshToken(user[33m.[39mid[33m,[39m {
     [90m     |[39m                          [31m[1m^[22m[39m
     [90m 181 |[39m         expiresAt[33m:[39m [36mnew[39m [33mDate[39m([33mDate[39m[33m.[39mnow() [33m+[39m [35m7[39m [33m*[39m [35m24[39m [33m*[39m [35m60[39m [33m*[39m [35m60[39m [33m*[39m [35m1000[39m)[33m,[39m
     [90m 182 |[39m       })[33m;[39m
     [90m 183 |[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:180:26)

  ‚óè Cron Job Service ‚Ä∫ triggerTokenCleanup() - Manual Execution ‚Ä∫ should remove multiple expired tokens

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 196 |[39m       [90m// Create 5 expired tokens[39m
     [90m 197 |[39m       [36mfor[39m ([36mlet[39m i [33m=[39m [35m0[39m[33m;[39m i [33m<[39m [35m5[39m[33m;[39m i[33m++[39m) {
    [31m[1m>[22m[39m[90m 198 |[39m         [36mawait[39m createTestRefreshToken(user[33m.[39mid[33m,[39m {
     [90m     |[39m         [31m[1m^[22m[39m
     [90m 199 |[39m           expiresAt[33m:[39m [36mnew[39m [33mDate[39m([33mDate[39m[33m.[39mnow() [33m-[39m [35m24[39m [33m*[39m [35m60[39m [33m*[39m [35m60[39m [33m*[39m [35m1000[39m)[33m,[39m
     [90m 200 |[39m         })[33m;[39m
     [90m 201 |[39m       }[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:198:9)

  ‚óè Cron Job Service ‚Ä∫ triggerTokenCleanup() - Manual Execution ‚Ä∫ should remove expired tokens for all users

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 210 |[39m
     [90m 211 |[39m       [90m// Create expired tokens for both users[39m
    [31m[1m>[22m[39m[90m 212 |[39m       [36mawait[39m createTestRefreshToken(user[33m.[39mid[33m,[39m {
     [90m     |[39m       [31m[1m^[22m[39m
     [90m 213 |[39m         expiresAt[33m:[39m [36mnew[39m [33mDate[39m([33mDate[39m[33m.[39mnow() [33m-[39m [35m24[39m [33m*[39m [35m60[39m [33m*[39m [35m60[39m [33m*[39m [35m1000[39m)[33m,[39m
     [90m 214 |[39m       })[33m;[39m
     [90m 215 |[39m       [36mawait[39m createTestRefreshToken(user2[33m.[39mid[33m,[39m {[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:212:7)

  ‚óè Cron Job Service ‚Ä∫ triggerTokenCleanup() - Manual Execution ‚Ä∫ should remove only expired tokens from mixed set

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 225 |[39m       [90m// 3 expired tokens[39m
     [90m 226 |[39m       [36mfor[39m ([36mlet[39m i [33m=[39m [35m0[39m[33m;[39m i [33m<[39m [35m3[39m[33m;[39m i[33m++[39m) {
    [31m[1m>[22m[39m[90m 227 |[39m         [36mawait[39m createTestRefreshToken(user[33m.[39mid[33m,[39m {
     [90m     |[39m         [31m[1m^[22m[39m
     [90m 228 |[39m           expiresAt[33m:[39m [36mnew[39m [33mDate[39m([33mDate[39m[33m.[39mnow() [33m-[39m [35m24[39m [33m*[39m [35m60[39m [33m*[39m [35m60[39m [33m*[39m [35m1000[39m)[33m,[39m
     [90m 229 |[39m         })[33m;[39m
     [90m 230 |[39m       }[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:227:9)

  ‚óè Cron Job Service ‚Ä∫ triggerTokenCleanup() - Manual Execution ‚Ä∫ should handle tokens expiring at exact current time

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 269 |[39m
     [90m 270 |[39m       [90m// Token expires exactly now[39m
    [31m[1m>[22m[39m[90m 271 |[39m       [36mawait[39m createTestRefreshToken(user[33m.[39mid[33m,[39m {
     [90m     |[39m       [31m[1m^[22m[39m
     [90m 272 |[39m         expiresAt[33m:[39m now[33m,[39m
     [90m 273 |[39m       })[33m;[39m
     [90m 274 |[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:271:7)

  ‚óè Cron Job Service ‚Ä∫ Token Cleanup Scheduling ‚Ä∫ should execute token cleanup callback when triggered

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 306 |[39m
     [90m 307 |[39m       [36mconst[39m user [33m=[39m [36mawait[39m createTestUser()[33m;[39m
    [31m[1m>[22m[39m[90m 308 |[39m       [36mawait[39m createTestRefreshToken(user[33m.[39mid[33m,[39m {
     [90m     |[39m       [31m[1m^[22m[39m
     [90m 309 |[39m         expiresAt[33m:[39m [36mnew[39m [33mDate[39m([33mDate[39m[33m.[39mnow() [33m-[39m [35m24[39m [33m*[39m [35m60[39m [33m*[39m [35m60[39m [33m*[39m [35m1000[39m)[33m,[39m
     [90m 310 |[39m       })[33m;[39m
     [90m 311 |[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:308:7)

  ‚óè Cron Job Service ‚Ä∫ Edge Cases ‚Ä∫ should handle concurrent cleanup executions

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 340 |[39m       [90m// Create 10 expired tokens[39m
     [90m 341 |[39m       [36mfor[39m ([36mlet[39m i [33m=[39m [35m0[39m[33m;[39m i [33m<[39m [35m10[39m[33m;[39m i[33m++[39m) {
    [31m[1m>[22m[39m[90m 342 |[39m         [36mawait[39m createTestRefreshToken(user[33m.[39mid[33m,[39m {
     [90m     |[39m         [31m[1m^[22m[39m
     [90m 343 |[39m           expiresAt[33m:[39m [36mnew[39m [33mDate[39m([33mDate[39m[33m.[39mnow() [33m-[39m [35m24[39m [33m*[39m [35m60[39m [33m*[39m [35m60[39m [33m*[39m [35m1000[39m)[33m,[39m
     [90m 344 |[39m         })[33m;[39m
     [90m 345 |[39m       }[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:342:9)

  ‚óè Cron Job Service ‚Ä∫ Performance ‚Ä∫ should efficiently remove large number of expired tokens

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 399 |[39m         )[33m;[39m
     [90m 400 |[39m       }
    [31m[1m>[22m[39m[90m 401 |[39m       [36mawait[39m [33mPromise[39m[33m.[39mall(tokenPromises)[33m;[39m
     [90m     |[39m       [31m[1m^[22m[39m
     [90m 402 |[39m
     [90m 403 |[39m       [36mconst[39m startTime [33m=[39m [33mDate[39m[33m.[39mnow()[33m;[39m
     [90m 404 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m triggerTokenCleanup()[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
          at async Promise.all (index 28)
      at Object.<anonymous> (__tests__/services/cronJobService.test.mjs:401:7)

FAIL __tests__/integration/systemWideIntegration.test.mjs (6.091 s)
  ‚óè System-Wide Integration Tests ‚Ä∫ Complete User Journey: Registration to Competition ‚Ä∫ End-to-end user workflow: registration ‚Üí horse purchase ‚Üí training ‚Üí competition

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 64 |[39m
     [90m 65 |[39m     [90m// Create test horse for global tests[39m
    [31m[1m>[22m[39m[90m 66 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 67 |[39m       data[33m:[39m {
     [90m 68 |[39m         name[33m:[39m [32m'Global Test Horse'[39m[33m,[39m
     [90m 69 |[39m         age[33m:[39m [35m5[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/systemWideIntegration.test.mjs:66:17)

  ‚óè System-Wide Integration Tests ‚Ä∫ System Integration Validation ‚Ä∫ Documentation system integration

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 64 |[39m
     [90m 65 |[39m     [90m// Create test horse for global tests[39m
    [31m[1m>[22m[39m[90m 66 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 67 |[39m       data[33m:[39m {
     [90m 68 |[39m         name[33m:[39m [32m'Global Test Horse'[39m[33m,[39m
     [90m 69 |[39m         age[33m:[39m [35m5[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/systemWideIntegration.test.mjs:66:17)

  ‚óè System-Wide Integration Tests ‚Ä∫ System Integration Validation ‚Ä∫ Groom career progression and talent system integration

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 64 |[39m
     [90m 65 |[39m     [90m// Create test horse for global tests[39m
    [31m[1m>[22m[39m[90m 66 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 67 |[39m       data[33m:[39m {
     [90m 68 |[39m         name[33m:[39m [32m'Global Test Horse'[39m[33m,[39m
     [90m 69 |[39m         age[33m:[39m [35m5[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/systemWideIntegration.test.mjs:66:17)

  ‚óè System-Wide Integration Tests ‚Ä∫ System Integration Validation ‚Ä∫ Documentation system integration with API endpoints

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 64 |[39m
     [90m 65 |[39m     [90m// Create test horse for global tests[39m
    [31m[1m>[22m[39m[90m 66 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 67 |[39m       data[33m:[39m {
     [90m 68 |[39m         name[33m:[39m [32m'Global Test Horse'[39m[33m,[39m
     [90m 69 |[39m         age[33m:[39m [35m5[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/systemWideIntegration.test.mjs:66:17)

  ‚óè System-Wide Integration Tests ‚Ä∫ Performance and Load Testing ‚Ä∫ API response times under load

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 64 |[39m
     [90m 65 |[39m     [90m// Create test horse for global tests[39m
    [31m[1m>[22m[39m[90m 66 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 67 |[39m       data[33m:[39m {
     [90m 68 |[39m         name[33m:[39m [32m'Global Test Horse'[39m[33m,[39m
     [90m 69 |[39m         age[33m:[39m [35m5[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/systemWideIntegration.test.mjs:66:17)

  ‚óè System-Wide Integration Tests ‚Ä∫ Performance and Load Testing ‚Ä∫ Memory usage monitoring during operations

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 64 |[39m
     [90m 65 |[39m     [90m// Create test horse for global tests[39m
    [31m[1m>[22m[39m[90m 66 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 67 |[39m       data[33m:[39m {
     [90m 68 |[39m         name[33m:[39m [32m'Global Test Horse'[39m[33m,[39m
     [90m 69 |[39m         age[33m:[39m [35m5[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/systemWideIntegration.test.mjs:66:17)

  ‚óè System-Wide Integration Tests ‚Ä∫ Data Consistency Validation ‚Ä∫ Database transaction integrity across systems

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 64 |[39m
     [90m 65 |[39m     [90m// Create test horse for global tests[39m
    [31m[1m>[22m[39m[90m 66 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 67 |[39m       data[33m:[39m {
     [90m 68 |[39m         name[33m:[39m [32m'Global Test Horse'[39m[33m,[39m
     [90m 69 |[39m         age[33m:[39m [35m5[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/systemWideIntegration.test.mjs:66:17)

  ‚óè System-Wide Integration Tests ‚Ä∫ Data Consistency Validation ‚Ä∫ User progress tracking accuracy

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 64 |[39m
     [90m 65 |[39m     [90m// Create test horse for global tests[39m
    [31m[1m>[22m[39m[90m 66 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 67 |[39m       data[33m:[39m {
     [90m 68 |[39m         name[33m:[39m [32m'Global Test Horse'[39m[33m,[39m
     [90m 69 |[39m         age[33m:[39m [35m5[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/systemWideIntegration.test.mjs:66:17)


  ‚óè Test suite failed to run

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 101 |[39m     }
     [90m 102 |[39m     [36mif[39m (testUser) {
    [31m[1m>[22m[39m[90m 103 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({ where[33m:[39m { id[33m:[39m testUser[33m.[39mid } })[33m;[39m
     [90m     |[39m       [31m[1m^[22m[39m
     [90m 104 |[39m     }
     [90m 105 |[39m     [36mif[39m (testBreed) {
     [90m 106 |[39m       [36mawait[39m prisma[33m.[39mbreed[33m.[39m[36mdelete[39m({ where[33m:[39m { id[33m:[39m testBreed[33m.[39mid } })[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/systemWideIntegration.test.mjs:103:7)

FAIL __tests__/integration/crossSystemValidation.test.mjs (6.586 s)
  ‚óè Cross-System Validation Tests ‚Ä∫ Epigenetic Trait System Integration ‚Ä∫ Trait discovery integration with groom care patterns

    expected 201 "Created", got 403 "Forbidden"

    [0m [90m 127 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)
     [90m 128 |[39m         [33m.[39msend(foalData)
    [31m[1m>[22m[39m[90m 129 |[39m         [33m.[39mexpect([35m201[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 130 |[39m
     [90m 131 |[39m       [36mconst[39m { foal } [33m=[39m foalResponse[33m.[39mbody[33m.[39mdata[33m;[39m
     [90m 132 |[39m[0m

      at Object.<anonymous> (__tests__/integration/crossSystemValidation.test.mjs:129:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Cross-System Validation Tests ‚Ä∫ Epigenetic Trait System Integration ‚Ä∫ Environmental trigger system integration

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 200 |[39m         [33m.[39m[36mget[39m([32m`/api/horses/${testHorse.id}/environmental-analysis`[39m)
     [90m 201 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)
    [31m[1m>[22m[39m[90m 202 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 203 |[39m
     [90m 204 |[39m       expect(environmentalResponse[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 205 |[39m[0m

      at Object.<anonymous> (__tests__/integration/crossSystemValidation.test.mjs:202:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Cross-System Validation Tests ‚Ä∫ Competition System Integration ‚Ä∫ Training system integration with competition performance

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 221 |[39m         [33m.[39m[36mget[39m([32m`/api/horses/${testHorse.id}`[39m)
     [90m 222 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)
    [31m[1m>[22m[39m[90m 223 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 224 |[39m
     [90m 225 |[39m       [36mconst[39m initialStats [33m=[39m initialHorseResponse[33m.[39mbody[33m.[39mdata[33m;[39m
     [90m 226 |[39m[0m

      at Object.<anonymous> (__tests__/integration/crossSystemValidation.test.mjs:223:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Cross-System Validation Tests ‚Ä∫ Groom System Integration ‚Ä∫ Groom career progression with horse development

    expected 200 "OK", got 403 "Forbidden"

    [0m [90m 356 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)
     [90m 357 |[39m         [33m.[39msend(interactionData)
    [31m[1m>[22m[39m[90m 358 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 359 |[39m
     [90m 360 |[39m       expect(interactionResponse[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 361 |[39m[0m

      at Object.<anonymous> (__tests__/integration/crossSystemValidation.test.mjs:358:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Cross-System Validation Tests ‚Ä∫ Groom System Integration ‚Ä∫ Groom assignment integration with horse care

    expected 201 "Created", got 403 "Forbidden"

    [0m [90m 403 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)
     [90m 404 |[39m         [33m.[39msend(assignmentData)
    [31m[1m>[22m[39m[90m 405 |[39m         [33m.[39mexpect([35m201[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 406 |[39m
     [90m 407 |[39m       expect(assignmentResponse[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 408 |[39m[0m

      at Object.<anonymous> (__tests__/integration/crossSystemValidation.test.mjs:405:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Cross-System Validation Tests ‚Ä∫ Performance System Integration ‚Ä∫ Memory management integration with API operations

    expected 400 "Bad Request", got 403 "Forbidden"

    [0m [90m 463 |[39m         [33m.[39mpost([32m'/api/memory/gc'[39m)
     [90m 464 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)
    [31m[1m>[22m[39m[90m 465 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 466 |[39m
     [90m 467 |[39m       expect(gcResponse[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 468 |[39m       expect(gcResponse[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'Garbage collection not exposed'[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/crossSystemValidation.test.mjs:465:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Cross-System Validation Tests ‚Ä∫ Documentation System Integration ‚Ä∫ API documentation integration with live endpoints

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 514 |[39m         [33m.[39m[36mget[39m([32m'/api/docs/health'[39m)
     [90m 515 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)
    [31m[1m>[22m[39m[90m 516 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 517 |[39m
     [90m 518 |[39m       expect(docHealthResponse[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 519 |[39m       expect(docHealthResponse[33m.[39mbody[33m.[39mdata[33m.[39mstatus)[33m.[39mtoBe([32m'healthy'[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/crossSystemValidation.test.mjs:516:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Cross-System Validation Tests ‚Ä∫ Documentation System Integration ‚Ä∫ User documentation integration with search functionality

    expected 200 "OK", got 401 "Unauthorized"

    [0m [90m 524 |[39m       [36mconst[39m searchResponse [33m=[39m [36mawait[39m request(app)
     [90m 525 |[39m         [33m.[39m[36mget[39m([32m'/api/user-docs/search?q=competition'[39m)
    [31m[1m>[22m[39m[90m 526 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 527 |[39m
     [90m 528 |[39m       expect(searchResponse[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 529 |[39m       expect(searchResponse[33m.[39mbody[33m.[39mdata[33m.[39mresults[33m.[39mlength)[33m.[39mtoBeGreaterThan([35m0[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/crossSystemValidation.test.mjs:526:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Cross-System Validation Tests ‚Ä∫ System Health and Monitoring ‚Ä∫ Overall system health validation

    expected 200 "OK", got 401 "Unauthorized"

    [0m [90m 575 |[39m       [36mconst[39m docHealthResponse [33m=[39m [36mawait[39m request(app)
     [90m 576 |[39m         [33m.[39m[36mget[39m([32m'/api/user-docs/health'[39m)
    [31m[1m>[22m[39m[90m 577 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 578 |[39m
     [90m 579 |[39m       expect(docHealthResponse[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 580 |[39m       expect(docHealthResponse[33m.[39mbody[33m.[39mdata[33m.[39mstatus)[33m.[39mtoBe([32m'healthy'[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/crossSystemValidation.test.mjs:577:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)


  ‚óè Test suite failed to run

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 106 |[39m     [36mawait[39m prisma[33m.[39mhorse[33m.[39mdeleteMany({ where[33m:[39m { ownerId[33m:[39m testUser[33m.[39mid } })[33m;[39m
     [90m 107 |[39m     [36mawait[39m prisma[33m.[39mgroom[33m.[39mdeleteMany({ where[33m:[39m { userId[33m:[39m testUser[33m.[39mid } })[33m;[39m
    [31m[1m>[22m[39m[90m 108 |[39m     [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({ where[33m:[39m { id[33m:[39m testUser[33m.[39mid } })[33m;[39m
     [90m     |[39m     [31m[1m^[22m[39m
     [90m 109 |[39m     [36mawait[39m prisma[33m.[39mbreed[33m.[39m[36mdelete[39m({ where[33m:[39m { id[33m:[39m testBreed[33m.[39mid } })[33m;[39m
     [90m 110 |[39m   })[33m;[39m
     [90m 111 |[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/crossSystemValidation.test.mjs:108:5)

FAIL __tests__/unit/token-rotation.test.mjs (7.544 s)
  ‚óè Token Rotation Service - Unit Tests ‚Ä∫ rotateRefreshToken() ‚Ä∫ should_create_new_token_and_invalidate_old

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 285 |[39m       [36mconst[39m rotationResult [33m=[39m [36mawait[39m rotateRefreshToken(oldTokenPair[33m.[39mrefreshToken)[33m;[39m
     [90m 286 |[39m
    [31m[1m>[22m[39m[90m 287 |[39m       expect(rotationResult[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                                      [31m[1m^[22m[39m
     [90m 288 |[39m       expect(rotationResult[33m.[39mnewTokenPair)[33m.[39mtoBeDefined()[33m;[39m
     [90m 289 |[39m       expect(rotationResult[33m.[39mnewTokenPair[33m.[39maccessToken)[33m.[39mtoBeDefined()[33m;[39m
     [90m 290 |[39m       expect(rotationResult[33m.[39mnewTokenPair[33m.[39mrefreshToken)[33m.[39mtoBeDefined()[33m;[39m[0m

      at Object.<anonymous> (__tests__/unit/token-rotation.test.mjs:287:38)

  ‚óè Token Rotation Service - Unit Tests ‚Ä∫ rotateRefreshToken() ‚Ä∫ should_handle_concurrent_rotation_attempts

    expect(received).toBeGreaterThanOrEqual(expected)

    Expected: >= 1
    Received:    0

    [0m [90m 345 |[39m
     [90m 346 |[39m       [90m// Expect at least one success; multiple successes tolerated in current impl[39m
    [31m[1m>[22m[39m[90m 347 |[39m       expect(successfulResults[33m.[39mlength)[33m.[39mtoBeGreaterThanOrEqual([35m1[39m)[33m;[39m
     [90m     |[39m                                        [31m[1m^[22m[39m
     [90m 348 |[39m     })[33m;[39m
     [90m 349 |[39m   })[33m;[39m
     [90m 350 |[39m[0m

      at Object.<anonymous> (__tests__/unit/token-rotation.test.mjs:347:40)

  ‚óè Token Rotation Service - Unit Tests ‚Ä∫ invalidateTokenFamily() ‚Ä∫ should_invalidate_all_tokens_in_family

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 0

    [0m [90m 361 |[39m
     [90m 362 |[39m       expect(invalidationResult[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 363 |[39m       expect(invalidationResult[33m.[39minvalidatedCount)[33m.[39mtoBe([35m3[39m)[33m;[39m
     [90m     |[39m                                                   [31m[1m^[22m[39m
     [90m 364 |[39m
     [90m 365 |[39m       [90m// Verify all tokens are invalidated[39m
     [90m 366 |[39m       [36mconst[39m allTokens [33m=[39m [36mawait[39m prisma[33m.[39mrefreshToken[33m.[39mfindMany({[0m

      at Object.<anonymous> (__tests__/unit/token-rotation.test.mjs:363:51)

  ‚óè Token Rotation Service - Unit Tests ‚Ä∫ cleanupExpiredTokens() ‚Ä∫ should_remove_expired_tokens_from_database

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

    [0m [90m 423 |[39m       [36mconst[39m cleanupResult [33m=[39m [36mawait[39m cleanupExpiredTokens()[33m;[39m
     [90m 424 |[39m
    [31m[1m>[22m[39m[90m 425 |[39m       expect(cleanupResult[33m.[39mremovedCount)[33m.[39mtoBe([35m1[39m)[33m;[39m
     [90m     |[39m                                          [31m[1m^[22m[39m
     [90m 426 |[39m
     [90m 427 |[39m       [90m// Verify expired token is removed[39m
     [90m 428 |[39m       [36mconst[39m expiredTokenRecord [33m=[39m [36mawait[39m prisma[33m.[39mrefreshToken[33m.[39mfindFirst({[0m

      at Object.<anonymous> (__tests__/unit/token-rotation.test.mjs:425:42)

  ‚óè Token Rotation Service - Unit Tests ‚Ä∫ cleanupExpiredTokens() ‚Ä∫ should_remove_old_invalidated_tokens

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

    [0m [90m 456 |[39m       [36mconst[39m cleanupResult [33m=[39m [36mawait[39m cleanupExpiredTokens({ olderThanDays[33m:[39m [35m7[39m })[33m;[39m
     [90m 457 |[39m
    [31m[1m>[22m[39m[90m 458 |[39m       expect(cleanupResult[33m.[39mremovedCount)[33m.[39mtoBe([35m1[39m)[33m;[39m
     [90m     |[39m                                          [31m[1m^[22m[39m
     [90m 459 |[39m     })[33m;[39m
     [90m 460 |[39m
     [90m 461 |[39m     it([32m'should_return_cleanup_statistics'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (__tests__/unit/token-rotation.test.mjs:458:42)

  ‚óè Token Rotation Service - Unit Tests ‚Ä∫ cleanupExpiredTokens() ‚Ä∫ should_return_cleanup_statistics

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 465 |[39m
     [90m 466 |[39m       [90m// Expired but not invalidated[39m
    [31m[1m>[22m[39m[90m 467 |[39m       [36mawait[39m prisma[33m.[39mrefreshToken[33m.[39mcreate({
     [90m     |[39m       [31m[1m^[22m[39m
     [90m 468 |[39m         data[33m:[39m {
     [90m 469 |[39m           token[33m:[39m [32m'expired-1'[39m[33m,[39m
     [90m 470 |[39m           userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/unit/token-rotation.test.mjs:467:7)

FAIL __tests__/integration/security/parameter-pollution.test.mjs (7.824 s)
  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ HTTP Parameter Pollution (HPP) ‚Ä∫ should reject duplicate id parameters in query string

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 42 |[39m
     [90m 43 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 44 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 45 |[39m       data[33m:[39m {
     [90m 46 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 47 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:44:17)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ HTTP Parameter Pollution (HPP) ‚Ä∫ should use first parameter value when duplicates present

    expected 200 "OK", got 404 "Not Found"

    [0m [90m  97 |[39m         [33m.[39m[36mget[39m([32m`/api/horses/${testHorse.id}?sort=name&sort=age`[39m)
     [90m  98 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${validToken}`[39m)
    [31m[1m>[22m[39m[90m  99 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 100 |[39m
     [90m 101 |[39m       [90m// Should use first 'sort=name' parameter[39m
     [90m 102 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:99:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ HTTP Parameter Pollution (HPP) ‚Ä∫ should reject array-syntax parameters where not expected

    expected 400 "Bad Request", got 404 "Not Found"

    [0m [90m 111 |[39m           name[33m:[39m [[32m'HorseName1'[39m[33m,[39m [32m'HorseName2'[39m][33m,[39m [90m// Array where string expected[39m
     [90m 112 |[39m         })
    [31m[1m>[22m[39m[90m 113 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 114 |[39m
     [90m 115 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 116 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'Invalid'[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:113:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ JSON Parameter Pollution ‚Ä∫ should reject duplicate keys in JSON payload

    expected 400 "Bad Request", got 404 "Not Found"

    [0m [90m 144 |[39m         [33m.[39m[36mset[39m([32m'Content-Type'[39m[33m,[39m [32m'application/json'[39m)
     [90m 145 |[39m         [33m.[39msend(maliciousPayload)
    [31m[1m>[22m[39m[90m 146 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 147 |[39m
     [90m 148 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 149 |[39m[0m

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:146:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ JSON Parameter Pollution ‚Ä∫ should reject prototype pollution attempts

    expected 400 "Bad Request", got 404 "Not Found"

    [0m [90m 181 |[39m           }[33m,[39m
     [90m 182 |[39m         })
    [31m[1m>[22m[39m[90m 183 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 184 |[39m
     [90m 185 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 186 |[39m[0m

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:183:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Query String Pollution ‚Ä∫ should reject NoSQL injection in query parameters

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 42 |[39m
     [90m 43 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 44 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 45 |[39m       data[33m:[39m {
     [90m 46 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 47 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:44:17)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Query String Pollution ‚Ä∫ should reject encoded special characters in parameters

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 42 |[39m
     [90m 43 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 44 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 45 |[39m       data[33m:[39m {
     [90m 46 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 47 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:44:17)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Query String Pollution ‚Ä∫ should enforce query string length limits

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 42 |[39m
     [90m 43 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 44 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 45 |[39m       data[33m:[39m {
     [90m 46 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 47 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:44:17)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Content-Type Manipulation ‚Ä∫ should reject Content-Type charset manipulation

    expected 400 "Bad Request", got 404 "Not Found"

    [0m [90m 366 |[39m         [33m.[39m[36mset[39m([32m'Content-Type'[39m[33m,[39m [32m'application/json; charset=utf-7'[39m)
     [90m 367 |[39m         [33m.[39msend({ name[33m:[39m [32m'HackedName'[39m })
    [31m[1m>[22m[39m[90m 368 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 369 |[39m
     [90m 370 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 371 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:368:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Content-Type Manipulation ‚Ä∫ should reject multipart/form-data without proper boundaries

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 42 |[39m
     [90m 43 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 44 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 45 |[39m       data[33m:[39m {
     [90m 46 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 47 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:44:17)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Content-Type Manipulation ‚Ä∫ should accept only allowed Content-Types

    expected 415 "Unsupported Media Type", got 404 "Not Found"

    [0m [90m 390 |[39m         [33m.[39m[36mset[39m([32m'Content-Type'[39m[33m,[39m [32m'application/xml'[39m) [90m// Not allowed[39m
     [90m 391 |[39m         [33m.[39msend([32m'<name>HackedName</name>'[39m)
    [31m[1m>[22m[39m[90m 392 |[39m         [33m.[39mexpect([35m415[39m)[33m;[39m [90m// Unsupported Media Type[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 393 |[39m
     [90m 394 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 395 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:392:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Nested Object Pollution ‚Ä∫ should reject excessive nesting depth

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 42 |[39m
     [90m 43 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 44 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 45 |[39m       data[33m:[39m {
     [90m 46 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 47 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:44:17)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Nested Object Pollution ‚Ä∫ should reject circular references in objects

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 42 |[39m
     [90m 43 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 44 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 45 |[39m       data[33m:[39m {
     [90m 46 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 47 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:44:17)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Nested Object Pollution ‚Ä∫ should sanitize nested object keys

    expected 400 "Bad Request", got 404 "Not Found"

    [0m [90m 437 |[39m           }[33m,[39m
     [90m 438 |[39m         })
    [31m[1m>[22m[39m[90m 439 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 440 |[39m
     [90m 441 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 442 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:439:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Nested Object Pollution ‚Ä∫ should reject objects with numeric string keys

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 42 |[39m
     [90m 43 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 44 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 45 |[39m       data[33m:[39m {
     [90m 46 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 47 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:44:17)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Type Coercion Attacks ‚Ä∫ should reject boolean as string

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 42 |[39m
     [90m 43 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 44 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 45 |[39m       data[33m:[39m {
     [90m 46 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 47 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:44:17)

  ‚óè Parameter Pollution Attack Integration Tests ‚Ä∫ Parameter Injection via Headers ‚Ä∫ should reject parameter injection via custom headers

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 42 |[39m
     [90m 43 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 44 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 45 |[39m       data[33m:[39m {
     [90m 46 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 47 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/parameter-pollution.test.mjs:44:17)

FAIL __tests__/integration/session-lifecycle.test.mjs (8.245 s)
  ‚óè Session Lifecycle Management ‚Ä∫ CWE-384: Token Regeneration on Login ‚Ä∫ should delete all existing refresh tokens on login

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 0

    [0m [90m 130 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 131 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 132 |[39m       expect(tokensBefore)[33m.[39mtoBe([35m3[39m)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 133 |[39m
     [90m 134 |[39m       [90m// Login[39m
     [90m 135 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)[0m

      at Object.<anonymous> (__tests__/integration/session-lifecycle.test.mjs:132:28)

  ‚óè Session Lifecycle Management ‚Ä∫ CWE-384: Token Regeneration on Login ‚Ä∫ should create fresh token pair on login

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

    [0m [90m 181 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 182 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 183 |[39m       expect(tokens[33m.[39mlength)[33m.[39mtoBe([35m1[39m)[33m;[39m
     [90m     |[39m                             [31m[1m^[22m[39m
     [90m 184 |[39m       expect(tokens[[35m0[39m][33m.[39misActive)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 185 |[39m       expect(tokens[[35m0[39m][33m.[39misInvalidated)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 186 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/session-lifecycle.test.mjs:183:29)

  ‚óè Session Lifecycle Management ‚Ä∫ CWE-613: Token Cleanup on Logout ‚Ä∫ should delete all refresh tokens on logout

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

    [0m [90m 197 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 198 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 199 |[39m       expect(tokensBefore)[33m.[39mtoBe([35m2[39m)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 200 |[39m
     [90m 201 |[39m       [90m// Login to get auth cookies[39m
     [90m 202 |[39m       [36mconst[39m loginResponse [33m=[39m [36mawait[39m request(app)[0m

      at Object.<anonymous> (__tests__/integration/session-lifecycle.test.mjs:199:28)

  ‚óè Session Lifecycle Management ‚Ä∫ Force Logout on Password Change ‚Ä∫ should invalidate all sessions when password is changed

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

    [0m [90m 279 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 280 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 281 |[39m       expect(tokensBefore)[33m.[39mtoBe([35m1[39m)[33m;[39m [90m// Login creates 1 token (after deleting old ones)[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 282 |[39m
     [90m 283 |[39m       [90m// Change password[39m
     [90m 284 |[39m       [36mconst[39m newPassword [33m=[39m [32m'NewPassword456!'[39m[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/session-lifecycle.test.mjs:281:28)

  ‚óè Session Lifecycle Management ‚Ä∫ Force Logout on Password Change ‚Ä∫ should reject password change with incorrect old password

    expected 401 "Unauthorized", got 404 "Not Found"

    [0m [90m 337 |[39m           newPassword[33m:[39m [32m'NewPassword456!'[39m[33m,[39m
     [90m 338 |[39m         })
    [31m[1m>[22m[39m[90m 339 |[39m         [33m.[39mexpect([35m401[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 340 |[39m
     [90m 341 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 342 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'incorrect'[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/session-lifecycle.test.mjs:339:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Session Lifecycle Management ‚Ä∫ Token Cleanup Cron Job ‚Ä∫ should not remove valid active tokens

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

    [0m [90m 562 |[39m         }[33m,[39m
     [90m 563 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 564 |[39m       expect(countBefore)[33m.[39mtoBe([35m2[39m)[33m;[39m
     [90m     |[39m                           [31m[1m^[22m[39m
     [90m 565 |[39m
     [90m 566 |[39m       [90m// Run cleanup[39m
     [90m 567 |[39m       [36mawait[39m triggerTokenCleanup()[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/session-lifecycle.test.mjs:564:27)

FAIL __tests__/integration/security/ownership-violations.test.mjs
  ‚óè Ownership Violation Attempts Integration Tests ‚Ä∫ Cross-user horse access ‚Ä∫ denies access to an unowned horse

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 56 |[39m     tokenB [33m=[39m createMockToken(userB[33m.[39mid)[33m;[39m
     [90m 57 |[39m
    [31m[1m>[22m[39m[90m 58 |[39m     horseA [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m              [31m[1m^[22m[39m
     [90m 59 |[39m       data[33m:[39m {
     [90m 60 |[39m         name[33m:[39m [32m`HorseA-${Date.now()}`[39m[33m,[39m
     [90m 61 |[39m         userId[33m:[39m userA[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/ownership-violations.test.mjs:58:14)

  ‚óè Ownership Violation Attempts Integration Tests ‚Ä∫ Cross-user horse access ‚Ä∫ allows owners to fetch their own horse

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 56 |[39m     tokenB [33m=[39m createMockToken(userB[33m.[39mid)[33m;[39m
     [90m 57 |[39m
    [31m[1m>[22m[39m[90m 58 |[39m     horseA [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m              [31m[1m^[22m[39m
     [90m 59 |[39m       data[33m:[39m {
     [90m 60 |[39m         name[33m:[39m [32m`HorseA-${Date.now()}`[39m[33m,[39m
     [90m 61 |[39m         userId[33m:[39m userA[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/ownership-violations.test.mjs:58:14)

  ‚óè Ownership Violation Attempts Integration Tests ‚Ä∫ Cross-user horse access ‚Ä∫ blocks cross-user updates and preserves data integrity

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 56 |[39m     tokenB [33m=[39m createMockToken(userB[33m.[39mid)[33m;[39m
     [90m 57 |[39m
    [31m[1m>[22m[39m[90m 58 |[39m     horseA [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m              [31m[1m^[22m[39m
     [90m 59 |[39m       data[33m:[39m {
     [90m 60 |[39m         name[33m:[39m [32m`HorseA-${Date.now()}`[39m[33m,[39m
     [90m 61 |[39m         userId[33m:[39m userA[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/ownership-violations.test.mjs:58:14)

  ‚óè Ownership Violation Attempts Integration Tests ‚Ä∫ Cross-user horse access ‚Ä∫ blocks cross-user deletes and allows owner deletes

    PrismaClientKnownRequestError: 
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

    [0m [90m 74 |[39m     })[33m;[39m
     [90m 75 |[39m
    [31m[1m>[22m[39m[90m 76 |[39m     groomA [33m=[39m [36mawait[39m prisma[33m.[39mgroom[33m.[39mcreate({
     [90m    |[39m              [31m[1m^[22m[39m
     [90m 77 |[39m       data[33m:[39m {
     [90m 78 |[39m         name[33m:[39m [32m`GroomA-${Date.now()}`[39m[33m,[39m
     [90m 79 |[39m         userId[33m:[39m userA[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/ownership-violations.test.mjs:76:14)

  ‚óè Ownership Violation Attempts Integration Tests ‚Ä∫ Groom ownership ‚Ä∫ allows owners to view their groom profile

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 56 |[39m     tokenB [33m=[39m createMockToken(userB[33m.[39mid)[33m;[39m
     [90m 57 |[39m
    [31m[1m>[22m[39m[90m 58 |[39m     horseA [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m              [31m[1m^[22m[39m
     [90m 59 |[39m       data[33m:[39m {
     [90m 60 |[39m         name[33m:[39m [32m`HorseA-${Date.now()}`[39m[33m,[39m
     [90m 61 |[39m         userId[33m:[39m userA[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/ownership-violations.test.mjs:58:14)

  ‚óè Ownership Violation Attempts Integration Tests ‚Ä∫ Parameter validation and enumeration safety ‚Ä∫ rejects invalid horse identifiers

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 56 |[39m     tokenB [33m=[39m createMockToken(userB[33m.[39mid)[33m;[39m
     [90m 57 |[39m
    [31m[1m>[22m[39m[90m 58 |[39m     horseA [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m              [31m[1m^[22m[39m
     [90m 59 |[39m       data[33m:[39m {
     [90m 60 |[39m         name[33m:[39m [32m`HorseA-${Date.now()}`[39m[33m,[39m
     [90m 61 |[39m         userId[33m:[39m userA[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/ownership-violations.test.mjs:58:14)

  ‚óè Ownership Violation Attempts Integration Tests ‚Ä∫ Parameter validation and enumeration safety ‚Ä∫ returns the same 404 for missing and unowned horses

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 56 |[39m     tokenB [33m=[39m createMockToken(userB[33m.[39mid)[33m;[39m
     [90m 57 |[39m
    [31m[1m>[22m[39m[90m 58 |[39m     horseA [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m              [31m[1m^[22m[39m
     [90m 59 |[39m       data[33m:[39m {
     [90m 60 |[39m         name[33m:[39m [32m`HorseA-${Date.now()}`[39m[33m,[39m
     [90m 61 |[39m         userId[33m:[39m userA[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/ownership-violations.test.mjs:58:14)

FAIL __tests__/integration/security/auth-bypass-attempts.test.mjs
  ‚óè Authentication Bypass Attempts Integration Tests ‚Ä∫ Expired Token Usage ‚Ä∫ should accept token exactly 7 days old

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 239 |[39m         [33m.[39m[36mget[39m([32m'/api/auth/profile'[39m)
     [90m 240 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${sevenDayToken}`[39m)
    [31m[1m>[22m[39m[90m 241 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 242 |[39m
     [90m 243 |[39m       expectSuccessFlag(response[33m,[39m [36mtrue[39m)[33m;[39m
     [90m 244 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/security/auth-bypass-attempts.test.mjs:241:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Authentication Bypass Attempts Integration Tests ‚Ä∫ Token Replay Attacks ‚Ä∫ should allow same token for multiple valid requests (expected behavior)

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 251 |[39m         [33m.[39m[36mget[39m([32m'/api/auth/profile'[39m)
     [90m 252 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${validToken}`[39m)
    [31m[1m>[22m[39m[90m 253 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 254 |[39m
     [90m 255 |[39m       expectSuccessFlag(response1[33m,[39m [36mtrue[39m)[33m;[39m
     [90m 256 |[39m[0m

      at Object.<anonymous> (__tests__/integration/security/auth-bypass-attempts.test.mjs:253:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Authentication Bypass Attempts Integration Tests ‚Ä∫ Token Replay Attacks ‚Ä∫ should accept token from both cookie and header (cookie preferred)

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 272 |[39m         [33m.[39m[36mset[39m([32m'Cookie'[39m[33m,[39m [32m`accessToken=${cookieToken}`[39m)
     [90m 273 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${headerToken}`[39m)
    [31m[1m>[22m[39m[90m 274 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 275 |[39m
     [90m 276 |[39m       expectSuccessFlag(response[33m,[39m [36mtrue[39m)[33m;[39m
     [90m 277 |[39m       [36mconst[39m responseUserId [33m=[39m response[33m.[39mbody[33m?[39m[33m.[39mdata[33m?[39m[33m.[39muser[33m?[39m[33m.[39mid [33m?[39m[33m?[39m response[33m.[39mbody[33m?[39m[33m.[39mdata[33m?[39m[33m.[39mid[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/security/auth-bypass-attempts.test.mjs:274:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Authentication Bypass Attempts Integration Tests ‚Ä∫ Multi-User Session Conflicts ‚Ä∫ should allow user to access their own resources only

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 401 |[39m         [33m.[39m[36mget[39m([32m'/api/auth/profile'[39m)
     [90m 402 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${validToken}`[39m)
    [31m[1m>[22m[39m[90m 403 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 404 |[39m
     [90m 405 |[39m       expectSuccessFlag(response[33m,[39m [36mtrue[39m)[33m;[39m
     [90m 406 |[39m       [36mconst[39m responseUserId [33m=[39m response[33m.[39mbody[33m?[39m[33m.[39mdata[33m?[39m[33m.[39muser[33m?[39m[33m.[39mid [33m?[39m[33m?[39m response[33m.[39mbody[33m?[39m[33m.[39mdata[33m?[39m[33m.[39mid[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/security/auth-bypass-attempts.test.mjs:403:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

FAIL __tests__/unit/email-verification.test.mjs (7.704 s)
  ‚óè Email Verification Service - Unit Tests ‚Ä∫ createVerificationToken() ‚Ä∫ should_allow_token_creation_after_cooldown

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:170:26)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ verifyEmailToken() ‚Ä∫ should_verify_valid_token

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:194:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ verifyEmailToken() ‚Ä∫ should_mark_user_email_as_verified

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:206:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ verifyEmailToken() ‚Ä∫ should_mark_token_as_used

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:219:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ verifyEmailToken() ‚Ä∫ should_reject_already_used_token

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:240:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ verifyEmailToken() ‚Ä∫ should_reject_expired_token

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:259:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ verifyEmailToken() ‚Ä∫ should_use_atomic_transaction_for_verification

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:275:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ checkVerificationStatus() ‚Ä∫ should_return_verification_status_for_verified_user

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:305:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ resendVerificationEmail() ‚Ä∫ should_reject_resend_for_verified_user

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:342:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ resendVerificationEmail() ‚Ä∫ should_cleanup_expired_tokens_before_creating_new

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at resendVerificationEmail (utils/emailVerificationService.mjs:318:23)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:366:7)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ cleanupExpiredTokens() ‚Ä∫ should_delete_expired_tokens

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:387:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ cleanupExpiredTokens() ‚Ä∫ should_delete_old_used_tokens

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:406:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ cleanupExpiredTokens() ‚Ä∫ should_keep_active_valid_tokens

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:421:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ getTokenInfo() ‚Ä∫ should_return_token_information

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:435:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ getTokenInfo() ‚Ä∫ should_indicate_used_token

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:448:25)

  ‚óè Email Verification Service - Unit Tests ‚Ä∫ getTokenInfo() ‚Ä∫ should_indicate_expired_token

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 94 |[39m
     [90m 95 |[39m     [90m// Create token record[39m
    [31m[1m>[22m[39m[90m 96 |[39m     [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 97 |[39m       data[33m:[39m {
     [90m 98 |[39m         token[33m,[39m
     [90m 99 |[39m         userId[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at createVerificationToken (utils/emailVerificationService.mjs:96:25)
      at Object.<anonymous> (__tests__/unit/email-verification.test.mjs:459:25)

FAIL __tests__/routes/memoryManagementRoutes.test.mjs


  ‚óè Test suite failed to run

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 74 |[39m
     [90m 75 |[39m     [90m// Cleanup test data[39m
    [31m[1m>[22m[39m[90m 76 |[39m     [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 77 |[39m       where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 78 |[39m     })[33m;[39m
     [90m 79 |[39m   })[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/routes/memoryManagementRoutes.test.mjs:76:5)

FAIL __tests__/integration/token-rotation.test.mjs (11.861 s)
  ‚óè Token Rotation and Reuse Detection System ‚Ä∫ Concurrent Token Usage ‚Ä∫ should_handle_concurrent_refresh_requests_gracefully

    expect(received).toMatch(expected)

    Expected pattern: /already used|invalid/i
    Received string:  "Token reuse detected - please login again"

    [0m [90m 375 |[39m       [90m// All failures should indicate token was already used[39m
     [90m 376 |[39m       failureResponses[33m.[39mforEach(response [33m=>[39m {
    [31m[1m>[22m[39m[90m 377 |[39m         expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoMatch([35m/already used|invalid/i[39m)[33m;[39m
     [90m     |[39m                                       [31m[1m^[22m[39m
     [90m 378 |[39m       })[33m;[39m
     [90m 379 |[39m     })[33m;[39m
     [90m 380 |[39m[0m

      at __tests__/integration/token-rotation.test.mjs:377:39
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (__tests__/integration/token-rotation.test.mjs:376:24)

  ‚óè Token Rotation and Reuse Detection System ‚Ä∫ Concurrent Token Usage ‚Ä∫ should_prevent_race_conditions_in_token_rotation

    expect(received).toBeGreaterThanOrEqual(expected)

    Expected: >= 1
    Received:    0

    [0m [90m 407 |[39m       [90m// Verify at least one succeeded (implementation allows multiple)[39m
     [90m 408 |[39m       [36mconst[39m successCount [33m=[39m statuses[33m.[39mfilter(s [33m=>[39m s [33m===[39m [35m200[39m)[33m.[39mlength[33m;[39m
    [31m[1m>[22m[39m[90m 409 |[39m       expect(successCount)[33m.[39mtoBeGreaterThanOrEqual([35m1[39m)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 410 |[39m     })[33m;[39m
     [90m 411 |[39m   })[33m;[39m
     [90m 412 |[39m[0m

      at Object.<anonymous> (__tests__/integration/token-rotation.test.mjs:409:28)

  ‚óè Token Rotation and Reuse Detection System ‚Ä∫ Token Expiration and Cleanup ‚Ä∫ should_reject_expired_refresh_tokens

    expect(received).toMatch(expected)

    Expected pattern: /expired|invalid/i
    Received string:  "Token reuse detected - please login again"

    [0m [90m 523 |[39m       expect([[35m401[39m[33m,[39m [35m403[39m])[33m.[39mtoContain(expiredResponse[33m.[39mstatus)[33m;[39m
     [90m 524 |[39m       [36mif[39m (expiredResponse[33m.[39mbody[33m?[39m[33m.[39mmessage) {
    [31m[1m>[22m[39m[90m 525 |[39m         expect(expiredResponse[33m.[39mbody[33m.[39mmessage)[33m.[39mtoMatch([35m/expired|invalid/i[39m)[33m;[39m
     [90m     |[39m                                              [31m[1m^[22m[39m
     [90m 526 |[39m       }
     [90m 527 |[39m     })[33m;[39m
     [90m 528 |[39m[0m

      at Object.<anonymous> (__tests__/integration/token-rotation.test.mjs:525:46)

FAIL __tests__/routes/documentationRoutes.test.mjs


  ‚óè Test suite failed to run

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 63 |[39m   afterAll([36masync[39m () [33m=>[39m {
     [90m 64 |[39m     [90m// Cleanup test data[39m
    [31m[1m>[22m[39m[90m 65 |[39m     [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 66 |[39m       where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 67 |[39m     })[33m;[39m
     [90m 68 |[39m   })[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/routes/documentationRoutes.test.mjs:65:5)

FAIL __tests__/middleware/sessionManagement.test.mjs
  ‚óè Session Management Middleware ‚Ä∫ trackSessionActivity() ‚Ä∫ Active session tracking ‚Ä∫ should update lastActivityAt for valid session

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 67 |[39m       beforeEach([36masync[39m () [33m=>[39m {
     [90m 68 |[39m         user [33m=[39m [36mawait[39m createTestUser()[33m;[39m
    [31m[1m>[22m[39m[90m 69 |[39m         token [33m=[39m [36mawait[39m createTestRefreshToken(user[33m.[39mid[33m,[39m {
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 70 |[39m           lastActivityAt[33m:[39m [36mnew[39m [33mDate[39m([33mDate[39m[33m.[39mnow() [33m-[39m [35m5[39m [33m*[39m [35m60[39m [33m*[39m [35m1000[39m)[33m,[39m [90m// 5 minutes ago[39m
     [90m 71 |[39m         })[33m;[39m
     [90m 72 |[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:69:17)

  ‚óè Session Management Middleware ‚Ä∫ trackSessionActivity() ‚Ä∫ Active session tracking ‚Ä∫ should allow session within timeout window (14 minutes)

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.update()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for an update.

    [0m [90m 91 |[39m       it([32m'should allow session within timeout window (14 minutes)'[39m[33m,[39m [36masync[39m () [33m=>[39m {
     [90m 92 |[39m         [90m// Update to 14 minutes ago (still within 15 min window)[39m
    [31m[1m>[22m[39m[90m 93 |[39m         [36mawait[39m prisma[33m.[39mrefreshToken[33m.[39mupdate({
     [90m    |[39m         [31m[1m^[22m[39m
     [90m 94 |[39m           where[33m:[39m { id[33m:[39m token[33m.[39mid }[33m,[39m
     [90m 95 |[39m           data[33m:[39m { lastActivityAt[33m:[39m [36mnew[39m [33mDate[39m([33mDate[39m[33m.[39mnow() [33m-[39m [35m14[39m [33m*[39m [35m60[39m [33m*[39m [35m1000[39m) }[33m,[39m
     [90m 96 |[39m         })[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:93:9)

  ‚óè Session Management Middleware ‚Ä∫ trackSessionActivity() ‚Ä∫ Active session tracking ‚Ä∫ should expire session after 15 minutes of inactivity

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 67 |[39m       beforeEach([36masync[39m () [33m=>[39m {
     [90m 68 |[39m         user [33m=[39m [36mawait[39m createTestUser()[33m;[39m
    [31m[1m>[22m[39m[90m 69 |[39m         token [33m=[39m [36mawait[39m createTestRefreshToken(user[33m.[39mid[33m,[39m {
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 70 |[39m           lastActivityAt[33m:[39m [36mnew[39m [33mDate[39m([33mDate[39m[33m.[39mnow() [33m-[39m [35m5[39m [33m*[39m [35m60[39m [33m*[39m [35m1000[39m)[33m,[39m [90m// 5 minutes ago[39m
     [90m 71 |[39m         })[33m;[39m
     [90m 72 |[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:69:17)

  ‚óè Session Management Middleware ‚Ä∫ trackSessionActivity() ‚Ä∫ Active session tracking ‚Ä∫ should clear cookies when session expires

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "accessToken"

    Number of calls: 0

    [0m [90m 134 |[39m         [36mawait[39m trackSessionActivity(req[33m,[39m res[33m,[39m next)[33m;[39m
     [90m 135 |[39m
    [31m[1m>[22m[39m[90m 136 |[39m         expect(res[33m.[39mclearCookie)[33m.[39mtoHaveBeenCalledWith([32m'accessToken'[39m)[33m;[39m
     [90m     |[39m                                 [31m[1m^[22m[39m
     [90m 137 |[39m         expect(res[33m.[39mclearCookie)[33m.[39mtoHaveBeenCalledWith([32m'refreshToken'[39m)[33m;[39m
     [90m 138 |[39m       })[33m;[39m
     [90m 139 |[39m[0m

      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:136:33)

  ‚óè Session Management Middleware ‚Ä∫ enforceConcurrentSessions() ‚Ä∫ should allow user with 1 session

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 230 |[39m     it([32m'should allow user with 1 session'[39m[33m,[39m [36masync[39m () [33m=>[39m {
     [90m 231 |[39m       [36mconst[39m user [33m=[39m [36mawait[39m createTestUser()[33m;[39m
    [31m[1m>[22m[39m[90m 232 |[39m       [36mawait[39m createTestRefreshToken(user[33m.[39mid)[33m;[39m
     [90m     |[39m       [31m[1m^[22m[39m
     [90m 233 |[39m
     [90m 234 |[39m       req[33m.[39muser [33m=[39m { id[33m:[39m user[33m.[39mid }[33m;[39m
     [90m 235 |[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:232:7)

  ‚óè Session Management Middleware ‚Ä∫ enforceConcurrentSessions() ‚Ä∫ should allow user with exactly MAX_CONCURRENT_SESSIONS (5)

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 249 |[39m       [90m// Create exactly 5 sessions[39m
     [90m 250 |[39m       [36mfor[39m ([36mlet[39m i [33m=[39m [35m0[39m[33m;[39m i [33m<[39m [35m5[39m[33m;[39m i[33m++[39m) {
    [31m[1m>[22m[39m[90m 251 |[39m         [36mawait[39m createTestRefreshToken(user[33m.[39mid)[33m;[39m
     [90m     |[39m         [31m[1m^[22m[39m
     [90m 252 |[39m       }
     [90m 253 |[39m
     [90m 254 |[39m       req[33m.[39muser [33m=[39m { id[33m:[39m user[33m.[39mid }[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:251:9)

  ‚óè Session Management Middleware ‚Ä∫ enforceConcurrentSessions() ‚Ä∫ should delete oldest session when limit exceeded (6 sessions)

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 270 |[39m       [36mconst[39m sessions [33m=[39m [][33m;[39m
     [90m 271 |[39m       [36mfor[39m ([36mlet[39m i [33m=[39m [35m0[39m[33m;[39m i [33m<[39m [35m6[39m[33m;[39m i[33m++[39m) {
    [31m[1m>[22m[39m[90m 272 |[39m         [36mconst[39m session [33m=[39m [36mawait[39m createTestRefreshToken(user[33m.[39mid)[33m;[39m
     [90m     |[39m                         [31m[1m^[22m[39m
     [90m 273 |[39m         sessions[33m.[39mpush(session)[33m;[39m
     [90m 274 |[39m
     [90m 275 |[39m         [90m// Wait 10ms between each to ensure different createdAt[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:272:25)

  ‚óè Session Management Middleware ‚Ä∫ enforceConcurrentSessions() ‚Ä∫ should delete multiple oldest sessions when far over limit (10 sessions)

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 303 |[39m       [90m// Create 10 sessions[39m
     [90m 304 |[39m       [36mfor[39m ([36mlet[39m i [33m=[39m [35m0[39m[33m;[39m i [33m<[39m [35m10[39m[33m;[39m i[33m++[39m) {
    [31m[1m>[22m[39m[90m 305 |[39m         [36mawait[39m createTestRefreshToken(user[33m.[39mid)[33m;[39m
     [90m     |[39m         [31m[1m^[22m[39m
     [90m 306 |[39m         [36mawait[39m [36mnew[39m [33mPromise[39m((resolve) [33m=>[39m setTimeout(resolve[33m,[39m [35m10[39m))[33m;[39m
     [90m 307 |[39m       }
     [90m 308 |[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:305:9)

  ‚óè Session Management Middleware ‚Ä∫ enforceConcurrentSessions() ‚Ä∫ should keep most recent sessions

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 324 |[39m       [36mconst[39m sessions [33m=[39m [][33m;[39m
     [90m 325 |[39m       [36mfor[39m ([36mlet[39m i [33m=[39m [35m0[39m[33m;[39m i [33m<[39m [35m7[39m[33m;[39m i[33m++[39m) {
    [31m[1m>[22m[39m[90m 326 |[39m         [36mconst[39m session [33m=[39m [36mawait[39m createTestRefreshToken(user[33m.[39mid)[33m;[39m
     [90m     |[39m                         [31m[1m^[22m[39m
     [90m 327 |[39m         sessions[33m.[39mpush(session)[33m;[39m
     [90m 328 |[39m         [36mawait[39m [36mnew[39m [33mPromise[39m((resolve) [33m=>[39m setTimeout(resolve[33m,[39m [35m10[39m))[33m;[39m
     [90m 329 |[39m       }[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:326:25)

  ‚óè Session Management Middleware ‚Ä∫ enforceConcurrentSessions() ‚Ä∫ Custom limit configuration ‚Ä∫ should respect custom MAX_CONCURRENT_SESSIONS

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 392 |[39m         [90m// Create 5 sessions[39m
     [90m 393 |[39m         [36mfor[39m ([36mlet[39m i [33m=[39m [35m0[39m[33m;[39m i [33m<[39m [35m5[39m[33m;[39m i[33m++[39m) {
    [31m[1m>[22m[39m[90m 394 |[39m           [36mawait[39m createTestRefreshToken(user[33m.[39mid)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 395 |[39m           [36mawait[39m [36mnew[39m [33mPromise[39m((resolve) [33m=>[39m setTimeout(resolve[33m,[39m [35m10[39m))[33m;[39m
     [90m 396 |[39m         }
     [90m 397 |[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:394:11)

  ‚óè Session Management Middleware ‚Ä∫ getActiveSessions() ‚Ä∫ should return empty array for user with no sessions

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.create()` invocation:


    Unique constraint failed on the fields: (`email`)

    [0m [90m 467 |[39m
     [90m 468 |[39m     it([32m'should return empty array for user with no sessions'[39m[33m,[39m [36masync[39m () [33m=>[39m {
    [31m[1m>[22m[39m[90m 469 |[39m       [36mconst[39m user [33m=[39m [36mawait[39m createTestUser()[33m;[39m
     [90m     |[39m                    [31m[1m^[22m[39m
     [90m 470 |[39m       req[33m.[39muser [33m=[39m { id[33m:[39m user[33m.[39mid }[33m;[39m
     [90m 471 |[39m
     [90m 472 |[39m       [36mawait[39m getActiveSessions(req[33m,[39m res[33m,[39m next)[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:469:20)

  ‚óè Session Management Middleware ‚Ä∫ getActiveSessions() ‚Ä∫ should return all active sessions for user

    expect(received).toHaveLength(expected)

    Expected length: 2
    Received length: 0
    Received array:  []

    [0m [90m 496 |[39m       [36mconst[39m responseData [33m=[39m res[33m.[39mjson[33m.[39mmock[33m.[39mcalls[[35m0[39m][[35m0[39m][33m;[39m
     [90m 497 |[39m       expect(responseData[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 498 |[39m       expect(responseData[33m.[39mdata[33m.[39msessions)[33m.[39mtoHaveLength([35m2[39m)[33m;[39m
     [90m     |[39m                                          [31m[1m^[22m[39m
     [90m 499 |[39m       expect(responseData[33m.[39mdata[33m.[39mmaxConcurrent)[33m.[39mtoBe([35m5[39m)[33m;[39m
     [90m 500 |[39m       expect(responseData[33m.[39mdata[33m.[39msessionTimeout)[33m.[39mtoBe([35m900000[39m)[33m;[39m
     [90m 501 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:498:42)

  ‚óè Session Management Middleware ‚Ä∫ revokeSession() ‚Ä∫ should successfully revoke own session

    PrismaClientKnownRequestError: 
    Invalid `prisma.refreshToken.create()` invocation:


    Foreign key constraint violated on the constraint: `refresh_tokens_userId_fkey`

    [0m [90m 564 |[39m     it([32m'should successfully revoke own session'[39m[33m,[39m [36masync[39m () [33m=>[39m {
     [90m 565 |[39m       [36mconst[39m user [33m=[39m [36mawait[39m createTestUser()[33m;[39m
    [31m[1m>[22m[39m[90m 566 |[39m       [36mconst[39m token [33m=[39m [36mawait[39m createTestRefreshToken(user[33m.[39mid)[33m;[39m
     [90m     |[39m                     [31m[1m^[22m[39m
     [90m 567 |[39m
     [90m 568 |[39m       req[33m.[39muser [33m=[39m { id[33m:[39m user[33m.[39mid }[33m;[39m
     [90m 569 |[39m       req[33m.[39mparams [33m=[39m { sessionId[33m:[39m token[33m.[39mid[33m.[39mtoString() }[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:566:21)

  ‚óè Session Management Middleware ‚Ä∫ revokeSession() ‚Ä∫ should NOT allow revoking another user's session

    expect(received).not.toBeNull()

    Received: null

    [0m [90m 614 |[39m         where[33m:[39m { id[33m:[39m user2Token[33m.[39mid }[33m,[39m
     [90m 615 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 616 |[39m       expect(user2Session)[33m.[39mnot[33m.[39mtoBeNull()[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 617 |[39m     })[33m;[39m
     [90m 618 |[39m
     [90m 619 |[39m     it([32m'should handle database errors'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (__tests__/middleware/sessionManagement.test.mjs:616:32)

FAIL __tests__/routes/apiOptimizationRoutes.test.mjs


  ‚óè Test suite failed to run

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 58 |[39m   afterAll([36masync[39m () [33m=>[39m {
     [90m 59 |[39m     [90m// Cleanup test data[39m
    [31m[1m>[22m[39m[90m 60 |[39m     [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 61 |[39m       where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 62 |[39m     })[33m;[39m
     [90m 63 |[39m   })[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/routes/apiOptimizationRoutes.test.mjs:60:5)

FAIL __tests__/integration/security/sql-injection-attempts.test.mjs
  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Classic SQL Injection in ID Parameters ‚Ä∫ should reject SQL injection in horse ID

    PrismaClientKnownRequestError: 
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

    [0m [90m 72 |[39m
     [90m 73 |[39m     [90m// Create test groom owned by user[39m
    [31m[1m>[22m[39m[90m 74 |[39m     testGroom [33m=[39m [36mawait[39m prisma[33m.[39mgroom[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 75 |[39m       data[33m:[39m {
     [90m 76 |[39m         name[33m:[39m [32m`TestGroom-${Date.now()}`[39m[33m,[39m
     [90m 77 |[39m         userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:74:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Blind SQL Injection Attempts ‚Ä∫ should reject boolean-based blind injection

    PrismaClientKnownRequestError: 
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

    [0m [90m 72 |[39m
     [90m 73 |[39m     [90m// Create test groom owned by user[39m
    [31m[1m>[22m[39m[90m 74 |[39m     testGroom [33m=[39m [36mawait[39m prisma[33m.[39mgroom[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 75 |[39m       data[33m:[39m {
     [90m 76 |[39m         name[33m:[39m [32m`TestGroom-${Date.now()}`[39m[33m,[39m
     [90m 77 |[39m         userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:74:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Blind SQL Injection Attempts ‚Ä∫ should reject time-based blind injection

    PrismaClientKnownRequestError: 
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

    [0m [90m 72 |[39m
     [90m 73 |[39m     [90m// Create test groom owned by user[39m
    [31m[1m>[22m[39m[90m 74 |[39m     testGroom [33m=[39m [36mawait[39m prisma[33m.[39mgroom[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 75 |[39m       data[33m:[39m {
     [90m 76 |[39m         name[33m:[39m [32m`TestGroom-${Date.now()}`[39m[33m,[39m
     [90m 77 |[39m         userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:74:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Blind SQL Injection Attempts ‚Ä∫ should reject PostgreSQL-specific time injection

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.create()` invocation:


    Unique constraint failed on the fields: (`email`)

    [0m [90m 47 |[39m   beforeEach([36masync[39m () [33m=>[39m {
     [90m 48 |[39m     [90m// Create test user in database[39m
    [31m[1m>[22m[39m[90m 49 |[39m     testUser [33m=[39m [36mawait[39m prisma[33m.[39muser[33m.[39mcreate({
     [90m    |[39m                [31m[1m^[22m[39m
     [90m 50 |[39m       data[33m:[39m {
     [90m 51 |[39m         email[33m:[39m [32m`test-${Date.now()}@example.com`[39m[33m,[39m
     [90m 52 |[39m         username[33m:[39m [32m`testuser-${Date.now()}`[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:49:16)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Union-Based SQL Injection ‚Ä∫ should reject UNION ALL attacks

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Union-Based SQL Injection ‚Ä∫ should reject UNION with ORDER BY column enumeration

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Union-Based SQL Injection ‚Ä∫ should reject UNION with NULL padding

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Stacked Queries ‚Ä∫ should reject semicolon-separated queries

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Stacked Queries ‚Ä∫ should reject multiple statements in ownership check

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Stacked Queries ‚Ä∫ should reject batch operations via stacking

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ SQL Injection in Search/Filter Parameters ‚Ä∫ should reject SQL injection in breed filter

    PrismaClientKnownRequestError: 
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

    [0m [90m 72 |[39m
     [90m 73 |[39m     [90m// Create test groom owned by user[39m
    [31m[1m>[22m[39m[90m 74 |[39m     testGroom [33m=[39m [36mawait[39m prisma[33m.[39mgroom[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 75 |[39m       data[33m:[39m {
     [90m 76 |[39m         name[33m:[39m [32m`TestGroom-${Date.now()}`[39m[33m,[39m
     [90m 77 |[39m         userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:74:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ SQL Injection in Search/Filter Parameters ‚Ä∫ should reject SQL injection in IN clause

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ SQL Injection in JSON/JSONB Queries ‚Ä∫ should reject SQL injection in JSONB path

    PrismaClientKnownRequestError: 
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

    [0m [90m 72 |[39m
     [90m 73 |[39m     [90m// Create test groom owned by user[39m
    [31m[1m>[22m[39m[90m 74 |[39m     testGroom [33m=[39m [36mawait[39m prisma[33m.[39mgroom[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 75 |[39m       data[33m:[39m {
     [90m 76 |[39m         name[33m:[39m [32m`TestGroom-${Date.now()}`[39m[33m,[39m
     [90m 77 |[39m         userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:74:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ SQL Injection in JSON/JSONB Queries ‚Ä∫ should reject SQL injection in JSON operators

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ SQL Injection in JSON/JSONB Queries ‚Ä∫ should reject SQL injection in JSON array queries

    PrismaClientKnownRequestError: 
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

    [0m [90m 72 |[39m
     [90m 73 |[39m     [90m// Create test groom owned by user[39m
    [31m[1m>[22m[39m[90m 74 |[39m     testGroom [33m=[39m [36mawait[39m prisma[33m.[39mgroom[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 75 |[39m       data[33m:[39m {
     [90m 76 |[39m         name[33m:[39m [32m`TestGroom-${Date.now()}`[39m[33m,[39m
     [90m 77 |[39m         userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:74:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Second-Order SQL Injection ‚Ä∫ should prevent injection via profile data used in ownership checks

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ ORM Bypass Attempts (Prisma) ‚Ä∫ should reject raw query injection via Prisma

    PrismaClientKnownRequestError: 
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

    [0m [90m 72 |[39m
     [90m 73 |[39m     [90m// Create test groom owned by user[39m
    [31m[1m>[22m[39m[90m 74 |[39m     testGroom [33m=[39m [36mawait[39m prisma[33m.[39mgroom[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 75 |[39m       data[33m:[39m {
     [90m 76 |[39m         name[33m:[39m [32m`TestGroom-${Date.now()}`[39m[33m,[39m
     [90m 77 |[39m         userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:74:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ ORM Bypass Attempts (Prisma) ‚Ä∫ should reject Prisma findRaw injection attempts

    PrismaClientKnownRequestError: 
    Invalid `prisma.groom.create()` invocation:


    Foreign key constraint violated on the constraint: `grooms_userId_fkey`

    [0m [90m 72 |[39m
     [90m 73 |[39m     [90m// Create test groom owned by user[39m
    [31m[1m>[22m[39m[90m 74 |[39m     testGroom [33m=[39m [36mawait[39m prisma[33m.[39mgroom[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 75 |[39m       data[33m:[39m {
     [90m 76 |[39m         name[33m:[39m [32m`TestGroom-${Date.now()}`[39m[33m,[39m
     [90m 77 |[39m         userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:74:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ ORM Bypass Attempts (Prisma) ‚Ä∫ should reject $queryRaw parameter injection

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ PostgreSQL-Specific Injection Attacks ‚Ä∫ should reject PostgreSQL function calls

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ PostgreSQL-Specific Injection Attacks ‚Ä∫ should reject PostgreSQL COPY command

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ PostgreSQL-Specific Injection Attacks ‚Ä∫ should reject pg_read_file attempts

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ PostgreSQL-Specific Injection Attacks ‚Ä∫ should reject PostgreSQL stored procedure execution

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ SQL Injection in Batch Operations ‚Ä∫ should reject SQL injection in batch horse updates

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ SQL Injection in Batch Operations ‚Ä∫ should reject SQL injection in batch groom deletion

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ SQL Injection Error Handling ‚Ä∫ should return consistent error format for all injection attempts

    PrismaClientKnownRequestError: 
    Invalid `prisma.horse.create()` invocation:


    Foreign key constraint violated on the constraint: `horses_userId_fkey`

    [0m [90m 61 |[39m
     [90m 62 |[39m     [90m// Create test horse owned by user[39m
    [31m[1m>[22m[39m[90m 63 |[39m     testHorse [33m=[39m [36mawait[39m prisma[33m.[39mhorse[33m.[39mcreate({
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 64 |[39m       data[33m:[39m {
     [90m 65 |[39m         name[33m:[39m [32m`TestHorse-${Date.now()}`[39m[33m,[39m
     [90m 66 |[39m         sex[33m:[39m [32m'mare'[39m[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:63:17)

  ‚óè SQL Injection Attempts Integration Tests ‚Ä∫ Parameterized Query Validation ‚Ä∫ should use parameterized queries for ownership checks

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 582 |[39m         [33m.[39m[36mget[39m([32m`/api/horses/${testHorse.id}`[39m)
     [90m 583 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${validToken}`[39m)
    [31m[1m>[22m[39m[90m 584 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 585 |[39m
     [90m 586 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 587 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mid)[33m.[39mtoBe(testHorse[33m.[39mid)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/security/sql-injection-attempts.test.mjs:584:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

FAIL __tests__/performance/apiResponseOptimization.test.mjs


  ‚óè Test suite failed to run

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 155 |[39m       where[33m:[39m { ownerId[33m:[39m testUserId }[33m,[39m
     [90m 156 |[39m     })[33m;[39m
    [31m[1m>[22m[39m[90m 157 |[39m     [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m     |[39m     [31m[1m^[22m[39m
     [90m 158 |[39m       where[33m:[39m { id[33m:[39m testUserId }[33m,[39m
     [90m 159 |[39m     })[33m;[39m
     [90m 160 |[39m     [36mawait[39m prisma[33m.[39mbreed[33m.[39mdeleteMany({[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/performance/apiResponseOptimization.test.mjs:157:5)

FAIL __tests__/integration/auth-cookies.test.mjs (6.961 s)
  ‚óè Authentication with HttpOnly Cookies ‚Ä∫ POST /api/auth/register - Cookie Setting ‚Ä∫ should set httpOnly cookies on successful registration

    expected 201 "Created", got 500 "Internal Server Error"

    [0m [90m 78 |[39m         [33m.[39m[36mset[39m(rateLimitBypassHeader)
     [90m 79 |[39m         [33m.[39msend(registrationUser)
    [31m[1m>[22m[39m[90m 80 |[39m         [33m.[39mexpect([35m201[39m)[33m;[39m
     [90m    |[39m          [31m[1m^[22m[39m
     [90m 81 |[39m
     [90m 82 |[39m       [90m// Verify response structure[39m
     [90m 83 |[39m       expect(response[33m.[39mbody[33m.[39mstatus)[33m.[39mtoBe([32m'success'[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/auth-cookies.test.mjs:80:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Authentication with HttpOnly Cookies ‚Ä∫ POST /api/auth/register - Cookie Setting ‚Ä∫ should NOT expose tokens in response body (XSS protection)

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 135 |[39m
     [90m 136 |[39m       [90m// Clean up[39m
    [31m[1m>[22m[39m[90m 137 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m     |[39m       [31m[1m^[22m[39m
     [90m 138 |[39m         where[33m:[39m { email[33m:[39m [32m'cookietest2@example.com'[39m }[33m,[39m
     [90m 139 |[39m       })[33m;[39m
     [90m 140 |[39m     })[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/auth-cookies.test.mjs:137:7)

  ‚óè Authentication with HttpOnly Cookies ‚Ä∫ Security: XSS Protection Verification ‚Ä∫ should never include JWT tokens in any response body

    expected 201 "Created", got 500 "Internal Server Error"

    [0m [90m 349 |[39m           username[33m:[39m [32m'xsstest'[39m[33m,[39m
     [90m 350 |[39m         })
    [31m[1m>[22m[39m[90m 351 |[39m         [33m.[39mexpect([35m201[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 352 |[39m
     [90m 353 |[39m       [36mconst[39m loginResponse [33m=[39m [36mawait[39m request(app)
     [90m 354 |[39m         [33m.[39mpost([32m'/api/auth/login'[39m)[0m

      at Object.<anonymous> (__tests__/integration/auth-cookies.test.mjs:351:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

  ‚óè Authentication with HttpOnly Cookies ‚Ä∫ Backward Compatibility: Authorization Header Fallback ‚Ä∫ should still accept Authorization header for backward compatibility

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 454 |[39m         [33m.[39m[36mset[39m([32m'X-Test-Bypass-Auth'[39m[33m,[39m [32m'true'[39m)
     [90m 455 |[39m         [33m.[39m[36mset[39m([32m'X-Test-Email'[39m[33m,[39m [32m'fallback@example.com'[39m)
    [31m[1m>[22m[39m[90m 456 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 457 |[39m
     [90m 458 |[39m       expect(response[33m.[39mbody[33m.[39mstatus)[33m.[39mtoBe([32m'success'[39m)[33m;[39m
     [90m 459 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39muser[33m.[39memail)[33m.[39mtoBe([32m'fallback@example.com'[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/auth-cookies.test.mjs:456:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:267:14)
      at node_modules/supertest/lib/test.js:323:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:300:13)
      at Test.assert (node_modules/supertest/lib/test.js:179:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:135:14)

FAIL __tests__/integration/email-verification.test.mjs (14.624 s)
  ‚óè Email Verification System - Integration Tests ‚Ä∫ POST /auth/register - Email Verification Integration ‚Ä∫ should_create_verification_token_on_registration

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 70 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)[33m.[39mpost([32m'/auth/register'[39m)[33m.[39msend(newUser)[33m;[39m
     [90m 71 |[39m
    [31m[1m>[22m[39m[90m 72 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                               [31m[1m^[22m[39m
     [90m 73 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39memailVerificationSent)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 74 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39muser[33m.[39memailVerified)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 75 |[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:72:31)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ POST /auth/register - Email Verification Integration ‚Ä∫ should_include_email_verified_status_in_response

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m  95 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)[33m.[39mpost([32m'/auth/register'[39m)[33m.[39msend(newUser)[33m;[39m
     [90m  96 |[39m
    [31m[1m>[22m[39m[90m  97 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m  98 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39muser)[33m.[39mtoHaveProperty([32m'emailVerified'[39m)[33m;[39m
     [90m  99 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39muser[33m.[39memailVerified)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 100 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'verify your account'[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:97:31)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ POST /auth/register - Email Verification Integration ‚Ä∫ should_log_verification_email_in_development_mode

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 114 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)[33m.[39mpost([32m'/auth/register'[39m)[33m.[39msend(newUser)[33m;[39m
     [90m 115 |[39m
    [31m[1m>[22m[39m[90m 116 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 117 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39memailVerificationSent)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 118 |[39m
     [90m 119 |[39m       [90m// In development, email should be logged (check via token existence)[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:116:31)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ GET /auth/verify-email ‚Ä∫ should_verify_email_with_valid_token

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

    [0m [90m 141 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)[33m.[39m[36mget[39m([32m`/auth/verify-email?token=${token.token}`[39m)[33m;[39m
     [90m 142 |[39m
    [31m[1m>[22m[39m[90m 143 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 144 |[39m       expect(response[33m.[39mbody[33m.[39mstatus)[33m.[39mtoBe([32m'success'[39m)[33m;[39m
     [90m 145 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoBe([32m'Email verified successfully'[39m)[33m;[39m
     [90m 146 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mverified)[33m.[39mtoBe([36mtrue[39m)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:143:31)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ GET /auth/verify-email ‚Ä∫ should_update_user_email_verified_status

    TypeError: Cannot read properties of null (reading 'emailVerified')

    [0m [90m 164 |[39m       })[33m;[39m
     [90m 165 |[39m
    [31m[1m>[22m[39m[90m 166 |[39m       expect(user[33m.[39memailVerified)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                   [31m[1m^[22m[39m
     [90m 167 |[39m       expect(user[33m.[39memailVerifiedAt)[33m.[39mtoBeDefined()[33m;[39m
     [90m 168 |[39m       expect(user[33m.[39memailVerifiedAt)[33m.[39mtoBeInstanceOf([33mDate[39m)[33m;[39m
     [90m 169 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:166:19)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ GET /auth/verify-email ‚Ä∫ should_mark_token_as_used

    TypeError: Cannot read properties of null (reading 'usedAt')

    [0m [90m 185 |[39m       })[33m;[39m
     [90m 186 |[39m
    [31m[1m>[22m[39m[90m 187 |[39m       expect(tokenRecord[33m.[39musedAt)[33m.[39mtoBeDefined()[33m;[39m
     [90m     |[39m                          [31m[1m^[22m[39m
     [90m 188 |[39m       expect(tokenRecord[33m.[39musedAt)[33m.[39mtoBeInstanceOf([33mDate[39m)[33m;[39m
     [90m 189 |[39m     })[33m;[39m
     [90m 190 |[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:187:26)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ GET /auth/verify-email ‚Ä∫ should_reject_expired_token

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 206 |[39m
     [90m 207 |[39m     it([32m'should_reject_expired_token'[39m[33m,[39m [36masync[39m () [33m=>[39m {
    [31m[1m>[22m[39m[90m 208 |[39m       [36mconst[39m token [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m     |[39m                     [31m[1m^[22m[39m
     [90m 209 |[39m         data[33m:[39m {
     [90m 210 |[39m           token[33m:[39m generateVerificationToken()[33m,[39m
     [90m 211 |[39m           userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:208:21)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ GET /auth/verify-email ‚Ä∫ should_be_publicly_accessible_without_authentication

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

    [0m [90m 254 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)[33m.[39m[36mget[39m([32m`/auth/verify-email?token=${token.token}`[39m)[33m;[39m
     [90m 255 |[39m
    [31m[1m>[22m[39m[90m 256 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 257 |[39m       expect(response[33m.[39mbody[33m.[39mstatus)[33m.[39mtoBe([32m'success'[39m)[33m;[39m
     [90m 258 |[39m     })[33m;[39m
     [90m 259 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:256:31)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ POST /auth/resend-verification ‚Ä∫ should_enforce_rate_limiting

    expect(received).toBe(expected) // Object.is equality

    Expected: 500
    Received: 404

    [0m [90m 313 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)[33m;[39m
     [90m 314 |[39m
    [31m[1m>[22m[39m[90m 315 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m500[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 316 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'wait'[39m)[33m;[39m
     [90m 317 |[39m     })[33m;[39m
     [90m 318 |[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:315:31)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ GET /auth/verification-status ‚Ä∫ should_return_unverified_status_for_new_user

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 350 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)[33m;[39m
     [90m 351 |[39m
    [31m[1m>[22m[39m[90m 352 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 353 |[39m       expect(response[33m.[39mbody[33m.[39mstatus)[33m.[39mtoBe([32m'success'[39m)[33m;[39m
     [90m 354 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mverified)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 355 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39memail)[33m.[39mtoBe(testUser[33m.[39memail)[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:352:31)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ GET /auth/verification-status ‚Ä∫ should_return_user_email_address

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 387 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)[33m;[39m
     [90m 388 |[39m
    [31m[1m>[22m[39m[90m 389 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 390 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39memail)[33m.[39mtoBe(testUser[33m.[39memail)[33m;[39m
     [90m 391 |[39m     })[33m;[39m
     [90m 392 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:389:31)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ Complete Email Verification Workflow ‚Ä∫ should_complete_full_registration_to_verification_flow

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 406 |[39m       [36mconst[39m registerResponse [33m=[39m [36mawait[39m request(app)[33m.[39mpost([32m'/auth/register'[39m)[33m.[39msend(newUser)[33m;[39m
     [90m 407 |[39m
    [31m[1m>[22m[39m[90m 408 |[39m       expect(registerResponse[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m     |[39m                                       [31m[1m^[22m[39m
     [90m 409 |[39m       expect(registerResponse[33m.[39mbody[33m.[39mdata[33m.[39muser[33m.[39memailVerified)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 410 |[39m
     [90m 411 |[39m       [90m// Step 2: Get verification token from database[39m[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:408:39)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ Complete Email Verification Workflow ‚Ä∫ should_handle_resend_and_verify_workflow

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 447 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)[33m;[39m
     [90m 448 |[39m
    [31m[1m>[22m[39m[90m 449 |[39m       expect(resendResponse[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                     [31m[1m^[22m[39m
     [90m 450 |[39m
     [90m 451 |[39m       [90m// Step 4: Get new token[39m
     [90m 452 |[39m       [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mfindFirst({[0m

      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:449:37)

  ‚óè Email Verification System - Integration Tests ‚Ä∫ Complete Email Verification Workflow ‚Ä∫ should_prevent_multiple_verification_attempts

    PrismaClientKnownRequestError: 
    Invalid `prisma.emailVerificationToken.create()` invocation:


    Foreign key constraint violated on the constraint: `email_verification_tokens_userId_fkey`

    [0m [90m 471 |[39m
     [90m 472 |[39m     it([32m'should_prevent_multiple_verification_attempts'[39m[33m,[39m [36masync[39m () [33m=>[39m {
    [31m[1m>[22m[39m[90m 473 |[39m       [36mconst[39m tokenRecord [33m=[39m [36mawait[39m prisma[33m.[39memailVerificationToken[33m.[39mcreate({
     [90m     |[39m                           [31m[1m^[22m[39m
     [90m 474 |[39m         data[33m:[39m {
     [90m 475 |[39m           token[33m:[39m generateVerificationToken()[33m,[39m
     [90m 476 |[39m           userId[33m:[39m testUser[33m.[39mid[33m,[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/email-verification.test.mjs:473:27)

FAIL __tests__/unit/cacheHelper.test.mjs
  ‚óè Test suite failed to run

    Cannot find module 'vitest' from '__tests__/unit/cacheHelper.test.mjs'

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)

FAIL __tests__/integration/cookieIntegration.test.mjs (13.606 s)
  ‚óè Cookie Integration Tests ‚Ä∫ Registration Endpoint Cookies ‚Ä∫ should set accessToken cookie with correct attributes

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 73 |[39m       })[33m;[39m
     [90m 74 |[39m
    [31m[1m>[22m[39m[90m 75 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                               [31m[1m^[22m[39m
     [90m 76 |[39m
     [90m 77 |[39m       [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m][33m;[39m
     [90m 78 |[39m       expect(cookies)[33m.[39mtoBeDefined()[33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/cookieIntegration.test.mjs:75:31)

  ‚óè Cookie Integration Tests ‚Ä∫ Token Refresh Endpoint Cookies ‚Ä∫ should set new refreshToken cookie with correct attributes

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 42 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 43 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 44 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 45 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 46 |[39m       })[33m;[39m
     [90m 47 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/cookieIntegration.test.mjs:44:7)

  ‚óè Cookie Integration Tests ‚Ä∫ Logout Endpoint Cookie Clearing ‚Ä∫ should clear refreshToken cookie on logout

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 42 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 43 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 44 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 45 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 46 |[39m       })[33m;[39m
     [90m 47 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/cookieIntegration.test.mjs:44:7)

  ‚óè Cookie Integration Tests ‚Ä∫ Logout Endpoint Cookie Clearing ‚Ä∫ should maintain same path when clearing cookies

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 42 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 43 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 44 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 45 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 46 |[39m       })[33m;[39m
     [90m 47 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/cookieIntegration.test.mjs:44:7)

FAIL __tests__/integration/csrf-integration.test.mjs (17.602 s)
  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Token Acquisition ‚Ä∫ should get CSRF token from /auth/csrf-token endpoint

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 52 |[39m       })[33m;[39m
     [90m 53 |[39m
    [31m[1m>[22m[39m[90m 54 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 55 |[39m
     [90m 56 |[39m     [90m// Extract accessToken from cookie[39m
     [90m 57 |[39m     [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m] [33m||[39m [][33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:54:29)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Token Acquisition ‚Ä∫ should set CSRF token in cookie

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 52 |[39m       })[33m;[39m
     [90m 53 |[39m
    [31m[1m>[22m[39m[90m 54 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 55 |[39m
     [90m 56 |[39m     [90m// Extract accessToken from cookie[39m
     [90m 57 |[39m     [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m] [33m||[39m [][33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:54:29)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Protection for State-Changing Operations ‚Ä∫ should reject POST request without CSRF token

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 71 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 72 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 73 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 74 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 75 |[39m       })[33m;[39m
     [90m 76 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:73:7)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Protection for State-Changing Operations ‚Ä∫ should reject DELETE request without CSRF token

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 52 |[39m       })[33m;[39m
     [90m 53 |[39m
    [31m[1m>[22m[39m[90m 54 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 55 |[39m
     [90m 56 |[39m     [90m// Extract accessToken from cookie[39m
     [90m 57 |[39m     [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m] [33m||[39m [][33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:54:29)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Protection for State-Changing Operations ‚Ä∫ should reject PATCH request without CSRF token

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 71 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 72 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 73 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 74 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 75 |[39m       })[33m;[39m
     [90m 76 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:73:7)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ Safe HTTP Methods (No CSRF Required) ‚Ä∫ should allow GET requests without CSRF token

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 52 |[39m       })[33m;[39m
     [90m 53 |[39m
    [31m[1m>[22m[39m[90m 54 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 55 |[39m
     [90m 56 |[39m     [90m// Extract accessToken from cookie[39m
     [90m 57 |[39m     [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m] [33m||[39m [][33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:54:29)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ Safe HTTP Methods (No CSRF Required) ‚Ä∫ should allow GET requests without CSRF token

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 71 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 72 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 73 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 74 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 75 |[39m       })[33m;[39m
     [90m 76 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:73:7)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ Safe HTTP Methods (No CSRF Required) ‚Ä∫ should allow HEAD requests without CSRF token

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 52 |[39m       })[33m;[39m
     [90m 53 |[39m
    [31m[1m>[22m[39m[90m 54 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 55 |[39m
     [90m 56 |[39m     [90m// Extract accessToken from cookie[39m
     [90m 57 |[39m     [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m] [33m||[39m [][33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:54:29)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ Safe HTTP Methods (No CSRF Required) ‚Ä∫ should allow HEAD requests without CSRF token

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 71 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 72 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 73 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 74 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 75 |[39m       })[33m;[39m
     [90m 76 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:73:7)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ Safe HTTP Methods (No CSRF Required) ‚Ä∫ should allow OPTIONS requests without CSRF token

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 52 |[39m       })[33m;[39m
     [90m 53 |[39m
    [31m[1m>[22m[39m[90m 54 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 55 |[39m
     [90m 56 |[39m     [90m// Extract accessToken from cookie[39m
     [90m 57 |[39m     [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m] [33m||[39m [][33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:54:29)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ Safe HTTP Methods (No CSRF Required) ‚Ä∫ should allow OPTIONS requests without CSRF token

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 71 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 72 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 73 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 74 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 75 |[39m       })[33m;[39m
     [90m 76 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:73:7)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Error Messages ‚Ä∫ should provide clear error message for missing token

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 52 |[39m       })[33m;[39m
     [90m 53 |[39m
    [31m[1m>[22m[39m[90m 54 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 55 |[39m
     [90m 56 |[39m     [90m// Extract accessToken from cookie[39m
     [90m 57 |[39m     [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m] [33m||[39m [][33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:54:29)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Error Messages ‚Ä∫ should provide clear error message for missing token

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 71 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 72 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 73 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 74 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 75 |[39m       })[33m;[39m
     [90m 76 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:73:7)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Error Messages ‚Ä∫ should include error code in response

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 52 |[39m       })[33m;[39m
     [90m 53 |[39m
    [31m[1m>[22m[39m[90m 54 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 55 |[39m
     [90m 56 |[39m     [90m// Extract accessToken from cookie[39m
     [90m 57 |[39m     [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m] [33m||[39m [][33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:54:29)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Error Messages ‚Ä∫ should include error code in response

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 71 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 72 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 73 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 74 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 75 |[39m       })[33m;[39m
     [90m 76 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:73:7)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Error Messages ‚Ä∫ should return 403 status for CSRF failures

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 71 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 72 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 73 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 74 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 75 |[39m       })[33m;[39m
     [90m 76 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:73:7)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Token Lifecycle ‚Ä∫ should accept newly generated token

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 52 |[39m       })[33m;[39m
     [90m 53 |[39m
    [31m[1m>[22m[39m[90m 54 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 55 |[39m
     [90m 56 |[39m     [90m// Extract accessToken from cookie[39m
     [90m 57 |[39m     [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m] [33m||[39m [][33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:54:29)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Token Lifecycle ‚Ä∫ should accept newly generated token

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 71 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 72 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 73 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 74 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 75 |[39m       })[33m;[39m
     [90m 76 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:73:7)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Token Lifecycle ‚Ä∫ should generate new token on each request to /auth/csrf-token

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 52 |[39m       })[33m;[39m
     [90m 53 |[39m
    [31m[1m>[22m[39m[90m 54 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 55 |[39m
     [90m 56 |[39m     [90m// Extract accessToken from cookie[39m
     [90m 57 |[39m     [36mconst[39m cookies [33m=[39m response[33m.[39mheaders[[32m'set-cookie'[39m] [33m||[39m [][33m;[39m[0m

      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:54:29)

  ‚óè CSRF Protection Integration Tests ‚Ä∫ CSRF Token Lifecycle ‚Ä∫ should generate new token on each request to /auth/csrf-token

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.delete()` invocation:


    An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.

    [0m [90m 71 |[39m         where[33m:[39m { userId[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 72 |[39m       })[33m;[39m
    [31m[1m>[22m[39m[90m 73 |[39m       [36mawait[39m prisma[33m.[39muser[33m.[39m[36mdelete[39m({
     [90m    |[39m       [31m[1m^[22m[39m
     [90m 74 |[39m         where[33m:[39m { id[33m:[39m testUser[33m.[39mid }[33m,[39m
     [90m 75 |[39m       })[33m;[39m
     [90m 76 |[39m       testUser [33m=[39m [36mnull[39m[33m;[39m[0m

      at Zn.handleRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:7459)
      at Zn.handleAndLogRequestError (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6784)
      at Zn.request (../packages/database/node_modules/@prisma/client/runtime/library.js:121:6491)
      at l (../packages/database/node_modules/@prisma/client/runtime/library.js:130:9778)
      at Object.<anonymous> (__tests__/integration/csrf-integration.test.mjs:73:7)


Test Suites: 22 failed, 2 skipped, 21 passed, 43 of 45 total
Tests:       162 failed, 41 skipped, 822 passed, 1025 total
Snapshots:   0 total
Time:        19.857 s, estimated 72 s
Ran all test suites.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
